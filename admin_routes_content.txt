@admin_bp.route('/admin/settlement/complete', methods=['POST'])
# --------------------------------------------------------------------------------
# 5. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë° ë¼ìš°íŒ… (ë³´ì™„ ì™„ë£Œ ë²„ì „)
# --------------------------------------------------------------------------------
@login_required
def admin_settlement_complete():
    """ë§ˆìŠ¤í„° ê´€ë¦¬ìê°€ íŠ¹ì • ì¹´í…Œê³ ë¦¬ì˜ ë§¤ì¶œì„ ì •ì‚° ì™„ë£Œ ì²˜ë¦¬"""
    if not current_user.is_admin:
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403

    data = request.get_json()
    cat_name = data.get('category_name')
    amount = data.get('amount')
    manager_email = data.get('manager_email')

    try:
        # 1. ì •ì‚° ê¸°ë¡ ìƒì„± (ì¹´í…Œê³ ë¦¬ë³„ ì •ì‚° ë‚´ì—­)
        new_settle = CategorySettlement(
            category_name=cat_name,
            manager_email=manager_email,
            total_sales=amount,
            settlement_amount=amount,
            status='ì…ê¸ˆì™„ë£Œ',
            completed_at=datetime.now()
        )
        db.session.add(new_settle)
        
        # 2. í•´ë‹¹ ê¸°ê°„/ì¹´í…Œê³ ë¦¬ì˜ ì£¼ë¬¸ ìƒíƒœë¥¼ 'ì •ì‚°ì™„ë£Œ'ë¡œ ì—…ë°ì´íŠ¸í•˜ê³  ì‹¶ë‹¤ë©´ 
        # ì—¬ê¸°ì— ì¶”ê°€ ë¡œì§ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬ëŠ” ê¸°ë¡ë§Œ ë‚¨ê¹€)
        
        db.session.commit()
        return jsonify({"success": True, "message": f"{cat_name} ì •ì‚° ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."})
    except Exception as e:
        db.session.rollback()
        return jsonify({"success": False, "message": str(e)})

@admin_bp.route('/admin/settlement/order_status', methods=['POST'])


@login_required
def admin_settlement_order_status():
    """ê´€ë¦¬ìÂ·ì¹´í…Œê³ ë¦¬ê´€ë¦¬ì: ì£¼ë¬¸ë³„ ì •ì‚°ìƒíƒœ(ì…ê¸ˆìƒíƒœ) ë³€ê²½ (ì…ê¸ˆëŒ€ê¸°/ì…ê¸ˆì™„ë£Œ/ì·¨ì†Œ/ë³´ë¥˜)"""
    data = request.get_json() or {}
    try:
        order_id = data.get('order_id')
        if order_id is None:
            return jsonify({"success": False, "message": "order_idê°€ ì—†ìŠµë‹ˆë‹¤."}), 400
        order_id = int(order_id)
    except (TypeError, ValueError):
        return jsonify({"success": False, "message": "order_idê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."}), 400
    settlement_status = (data.get('settlement_status') or '').strip()
    if settlement_status not in ('ì…ê¸ˆëŒ€ê¸°', 'ì…ê¸ˆì™„ë£Œ', 'ì·¨ì†Œ', 'ë³´ë¥˜'):
        return jsonify({"success": False, "message": "ìœ íš¨í•œ ì…ê¸ˆìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤."}), 400
    o = Order.query.get(order_id)
    if not o:
        return jsonify({"success": False, "message": "ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 404
    if not current_user.is_admin:
        my_cats = [c.name for c in Category.query.filter_by(manager_email=current_user.email).all()]
        if not my_cats:
            return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
        order_items = OrderItem.query.filter_by(order_id=o.id).all()
        if not any(getattr(oi, 'product_category', None) in my_cats for oi in order_items):
            return jsonify({"success": False, "message": "í•´ë‹¹ ì£¼ë¬¸ì— ëŒ€í•œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    # ì´ë¯¸ ìš”ì²­í•œ ìƒíƒœì™€ ê°™ìœ¼ë©´ ì„±ê³µ ì²˜ë¦¬ (ì¬í´ë¦­ ì‹œ ì˜¤ë¥˜ ë°©ì§€)
    if getattr(o, 'settlement_status', None) == settlement_status:
        return jsonify({"success": True, "message": "ì´ë¯¸ í•´ë‹¹ ìƒíƒœì…ë‹ˆë‹¤."})
    if getattr(o, 'settlement_status', None) == 'ì…ê¸ˆì™„ë£Œ' and settlement_status != 'ì…ê¸ˆì™„ë£Œ':
        return jsonify({"success": False, "message": "ì´ë¯¸ ì…ê¸ˆì™„ë£Œëœ ì£¼ë¬¸ì€ ë‹¤ë¥¸ ìƒíƒœë¡œ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 400
    old_settlement = getattr(o, 'settlement_status', None) or 'ì…ê¸ˆëŒ€ê¸°'
    o.settlement_status = settlement_status
    if settlement_status == 'ì…ê¸ˆì™„ë£Œ':
        o.is_settled = True
        o.settled_at = datetime.now()
    else:
        o.is_settled = False
        o.settled_at = None
    # í•´ë‹¹ ì£¼ë¬¸ì˜ ëª¨ë“  í’ˆëª©(OrderItem)ë„ ë™ì¼í•œ ì…ê¸ˆìƒíƒœë¡œ ì¼ê´„ ë°˜ì˜ (ì •ì‚°ìƒì„¸ëŠ” í’ˆëª© ë‹¨ìœ„ í‘œì‹œ)
    for oi in OrderItem.query.filter_by(order_id=o.id).all():
        oi.settlement_status = settlement_status
        if settlement_status == 'ì…ê¸ˆì™„ë£Œ':
            oi.settled_at = datetime.now()
        else:
            oi.settled_at = None
        db.session.add(OrderItemLog(order_id=o.id, order_item_id=oi.id, log_type='settlement_status', old_value=old_settlement, new_value=settlement_status, created_at=datetime.now()))
    db.session.add(OrderItemLog(order_id=o.id, order_item_id=None, log_type='settlement_status', old_value=old_settlement, new_value=settlement_status, created_at=datetime.now()))
    try:
        db.session.commit()
    except Exception as e:
        db.session.rollback()
        return jsonify({"success": False, "message": "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + str(e)}), 500
    return jsonify({"success": True, "message": "ì…ê¸ˆìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."})

@admin_bp.route('/admin/settlement/item_status', methods=['POST'])


@login_required
def admin_settlement_item_status():
    """í’ˆëª©ID(OrderItem) ê¸°ì¤€ ì…ê¸ˆìƒíƒœ ê°œë³„ ë³€ê²½ (ì…ê¸ˆì™„ë£ŒëŠ” í’ˆëª©ë³„ ì ìš©)"""
    data = request.get_json() or {}
    order_id = data.get('order_id')  # Order.id (pk)
    item_id = data.get('item_id')    # OrderItem.id (pk)
    settlement_status = (data.get('settlement_status') or '').strip()
    if settlement_status not in ('ì…ê¸ˆëŒ€ê¸°', 'ì…ê¸ˆì™„ë£Œ', 'ì·¨ì†Œ', 'ë³´ë¥˜'):
        return jsonify({"success": False, "message": "ìœ íš¨í•œ ì…ê¸ˆìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤."}), 400
    if not order_id or not item_id:
        return jsonify({"success": False, "message": "order_idì™€ item_idê°€ í•„ìš”í•©ë‹ˆë‹¤."}), 400
    o = Order.query.get(order_id)
    if not o:
        return jsonify({"success": False, "message": "ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 404
    oi = OrderItem.query.filter_by(id=int(item_id), order_id=int(order_id)).first()
    if not oi:
        return jsonify({"success": False, "message": "í’ˆëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 404
    if not current_user.is_admin:
        my_cats = [c.name for c in Category.query.filter_by(manager_email=current_user.email).all()]
        if not my_cats or oi.product_category not in my_cats:
            return jsonify({"success": False, "message": "í•´ë‹¹ í’ˆëª©ì— ëŒ€í•œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    old_settlement = getattr(oi, 'settlement_status', None) or 'ì…ê¸ˆëŒ€ê¸°'
    oi.settlement_status = settlement_status
    if settlement_status == 'ì…ê¸ˆì™„ë£Œ':
        oi.settled_at = datetime.now()
    else:
        oi.settled_at = None
    db.session.add(OrderItemLog(order_id=o.id, order_item_id=oi.id, log_type='settlement_status', old_value=old_settlement, new_value=settlement_status, created_at=datetime.now()))
    # Settlement í…Œì´ë¸”ë„ ë™ê¸°í™” (ì •ì‚° ìƒì„¸ëŠ” Settlement ê¸°ì¤€ ì¡°íšŒ)
    st = Settlement.query.filter_by(order_item_id=oi.id).first()
    if st:
        st.settlement_status = settlement_status
        st.settled_at = datetime.now() if settlement_status == 'ì…ê¸ˆì™„ë£Œ' else None
    db.session.commit()
    return jsonify({"success": True, "message": "í’ˆëª© ì…ê¸ˆìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."})

@admin_bp.route('/admin/settlement/bulk_item_status', methods=['POST'])


@login_required
def admin_settlement_bulk_item_status():
    """ì •ì‚° ìƒì„¸ì—ì„œ ì„ íƒí•œ í’ˆëª©ë“¤(OrderItem) ì…ê¸ˆìƒíƒœ ì¼ê´„ ë³€ê²½"""
    data = request.get_json() or {}
    item_ids = data.get('order_item_ids') or data.get('item_ids') or []
    if isinstance(item_ids, str):
        item_ids = [x.strip() for x in item_ids.split(',') if x.strip()]
    item_ids = [int(x) for x in item_ids if str(x).isdigit()]
    settlement_status = (data.get('settlement_status') or '').strip()
    if settlement_status not in ('ì…ê¸ˆëŒ€ê¸°', 'ì…ê¸ˆì™„ë£Œ', 'ì·¨ì†Œ', 'ë³´ë¥˜'):
        return jsonify({"success": False, "message": "ìœ íš¨í•œ ì…ê¸ˆìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤."}), 400
    if not item_ids:
        return jsonify({"success": False, "message": "ì„ íƒí•œ í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤."}), 400
    is_master = current_user.is_admin
    my_cats = [] if is_master else [c.name for c in Category.query.filter_by(manager_email=current_user.email).all()]
    updated = 0
    for oi_id in item_ids:
        oi = OrderItem.query.get(oi_id)
        if not oi:
            continue
        if not is_master and (not my_cats or getattr(oi, 'product_category', None) not in my_cats):
            continue
        old_st = getattr(oi, 'settlement_status', None) or 'ì…ê¸ˆëŒ€ê¸°'
        oi.settlement_status = settlement_status
        if settlement_status == 'ì…ê¸ˆì™„ë£Œ':
            oi.settled_at = datetime.now()
        else:
            oi.settled_at = None
        db.session.add(OrderItemLog(order_id=oi.order_id, order_item_id=oi.id, log_type='settlement_status', old_value=old_st, new_value=settlement_status, created_at=datetime.now()))
        st = Settlement.query.filter_by(order_item_id=oi.id).first()
        if st:
            st.settlement_status = settlement_status
            st.settled_at = datetime.now() if settlement_status == 'ì…ê¸ˆì™„ë£Œ' else None
        updated += 1
    db.session.commit()
    return jsonify({"success": True, "message": f"{updated}ê±´ ì…ê¸ˆìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.", "updated": updated})

@admin_bp.route('/admin/messages/send', methods=['POST'])


@login_required
def admin_messages_send():
    """ê´€ë¦¬ì: íšŒì› ë“±ê¸‰ë³„ë¡œ ë©”ì‹œì§€ ì¼ê´„ ë°œì†¡ (ê°€ì…ì¸ì‚¬Â·ì´ë²¤íŠ¸Â·ê³µì§€Â·ì•ˆë‚´Â·ì§ì ‘ì‘ì„±)"""
    if not current_user.is_admin:
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    data = request.get_json() or request.form
    target = data.get('target_grade', 'all')  # 1,2,3,4,5 or 'all'
    msg_type = (data.get('msg_type') or 'custom').strip() or 'custom'
    title = (data.get('title') or '').strip()
    body = (data.get('body') or '').strip()
    if not title:
        return jsonify({"success": False, "message": "ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."})
    q = User.query.filter(User.is_admin == False)
    if target != 'all' and str(target).isdigit():
        g = int(target)
        if 1 <= g <= 5:
            q = q.filter(User.member_grade == g)
    users = q.all()
    count = 0
    for u in users:
        send_message(u.id, title, body, msg_type, None)
        count += 1
    db.session.commit()
    return jsonify({"success": True, "message": f"{count}ëª…ì—ê²Œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.", "count": count})

@admin_bp.route('/admin/messages/template', methods=['POST'])


@login_required
def admin_messages_template():
    """ê´€ë¦¬ì: ìë™ ë°œì†¡ í…œí”Œë¦¿ ì €ì¥. msg_type, title, body. {order_id}ëŠ” ë°œì†¡ ì‹œ ì£¼ë¬¸ë²ˆí˜¸ë¡œ ì¹˜í™˜ë¨."""
    if not current_user.is_admin:
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    data = request.get_json() or request.form
    msg_type = (data.get('msg_type') or '').strip()
    title = (data.get('title') or '').strip()
    body = (data.get('body') or '').strip()
    if not msg_type:
        return jsonify({"success": False, "message": "msg_typeì´ í•„ìš”í•©ë‹ˆë‹¤."})
    t = MessageTemplate.query.filter_by(msg_type=msg_type).first()
    if not t:
        t = MessageTemplate(msg_type=msg_type, title=title or 'ì•Œë¦¼', body=body)
        db.session.add(t)
    else:
        t.title = title or t.title or 'ì•Œë¦¼'
        t.body = body
    db.session.commit()
    return jsonify({"success": True, "message": "í…œí”Œë¦¿ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."})


@admin_bp.route('/admin/popup/save', methods=['POST'])
    })


@login_required
def admin_popup_save():
    """ì•Œë¦¼ íŒì—… ì €ì¥. id ìˆìœ¼ë©´ ìˆ˜ì •, ì—†ìœ¼ë©´ ì‹ ê·œ."""
    if not current_user.is_admin:
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    data = request.get_json() or request.form
    try:
        pid = data.get('id')
        pid = int(pid) if pid not in (None, '') else None
    except (TypeError, ValueError):
        pid = None
    title = (data.get('title') or '').strip()
    if not title:
        return jsonify({"success": False, "message": "ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."})
    body = (data.get('body') or '').strip()
    popup_type = (data.get('popup_type') or 'notice').strip() or 'notice'
    image_url = (data.get('image_url') or '').strip() or None
    display_date = (data.get('display_date') or '').strip() or None
    start_at = None
    if data.get('start_at'):
        try:
            start_at = datetime.strptime(data.get('start_at')[:19], '%Y-%m-%dT%H:%M:%S')
        except Exception:
            try:
                start_at = datetime.strptime(data.get('start_at')[:16], '%Y-%m-%dT%H:%M')
            except Exception:
                pass
    end_at = None
    if data.get('end_at'):
        try:
            end_at = datetime.strptime(data.get('end_at')[:19], '%Y-%m-%dT%H:%M:%S')
        except Exception:
            try:
                end_at = datetime.strptime(data.get('end_at')[:16], '%Y-%m-%dT%H:%M')
            except Exception:
                pass
    is_active = data.get('is_active') not in (False, 'false', '0', 0)
    sort_order = int(data.get('sort_order') or 0)
    if pid:
        pop = SitePopup.query.get(pid)
        if not pop:
            return jsonify({"success": False, "message": "í•´ë‹¹ íŒì—…ì´ ì—†ìŠµë‹ˆë‹¤."})
    else:
        pop = SitePopup()
    pop.title = title
    pop.body = body
    pop.popup_type = popup_type
    pop.image_url = image_url
    pop.display_date = display_date
    pop.start_at = start_at
    pop.end_at = end_at
    pop.is_active = is_active
    pop.sort_order = sort_order
    if not pid:
        db.session.add(pop)
    db.session.commit()
@admin_bp.route('/admin/popup/delete/<int:pid>', methods=['POST'])
    return jsonify({"success": True, "message": "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", "id": pop.id})


@login_required
def admin_popup_delete(pid):
    if not current_user.is_admin:
        return jsonify({"success": False}), 403
    pop = SitePopup.query.get(pid)
    if pop:
        db.session.delete(pop)
        db.session.commit()
@admin_bp.route('/admin/popup/upload', methods=['POST'])
    return jsonify({"success": True})


@login_required
def admin_popup_upload():
    """ì•Œë¦¼ íŒì—…ìš© ì´ë¯¸ì§€ ì—…ë¡œë“œ. ë°˜í™˜: { url: /static/uploads/... }"""
    if not current_user.is_admin:
        return jsonify({"success": False}), 403
    f = request.files.get('image')
    if not f or f.filename == '':
        return jsonify({"success": False, "message": "ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”."}), 400
    path = save_uploaded_file(f)
    if not path:
        return jsonify({"success": False, "message": "ì—…ë¡œë“œ ì‹¤íŒ¨"}), 400
    return jsonify({"success": True, "url": path})


@admin_bp.route('/admin/order/print')
    return jsonify({"success": True, "message": "ì•Œë¦¼ì´ ì¼œì¡ŒìŠµë‹ˆë‹¤."})


@login_required
def admin_order_print():
    if not (current_user.is_admin or Category.query.filter_by(manager_email=current_user.email).first()):
        return "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.", 403

    categories = Category.query.all()
    my_categories = [c.name for c in categories if c.manager_email == current_user.email]
    is_master = current_user.is_admin

    order_ids = request.args.get('ids', '').split(',')
    target_orders = Order.query.filter(Order.order_id.in_(order_ids)).all()

    # ë°ì´í„° ê°€ê³µ (ë§ˆìŠ¤í‚¹ ë° ìš”ì•½)
    processed_orders = []
    for o in target_orders:
        # ì„±í•¨/ë²ˆí˜¸ ë§ˆìŠ¤í‚¹ ë™ì¼
        name = o.customer_name or ""
        masked_name = name[0] + "*" * (len(name)-1) if len(name) > 1 else name
        
        phone = o.customer_phone or ""
        phone_parts = phone.split('-')
        masked_phone = f"{phone_parts[0]}-****-{phone_parts[2]}" if len(phone_parts) == 3 else "****"

        # âœ… í’ˆëª©: ë§ˆìŠ¤í„°ëŠ” ì „ì²´, ì¹´í…Œê³ ë¦¬ ë§¤ë‹ˆì €ëŠ” í•´ë‹¹ ì¹´í…Œê³ ë¦¬ í’ˆëª©ë§Œ
        all_items = []
        if o.product_details:
            parts = o.product_details.split(' | ')
            for part in parts:
                match = re.search(r'\[(.*?)\] (.*)', part)
                if match:
                    cat_n = match.group(1).strip()
                    items_str = match.group(2).strip()
                    if is_master or cat_n in my_categories:
                        for item in items_str.split(', '):
                            clean_item = item.strip()
                            if clean_item:
                                all_items.append(clean_item)

        # ì¹´í…Œê³ ë¦¬ ë§¤ë‹ˆì €ëŠ” í•´ë‹¹ í’ˆëª©ì´ ì—†ëŠ” ì£¼ë¬¸ì€ ì†¡ì¥ì—ì„œ ì œì™¸
        if not is_master and not all_items:
            continue

        # âœ… í˜„ê´€ ë¹„ë°€ë²ˆí˜¸ ì œì™¸ ë¡œì§ (ìˆ«ì í¬í•¨ ë‹¨ì–´ í•„í„°ë§ ê°•í™”)
        raw_memo = o.request_memo or ""
        clean_words = [w for w in raw_memo.split() if not (any(c.isdigit() for c in w) or any(k in w for k in ['ë¹„ë²ˆ', 'ë²ˆí˜¸', 'í˜„ê´€', '#', '*']))]
        clean_memo = " ".join(clean_words) if clean_words else "ìš”ì²­ì‚¬í•­ ì—†ìŒ"

        processed_orders.append({
            'order_id': o.order_id,
            'masked_name': masked_name,
            'masked_phone': masked_phone,
            'all_items': all_items,
            'delivery_address': o.delivery_address,
            'clean_memo': clean_memo,
            'created_at': o.created_at
        })
# SyntaxWarning ë°©ì§€ë¥¼ ìœ„í•´ ì‹œì‘ ë¶€ë¶„ì— rì„ ë¶™ì—¬ r""" ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
    invoice_html = r"""
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap');
            body { font-family: 'Noto Sans KR', sans-serif; background: #f1f1f1; margin: 0; padding: 0; --inv-scale: 1; --inv-width-mm: 80; }
            .print-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; padding: 1rem; align-items: flex-start; }
            .invoice-card { background: white; border: 2px solid #000; box-sizing: border-box; display: flex; flex-direction: column; position: relative; transform-origin: top left; }
            .item-list { overflow: hidden; }
            .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

            /* A4 1ì¥: 1ê±´ì´ A4 í•œ í˜ì´ì§€ ì „ì²´ */
            body.layout-a4-1 .invoice-card { width: 21cm; min-height: 29.2cm; padding: 1.5rem; margin: 0 auto 1rem; }
            body.layout-a4-1 .item-list { max-height: 12cm; }
            /* A4 2ë¶„í•  */
            body.layout-a4-2 .print-container { flex-direction: column; align-items: center; }
            body.layout-a4-2 .invoice-card { width: 21cm; height: 14.6cm; padding: 1rem; margin: 0 auto 0.5rem; }
            body.layout-a4-2 .item-list { max-height: 4.2cm; }
            /* A4 3ë¶„í•  */
            body.layout-a4-3 .print-container { flex-direction: column; align-items: center; }
            body.layout-a4-3 .invoice-card { width: 21cm; height: 9.7cm; padding: 0.6rem; margin: 0 auto 0.3rem; }
            body.layout-a4-3 .item-list { max-height: 2.6cm; }
            /* A4 4ë“±ë¶„: ì„¸ë¡œ 2ì—´(2x2), ë¹„ìœ¨ë§ì¶° ì…€ ì•ˆì— ì¶•ì†Œ */
            body.layout-a4-4 .print-container {
                display: grid; grid-template-columns: 1fr 1fr; grid-auto-rows: 14.6cm;
                gap: 0; padding: 0; max-width: 21cm; margin: 0 auto;
            }
            body.layout-a4-4 .invoice-card {
                width: 100%; height: 100%; min-height: 0; padding: 0.4rem;
                box-sizing: border-box; margin: 0; overflow: hidden;
            }
            body.layout-a4-4 .invoice-card .text-4xl { font-size: 1rem !important; }
            body.layout-a4-4 .invoice-card .text-2xl { font-size: 0.8rem !important; }
            body.layout-a4-4 .invoice-card .text-xl { font-size: 0.7rem !important; }
            body.layout-a4-4 .item-list { max-height: 4.5cm; }
            /* íœ´ëŒ€ìš©: ê°€ë¡œí­ mm + ìŠ¤ì¼€ì¼ë¡œ ì¡°ì ˆ */
            body.layout-portable .invoice-card {
                width: calc(var(--inv-width-mm) * 0.2645833rem);
                min-height: 8cm;
                padding: 0.4rem;
                transform: scale(var(--inv-scale));
                margin: 0.5rem;
            }
            body.layout-portable .item-list { max-height: 3.5cm; }

            @media print {
                @page { size: A4; margin: 8mm; }
                .no-print { display: none !important; }
                body { background: white; }
                .print-container { gap: 0; padding: 0; }
                .invoice-card { border: 1.5px solid #000; page-break-inside: avoid; }
                body.layout-a4-1 .invoice-card { margin: 0 auto; page-break-after: always; }
                body.layout-a4-1 .invoice-card:last-child { page-break-after: auto; }
                body.layout-a4-2 .invoice-card { margin: 0 auto; }
                body.layout-a4-2 .invoice-card:nth-child(2n) { page-break-after: always; }
                body.layout-a4-2 .invoice-card:last-child:nth-child(2n-1) { page-break-after: always; }
                body.layout-a4-3 .invoice-card { margin: 0 auto; }
                body.layout-a4-3 .invoice-card:nth-child(3n) { page-break-after: always; }
                body.layout-a4-3 .invoice-card:last-child { page-break-after: always; }
                body.layout-a4-4 .print-container { display: grid; grid-template-columns: 1fr 1fr; grid-auto-rows: 14.6cm; max-width: 21cm; }
                body.layout-a4-4 .invoice-card { margin: 0; }
                body.layout-a4-4 .invoice-card:nth-child(4n) { page-break-after: always; }
                body.layout-a4-4 .invoice-card:last-child { page-break-after: always; }
                body.layout-portable .invoice-card {
                    width: calc(var(--inv-width-mm) * 0.2645833rem) !important;
                    transform: scale(var(--inv-scale)) !important;
                    margin: 0 auto 2mm !important;
                    page-break-after: always;
                }
                body.layout-portable .invoice-card:last-child { page-break-after: auto; }
            }
        </style>
    </head>
    <body class="layout-a4-2">
        <div class="no-print p-4 bg-white border-b sticky top-0 z-50 shadow-md">
            <p class="text-sm font-bold text-blue-600 mb-3">ì´ {{ orders|length }}ê±´ Â· ì¶œë ¥ ì–‘ì‹ ì„ íƒ í›„ ì¸ì‡„í•˜ì„¸ìš”.</p>
            <div class="flex flex-wrap items-center gap-3 mb-2">
                <span class="text-xs font-black text-gray-500">ì–‘ì‹:</span>
                <button type="button" onclick="setLayout('layout-a4-1')" class="layout-btn px-4 py-2 rounded-xl text-xs font-black border-2 border-gray-300 hover:border-teal-500 hover:bg-teal-50" data-layout="layout-a4-1">A4 1ì¥</button>
                <button type="button" onclick="setLayout('layout-a4-2')" class="layout-btn px-4 py-2 rounded-xl text-xs font-black border-2 border-teal-500 bg-teal-50 text-teal-700" data-layout="layout-a4-2">A4 2ë¶„í• </button>
                <button type="button" onclick="setLayout('layout-a4-3')" class="layout-btn px-4 py-2 rounded-xl text-xs font-black border-2 border-gray-300 hover:border-teal-500 hover:bg-teal-50" data-layout="layout-a4-3">A4 3ë¶„í• </button>
                <button type="button" onclick="setLayout('layout-a4-4')" class="layout-btn px-4 py-2 rounded-xl text-xs font-black border-2 border-gray-300 hover:border-teal-500 hover:bg-teal-50" data-layout="layout-a4-4">A4 4ë“±ë¶„</button>
                <button type="button" onclick="setLayout('layout-portable')" class="layout-btn px-4 py-2 rounded-xl text-xs font-black border-2 border-gray-300 hover:border-teal-500 hover:bg-teal-50" data-layout="layout-portable">íœ´ëŒ€ìš©</button>
            </div>
            <div id="portable-options" class="hidden flex-wrap items-center gap-4 mt-3 p-3 bg-gray-50 rounded-xl">
                <label class="flex items-center gap-2">
                    <span class="text-xs font-black text-gray-600">í­(mm):</span>
                    <select id="portable-width" onchange="applyPortableSize()" class="border rounded-lg px-2 py-1 text-xs font-black">
                        <option value="58">58mm</option>
                        <option value="80" selected>80mm</option>
                        <option value="100">100mm</option>
                    </select>
                </label>
                <label class="flex items-center gap-2">
                    <span class="text-xs font-black text-gray-600">í¬ê¸°:</span>
                    <input type="range" id="portable-scale" min="0.5" max="1.5" step="0.05" value="1" oninput="applyPortableSize()" class="w-24">
                    <span id="portable-scale-val" class="text-xs font-black text-gray-700">100%</span>
                </label>
            </div>
            <div class="mt-3">
                <button onclick="window.print()" class="bg-blue-600 text-white px-8 py-2.5 rounded-xl font-black text-sm shadow-lg hover:bg-blue-700">ğŸ–¨ï¸ ì¸ì‡„</button>
            </div>
        </div>

        <div class="print-container">
            {% for o in orders %}
            <div class="invoice-card">
                <div class="flex justify-between items-center border-b-4 border-black pb-2 mb-2">
                    <h1 class="text-2xl font-black tracking-tighter text-teal-700 italic">ë°”êµ¬ë‹ˆì‚¼ì´Œ</h1>
                    <p class="text-[11px] font-black bg-black text-white px-3 py-1 rounded">ì†¡ë„ ì „ìš© ë°°ì†¡</p>
                </div>
                <div class="flex justify-between items-start mb-2">
                    <div class="w-2/3">
                        <p class="text-[9px] text-gray-400 font-black uppercase mb-1">Recipient</p>
                        <p class="text-4xl font-black text-gray-900 leading-none mb-1">{{ o.masked_name }}</p>
                        <p class="text-2xl font-black text-gray-700">{{ o.masked_phone }}</p>
                    </div>
                    <div class="w-1/3 text-right">
                        <p class="text-[9px] text-gray-400 font-black uppercase mb-1">Order ID</p>
                        <p class="text-xs font-black bg-gray-100 px-2 py-1 inline-block rounded">{{ o.order_id[-8:] }}</p>
                        <p class="text-[10px] text-gray-400 mt-1 font-bold">{{ o.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    </div>
                </div>
                <div class="bg-gray-50 p-3 rounded-xl border-l-8 border-teal-600 mb-2">
                    <p class="text-[9px] text-gray-400 font-black mb-1 uppercase">Shipping Address</p>
                    <p class="text-xl font-black text-black leading-tight mb-1">{{ o.delivery_address }}</p>
                    <div class="bg-white px-2 py-1.5 rounded-lg border border-red-100 mt-1">
                        <p class="text-[11px] font-black text-red-600">ìš”ì²­: {{ o.clean_memo }}</p>
                    </div>
                </div>
                <div class="flex-grow overflow-hidden">
                    <p class="text-[9px] text-gray-400 font-black mb-1 border-b pb-1 uppercase">Order Items</p>
                    <div class="item-list space-y-1">
                        {% for item in o.all_items %}
                        <div class="flex items-center justify-between border-b border-gray-50 pb-0.5">
                            <span class="text-[13px] font-black text-gray-800 line-clamp-1">â–¡ {{ item }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="pt-2 border-t border-dashed border-gray-300 text-center opacity-40">
                    <p class="text-[8px] font-black italic uppercase">Basket Uncle</p>
                </div>
            </div>
            {% endfor %}
        </div>
        <script>
        function setLayout(cls) {
            document.body.className = cls;
            document.querySelectorAll('.layout-btn').forEach(function(b) {
                b.classList.remove('border-teal-500', 'bg-teal-50', 'text-teal-700');
                b.classList.add('border-gray-300');
                if (b.getAttribute('data-layout') === cls) {
                    b.classList.add('border-teal-500', 'bg-teal-50', 'text-teal-700');
                    b.classList.remove('border-gray-300');
                }
            });
            var po = document.getElementById('portable-options');
            if (po) po.classList.toggle('hidden', cls !== 'layout-portable');
        }
        function applyPortableSize() {
            var w = document.getElementById('portable-width');
            var s = document.getElementById('portable-scale');
            var v = document.getElementById('portable-scale-val');
            if (w) document.body.style.setProperty('--inv-width-mm', w.value);
            if (s) {
                document.body.style.setProperty('--inv-scale', s.value);
                if (v) v.textContent = Math.round(parseFloat(s.value) * 100) + '%';
            }
        }
        </script>
    </body>
    </html>
    """
    return render_template_string(invoice_html, orders=processed_orders)
@app.context_processor
def inject_globals():
    """ì „ì—­ í…œí”Œë¦¿ ë³€ìˆ˜ ì£¼ì…"""
    cart_count = 0
    unread_message_count = 0
    grade = 1
    if current_user.is_authenticated:
        total_qty = db.session.query(db.func.sum(Cart.quantity)).filter(Cart.user_id == current_user.id).scalar()
        cart_count = total_qty if total_qty else 0
        grade = getattr(current_user, 'member_grade', 1) or 1
        unread_message_count = UserMessage.query.filter_by(user_id=current_user.id, read_at=None).count()
    categories = categories_for_member_grade(grade).all()
    managers = [c.manager_email for c in categories if c.manager_email]
    return dict(cart_count=cart_count, unread_message_count=unread_message_count, now=datetime.now(), managers=managers, nav_categories=categories)

@admin_bp.route('/admin/auth-status')
    })


@login_required
def admin_auth_status():
    """í†µí•© ë¡œê·¸ì¸ ì„¤ì • ì ê²€ (ê´€ë¦¬ì ì „ìš©)."""
    if not getattr(current_user, 'is_admin', False):
        return jsonify({"error": "ê¶Œí•œ ì—†ìŒ"}), 403
    return _auth_status_json()


@admin_bp.route('/admin/order/bulk_request_delivery', methods=['POST'])

# admin() í•¨ìˆ˜ ë‚´ ì£¼ë¬¸ ì¡°íšŒ ë¶€ë¶„ì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€í•˜ë˜ UIì—ì„œ í•„ë“œë¥¼ ì‚¬ìš©í•¨
@login_required
def admin_bulk_request_delivery():
    """ì—¬ëŸ¬ ì£¼ë¬¸ì„ í•œêº¼ë²ˆì— ë°°ì†¡ ìš”ì²­ ìƒíƒœë¡œ ë³€ê²½ (ìƒˆë¡œê³ ì¹¨ ì—†ìŒ)"""
    if not (current_user.is_admin or Category.query.filter_by(manager_email=current_user.email).first()):
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    
    data = request.get_json()
    order_ids = data.get('order_ids', [])
    
    if not order_ids:
        return jsonify({"success": False, "message": "ì„ íƒëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤."})

    # 'ê²°ì œì™„ë£Œ' ìƒíƒœì¸ ì£¼ë¬¸ë“¤ë§Œ ì°¾ì•„ì„œ 'ë°°ì†¡ìš”ì²­'ìœ¼ë¡œ ì¼ê´„ ë³€ê²½ + í’ˆëª©ë³„ ìƒíƒœ ë°˜ì˜
    orders = Order.query.filter(Order.order_id.in_(order_ids), Order.status == 'ê²°ì œì™„ë£Œ').all()
    
    count = 0
    for o in orders:
        o.status = 'ë°°ì†¡ìš”ì²­'
        # í•´ë‹¹ ì£¼ë¬¸ì˜ ëª¨ë“  í’ˆëª©ì—ë„ ë°°ì†¡ìš”ì²­ ìƒíƒœ ì ìš©
        for oi in OrderItem.query.filter_by(order_id=o.id, cancelled=False).all():
            oi.item_status = 'ë°°ì†¡ìš”ì²­'
        title, body = get_template_content('delivery_requested', order_id=o.order_id)
        send_message(o.user_id, title, body, 'delivery_requested', o.id)
        count += 1

    db.session.commit()
    return jsonify({"success": True, "message": f"{count}ê±´ì˜ ë°°ì†¡ ìš”ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."})


def _save_delivery_proof_image(file):
    """ë°°ì†¡ì™„ë£Œ ì¦ë¹™ ì‚¬ì§„ ì €ì¥. ë°˜í™˜: URL ë˜ëŠ” None. í—ˆìš© í™•ì¥ìë§Œ ì €ì¥."""
    if not file or not getattr(file, 'filename', None) or file.filename == '' or not _is_allowed_image_filename(file.filename):
        return None
    folder = os.path.join(app.config['UPLOAD_FOLDER'], 'delivery_proof')
    os.makedirs(folder, exist_ok=True)
    ext = os.path.splitext(secure_filename(file.filename))[1].lower() or '.jpg'
    if ext not in ALLOWED_IMAGE_EXTENSIONS:
        ext = '.jpg'
    new_name = f"proof_{datetime.now().strftime('%Y%m%d_%H%M%S_%f')}{ext}"
    path = os.path.join(folder, new_name)
    try:
        file.save(path)
        return f"/static/uploads/delivery_proof/{new_name}"
    except Exception:
        return None

@admin_bp.route('/admin/order/item_status', methods=['POST'])


@login_required
def admin_order_item_status():
    """ê´€ë¦¬ì: í’ˆëª©ë³„ ìƒíƒœ ì ìš© (í’ˆì ˆì·¨ì†ŒÂ·ë°°ì†¡ì§€ì—°Â·ë°°ì†¡ì¤‘Â·ë°°ì†¡ì™„ë£Œ ë“±). ë°°ì†¡ì™„ë£Œ ì‹œ ì²¨ë¶€ ì´ë¯¸ì§€ ìˆìœ¼ë©´ ê³ ê° ë©”ì‹œì§€ì— í¬í•¨."""
    if not (current_user.is_admin or Category.query.filter_by(manager_email=current_user.email).first()):
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    if request.content_type and 'multipart/form-data' in request.content_type:
        order_id = request.form.get('order_id', type=int)
        item_id = request.form.get('item_id', type=int)
        item_status = (request.form.get('item_status') or '').strip()
        status_message = (request.form.get('status_message') or '').strip() or None
        delivery_photo = request.files.get('delivery_photo')
    else:
        data = request.get_json() or {}
        order_id = data.get('order_id')
        item_id = data.get('item_id')
        item_status = (data.get('item_status') or '').strip()
        status_message = (data.get('status_message') or '').strip() or None
        delivery_photo = None
    if not order_id or not item_id or not item_status:
        return jsonify({"success": False, "message": "order_id, item_id, item_statusê°€ í•„ìš”í•©ë‹ˆë‹¤."})
    order = Order.query.get(order_id)
    oi = OrderItem.query.filter_by(id=item_id, order_id=order_id).first()
    if not order or not oi:
        return jsonify({"success": False, "message": "ì£¼ë¬¸ ë˜ëŠ” í’ˆëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."})
    # ì¹´í…Œê³ ë¦¬ ë§¤ë‹ˆì €ëŠ” ìê¸° ì¹´í…Œê³ ë¦¬ í’ˆëª©ë§Œ
    if not current_user.is_admin and oi.product_category not in [c.name for c in Category.query.filter_by(manager_email=current_user.email).all()]:
        return jsonify({"success": False, "message": "í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    allowed = ('ê²°ì œì™„ë£Œ', 'ë°°ì†¡ìš”ì²­', 'ë°°ì†¡ì¤‘', 'ë°°ì†¡ì™„ë£Œ', 'í’ˆì ˆì·¨ì†Œ', 'ë°°ì†¡ì§€ì—°', 'ë¶€ë¶„ì·¨ì†Œ')
    if item_status not in allowed:
        return jsonify({"success": False, "message": f"item_statusëŠ” {allowed} ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•©ë‹ˆë‹¤."})

    old_item_status = getattr(oi, 'item_status', None) or 'ê²°ì œì™„ë£Œ'
    if item_status == 'í’ˆì ˆì·¨ì†Œ':
        if oi.cancelled:
            return jsonify({"success": False, "message": "ì´ë¯¸ ì·¨ì†Œëœ í’ˆëª©ì…ë‹ˆë‹¤."})
        cancel_amount = oi.price * oi.quantity
        tax_free_cancel = (oi.price * oi.quantity) if (oi.tax_type == 'ë©´ì„¸') else 0
        if order.payment_key and cancel_amount > 0:
            url = f"https://api.tosspayments.com/v1/payments/{order.payment_key}/cancel"
            auth_key = base64.b64encode(f"{TOSS_SECRET_KEY}:".encode()).decode()
            body = {"cancelAmount": cancel_amount, "cancelReason": "í’ˆì ˆë¡œ ì¸í•œ ë¶€ë¶„ ì·¨ì†Œ"}
            if tax_free_cancel:
                body["taxFreeAmount"] = tax_free_cancel
            res = requests.post(url, json=body, headers={"Authorization": f"Basic {auth_key}", "Content-Type": "application/json"})
            if res.status_code not in (200, 201):
                try:
                    err = res.json()
                    return jsonify({"success": False, "message": err.get("message", "í™˜ë¶ˆ ìš”ì²­ ì‹¤íŒ¨")})
                except Exception:
                    return jsonify({"success": False, "message": "í™˜ë¶ˆ ìš”ì²­ ì‹¤íŒ¨"})
        oi.cancelled = True
        oi.item_status = 'í’ˆì ˆì·¨ì†Œ'
        oi.status_message = status_message or "í’ˆì ˆë¡œ ì¸í•œ ë¶€ë¶„ ì·¨ì†Œ"
        p = Product.query.get(oi.product_id)
        if p:
            p.stock += oi.quantity
        _recalc_order_from_items(order)
        title, body = get_template_content('out_of_stock', order_id=order.order_id)
        send_message(order.user_id, title, body, 'out_of_stock', order.id)
    else:
        oi.item_status = item_status
        oi.status_message = status_message
        if item_status == 'ë°°ì†¡ì™„ë£Œ' and delivery_photo:
            proof_url = _save_delivery_proof_image(delivery_photo)
            if proof_url:
                oi.delivery_proof_image_url = proof_url
        if not oi.cancelled and item_status == 'ë°°ì†¡ì™„ë£Œ':
            apply_points_on_delivery_complete(oi)  # ì •ì‚°ë²ˆí˜¸(sales_amount) ê¸°ì¤€ í¬ì¸íŠ¸ ì ë¦½ (1íšŒë§Œ)

    db.session.add(OrderItemLog(order_id=order_id, order_item_id=item_id, log_type='item_status', old_value=old_item_status, new_value=item_status, created_at=datetime.now()))
    db.session.commit()
    # ë°°ì†¡ ìƒíƒœ ë³€ê²½ ì‹œ íšŒì›ì—ê²Œ ìë™ ë©”ì‹œì§€ (ë°°ì†¡ì™„ë£Œ ì‹œ ê¸°ì‚¬ ì‚¬ì§„ ìˆìœ¼ë©´ ì²¨ë¶€)
    if item_status in ('ë°°ì†¡ìš”ì²­', 'ë°°ì†¡ì¤‘', 'ë°°ì†¡ì™„ë£Œ', 'ë°°ì†¡ì§€ì—°'):
        if item_status == 'ë°°ì†¡ìš”ì²­':
            title, body = get_template_content('delivery_requested', order_id=order.order_id)
            send_message(order.user_id, title, body, 'delivery_requested', order.id)
        elif item_status == 'ë°°ì†¡ì¤‘':
            title, body = get_template_content('delivery_in_progress', order_id=order.order_id)
            send_message(order.user_id, title, body, 'delivery_in_progress', order.id)
        elif item_status == 'ë°°ì†¡ì™„ë£Œ':
            title, body = get_template_content('delivery_complete', order_id=order.order_id)
            proof_url = getattr(oi, 'delivery_proof_image_url', None) or None
            send_message(order.user_id, title, body, 'delivery_complete', order.id, image_url=proof_url)
        elif item_status == 'ë°°ì†¡ì§€ì—°':
            title, body = get_template_content('delivery_delayed', order_id=order.order_id)
            send_message(order.user_id, title, body, 'delivery_delayed', order.id)
        db.session.commit()
    return jsonify({"success": True, "message": f"í’ˆëª© ìƒíƒœê°€ '{item_status}'(ìœ¼)ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤."})

@admin_bp.route('/admin/order/<int:order_id>/items')


@login_required
def admin_order_items(order_id):
    """ê´€ë¦¬ì: ì£¼ë¬¸ë³„ í’ˆëª© ëª©ë¡ ë° í’ˆëª©ë³„ ìƒíƒœ/ë©”ì‹œì§€ ì ìš© í™”ë©´"""
    if not (current_user.is_admin or Category.query.filter_by(manager_email=current_user.email).first()):
        flash("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin')
    order = Order.query.get_or_404(order_id)
    my_categories = [c.name for c in Category.query.filter_by(manager_email=current_user.email).all()]
    if not current_user.is_admin and order.id:  # ì£¼ë¬¸ì— ë‚´ ì¹´í…Œê³ ë¦¬ í’ˆëª©ì´ ìˆëŠ”ì§€ í™•ì¸
        items = OrderItem.query.filter_by(order_id=order_id).all()
        if not any(oi.product_category in my_categories for oi in items):
            flash("í•´ë‹¹ ì£¼ë¬¸ì— ëŒ€í•œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")
            return redirect('/admin?tab=orders')
    order_items = OrderItem.query.filter_by(order_id=order_id).order_by(OrderItem.id.asc()).all()
    _order_item_status_tpl = """
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="bg-gray-50 p-6 font-sans text-sm">
        <div class="max-w-4xl mx-auto">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-xl font-black text-gray-800">í’ˆëª©ë³„ ìƒíƒœ ê´€ë¦¬ Â· ì£¼ë¬¸ {{ order.order_id[-12:] if order.order_id else order_id }}</h1>
                <a href="/admin?tab=orders" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-xl font-bold hover:bg-gray-300">ëª©ë¡ìœ¼ë¡œ</a>
            </div>
            <p class="text-gray-500 mb-4">ê° í’ˆëª©ì— ìƒíƒœ(í’ˆì ˆì·¨ì†ŒÂ·ë°°ì†¡ì§€ì—°Â·ë°°ì†¡ì¤‘Â·ë°°ì†¡ì™„ë£Œ ë“±)ì™€ ì‚¬ìœ  ë©”ì‹œì§€ë¥¼ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-gray-100 border-b border-gray-200">
                        <tr>
                            <th class="p-4 font-black">í’ˆëª©</th>
                            <th class="p-4 font-black">ìˆ˜ëŸ‰/ê¸ˆì•¡</th>
                            <th class="p-4 font-black">í˜„ì¬ ìƒíƒœ</th>
                            <th class="p-4 font-black">ìƒíƒœ ë³€ê²½</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for oi in order_items %}
                        <tr class="border-b border-gray-50 hover:bg-gray-50/50" data-item-id="{{ oi.id }}">
                            <td class="p-4">
                                <span class="font-bold text-gray-800">{{ oi.product_name }}</span>
                                {% if oi.cancelled %}<span class="ml-2 text-red-500 text-xs font-black">ì·¨ì†Œë¨</span>{% endif %}
                            </td>
                            <td class="p-4 text-gray-600">{{ oi.quantity }}ê°œ Â· {{ "{:,}".format(oi.price * oi.quantity) }}ì›</td>
                            <td class="p-4">
                                <span class="font-bold {% if oi.item_status in ['í’ˆì ˆì·¨ì†Œ','ë¶€ë¶„ì·¨ì†Œ'] %}text-red-600{% elif oi.item_status == 'ë°°ì†¡ì§€ì—°' %}text-amber-600{% else %}text-teal-600{% endif %}">{{ oi.item_status or 'ê²°ì œì™„ë£Œ' }}</span>
                                {% if oi.status_message %}<p class="text-xs text-gray-500 mt-1">{{ oi.status_message }}</p>{% endif %}
                            </td>
                            <td class="p-4">
                                {% if not oi.cancelled %}
                                <div class="flex flex-wrap gap-2 items-end">
                                    <select class="item-status-select border border-gray-200 rounded-lg px-3 py-2 font-bold text-xs" data-order-id="{{ order.id }}" data-item-id="{{ oi.id }}">
                                        {% set current = oi.item_status or 'ê²°ì œì™„ë£Œ' %}
                                        <option value="ê²°ì œì™„ë£Œ" {% if current == 'ê²°ì œì™„ë£Œ' %}selected{% endif %}>ê²°ì œì™„ë£Œ</option>
                                        <option value="ë°°ì†¡ìš”ì²­" {% if current == 'ë°°ì†¡ìš”ì²­' %}selected{% endif %}>ë°°ì†¡ìš”ì²­</option>
                                        <option value="ë°°ì†¡ì§€ì—°" {% if current == 'ë°°ì†¡ì§€ì—°' %}selected{% endif %}>ë°°ì†¡ì§€ì—°</option>
                                        <option value="ë°°ì†¡ì¤‘" {% if current == 'ë°°ì†¡ì¤‘' %}selected{% endif %}>ë°°ì†¡ì¤‘</option>
                                        <option value="ë°°ì†¡ì™„ë£Œ" {% if current == 'ë°°ì†¡ì™„ë£Œ' %}selected{% endif %}>ë°°ì†¡ì™„ë£Œ</option>
                                        <option value="í’ˆì ˆì·¨ì†Œ" {% if current == 'í’ˆì ˆì·¨ì†Œ' %}selected{% endif %}>í’ˆì ˆì·¨ì†Œ</option>
                                    </select>
                                    <input type="text" class="item-message border border-gray-200 rounded-lg px-3 py-2 w-40 text-xs" placeholder="ì‚¬ìœ  ë©”ì‹œì§€" value="{{ oi.status_message or '' }}">
                                    <div class="item-delivery-photo-wrap hidden">
                                        <label class="text-[10px] text-gray-500 block mb-1">ë°°ì†¡ì™„ë£Œ ì‚¬ì§„ (ê³ ê° ë©”ì‹œì§€ì— ì²¨ë¶€)</label>
                                        <input type="file" class="item-delivery-photo border border-gray-200 rounded-lg px-2 py-1 text-[10px]" accept="image/*">
                                    </div>
                                    {% if getattr(oi, 'delivery_proof_image_url', None) %}<a href="{{ oi.delivery_proof_image_url }}" target="_blank" class="text-[10px] text-teal-600 font-bold">ê¸°ì¡´ ì‚¬ì§„ ë³´ê¸°</a>{% endif %}
                                    <button type="button" class="apply-item-status bg-teal-600 text-white px-4 py-2 rounded-lg font-bold text-xs hover:bg-teal-700" data-order-id="{{ order.id }}" data-item-id="{{ oi.id }}">ì ìš©</button>
                                </div>
                                {% else %}
                                <span class="text-gray-400 text-xs">ì·¨ì†Œëœ í’ˆëª©</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <p id="api-message" class="mt-4 text-sm font-bold hidden"></p>
        </div>
        <script>
        document.querySelectorAll('.item-status-select').forEach(function(select) {
            select.addEventListener('change', function() {
                var row = this.closest('tr');
                var wrap = row ? row.querySelector('.item-delivery-photo-wrap') : null;
                if (wrap) { wrap.classList.toggle('hidden', this.value !== 'ë°°ì†¡ì™„ë£Œ'); }
            });
            var row = select.closest('tr');
            var wrap = row ? row.querySelector('.item-delivery-photo-wrap') : null;
            if (wrap && select.value === 'ë°°ì†¡ì™„ë£Œ') wrap.classList.remove('hidden');
        });
        document.querySelectorAll('.apply-item-status').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var orderId = this.dataset.orderId;
                var itemId = this.dataset.itemId;
                var row = this.closest('tr');
                var select = row.querySelector('.item-status-select');
                var message = row.querySelector('.item-message');
                var photoInput = row.querySelector('.item-delivery-photo');
                var status = select ? select.value : '';
                var msg = message ? message.value.trim() : '';
                var hasFile = photoInput && photoInput.files && photoInput.files.length > 0 && status === 'ë°°ì†¡ì™„ë£Œ';
                if (hasFile) {
                    var fd = new FormData();
                    fd.append('order_id', orderId);
                    fd.append('item_id', itemId);
                    fd.append('item_status', status);
                    if (msg) fd.append('status_message', msg);
                    fd.append('delivery_photo', photoInput.files[0]);
                    fetch('/admin/order/item_status', { method: 'POST', body: fd }).then(function(r) { return r.json(); }).then(function(data) {
                        var el = document.getElementById('api-message');
                        el.textContent = data.message || (data.success ? 'ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì˜¤ë¥˜');
                        el.classList.remove('hidden');
                        el.className = 'mt-4 text-sm font-bold ' + (data.success ? 'text-teal-600' : 'text-red-600');
                        if (data.success) setTimeout(function() { location.reload(); }, 800);
                    }).catch(function() {
                        document.getElementById('api-message').textContent = 'í†µì‹  ì˜¤ë¥˜';
                        document.getElementById('api-message').classList.remove('hidden').classList.add('text-red-600');
                    });
                } else {
                    fetch('/admin/order/item_status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ order_id: parseInt(orderId), item_id: parseInt(itemId), item_status: status, status_message: msg || null })
                    }).then(function(r) { return r.json(); }).then(function(data) {
                        var el = document.getElementById('api-message');
                        el.textContent = data.message || (data.success ? 'ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì˜¤ë¥˜');
                        el.classList.remove('hidden');
                        el.className = 'mt-4 text-sm font-bold ' + (data.success ? 'text-teal-600' : 'text-red-600');
                        if (data.success) setTimeout(function() { location.reload(); }, 800);
                    }).catch(function() {
                        document.getElementById('api-message').textContent = 'í†µì‹  ì˜¤ë¥˜';
                        document.getElementById('api-message').classList.remove('hidden', 'text-teal-600').classList.add('text-red-600');
                    });
                }
            });
        });
        </script>
    </body>
    </html>
    """
    return render_template_string(_order_item_status_tpl, order=order, order_items=order_items)


def _ensure_delivery_zone_columns():
    """delivery_zone í…Œì´ë¸”ì— í€µì§€ì—­Â·ê·¸ ì™¸ ë°°ì†¡ë¶ˆê°€ìš© ì»¬ëŸ¼ì´ ì—†ìœ¼ë©´ ì¶”ê°€ (ê¸°ì¡´ DB í˜¸í™˜)."""
    try:
        from sqlalchemy import inspect
        insp = inspect(db.engine)
        cols = [c['name'] for c in insp.get_columns('delivery_zone')]
        if 'quick_region_names' not in cols:
            db.session.execute(text("ALTER TABLE delivery_zone ADD COLUMN quick_region_names TEXT"))
            db.session.commit()
    except Exception:
        try:
            db.session.rollback()
        except Exception:
            pass
    try:
        from sqlalchemy import inspect
        insp = inspect(db.engine)
        cols = [c['name'] for c in insp.get_columns('delivery_zone')]
        if 'use_quick_region_only' not in cols:
            db.session.execute(text("ALTER TABLE delivery_zone ADD COLUMN use_quick_region_only BOOLEAN DEFAULT 0"))
            db.session.commit()
    except Exception:
        try:
            db.session.rollback()
        except Exception:
            pass
    try:
        from sqlalchemy import inspect
        insp = inspect(db.engine)
        cols = [c['name'] for c in insp.get_columns('delivery_zone')]
        if 'quick_region_polygon_json' not in cols:
            db.session.execute(text("ALTER TABLE delivery_zone ADD COLUMN quick_region_polygon_json TEXT"))
            db.session.commit()
    except Exception:
        try:
            db.session.rollback()
        except Exception:
            pass
    for col, sql in [
        ('quick_extra_fee', 'ALTER TABLE delivery_zone ADD COLUMN quick_extra_fee INTEGER DEFAULT 10000'),
        ('quick_extra_message', 'ALTER TABLE delivery_zone ADD COLUMN quick_extra_message TEXT'),
    ]:
        try:
            insp = inspect(db.engine)
            cols = [c['name'] for c in insp.get_columns('delivery_zone')]
            if col not in cols:
                db.session.execute(text(sql))
                db.session.commit()
        except Exception:
            try:
                db.session.rollback()
            except Exception:
                pass
    try:
        insp = inspect(db.engine)
        cols = [c['name'] for c in insp.get_columns('order')]
        if 'quick_extra_fee' not in cols:
            db.session.execute(text("ALTER TABLE \"order\" ADD COLUMN quick_extra_fee INTEGER DEFAULT 0"))
            db.session.commit()
    except Exception:
        try:
            db.session.rollback()
        except Exception:
@admin_bp.route('/admin/delivery_zone/api', methods=['GET', 'POST'])
            pass


@login_required
def admin_delivery_zone_api():
    """ë°°ì†¡êµ¬ì—­: GET=í´ë¦¬ê³¤Â·í€µì§€ì—­ ë°˜í™˜, POST=í´ë¦¬ê³¤ ë˜ëŠ” í€µì§€ì—­ ì €ì¥ (ë§ˆìŠ¤í„° ê´€ë¦¬ì ì „ìš©). í€µì§€ì—­ë§Œ ì‚¬ìš© ì‹œ ê·¸ ì™¸ ì§€ì—­ ë°°ì†¡ë¶ˆê°€."""
    if not current_user.is_admin:
        return jsonify({'error': 'ê¶Œí•œ ì—†ìŒ'}), 403
    _ensure_delivery_zone_columns()
    if request.method == 'GET':
        z = DeliveryZone.query.order_by(DeliveryZone.updated_at.desc()).first()
        polygon = []
        quick_region_polygon = []
        quick_region_names = []
        use_quick_region_only = False
        quick_extra_fee = 10000
        quick_extra_message = ''
        if z:
            if z.polygon_json:
                try:
                    polygon = json.loads(z.polygon_json)
                except Exception:
                    pass
            if getattr(z, 'quick_region_polygon_json', None):
                try:
                    quick_region_polygon = json.loads(z.quick_region_polygon_json) or []
                except Exception:
                    pass
            if getattr(z, 'quick_region_names', None):
                try:
                    quick_region_names = json.loads(z.quick_region_names) or []
                except Exception:
                    pass
            use_quick_region_only = bool(getattr(z, 'use_quick_region_only', False))
            quick_extra_fee = int(getattr(z, 'quick_extra_fee', None) or 10000)
            quick_extra_message = (getattr(z, 'quick_extra_message', None) or '') or ''
        return jsonify({'polygon': polygon, 'quick_region_polygon': quick_region_polygon, 'quick_region_names': quick_region_names, 'use_quick_region_only': use_quick_region_only, 'quick_extra_fee': quick_extra_fee, 'quick_extra_message': quick_extra_message})
    # POST
    data = request.get_json() or {}
    z = DeliveryZone.query.order_by(DeliveryZone.updated_at.desc()).first()
    if not z:
        z = DeliveryZone(name='ì—°ìˆ˜êµ¬')
        db.session.add(z)
        db.session.flush()
    updated = False
    if 'polygon' in data:
        polygon = data['polygon']
        if polygon is not None:
            if not isinstance(polygon, list) or len(polygon) < 3:
                return jsonify({'error': 'ê¼­ì§“ì  3ê°œ ì´ìƒ í•„ìš”'}), 400
            try:
                json.dumps(polygon)
            except (TypeError, ValueError):
                return jsonify({'error': 'ìœ íš¨í•œ ì¢Œí‘œ ë°°ì—´ì´ ì•„ë‹˜'}), 400
            z.polygon_json = json.dumps(polygon)
            updated = True
    if 'quick_region_names' in data:
        val = data['quick_region_names']
        if isinstance(val, str):
            val = [n.strip() for n in val.replace('ï¼Œ', ',').split(',') if n.strip()]
        if isinstance(val, list):
            z.quick_region_names = json.dumps([str(n).strip() for n in val if str(n).strip()])
            updated = True
    if 'use_quick_region_only' in data:
        z.use_quick_region_only = data['use_quick_region_only'] in (True, 'true', '1', 1)
        updated = True
    if 'quick_region_polygon' in data:
        qrp = data['quick_region_polygon']
        if qrp is None or (isinstance(qrp, list) and len(qrp) == 0):
            z.quick_region_polygon_json = None
            updated = True
        elif isinstance(qrp, list) and len(qrp) >= 3:
            try:
                json.dumps(qrp)
                z.quick_region_polygon_json = json.dumps(qrp)
                updated = True
            except (TypeError, ValueError):
                return jsonify({'error': 'í€µì§€ì—­ í´ë¦¬ê³¤ ì¢Œí‘œê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'}), 400
        else:
            return jsonify({'error': 'í€µì§€ì—­ í´ë¦¬ê³¤ì€ ê¼­ì§“ì  3ê°œ ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤.'}), 400
    if 'quick_extra_fee' in data:
        try:
            v = data['quick_extra_fee']
            z.quick_extra_fee = int(v) if v not in (None, '') else 10000
            updated = True
        except (TypeError, ValueError):
            z.quick_extra_fee = 10000
            updated = True
    if 'quick_extra_message' in data:
        z.quick_extra_message = (data['quick_extra_message'] or '').strip() or None
        updated = True
    if updated:
        z.updated_at = datetime.utcnow()
    db.session.commit()
    return jsonify({'ok': True})


@login_required
def admin_member_grade_set():
    """íšŒì› ë“±ê¸‰ ì§ì ‘ ì„¤ì • (ë§ˆìŠ¤í„° ì „ìš©). user_id, grade(1~5), overridden(true|false)"""
    if not current_user.is_admin:
        return jsonify({'error': 'ê¶Œí•œ ì—†ìŒ'}), 403
    data = request.get_json() or request.form
    try:
        uid = int(data.get('user_id', 0))
        grade = int(data.get('grade', 1))
        overridden = data.get('overridden', 'true').lower() in ('1', 'true', 'yes')
    except (TypeError, ValueError):
        return jsonify({'error': 'user_id, grade í•„ìš”'}), 400
    if grade not in (1, 2, 3, 4, 5):
        return jsonify({'error': 'gradeëŠ” 1~5ë§Œ ê°€ëŠ¥'}), 400
    u = User.query.get(uid)
    if not u:
        return jsonify({'error': 'íšŒì› ì—†ìŒ'}), 404
    u.member_grade = grade
    u.member_grade_overridden = overridden
    db.session.commit()
    return jsonify({'ok': True})
@admin_bp.route('/admin/member_grade/config', methods=['POST'])


@login_required
def admin_member_grade_config():
    """ìë™ ë“±ê¸‰ ê¸°ì¤€ ì €ì¥ (ë§ˆìŠ¤í„° ì „ìš©). min_amount_grade2~5 (ì›)"""
    if not current_user.is_admin:
        return jsonify({'error': 'ê¶Œí•œ ì—†ìŒ'}), 403
    data = request.get_json() or request.form
    def set_val(k, v):
        try:
            val = str(int(v)) if v not in (None, '') else '0'
        except (TypeError, ValueError):
            val = '0'
        row = MemberGradeConfig.query.filter_by(key=k).first()
        if not row:
            row = MemberGradeConfig(key=k, value=val)
            db.session.add(row)
        else:
            row.value = val
    set_val('min_amount_grade2', data.get('min_amount_grade2'))
    set_val('min_amount_grade3', data.get('min_amount_grade3'))
    set_val('min_amount_grade4', data.get('min_amount_grade4'))
    set_val('min_amount_grade5', data.get('min_amount_grade5'))
    db.session.commit()
@admin_bp.route('/admin/member_grade/auto_apply', methods=['POST'])
    return jsonify({'ok': True})


@login_required
def admin_member_grade_auto_apply():
    """êµ¬ë§¤ì´ë ¥ìœ¼ë¡œ ë“±ê¸‰ ìë™ ë°˜ì˜ (ì§ì ‘ì„¤ì • ì•„ë‹Œ íšŒì›ë§Œ, ë§ˆìŠ¤í„° ì „ìš©)"""
    if not current_user.is_admin:
        return jsonify({'error': 'ê¶Œí•œ ì—†ìŒ'}), 403
    count = 0
    for u in User.query.filter_by(member_grade_overridden=False).all():
        if recompute_member_grade_for_user(u):
            count += 1
    db.session.commit()
@admin_bp.route('/admin/point/config', methods=['POST'])
    return jsonify({'ok': True, 'updated': count})


@login_required
def admin_point_config():
    """í¬ì¸íŠ¸ ì •ì±… ì €ì¥ (ë§ˆìŠ¤í„° ì „ìš©). accumulation_rate(1=0.1%), min_order_to_use, max_points_per_order"""
    if not current_user.is_admin:
        return jsonify({'error': 'ê¶Œí•œ ì—†ìŒ'}), 403
    data = request.get_json() or request.form
    def set_val(k, v):
        try:
            val = str(int(v)) if v not in (None, '') else '0'
        except (TypeError, ValueError):
            val = '0'
        row = PointConfig.query.filter_by(key=k).first()
        if not row:
            row = PointConfig(key=k, value=val)
            db.session.add(row)
        else:
            row.value = val
    set_val('accumulation_rate', data.get('accumulation_rate'))
    set_val('min_order_to_use', data.get('min_order_to_use'))
    set_val('max_points_per_order', data.get('max_points_per_order'))
    db.session.commit()
@admin_bp.route('/admin/point/adjust', methods=['POST'])
    return jsonify({'ok': True})


@login_required
def admin_point_adjust():
    """íšŒì› í¬ì¸íŠ¸ ì§€ê¸‰/ì°¨ê° (ë§ˆìŠ¤í„° ì „ìš©). user_id, amount(ì–‘ìˆ˜=ì§€ê¸‰/ìŒìˆ˜=ì°¨ê°), memo"""
    if not current_user.is_admin:
        return jsonify({'error': 'ê¶Œí•œ ì—†ìŒ'}), 403
    data = request.get_json() or request.form
    try:
        uid = int(data.get('user_id', 0))
        amount = int(data.get('amount', 0))
    except (TypeError, ValueError):
        return jsonify({'error': 'user_id, amount í•„ìš”'}), 400
    u = User.query.get(uid)
    if not u:
        return jsonify({'error': 'íšŒì› ì—†ìŒ'}), 404
    memo = (data.get('memo') or '')[:200]
    current_pts = getattr(u, 'points', 0) or 0
    after = current_pts + amount
    if after < 0:
        return jsonify({'error': 'í¬ì¸íŠ¸ê°€ ìŒìˆ˜ê°€ ë  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}), 400
    u.points = after
    db.session.add(PointLog(user_id=u.id, amount=amount, memo=memo or ('ê´€ë¦¬ì ì¡°ì •' if amount >= 0 else 'ê´€ë¦¬ì ì°¨ê°'), adjusted_by=current_user.id))
    db.session.commit()
@admin_bp.route('/admin/point/log')
    return jsonify({'ok': True, 'after': after})


@login_required
def admin_point_log():
    """íšŒì›ë³„ í¬ì¸íŠ¸ ë‚´ì—­ (ë§ˆìŠ¤í„° ì „ìš©). user_id, limit ê¸°ë³¸ 30"""
    if not current_user.is_admin:
        return jsonify({'error': 'ê¶Œí•œ ì—†ìŒ'}), 403
    uid = request.args.get('user_id', type=int)
    limit = min(100, max(1, request.args.get('limit', type=int) or 30))
    if not uid:
        return jsonify({'error': 'user_id í•„ìš”'}), 400
    logs = PointLog.query.filter_by(user_id=uid).order_by(PointLog.created_at.desc()).limit(limit).all()
    out = []
    for l in logs:
        modifier = None
        if getattr(l, 'adjusted_by', None):
            mod_user = User.query.get(l.adjusted_by)
            modifier = mod_user.email if mod_user else str(l.adjusted_by)
        out.append({
            'id': l.id, 'amount': l.amount, 'order_id': l.order_id, 'memo': l.memo or '',
            'created_at': l.created_at.strftime('%Y-%m-%d %H:%M') if l.created_at else '',
            'date': l.created_at.strftime('%Y-%m-%d') if l.created_at else '',
            'modifier': modifier  # ìˆ˜ì •ì ì´ë©”ì¼(ê´€ë¦¬ì), ì—†ìœ¼ë©´ ì‹œìŠ¤í…œ
        })
@admin_bp.route('/admin/api/member/<int:uid>/message', methods=['POST'])
    return jsonify({'logs': out})


@login_required
def admin_member_send_message(uid):
    """ê´€ë¦¬ì: íŠ¹ì • íšŒì›ì—ê²Œ ë©”ì‹œì§€ ë°œì†¡ (ì œëª©Â·ë‚´ìš©). í‘¸ì‹œ ì•Œë¦¼ í¬í•¨."""
    if not current_user.is_admin:
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    u = User.query.get(uid)
    if not u:
        return jsonify({"success": False, "message": "íšŒì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 404
    data = request.get_json() or request.form
    title = (data.get('title') or '').strip()
    body = (data.get('body') or '').strip()
    if not title:
        return jsonify({"success": False, "message": "ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."})
    mid = send_message(uid, title, body, 'custom', None)
    if mid:
        db.session.commit()
        return jsonify({"success": True, "message": "ë©”ì‹œì§€ë¥¼ ë°œì†¡í–ˆìŠµë‹ˆë‹¤."})
@admin_bp.route('/admin/api/member/<int:uid>/delete', methods=['POST'])
    return jsonify({"success": False, "message": "ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."}), 500


@login_required
def admin_member_delete(uid):
    """ê´€ë¦¬ì: íšŒì› ì‚­ì œ. ì£¼ë¬¸ ì´ë ¥ì´ ìˆìœ¼ë©´ ì‚­ì œ ë¶ˆê°€. ê´€ë¦¬ì ê³„ì •ì€ ì‚­ì œ ë¶ˆê°€."""
    if not current_user.is_admin:
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    u = User.query.get(uid)
    if not u:
        return jsonify({"success": False, "message": "íšŒì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 404
    if u.is_admin:
        return jsonify({"success": False, "message": "ê´€ë¦¬ì ê³„ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 400
    if uid == current_user.id:
        return jsonify({"success": False, "message": "ë³¸ì¸ ê³„ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 400
    order_count = Order.query.filter_by(user_id=uid).count()
    if order_count > 0:
        return jsonify({"success": False, "message": f"ì£¼ë¬¸ ì´ë ¥ì´ ìˆëŠ” íšŒì›({order_count}ê±´)ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 400
    try:
        PointLog.query.filter_by(user_id=uid).delete()
        PushSubscription.query.filter_by(user_id=uid).delete()
        UserMessage.query.filter_by(user_id=uid).delete()
        Cart.query.filter_by(user_id=uid).delete()
        db.session.delete(u)
        db.session.commit()
        return jsonify({"success": True, "message": "íšŒì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."})
    except Exception as e:
        db.session.rollback()
        return jsonify({"success": False, "message": str(e) or "ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."}), 500


@login_required
@admin_bp.route('/admin')
@admin_bp.route('/admin/')
def admin_dashboard():
    """ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ - [ë§¤ì¶œ+ë¬¼ë¥˜+ì¹´í…Œê³ ë¦¬+ë¦¬ë·°] ì „ì²´ ê¸°ëŠ¥ í†µí•© ë³µêµ¬ë³¸"""
    categories = Category.query.order_by(Category.order.asc(), Category.id.asc()).all()
    managers = [c.manager_email for c in categories if c.manager_email]
    
    if not (current_user.is_admin or current_user.email in managers):
        flash("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/')
    
    is_master = current_user.is_admin
    tab = request.args.get('tab', 'products')
    seller_tax = request.args.get('seller_tax', 'ì „ì²´')  # íŒë§¤ì ê´€ë¦¬ ì„œë¸Œíƒ­: ì „ì²´ / ê³¼ì„¸ / ë©´ì„¸
    my_categories = [c.name for c in categories if c.manager_email == current_user.email]
    # ì¹´í…Œê³ ë¦¬ ì„ íƒ: ê¶Œí•œ ìˆëŠ” ì¹´í…Œê³ ë¦¬ë§Œ (ë§ˆìŠ¤í„°=ì „ì²´, ë§¤ë‹ˆì €=ìê¸° ì¹´í…Œê³ ë¦¬ë§Œ)
    selectable_categories = [c for c in categories if is_master or c.name in my_categories]
    sellers_categories = categories
    if tab == 'sellers' and seller_tax in ('ê³¼ì„¸', 'ë©´ì„¸'):
        sellers_categories = [c for c in categories if (getattr(c, 'tax_type', None) or 'ê³¼ì„¸') == seller_tax]
    
    # 1. ë‚ ì§œ ë³€ìˆ˜ ì •ì˜
    now = datetime.now()
    start_date_str = request.args.get('start_date', now.strftime('%Y-%m-%d 00:00')).replace('T', ' ')
    end_date_str = request.args.get('end_date', now.strftime('%Y-%m-%d 23:59')).replace('T', ' ')
    
    # 2. ê³µí†µ ë³€ìˆ˜ ì´ˆê¸°í™”
    sel_cat = request.args.get('category', 'ì „ì²´')
    sel_order_cat = request.args.get('order_cat', 'ì „ì²´')
    products, filtered_orders, summary, daily_stats, reviews = [], [], {}, {}, []
    product_q, product_page, products_total, product_total_pages, per_page = '', 1, 0, 1, 30
    stats = {"sales": 0, "delivery": 0, "count": 0, "grand_total": 0}
    category_names = {}
    order_total_qty, order_total_subtotal = 0, 0
    sales_table_rows = []
    sales_total_quantity = 0
    product_summary_rows = []
    settlement_detail_rows = []
    settlement_detail_orders = []
    settlement_category_totals = {}

    if tab == 'products':
        product_q = (request.args.get('q') or request.args.get('product_q') or '').strip()
        product_page = max(1, int(request.args.get('page', 1)))
        per_page = 30
        q = Product.query
        if not is_master:
            q = q.filter(Product.category.in_(my_categories))
        if product_q:
            q = q.filter(or_(
                Product.name.contains(product_q),
                Product.description.contains(product_q),
                Product.category.contains(product_q)
            ))
        else:
            if sel_cat != 'ì „ì²´':
                q = q.filter_by(category=sel_cat)
        q = q.order_by(Product.id.desc())
        products_total = q.count()
        products = q.offset((product_page - 1) * per_page).limit(per_page).all()
        product_total_pages = max(1, (products_total + per_page - 1) // per_page)
     
    elif tab in ('orders', 'settlement'):
        try:
            # ë‚ ì§œ íŒŒì‹± ì‹œë„
            start_dt = datetime.strptime(start_date_str, '%Y-%m-%d %H:%M')
            end_dt = datetime.strptime(end_date_str, '%Y-%m-%d %H:%M')
        except Exception as e:
            # íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ (ì˜¤ëŠ˜ 00:00 ~ 23:59)
            print(f"Date parsing error: {e}")
            start_dt = now.replace(hour=0, minute=0, second=0)
            end_dt = now.replace(hour=23, minute=59, second=59)

        # ê²°ì œì·¨ì†Œ ì œì™¸ ì£¼ë¬¸ í•„í„°ë§
        all_orders = Order.query.filter(
            Order.created_at >= start_dt, 
            Order.created_at <= end_dt,
            Order.status != 'ê²°ì œì·¨ì†Œ'
        ).order_by(Order.created_at.desc()).all()
        
        for o in all_orders:
            order_date = o.created_at.strftime('%Y-%m-%d')
            if order_date not in daily_stats:
                daily_stats[order_date] = {"sales": 0, "count": 0}

            order_show_flag = False
            current_order_sales = 0  # ë§¤ë‹ˆì €ë³„ ì •ì‚° ëŒ€ìƒ ê¸ˆì•¡ ë³€ìˆ˜
            manager_items_list = []  # ì˜¤ë”ë³„ ì •ì‚°: ë‚´ ì¹´í…Œê³ ë¦¬ í’ˆëª© ëª©ë¡
            manager_qty_total = 0    # ì˜¤ë”ë³„ ì •ì‚°: ë‚´ ì¹´í…Œê³ ë¦¬ ìˆ˜ëŸ‰ í•©ê³„

            # OrderItemì´ ìˆìœ¼ë©´ DB ê¸°ì¤€ìœ¼ë¡œ ê¸ˆì•¡Â·ìˆ˜ëŸ‰ ì§‘ê³„ (ì·¨ì†Œ í’ˆëª© ì œì™¸)
            items = OrderItem.query.filter_by(order_id=o.id, cancelled=False).order_by(OrderItem.id.asc()).all()
            if items:
                for oi in items:
                    if is_master or oi.product_category in my_categories:
                        order_show_flag = True
                        if oi.product_category not in summary:
                            summary[oi.product_category] = {"product_list": {}, "subtotal": 0}
                        item_price = oi.price * oi.quantity
                        manager_qty_total += oi.quantity
                        current_order_sales += item_price
                        summary[oi.product_category]["subtotal"] += item_price
                        summary[oi.product_category]["product_list"][oi.product_name] = summary[oi.product_category]["product_list"].get(oi.product_name, 0) + oi.quantity
                        manager_items_list.append(f"{oi.product_name}({oi.quantity})")
            else:
                # OrderItem ì—†ì„ ë•Œë§Œ product_details í…ìŠ¤íŠ¸ íŒŒì‹±
                parts = (o.product_details or '').split(' | ')
                for part in parts:
                    match = re.search(r'\[(.*?)\] (.*)', part)
                    if match:
                        cat_n = match.group(1).strip()
                        items_str = match.group(2).strip()
                        if is_master or cat_n in my_categories:
                            order_show_flag = True
                            if cat_n not in summary:
                                summary[cat_n] = {"product_list": {}, "subtotal": 0}
                            for item in items_str.split(', '):
                                it_match = re.search(r'(.*?)\((\d+)\)', item)
                                if it_match:
                                    pn = it_match.group(1).strip()
                                    qt = int(it_match.group(2))
                                    manager_items_list.append(f"{pn}({qt})")
                                    manager_qty_total += qt
                                    p_obj = Product.query.filter_by(name=pn).first()
                                    if p_obj:
                                        item_price = p_obj.price * qt
                                        summary[cat_n]["subtotal"] += item_price
                                        summary[cat_n]["product_list"][pn] = summary[cat_n]["product_list"].get(pn, 0) + qt
                                        current_order_sales += item_price

            # ê¶Œí•œì´ ìˆëŠ” ì£¼ë¬¸ ë°ì´í„°ë§Œ í†µê³„ì— ë°˜ì˜ + ì˜¤ë”ë³„ ì •ì‚°ìš© ì†ì„±
            if order_show_flag:
                o._manager_items = manager_items_list
                o._manager_qty = manager_qty_total
                o._manager_subtotal = current_order_sales
                filtered_orders.append(o)
                stats["sales"] += current_order_sales
                stats["count"] += 1
                daily_stats[order_date]["sales"] += current_order_sales
                daily_stats[order_date]["count"] += 1
                if is_master: stats["delivery"] += (o.delivery_fee or 0)

        daily_stats = dict(sorted(daily_stats.items(), reverse=True))
        stats["grand_total"] = stats["sales"] + stats["delivery"]
        # ì˜¤ë”ë³„ ì •ì‚° í˜„í™© í•˜ë‹¨ ì´í•©ê³„ìš©
        order_total_qty = sum(getattr(o, '_manager_qty', 0) for o in filtered_orders)
        order_total_subtotal = sum(getattr(o, '_manager_subtotal', 0) for o in filtered_orders)
        # ë§¤ì¶œ ìƒì„¸ í…Œì´ë¸”ìš©: ìƒë‹¨ ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ ì„ íƒëœ ì¹´í…Œê³ ë¦¬ë§Œ í‘œì‹œ
        sales_table_rows = []
        for o in filtered_orders:
            order_date_str = o.created_at.strftime('%Y-%m-%d %H:%M') if o.created_at else ''
            status_str = o.status or 'ê²°ì œì™„ë£Œ'
            items = OrderItem.query.filter_by(order_id=o.id).order_by(OrderItem.id.asc()).all()
            if items:
                for oi in items:
                    if (is_master or oi.product_category in my_categories) and (sel_order_cat == 'ì „ì²´' or oi.product_category == sel_order_cat):
                        is_cancelled = getattr(oi, 'cancelled', False) or (getattr(oi, 'item_status', None) in ('ë¶€ë¶„ì·¨ì†Œ', 'í’ˆì ˆì·¨ì†Œ'))
                        sales_table_rows.append({
                            'order_date': order_date_str,
                            'product_name': oi.product_name,
                            'category': oi.product_category,
                            'quantity': 0 if is_cancelled else oi.quantity,
                            'status': 'ì·¨ì†Œ' if is_cancelled else (getattr(oi, 'item_status', None) or status_str)
                        })
            else:
                parts = (o.product_details or '').split(' | ')
                for part in parts:
                    match = re.search(r'\[(.*?)\] (.*)', part)
                    if match:
                        cat_n, items_str = match.groups()
                        if (is_master or cat_n in my_categories) and (sel_order_cat == 'ì „ì²´' or cat_n == sel_order_cat):
                            for item in items_str.split(', '):
                                it_match = re.search(r'(.*?)\((\d+)\)', item)
                                if it_match:
                                    pn, qt = it_match.groups()
                                    sales_table_rows.append({'order_date': order_date_str, 'product_name': pn.strip(), 'category': cat_n, 'quantity': int(qt), 'status': status_str})
        # ì¡°íšŒ ê²°ê³¼ ì´í•©ê³„ ìˆ˜ëŸ‰ + í’ˆëª©Â·íŒë§¤ìƒí’ˆëª…ë³„ íŒë§¤ìˆ˜ëŸ‰ ì´í•©ê³„ (ì§‘ê³„ í…Œì´ë¸”ìš©)
        sales_total_quantity = sum(r.get('quantity', 0) for r in sales_table_rows)
        product_summary_rows = []
        from collections import defaultdict
        agg = defaultdict(int)
        for r in sales_table_rows:
            key = (r.get('category') or '', r.get('product_name') or '')
            agg[key] += r.get('quantity', 0)
        for (cat, pname), total_qty in sorted(agg.items(), key=lambda x: (x[0][0], x[0][1])):
            product_summary_rows.append({'category': cat, 'product_name': pname, 'total_quantity': total_qty})

        # ì •ì‚° ì „ìš© í…Œì´ë¸”(Settlement) ê¸°ì¤€: në„˜ë²„(ì •ì‚°ë²ˆí˜¸), íŒë§¤ì¼ì‹œ, ì¹´í…Œê³ ë¦¬, ë©´ì„¸ì—¬ë¶€, í’ˆëª©, íŒë§¤ê¸ˆì•¡, ìˆ˜ìˆ˜ë£Œ, ë°°ì†¡ê´€ë¦¬ë¹„, ì •ì‚°í•©ê³„, ì…ê¸ˆìƒíƒœ(ì…ê¸ˆì¼)
        sel_settlement_status = request.args.get('settlement_status', 'ì „ì²´')
        if sel_settlement_status == 'ì •ì‚°ëŒ€ê¸°': sel_settlement_status = 'ì…ê¸ˆëŒ€ê¸°'
        if sel_settlement_status == 'ì •ì‚°ì™„ë£Œ': sel_settlement_status = 'ì…ê¸ˆì™„ë£Œ'
        # ê¸°ì¡´ OrderItemì— ëŒ€í•œ Settlement ë°±í•„ (ê²°ì œ ì‹œ ìƒì„± ëˆ„ë½ë¶„ ë³´ì¶©)
        for o in filtered_orders:
            items = OrderItem.query.filter_by(order_id=o.id, cancelled=False).order_by(OrderItem.id.asc()).all()
            if not items:
                continue
            for oi in items:
                if not (is_master or oi.product_category in my_categories):
                    continue
                if Settlement.query.filter_by(order_item_id=oi.id).first():
                    continue
                delivery_fee_per_settlement = 990  # ì •ì‚°ë²ˆí˜¸ë‹¹ ë°°ì†¡ê´€ë¦¬ë¹„ 990ì›
                sales_amount = oi.price * oi.quantity
                fee = round(sales_amount * 0.055)
                total = sales_amount - fee - delivery_fee_per_settlement
                settlement_no = "N" + str(oi.id).zfill(10)
                st = getattr(oi, 'settlement_status', None) or getattr(o, 'settlement_status', None) or 'ì…ê¸ˆëŒ€ê¸°'
                if st not in ('ì…ê¸ˆëŒ€ê¸°', 'ì…ê¸ˆì™„ë£Œ', 'ì·¨ì†Œ', 'ë³´ë¥˜'):
                    st = 'ì…ê¸ˆëŒ€ê¸°'
                # ë©´ì„¸ì—¬ë¶€: íŒë§¤ì ê´€ë¦¬(ì¹´í…Œê³ ë¦¬)ì˜ ê³¼ì„¸/ë©´ì„¸ ì„¤ì • ê¸°ì¤€
                cat = Category.query.filter_by(name=oi.product_category).first()
                tax_exempt_val = (getattr(cat, 'tax_type', None) or 'ê³¼ì„¸') == 'ë©´ì„¸'
                db.session.add(Settlement(
                    settlement_no=settlement_no, order_id=o.id, order_item_id=oi.id,
                    sale_dt=o.created_at, category=oi.product_category,
                    tax_exempt=tax_exempt_val,
                    product_name=oi.product_name, sales_amount=sales_amount, fee=fee,
                    delivery_fee=delivery_fee_per_settlement, settlement_total=total,
                    settlement_status=st, settled_at=getattr(oi, 'settled_at', None)
                ))
        try:
            db.session.commit()
        except Exception:
            db.session.rollback()
        # ì •ì‚° ì „ìš© í…Œì´ë¸”ì—ì„œ ì¡°íšŒ (íŒë§¤ì¼ì‹œ, ì¹´í…Œê³ ë¦¬, ë©´ì„¸ì—¬ë¶€, í’ˆëª©, íŒë§¤ê¸ˆì•¡, ìˆ˜ìˆ˜ë£Œ, ë°°ì†¡ê´€ë¦¬ë¹„, ì •ì‚°í•©ê³„, ì…ê¸ˆìƒíƒœ(ì…ê¸ˆì¼))
        q = Settlement.query.filter(Settlement.sale_dt >= start_dt, Settlement.sale_dt <= end_dt)
        if not is_master:
            q = q.filter(Settlement.category.in_(my_categories))
        if sel_order_cat != 'ì „ì²´':
            q = q.filter(Settlement.category == sel_order_cat)
        if sel_settlement_status and sel_settlement_status != 'ì „ì²´':
            q = q.filter(Settlement.settlement_status == sel_settlement_status)
        for s in q.order_by(Settlement.sale_dt.desc()).all():
            settlement_detail_rows.append({
                'settlement_no': s.settlement_no,
                'order_item_id': s.order_item_id,
                'order_pk': s.order_id,
                'sale_dt': s.sale_dt.strftime('%Y-%m-%d %H:%M') if s.sale_dt else '-',
                'category': s.category,
                'tax_exempt': 'ë©´ì„¸' if s.tax_exempt else 'ê³¼ì„¸',
                'product_name': s.product_name,
                'sales_amount': s.sales_amount,
                'fee': s.fee,
                'delivery_fee': s.delivery_fee,
                'settlement_total': s.settlement_total,
                'settlement_status': s.settlement_status,
                'settled_at': s.settled_at.strftime('%Y-%m-%d %H:%M') if s.settled_at else None,
            })
        # ì •ì‚° ìƒì„¸ ì¹´í…Œê³ ë¦¬ë³„ ì´í•©ê³„
        settlement_category_totals = {}
        for r in settlement_detail_rows:
            cat = r.get('category', '')
            row_total = r.get('settlement_total', 0)
            settlement_category_totals[cat] = settlement_category_totals.get(cat, 0) + row_total
        # ì˜¤ë” ëª©ë¡ (ì •ì‚° í…Œì´ë¸”ì€ në„˜ë²„ ê¸°ì¤€ì´ë¯€ë¡œ ë¹ˆ ëª©ë¡ ìœ ì§€)
        settlement_detail_orders = []
            
    elif tab == 'reviews':
        reviews = Review.query.order_by(Review.created_at.desc()).all()
        category_names = {c.id: c.name for c in Category.query.all()}  # ë¦¬ë·° í…Œì´ë¸”ì—ì„œ íŒë§¤ìëª… í‘œì‹œìš©

    delivery_zone_polygon = []
    delivery_zone_quick_polygon = []
    delivery_zone_quick_regions = []
    delivery_zone_use_quick_only = False
    delivery_zone_quick_extra_fee = 10000
    delivery_zone_quick_extra_message = ''
    kakao_map_app_key = KAKAO_MAP_APP_KEY
    if tab == 'delivery_zone' and is_master:
        _ensure_delivery_zone_columns()
        z = DeliveryZone.query.order_by(DeliveryZone.updated_at.desc()).first()
        if z:
            if z.polygon_json:
                try:
                    delivery_zone_polygon = json.loads(z.polygon_json)
                except Exception:
                    pass
            if getattr(z, 'quick_region_polygon_json', None):
                try:
                    delivery_zone_quick_polygon = json.loads(z.quick_region_polygon_json) or []
                except Exception:
                    pass
            if getattr(z, 'quick_region_names', None):
                try:
                    delivery_zone_quick_regions = json.loads(z.quick_region_names) or []
                except Exception:
                    pass
            delivery_zone_use_quick_only = bool(getattr(z, 'use_quick_region_only', False))
            delivery_zone_quick_extra_fee = int(getattr(z, 'quick_extra_fee', None) or 10000)
            delivery_zone_quick_extra_message = (getattr(z, 'quick_extra_message', None) or '').strip() or 'í•´ë‹¹ ì£¼ì†ŒëŠ” ë°°ì†¡ì§€ì—­ì´ ì•„ë‹™ë‹ˆë‹¤. ë°°ì†¡ë£Œ ì¶”ê°€ ì‹œ í€µìœ¼ë¡œ ë°°ì†¡ë©ë‹ˆë‹¤. ì¶”ê°€í•˜ì‹œê³  ì£¼ë¬¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'

    member_grade_users = []
    member_grade_min2 = member_grade_min3 = member_grade_min4 = member_grade_min5 = 0
    if tab == 'member_grade' and is_master:
        min2, min3, min4, min5 = _get_member_grade_config()
        member_grade_min2, member_grade_min3 = min2, min3
        member_grade_min4, member_grade_min5 = min4, min5
        for u in User.query.order_by(User.id.asc()).all():
            if u.is_admin:
                continue
            total_paid = _get_user_total_paid(u.id)
            order_count = Order.query.filter(Order.user_id == u.id, Order.status.notin_(['ì·¨ì†Œ', 'í™˜ë¶ˆ'])).count()
            member_grade_users.append({
                'id': u.id, 'email': u.email or '', 'name': u.name or '',
                'member_grade': getattr(u, 'member_grade', 1) or 1,
                'member_grade_overridden': getattr(u, 'member_grade_overridden', False),
                'total_paid': total_paid, 'order_count': order_count
            })

    point_accumulation_rate = point_min_order = point_max_use = 0
    point_users = []
    if tab == 'point_manage' and is_master:
        rate, min_ord, max_pts = _get_point_config()
        point_accumulation_rate, point_min_order, point_max_use = rate, min_ord, max_pts
        for u in User.query.order_by(User.id.asc()).all():
            point_users.append({
                'id': u.id, 'email': u.email or '', 'name': u.name or '',
                'points': getattr(u, 'points', 0) or 0
            })

    marketing_cost_list = []
    marketing_cost_total = 0
    if tab == 'marketing_cost' and is_master:
        rows = MarketingCost.query.order_by(MarketingCost.created_at.desc()).limit(500).all()
        for mc in rows:
            u = User.query.get(mc.user_id) if mc.user_id else None
            marketing_cost_list.append({
                'id': mc.id, 'order_id': mc.order_id, 'user_id': mc.user_id,
                'user_email': u.email if u else '', 'user_name': u.name if u else '',
                'amount': mc.amount, 'memo': mc.memo or '', 'created_at': mc.created_at
            })
        marketing_cost_total = db.session.query(db.func.coalesce(db.func.sum(MarketingCost.amount), 0)).scalar() or 0

    admin_members = []
    if tab == 'members' and is_master:
        admin_members = User.query.order_by(User.id.asc()).all()

    message_templates = []
    messages_history = []
    if tab == 'messages' and is_master:
        template_types = ['welcome', 'order_created', 'order_cancelled', 'part_cancelled', 'out_of_stock', 'delivery_requested', 'delivery_in_progress', 'delivery_complete', 'delivery_delayed']
        for mt in template_types:
            t = MessageTemplate.query.filter_by(msg_type=mt).first()
            def_title, def_body = _DEFAULT_MESSAGES.get(mt, ('', ''))
            message_templates.append({'msg_type': mt, 'title': t.title if t else def_title, 'body': t.body if t else def_body})
        history_rows = db.session.query(UserMessage, User).join(User, UserMessage.user_id == User.id).order_by(UserMessage.created_at.desc()).limit(150).all()
        messages_history = [{'msg': m, 'user_email': u.email or '', 'user_name': u.name or ''} for m, u in history_rows]

    popup_list = []
    if tab == 'popup' and is_master:
        popup_list = SitePopup.query.order_by(SitePopup.sort_order.asc(), SitePopup.start_at.desc().nullslast()).all()

    admin_restaurant_requests = []
    admin_partnership_inquiries = []
    restaurant_recommend_counts = {}  # tab==restaurant_requestì¼ ë•Œ ì±„ì›€
    if tab == 'restaurant_request' and is_master:
        admin_restaurant_requests = RestaurantRequest.query.order_by(RestaurantRequest.id.desc()).all()
        restaurant_recommend_counts = {}
        for p in admin_restaurant_requests:
            u, d = _restaurant_vote_counts(p.id)
            restaurant_recommend_counts[p.id] = (u, d)
    admin_delivery_requests = []
    delivery_request_vote_counts = {}
    if tab == 'delivery_request' and is_master:
        admin_delivery_requests = DeliveryRequest.query.order_by(DeliveryRequest.id.desc()).all()
        for p in admin_delivery_requests:
            u, d = _delivery_request_vote_counts(p.id)
            delivery_request_vote_counts[p.id] = (u, d)
    if tab == 'partnership' and is_master:
        admin_partnership_inquiries = PartnershipInquiry.query.order_by(PartnershipInquiry.id.desc()).all()

    utm_aggregates = []
    if tab == 'utm' and is_master:
        # ì£¼ë¬¸ ê¸°ì¤€: utm_sourceë³„ ì£¼ë¬¸ ìˆ˜, ë§¤ì¶œ, êµ¬ë§¤ì ìˆ˜(ê²°ì œ ì™„ë£Œ ì£¼ë¬¸ì˜ distinct user_id)
        from sqlalchemy import distinct
        order_stats = db.session.query(
            Order.utm_source,
            func.count(Order.id).label('order_count'),
            func.coalesce(func.sum(Order.total_price), 0).label('revenue'),
            func.count(distinct(Order.user_id)).label('buyer_count')
        ).filter(Order.status != 'ê²°ì œì·¨ì†Œ').group_by(Order.utm_source).all()
        # íšŒì›ê°€ì… ìˆ˜: User.utm_sourceë³„
        signup_counts = db.session.query(
            User.utm_source,
            func.count(User.id).label('signup_count')
        ).group_by(User.utm_source).all()
        signup_map = {(r.utm_source or '').strip() or 'ì§ì ‘/ê¸°íƒ€': r.signup_count for r in signup_counts}
        # ì†ŒìŠ¤ í‚¤ í†µì¼ (None/ë¹ˆê°’ â†’ ì§ì ‘/ê¸°íƒ€)
        def _src(s):
            return (s or '').strip() or 'ì§ì ‘/ê¸°íƒ€'
        utm_aggregates = [
            {
                'source': _src(r.utm_source),
                'order_count': r.order_count,
                'revenue': int(r.revenue or 0),
                'buyer_count': r.buyer_count or 0,
                'signup_count': signup_map.get(_src(r.utm_source), 0)
            }
            for r in order_stats
        ]
        # ìœ ì €ëŠ” ê°€ì…ë§Œ í•˜ê³  ì£¼ë¬¸ ì•ˆ í•œ ì†ŒìŠ¤ë„ í‘œì‹œ
        for usrc, cnt in signup_map.items():
            if not any(a['source'] == usrc for a in utm_aggregates):
                utm_aggregates.append({'source': usrc, 'order_count': 0, 'revenue': 0, 'buyer_count': 0, 'signup_count': cnt})
        utm_aggregates.sort(key=lambda x: (-x['revenue'], -x['order_count']))

    seller_request_categories = []
    seller_confirmations_recent = []
    email_order_date = None
    email_order_lines_by_category = {}
    if (tab == 'seller_request' or tab == 'email_order') and is_master:
        seller_request_categories = Category.query.filter(Category.manager_email.isnot(None), Category.manager_email != '').order_by(Category.order.asc(), Category.id.asc()).all()
        seller_confirmations_recent = SellerOrderConfirmation.query.order_by(SellerOrderConfirmation.created_at.desc()).limit(100).all()
        order_date_str = request.args.get('order_date', '').strip() or datetime.now().strftime('%Y-%m-%d')
        try:
            email_order_date = datetime.strptime(order_date_str, '%Y-%m-%d').date()
        except Exception:
            email_order_date = datetime.now().date()
        for c in seller_request_categories:
            email_order_lines_by_category[c.id] = _get_email_order_lines(c.name, email_order_date)

    # í†µê³„(í˜ì´ì§€ë·°) íƒ­: ì¡°íšŒìˆ˜Â·ì£¼ë¬¸Â·ìƒí’ˆÂ·íšŒì› ë“±
    stats_page_views_today = stats_page_views_week = stats_page_views_total = {'main': 0, 'category': 0, 'product': 0, 'cart': 0}
    stats_orders_today = stats_orders_week = stats_orders_total = 0
    stats_revenue_today = stats_revenue_week = stats_revenue_total = 0
    stats_products_total = stats_categories_total = stats_low_stock_count = 0
    stats_top_products_by_sold = []
    stats_top_products_by_views = []
    stats_members_total = stats_members_today = stats_members_week = 0
    stats_reviews_total = 0
    stats_cart_items_total = 0
    stats_product_views_total = 0
    stats_daily_table = []
    if tab == 'stats':
        now = datetime.now()
        today_start = now.replace(hour=0, minute=0, second=0, microsecond=0)
        week_start = today_start - timedelta(days=7)
        # DailyStat: ì˜¤ëŠ˜ / ìµœê·¼ 7ì¼ / ì „ì²´
        all_daily = DailyStat.query.order_by(DailyStat.stat_date.desc()).limit(365).all()
        for row in all_daily:
            d = row.stat_date
            main = (row.main_views or 0)
            cat = (row.category_views or 0)
            prod = (row.product_views or 0)
            cart = (row.cart_views or 0)
            if d == today_start.date():
                stats_page_views_today['main'] += main
                stats_page_views_today['category'] += cat
                stats_page_views_today['product'] += prod
                stats_page_views_today['cart'] += cart
            if d >= week_start.date():
                stats_page_views_week['main'] += main
                stats_page_views_week['category'] += cat
                stats_page_views_week['product'] += prod
                stats_page_views_week['cart'] += cart
            stats_page_views_total['main'] += main
            stats_page_views_total['category'] += cat
            stats_page_views_total['product'] += prod
            stats_page_views_total['cart'] += cart
            stats_daily_table.append({'date': d, 'main': main, 'category': cat, 'product': prod, 'cart': cart})
        # ì£¼ë¬¸ (ê²°ì œì·¨ì†Œ ì œì™¸)
        q_order = Order.query.filter(Order.status != 'ê²°ì œì·¨ì†Œ')
        stats_orders_today = q_order.filter(Order.created_at >= today_start).count()
        stats_orders_week = q_order.filter(Order.created_at >= week_start).count()
        stats_orders_total = q_order.count()
        rev_today = db.session.query(db.func.coalesce(db.func.sum(Order.total_price), 0)).filter(Order.status != 'ê²°ì œì·¨ì†Œ', Order.created_at >= today_start).scalar()
        rev_week = db.session.query(db.func.coalesce(db.func.sum(Order.total_price), 0)).filter(Order.status != 'ê²°ì œì·¨ì†Œ', Order.created_at >= week_start).scalar()
        rev_all = db.session.query(db.func.coalesce(db.func.sum(Order.total_price), 0)).filter(Order.status != 'ê²°ì œì·¨ì†Œ').scalar()
        stats_revenue_today = int(rev_today or 0)
        stats_revenue_week = int(rev_week or 0)
        stats_revenue_total = int(rev_all or 0)
        # ìƒí’ˆ
        stats_products_total = Product.query.count()
        stats_categories_total = Category.query.count()
        stats_low_stock_count = Product.query.filter(Product.is_active == True, Product.stock < 5).count()
        # ì¸ê¸° ìƒí’ˆ: OrderItem ê¸°ì¤€ íŒë§¤ ìˆ˜ëŸ‰ ìƒìœ„
        from sqlalchemy import func
        sold_q = db.session.query(OrderItem.product_id, OrderItem.product_name, func.sum(OrderItem.quantity).label('qty')).filter(OrderItem.cancelled == False).group_by(OrderItem.product_id, OrderItem.product_name).order_by(func.sum(OrderItem.quantity).desc()).limit(15).all()
        stats_top_products_by_sold = [{'product_id': r.product_id, 'product_name': r.product_name, 'qty': r.qty} for r in sold_q]
        # ì¡°íšŒìˆ˜ ë§ì€ ìƒí’ˆ
        stats_top_products_by_views = Product.query.order_by(Product.view_count.desc().nullslast()).limit(10).all()
        stats_product_views_total = db.session.query(db.func.coalesce(db.func.sum(Product.view_count), 0)).scalar() or 0
        # íšŒì› (ê´€ë¦¬ì ì œì™¸). Userì— created_at ì—†ìœ¼ë©´ ì‹ ê·œ ì§‘ê³„ëŠ” 0
        stats_members_total = User.query.filter(User.is_admin == False).count()
        stats_members_today = 0
        stats_members_week = 0
        if hasattr(User, 'created_at'):
            try:
                stats_members_today = User.query.filter(User.is_admin == False, User.created_at >= today_start).count()
                stats_members_week = User.query.filter(User.is_admin == False, User.created_at >= week_start).count()
            except Exception:
                pass
        stats_reviews_total = Review.query.count()
        stats_cart_items_total = db.session.query(db.func.coalesce(db.func.sum(Cart.quantity), 0)).scalar() or 0

    # 3. HTML í…œí”Œë¦¿ ì½”ë“œ
    # 3. HTML í…œí”Œë¦¿ ì½”ë“œ (ì¹´í…Œê³ ë¦¬ ì„¤ì • íƒ­ ì™„ë²½ ë³µêµ¬ë³¸)
    admin_html = """
    <div class="max-w-7xl mx-auto py-12 px-4 md:px-6 font-black text-xs md:text-sm text-left">
        <div class="flex justify-between items-center mb-10">
            <h2 class="text-2xl md:text-3xl font-black text-orange-700 italic">Admin Panel</h2>
            <div class="flex gap-2">
                 <a href="/" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] hover:bg-gray-200 transition">í™ˆìœ¼ë¡œ</a>
                 <a href="/logout" class="px-4 py-2 bg-red-50 text-red-500 rounded-xl text-[10px] hover:bg-red-100 transition">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </div>
        
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 p-4 mb-12 bg-white rounded-2xl border border-gray-100 shadow-sm">
            {% if my_categories %}<a href="/seller/orders" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition bg-teal-50 border border-teal-200 text-teal-700 hover:bg-teal-100 hover:border-teal-300">ë‚´ ë°œì£¼ ëª©ë¡</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=email_order" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'seller_request' or tab == 'email_order' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">emailë°œì£¼</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=marketing_cost" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'marketing_cost' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë§ˆì¼€íŒ…ë¹„ ì‚¬ìš©ë‚´ì—­</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=messages" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'messages' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë©”ì‹œì§€ ë°œì†¡</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=delivery_zone" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'delivery_zone' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë°°ì†¡êµ¬ì—­ê´€ë¦¬</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=delivery_request" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'delivery_request' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë°°ì†¡ìš”ì²­</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=backup" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'backup' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë°±ì—…</a>{% endif %}
            <a href="/admin?tab=products" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'products' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ìƒí’ˆ ê´€ë¦¬</a>
            {% if is_master %}<a href="/admin?tab=popup" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'popup' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì•Œë¦¼íŒì—…</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=partnership" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'partnership' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì œíœ´ë¬¸ì˜</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=restaurant_request" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'restaurant_request' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì „êµ­ë§›ì§‘ìš”ì²­</a>{% endif %}
            <a href="/admin?tab=settlement" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'settlement' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì •ì‚°ê´€ë¦¬</a>
            <a href="/admin?tab=orders" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'orders' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì£¼ë¬¸ ë° ë§¤ì¶œ ì§‘ê³„</a>
            {% if is_master %}<a href="/admin?tab=utm" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'utm' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ìœ ì…/ê´‘ê³ </a>{% endif %}
            {% if is_master %}<a href="/admin?tab=categories" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'categories' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì¹´í…Œê³ ë¦¬ ì„¤ì •</a>{% endif %}
            <a href="/admin?tab=stats" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'stats' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">í†µê³„</a>
            <a href="/admin?tab=reviews" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'reviews' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë¦¬ë·° ê´€ë¦¬</a>
            {% if is_master %}<a href="/admin?tab=sellers" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'sellers' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">íŒë§¤ì ê´€ë¦¬</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=point_manage" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'point_manage' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">í¬ì¸íŠ¸ ê´€ë¦¬</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=member_grade" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'member_grade' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">íšŒì› ë“±ê¸‰</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=members" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'members' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">íšŒì›ê´€ë¦¬</a>{% endif %}
        </div>

        {% if tab == 'products' %}
            <div class="mb-8 p-6 rounded-[2rem] border-2 border-amber-200 bg-amber-50/80 text-left">
                <p class="font-black text-amber-800 text-sm mb-3 flex items-center gap-2"><span class="text-lg">ğŸ‘‹</span> ì²˜ìŒ ì‚¬ìš©í•˜ì‹œëŠ” ê´€ë¦¬ììš© ì•ˆë‚´</p>
                <ul class="text-[11px] text-gray-700 space-y-1.5 mb-4">
                    <li><b>ì—‘ì…€ ëŒ€ëŸ‰ ë“±ë¡</b>: ì•„ë˜ ã€Œì—‘ì…€ ì—…ë¡œë“œã€ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì–‘ì‹ ë‹¤ìš´ë¡œë“œì™€ ì—…ë¡œë“œ ì°½ì´ ë‚˜ì˜µë‹ˆë‹¤.</li>
                    <li><b>ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</b>: <a href="/admin/product/bulk_upload_template" class="text-blue-600 font-black underline hover:no-underline">ğŸ“¥ ìƒí’ˆ ì—‘ì…€ ì—…ë¡œë“œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</a></li>
                    <li><b>í•„ìˆ˜ ì»¬ëŸ¼</b>: ì¹´í…Œê³ ë¦¬, ìƒí’ˆëª…, ê·œê²©, ê°€ê²©, ì´ë¯¸ì§€íŒŒì¼ëª… (ì²« ì¤„ í—¤ë” ì´ë¦„ì„ ì •í™•íˆ ë§ì¶°ì£¼ì„¸ìš”)</li>
                    <li><b>ì´ë¯¸ì§€ í´ë” ìœ„ì¹˜</b>: ì„œë²„/í”„ë¡œì íŠ¸ì˜ <code class="bg-white px-1.5 py-0.5 rounded border border-amber-200 font-mono text-[10px]">static/uploads/</code> í´ë”ì— ì´ë¯¸ì§€ íŒŒì¼ì„ ë„£ê³ , ì—‘ì…€ì—ëŠ” <b>íŒŒì¼ëª…ë§Œ</b> ì…ë ¥ (ì˜ˆ: apple.jpg)</li>
                    <li>ì¹´í…Œê³ ë¦¬ëŠ” ë¨¼ì € ã€Œì¹´í…Œê³ ë¦¬ ì„¤ì •ã€ íƒ­ì—ì„œ ë“±ë¡í•œ ì´ë¦„ê³¼ ë™ì¼í•´ì•¼ í•©ë‹ˆë‹¤. ê°€ê²©ì€ ìˆ«ìë§Œ ì…ë ¥í•˜ì„¸ìš”.</li>
                </ul>
                <p class="text-[10px] text-amber-700/90">ê°œë³„ ìƒí’ˆì€ ã€Œ+ ìƒí’ˆ ë“±ë¡ã€ìœ¼ë¡œ í•˜ë‚˜ì”© ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            <div id="excel_upload_form" class="hidden mb-8 bg-blue-50 p-8 rounded-[2rem] border border-blue-100">
                <p class="font-black text-blue-700 mb-4">ğŸ“¦ ì—‘ì…€ ìƒí’ˆ ëŒ€ëŸ‰ ë“±ë¡</p>
                <div class="flex flex-wrap items-center gap-3 mb-4">
                    <a href="/admin/product/bulk_upload_template" class="bg-white text-blue-600 border border-blue-200 px-5 py-2.5 rounded-xl font-black text-[10px] shadow-sm hover:bg-blue-50 transition">ğŸ“¥ ì—…ë¡œë“œ ì–‘ì‹ ë‹¤ìš´</a>
                </div>
                <form action="/admin/product/bulk_upload" method="POST" enctype="multipart/form-data" class="flex gap-4">
                    <input type="file" name="excel_file" class="bg-white p-3 rounded-xl flex-1 text-xs" accept=".xlsx,.xls" required>
                    <button type="submit" class="bg-blue-600 text-white px-8 rounded-xl font-black">ì—…ë¡œë“œ ì‹œì‘</button>
                </form>
                <div class="mt-5 p-5 bg-white/70 rounded-xl border border-blue-100 text-left text-[11px] text-gray-700 space-y-2">
                    <p class="font-black text-gray-800 mb-2">ğŸ“‹ ì—…ë¡œë“œ ì–‘ì‹ ì‚¬ìš©ë²• (ìƒì„¸)</p>
                    <p>Â· <b>í•„ìˆ˜ ì»¬ëŸ¼</b>: ì¹´í…Œê³ ë¦¬, ìƒí’ˆëª…, ê·œê²©, ê°€ê²©, ì´ë¯¸ì§€íŒŒì¼ëª… (í—¤ë” ì´ë¦„ ì •í™•íˆ ì¼ì¹˜)</p>
                    <p>Â· <b>ì´ë¯¸ì§€ íŒŒì¼ í´ë” ìœ„ì¹˜</b>: í”„ë¡œì íŠ¸ ë‚´ <code class="bg-gray-100 px-1 rounded">static/uploads/</code> í´ë”ì— ìƒí’ˆ ì´ë¯¸ì§€ íŒŒì¼ì„ ë„£ê³ , ì—‘ì…€ì˜ ã€Œì´ë¯¸ì§€íŒŒì¼ëª…ã€ë€ì—ëŠ” <b>íŒŒì¼ëª…ë§Œ</b> ì…ë ¥ (ì˜ˆ: apple.jpg). í•´ë‹¹ ê²½ë¡œì— ì—†ëŠ” íŒŒì¼ëª…ì€ ì´ë¯¸ì§€ ì—†ì´ ë“±ë¡ë©ë‹ˆë‹¤.</p>
                    <p>Â· ì¹´í…Œê³ ë¦¬ëŠ” ë¯¸ë¦¬ ã€Œì¹´í…Œê³ ë¦¬ ì„¤ì •ã€ì—ì„œ ë“±ë¡ëœ ì´ë¦„ê³¼ ë™ì¼í•´ì•¼ í•©ë‹ˆë‹¤. ê°€ê²©ì€ ìˆ«ìë§Œ ì…ë ¥í•˜ì„¸ìš”.</p>
                </div>
            </div>
            <div class="flex flex-wrap justify-between items-center gap-4 mb-8">
                <form action="/admin" method="GET" class="flex flex-wrap gap-3 items-center">
                    <input type="hidden" name="tab" value="products">
                    <input type="text" name="q" value="{{ product_q or '' }}" placeholder="ìƒí’ˆëª…Â·ì„¤ëª…Â·ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰" class="border border-gray-200 rounded-2xl px-4 py-2.5 text-[11px] font-black w-52 focus:ring-2 focus:ring-teal-500">
                    <select name="category" onchange="this.form.submit()" class="border-none bg-white shadow-sm p-3 rounded-2xl text-[11px] font-black">
                        <option value="ì „ì²´">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                        {% for c in selectable_categories %}<option value="{{c.name}}" {% if sel_cat == c.name %}selected{% endif %}>{{c.name}}</option>{% endfor %}
                    </select>
                    <button type="submit" class="bg-teal-600 text-white px-5 py-2.5 rounded-2xl font-black text-[10px]">ê²€ìƒ‰</button>
                    {% if product_q %}<a href="/admin?tab=products" class="text-gray-500 text-[10px]">ê²€ìƒ‰ì´ˆê¸°í™”</a>{% endif %}
                </form>
                <div class="flex gap-3">
                    <button onclick="document.getElementById('excel_upload_form').classList.toggle('hidden')" class="bg-blue-600 text-white px-5 py-3 rounded-2xl font-black text-[10px] shadow-lg">ì—‘ì…€ ì—…ë¡œë“œ</button>
                    <a href="/admin/add" class="bg-teal-600 text-white px-5 py-3 rounded-2xl font-black text-[10px] shadow-lg">+ ìƒí’ˆ ë“±ë¡</a>
                    {% if is_master %}<a href="/admin/seed_test_data" class="bg-amber-500 text-white px-5 py-3 rounded-2xl font-black text-[10px] shadow-lg hover:bg-amber-600" onclick="return confirm('í…ŒìŠ¤íŠ¸ ì¹´í…Œê³ ë¦¬ 3ê°œ(í…ŒìŠ¤íŠ¸-ì±„ì†Œ/ê³¼ì¼/ìˆ˜ì‚°)ì™€ ê° 10ê°œì”© ê°€ìƒ ìƒí’ˆì„ ìƒì„±í•©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?');">ğŸ§ª í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±</a><a href="/admin/delete_test_data" class="bg-red-500 text-white px-5 py-3 rounded-2xl font-black text-[10px] shadow-lg hover:bg-red-600" onclick="return confirm('í…ŒìŠ¤íŠ¸-ì±„ì†Œ/ê³¼ì¼/ìˆ˜ì‚° ì¹´í…Œê³ ë¦¬ì™€ í•´ë‹¹ ìƒí’ˆì„ ëª¨ë‘ ì‚­ì œí•©ë‹ˆë‹¤. ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?');">ğŸ—‘ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ</a><a href="/admin/seed_virtual_reviews" class="bg-violet-500 text-white px-5 py-3 rounded-2xl font-black text-[10px] shadow-lg hover:bg-violet-600" onclick="return confirm('ì „ì²´ ìƒí’ˆë³„ë¡œ ê°€ìƒ êµ¬ë§¤ í›„ê¸° 10ê°œì”© ìƒì„±í•©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?');">ğŸ“ ê°€ìƒ í›„ê¸° 10ê°œì”©</a><a href="/admin/seed_virtual_orders" class="bg-emerald-500 text-white px-5 py-3 rounded-2xl font-black text-[10px] shadow-lg hover:bg-emerald-600" onclick="return confirm('ìµœê·¼ 10ì¼ ì´ë‚´ ê°€ìƒ ì£¼ë¬¸ 20ê±´(í’ˆëª© 2~3ê°œì”©)ì„ ìƒì„±í•©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?');">ğŸ›’ ê°€ìƒ ì£¼ë¬¸ 20ê±´</a>{% endif %}
                </div>
            </div>
            <div class="bg-white rounded-[2rem] shadow-sm border border-gray-50 overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 border-b border-gray-100 text-gray-400 text-[10px]">
                        <tr><th class="p-6 w-20">ì‚¬ì§„</th><th class="p-6">ìƒí’ˆì •ë³´</th><th class="p-6 text-center">ì¬ê³ </th><th class="p-6 text-center">ê´€ë¦¬</th></tr>
                    </thead>
                    <tbody>
                        {% for p in products %}
                        <tr class="border-b border-gray-50 hover:bg-gray-50/50 transition">
                            <td class="p-4">
                                {% if p.image_url %}
                                <a href="{{ p.image_url }}" target="_blank" class="block w-16 h-16 rounded-xl overflow-hidden border border-gray-100 bg-gray-50 shrink-0"><img src="{{ p.image_url }}" alt="" class="w-full h-full object-cover"></a>
                                {% else %}
                                <span class="w-16 h-16 rounded-xl bg-gray-100 flex items-center justify-center text-gray-400 text-[9px] font-bold">ì—†ìŒ</span>
                                {% endif %}
                            </td>
                            <td class="p-6"><b class="text-gray-800 text-sm">{{ p.name }}</b><br><span class="text-teal-600 text-[10px]">{{ p.description or '' }}</span></td>
                            <td class="p-6 text-center font-black">{{ p.stock }}ê°œ</td>
                            <td class="p-6 text-center space-x-2"><a href="/admin/edit/{{p.id}}" class="text-blue-500">ìˆ˜ì •</a><a href="/admin/delete/{{p.id}}" class="text-red-300" onclick="return confirm('ì‚­ì œ?')">ì‚­ì œ</a></td>
                        </tr>
                        {% endfor %}
                        {% if not products %}
                        <tr><td colspan="4" class="p-10 text-center text-gray-400 font-bold">ì¡°íšŒëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            {% if products_total > per_page or product_page > 1 %}
            <div class="flex flex-wrap items-center justify-between gap-4 mt-6">
                <p class="text-[11px] text-gray-500 font-bold">ì´ {{ products_total }}ê±´ Â· {{ product_page }} / {{ product_total_pages }} í˜ì´ì§€ (30ê°œì”©)</p>
                <div class="flex gap-2">
                    {% if product_page > 1 %}
                    <a href="/admin?tab=products&page={{ product_page - 1 }}{% if product_q %}&q={{ product_q | e }}{% endif %}{% if sel_cat != 'ì „ì²´' %}&category={{ sel_cat }}{% endif %}" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-xl font-black text-[10px] hover:bg-gray-300">ì´ì „</a>
                    {% endif %}
                    {% if product_page < product_total_pages %}
                    <a href="/admin?tab=products&page={{ product_page + 1 }}{% if product_q %}&q={{ product_q | e }}{% endif %}{% if sel_cat != 'ì „ì²´' %}&category={{ sel_cat }}{% endif %}" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-xl font-black text-[10px] hover:bg-gray-300">ë‹¤ìŒ</a>
                    {% endif %}
                </div>
            </div>
            {% endif %}

        {% elif tab == 'stats' %}
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-6">ğŸ“Š í˜ì´ì§€ë·° Â· ì£¼ë¬¸ Â· ìƒí’ˆ í†µê³„</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] text-gray-500 font-black uppercase mb-1">ì˜¤ëŠ˜ ì¡°íšŒìˆ˜</p>
                        <p class="text-xl font-black text-teal-600">{{ stats_page_views_today['main'] + stats_page_views_today['category'] + stats_page_views_today['product'] + stats_page_views_today['cart'] }}</p>
                        <p class="text-[9px] text-gray-400 mt-1">ë©”ì¸ {{ stats_page_views_today['main'] }} Â· ì¹´í…Œê³ ë¦¬ {{ stats_page_views_today['category'] }} Â· ìƒí’ˆ {{ stats_page_views_today['product'] }} Â· ì¥ë°”êµ¬ë‹ˆ {{ stats_page_views_today['cart'] }}</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] text-gray-500 font-black uppercase mb-1">ì´ë²ˆ ì£¼ ì¡°íšŒìˆ˜</p>
                        <p class="text-xl font-black text-teal-600">{{ stats_page_views_week['main'] + stats_page_views_week['category'] + stats_page_views_week['product'] + stats_page_views_week['cart'] }}</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] text-gray-500 font-black uppercase mb-1">ì „ì²´ ì¡°íšŒìˆ˜</p>
                        <p class="text-xl font-black text-gray-800">{{ stats_page_views_total['main'] + stats_page_views_total['category'] + stats_page_views_total['product'] + stats_page_views_total['cart'] }}</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] text-gray-500 font-black uppercase mb-1">ìƒí’ˆ ìƒì„¸ ì¡°íšŒìˆ˜ í•©ê³„</p>
                        <p class="text-xl font-black text-blue-600">{{ stats_product_views_total }}</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-5 rounded-2xl border border-orange-100 shadow-sm">
                        <p class="text-[10px] text-orange-600 font-black uppercase mb-1">ì˜¤ëŠ˜ ì£¼ë¬¸</p>
                        <p class="text-xl font-black text-orange-600">{{ stats_orders_today }}ê±´</p>
                        <p class="text-[10px] text-gray-600 font-bold">{{ "{:,}".format(stats_revenue_today) }}ì›</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border border-orange-100 shadow-sm">
                        <p class="text-[10px] text-orange-600 font-black uppercase mb-1">ì´ë²ˆ ì£¼ ì£¼ë¬¸</p>
                        <p class="text-xl font-black text-orange-600">{{ stats_orders_week }}ê±´</p>
                        <p class="text-[10px] text-gray-600 font-bold">{{ "{:,}".format(stats_revenue_week) }}ì›</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border border-orange-100 shadow-sm">
                        <p class="text-[10px] text-orange-600 font-black uppercase mb-1">ì „ì²´ ì£¼ë¬¸</p>
                        <p class="text-xl font-black text-orange-700">{{ stats_orders_total }}ê±´</p>
                        <p class="text-[10px] text-gray-600 font-bold">{{ "{:,}".format(stats_revenue_total) }}ì›</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] text-gray-500 font-black uppercase mb-1">ë¦¬ë·° ìˆ˜</p>
                        <p class="text-xl font-black text-gray-800">{{ stats_reviews_total }}ê°œ</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] text-gray-500 font-black uppercase mb-1">ìƒí’ˆ ìˆ˜</p>
                        <p class="text-xl font-black text-gray-800">{{ stats_products_total }}ê°œ</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] text-gray-500 font-black uppercase mb-1">ì¹´í…Œê³ ë¦¬ ìˆ˜</p>
                        <p class="text-xl font-black text-gray-800">{{ stats_categories_total }}ê°œ</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border border-amber-100 shadow-sm">
                        <p class="text-[10px] text-amber-600 font-black uppercase mb-1">ì¬ê³  ë¶€ì¡± (5ê°œ ë¯¸ë§Œ)</p>
                        <p class="text-xl font-black text-amber-600">{{ stats_low_stock_count }}ê°œ</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] text-gray-500 font-black uppercase mb-1">íšŒì› ìˆ˜</p>
                        <p class="text-xl font-black text-gray-800">{{ stats_members_total }}ëª…</p>
                        {% if stats_members_today or stats_members_week %}<p class="text-[9px] text-gray-400">ì˜¤ëŠ˜ {{ stats_members_today }} Â· ì´ë²ˆ ì£¼ {{ stats_members_week }}</p>{% endif %}
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
                        <h4 class="p-4 border-b border-gray-100 text-sm font-black text-gray-800">íŒë§¤ëŸ‰ ìƒìœ„ ìƒí’ˆ (ì·¨ì†Œ ì œì™¸)</h4>
                        <div class="overflow-x-auto max-h-80 overflow-y-auto">
                            <table class="w-full text-[11px]">
                                <thead class="bg-gray-50"><tr><th class="p-3 text-left">ìƒí’ˆëª…</th><th class="p-3 text-right">íŒë§¤ìˆ˜ëŸ‰</th></tr></thead>
                                <tbody>
                                    {% for r in stats_top_products_by_sold %}
                                    <tr class="border-b border-gray-50"><td class="p-3 font-bold text-gray-800 truncate max-w-[200px]">{{ r.product_name }}</td><td class="p-3 text-right font-black text-teal-600">{{ r.qty }}</td></tr>
                                    {% else %}
                                    <tr><td colspan="2" class="p-4 text-center text-gray-400">ë°ì´í„° ì—†ìŒ</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
                        <h4 class="p-4 border-b border-gray-100 text-sm font-black text-gray-800">ìƒí’ˆ ìƒì„¸ ì¡°íšŒìˆ˜ ìƒìœ„</h4>
                        <div class="overflow-x-auto max-h-80 overflow-y-auto">
                            <table class="w-full text-[11px]">
                                <thead class="bg-gray-50"><tr><th class="p-3 text-left">ìƒí’ˆëª…</th><th class="p-3 text-right">ì¡°íšŒìˆ˜</th></tr></thead>
                                <tbody>
                                    {% for p in stats_top_products_by_views %}
                                    <tr class="border-b border-gray-50"><td class="p-3 font-bold text-gray-800 truncate max-w-[200px]">{{ p.name }}</td><td class="p-3 text-right font-black text-blue-600">{{ getattr(p, 'view_count', 0) or 0 }}</td></tr>
                                    {% else %}
                                    <tr><td colspan="2" class="p-4 text-center text-gray-400">ë°ì´í„° ì—†ìŒ</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden mb-8">
                    <h4 class="p-4 border-b border-gray-100 text-sm font-black text-gray-800">ì¼ë³„ í˜ì´ì§€ë·° (ìµœê·¼ 30ì¼)</h4>
                    <div class="overflow-x-auto max-h-64 overflow-y-auto">
                        <table class="w-full text-[11px]">
                            <thead class="bg-gray-50"><tr><th class="p-3 text-left">ë‚ ì§œ</th><th class="p-3 text-right">ë©”ì¸</th><th class="p-3 text-right">ì¹´í…Œê³ ë¦¬</th><th class="p-3 text-right">ìƒí’ˆ</th><th class="p-3 text-right">ì¥ë°”êµ¬ë‹ˆ</th><th class="p-3 text-right">í•©ê³„</th></tr></thead>
                            <tbody>
                                {% for row in stats_daily_table[:30] %}
                                <tr class="border-b border-gray-50">
                                    <td class="p-3 font-bold">{{ row.date }}</td>
                                    <td class="p-3 text-right">{{ row.main }}</td>
                                    <td class="p-3 text-right">{{ row.category }}</td>
                                    <td class="p-3 text-right">{{ row.product }}</td>
                                    <td class="p-3 text-right">{{ row.cart }}</td>
                                    <td class="p-3 text-right font-black text-teal-600">{{ row.main + row.category + row.product + row.cart }}</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="6" class="p-4 text-center text-gray-400">ê¸°ë¡ ì—†ìŒ</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100 text-[11px] text-gray-600">
                    <p class="font-black text-gray-700 mb-1">í†µê³„ ì•ˆë‚´</p>
                    <p>ì¡°íšŒìˆ˜ëŠ” ë©”ì¸Â·ì¹´í…Œê³ ë¦¬Â·ìƒí’ˆìƒì„¸Â·ì¥ë°”êµ¬ë‹ˆ í˜ì´ì§€ ë°©ë¬¸ ì‹œ ì¼ë³„ë¡œ ì§‘ê³„ë©ë‹ˆë‹¤. ì£¼ë¬¸Â·ë§¤ì¶œì€ ê²°ì œì·¨ì†Œë¥¼ ì œì™¸í•œ ê±´ìˆ˜ì™€ ê²°ì œê¸ˆì•¡ í•©ê³„ì…ë‹ˆë‹¤. ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸´ ìˆ˜: {{ stats_cart_items_total }}ê°œ(í˜„ì¬ ë‹´ê¸´ ìˆ˜ëŸ‰ í•©ê³„).</p>
                </div>
            </div>

        {% elif tab == 'categories' %}
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 text-left">
                <div class="bg-white p-8 md:p-12 rounded-[2.5rem] md:rounded-[3.5rem] border border-gray-50 shadow-sm h-fit">
                    <h3 class="text-[11px] md:text-sm text-gray-400 uppercase tracking-widest mb-10 font-black">íŒë§¤ ì¹´í…Œê³ ë¦¬ ë° ì‚¬ì—…ì ì¶”ê°€</h3>
                    <form action="/admin/category/add" method="POST" class="space-y-5">
                        <input name="cat_name" placeholder="ì¹´í…Œê³ ë¦¬ëª… (ì˜ˆ: ì‚°ì§€ì§ì†¡ ë†ì‚°ë¬¼)" class="border border-gray-100 p-5 rounded-2xl w-full font-black text-sm" required>
                        <textarea name="description" placeholder="ì¹´í…Œê³ ë¦¬ ì„¤ëª… (ë°°ì†¡ ì •ì±… ë“±)" class="border border-gray-100 p-5 rounded-2xl w-full h-24 font-black text-sm"></textarea>
                        <input name="manager_email" placeholder="ê´€ë¦¬ ë§¤ë‹ˆì € ì´ë©”ì¼ (ë¡œê·¸ì¸ ID)" class="border border-gray-100 p-5 rounded-2xl w-full font-black text-sm">
                        <select name="tax_type" class="border border-gray-100 p-5 rounded-2xl w-full font-black text-sm bg-white">
                            <option value="ê³¼ì„¸">ì¼ë°˜ ê³¼ì„¸ ìƒí’ˆ</option>
                            <option value="ë©´ì„¸">ë©´ì„¸ ë†ì¶•ì‚°ë¬¼</option>
                        </select>
                        <p class="text-[10px] text-amber-600 font-bold uppercase mt-2">ë…¸ì¶œ íšŒì›ë“±ê¸‰ (ëª‡ ë“±ê¸‰ ì´ìƒ)</p>
                        <select name="min_member_grade" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs bg-white">
                            <option value="">ì „ì²´ íšŒì›</option>
                            <option value="1">1ë‹¨ê³„ ì´ìƒ</option>
                            <option value="2">2ë‹¨ê³„ ì´ìƒ</option>
                            <option value="3">3ë‹¨ê³„ ì´ìƒ</option>
                            <option value="4">4ë‹¨ê³„ ì´ìƒ</option>
                            <option value="5">5ë‹¨ê³„ë§Œ</option>
                        </select>
                        <div class="border-t border-gray-100 pt-8 space-y-4">
                            <p class="text-[10px] text-teal-600 font-bold tracking-widest uppercase">Seller Business Profile</p>
                            <input name="biz_name" placeholder="ì‚¬ì—…ì ìƒí˜¸ëª…" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm">
                            <input name="biz_representative" placeholder="ëŒ€í‘œì ì„±í•¨" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm">
                            <input name="biz_reg_number" placeholder="ì‚¬ì—…ì ë“±ë¡ë²ˆí˜¸ ( - í¬í•¨ )" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm">
                            <input name="biz_address" placeholder="ì‚¬ì—…ì¥ ì†Œì¬ì§€" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm">
                            <input name="biz_contact" placeholder="ê³ ê° ì„¼í„° ë²ˆí˜¸" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm">
                            <input name="seller_link" placeholder="íŒë§¤ì ë¬¸ì˜ ë§í¬" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm">
                            <p class="text-[10px] text-blue-600 font-bold tracking-widest uppercase pt-2">ì •ì‚° ê³„ì¢Œ</p>
                            <input name="bank_name" placeholder="ì€í–‰ëª…" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm">
                            <input name="account_holder" placeholder="ì˜ˆê¸ˆì£¼" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm">
                            <input name="settlement_account" placeholder="ì •ì‚°ê³„ì¢Œ (ê³„ì¢Œë²ˆí˜¸)" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm">
                        </div>
                        <button class="w-full bg-teal-600 text-white py-5 rounded-3xl font-black text-base md:text-lg shadow-xl hover:bg-teal-700 transition">ì‹ ê·œ ì¹´í…Œê³ ë¦¬ ìƒì„±</button>
                    </form>
                </div>
                
                <div class="bg-white rounded-[2.5rem] md:rounded-[3.5rem] border border-gray-50 shadow-sm overflow-hidden h-fit">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b border-gray-100 font-bold uppercase text-[10px] md:text-xs">
                            <tr><th class="p-6">ìˆœì„œ</th><th class="p-6">ì¹´í…Œê³ ë¦¬ ì •ë³´</th><th class="p-6 text-center">ê´€ë¦¬</th></tr>
                        </thead>
                        <tbody>
                            {% for c in categories %}
                            <tr class="border-b border-gray-50 hover:bg-gray-50/50 transition">
                                <td class="p-6 flex gap-2">
                                    <a href="/admin/category/move/{{c.id}}/up" class="text-blue-500 hover:scale-125 transition"><i class="fas fa-chevron-up"></i></a>
                                    <a href="/admin/category/move/{{c.id}}/down" class="text-red-500 hover:scale-125 transition"><i class="fas fa-chevron-down"></i></a>
                                </td>
                                <td class="p-6">
                                    <b class="text-gray-800">{{ c.name }}</b><br>
                                    <span class="text-gray-400 text-[10px]">ë§¤ë‹ˆì €: {{ c.manager_email or 'ë¯¸ì§€ì •' }}</span>
                                </td>
                                <td class="p-6 text-center space-x-3 text-[10px]">
                                    <a href="/admin/category/edit/{{c.id}}" class="text-blue-500 font-bold hover:underline">ìˆ˜ì •</a>
                                    <a href="/admin/category/delete/{{c.id}}" class="text-red-200 hover:text-red-500 transition" onclick="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        {% elif tab == 'delivery_zone' %}
            {% if kakao_map_app_key %}
            <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_map_app_key }}"></script>
            {% else %}
            <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
            <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
            {% endif %}
            <div class="mb-10 p-6 bg-teal-50 border border-teal-200 rounded-2xl">
                <h3 class="text-base font-black text-teal-800 italic mb-2">í€µì§€ì—­ ì„¤ì • <span class="text-teal-600 text-xs font-bold">(ìš°ì„  ì ìš©, ê·¸ ì™¸ ë°°ì†¡ë¶ˆê°€)</span></h3>
                <p class="text-[11px] text-teal-700 font-bold mb-3"><strong>ë°©ë²• 1) ì§€ë„ì—ì„œ ì¢Œí‘œë¡œ ì„¤ì •</strong> â€” ì•„ë˜ ì§€ë„ì—ì„œ ã€Œí€µì§€ì—­ í¸ì§‘ã€ ì„ íƒ í›„ í´ë¦­í•´ ê¼­ì§“ì ì„ ì°ê³  <strong>í€µì§€ì—­ í´ë¦¬ê³¤ ì €ì¥</strong>. <strong>ë°©ë²• 2) ì§€ì—­ëª… ì…ë ¥</strong> â€” ì£¼ì†Œì— í¬í•¨ë˜ë©´ ë°°ì†¡ê°€ëŠ¥ì¸ ì§€ì—­ëª…ì„ ì‰¼í‘œë¡œ ì…ë ¥.</p>
                <p class="text-[10px] text-teal-600 mb-3">â€» í€µì§€ì—­ ì¢Œí‘œ(í´ë¦¬ê³¤)ê°€ ìˆìœ¼ë©´ ì¢Œí‘œë¡œë§Œ íŒë‹¨í•©ë‹ˆë‹¤. ì—†ìœ¼ë©´ ì§€ì—­ëª…ìœ¼ë¡œ íŒë‹¨í•˜ë©°, ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ì¼ë°˜ í´ë¦¬ê³¤ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
                <div class="flex gap-2 flex-wrap items-center mb-3">
                    <input type="text" id="quick_region_input" value="{{ delivery_zone_quick_regions | join(', ') }}" placeholder="ì†¡ë„ë™, ì„ ë¦°ë™ (ì¢Œí‘œ ëŒ€ì‹  ì‚¬ìš© ì‹œ)" class="flex-1 min-w-[200px] border border-teal-200 rounded-xl px-4 py-2.5 text-sm font-bold text-gray-800">
                    <button type="button" id="quick_region_save_btn" class="px-5 py-2.5 bg-teal-600 text-white rounded-xl font-black text-xs shadow hover:bg-teal-700">í€µì§€ì—­(ì´ë¦„) ì €ì¥</button>
                </div>
                <label class="flex items-center gap-2 cursor-pointer mb-2">
                    <input type="checkbox" id="use_quick_region_only" {% if delivery_zone_use_quick_only %}checked{% endif %} class="rounded border-teal-300 text-teal-600 focus:ring-teal-500">
                    <span class="text-sm font-bold text-teal-800">í€µì§€ì—­ë§Œ ì‚¬ìš© â€” í€µì§€ì—­(ì¢Œí‘œ/ì´ë¦„) ìˆìœ¼ë©´ ê·¸ë§Œ ë°°ì†¡ê°€ëŠ¥, ê·¸ ì™¸ ë°°ì†¡ë¶ˆê°€</span>
                </label>
            </div>
            <div class="mb-10 p-6 bg-amber-50 border border-amber-200 rounded-2xl">
                <h3 class="text-base font-black text-amber-800 italic mb-2">í€µ ì§€ì—­ ì¶”ê°€ ë°°ì†¡ë£Œ Â· ì•ˆë‚´ ë¬¸êµ¬ <span class="text-amber-600 text-xs font-bold">(ìˆ˜ì • ê°€ëŠ¥)</span></h3>
                <p class="text-[11px] text-amber-700 font-bold mb-3">í€µ í´ë¦¬ê³¤ ì§€ì—­ ì£¼ë¬¸ ì‹œ ê²°ì œ í™”ë©´ì— ì•ˆë‚´ë˜ëŠ” ë¬¸êµ¬ì™€ ì¶”ê°€ ë°°ì†¡ë£Œ(ì›)ì…ë‹ˆë‹¤. ë™ì˜ ì‹œ í•´ë‹¹ ê¸ˆì•¡ì´ ê²°ì œì— í¬í•¨ë©ë‹ˆë‹¤.</p>
                <div class="flex flex-wrap gap-3 items-end mb-3">
                    <label class="flex flex-col gap-1">
                        <span class="text-[10px] text-amber-700 font-black uppercase">í€µ ì¶”ê°€ ë°°ì†¡ë£Œ (ì›)</span>
                        <input type="number" id="quick_extra_fee_input" min="0" step="1" value="{{ delivery_zone_quick_extra_fee }}" class="w-32 border border-amber-200 rounded-xl px-3 py-2 text-sm font-black text-gray-800">
                    </label>
                    <button type="button" id="quick_extra_save_btn" class="px-5 py-2.5 bg-amber-600 text-white rounded-xl font-black text-xs shadow hover:bg-amber-700">ì €ì¥</button>
                </div>
                <label class="flex flex-col gap-1">
                    <span class="text-[10px] text-amber-700 font-black uppercase">í€µ ë°°ì†¡ ì•ˆë‚´ ë¬¸êµ¬ (ê²°ì œ ì „ ê³ ê°ì—ê²Œ í‘œì‹œ)</span>
                    <textarea id="quick_extra_message_input" rows="3" class="w-full border border-amber-200 rounded-xl px-4 py-3 text-sm font-bold text-gray-800 placeholder-gray-400" placeholder="í•´ë‹¹ ì£¼ì†ŒëŠ” ë°°ì†¡ì§€ì—­ì´ ì•„ë‹™ë‹ˆë‹¤. ë°°ì†¡ë£Œ ì¶”ê°€ ì‹œ í€µìœ¼ë¡œ ë°°ì†¡ë©ë‹ˆë‹¤. ì¶”ê°€í•˜ì‹œê³  ì£¼ë¬¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?">{{ delivery_zone_quick_extra_message }}</textarea>
                </label>
            </div>
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-2">ì§€ë„ì—ì„œ ë°°ì†¡êµ¬ì—­ ì„¤ì • (ì¢Œí‘œ í´ë¦­)</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-2">í¸ì§‘í•  êµ¬ì—­ì„ ì„ íƒí•œ ë’¤ ì§€ë„ë¥¼ í´ë¦­í•´ ê¼­ì§“ì ì„ ì¶”ê°€í•˜ì„¸ìš”. <span class="text-orange-600 font-black">ì£¼í™©ìƒ‰ = ì¼ë°˜ ë°°ì†¡êµ¬ì—­</span> (í€µì§€ì—­ ë¹„ì—ˆì„ ë•Œë§Œ ì‚¬ìš©), <span class="text-teal-600 font-black">í‹¸ìƒ‰ = í€µì§€ì—­</span> (ìš°ì„  ì ìš©).</p>
                <div class="flex flex-wrap gap-3 mb-3 items-center">
                    <span class="text-xs font-black text-gray-600">ì§€ê¸ˆ í¸ì§‘:</span>
                    <button type="button" id="dz_edit_main_btn" class="px-4 py-2 rounded-xl font-black text-xs bg-orange-100 text-orange-700 border-2 border-orange-300">ì¼ë°˜ í´ë¦¬ê³¤</button>
                    <button type="button" id="dz_edit_quick_btn" class="px-4 py-2 rounded-xl font-black text-xs bg-teal-100 text-teal-700 border-2 border-teal-300">í€µì§€ì—­ í´ë¦¬ê³¤</button>
                </div>
                <div class="flex gap-3 mb-3 items-center flex-wrap">
                    <button type="button" id="dz_save_btn" class="px-5 py-2.5 bg-orange-600 text-white rounded-xl font-black text-xs shadow hover:bg-orange-700">ì¼ë°˜ í´ë¦¬ê³¤ ì €ì¥</button>
                    <button type="button" id="dz_reset_btn" class="px-5 py-2.5 bg-gray-200 text-gray-700 rounded-xl font-black text-xs hover:bg-gray-300">ì¼ë°˜ ì´ˆê¸°í™”</button>
                    <span id="dz_coords_display" class="text-[11px] text-gray-600 font-bold"></span>
                </div>
                <div class="flex gap-3 mb-3 items-center flex-wrap">
                    <button type="button" id="dz_quick_save_btn" class="px-5 py-2.5 bg-teal-600 text-white rounded-xl font-black text-xs shadow hover:bg-teal-700">í€µì§€ì—­ í´ë¦¬ê³¤ ì €ì¥</button>
                    <button type="button" id="dz_quick_reset_btn" class="px-5 py-2.5 bg-gray-200 text-gray-700 rounded-xl font-black text-xs hover:bg-gray-300">í€µì§€ì—­ ì´ˆê¸°í™”</button>
                    <span id="dz_quick_coords_display" class="text-[11px] text-teal-700 font-bold"></span>
                </div>
                <div id="delivery_zone_map" class="w-full rounded-2xl border border-gray-200 overflow-hidden" style="height: 500px;"></div>
                <p class="text-[10px] text-gray-500 mt-2">ê¼­ì§“ì  3ê°œ ì´ìƒ í•„ìš”. {% if not kakao_map_app_key %}(ì¹´ì¹´ì˜¤ë§µ: KAKAO_MAP_APP_KEY ì„¤ì •){% endif %}</p>
            </div>
            <script>
            (function(){
                var initialPolygon = {{ delivery_zone_polygon | tojson }};
                var initialQuickPolygon = {{ delivery_zone_quick_polygon | tojson }};
                var yeonsu = [37.3931, 126.6397];
                var points = Array.isArray(initialPolygon) ? initialPolygon.slice() : [];
                var quickPoints = Array.isArray(initialQuickPolygon) ? initialQuickPolygon.slice() : [];
                var editMode = 'main';
                var useKakao = {{ 'true' if kakao_map_app_key else 'false' }};

                function updateCoordsDisplay() {
                    var el = document.getElementById('dz_coords_display');
                    if (el) el.textContent = points.length ? 'ì¼ë°˜ ê¼­ì§“ì  ' + points.length + 'ê°œ' : '';
                    var qel = document.getElementById('dz_quick_coords_display');
                    if (qel) qel.textContent = quickPoints.length ? 'í€µì§€ì—­ ê¼­ì§“ì  ' + quickPoints.length + 'ê°œ' : '';
                    var mainBtn = document.getElementById('dz_edit_main_btn');
                    var quickBtn = document.getElementById('dz_edit_quick_btn');
                    if (mainBtn) { mainBtn.className = editMode === 'main' ? 'px-4 py-2 rounded-xl font-black text-xs bg-orange-600 text-white border-2 border-orange-700' : 'px-4 py-2 rounded-xl font-black text-xs bg-orange-100 text-orange-700 border-2 border-orange-300'; }
                    if (quickBtn) { quickBtn.className = editMode === 'quick' ? 'px-4 py-2 rounded-xl font-black text-xs bg-teal-600 text-white border-2 border-teal-700' : 'px-4 py-2 rounded-xl font-black text-xs bg-teal-100 text-teal-700 border-2 border-teal-300'; }
                }

                function bindButtons() {
                    document.getElementById('dz_save_btn').addEventListener('click', function() {
                        if (points.length < 3) { alert('ì¼ë°˜ í´ë¦¬ê³¤ ê¼­ì§“ì ì„ 3ê°œ ì´ìƒ ì°ì–´ì£¼ì„¸ìš”.'); return; }
                        fetch('/admin/delivery_zone/api', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, body: JSON.stringify({ polygon: points }) })
                        .then(function(r) { return r.json(); }).then(function(d) { if (d.error) alert(d.error); else alert('ì¼ë°˜ í´ë¦¬ê³¤ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); }).catch(function() { alert('ì €ì¥ ì‹¤íŒ¨'); });
                    });
                    document.getElementById('dz_reset_btn').addEventListener('click', function() { points = []; if (window.dzRedraw) window.dzRedraw(); updateCoordsDisplay(); });
                    document.getElementById('dz_quick_save_btn').addEventListener('click', function() {
                        if (quickPoints.length < 3) { alert('í€µì§€ì—­ í´ë¦¬ê³¤ ê¼­ì§“ì ì„ 3ê°œ ì´ìƒ ì°ì–´ì£¼ì„¸ìš”.'); return; }
                        fetch('/admin/delivery_zone/api', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, body: JSON.stringify({ quick_region_polygon: quickPoints }) })
                        .then(function(r) { return r.json(); }).then(function(d) { if (d.error) alert(d.error); else alert('í€µì§€ì—­ í´ë¦¬ê³¤ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ê·¸ ì™¸ ì§€ì—­ ë°°ì†¡ë¶ˆê°€ ì ìš©.'); }).catch(function() { alert('ì €ì¥ ì‹¤íŒ¨'); });
                    });
                    document.getElementById('dz_quick_reset_btn').addEventListener('click', function() { quickPoints = []; if (window.dzRedraw) window.dzRedraw(); updateCoordsDisplay(); });
                    document.getElementById('dz_edit_main_btn').addEventListener('click', function() { editMode = 'main'; updateCoordsDisplay(); });
                    document.getElementById('dz_edit_quick_btn').addEventListener('click', function() { editMode = 'quick'; updateCoordsDisplay(); });
                    var qrInput = document.getElementById('quick_region_input');
                    var useQuickOnlyCb = document.getElementById('use_quick_region_only');
                    document.getElementById('quick_region_save_btn').addEventListener('click', function() {
                        var raw = (qrInput && qrInput.value) ? qrInput.value.trim() : '';
                        var list = raw ? raw.replace(/ï¼Œ/g, ',').split(',').map(function(s){ return s.trim(); }).filter(Boolean) : [];
                        var useQuickOnly = useQuickOnlyCb && useQuickOnlyCb.checked;
                        fetch('/admin/delivery_zone/api', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, body: JSON.stringify({ quick_region_names: list, use_quick_region_only: useQuickOnly }) })
                        .then(function(r) { return r.json(); }).then(function(d) { if (d.error) alert(d.error); else alert('í€µì§€ì—­(ì´ë¦„) ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); }).catch(function() { alert('ì €ì¥ ì‹¤íŒ¨'); });
                    });
                    var feeIn = document.getElementById('quick_extra_fee_input');
                    var msgIn = document.getElementById('quick_extra_message_input');
                    document.getElementById('quick_extra_save_btn').addEventListener('click', function() {
                        var fee = feeIn ? (parseInt(feeIn.value, 10) || 0) : 10000;
                        var msg = (msgIn && msgIn.value) ? msgIn.value.trim() : '';
                        fetch('/admin/delivery_zone/api', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, body: JSON.stringify({ quick_extra_fee: fee, quick_extra_message: msg }) })
                        .then(function(r) { return r.json(); }).then(function(d) { if (d.error) alert(d.error); else alert('í€µ ì¶”ê°€ ë°°ì†¡ë£ŒÂ·ì•ˆë‚´ ë¬¸êµ¬ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); }).catch(function() { alert('ì €ì¥ ì‹¤íŒ¨'); });
                    });
                }

                if (useKakao && typeof kakao !== 'undefined') {
                    kakao.maps.load(function() {
                        var container = document.getElementById('delivery_zone_map');
                        var map = new kakao.maps.Map(container, { center: new kakao.maps.LatLng(yeonsu[0], yeonsu[1]), level: 5 });
                        var mainMarkers = [], mainLine = null, quickMarkers = [], quickLine = null;

                        window.dzRedraw = function() {
                            mainMarkers.forEach(function(m) { m.setMap(null); }); mainMarkers = [];
                            if (mainLine) { mainLine.setMap(null); mainLine = null; }
                            points.forEach(function(p) { mainMarkers.push(new kakao.maps.Marker({ position: new kakao.maps.LatLng(p[0], p[1]), map: map })); });
                            if (points.length >= 2) { mainLine = new kakao.maps.Polyline({ path: points.map(function(p){ return new kakao.maps.LatLng(p[0],p[1]); }), strokeColor: '#ea580c', strokeWeight: 4 }); mainLine.setMap(map); }
                            quickMarkers.forEach(function(m) { m.setMap(null); }); quickMarkers = [];
                            if (quickLine) { quickLine.setMap(null); quickLine = null; }
                            quickPoints.forEach(function(p) { quickMarkers.push(new kakao.maps.Marker({ position: new kakao.maps.LatLng(p[0], p[1]), map: map })); });
                            if (quickPoints.length >= 2) { quickLine = new kakao.maps.Polyline({ path: quickPoints.map(function(p){ return new kakao.maps.LatLng(p[0],p[1]); }), strokeColor: '#0d9488', strokeWeight: 5 }); quickLine.setMap(map); }
                            updateCoordsDisplay();
                        };

                        kakao.maps.event.addListener(map, 'click', function(ev) {
                            var lat = ev.latLng.getLat(), lng = ev.latLng.getLng();
                            if (editMode === 'main') points.push([lat, lng]); else quickPoints.push([lat, lng]);
                            window.dzRedraw();
                        });

                        bindButtons();
                        window.dzRedraw();
                    });
                } else {
                    var map = L.map('delivery_zone_map').setView(yeonsu, 14);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
                    var mainLayer = L.layerGroup().addTo(map), quickLayer = L.layerGroup().addTo(map);
                    var mainPoly = null, quickPoly = null;

                    window.dzRedraw = function() {
                        mainLayer.clearLayers(); quickLayer.clearLayers();
                        if (mainPoly) { map.removeLayer(mainPoly); mainPoly = null; }
                        if (quickPoly) { map.removeLayer(quickPoly); quickPoly = null; }
                        points.forEach(function(p) { L.marker(p).addTo(mainLayer); });
                        quickPoints.forEach(function(p) { L.marker(p).addTo(quickLayer); });
                        if (points.length >= 2) { mainPoly = L.polyline(points, { color: '#ea580c', weight: 4 }).addTo(map); }
                        if (quickPoints.length >= 2) { quickPoly = L.polyline(quickPoints, { color: '#0d9488', weight: 5 }).addTo(map); }
                        updateCoordsDisplay();
                    };

                    map.on('click', function(e) {
                        var pt = [e.latlng.lat, e.latlng.lng];
                        if (editMode === 'main') points.push(pt); else quickPoints.push(pt);
                        window.dzRedraw();
                    });

                    bindButtons();
                    window.dzRedraw();
                }
            })();
            </script>

        {% elif tab == 'restaurant_request' %}
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-2">ì „êµ­ë§›ì§‘ìš”ì²­ ê´€ë¦¬</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-4">ê³ ê°ì´ ë“±ë¡í•œ ì „êµ­ë§›ì§‘ ìš”ì²­ ê¸€. ê´€ë¦¬ì ëŒ“ê¸€ì€ ìƒì„¸ í˜ì´ì§€ì— ë…¸ì¶œë©ë‹ˆë‹¤.</p>
                <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden">
                    <table class="w-full text-left text-[11px]">
                        <thead class="bg-gray-50 border-b border-gray-100"><tr><th class="p-4">ID</th><th class="p-4">ì—…ì²´ëª…</th><th class="p-4">ì‘ì„±ì</th><th class="p-4">ì‘ì„±ì¼</th><th class="p-4">ì¶”ì²œ</th><th class="p-4">ë¹„ì¶”ì²œ</th><th class="p-4">ê´€ë¦¬ì ëŒ“ê¸€</th><th class="p-4">ê´€ë¦¬</th></tr></thead>
                        <tbody>
                            {% for p in admin_restaurant_requests %}
                            {% set vc = restaurant_recommend_counts.get(p.id, (0, 0)) %}
                            <tr class="border-b border-gray-50 hover:bg-gray-50/50">
                                <td class="p-4">{{ p.id }}</td>
                                <td class="p-4 font-bold">{{ p.store_name }}</td>
                                <td class="p-4">{{ p.user_name or '-' }}</td>
                                <td class="p-4">{{ p.created_at.strftime('%Y-%m-%d %H:%M') if p.created_at else '-' }}</td>
                                <td class="p-4 text-teal-600 font-black">{{ vc[0] }}</td>
                                <td class="p-4 text-gray-500 font-black">{{ vc[1] }}</td>
                                <td class="p-4 max-w-[200px]">
                                    <form action="/admin/board/restaurant-request/{{ p.id }}/comment" method="POST" class="flex gap-2">
                                        <textarea name="admin_notes" rows="2" class="flex-1 min-w-0 text-[10px] border border-gray-200 rounded-lg px-2 py-1" placeholder="ëŒ“ê¸€ ì…ë ¥">{{ p.admin_notes or '' }}</textarea>
                                        <button type="submit" class="shrink-0 px-2 py-1 bg-teal-600 text-white rounded-lg text-[10px] font-black">ì €ì¥</button>
                                    </form>
                                </td>
                                <td class="p-4">
                                    <a href="/board/restaurant-request/{{ p.id }}" target="_blank" class="text-teal-600 font-black mr-2">ë³´ê¸°</a>
                                    <form action="/admin/board/restaurant-request/{{ p.id }}/hide" method="POST" class="inline" onsubmit="return confirm('ìˆ¨ê¸°ì‹œê² ìŠµë‹ˆê¹Œ?');"><button type="submit" class="text-amber-600 font-black">{{ 'ìˆ¨ê¹€í•´ì œ' if p.is_hidden else 'ìˆ¨ê¸°ê¸°' }}</button></form>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="8" class="p-8 text-center text-gray-400">ë“±ë¡ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% elif tab == 'delivery_request' %}
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-2">ë°°ì†¡ìš”ì²­ ê´€ë¦¬</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-4">ê³ ê°ì´ ìš”ì²­í•œ ë°°ì†¡ ì§€ì—­. ì¶”ì²œì´ ë§ì€ ì§€ì—­ë¶€í„° ë°°ì†¡êµ¬ì—­ í™•ì¥ì„ ê²€í† í•©ë‹ˆë‹¤. ì ìš© ì‹œ <a href="/admin?tab=delivery_zone" class="text-teal-600 font-black underline">ë°°ì†¡êµ¬ì—­ê´€ë¦¬</a> íƒ­ì—ì„œ ì„¤ì •í•˜ì„¸ìš”.</p>
                <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden">
                    <table class="w-full text-left text-[11px]">
                        <thead class="bg-gray-50 border-b border-gray-100"><tr><th class="p-4">ID</th><th class="p-4">ì§€ì—­ëª…</th><th class="p-4">ê¸€ë‚´ìš©</th><th class="p-4">ì‘ì„±ì</th><th class="p-4">ì‘ì„±ì¼</th><th class="p-4">ì¶”ì²œ</th><th class="p-4">ë¹„ì¶”ì²œ</th><th class="p-4">ê´€ë¦¬ì ëŒ“ê¸€</th><th class="p-4">ê´€ë¦¬</th></tr></thead>
                        <tbody>
                            {% for p in admin_delivery_requests %}
                            {% set vc = delivery_request_vote_counts.get(p.id, (0, 0)) %}
                            <tr class="border-b border-gray-50 hover:bg-gray-50/50">
                                <td class="p-4">{{ p.id }}</td>
                                <td class="p-4 font-bold text-teal-700">{{ p.region_name }}</td>
                                <td class="p-4 max-w-[180px] truncate" title="{{ (p.content or '')[:200] }}">{{ (p.content or '-')[:60] }}{% if (p.content or '')|length > 60 %}...{% endif %}</td>
                                <td class="p-4">{{ p.user_name or '-' }}</td>
                                <td class="p-4">{{ p.created_at.strftime('%Y-%m-%d %H:%M') if p.created_at else '-' }}</td>
                                <td class="p-4 text-teal-600 font-black">{{ vc[0] }}</td>
                                <td class="p-4 text-gray-500 font-black">{{ vc[1] }}</td>
                                <td class="p-4 max-w-[200px]">
                                    <form action="/admin/board/delivery-request/{{ p.id }}/comment" method="POST" class="flex gap-2">
                                        <textarea name="admin_notes" rows="2" class="flex-1 min-w-0 text-[10px] border border-gray-200 rounded-lg px-2 py-1" placeholder="ëŒ“ê¸€ ì…ë ¥">{{ p.admin_notes or '' }}</textarea>
                                        <button type="submit" class="shrink-0 px-2 py-1 bg-teal-600 text-white rounded-lg text-[10px] font-black">ì €ì¥</button>
                                    </form>
                                </td>
                                <td class="p-4">
                                    <a href="/board/delivery-request/{{ p.id }}" target="_blank" class="text-teal-600 font-black mr-2">ë³´ê¸°</a>
                                    <a href="/admin?tab=delivery_zone" class="text-blue-600 font-black mr-2">ë°°ì†¡êµ¬ì—­</a>
                                    <form action="/admin/board/delivery-request/{{ p.id }}/hide" method="POST" class="inline" onsubmit="return confirm('ìˆ¨ê¸°ì‹œê² ìŠµë‹ˆê¹Œ?');"><button type="submit" class="text-amber-600 font-black">{{ 'ìˆ¨ê¹€í•´ì œ' if p.is_hidden else 'ìˆ¨ê¸°ê¸°' }}</button></form>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="9" class="p-8 text-center text-gray-400">ë“±ë¡ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% elif tab == 'partnership' %}
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-2">ì œíœ´ë¬¸ì˜ ê´€ë¦¬</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-4">ë¹„ë°€ê¸€ì€ ê¸€ì“´ì´ë§Œ ëª©ë¡Â·ìƒì„¸ ì¡°íšŒ ê°€ëŠ¥. ê´€ë¦¬ì ëŒ“ê¸€ì€ ê¸€ì“´ì´/ê´€ë¦¬ì ìƒì„¸ì—ì„œ í™•ì¸ë©ë‹ˆë‹¤.</p>
                <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden">
                    <table class="w-full text-left text-[11px]">
                        <thead class="bg-gray-50 border-b border-gray-100"><tr><th class="p-4">ID</th><th class="p-4">ì œíœ´ì¢…ë¥˜</th><th class="p-4">ì‘ì„±ì</th><th class="p-4">ì‘ì„±ì¼</th><th class="p-4">ë¹„ë°€</th><th class="p-4">ê´€ë¦¬ì ëŒ“ê¸€</th><th class="p-4">ê´€ë¦¬</th></tr></thead>
                        <tbody>
                            {% for p in admin_partnership_inquiries %}
                            <tr class="border-b border-gray-50 hover:bg-gray-50/50">
                                <td class="p-4">{{ p.id }}</td>
                                <td class="p-4 font-bold">{{ p.partnership_type or '-' }}</td>
                                <td class="p-4">{{ p.user_name or '-' }}</td>
                                <td class="p-4">{{ p.created_at.strftime('%Y-%m-%d %H:%M') if p.created_at else '-' }}</td>
                                <td class="p-4">{{ 'Y' if p.is_secret else '-' }}</td>
                                <td class="p-4 max-w-[200px]">
                                    <form action="/admin/board/partnership/{{ p.id }}/comment" method="POST" class="flex gap-2">
                                        <textarea name="admin_notes" rows="2" class="flex-1 min-w-0 text-[10px] border border-gray-200 rounded-lg px-2 py-1" placeholder="ëŒ“ê¸€ ì…ë ¥">{{ p.admin_notes or '' }}</textarea>
                                        <button type="submit" class="shrink-0 px-2 py-1 bg-teal-600 text-white rounded-lg text-[10px] font-black">ì €ì¥</button>
                                    </form>
                                </td>
                                <td class="p-4">
                                    <a href="/board/partnership/{{ p.id }}" target="_blank" class="text-teal-600 font-black mr-2">ë³´ê¸°</a>
                                    <form action="/admin/board/partnership/{{ p.id }}/hide" method="POST" class="inline" onsubmit="return confirm('ìˆ¨ê¸°ì‹œê² ìŠµë‹ˆê¹Œ?');"><button type="submit" class="text-amber-600 font-black">{{ 'ìˆ¨ê¹€í•´ì œ' if p.is_hidden else 'ìˆ¨ê¸°ê¸°' }}</button></form>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="7" class="p-8 text-center text-gray-400">ë“±ë¡ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        {% elif tab == 'seller_request' or tab == 'email_order' %}
            <div class="mb-12">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <div>
                        <h3 class="text-lg font-black text-gray-800 italic mb-1">emailë°œì£¼</h3>
                        <p class="text-[11px] text-gray-500 font-bold">ì¹´í…Œê³ ë¦¬ë³„ ë°œì£¼ í’ˆëª©(ê²°ì œ í’ˆëª©ë„˜ë²„ë³„ ì˜¤ë”) ì¡°íšŒ, ë‚ ì§œë³„ ë¶„ë¥˜, ë°œì£¼ìƒíƒœ í™•ì¸. ì´ë©”ì¼ ê¸°ì… ì‹œ ë°œì£¼ì–‘ì‹ ìë™ ìƒì„± í›„ í™•ì¸ ì‹œ ë©”ì¼ ë°œì†¡.</p>
                    </div>
                    <div class="flex gap-2">
                        {% if my_categories %}<a href="/seller/orders" class="px-4 py-2.5 bg-teal-100 text-teal-700 rounded-xl text-xs font-black hover:bg-teal-200 transition">ë‚´ ë°œì£¼ ëª©ë¡</a>{% endif %}
                        <a href="/admin/email-setup" class="px-4 py-2.5 bg-gray-100 text-gray-700 rounded-xl text-xs font-black hover:bg-gray-200 transition">ì´ë©”ì¼ í‚¤ ì„¤ì • ì•ˆë‚´</a>
                    </div>
                </div>
                <form method="GET" action="/admin" class="flex flex-wrap items-center gap-3 mb-6 p-4 bg-gray-50 rounded-2xl border border-gray-100">
                    <input type="hidden" name="tab" value="email_order">
                    <label class="text-[11px] font-black text-gray-600">ë‚ ì§œë³„ ë¶„ë¥˜</label>
                    <input type="date" name="order_date" value="{{ email_order_date.strftime('%Y-%m-%d') if email_order_date else '' }}" class="border border-gray-200 rounded-xl px-3 py-2 text-sm font-bold">
                    <button type="submit" class="px-4 py-2 bg-teal-600 text-white rounded-xl text-xs font-black hover:bg-teal-700">ì¡°íšŒ</button>
                </form>
                {% for c in seller_request_categories %}
                <div class="mb-8">
                    <h4 class="text-sm font-black text-gray-800 mb-2 flex items-center gap-2">{{ c.name }} <span class="text-[10px] font-normal text-gray-500">(íŒë§¤ì ì´ë©”ì¼: {{ c.manager_email or '-' }})</span></h4>
                    <div class="overflow-x-auto rounded-2xl border border-gray-200 bg-white">
                        <table class="w-full text-left min-w-[640px] text-[11px] font-bold border-collapse">
                            <thead class="bg-gray-800 text-white">
                                <tr>
                                    <th class="p-3 border border-gray-600 w-36">íŒë§¤ì‹œê°</th>
                                    <th class="p-3 border border-gray-600">í’ˆëª…</th>
                                    <th class="p-3 border border-gray-600 w-16 text-center">ìˆ˜ëŸ‰</th>
                                    <th class="p-3 border border-gray-600 w-28 text-right">ê¸ˆì•¡í•©ê³„</th>
                                    <th class="p-3 border border-gray-600 w-16 text-center">VAT</th>
                                    <th class="p-3 border border-gray-600 w-24 text-center">ë°œì£¼ìƒíƒœ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in email_order_lines_by_category[c.id] %}
                                <tr class="border-b border-gray-100">
                                    <td class="p-3">{{ row.sale_dt.strftime('%Y-%m-%d %H:%M') if row.sale_dt else '-' }}</td>
                                    <td class="p-3">{{ row.product_name }}</td>
                                    <td class="p-3 text-center">{{ row.quantity }}</td>
                                    <td class="p-3 text-right">{{ "{:,}".format(row.amount_total) }}ì›</td>
                                    <td class="p-3 text-center">{{ row.vat_label }}</td>
                                    <td class="p-3 text-center">
                                        {% if row.status == 'í™•ì¸ì™„ë£Œ' %}<span class="text-teal-600">í™•ì¸ì™„ë£Œ</span>{% elif row.status == 'ë°œì†¡ì™„ë£Œ' %}<span class="text-amber-600">ë°œì†¡ì™„ë£Œ</span>{% else %}<span class="text-gray-500">ëŒ€ê¸°</span>{% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td colspan="6" class="p-6 text-center text-gray-400 text-xs">í•´ë‹¹ ì¼ì ë°œì£¼ í’ˆëª© ì—†ìŒ</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if email_order_lines_by_category[c.id] %}
                    <div class="email-order-row mt-3 flex flex-wrap items-center gap-2">
                        <span class="text-[11px] font-black text-gray-600">ë°œì£¼ ì´ë©”ì¼ ìˆ˜ì‹ :</span>
                        <input type="email" class="email-order-to border border-gray-200 rounded-xl px-3 py-2 text-sm w-64" placeholder="ì´ë©”ì¼ ê¸°ì… ì‹œ ë°œì£¼ì–‘ì‹ ìë™ ìƒì„±" data-category-id="{{ c.id }}" data-category-name="{{ c.name }}" value="{{ c.manager_email or '' }}">
                        <button type="button" class="email-order-gen px-4 py-2 rounded-xl bg-teal-600 text-white text-xs font-black hover:bg-teal-700" data-category-id="{{ c.id }}" data-category-name="{{ c.name }}">ì–‘ì‹ ìƒì„±</button>
                        <a href="/admin/settlement/category_excel?category={{ c.name | urlencode }}&start_date={{ (email_order_date.strftime('%Y-%m-%d') if email_order_date else '') }}%2000:00&end_date={{ (email_order_date.strftime('%Y-%m-%d') if email_order_date else '') }}%2023:59" class="inline-block px-3 py-1.5 rounded-lg bg-blue-100 text-blue-700 text-[10px] font-black hover:bg-blue-200">ì¹´í…Œê³ ë¦¬ ì—‘ì…€</a>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <p class="text-gray-500 text-sm py-6">íŒë§¤ì ì´ë©”ì¼ì´ ë“±ë¡ëœ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬ ì„¤ì •ì—ì„œ ë§¤ë‹ˆì € ì´ë©”ì¼ì„ ë„£ì–´ ì£¼ì„¸ìš”.</p>
                {% endfor %}
                <div id="email-order-result" class="hidden mt-4 p-4 rounded-2xl bg-teal-50 border border-teal-200">
                    <p class="font-black text-teal-800 mb-2">ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ</p>
                    <p class="text-xs font-mono break-all" id="email-order-confirm-url"></p>
                    <p class="text-xs mt-2">í™•ì¸ì½”ë“œ: <strong id="email-order-confirm-code"></strong></p>
                </div>
                <div id="email-order-preview-modal" class="hidden fixed inset-0 z-50 overflow-auto bg-black/50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl max-w-2xl w-full p-6 max-h-[90vh] overflow-auto">
                        <h4 class="font-black text-gray-800 mb-2">ë°œì£¼ì–‘ì‹ ë¯¸ë¦¬ë³´ê¸° Â· í™•ì¸ ì‹œ ë©”ì¼ ë°œì†¡</h4>
                        <p class="text-[10px] text-gray-500 mb-2">ìˆ˜ì‹ : <span id="preview-to-email"></span></p>
                        <div class="border border-gray-200 rounded-xl p-3 mb-4 text-xs font-mono whitespace-pre-wrap break-words" id="preview-body"></div>
                        <div class="flex gap-2">
                            <button type="button" id="email-order-send-confirm" class="px-4 py-2 bg-teal-600 text-white rounded-xl font-black text-xs">í™•ì¸ ì‹œ ë©”ì¼ ë°œì†¡</button>
                            <button type="button" id="email-order-preview-close" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-xl font-black text-xs">ë‹«ê¸°</button>
                        </div>
                    </div>
                </div>
                <hr class="my-10 border-gray-200">
                <div class="mb-8">
                    <h3 class="text-base font-black text-gray-800 mb-2">ìˆ˜ê¸° ì´ë©”ì¼ ë°œì†¡</h3>
                    <p class="text-[11px] text-gray-500 font-bold mb-4">ë°œì£¼ì–‘ì‹ê³¼ ë³„ê°œë¡œ ìˆ˜ì‹ Â·ì œëª©Â·ë³¸ë¬¸ì„ ì§ì ‘ ì…ë ¥í•˜ì—¬ ì´ë©”ì¼ì„ ë°œì†¡í•©ë‹ˆë‹¤.</p>
                    <div class="bg-white rounded-2xl border border-gray-200 p-6 max-w-xl">
                        <label class="block text-[11px] font-black text-gray-600 mb-1">ìˆ˜ì‹  ì´ë©”ì¼</label>
                        <input type="email" id="manual-email-to" placeholder="ë°›ëŠ” ì‚¬ëŒ ì´ë©”ì¼" class="w-full border border-gray-200 rounded-xl px-3 py-2 text-sm mb-3">
                        <label class="block text-[11px] font-black text-gray-600 mb-1">ì œëª©</label>
                        <input type="text" id="manual-email-subject" placeholder="ì œëª©" class="w-full border border-gray-200 rounded-xl px-3 py-2 text-sm mb-3">
                        <label class="block text-[11px] font-black text-gray-600 mb-1">ë³¸ë¬¸</label>
                        <textarea id="manual-email-body" rows="8" placeholder="ë³¸ë¬¸ ë‚´ìš©" class="w-full border border-gray-200 rounded-xl px-3 py-2 text-sm mb-4"></textarea>
                        <button type="button" id="manual-email-send" class="px-5 py-2.5 bg-amber-600 text-white rounded-xl font-black text-xs hover:bg-amber-700">ë°œì†¡</button>
                        <span id="manual-email-msg" class="ml-3 text-xs font-bold hidden"></span>
                    </div>
                </div>
            </div>
            <script>
            (function(){
                var orderDate = '{{ email_order_date.strftime("%Y-%m-%d") if email_order_date else "" }}';
                var previewData = null;
                document.querySelectorAll('.email-order-gen').forEach(function(btn){
                    btn.addEventListener('click', function(){
                        var catId = parseInt(btn.dataset.categoryId, 10);
                        var catName = btn.dataset.categoryName || '';
                        var row = btn.closest('.email-order-row');
                        var toInput = row ? row.querySelector('.email-order-to') : null;
                        var toEmail = (toInput && toInput.value) ? toInput.value.trim() : '';
                        if (!toEmail) { alert('ìˆ˜ì‹  ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
                        fetch('/admin/seller/order_preview?category_id=' + catId + '&order_date=' + (orderDate || new Date().toISOString().slice(0,10)))
                            .then(function(r){ return r.json(); })
                            .then(function(d){
                                if (!d.success) { alert(d.message || 'ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨'); return; }
                                previewData = { category_id: catId, order_date: orderDate || new Date().toISOString().slice(0,10), to_email: toEmail };
                                document.getElementById('preview-to-email').textContent = toEmail;
                                document.getElementById('preview-body').textContent = d.body || '';
                                document.getElementById('email-order-preview-modal').classList.remove('hidden');
                            }).catch(function(){ alert('ìš”ì²­ ì‹¤íŒ¨'); });
                    });
                });
                document.getElementById('email-order-preview-close').addEventListener('click', function(){
                    document.getElementById('email-order-preview-modal').classList.add('hidden');
                    previewData = null;
                });
                document.getElementById('email-order-send-confirm').addEventListener('click', function(){
                    if (!previewData || !confirm('í•´ë‹¹ ë‚´ìš©ìœ¼ë¡œ ë©”ì¼ì„ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                    fetch('/admin/seller/send_order_email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                        credentials: 'same-origin',
                        body: JSON.stringify({ category_id: previewData.category_id, order_date: previewData.order_date, to_email: previewData.to_email })
                    }).then(function(r){ return r.json(); }).then(function(d){
                        if (d.success) {
                            document.getElementById('email-order-preview-modal').classList.add('hidden');
                            var resultEl = document.getElementById('email-order-result');
                            resultEl.classList.remove('hidden');
                            document.getElementById('email-order-confirm-url').textContent = d.confirm_url || '';
                            document.getElementById('email-order-confirm-code').textContent = d.confirmation_code || '';
                            resultEl.scrollIntoView({ behavior: 'smooth' });
                        } else { alert(d.message || 'ë°œì†¡ ì‹¤íŒ¨'); }
                    }).catch(function(){ alert('ìš”ì²­ ì‹¤íŒ¨'); });
                });
                document.getElementById('manual-email-send').addEventListener('click', function(){
                    var to = (document.getElementById('manual-email-to').value || '').trim();
                    var subj = (document.getElementById('manual-email-subject').value || '').trim();
                    var body = (document.getElementById('manual-email-body').value || '').trim();
                    if (!to) { alert('ìˆ˜ì‹  ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
                    if (!subj) { alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
                    var msgEl = document.getElementById('manual-email-msg');
                    msgEl.classList.remove('hidden'); msgEl.textContent = 'ë°œì†¡ ì¤‘...'; msgEl.className = 'ml-3 text-xs font-bold text-gray-600';
                    fetch('/admin/seller/send_manual_email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                        credentials: 'same-origin',
                        body: JSON.stringify({ to_email: to, subject: subj, body: body })
                    }).then(function(r){ return r.json(); }).then(function(d){
                        if (d.success) { msgEl.textContent = 'ë°œì†¡ ì™„ë£Œ'; msgEl.className = 'ml-3 text-xs font-bold text-teal-600'; }
                        else { msgEl.textContent = d.message || 'ë°œì†¡ ì‹¤íŒ¨'; msgEl.className = 'ml-3 text-xs font-bold text-red-600'; }
                    }).catch(function(){ msgEl.textContent = 'ìš”ì²­ ì‹¤íŒ¨'; msgEl.className = 'ml-3 text-xs font-bold text-red-600'; });
                });
            })();
            </script>

        {% elif tab == 'backup' %}
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-2">ë°±ì—… Â· ë³µì›</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-6">SQLite DBë¥¼ zipìœ¼ë¡œ ë°±ì—…í•©ë‹ˆë‹¤. GITHUB_BACKUP_TOKENÂ·GITHUB_BACKUP_REPO ì„¤ì • ì‹œ GitHub Releaseë¡œ ì—…ë¡œë“œë˜ë©°, ë¯¸ì„¤ì • ì‹œ instance/backups ì— ì €ì¥ë©ë‹ˆë‹¤.</p>
                <div class="flex flex-wrap items-center gap-4 mb-6">
                    <button type="button" id="backup-run-btn" class="px-6 py-3 bg-teal-600 text-white rounded-xl font-black text-sm hover:bg-teal-700 transition">ìˆ˜ë™ ë°±ì—… ì‹¤í–‰</button>
                    <span id="backup-result" class="text-sm font-bold"></span>
                </div>
                <div class="bg-amber-50 border border-amber-200 rounded-2xl p-6 text-left">
                    <h4 class="font-black text-amber-800 mb-3">ë°±ì—…ëœ íŒŒì¼ ì ìš© ë°©ë²• (ë³µì›)</h4>
                    <ol class="text-xs text-gray-700 space-y-2 list-decimal list-inside font-medium">
                        <li><strong>GitHubì— ë°±ì—…í•œ ê²½ìš°</strong>: GitHub ì €ì¥ì†Œ â†’ Releases â†’ í•´ë‹¹ backup-ë‚ ì§œ ì‹œê° íƒœê·¸ ì„ íƒ â†’ ì²¨ë¶€ëœ backup_YYYYMMDD_HHMM.zip ë‹¤ìš´ë¡œë“œ.</li>
                        <li>ì•±/ì„œë²„ë¥¼ <strong>ì¤‘ì§€</strong>í•œ ë’¤, zip ì••ì¶•ì„ í’€ì–´ ë‚˜ì˜¨ <code class="bg-white px-1 rounded">main.db</code>, <code class="bg-white px-1 rounded">delivery.db</code> ë“±ìœ¼ë¡œ ê¸°ì¡´ DB íŒŒì¼ì„ <strong>ë®ì–´ì“°ê¸°</strong>í•©ë‹ˆë‹¤. (ê¸°ì¡´ DBëŠ” ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì˜®ê²¨ ë‘ê³  ë³µì›ìš© íŒŒì¼ë§Œ ì‚¬ìš©í•´ë„ ë©ë‹ˆë‹¤.)</li>
                        <li>ì•±ì„ ë‹¤ì‹œ <strong>ì‹œì‘</strong>í•©ë‹ˆë‹¤.</li>
                        <li>ë°°í¬ í™˜ê²½(Render ë“±)ì—ì„œëŠ” ì„œë²„ ë””ìŠ¤í¬ê°€ íœ˜ë°œì„±ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ë³µì›ì´ í•„ìš”í•  ë•Œ GitHub Releaseì—ì„œ zipì„ ë°›ì•„ ë¡œì»¬ì—ì„œ DBë¥¼ êµì²´í•œ ë’¤ ì¬ë°°í¬í•˜ê±°ë‚˜, ì¸ìŠ¤í„´ìŠ¤ ë””ìŠ¤í¬ì— DBë¥¼ ë³µì‚¬í•œ ë’¤ ì¬ì‹œì‘í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì ìš©í•˜ì„¸ìš”.</li>
                    </ol>
                </div>
                <p class="mt-4 text-[10px] text-gray-500">ë§¤ì¼ í•œêµ­ì‹œê°„ ìƒˆë²½ 4ì‹œ ìë™ ë°±ì—…: <code class="bg-gray-100 px-1 rounded">python app.py</code> ë¡œ ì‹¤í–‰ ì‹œ ìŠ¤ì¼€ì¤„ì´ ë™ì‘í•©ë‹ˆë‹¤. gunicorn ë°°í¬ ì‹œì—ëŠ” Cron ì„œë¹„ìŠ¤ì—ì„œ <code class="bg-gray-100 px-1 rounded">GET /admin/backup/cron?key=BACKUP_CRON_SECRET</code> ì„ ìƒˆë²½ 4ì‹œ(KST)ì— í˜¸ì¶œí•˜ë„ë¡ ì„¤ì •í•˜ë©´ ë©ë‹ˆë‹¤.</p>
            </div>
            <script>
            (function(){
                var btn = document.getElementById('backup-run-btn');
                var result = document.getElementById('backup-result');
                if (btn && result) {
                    btn.addEventListener('click', function(){
                        btn.disabled = true;
                        result.textContent = 'ë°±ì—… ì¤‘...';
                        fetch('/admin/backup/run', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' })
                            .then(function(r){ return r.json(); })
                            .then(function(d){
                                result.textContent = d.success ? ('âœ“ ' + (d.message || 'ì™„ë£Œ')) : ('âœ— ' + (d.message || 'ì‹¤íŒ¨'));
                                result.className = 'text-sm font-bold ' + (d.success ? 'text-teal-600' : 'text-red-600');
                                btn.disabled = false;
                            })
                            .catch(function(){ result.textContent = 'âœ— ìš”ì²­ ì‹¤íŒ¨'; result.className = 'text-sm font-bold text-red-600'; btn.disabled = false; });
                    });
                }
            })();
            </script>

        {% elif tab == 'member_grade' %}
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-2">íšŒì› ë“±ê¸‰ ê´€ë¦¬ (1Â·2Â·3ë‹¨ê³„)</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-4">ë“±ê¸‰ì€ í™”ë©´ì— ë…¸ì¶œí•˜ì§€ ì•Šìœ¼ë©°, ë“±ê¸‰ë³„ ì¹´í…Œê³ ë¦¬ ê³µê°œÂ·ë©”ì‹œì§€ ë°œì†¡ ë“±ì— ì‚¬ìš©í•©ë‹ˆë‹¤. ì§ì ‘ ì„¤ì •í•˜ê±°ë‚˜ êµ¬ë§¤ì´ë ¥ ê¸°ì¤€ìœ¼ë¡œ ìë™ ë°˜ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. êµ¬ë§¤ê¸ˆì•¡ì€ <strong>ë°°ì†¡ì™„ë£Œ</strong>ëœ í’ˆëª© ê¸ˆì•¡ë§Œ ì¸ì •ë©ë‹ˆë‹¤.</p>
                <div class="bg-amber-50 border border-amber-200 rounded-2xl p-6 mb-6">
                    <p class="font-black text-amber-800 text-xs mb-3">ìë™ ë“±ê¸‰ ê¸°ì¤€ (ëˆ„ì  ê²°ì œì•¡, ì›)</p>
                    <form id="mg_config_form" class="flex flex-wrap items-end gap-4">
                        <label class="flex flex-col gap-1"><span class="text-[10px] text-gray-600 font-bold">2ë‹¨ê³„ ìµœì†Œ</span><input type="number" name="min_amount_grade2" value="{{ member_grade_min2 }}" min="0" class="border border-gray-200 rounded-xl px-3 py-2 text-xs w-32"></label>
                        <label class="flex flex-col gap-1"><span class="text-[10px] text-gray-600 font-bold">3ë‹¨ê³„ ìµœì†Œ</span><input type="number" name="min_amount_grade3" value="{{ member_grade_min3 }}" min="0" class="border border-gray-200 rounded-xl px-3 py-2 text-xs w-32"></label>
                        <label class="flex flex-col gap-1"><span class="text-[10px] text-gray-600 font-bold">4ë‹¨ê³„ ìµœì†Œ</span><input type="number" name="min_amount_grade4" value="{{ member_grade_min4 }}" min="0" class="border border-gray-200 rounded-xl px-3 py-2 text-xs w-32"></label>
                        <label class="flex flex-col gap-1"><span class="text-[10px] text-gray-600 font-bold">5ë‹¨ê³„ ìµœì†Œ</span><input type="number" name="min_amount_grade5" value="{{ member_grade_min5 }}" min="0" class="border border-gray-200 rounded-xl px-3 py-2 text-xs w-32"></label>
                        <button type="submit" class="px-4 py-2 bg-amber-600 text-white rounded-xl font-black text-xs">ê¸°ì¤€ ì €ì¥</button>
                    </form>
                    <p class="text-[10px] text-amber-700 mt-2">ì €ì¥ í›„ ì•„ë˜ ã€Œêµ¬ë§¤ì´ë ¥ìœ¼ë¡œ ìë™ ë°˜ì˜ã€ ì‹œ ìœ„ ê¸°ì¤€ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤. ì§ì ‘ ì„¤ì •í•œ íšŒì›ì€ ìë™ ë°˜ì˜ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.</p>
                </div>
                <div class="flex gap-3 mb-4">
                    <button type="button" id="mg_auto_apply_btn" class="px-5 py-2.5 bg-teal-600 text-white rounded-xl font-black text-xs">êµ¬ë§¤ì´ë ¥ìœ¼ë¡œ ìë™ ë°˜ì˜</button>
                    <span id="mg_api_message" class="text-xs font-bold hidden"></span>
                </div>
                <div class="bg-white rounded-2xl border border-gray-200 overflow-x-auto">
                    <table class="w-full text-left min-w-[800px] text-[11px] font-bold border-collapse">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="p-3 border border-gray-600">ì´ë©”ì¼</th>
                                <th class="p-3 border border-gray-600">ì´ë¦„</th>
                                <th class="p-3 border border-gray-600 w-20 text-center">ë“±ê¸‰</th>
                                <th class="p-3 border border-gray-600 w-24 text-center">ì§ì ‘ì„¤ì •</th>
                                <th class="p-3 border border-gray-600 w-28 text-right">ëˆ„ì ê²°ì œ(ì›)</th>
                                <th class="p-3 border border-gray-600 w-20 text-center">ì£¼ë¬¸ìˆ˜</th>
                                <th class="p-3 border border-gray-600">ì„¤ì •</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for u in member_grade_users %}
                            <tr class="border-b border-gray-100">
                                <td class="p-3">{{ u.email }}</td>
                                <td class="p-3">{{ u.name }}</td>
                                <td class="p-3 text-center">{{ u.member_grade }}ë‹¨ê³„</td>
                                <td class="p-3 text-center">{% if u.member_grade_overridden %}Y{% else %}-{% endif %}</td>
                                <td class="p-3 text-right">{{ "{:,}".format(u.total_paid) }}</td>
                                <td class="p-3 text-center">{{ u.order_count }}</td>
                                <td class="p-3">
                                    <select class="mg_grade_select border border-gray-200 rounded-lg px-2 py-1 text-[10px]" data-user-id="{{ u.id }}">
                                        <option value="1" {% if u.member_grade == 1 %}selected{% endif %}>1ë‹¨ê³„</option>
                                        <option value="2" {% if u.member_grade == 2 %}selected{% endif %}>2ë‹¨ê³„</option>
                                        <option value="3" {% if u.member_grade == 3 %}selected{% endif %}>3ë‹¨ê³„</option>
                                        <option value="4" {% if u.member_grade == 4 %}selected{% endif %}>4ë‹¨ê³„</option>
                                        <option value="5" {% if u.member_grade == 5 %}selected{% endif %}>5ë‹¨ê³„</option>
                                    </select>
                                    <button type="button" class="mg_set_btn ml-1 px-2 py-1 bg-orange-100 text-orange-700 rounded-lg text-[10px] font-black" data-user-id="{{ u.id }}">ì§ì ‘ ì„¤ì •</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if not member_grade_users %}<p class="text-gray-400 text-sm mt-4">ë“±ë¡ëœ ì¼ë°˜ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>{% endif %}
            </div>
            <script>
            (function(){
                var msgEl = document.getElementById('mg_api_message');
                function showMsg(text, ok) { msgEl.textContent = text; msgEl.classList.remove('hidden'); msgEl.className = 'text-xs font-bold ' + (ok ? 'text-teal-600' : 'text-red-600'); }
                document.getElementById('mg_config_form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    var fd = new FormData(this);
                    fetch('/admin/member_grade/config', { method: 'POST', body: fd }).then(function(r) { return r.json(); }).then(function(d) {
                        showMsg(d.error || 'ê¸°ì¤€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', !d.error);
                        if (!d.error) setTimeout(function() { location.reload(); }, 600);
                    }).catch(function() { showMsg('í†µì‹  ì˜¤ë¥˜', false); });
                });
                document.getElementById('mg_auto_apply_btn').addEventListener('click', function() {
                    fetch('/admin/member_grade/auto_apply', { method: 'POST', headers: { 'Content-Type': 'application/json' } }).then(function(r) { return r.json(); }).then(function(d) {
                        showMsg(d.error || ('ìë™ ë°˜ì˜ ì™„ë£Œ. ' + (d.updated || 0) + 'ëª… ë°˜ì˜ë¨.'), !d.error);
                        if (!d.error) setTimeout(function() { location.reload(); }, 600);
                    }).catch(function() { showMsg('í†µì‹  ì˜¤ë¥˜', false); });
                });
                document.querySelectorAll('.mg_set_btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var uid = this.getAttribute('data-user-id');
                        var row = this.closest('tr');
                        var sel = row.querySelector('.mg_grade_select');
                        var grade = sel ? sel.value : 1;
                        fetch('/admin/member_grade/set', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ user_id: parseInt(uid, 10), grade: parseInt(grade, 10), overridden: true })
                        }).then(function(r) { return r.json(); }).then(function(d) {
                            showMsg(d.error || 'ì§ì ‘ ì„¤ì • ë°˜ì˜ë¨.', !d.error);
                            if (!d.error) setTimeout(function() { location.reload(); }, 600);
                        }).catch(function() { showMsg('í†µì‹  ì˜¤ë¥˜', false); });
                    });
                });
            })();
            </script>

        {% elif tab == 'messages' %}
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-2">ë©”ì‹œì§€ ë°œì†¡</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-4">íšŒì› ë“±ê¸‰ì„ ì„ íƒí•´ ê°€ì…ì¸ì‚¬Â·ì´ë²¤íŠ¸Â·ê³µì§€Â·ì•ˆë‚´ ë“±ì„ ì§ì ‘ ì‘ì„±í•´ ë°œì†¡í•©ë‹ˆë‹¤. ì•„ë˜ì—ì„œ ìë™ ë°œì†¡ ë¬¸êµ¬(í…œí”Œë¦¿)ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded-2xl border border-gray-200 p-8">
                        <p class="text-[10px] text-teal-600 font-black uppercase mb-3">ë“±ê¸‰ë³„ ì§ì ‘ ë°œì†¡</p>
                        <form id="admin_message_form" class="space-y-4">
                            <div class="flex flex-wrap gap-4 items-end">
                                <label class="flex flex-col gap-1">
                                    <span class="text-[10px] text-gray-600 font-bold">ëŒ€ìƒ ë“±ê¸‰</span>
                                    <select name="target_grade" class="border border-gray-200 rounded-xl px-4 py-2.5 text-xs font-black">
                                        <option value="all">ì „ì²´ íšŒì›</option>
                                        <option value="1">1ë‹¨ê³„</option>
                                        <option value="2">2ë‹¨ê³„</option>
                                        <option value="3">3ë‹¨ê³„</option>
                                        <option value="4">4ë‹¨ê³„</option>
                                        <option value="5">5ë‹¨ê³„</option>
                                    </select>
                                </label>
                                <label class="flex flex-col gap-1">
                                    <span class="text-[10px] text-gray-600 font-bold">ìœ í˜•</span>
                                    <select name="msg_type" class="border border-gray-200 rounded-xl px-4 py-2.5 text-xs font-black">
                                        <option value="welcome">ê°€ì…ì¸ì‚¬</option>
                                        <option value="event">ì´ë²¤íŠ¸</option>
                                        <option value="notice">ê³µì§€</option>
                                        <option value="guide">ì•ˆë‚´</option>
                                        <option value="custom">ì§ì ‘ì‘ì„±</option>
                                    </select>
                                </label>
                            </div>
                            <label class="block">
                                <span class="text-[10px] text-gray-600 font-bold">ì œëª©</span>
                                <input type="text" name="title" required placeholder="ë©”ì‹œì§€ ì œëª©" class="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm font-black mt-1">
                            </label>
                            <label class="block">
                                <span class="text-[10px] text-gray-600 font-bold">ë‚´ìš©</span>
                                <textarea name="body" rows="5" placeholder="ë©”ì‹œì§€ ë‚´ìš©" class="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm font-black mt-1"></textarea>
                            </label>
                            <button type="submit" class="bg-teal-600 text-white px-8 py-3 rounded-xl font-black text-sm hover:bg-teal-700 transition">ë°œì†¡í•˜ê¸°</button>
                        </form>
                        <p id="admin_message_result" class="mt-4 text-sm font-bold hidden"></p>
                    </div>
                    <div class="bg-amber-50/80 rounded-2xl border border-amber-200 p-8">
                        <p class="text-[10px] text-amber-700 font-black uppercase mb-3">ìë™ ë°œì†¡ í…œí”Œë¦¿ í¸ì§‘</p>
                        <p class="text-[11px] text-gray-600 mb-4">ì£¼ë¬¸/ë°°ì†¡ ì‹œ ìë™ ë°œì†¡ë˜ëŠ” ë¬¸êµ¬ì…ë‹ˆë‹¤. <code class="bg-white px-1 rounded text-[10px]">{order_id}</code>ëŠ” ì£¼ë¬¸ë²ˆí˜¸ë¡œ ì¹˜í™˜ë©ë‹ˆë‹¤.</p>
                        <form id="admin_template_form" class="space-y-4">
                            <label class="block">
                                <span class="text-[10px] text-gray-600 font-bold">ìœ í˜•</span>
                                <select name="msg_type" id="template_msg_type" class="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-xs font-black mt-1">
                                    <option value="welcome">ê°€ì…ì¸ì‚¬</option>
                                    <option value="order_created">ì£¼ë¬¸ì ‘ìˆ˜</option>
                                    <option value="order_cancelled">ì£¼ë¬¸ì·¨ì†Œ</option>
                                    <option value="part_cancelled">ì¼ë¶€ì·¨ì†Œ</option>
                                    <option value="out_of_stock">í’ˆì ˆì·¨ì†Œ</option>
                                    <option value="delivery_requested">ë°°ì†¡ìš”ì²­</option>
                                    <option value="delivery_in_progress">ë°°ì†¡ì¤‘</option>
                                    <option value="delivery_complete">ë°°ì†¡ì™„ë£Œ</option>
                                    <option value="delivery_delayed">ë°°ì†¡ì§€ì—°</option>
                                </select>
                            </label>
                            <label class="block">
                                <span class="text-[10px] text-gray-600 font-bold">ì œëª©</span>
                                <input type="text" name="title" id="template_title" class="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm font-black mt-1">
                            </label>
                            <label class="block">
                                <span class="text-[10px] text-gray-600 font-bold">ë‚´ìš©</span>
                                <textarea name="body" id="template_body" rows="4" class="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm font-black mt-1"></textarea>
                            </label>
                            <button type="submit" class="bg-amber-600 text-white px-6 py-2.5 rounded-xl font-black text-xs hover:bg-amber-700 transition">í…œí”Œë¦¿ ì €ì¥</button>
                        </form>
                        <p id="admin_template_result" class="mt-3 text-sm font-bold hidden"></p>
                    </div>
                </div>
                <div class="mt-8 p-6 bg-gray-50 rounded-2xl border border-gray-100 text-left text-[11px] text-gray-600">
                    <p class="font-black text-gray-800 mb-2">ìë™ ë°œì†¡ ì•ˆë‚´</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li>ê°€ì… ì‹œ: ê°€ì… í™˜ì˜ ë©”ì‹œì§€</li>
                        <li>ì£¼ë¬¸ ê²°ì œ ì™„ë£Œ ì‹œ: ì£¼ë¬¸ ì ‘ìˆ˜ ì•ˆë‚´</li>
                        <li>ë°°ì†¡ ìš”ì²­/ë°°ì†¡ì¤‘/ë°°ì†¡ì™„ë£Œ/ë°°ì†¡ì§€ì—° ì‹œ: ë°°ì†¡ ìƒíƒœ ì•Œë¦¼</li>
                        <li>ì£¼ë¬¸Â·í’ˆëª© ì·¨ì†ŒÂ·í’ˆì ˆì·¨ì†Œ ì‹œ: ì·¨ì†ŒÂ·í™˜ë¶ˆ ì•ˆë‚´</li>
                    </ul>
                </div>
                <div class="mt-8 bg-white rounded-2xl border border-gray-200 overflow-hidden">
                    <p class="p-4 font-black text-gray-800 border-b border-gray-100">ë°œì†¡ ì´ë ¥ (ìµœê·¼ 150ê±´)</p>
                    <div class="overflow-x-auto max-h-[400px] overflow-y-auto">
                        <table class="w-full text-left text-[11px] border-collapse">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="p-3 border-b border-gray-200 w-36">ë°œì†¡ì¼ì‹œ</th>
                                    <th class="p-3 border-b border-gray-200">ìˆ˜ì‹ ì</th>
                                    <th class="p-3 border-b border-gray-200 w-24">ìœ í˜•</th>
                                    <th class="p-3 border-b border-gray-200">ì œëª©</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in messages_history %}
                                <tr class="border-b border-gray-50 hover:bg-gray-50/50">
                                    <td class="p-3 text-gray-600">{{ row.msg.created_at.strftime('%Y-%m-%d %H:%M') if row.msg.created_at else '-' }}</td>
                                    <td class="p-3">{{ row.user_email }} ({{ row.user_name }})</td>
                                    <td class="p-3">{{ row.msg.msg_type or 'custom' }}</td>
                                    <td class="p-3 font-bold">{{ (row.msg.title or '')[:50] }}{% if (row.msg.title or '')|length > 50 %}...{% endif %}</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="4" class="p-6 text-center text-gray-400">ë°œì†¡ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <script>
            (function(){
                var templateData = {{ message_templates | tojson | safe }};
                var form = document.getElementById('admin_message_form');
                var resultEl = document.getElementById('admin_message_result');
                if (form) form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    var fd = new FormData(form);
                    var obj = { target_grade: fd.get('target_grade') || 'all', msg_type: fd.get('msg_type') || 'custom', title: fd.get('title') || '', body: fd.get('body') || '' };
                    resultEl.classList.add('hidden');
                    fetch('/admin/messages/send', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(obj), credentials: 'same-origin' })
                        .then(function(r) { return r.json(); })
                        .then(function(d) {
                            resultEl.textContent = d.success ? (d.message || d.count + 'ëª… ë°œì†¡ë¨') : (d.message || 'ë°œì†¡ ì‹¤íŒ¨');
                            resultEl.className = 'mt-4 text-sm font-bold ' + (d.success ? 'text-teal-600' : 'text-red-600');
                            resultEl.classList.remove('hidden');
                            if (d.success) { form.querySelector('[name="title"]').value = ''; form.querySelector('[name="body"]').value = ''; }
                        })
                        .catch(function() { resultEl.textContent = 'í†µì‹  ì˜¤ë¥˜'; resultEl.className = 'mt-4 text-sm font-bold text-red-600'; resultEl.classList.remove('hidden'); });
                });
                var tForm = document.getElementById('admin_template_form');
                var tResult = document.getElementById('admin_template_result');
                var sel = document.getElementById('template_msg_type');
                var tTitle = document.getElementById('template_title');
                var tBody = document.getElementById('template_body');
                function fillTemplate() {
                    var val = sel ? sel.value : '';
                    var t = templateData && templateData.find(function(x) { return x.msg_type === val; });
                    if (t) { if (tTitle) tTitle.value = t.title || ''; if (tBody) tBody.value = t.body || ''; }
                }
                if (sel) sel.addEventListener('change', fillTemplate);
                if (templateData && templateData.length && sel) { fillTemplate(); }
                if (tForm) tForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    var fd = new FormData(tForm);
                    tResult.classList.add('hidden');
                    fetch('/admin/messages/template', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ msg_type: fd.get('msg_type'), title: fd.get('title'), body: fd.get('body') }), credentials: 'same-origin' })
                        .then(function(r) { return r.json(); })
                        .then(function(d) {
                            tResult.textContent = d.success ? 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : (d.message || 'ì €ì¥ ì‹¤íŒ¨');
                            tResult.className = 'mt-3 text-sm font-bold ' + (d.success ? 'text-teal-600' : 'text-red-600');
                            tResult.classList.remove('hidden');
                            if (d.success) { var t = templateData && templateData.find(function(x) { return x.msg_type === fd.get('msg_type'); }); if (t) { t.title = fd.get('title'); t.body = fd.get('body'); } }
                        })
                        .catch(function() { tResult.textContent = 'í†µì‹  ì˜¤ë¥˜'; tResult.className = 'mt-3 text-sm font-bold text-red-600'; tResult.classList.remove('hidden'); });
                });
            })();
            </script>

        {% elif tab == 'popup' %}
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-2">ì•Œë¦¼ íŒì—… ê´€ë¦¬</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-4">ì ‘ì† ì‹œ ë…¸ì¶œí•  ê³µì§€Â·ì´ë²¤íŠ¸Â·ì•Œë¦¼ íŒì—…. í‘œì‹œ ê¸°ê°„(ì‹œì‘/ì¢…ë£Œ)ê³¼ ì´ë¯¸ì§€Â·ë‚ ì§œ ë¬¸êµ¬ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded-2xl border border-gray-200 p-8">
                        <p class="text-[10px] text-teal-600 font-black uppercase mb-4">íŒì—… ë“±ë¡/ìˆ˜ì •</p>
                        <form id="popup_form" class="space-y-4 text-left">
                            <input type="hidden" name="id" id="popup_id" value="">
                            <label class="block">
                                <span class="text-[10px] text-gray-600 font-bold">ìœ í˜•</span>
                                <select name="popup_type" id="popup_type" class="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm font-black mt-1">
                                    <option value="notice">ê³µì§€</option>
                                    <option value="event">ì´ë²¤íŠ¸</option>
                                    <option value="alert">ì•Œë¦¼</option>
                                </select>
                            </label>
                            <label class="block">
                                <span class="text-[10px] text-gray-600 font-bold">ì œëª©</span>
                                <input type="text" name="title" id="popup_title" required class="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm font-black mt-1" placeholder="íŒì—… ì œëª©">
                            </label>
                            <label class="block">
                                <span class="text-[10px] text-gray-600 font-bold">ë‚´ìš©</span>
                                <textarea name="body" id="popup_body" rows="4" class="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm font-black mt-1" placeholder="ë³¸ë¬¸ (ì¤„ë°”ê¿ˆ ê°€ëŠ¥)"></textarea>
                            </label>
                            <label class="block">
                                <span class="text-[10px] text-gray-600 font-bold">ë…¸ì¶œìš© ë‚ ì§œ/ê¸°ê°„ ë¬¸êµ¬</span>
                                <input type="text" name="display_date" id="popup_display_date" class="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm font-black mt-1" placeholder="ì˜ˆ: 2025.02.22 ~ 02.28">
                            </label>
                            <label class="block">
                                <span class="text-[10px] text-gray-600 font-bold">ì´ë¯¸ì§€</span>
                                <div class="flex gap-2 mt-1">
                                    <input type="text" name="image_url" id="popup_image_url" class="flex-1 border border-gray-200 rounded-xl px-4 py-2.5 text-sm font-black" placeholder="/static/uploads/ì´ë¯¸ì§€.jpg ë˜ëŠ” URL">
                                    <input type="file" id="popup_image_file" accept="image/*" class="hidden">
                                    <button type="button" id="popup_image_upload_btn" class="px-4 py-2.5 bg-gray-200 text-gray-700 rounded-xl font-black text-xs whitespace-nowrap">ì—…ë¡œë“œ</button>
                                </div>
                            </label>
                            <div class="grid grid-cols-2 gap-4">
                                <label class="block">
                                    <span class="text-[10px] text-gray-600 font-bold">ë…¸ì¶œ ì‹œì‘ì¼ì‹œ</span>
                                    <input type="datetime-local" name="start_at" id="popup_start_at" class="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm font-black mt-1">
                                </label>
                                <label class="block">
                                    <span class="text-[10px] text-gray-600 font-bold">ë…¸ì¶œ ì¢…ë£Œì¼ì‹œ</span>
                                    <input type="datetime-local" name="end_at" id="popup_end_at" class="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm font-black mt-1">
                                </label>
                            </div>
                            <div class="flex flex-wrap items-center gap-4">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" name="is_active" id="popup_is_active" checked class="rounded">
                                    <span class="text-xs font-bold">í™œì„±</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <span class="text-[10px] text-gray-600 font-bold">ìˆœì„œ</span>
                                    <input type="number" name="sort_order" id="popup_sort_order" value="0" class="border border-gray-200 rounded-lg px-2 py-1 w-16 text-xs">
                                </label>
                            </div>
                            <div class="flex gap-3">
                                <button type="submit" class="px-6 py-2.5 bg-teal-600 text-white rounded-xl font-black text-xs">ì €ì¥</button>
                                <button type="button" id="popup_form_reset" class="px-6 py-2.5 bg-gray-200 text-gray-700 rounded-xl font-black text-xs">ì´ˆê¸°í™”</button>
                            </div>
                        </form>
                        <p id="popup_form_result" class="mt-3 text-sm font-bold hidden"></p>
                    </div>
                    <div class="bg-gray-50 rounded-2xl border border-gray-200 p-6">
                        <p class="text-[10px] text-gray-600 font-black uppercase mb-4">ë“±ë¡ëœ íŒì—… ëª©ë¡</p>
                        <div class="space-y-3 max-h-[500px] overflow-y-auto">
                            {% for p in popup_list %}
                            <div class="bg-white rounded-xl border border-gray-100 p-4 flex justify-between items-start gap-3">
                                <div class="min-w-0 flex-1">
                                    <span class="text-[10px] px-2 py-0.5 rounded {{ 'bg-amber-100 text-amber-800' if p.popup_type == 'event' else ('bg-blue-100 text-blue-800' if p.popup_type == 'alert' else 'bg-gray-100 text-gray-700') }}">{{ 'ì´ë²¤íŠ¸' if p.popup_type == 'event' else ('ì•Œë¦¼' if p.popup_type == 'alert' else 'ê³µì§€') }}</span>
                                    <p class="font-black text-gray-800 mt-1 truncate">{{ p.title or '-' }}</p>
                                    <p class="text-[10px] text-gray-500">{% if p.start_at %}{{ p.start_at.strftime('%Y-%m-%d %H:%M') }}{% else %}ì‹œì‘ ë¯¸ì„¤ì •{% endif %} ~ {% if p.end_at %}{{ p.end_at.strftime('%Y-%m-%d %H:%M') }}{% else %}ì¢…ë£Œ ë¯¸ì„¤ì •{% endif %}</p>
                                </div>
                                <div class="flex gap-2 flex-shrink-0">
                                    <button type="button" class="popup-edit-btn px-3 py-1.5 bg-teal-100 text-teal-700 rounded-lg text-[10px] font-black" data-id="{{ p.id }}" data-title="{{ (p.title or '')|e }}" data-body="{{ (p.body or '')|e }}" data-type="{{ p.popup_type or 'notice' }}" data-display-date="{{ (p.display_date or '')|e }}" data-image-url="{{ (p.image_url or '')|e }}" data-start="{{ p.start_at.strftime('%Y-%m-%dT%H:%M') if p.start_at else '' }}" data-end="{{ p.end_at.strftime('%Y-%m-%dT%H:%M') if p.end_at else '' }}" data-active="{{ '1' if p.is_active else '0' }}" data-sort="{{ p.sort_order or 0 }}">ìˆ˜ì •</button>
                                    <button type="button" class="popup-del-btn px-3 py-1.5 bg-red-100 text-red-600 rounded-lg text-[10px] font-black" data-id="{{ p.id }}">ì‚­ì œ</button>
                                </div>
                            </div>
                            {% else %}
                            <p class="text-gray-400 text-sm">ë“±ë¡ëœ íŒì—…ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <script>
            (function(){
                var form = document.getElementById('popup_form');
                var resultEl = document.getElementById('popup_form_result');
                function toIsoLocal(d) { if (!d) return ''; var dt = new Date(d); var y=dt.getFullYear(), m=(''+(dt.getMonth()+1)).padStart(2,'0'), day=(''+dt.getDate()).padStart(2,'0'), h=(''+dt.getHours()).padStart(2,'0'), min=(''+dt.getMinutes()).padStart(2,'0'); return y+'-'+m+'-'+day+'T'+h+':'+min; }
                form.addEventListener('submit', function(e){
                    e.preventDefault();
                    var payload = { title: document.getElementById('popup_title').value, body: document.getElementById('popup_body').value, popup_type: document.getElementById('popup_type').value, display_date: document.getElementById('popup_display_date').value || null, image_url: document.getElementById('popup_image_url').value || null, start_at: document.getElementById('popup_start_at').value || null, end_at: document.getElementById('popup_end_at').value || null, is_active: document.getElementById('popup_is_active').checked, sort_order: parseInt(document.getElementById('popup_sort_order').value,10) || 0 };
                    var id = document.getElementById('popup_id').value; if (id) payload.id = parseInt(id,10);
                    resultEl.classList.add('hidden');
                    fetch('/admin/popup/save', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), credentials: 'same-origin' })
                        .then(function(r){ return r.json(); })
                        .then(function(d){ resultEl.textContent = d.success ? 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : (d.message || 'ì‹¤íŒ¨'); resultEl.className = 'mt-3 text-sm font-bold ' + (d.success ? 'text-teal-600' : 'text-red-600'); resultEl.classList.remove('hidden'); if (d.success) { document.getElementById('popup_form_reset').click(); location.reload(); } })
                        .catch(function(){ resultEl.textContent = 'í†µì‹  ì˜¤ë¥˜'; resultEl.className = 'mt-3 text-sm font-bold text-red-600'; resultEl.classList.remove('hidden'); });
                });
                document.getElementById('popup_form_reset').addEventListener('click', function(){ document.getElementById('popup_id').value = ''; document.getElementById('popup_title').value = ''; document.getElementById('popup_body').value = ''; document.getElementById('popup_type').value = 'notice'; document.getElementById('popup_display_date').value = ''; document.getElementById('popup_image_url').value = ''; document.getElementById('popup_start_at').value = ''; document.getElementById('popup_end_at').value = ''; document.getElementById('popup_is_active').checked = true; document.getElementById('popup_sort_order').value = '0'; });
                document.getElementById('popup_image_upload_btn').addEventListener('click', function(){ document.getElementById('popup_image_file').click(); });
                document.getElementById('popup_image_file').addEventListener('change', function(){
                    var fd = new FormData(); fd.append('image', this.files[0]);
                    fetch('/admin/popup/upload', { method: 'POST', body: fd, credentials: 'same-origin' }).then(function(r){ return r.json(); }).then(function(d){ if (d.success && d.url) document.getElementById('popup_image_url').value = d.url; else if (d.message) alert(d.message); }); this.value = '';
                });
                document.querySelectorAll('.popup-edit-btn').forEach(function(btn){
                    btn.addEventListener('click', function(){ var d=btn.dataset; document.getElementById('popup_id').value = d.id; document.getElementById('popup_title').value = d.title || ''; document.getElementById('popup_body').value = d.body || ''; document.getElementById('popup_type').value = d.type || 'notice'; document.getElementById('popup_display_date').value = d.displayDate || ''; document.getElementById('popup_image_url').value = d.imageUrl || ''; document.getElementById('popup_start_at').value = d.start || ''; document.getElementById('popup_end_at').value = d.end || ''; document.getElementById('popup_is_active').checked = d.active === '1'; document.getElementById('popup_sort_order').value = d.sort || '0'; });
                });
                document.querySelectorAll('.popup-del-btn').forEach(function(btn){
                    btn.addEventListener('click', function(){ if (!confirm('ì´ íŒì—…ì„ ì‚­ì œí• ê¹Œìš”?')) return; fetch('/admin/popup/delete/' + btn.dataset.id, { method: 'POST', credentials: 'same-origin' }).then(function(){ location.reload(); }); });
                });
            })();
            </script>

        {% elif tab == 'point_manage' %}
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-2">í¬ì¸íŠ¸ ì •ì±… ë° íšŒì›ë³„ ê´€ë¦¬</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-4">êµ¬ë§¤ê¸ˆì•¡ì˜ 0.1% ìë™ ì ë¦½, ì„¤ì •í•œ ê¸ˆì•¡ ì´ìƒ êµ¬ë§¤ ì‹œ ì„¤ì •í•œ í•œë„ê¹Œì§€ ì‚¬ìš© ê°€ëŠ¥.</p>
                <div class="bg-amber-50 border border-amber-200 rounded-2xl p-6 mb-6">
                    <p class="font-black text-amber-800 text-xs mb-3">í¬ì¸íŠ¸ ì •ì±… ì„¤ì •</p>
                    <form id="point_config_form" class="flex flex-wrap items-end gap-4">
                        <label class="flex flex-col gap-1"><span class="text-[10px] text-gray-600 font-bold">ì ë¦½ë¥  (1=0.1%)</span><input type="number" name="accumulation_rate" value="{{ point_accumulation_rate }}" min="0" max="100" class="border border-gray-200 rounded-xl px-3 py-2 text-xs w-24"></label>
                        <label class="flex flex-col gap-1"><span class="text-[10px] text-gray-600 font-bold">ì‚¬ìš© ê°€ëŠ¥ ìµœì†Œ ì£¼ë¬¸ê¸ˆì•¡(ì›)</span><input type="number" name="min_order_to_use" value="{{ point_min_order }}" min="0" class="border border-gray-200 rounded-xl px-3 py-2 text-xs w-36"></label>
                        <label class="flex flex-col gap-1"><span class="text-[10px] text-gray-600 font-bold">1íšŒ ìµœëŒ€ ì‚¬ìš©(ì›)</span><input type="number" name="max_points_per_order" value="{{ point_max_use }}" min="0" class="border border-gray-200 rounded-xl px-3 py-2 text-xs w-32"></label>
                        <button type="submit" class="px-4 py-2 bg-amber-600 text-white rounded-xl font-black text-xs">ì €ì¥</button>
                    </form>
                    <p class="text-[10px] text-amber-700 mt-2">ì ë¦½ë¥  1 = êµ¬ë§¤ê¸ˆì•¡ì˜ 0.1% ìë™ ì ë¦½. ì‚¬ìš© ê°€ëŠ¥ ìµœì†Œ ì£¼ë¬¸ê¸ˆì•¡(ì›) ì´ìƒ êµ¬ë§¤ ì‹œ, 1íšŒ ìµœëŒ€ ì‚¬ìš©(ì›)ê¹Œì§€ ê²°ì œ ì‹œ ì‚¬ìš© ê°€ëŠ¥.</p>
                </div>
                <div id="point_log_modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 p-4">
                    <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[85vh] overflow-hidden flex flex-col">
                        <div class="p-4 border-b border-gray-100 font-black text-gray-800" id="point_log_modal_title">í¬ì¸íŠ¸ ì ë¦½/ì‚¬ìš© ë‚´ì—­</div>
                        <div class="p-4 overflow-y-auto flex-1 text-[11px]" id="point_log_modal_body"></div>
                        <div class="p-4 border-t border-gray-100"><button type="button" id="point_log_modal_close" class="w-full py-2 bg-gray-200 rounded-xl font-black text-sm">ë‹«ê¸°</button></div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl border border-gray-200 overflow-x-auto">
                    <table class="w-full text-left min-w-[700px] text-[11px] font-bold border-collapse">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="p-3 border border-gray-600">ì´ë©”ì¼</th>
                                <th class="p-3 border border-gray-600">ì´ë¦„</th>
                                <th class="p-3 border border-gray-600 w-28 text-right">ë³´ìœ  í¬ì¸íŠ¸</th>
                                <th class="p-3 border border-gray-600">ì§€ê¸‰/ì°¨ê° Â· Log</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for u in point_users %}
                            <tr class="border-b border-gray-100">
                                <td class="p-3">{{ u.email }}</td>
                                <td class="p-3">{{ u.name }}</td>
                                <td class="p-3 text-right">{{ "{:,}".format(u.points) }}ì›</td>
                                <td class="p-3">
                                    <input type="number" class="point_adj_amount border border-gray-200 rounded-lg px-2 py-1 text-[10px] w-20" placeholder="ê¸ˆì•¡" data-user-id="{{ u.id }}">
                                    <select class="point_adj_type border border-gray-200 rounded-lg px-2 py-1 text-[10px] ml-1"><option value="1">ì§€ê¸‰</option><option value="-1">ì°¨ê°</option></select>
                                    <input type="text" class="point_adj_memo border border-gray-200 rounded-lg px-2 py-1 text-[10px] w-24 ml-1" placeholder="ì‚¬ìœ " maxlength="50">
                                    <button type="button" class="point_adj_btn ml-1 px-2 py-1 bg-teal-100 text-teal-700 rounded-lg text-[10px] font-black" data-user-id="{{ u.id }}">ì ìš©</button>
                                    <button type="button" class="point_log_btn ml-1 px-2 py-1 bg-gray-200 text-gray-700 rounded-lg text-[10px] font-black" data-user-id="{{ u.id }}" data-user-name="{{ u.name or u.email }}">Log</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if not point_users %}<p class="text-gray-400 text-sm mt-4">íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>{% endif %}
            </div>
            <script>
            (function(){
                var msgEl = document.getElementById('pt_api_message');
                function showMsg(text, ok) {
                    var el = document.getElementById('pt_api_message');
                    if (!el) return;
                    el.textContent = text; el.classList.remove('hidden');
                    el.className = 'text-xs font-bold ' + (ok ? 'text-teal-600' : 'text-red-600');
                }
                document.getElementById('point_config_form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    var fd = new FormData(this);
                    fetch('/admin/point/config', { method: 'POST', body: fd }).then(function(r) { return r.json(); }).then(function(d) {
                        showMsg(d.error || 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', !d.error);
                        if (!d.error) setTimeout(function() { location.reload(); }, 600);
                    }).catch(function() { showMsg('í†µì‹  ì˜¤ë¥˜', false); });
                });
                document.querySelectorAll('.point_adj_btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var uid = parseInt(this.getAttribute('data-user-id'), 10);
                        var row = this.closest('tr');
                        var amtInput = row.querySelector('.point_adj_amount');
                        var typeSel = row.querySelector('.point_adj_type');
                        var memoInput = row.querySelector('.point_adj_memo');
                        var amt = parseInt(amtInput && amtInput.value, 10) || 0;
                        if (amt <= 0) { alert('ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
                        var mult = typeSel && typeSel.value === '-1' ? -1 : 1;
                        var body = JSON.stringify({ user_id: uid, amount: amt * mult, memo: memoInput ? memoInput.value : '' });
                        fetch('/admin/point/adjust', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: body }).then(function(r) { return r.json(); }).then(function(d) {
                            showMsg(d.error || 'ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.', !d.error);
                            if (!d.error) setTimeout(function() { location.reload(); }, 600);
                        }).catch(function() { showMsg('í†µì‹  ì˜¤ë¥˜', false); });
                    });
                });
                var modal = document.getElementById('point_log_modal');
                var modalTitle = document.getElementById('point_log_modal_title');
                var modalBody = document.getElementById('point_log_modal_body');
                document.getElementById('point_log_modal_close').addEventListener('click', function() { modal.classList.add('hidden'); modal.classList.remove('flex'); });
                modal.addEventListener('click', function(e) { if (e.target === modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); } });
                document.querySelectorAll('.point_log_btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var uid = this.getAttribute('data-user-id');
                        var name = this.getAttribute('data-user-name') || '';
                        modalTitle.textContent = 'í¬ì¸íŠ¸ ë‚´ì—­ Â· ' + name;
                        modalBody.innerHTML = '<p class="text-gray-400">ë¡œë”© ì¤‘...</p>';
                        modal.classList.remove('hidden'); modal.classList.add('flex');
                        fetch('/admin/point/log?user_id=' + uid + '&limit=100').then(function(r) { return r.json(); }).then(function(d) {
                            if (d.error) { modalBody.innerHTML = '<p class="text-red-600">' + d.error + '</p>'; return; }
                            var logs = d.logs || [];
                            if (logs.length === 0) { modalBody.innerHTML = '<p class="text-gray-400">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
                            var byDate = {};
                            logs.forEach(function(l) {
                                var dk = l.date || '';
                                if (!byDate[dk]) byDate[dk] = { earn: [], use: [] };
                                if (l.amount >= 0) byDate[dk].earn.push(l); else byDate[dk].use.push(l);
                            });
                            var dates = Object.keys(byDate).sort().reverse();
                            var html = '';
                            dates.forEach(function(date) {
                                html += '<div class="mb-6"><p class="text-gray-500 font-black text-[10px] uppercase tracking-wider mb-2 border-b border-gray-100 pb-1">' + date + '</p>';
                                var earn = byDate[date].earn;
                                var use = byDate[date].use;
                                if (earn.length) {
                                    html += '<p class="text-teal-600 font-bold text-[10px] mb-1">ì ë¦½ ë‚´ì—­</p><table class="w-full text-left mb-3"><thead><tr class="border-b border-gray-200 text-gray-500"><th class="py-1 pr-2">ì¼ì‹œ</th><th class="py-1 pr-2 text-right">ê¸ˆì•¡</th><th class="py-1 pr-2">ë©”ëª¨</th><th class="py-1">ìˆ˜ì •ì</th></tr></thead><tbody>';
                                    earn.forEach(function(l) {
                                        html += '<tr class="border-b border-gray-50"><td class="py-1 pr-2 text-gray-500">' + (l.created_at || '') + '</td><td class="py-1 pr-2 text-right text-teal-600">+' + l.amount + 'ì›</td><td class="py-1 pr-2">' + (l.memo || '-') + '</td><td class="py-1 text-gray-500">' + (l.modifier || 'ì‹œìŠ¤í…œ') + '</td></tr>';
                                    });
                                    html += '</tbody></table>';
                                }
                                if (use.length) {
                                    html += '<p class="text-red-600 font-bold text-[10px] mb-1">ì‚¬ìš© ë‚´ì—­</p><table class="w-full text-left"><thead><tr class="border-b border-gray-200 text-gray-500"><th class="py-1 pr-2">ì¼ì‹œ</th><th class="py-1 pr-2 text-right">ê¸ˆì•¡</th><th class="py-1 pr-2">ë©”ëª¨</th><th class="py-1">ìˆ˜ì •ì</th></tr></thead><tbody>';
                                    use.forEach(function(l) {
                                        html += '<tr class="border-b border-gray-50"><td class="py-1 pr-2 text-gray-500">' + (l.created_at || '') + '</td><td class="py-1 pr-2 text-right text-red-600">' + l.amount + 'ì›</td><td class="py-1 pr-2">' + (l.memo || '-') + '</td><td class="py-1 text-gray-500">' + (l.modifier || 'ì‹œìŠ¤í…œ') + '</td></tr>';
                                    });
                                    html += '</tbody></table>';
                                }
                                html += '</div>';
                            });
                            modalBody.innerHTML = html;
                        }).catch(function() { modalBody.innerHTML = '<p class="text-red-600">í†µì‹  ì˜¤ë¥˜</p>'; });
                    });
                });
            })();
            </script>
            <p id="pt_api_message" class="hidden mt-2 text-xs font-bold"></p>

        {% elif tab == 'marketing_cost' %}
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-2">ë§ˆì¼€íŒ…ë¹„ ì‚¬ìš©ë‚´ì—­</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-4">ê³ ê° í¬ì¸íŠ¸ ì‚¬ìš©ë¶„ì€ íŒë§¤ì í’ˆëª©/ì •ì‚°ì—ì„œ ì°¨ê°ë˜ì§€ ì•Šê³  ë§ˆì¼€íŒ…ë¹„ë¡œë§Œ ì²˜ë¦¬ë©ë‹ˆë‹¤. ì•„ë˜ëŠ” í¬ì¸íŠ¸ ì‚¬ìš©ì— ë”°ë¥¸ ë§ˆì¼€íŒ…ë¹„ ì§€ì¶œ ë‚´ì—­ì…ë‹ˆë‹¤.</p>
                <div class="bg-amber-50 border border-amber-200 rounded-2xl p-4 mb-6">
                    <p class="text-amber-800 font-black text-sm">ì „ì²´ ë§ˆì¼€íŒ…ë¹„ í•©ê³„ (í¬ì¸íŠ¸ ì‚¬ìš©ë¶„): <span class="text-lg">{{ "{:,}".format(marketing_cost_total) }}</span>ì›</p>
                </div>
                <div class="bg-white rounded-2xl border border-gray-200 overflow-x-auto">
                    <table class="w-full text-left min-w-[700px] text-[11px] font-bold border-collapse">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="p-3 border border-gray-600 w-36">ì¼ì‹œ</th>
                                <th class="p-3 border border-gray-600 w-20">ì£¼ë¬¸ID</th>
                                <th class="p-3 border border-gray-600">ê³ ê°(ì´ë©”ì¼/ì´ë¦„)</th>
                                <th class="p-3 border border-gray-600 w-28 text-right">ê¸ˆì•¡(ì›)</th>
                                <th class="p-3 border border-gray-600">ë¹„ê³ </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mc in marketing_cost_list %}
                            <tr class="border-b border-gray-100">
                                <td class="p-3">{{ mc.created_at.strftime('%Y-%m-%d %H:%M') if mc.created_at else '-' }}</td>
                                <td class="p-3"><a href="/admin/order/{{ mc.order_id }}" class="text-teal-600 hover:underline font-black">{{ mc.order_id }}</a></td>
                                <td class="p-3">{{ mc.user_email }} {% if mc.user_name %}({{ mc.user_name }}){% endif %}</td>
                                <td class="p-3 text-right">{{ "{:,}".format(mc.amount) }}</td>
                                <td class="p-3 text-gray-600">{{ mc.memo or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if not marketing_cost_list %}<p class="text-gray-400 text-sm mt-4">ë§ˆì¼€íŒ…ë¹„ ì‚¬ìš© ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>{% endif %}
                <p class="text-[10px] text-gray-500 mt-2">ìµœê·¼ 500ê±´ë§Œ í‘œì‹œë©ë‹ˆë‹¤. ì „ì²´ í•©ê³„ëŠ” ìƒë‹¨ ê¸ˆì•¡ì„ ì°¸ê³ í•˜ì„¸ìš”.</p>
            </div>

        {% elif tab == 'members' %}
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-2">íšŒì›ê´€ë¦¬</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-4">ê°€ì… íšŒì› ì •ë³´ ì „ì²´ ì¶œë ¥ (ë¹„ë°€ë²ˆí˜¸ëŠ” ë³´ì•ˆìƒ ë¹„í‘œì‹œ)</p>
                <div class="bg-white rounded-2xl border border-gray-200 overflow-x-auto">
                    <table class="w-full text-left min-w-[900px] text-[11px] font-bold border-collapse">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="p-3 border border-gray-600 w-12 text-center">ID</th>
                                <th class="p-3 border border-gray-600">ì´ë©”ì¼</th>
                                <th class="p-3 border border-gray-600 w-24">ì´ë¦„</th>
                                <th class="p-3 border border-gray-600 w-28">ì „í™”</th>
                                <th class="p-3 border border-gray-600">ì£¼ì†Œ</th>
                                <th class="p-3 border border-gray-600">ìƒì„¸ì£¼ì†Œ</th>
                                <th class="p-3 border border-gray-600 w-20">í˜„ê´€ë¹„ë°€ë²ˆí˜¸</th>
                                <th class="p-3 border border-gray-600">ìš”ì²­ë©”ëª¨</th>
                                <th class="p-3 border border-gray-600 w-16 text-center">ê´€ë¦¬ì</th>
                                <th class="p-3 border border-gray-600 w-16 text-center">ë§ˆì¼€íŒ…</th>
                                <th class="p-3 border border-gray-600 w-14 text-center">ë“±ê¸‰</th>
                                <th class="p-3 border border-gray-600 w-14 text-center">ì§ì ‘ì„¤ì •</th>
                                <th class="p-3 border border-gray-600 w-20 text-right">í¬ì¸íŠ¸</th>
                                <th class="p-3 border border-gray-600 w-32 text-center">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for u in admin_members %}
                            <tr class="border-b border-gray-100 hover:bg-gray-50/50" data-member-id="{{ u.id }}" data-member-name="{{ (u.name or u.email or '')|e }}">
                                <td class="p-3 border border-gray-100 text-center text-gray-500">{{ u.id }}</td>
                                <td class="p-3 border border-gray-100">{{ u.email or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ u.name or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ u.phone or '-' }}</td>
                                <td class="p-3 border border-gray-100 max-w-[180px] truncate" title="{{ u.address or '' }}">{{ u.address or '-' }}</td>
                                <td class="p-3 border border-gray-100 max-w-[120px] truncate" title="{{ u.address_detail or '' }}">{{ u.address_detail or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ u.entrance_pw or '-' }}</td>
                                <td class="p-3 border border-gray-100 max-w-[140px] truncate" title="{{ u.request_memo or '' }}">{{ u.request_memo or '-' }}</td>
                                <td class="p-3 border border-gray-100 text-center">{% if u.is_admin %}Y{% else %}-{% endif %}</td>
                                <td class="p-3 border border-gray-100 text-center">{% if u.consent_marketing %}Y{% else %}-{% endif %}</td>
                                <td class="p-3 border border-gray-100 text-center">{{ u.member_grade or 1 }}</td>
                                <td class="p-3 border border-gray-100 text-center">{% if u.member_grade_overridden|default(false) %}Y{% else %}-{% endif %}</td>
                                <td class="p-3 border border-gray-100 text-right">{{ "{:,}".format(u.points or 0) }}ì›</td>
                                <td class="p-3 border border-gray-100 text-center">
                                    <button type="button" class="member-msg-btn px-2 py-1.5 rounded-lg bg-teal-600 text-white text-[10px] font-black hover:bg-teal-700 transition" data-uid="{{ u.id }}" data-uname="{{ (u.name or u.email or '')|e }}">ë©”ì‹œì§€</button>
                                    {% if not u.is_admin and u.id != current_user.id %}
                                    <button type="button" class="member-del-btn px-2 py-1.5 rounded-lg bg-red-500 text-white text-[10px] font-black hover:bg-red-600 transition ml-1" data-uid="{{ u.id }}">ì‚­ì œ</button>
                                    {% else %}
                                    <span class="text-gray-300 text-[10px]">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="14" class="p-8 text-center text-gray-400 font-bold">ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- íšŒì› ë©”ì‹œì§€ ë°œì†¡ ëª¨ë‹¬ (íšŒì›ê´€ë¦¬ íƒ­) -->
            <div id="member-msg-modal" class="fixed inset-0 z-[60] hidden items-center justify-center bg-black/50 p-4">
                <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-5">
                    <h3 class="text-lg font-black text-gray-800 mb-3">íšŒì›ì—ê²Œ ë©”ì‹œì§€ ë³´ë‚´ê¸°</h3>
                    <p class="text-xs text-gray-500 mb-3" id="member-msg-target">ëŒ€ìƒ: </p>
                    <input type="hidden" id="member-msg-uid" value="">
                    <div class="mb-3">
                        <label class="block text-[10px] font-black text-gray-500 mb-1">ì œëª©</label>
                        <input type="text" id="member-msg-title" class="w-full border border-gray-200 p-3 rounded-xl text-sm font-bold" placeholder="ì œëª© ì…ë ¥" maxlength="200">
                    </div>
                    <div class="mb-4">
                        <label class="block text-[10px] font-black text-gray-500 mb-1">ë‚´ìš©</label>
                        <textarea id="member-msg-body" class="w-full border border-gray-200 p-3 rounded-xl text-sm font-bold min-h-[100px]" placeholder="ë‚´ìš© ì…ë ¥"></textarea>
                    </div>
                    <div class="flex gap-2">
                        <button type="button" id="member-msg-submit" class="flex-1 py-3 bg-teal-600 text-white rounded-xl font-black text-sm hover:bg-teal-700 transition">ë°œì†¡</button>
                        <button type="button" id="member-msg-cancel" class="px-4 py-3 bg-gray-100 text-gray-600 rounded-xl font-black text-sm hover:bg-gray-200 transition">ì·¨ì†Œ</button>
                    </div>
                    <p id="member-msg-status" class="mt-2 text-xs font-bold hidden"></p>
                </div>
            </div>
            <script>
            (function(){
                var modal = document.getElementById('member-msg-modal');
                var targetEl = document.getElementById('member-msg-target');
                var uidEl = document.getElementById('member-msg-uid');
                var titleEl = document.getElementById('member-msg-title');
                var bodyEl = document.getElementById('member-msg-body');
                var statusEl = document.getElementById('member-msg-status');
                var submitBtn = document.getElementById('member-msg-submit');
                var cancelBtn = document.getElementById('member-msg-cancel');
                if (!modal || !uidEl) return;
                function showModal(uid, uname) {
                    uidEl.value = uid;
                    targetEl.textContent = 'ëŒ€ìƒ: ' + (uname || 'íšŒì› #' + uid);
                    titleEl.value = '';
                    bodyEl.value = '';
                    statusEl.classList.add('hidden');
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    if (titleEl) titleEl.focus();
                }
                function hideModal() {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
                document.querySelectorAll('.member-msg-btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var uid = this.getAttribute('data-uid');
                        var uname = this.getAttribute('data-uname') || '';
                        showModal(uid, uname);
                    });
                });
                if (cancelBtn) cancelBtn.addEventListener('click', hideModal);
                modal.addEventListener('click', function(e) { if (e.target === modal) hideModal(); });
                if (submitBtn) submitBtn.addEventListener('click', function() {
                    var uid = uidEl.value;
                    var title = (titleEl && titleEl.value) ? titleEl.value.trim() : '';
                    if (!title) { statusEl.textContent = 'ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'; statusEl.classList.remove('hidden'); statusEl.className = 'mt-2 text-xs font-bold text-red-600'; return; }
                    statusEl.textContent = 'ë°œì†¡ ì¤‘...';
                    statusEl.classList.remove('hidden');
                    statusEl.className = 'mt-2 text-xs font-bold text-gray-600';
                    submitBtn.disabled = true;
                    fetch('/admin/api/member/' + uid + '/message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                        body: JSON.stringify({ title: title, body: (bodyEl && bodyEl.value) ? bodyEl.value.trim() : '' }),
                        credentials: 'same-origin'
                    }).then(function(r) { return r.json(); }).then(function(d) {
                        if (d.success) { statusEl.textContent = d.message || 'ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.'; statusEl.className = 'mt-2 text-xs font-bold text-teal-600'; setTimeout(hideModal, 1200); }
                        else { statusEl.textContent = d.message || 'ë°œì†¡ ì‹¤íŒ¨'; statusEl.className = 'mt-2 text-xs font-bold text-red-600'; }
                    }).catch(function() { statusEl.textContent = 'ìš”ì²­ ì‹¤íŒ¨'; statusEl.className = 'mt-2 text-xs font-bold text-red-600'; }).finally(function() { submitBtn.disabled = false; });
                });
                document.querySelectorAll('.member-del-btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var uid = this.getAttribute('data-uid');
                        if (!confirm('ì´ íšŒì›ì„ ì •ë§ ì‚­ì œí• ê¹Œìš”? ì£¼ë¬¸ ì´ë ¥ì´ ìˆìœ¼ë©´ ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')) return;
                        fetch('/admin/api/member/' + uid + '/delete', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' })
                            .then(function(r) { return r.json(); })
                            .then(function(d) {
                                if (d.success) { var row = document.querySelector('tr[data-member-id="' + uid + '"]'); if (row) row.remove(); alert(d.message); }
                                else { alert(d.message || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
                            })
                            .catch(function() { alert('ìš”ì²­ ì‹¤íŒ¨'); });
                    });
                });
            })();
            </script>

        {% elif tab == 'sellers' %}
            <div class="mb-12">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <div>
                        <h3 class="text-lg font-black text-gray-800 italic">Seller Business Profile (íŒë§¤ì ì •ë³´)</h3>
                        <p class="text-[11px] text-gray-500 font-bold mt-1">ì—‘ì…€ í˜•ì‹ìœ¼ë¡œ ì •ë ¬ëœ íŒë§¤ìë³„ ì‚¬ì—…ìÂ·ì •ì‚° ì •ë³´</p>
                    </div>
                    <a href="/admin/sellers/excel" class="bg-teal-600 text-white px-5 py-2.5 rounded-xl font-black text-xs shadow hover:bg-teal-700">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</a>
                </div>
                <div class="flex gap-2 mb-4">
                    <a href="/admin?tab=sellers&seller_tax=ì „ì²´" class="px-4 py-2 rounded-xl text-[11px] font-black {% if seller_tax == 'ì „ì²´' %}bg-teal-600 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">ì „ì²´</a>
                    <a href="/admin?tab=sellers&seller_tax=ê³¼ì„¸" class="px-4 py-2 rounded-xl text-[11px] font-black {% if seller_tax == 'ê³¼ì„¸' %}bg-teal-600 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">ê³¼ì„¸</a>
                    <a href="/admin?tab=sellers&seller_tax=ë©´ì„¸" class="px-4 py-2 rounded-xl text-[11px] font-black {% if seller_tax == 'ë©´ì„¸' %}bg-teal-600 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">ë©´ì„¸</a>
                </div>
                <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-x-auto">
                    <table class="w-full text-left min-w-[1000px] text-[11px] font-bold border-collapse">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="p-3 border border-gray-600 w-12 text-center">ìˆœì„œ</th>
                                <th class="p-3 border border-gray-600 w-16 text-center">ê³¼ì„¸/ë©´ì„¸</th>
                                <th class="p-3 border border-gray-600">ì¹´í…Œê³ ë¦¬</th>
                                <th class="p-3 border border-gray-600">ìƒí˜¸</th>
                                <th class="p-3 border border-gray-600">ëŒ€í‘œì</th>
                                <th class="p-3 border border-gray-600">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</th>
                                <th class="p-3 border border-gray-600">ì†Œì¬ì§€</th>
                                <th class="p-3 border border-gray-600">ê³ ê°ì„¼í„°</th>
                                <th class="p-3 border border-gray-600">ë¬¸ì˜ë§í¬</th>
                                <th class="p-3 border border-gray-600">ì€í–‰ëª…</th>
                                <th class="p-3 border border-gray-600">ì˜ˆê¸ˆì£¼</th>
                                <th class="p-3 border border-gray-600">ì •ì‚°ê³„ì¢Œ</th>
                                <th class="p-3 border border-gray-600">ë§¤ë‹ˆì €ì´ë©”ì¼</th>
                                <th class="p-3 border border-gray-600 w-20 text-center">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in sellers_categories %}
                            <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                                <td class="p-3 border border-gray-100 text-center text-gray-500">{{ loop.index }}</td>
                                <td class="p-3 border border-gray-100 text-center"><span class="{% if (c.tax_type or 'ê³¼ì„¸') == 'ë©´ì„¸' %}text-amber-600{% else %}text-teal-600{% endif %} font-black text-[10px]">{{ c.tax_type or 'ê³¼ì„¸' }}</span></td>
                                <td class="p-3 border border-gray-100 font-black text-teal-700">{{ c.name }}</td>
                                <td class="p-3 border border-gray-100">{{ c.biz_name or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.biz_representative or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.biz_reg_number or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.biz_address or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.biz_contact or '-' }}</td>
                                <td class="p-3 border border-gray-100 text-teal-600 truncate max-w-[120px]" title="{{ c.seller_inquiry_link or '' }}">{% if c.seller_inquiry_link %}{{ c.seller_inquiry_link[:30] }}{% if c.seller_inquiry_link|length > 30 %}...{% endif %}{% else %}-{% endif %}</td>
                                <td class="p-3 border border-gray-100">{{ c.bank_name or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.account_holder or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.settlement_account or '-' }}</td>
                                <td class="p-3 border border-gray-100 text-gray-500">{{ c.manager_email or '-' }}</td>
                                <td class="p-3 border border-gray-100 text-center"><a href="/admin/category/edit/{{ c.id }}" class="text-blue-600 font-black hover:underline text-[10px]">ìˆ˜ì •</a></td>
                            </tr>
                            {% else %}
                            <tr><td colspan="14" class="p-8 text-center text-gray-400 font-bold">ë“±ë¡ëœ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬ ì„¤ì •ì—ì„œ ì¶”ê°€í•´ ì£¼ì„¸ìš”.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        {% elif tab == 'orders' %}
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-left">
                <div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm"><p class="text-[9px] text-gray-400 font-black uppercase mb-1">Total Sales</p><p class="text-xl font-black text-teal-600">{{ "{:,}".format(stats.sales) }}ì›</p></div>
                <div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm"><p class="text-[9px] text-gray-400 font-black uppercase mb-1">Orders</p><p class="text-xl font-black text-gray-800">{{ stats.count }}ê±´</p></div>
                <div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm"><p class="text-[9px] text-gray-400 font-black uppercase mb-1">Delivery Fees</p><p class="text-xl font-black text-orange-500">{{ "{:,}".format(stats.delivery) }}ì›</p></div>
                <div class="bg-gray-800 p-6 rounded-[2rem] shadow-xl"><p class="text-[9px] text-gray-400 font-black uppercase mb-1 text-white/50">Grand Total</p><p class="text-xl font-black text-white">{{ "{:,}".format(stats.grand_total) }}ì›</p></div>
            </div>

            <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm mb-12">
                <div class="flex gap-2 mb-6">
                    <button type="button" onclick="setDateRange('today')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ì˜¤ëŠ˜</button>
                    <button type="button" onclick="setDateRange('7days')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ìµœê·¼ 7ì¼</button>
                    <button type="button" onclick="setDateRange('month')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ì´ë²ˆ ë‹¬</button>
                </div>
                <form action="/admin" method="GET" id="date-filter-form" class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                    <input type="hidden" name="tab" value="orders">
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì‹œì‘ ì¼ì‹œ</label><input type="datetime-local" name="start_date" id="start_date" value="{{ start_date_str.replace(' ', 'T') }}" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs"></div>
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì¢…ë£Œ ì¼ì‹œ</label><input type="datetime-local" name="end_date" id="end_date" value="{{ end_date_str.replace(' ', 'T') }}" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs"></div>
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì¹´í…Œê³ ë¦¬</label><select name="order_cat" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs bg-white"><option value="ì „ì²´">ëª¨ë“  í’ˆëª© í•©ì‚°</option>{% for c in selectable_categories %}<option value="{{c.name}}" {% if sel_order_cat == c.name %}selected{% endif %}>{{c.name}}</option>{% endfor %}</select></div>
                    <button type="submit" class="bg-teal-600 text-white py-4 rounded-2xl font-black shadow-lg">ì¡°íšŒí•˜ê¸°</button>
                </form>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8">
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-base font-black text-gray-800">íŒë§¤ìƒí’ˆëª…ë³„ íŒë§¤ìˆ˜ëŸ‰ ì´í•©ê³„</h3>
                        <div class="flex gap-2 flex-wrap">
                            <button type="button" onclick="downloadSalesSummaryTableImage()" class="bg-gray-700 text-white px-5 py-2.5 rounded-xl font-black text-xs shadow hover:bg-gray-800">ì´ë¯¸ì§€</button>
                            <a href="/admin/orders/sales_summary_excel?start_date={{start_date_str}}&end_date={{end_date_str}}&order_ids={{ filtered_orders | map(attribute='order_id') | join(',') }}&order_cat={{ sel_order_cat }}" class="bg-teal-600 text-white px-5 py-2.5 rounded-xl font-black text-xs shadow hover:bg-teal-700">ì—‘ì…€</a>
                        </div>
                    </div>
                    <div id="sales-summary-table-wrap" class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-x-auto overflow-y-auto max-h-[32rem]">
                        <table id="sales-summary-table" class="w-full text-[11px] font-black min-w-[400px]">
                            <thead class="bg-gray-800 text-white">
                                <tr>
                                    <th class="p-4 text-left">í’ˆëª©(ì¹´í…Œê³ ë¦¬)</th>
                                    <th class="p-4 text-left">íŒë§¤ìƒí’ˆëª…</th>
                                    <th class="p-4 text-center">íŒë§¤ìˆ˜ëŸ‰ ì´í•©ê³„</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in product_summary_rows %}
                                <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                                    <td class="p-4 text-gray-600">{{ row.category }}</td>
                                    <td class="p-4 text-gray-800">{{ row.product_name }}</td>
                                    <td class="p-4 text-center font-black text-teal-600">{{ row.total_quantity }}</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="3" class="p-8 text-center text-gray-400">ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="bg-gray-200 border-t-2 border-gray-400">
                                <tr>
                                    <td colspan="2" class="p-4 text-right font-black text-gray-800">ì´í•©ê³„ ìˆ˜ëŸ‰</td>
                                    <td class="p-4 text-center font-black text-teal-600">{{ sales_total_quantity }}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-base font-black text-gray-800">ì¡°íšŒ ê²°ê³¼ ìƒì„¸ (ì£¼ë¬¸ì¼ì‹œ Â· í’ˆëª© Â· ìˆ˜ëŸ‰ Â· ìƒíƒœ)</h3>
                        <div class="flex gap-2 flex-wrap">
                            <button type="button" onclick="downloadSalesTableImage()" class="bg-gray-700 text-white px-5 py-2.5 rounded-xl font-black text-xs shadow hover:bg-gray-800">ì´ë¯¸ì§€</button>
                            <a href="/admin/orders/sales_excel?start_date={{start_date_str}}&end_date={{end_date_str}}&order_ids={{ filtered_orders | map(attribute='order_id') | join(',') }}&order_cat={{ sel_order_cat }}" class="bg-teal-600 text-white px-5 py-2.5 rounded-xl font-black text-xs shadow hover:bg-teal-700">ì—‘ì…€</a>
                        </div>
                    </div>
                    <div id="sales-detail-table-wrap" class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-x-auto overflow-y-auto max-h-[32rem]">
                        <table id="sales-detail-table" class="w-full text-[11px] font-black min-w-[600px]">
                            <thead class="bg-gray-800 text-white">
                                <tr>
                                    <th class="p-4 text-left">ì£¼ë¬¸ì¼ì‹œ</th>
                                    <th class="p-4 text-left">íŒë§¤ìƒí’ˆëª…</th>
                                    <th class="p-4 text-left">ì¹´í…Œê³ ë¦¬</th>
                                    <th class="p-4 text-center">íŒë§¤ìˆ˜ëŸ‰</th>
                                    <th class="p-4 text-center">ê²°ì œìƒíƒœ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in sales_table_rows %}
                                <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                                    <td class="p-4 text-gray-700">{{ row.order_date }}</td>
                                    <td class="p-4 text-gray-800">{{ row.product_name }}</td>
                                    <td class="p-4 text-gray-600">{{ row.category | default('') }}</td>
                                    <td class="p-4 text-center font-black">{{ row.quantity }}</td>
                                    <td class="p-4 text-center {% if row.status in ('ê²°ì œì·¨ì†Œ', 'ì·¨ì†Œ') %}text-red-500{% else %}text-teal-600{% endif %}">{{ row.status }}</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="5" class="p-8 text-center text-gray-400">ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="bg-gray-200 border-t-2 border-gray-400">
                                <tr>
                                    <td colspan="3" class="p-4 text-right font-black text-gray-800">ì´í•©ê³„ ìˆ˜ëŸ‰</td>
                                    <td class="p-4 text-center font-black text-teal-600">{{ sales_total_quantity }}</td>
                                    <td class="p-4"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm mb-8">
                <div class="flex gap-2 mb-6">
                    <button type="button" onclick="setDateRange('today')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ì˜¤ëŠ˜</button>
                    <button type="button" onclick="setDateRange('7days')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ìµœê·¼ 7ì¼</button>
                    <button type="button" onclick="setDateRange('month')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ì´ë²ˆ ë‹¬</button>
                </div>
                <form action="/admin" method="GET" id="date-filter-form-2" class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                    <input type="hidden" name="tab" value="orders">
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì‹œì‘ ì¼ì‹œ</label><input type="datetime-local" name="start_date" id="start_date_2" value="{{ start_date_str.replace(' ', 'T') }}" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs"></div>
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì¢…ë£Œ ì¼ì‹œ</label><input type="datetime-local" name="end_date" id="end_date_2" value="{{ end_date_str.replace(' ', 'T') }}" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs"></div>
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì¹´í…Œê³ ë¦¬</label><select name="order_cat" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs bg-white"><option value="ì „ì²´">ëª¨ë“  í’ˆëª© í•©ì‚°</option>{% for c in selectable_categories %}<option value="{{c.name}}" {% if sel_order_cat == c.name %}selected{% endif %}>{{c.name}}</option>{% endfor %}</select></div>
                    <button type="submit" class="bg-teal-600 text-white py-4 rounded-2xl font-black shadow-lg">ì¡°íšŒí•˜ê¸°</button>
                </form>
            </div>

            <div class="flex flex-wrap items-center gap-4 mb-8 bg-gray-50 p-6 rounded-[2.5rem] border border-gray-100">
                <label class="flex items-center gap-2 cursor-pointer bg-white px-6 py-3 rounded-2xl shadow-sm">
                    <input type="checkbox" id="selectAllOrders" class="w-5 h-5 accent-blue-600" onchange="var c=this.checked;document.querySelectorAll('.order-checkbox').forEach(function(b){b.checked=c;});">
                    <span class="text-xs font-black">ì „ì²´ ì„ íƒ</span>
                </label>
                <button type="button" id="btnBulkDelivery" class="bg-blue-600 text-white px-8 py-3 rounded-2xl font-black text-xs shadow-lg">ì¼ê´„ ë°°ì†¡ìš”ì²­</button>
                <button type="button" id="btnPrintInvoices" class="bg-gray-800 text-white px-8 py-3 rounded-2xl font-black text-xs shadow-lg">ì†¡ì¥ ì¶œë ¥</button>
                <a href="/admin/orders/excel?start_date={{start_date_str}}&end_date={{end_date_str}}&order_ids={{ filtered_orders | map(attribute='order_id') | join(',') }}" class="bg-teal-100 text-teal-700 px-8 py-3 rounded-2xl font-black text-xs ml-auto">Excel</a>
            </div>

            <div class="bg-white rounded-[2.5rem] shadow-xl border border-gray-50 overflow-x-auto mb-12">
                <table class="w-full text-[10px] font-black min-w-[1200px]">
                    <thead class="bg-gray-800 text-white">
                        <tr><th class="p-6 text-center">ì„ íƒ</th><th class="p-6">ì˜¤ë”ë„˜ë²„</th><th class="p-6">ì£¼ë¬¸ì¼ ìƒíƒœ</th><th class="p-6">ê³ ê°ì •ë³´</th><th class="p-6">ë°°ì†¡ì§€</th><th class="p-6">í’ˆëª©</th><th class="p-6 text-center">ì†¡ì¥</th></tr>
                    </thead>
                    <tbody>
                        {% for o in filtered_orders %}
                        <tr id="row-{{ o.order_id }}" class="border-b border-gray-100 hover:bg-teal-50/30 transition">
                            <td class="p-6 text-center">
                                {% if o.status == 'ê²°ì œì™„ë£Œ' %}
                                <input type="checkbox" class="order-checkbox w-5 h-5 accent-blue-600" value="{{ o.order_id }}">
                                {% endif %}
                            </td>
                            <td class="p-6 text-gray-700 font-mono text-[11px]">{{ o.order_id }}</td>
                            <td class="p-6">
                                <span class="text-gray-400 text-[11px]">{{ o.created_at.strftime('%m/%d %H:%M') }}</span><br>
                                <span id="status-{{ o.order_id }}" class="{% if o.status == 'ê²°ì œì·¨ì†Œ' %}text-red-500{% else %}text-teal-600{% endif %} font-black">[{{ o.status }}]</span><br>
                                <a href="/admin/order/{{ o.id }}/items" class="text-[10px] text-teal-600 hover:underline font-bold">í’ˆëª©ìƒíƒœ</a>
                            </td>
                            <td class="p-6"><b>{{ o.customer_name }}</b><br><span class="text-gray-400">{{ o.customer_phone }}</span></td>
                            <td class="p-6 text-gray-500 text-[11px]">{{ o.delivery_address }}</td>
                            <td class="p-6 text-gray-600 font-medium text-[11px]">{{ (o._manager_items | default([])) | join(', ') }}</td>
                            <td class="p-6 text-center">
                                <button type="button" class="invoice-modal-btn bg-gray-700 text-white px-3 py-2 rounded-xl text-[10px] font-black hover:bg-gray-800" data-order-id="{{ o.order_id }}">ì†¡ì¥</button>
                            </td>
                        </tr>
                        {% endfor %}
                        {% if not filtered_orders %}
                        <tr><td colspan="7" class="p-10 text-center text-gray-400 font-bold">ì¡°íšŒëœ ì˜¤ë”ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <div id="invoice-print-modal" class="fixed inset-0 z-[9998] hidden flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 max-h-[90vh] flex flex-col">
                    <div class="flex justify-between items-center mb-4 flex-shrink-0">
                        <h3 class="text-lg font-black text-gray-800" id="invoice-modal-title">ì†¡ì¥ ì¶œë ¥</h3>
                        <button type="button" id="invoice-modal-close" class="w-8 h-8 rounded-xl text-gray-400 hover:text-gray-600 hover:bg-gray-100 flex items-center justify-center text-xl">&times;</button>
                    </div>
                    <div id="invoice-step-choice" class="flex flex-col gap-3 flex-shrink-0">
                        <p class="text-xs text-gray-500 mb-1">ì¶œë ¥ ë°©ì‹ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                        <button type="button" id="invoice-print-single" class="w-full bg-teal-600 text-white py-3 rounded-xl font-black text-sm hover:bg-teal-700">ê°œë³„ (ì´ ì£¼ë¬¸ 1ê±´)</button>
                        <button type="button" id="invoice-print-all-show" class="w-full bg-gray-700 text-white py-3 rounded-xl font-black text-sm hover:bg-gray-800">ì „ì²´ ì„ íƒ (ì˜¤ë”ë„˜ë²„ ì„ íƒ)</button>
                    </div>
                    <div id="invoice-step-list" class="hidden flex flex-col flex-1 min-h-0">
                        <p class="text-xs text-gray-500 mb-2">ì¶œë ¥í•  ì˜¤ë”ë„˜ë²„ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
                        <label class="flex items-center gap-2 cursor-pointer mb-2 p-2 rounded-lg hover:bg-gray-50">
                            <input type="checkbox" id="invoice-select-all-orders" class="w-4 h-4 accent-teal-600">
                            <span class="text-sm font-black text-gray-700">ì „ì²´ ì„ íƒ</span>
                        </label>
                        <div id="invoice-order-list" class="border border-gray-200 rounded-xl p-3 overflow-y-auto flex-1 mb-4 space-y-1 max-h-48 text-[11px] font-mono"></div>
                        <div class="flex gap-2 flex-shrink-0">
                            <button type="button" id="invoice-back-from-list" class="flex-1 py-2.5 rounded-xl font-black text-sm bg-gray-100 text-gray-700 hover:bg-gray-200">ë’¤ë¡œ</button>
                            <button type="button" id="invoice-do-print-selected" class="flex-1 py-2.5 rounded-xl font-black text-sm bg-teal-600 text-white hover:bg-teal-700">ì†¡ì¥ ì¶œë ¥</button>
                        </div>
                    </div>
                </div>
            </div>

            <script>
            (function() {
                var invoiceModalOrderId = null;
                function getCheckedOrderIds() {
                    var list = [];
                    document.querySelectorAll('.order-checkbox:checked').forEach(function(cb) { list.push(cb.value); });
                    return list;
                }
                function getAllOrderIds() {
                    var list = [];
                    document.querySelectorAll('.order-checkbox').forEach(function(cb) { list.push(cb.value); });
                    return list;
                }
                function openInvoiceModal(orderId) {
                    invoiceModalOrderId = orderId;
                    showInvoiceStep('choice');
                    var modal = document.getElementById('invoice-print-modal');
                    if (modal) { modal.style.display = 'flex'; modal.classList.remove('hidden'); modal.classList.add('flex'); }
                }
                function closeInvoiceModal() {
                    var modal = document.getElementById('invoice-print-modal');
                    if (modal) { modal.style.display = 'none'; modal.classList.add('hidden'); }
                    invoiceModalOrderId = null;
                    showInvoiceStep('choice');
                }
                function showInvoiceStep(step) {
                    var choiceEl = document.getElementById('invoice-step-choice');
                    var listEl = document.getElementById('invoice-step-list');
                    if (step === 'list') {
                        if (choiceEl) choiceEl.classList.add('hidden');
                        if (listEl) { listEl.classList.remove('hidden'); listEl.classList.add('flex'); fillInvoiceOrderList(); }
                    } else {
                        if (choiceEl) choiceEl.classList.remove('hidden');
                        if (listEl) { listEl.classList.add('hidden'); listEl.classList.remove('flex'); }
                    }
                }
                function fillInvoiceOrderList() {
                    var container = document.getElementById('invoice-order-list');
                    var selectAllCb = document.getElementById('invoice-select-all-orders');
                    if (!container) return;
                    var rows = document.querySelectorAll('tr[id^="row-"]');
                    var orderIds = [];
                    rows.forEach(function(tr) {
                        var id = tr.id.replace('row-', '');
                        if (id) orderIds.push(id);
                    });
                    var checkedInTable = {};
                    document.querySelectorAll('.order-checkbox:checked').forEach(function(cb) { checkedInTable[cb.value] = true; });
                    container.innerHTML = '';
                    orderIds.forEach(function(oid) {
                        var label = document.createElement('label');
                        label.className = 'flex items-center gap-2 cursor-pointer p-1.5 rounded hover:bg-gray-50';
                        var cb = document.createElement('input');
                        cb.type = 'checkbox';
                        cb.className = 'invoice-order-cb w-4 h-4 accent-teal-600';
                        cb.value = oid;
                        cb.checked = !!checkedInTable[oid];
                        label.appendChild(cb);
                        label.appendChild(document.createTextNode(oid));
                        container.appendChild(label);
                    });
                    if (selectAllCb) {
                        selectAllCb.checked = orderIds.length > 0 && orderIds.every(function(id) { return checkedInTable[id]; });
                        selectAllCb.onchange = function() {
                            container.querySelectorAll('.invoice-order-cb').forEach(function(c) { c.checked = selectAllCb.checked; });
                        };
                    }
                }
                function getSelectedInvoiceOrderIds() {
                    var list = [];
                    document.querySelectorAll('#invoice-order-list .invoice-order-cb:checked').forEach(function(cb) { list.push(cb.value); });
                    return list;
                }
                function doPrint(ids) {
                    if (!ids || ids.length === 0) { alert("ì¶œë ¥í•  ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
                    window.open('/admin/order/print?ids=' + ids.join(','), '_blank', 'width=800,height=900');
                    closeInvoiceModal();
                }
                document.querySelectorAll('.invoice-modal-btn').forEach(function(btn) {
                    btn.addEventListener('click', function() { openInvoiceModal(this.getAttribute('data-order-id')); });
                });
                var closeBtn = document.getElementById('invoice-modal-close');
                if (closeBtn) closeBtn.addEventListener('click', closeInvoiceModal);
                var singleBtn = document.getElementById('invoice-print-single');
                if (singleBtn) singleBtn.addEventListener('click', function() {
                    if (invoiceModalOrderId) doPrint([invoiceModalOrderId]);
                    else alert("ì£¼ë¬¸ì„ ì§€ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                });
                var allShowBtn = document.getElementById('invoice-print-all-show');
                if (allShowBtn) allShowBtn.addEventListener('click', function() { showInvoiceStep('list'); });
                var backBtn = document.getElementById('invoice-back-from-list');
                if (backBtn) backBtn.addEventListener('click', function() { showInvoiceStep('choice'); });
                var doPrintBtn = document.getElementById('invoice-do-print-selected');
                if (doPrintBtn) doPrintBtn.addEventListener('click', function() {
                    var ids = getSelectedInvoiceOrderIds();
                    if (ids.length === 0) { alert("ì¶œë ¥í•  ì˜¤ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”."); return; }
                    doPrint(ids);
                });
                document.getElementById('invoice-print-modal').addEventListener('click', function(e) {
                    if (e.target === this) closeInvoiceModal();
                });

                window.printSelectedInvoices = function() {
                    var ids = getCheckedOrderIds();
                    if (ids.length === 0) { alert("ì¶œë ¥í•  ì£¼ë¬¸ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
                    window.open('/admin/order/print?ids=' + ids.join(','), '_blank', 'width=800,height=900');
                };
                window.requestBulkDelivery = function() {
                    var ids = getCheckedOrderIds();
                    if (ids.length === 0) { alert("ì„ íƒëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
                    if (!confirm(ids.length + "ê±´ì„ ì¼ê´„ ë°°ì†¡ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                    fetch('/admin/order/bulk_request_delivery', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ order_ids: ids }),
                        credentials: 'same-origin'
                    }).then(function(r) { return r.json(); }).then(function(data) {
                        if (data.success) {
                            alert("ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.");
                            ids.forEach(function(id) {
                                var el = document.getElementById('status-' + id);
                                if (el) el.innerText = '[ë°°ì†¡ìš”ì²­]';
                                var row = document.getElementById('row-' + id);
                                if (row) {
                                    var cb = row.querySelector('.order-checkbox');
                                    if (cb) cb.remove();
                                }
                            });
                        } else { alert(data.message || 'ì²˜ë¦¬ ì‹¤íŒ¨'); }
                    }).catch(function() { alert("í†µì‹  ì˜¤ë¥˜"); });
                };
                var sel = document.getElementById('selectAllOrders');
                if (sel) sel.addEventListener('change', function() {
                    var c = this.checked;
                    document.querySelectorAll('.order-checkbox').forEach(function(b) { b.checked = c; });
                });
                var btnPrint = document.getElementById('btnPrintInvoices');
                if (btnPrint) btnPrint.addEventListener('click', window.printSelectedInvoices);
                var btnBulk = document.getElementById('btnBulkDelivery');
                if (btnBulk) btnBulk.addEventListener('click', window.requestBulkDelivery);
            })();
            </script>

        {% elif tab == 'settlement' %}
            <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm mb-12">
                <div class="flex gap-2 mb-6">
                    <button type="button" onclick="setDateRange('today')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ì˜¤ëŠ˜</button>
                    <button type="button" onclick="setDateRange('7days')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ìµœê·¼ 7ì¼</button>
                    <button type="button" onclick="setDateRange('month')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ì´ë²ˆ ë‹¬</button>
                </div>
                <form action="/admin" method="GET" id="date-filter-form" class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                    <input type="hidden" name="tab" value="settlement">
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì‹œì‘ ì¼ì‹œ</label><input type="datetime-local" name="start_date" id="start_date" value="{{ start_date_str.replace(' ', 'T') }}" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs"></div>
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì¢…ë£Œ ì¼ì‹œ</label><input type="datetime-local" name="end_date" id="end_date" value="{{ end_date_str.replace(' ', 'T') }}" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs"></div>
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì¹´í…Œê³ ë¦¬ í•„í„°</label><select name="order_cat" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs bg-white"><option value="ì „ì²´">ëª¨ë“  í’ˆëª© í•©ì‚°</option>{% for c in selectable_categories %}<option value="{{c.name}}" {% if sel_order_cat == c.name %}selected{% endif %}>{{c.name}}</option>{% endfor %}</select></div>
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì…ê¸ˆìƒíƒœ</label><select name="settlement_status" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs bg-white"><option value="ì „ì²´" {% if sel_settlement_status == 'ì „ì²´' %}selected{% endif %}>ì „ì²´</option><option value="ì…ê¸ˆëŒ€ê¸°" {% if sel_settlement_status == 'ì…ê¸ˆëŒ€ê¸°' %}selected{% endif %}>ì…ê¸ˆëŒ€ê¸°</option><option value="ì…ê¸ˆì™„ë£Œ" {% if sel_settlement_status == 'ì…ê¸ˆì™„ë£Œ' %}selected{% endif %}>ì…ê¸ˆì™„ë£Œ</option><option value="ì·¨ì†Œ" {% if sel_settlement_status == 'ì·¨ì†Œ' %}selected{% endif %}>ì·¨ì†Œ</option><option value="ë³´ë¥˜" {% if sel_settlement_status == 'ë³´ë¥˜' %}selected{% endif %}>ë³´ë¥˜</option></select></div>
                    <button type="submit" class="bg-teal-600 text-white py-4 rounded-2xl font-black shadow-lg">ì¡°íšŒí•˜ê¸°</button>
                </form>
                <p class="mt-3 text-[11px] text-gray-600 font-bold">ì—‘ì…€: <a href="/admin/orders/settlement_detail_excel?start_date={{ start_date_str.replace(' ', '%20') }}&end_date={{ end_date_str.replace(' ', '%20') }}&order_cat={{ sel_order_cat | urlencode }}&settlement_status={{ sel_settlement_status | urlencode }}" class="text-teal-600 hover:underline">ì •ì‚° ìƒì„¸ (në„˜ë²„)</a> Â· <a href="/admin/settlement/category_excel?start_date={{ start_date_str.replace(' ', '%20') }}&end_date={{ end_date_str.replace(' ', '%20') }}&category={{ sel_order_cat | urlencode }}" class="text-teal-600 hover:underline">ì¹´í…Œê³ ë¦¬ë³„ íŒë§¤ í’ˆëª© (í’ˆëª©Â·ê·œê²©Â·ìˆ˜ëŸ‰)</a></p>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-12">
                <div>
                    <h3 class="text-lg font-black text-gray-800 mb-4 italic">ğŸ“Š ì •ì‚° ìƒì„¸ (në„˜ë²„ ê¸°ì¤€)</h3>
                    <p class="text-[11px] text-gray-500 font-bold mb-4">ê³ ê° ê²°ì œ ì‹œ í’ˆëª©ë³„ ê³ ìœ  në„˜ë²„ê°€ ë¶€ì—¬ë˜ë©°, í•´ë‹¹ ë²ˆí˜¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì •ì‚°í•©ë‹ˆë‹¤.</p>
                    <div class="flex items-center gap-4 mb-4 flex-wrap">
                        <span class="text-[11px] font-bold text-gray-600">ì„ íƒ í•­ëª© ì…ê¸ˆìƒíƒœ ë³€ê²½:</span>
                        <select id="settlement-bulk-status" class="border border-gray-200 rounded-xl px-3 py-2 text-xs font-black bg-white">
                            <option value="ì…ê¸ˆëŒ€ê¸°">ì…ê¸ˆëŒ€ê¸°</option>
                            <option value="ì…ê¸ˆì™„ë£Œ">ì…ê¸ˆì™„ë£Œ</option>
                            <option value="ì·¨ì†Œ">ì·¨ì†Œ</option>
                            <option value="ë³´ë¥˜">ë³´ë¥˜</option>
                        </select>
                        <button type="button" id="settlement-bulk-status-btn" class="bg-teal-600 text-white px-5 py-2 rounded-xl text-xs font-black shadow">ì ìš©</button>
                    </div>
                    <div id="settlement-detail-table-wrap" class="bg-white rounded-[2rem] border border-gray-100 shadow-sm overflow-x-auto overflow-y-auto max-h-[32rem]">
                        <table class="w-full text-left min-w-[900px] text-[10px] font-black">
                            <thead class="bg-gray-800 text-white">
                                <tr>
                                    <th class="p-3 w-12"><input type="checkbox" id="selectAllSettlement" title="ì „ì²´ì„ íƒ" class="rounded"></th>
                                    <th class="p-3">ì •ì‚°ë²ˆí˜¸(n)</th>
                                    <th class="p-3">íŒë§¤ì¼ì‹œ</th>
                                    <th class="p-3">ì¹´í…Œê³ ë¦¬</th>
                                    <th class="p-3 text-center">ë©´ì„¸ì—¬ë¶€</th>
                                    <th class="p-3">í’ˆëª©</th>
                                    <th class="p-3 text-right">íŒë§¤ê¸ˆì•¡</th>
                                    <th class="p-3 text-right">ìˆ˜ìˆ˜ë£Œ</th>
                                    <th class="p-3 text-right">ë°°ì†¡ê´€ë¦¬ë¹„</th>
                                    <th class="p-3 text-right">ì •ì‚°í•©ê³„</th>
                                    <th class="p-3 text-center">ì…ê¸ˆìƒíƒœ(ì…ê¸ˆì¼)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for r in settlement_detail_rows %}
                                <tr class="border-b border-gray-50 hover:bg-teal-50/20">
                                    <td class="p-3"><input type="checkbox" class="settlement-row-checkbox rounded" value="{{ r.order_item_id }}" data-order-item-id="{{ r.order_item_id }}"></td>
                                    <td class="p-3 font-mono text-gray-700">{{ r.settlement_no or '-' }}</td>
                                    <td class="p-3 text-gray-700">{{ r.sale_dt }}</td>
                                    <td class="p-3 text-gray-600">{{ r.category }}</td>
                                    <td class="p-3 text-center text-[9px]">{{ r.tax_exempt }}</td>
                                    <td class="p-3 text-gray-800">{{ r.product_name }}</td>
                                    <td class="p-3 text-right">{{ "{:,}".format(r.sales_amount) }}ì›</td>
                                    <td class="p-3 text-right">{{ "{:,}".format(r.fee) }}ì›</td>
                                    <td class="p-3 text-right">{{ "{:,}".format(r.delivery_fee) }}ì›</td>
                                    <td class="p-3 text-right font-black text-blue-600">{{ "{:,}".format(r.settlement_total) }}ì›</td>
                                    <td class="p-3 text-center align-top"><span class="{% if r.settlement_status == 'ì…ê¸ˆì™„ë£Œ' %}bg-green-100 text-green-700{% else %}bg-orange-100 text-orange-600{% endif %} px-2 py-1 rounded-full text-[9px]">{{ r.settlement_status }}</span>{% if r.settled_at %}<div class="text-[8px] text-gray-500 mt-1">{{ r.settled_at }}</div>{% endif %}</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="11" class="p-10 text-center text-gray-400 font-bold text-sm">í•´ë‹¹ ê¸°ê°„ ì •ì‚° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-6 p-6 bg-gray-50 rounded-2xl border border-gray-200">
                        <h4 class="text-sm font-black text-gray-700 mb-4">ğŸ“Œ ì¹´í…Œê³ ë¦¬ë³„ ì´í•©ê³„ê¸ˆì•¡</h4>
                        <ul class="space-y-2 text-[11px] font-black">
                            {% for cat_name, total_amt in settlement_category_totals.items() %}
                            <li class="flex justify-between"><span class="text-gray-600">{{ cat_name }}</span><span class="text-teal-600">{{ "{:,}".format(total_amt) }}ì›</span></li>
                            {% endfor %}
                            <li class="flex justify-between pt-3 border-t-2 border-gray-300 mt-3"><span class="text-gray-800">ì´í•©ê³„</span><span class="text-blue-600 font-black">{{ "{:,}".format(settlement_category_totals.values() | sum) }}ì›</span></li>
                        </ul>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-black text-gray-800 mb-6 italic">ğŸ“‹ ì˜¤ë”ë³„ ì •ì‚° í˜„í™©</h3>
                    <p class="text-[11px] text-gray-500 font-bold mb-4">ê´€ë¦¬ ì¤‘ì¸ ì¹´í…Œê³ ë¦¬ í’ˆëª©ë§Œ í‘œì‹œë©ë‹ˆë‹¤.</p>
                    <div class="bg-white rounded-[2rem] border border-gray-100 shadow-sm overflow-x-auto overflow-y-auto max-h-[32rem] text-left">
                        <table class="w-full text-left min-w-[800px]">
                            <thead class="bg-gray-50 border-b border-gray-100 text-[10px] text-gray-400 font-black">
                                <tr>
                                    <th class="p-5">ì˜¤ë”ë„˜ë²„</th>
                                    <th class="p-5">íŒë§¤ì¼</th>
                                    <th class="p-5">í’ˆëª©</th>
                                    <th class="p-5 text-center">ìˆ˜ëŸ‰</th>
                                    <th class="p-5 text-center">ë°°ì†¡í˜„í™©</th>
                                    <th class="p-5 text-right">ê°€ê²©(ì •ì‚°ëŒ€ìƒ)</th>
                                    <th class="p-5 text-right">í•©ê³„ê¸ˆì•¡</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for o in filtered_orders %}
                                <tr class="border-b border-gray-50 hover:bg-teal-50/20">
                                    <td class="p-5 font-mono text-[11px] text-gray-700">{{ o.order_id[-12:] if o.order_id else '-' }}</td>
                                    <td class="p-5 text-gray-700 font-bold">{{ o.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td class="p-5 text-gray-700 text-[11px] leading-relaxed">{{ (o._manager_items | default([])) | join(', ') }}</td>
                                    <td class="p-5 text-center font-black">{{ o._manager_qty | default(0) }}</td>
                                    <td class="p-5 text-center"><span class="{% if o.status == 'ê²°ì œì·¨ì†Œ' %}text-red-500{% else %}text-teal-600{% endif %} font-bold text-[11px]">{{ o.status }}</span></td>
                                    <td class="p-5 text-right font-black text-blue-600">{{ "{:,}".format(o._manager_subtotal | default(0)) }}ì›</td>
                                    <td class="p-5 text-right font-black text-gray-800">{{ "{:,}".format(o._manager_subtotal | default(0)) }}ì›</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="7" class="p-10 text-center text-gray-400 font-bold text-sm">í•´ë‹¹ ê¸°ê°„ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="bg-gray-100 border-t-2 border-gray-200">
                            <tr>
                                <td class="p-5 font-black text-gray-500 text-[11px]" colspan="3">ì´í•©ê³„</td>
                                <td class="p-5 text-center font-black text-gray-800">{{ order_total_qty }}</td>
                                <td class="p-5"></td>
                                <td class="p-5 text-right font-black text-blue-600">{{ "{:,}".format(order_total_subtotal) }}ì›</td>
                                <td class="p-5 text-right font-black text-gray-800">{{ "{:,}".format(order_total_subtotal) }}ì›</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                </div>
            </div>
            <script>
            function setDateRange(range) {
                const startInput = document.getElementById('start_date');
                const endInput = document.getElementById('end_date');
                if (!startInput || !endInput) return;
                const now = new Date();
                let start = new Date();
                let end = new Date();
                if (range === 'today') { start.setHours(0,0,0,0); end.setHours(23,59,59,999); }
                else if (range === '7days') { start.setDate(now.getDate()-7); start.setHours(0,0,0,0); }
                else if (range === 'month') { start.setDate(1); start.setHours(0,0,0,0); }
                const format = (d) => new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                startInput.value = format(start);
                endInput.value = format(end);
                document.getElementById('date-filter-form').submit();
            }
            document.getElementById('selectAllSettlement')?.addEventListener('change', function() {
                document.querySelectorAll('.settlement-row-checkbox').forEach(cb => cb.checked = this.checked);
            });
            document.getElementById('settlement-bulk-status-btn')?.addEventListener('click', async function() {
                const ids = Array.from(document.querySelectorAll('.settlement-row-checkbox:checked')).map(cb => cb.value).filter(Boolean);
                if (!ids.length) { alert('ì„ íƒí•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
                const status = document.getElementById('settlement-bulk-status')?.value;
                if (!status) return;
                try {
                    const r = await fetch('/admin/settlement/bulk_item_status', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ order_item_ids: ids, settlement_status: status }), credentials: 'same-origin' });
                    const j = await r.json();
                    if (j.success) { alert(j.message); document.getElementById('date-filter-form')?.submit(); } else { alert(j.message || 'ë³€ê²½ ì‹¤íŒ¨'); }
                } catch (e) { alert('ìš”ì²­ ì‹¤íŒ¨'); }
            });
            </script>

        {% elif tab == 'utm' %}
            <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm mb-8">
                <h2 class="text-xl font-black text-gray-800 mb-2">ğŸ¯ ê´‘ê³ ë³„ ìœ ì…Â·ì£¼ë¬¸ ì§‘ê³„</h2>
                <p class="text-[11px] text-gray-500 font-bold mb-6">ê´‘ê³  ë§í¬ì— UTMì„ ë¶™ì´ë©´ ì—¬ê¸°ì„œ ì§‘ê³„ë©ë‹ˆë‹¤. ê´‘ê³ ë¹„ë¥¼ ì…ë ¥í•˜ë©´ CPAÂ·ROASê°€ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.</p>
                <div class="overflow-x-auto">
                    <table class="w-full text-left min-w-[700px] text-[11px] font-bold">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="p-4">ìœ ì…ê²½ë¡œ (utm_source)</th>
                                <th class="p-4 text-center">íšŒì›ê°€ì…</th>
                                <th class="p-4 text-center">êµ¬ë§¤ì ìˆ˜</th>
                                <th class="p-4 text-center">ì£¼ë¬¸ ìˆ˜</th>
                                <th class="p-4 text-right">ë§¤ì¶œ</th>
                                <th class="p-4 text-right">ê´‘ê³ ë¹„ ì…ë ¥ (ì›)</th>
                                <th class="p-4 text-center">CPA</th>
                                <th class="p-4 text-center">ROAS</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for a in utm_aggregates %}
                            <tr class="border-b border-gray-100 hover:bg-teal-50/30">
                                <td class="p-4 font-black text-gray-800">{{ a.source }}</td>
                                <td class="p-4 text-center">{{ a.signup_count }}</td>
                                <td class="p-4 text-center">{{ a.buyer_count }}</td>
                                <td class="p-4 text-center">{{ a.order_count }}</td>
                                <td class="p-4 text-right font-black text-teal-600">{{ "{:,}".format(a.revenue) }}ì›</td>
                                <td class="p-4 text-right">
                                    <input type="number" min="0" step="1000" class="utm-ad-spend w-28 border border-gray-200 rounded-lg px-2 py-1.5 text-right text-xs" data-source="{{ a.source }}" placeholder="0">
                                </td>
                                <td class="p-4 text-center utm-cpa font-black text-gray-600">-</td>
                                <td class="p-4 text-center utm-roas font-black text-gray-600">-</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="8" class="p-8 text-center text-gray-400">ìœ ì…/ì£¼ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. UTM ë§í¬ë¡œ ìœ ì… í›„ íšŒì›ê°€ì…Â·ì£¼ë¬¸í•˜ë©´ ì§‘ê³„ë©ë‹ˆë‹¤.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="mt-6 p-4 bg-amber-50 rounded-2xl border border-amber-200 text-[11px] text-amber-800 font-bold">
                    <strong>ğŸ“Œ UTM ë§í¬ ì˜ˆì‹œ (ë³µë¶™ í›„ ì†ŒìŠ¤ë§Œ ìˆ˜ì •)</strong><br>
                    ì¹´ì¹´ì˜¤: <code class="bg-white px-1 rounded">?utm_source=kakao&utm_medium=local&utm_campaign=songdo</code><br>
                    ë‹¹ê·¼: <code class="bg-white px-1 rounded">?utm_source=daangn&utm_medium=local&utm_campaign=songdo</code><br>
                    ë„¤ì´ë²„: <code class="bg-white px-1 rounded">?utm_source=naver&utm_medium=search&utm_campaign=basam</code>
                </div>
                <p class="mt-4 text-[10px] text-gray-500">CPA = ê´‘ê³ ë¹„ Ã· êµ¬ë§¤ì ìˆ˜ Â· ROAS = ë§¤ì¶œ Ã· ê´‘ê³ ë¹„ Ã— 100 (ê´‘ê³ ë¹„ ì…ë ¥ ì‹œë§Œ í‘œì‹œ)</p>
            </div>
            <script>
            (function(){
                document.querySelectorAll('.utm-ad-spend').forEach(function(inp){
                    function update(){
                        var row = inp.closest('tr');
                        if (!row) return;
                        var buyer = parseInt(row.querySelector('td:nth-child(3)')?.textContent || '0', 10);
                        var revenue = parseInt((row.querySelector('td:nth-child(5)')?.textContent || '0').replace(/[^0-9]/g,''), 10) || 0;
                        var adSpend = parseInt(inp.value, 10) || 0;
                        var cpaEl = row.querySelector('.utm-cpa');
                        var roasEl = row.querySelector('.utm-roas');
                        if (!cpaEl || !roasEl) return;
                        if (adSpend <= 0) { cpaEl.textContent = '-'; roasEl.textContent = '-'; return; }
                        cpaEl.textContent = buyer > 0 ? (adSpend / buyer).toLocaleString() + 'ì›' : '-';
                        roasEl.textContent = (revenue / adSpend * 100).toFixed(0) + '%';
                    }
                    inp.addEventListener('input', update);
                    inp.addEventListener('change', update);
                });
            })();
            </script>

        {% elif tab == 'reviews' %}
            <div class="bg-white rounded-[2.5rem] border border-gray-50 shadow-sm overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 border-b border-gray-100 text-[10px]">
                        <tr><th class="p-6">íŒë§¤ì(ì¹´í…Œê³ ë¦¬)</th><th class="p-6">ìƒí’ˆ/ì‘ì„±ì</th><th class="p-6">ë‚´ìš©</th><th class="p-6 text-center">ê´€ë¦¬</th></tr>
                    </thead>
                    <tbody>
                        {% for r in reviews %}
                        <tr class="border-b border-gray-100 hover:bg-red-50/30">
                            <td class="p-6 text-gray-500 font-bold">{{ category_names.get(r.category_id, '-') }}</td>
                            <td class="p-6"><span class="text-teal-600">[{{ r.product_name }}]</span><br><b>{{ r.user_name }}</b></td>
                            <td class="p-6 text-gray-600 leading-relaxed">{{ r.content }}</td>
                            <td class="p-6 text-center"><a href="/admin/review/delete/{{ r.id }}" class="text-red-500 underline" onclick="return confirm('ì‚­ì œ?')">ì‚­ì œ</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}
    </div>

    <script>
    function setDateRange(range) {
        const startInput = document.getElementById('start_date');
        const endInput = document.getElementById('end_date');
        const now = new Date();
        let start = new Date();
        let end = new Date();
        if (range === 'today') { start.setHours(0,0,0,0); end.setHours(23,59,59,999); }
        else if (range === '7days') { start.setDate(now.getDate()-7); start.setHours(0,0,0,0); }
        else if (range === 'month') { start.setDate(1); start.setHours(0,0,0,0); }
        const format = (d) => new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
        var startStr = format(start);
        var endStr = format(end);
        if(startInput) startInput.value = startStr;
        if(endInput) endInput.value = endStr;
        var start2 = document.getElementById('start_date_2');
        var end2 = document.getElementById('end_date_2');
        if(start2) start2.value = startStr;
        if(end2) end2.value = endStr;
        var form = document.getElementById('date-filter-form') || document.getElementById('date-filter-form-2');
        if(form) form.submit();
    }

    (function() {
        window.printSelectedInvoices = function() {
            var boxes = document.querySelectorAll ? document.querySelectorAll('.order-checkbox:checked') : [];
            var selected = [];
            for (var i = 0; i < boxes.length; i++) selected.push(boxes[i].value);
            if (selected.length === 0) { alert("ì¶œë ¥í•  ì£¼ë¬¸ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
            window.open('/admin/order/print?ids=' + selected.join(','), '_blank', 'width=800,height=900');
        };
        window.requestBulkDelivery = function() {
            var boxes = document.querySelectorAll ? document.querySelectorAll('.order-checkbox:checked') : [];
            var selected = [];
            for (var i = 0; i < boxes.length; i++) selected.push(boxes[i].value);
            if (selected.length === 0) { alert("ì„ íƒëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
            if (!confirm(selected.length + "ê±´ì„ ì¼ê´„ ë°°ì†¡ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            sendDeliveryRequest(selected);
        };
    })();
    function sendDeliveryRequest(ids) {
        fetch('/admin/order/bulk_request_delivery', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ order_ids: ids }),
            credentials: 'same-origin'
        }).then(function(res){ return res.json(); }).then(function(data) {
            if (data.success) {
                alert(data.message);
                ids.forEach(function(id) {
                    var statusSpan = document.getElementById('status-' + id);
                    if (statusSpan) statusSpan.innerText = '[ë°°ì†¡ìš”ì²­]';
                    var row = document.getElementById('row-' + id);
                    if (row) {
                        var cb = row.querySelector('.order-checkbox');
                        if (cb) cb.remove();
                    }
                });
            } else { alert(data.message || 'ì²˜ë¦¬ ì‹¤íŒ¨'); }
        }).catch(function() { alert("í†µì‹  ì˜¤ë¥˜"); });
    }

    function bindOrderCheckboxes() {
        var selectAll = document.getElementById('selectAllOrders');
        if (selectAll) {
            selectAll.addEventListener('change', function() {
                document.querySelectorAll('.order-checkbox').forEach(function(cb) { cb.checked = selectAll.checked; });
            });
        }
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', bindOrderCheckboxes);
    } else {
        bindOrderCheckboxes();
    }

    async function approveSettlement(catName, amt, email) {
        if(!confirm(catName + "ì˜ " + amt.toLocaleString() + "ì› ì •ì‚°ì„ ì…ê¸ˆ ì™„ë£Œì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        try {
            const res = await fetch('/admin/settlement/complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category_name: catName, amount: amt, manager_email: email })
            });
            const result = await res.json();
            if(result.success) { alert(result.message); location.reload(); }
        } catch(e) { alert("ì„œë²„ ì˜¤ë¥˜"); }
    }
    function downloadSalesTableImage() {
        var el = document.getElementById('sales-detail-table-wrap');
        if (!el) { alert('í…Œì´ë¸”ì´ ì—†ê±°ë‚˜ ì£¼ë¬¸ ë° ë§¤ì¶œ ì§‘ê³„ íƒ­ì—ì„œ ì¡°íšŒ í›„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.'); return; }
        if (typeof html2canvas === 'undefined') {
            alert('ì´ë¯¸ì§€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì¤‘... ì ì‹œ í›„ ë‹¤ì‹œ í´ë¦­í•´ ì£¼ì„¸ìš”.');
            var s = document.createElement('script');
            s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
            s.onload = function() { runDownload(el); };
            document.head.appendChild(s);
            return;
        }
        runDownload(el);
    }
    function runDownload(el) {
        html2canvas(el, { scale: 2, useCORS: true }).then(function(canvas) {
            var a = document.createElement('a');
            a.href = canvas.toDataURL('image/png');
            a.download = 'ë§¤ì¶œìƒì„¸_' + new Date().toISOString().slice(0,10) + '.png';
            a.click();
        }).catch(function() { alert('ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); });
    }
    function downloadSalesSummaryTableImage() {
        var el = document.getElementById('sales-summary-table-wrap');
        if (!el) { alert('í…Œì´ë¸”ì´ ì—†ê±°ë‚˜ ì£¼ë¬¸ ë° ë§¤ì¶œ ì§‘ê³„ íƒ­ì—ì„œ ì¡°íšŒ í›„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.'); return; }
        if (typeof html2canvas === 'undefined') {
            alert('ì´ë¯¸ì§€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì¤‘... ì ì‹œ í›„ ë‹¤ì‹œ í´ë¦­í•´ ì£¼ì„¸ìš”.');
            var s = document.createElement('script');
            s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
            s.onload = function() { runDownload(el); };
            document.head.appendChild(s);
            return;
        }
        runDownload(el);
    }
    (function() {
        function syncSelectAllFromRowCbs() {
            var cbs = document.querySelectorAll('.settlement-row-cb');
            var checked = document.querySelectorAll('.settlement-row-cb:checked');
            var allChecked = cbs.length > 0 && checked.length === cbs.length;
            document.querySelectorAll('.select-all-orders-settlement, .select-all-settlement-rows').forEach(function(el) { el.checked = allChecked; });
        }
        document.addEventListener('change', function(e) {
            if (!e.target || !e.target.classList) return;
            if (e.target.classList.contains('select-all-orders-settlement') || e.target.classList.contains('select-all-settlement-rows')) {
                var checked = e.target.checked;
                document.querySelectorAll('.settlement-row-cb').forEach(function(cb) { cb.checked = checked; });
            }
            if (e.target.classList.contains('settlement-row-cb')) {
                syncSelectAllFromRowCbs();
            }
        });
        document.addEventListener('click', function(e) {
            if (!e.target || !e.target.classList) return;
            if (e.target.classList.contains('btn-bulk-settlement-status')) {
                var checked = document.querySelectorAll('.settlement-row-cb:checked');
                var orderIdSet = {};
                checked.forEach(function(cb) {
                    var tr = cb.closest('tr');
                    if (tr) {
                        var orderId = tr.getAttribute('data-order-pk');
                        if (orderId) orderIdSet[orderId] = true;
                    }
                });
                var orderIds = Object.keys(orderIdSet).map(function(k) { return parseInt(k, 10); }).filter(function(id) { return !isNaN(id) && id > 0; });
                var sel = document.getElementById('bulkSettlementStatus') || document.querySelector('.bulk-settlement-status');
                var status = (sel && sel.value) ? sel.value : 'ì…ê¸ˆì™„ë£Œ';
                if (orderIds.length === 0) { alert('ë³€ê²½í•  í’ˆëª©(í–‰)ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }
                if (!confirm('ì„ íƒí•œ ' + orderIds.length + 'ê°œ ì£¼ë¬¸(ì˜¤ë”)ì„ ëª¨ë‘ "' + status + '"(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                var done = 0, fail = 0, failMsgs = [];
                function onEnd() {
                    if (done + fail === orderIds.length) {
                        var msg = 'ë³€ê²½ ì™„ë£Œ: ' + done + 'ê±´' + (fail ? ', ì‹¤íŒ¨: ' + fail + 'ê±´' : '');
                        if (fail && failMsgs.length) msg += '\n' + failMsgs.slice(0, 3).join('\n') + (failMsgs.length > 3 ? '\n...' : '');
                        alert(msg);
                        location.reload();
                    }
                }
                orderIds.forEach(function(orderId) {
                    fetch('/admin/settlement/order_status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'same-origin',
                        body: JSON.stringify({ order_id: orderId, settlement_status: status })
                    }).then(function(r) {
                        return r.json().then(function(data) {
                            return { ok: r.ok, status: r.status, data: data };
                        }).catch(function() { return { ok: false, status: r.status, data: { success: false, message: 'ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨' }; });
                    }).then(function(result) {
                        if (result.ok && result.data && result.data.success) { done++; } else { fail++; if (result.data && result.data.message) failMsgs.push(result.data.message); }
                        onEnd();
                    }).catch(function(err) { fail++; failMsgs.push('ìš”ì²­ ì‹¤íŒ¨'); onEnd(); });
                });
                return;
            }
            if (e.target.classList.contains('settlement-log-trigger')) {
                var trigger = e.target;
                var contentEl = trigger.parentElement.querySelector('.settlement-log-content');
                var modal = document.getElementById('settlement-log-modal');
                var bodyEl = document.getElementById('settlement-log-modal-body');
                if (contentEl && modal && bodyEl) {
                    bodyEl.innerHTML = contentEl.innerHTML;
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    modal.setAttribute('aria-hidden', 'false');
                }
                return;
            }
            if (e.target.id === 'settlement-log-modal-close' || e.target.id === 'settlement-log-modal') {
                var modal = document.getElementById('settlement-log-modal');
                if (modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    modal.setAttribute('aria-hidden', 'true');
                }
                return;
            }
        });
    })();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" async></script>
    """
    return render_template_string(_header_html() + admin_html + _footer_html(), **locals())
    
"""
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-left">
    <div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm">
        <p class="text-[9px] text-gray-400 font-black uppercase mb-1">Total Sales</p>
        <p class="text-xl font-black text-teal-600">{{ "{:,}".format(stats.sales) }}ì›</p>
    </div>
    <div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm">
        <p class="text-[9px] text-gray-400 font-black uppercase mb-1">Orders</p>
        <p class="text-xl font-black text-gray-800">{{ stats.count }}ê±´</p>
    </div>
    <div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm">
        <p class="text-[9px] text-gray-400 font-black uppercase mb-1">Delivery Fees</p>
        <p class="text-xl font-black text-orange-500">{{ "{:,}".format(stats.delivery) }}ì›</p>
    </div>
    <div class="bg-gray-800 p-6 rounded-[2rem] shadow-xl">
        <p class="text-[9px] text-gray-400 font-black uppercase mb-1 text-white/50">Grand Total</p>
        <p class="text-xl font-black text-white">{{ "{:,}".format(stats.grand_total) }}ì›</p>
    </div>
</div>
    <div class="max-w-7xl mx-auto py-12 px-4 md:px-6 font-black text-xs md:text-sm text-left">
        <div class="flex justify-between items-center mb-10 text-left">
            <h2 class="text-2xl md:text-3xl font-black text-orange-700 italic text-left">Admin Panel</h2>
            <div class="flex gap-4 text-left"><a href="/logout" class="absolute top-6 right-6 z-[9999] text-[12px] md:text-[10px] bg-gray-100 px-6 py-3 md:px-5 md:py-2 rounded-full text-gray-500 font-black hover:bg-red-50 hover:text-red-500 transition-all shadow-md border border-gray-200 text-center">LOGOUT</a></div>
        </div>
        
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 p-4 mb-12 bg-white rounded-2xl border border-gray-100 shadow-sm text-left">
            {% if my_categories %}<a href="/seller/orders" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition bg-teal-50 border border-teal-200 text-teal-700 hover:bg-teal-100 hover:border-teal-300">ë‚´ ë°œì£¼ ëª©ë¡</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=email_order" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'seller_request' or tab == 'email_order' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">emailë°œì£¼</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=marketing_cost" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'marketing_cost' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë§ˆì¼€íŒ…ë¹„ ì‚¬ìš©ë‚´ì—­</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=messages" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'messages' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë©”ì‹œì§€ ë°œì†¡</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=delivery_zone" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'delivery_zone' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë°°ì†¡êµ¬ì—­ê´€ë¦¬</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=delivery_request" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'delivery_request' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë°°ì†¡ìš”ì²­</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=backup" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'backup' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë°±ì—…</a>{% endif %}
            <a href="/admin?tab=products" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'products' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ìƒí’ˆ ê´€ë¦¬</a>
            {% if is_master %}<a href="/admin?tab=popup" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'popup' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì•Œë¦¼íŒì—…</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=partnership" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'partnership' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì œíœ´ë¬¸ì˜</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=restaurant_request" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'restaurant_request' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì „êµ­ë§›ì§‘ìš”ì²­</a>{% endif %}
            <a href="/admin?tab=settlement" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'settlement' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì •ì‚°ê´€ë¦¬</a>
            <a href="/admin?tab=orders" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'orders' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì£¼ë¬¸ ë° ë°°ì†¡ ì§‘ê³„</a>
            {% if is_master %}<a href="/admin?tab=categories" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'categories' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì¹´í…Œê³ ë¦¬/íŒë§¤ì ì„¤ì •</a>{% endif %}
            <a href="/admin?tab=stats" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'stats' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">í†µê³„</a>
            <a href="/admin?tab=reviews" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'reviews' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë¦¬ë·° ê´€ë¦¬</a>
            {% if is_master %}<a href="/admin?tab=sellers" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'sellers' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">íŒë§¤ì ê´€ë¦¬</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=point_manage" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'point_manage' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">í¬ì¸íŠ¸ ê´€ë¦¬</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=member_grade" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'member_grade' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">íšŒì› ë“±ê¸‰</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=members" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'members' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">íšŒì›ê´€ë¦¬</a>{% endif %}
        </div>

        {% if tab == 'products' %}
            <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm mb-12">
    <form action="/admin" method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
        <input type="hidden" name="tab" value="orders">
        
        <div class="space-y-2">
            <label class="text-[10px] text-gray-400 font-black uppercase tracking-widest ml-2">ì‹œì‘ ì¼ì‹œ</label>
            <input type="datetime-local" name="start_date" value="{{ start_date_str.replace(' ', 'T') }}" 
                   class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs focus:ring-2 focus:ring-teal-500 transition">
        </div>

        <div class="space-y-2">
            <label class="text-[10px] text-gray-400 font-black uppercase tracking-widest ml-2">ì¢…ë£Œ ì¼ì‹œ</label>
            <input type="datetime-local" name="end_date" value="{{ end_date_str.replace(' ', 'T') }}" 
                   class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs focus:ring-2 focus:ring-teal-500 transition">
        </div>

        <div class="space-y-2">
            <label class="text-[10px] text-gray-400 font-black uppercase tracking-widest ml-2">ì¹´í…Œê³ ë¦¬</label>
            <select name="order_cat" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs bg-white focus:ring-2 focus:ring-teal-500 transition">
                <option value="ì „ì²´">ëª¨ë“  í’ˆëª© í•©ì‚°</option>
                {% for c in selectable_categories %}
                <option value="{{c.name}}" {% if sel_order_cat == c.name %}selected{% endif %}>{{c.name}}</option>
                {% endfor %}
            </select>
        </div>

        <button type="submit" class="bg-teal-600 text-white py-4 rounded-2xl font-black shadow-lg shadow-teal-100 hover:bg-teal-700 transition active:scale-95 text-xs">
            <i class="fas fa-search mr-2"></i> ê¸°ê°„ ì¡°íšŒí•˜ê¸°
        </button>
    </form>
</div>
                <div class="flex gap-3 text-left">
                    <button onclick="document.getElementById('excel_upload_form').classList.toggle('hidden')" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-black text-xs shadow-lg hover:bg-blue-700 transition">ğŸ“¦ ì—‘ì…€ ëŒ€ëŸ‰ ë“±ë¡</button>
                    <a href="/admin/add" class="bg-teal-600 text-white px-6 py-3 rounded-2xl font-black text-xs shadow-lg hover:bg-teal-700 transition">+ ê°œë³„ ìƒí’ˆ ë“±ë¡</a>
                </div>
            </div>
            
            <div class="bg-white rounded-[2rem] shadow-sm border border-gray-50 overflow-hidden text-left">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 border-b border-gray-100 text-gray-400 uppercase text-[10px] md:text-xs">
                        <tr><th class="p-6">ìƒí’ˆ ê¸°ë³¸ ì •ë³´</th><th class="p-6 text-center">ì¬ê³ </th><th class="p-6 text-center">ê´€ë¦¬</th></tr>
                    </thead>
                    <tbody class="text-left">
                        {% for p in products %}
                        <tr class="border-b border-gray-50 hover:bg-gray-50/50 transition">
                            <td class="p-6 text-left">
                                <b class="text-gray-800 text-sm md:text-base">{{ p.name }}</b> <span class="text-orange-500 text-[9px] md:text-[10px] font-black ml-2">{{ p.badge }}</span><br>
                                <span class="text-teal-600 font-bold text-[10px] md:text-xs">{{ p.description or 'ì„¤ëª… ì—†ìŒ' }}</span><br>
                                <span class="text-gray-400 text-[10px] md:text-xs">{{ "{:,}".format(p.price) }}ì› / {{ p.spec or 'ì¼ë°˜' }}</span>
                            </td>
                            <td class="p-6 text-center font-black text-gray-500">{{ p.stock }}ê°œ</td>
                            <td class="p-6 text-center space-x-3 text-[10px] md:text-xs text-center">
                                <a href="/admin/edit/{{p.id}}" class="text-blue-500 hover:underline">ìˆ˜ì •</a>
                                <a href="/admin/delete/{{p.id}}" class="text-red-300 hover:text-red-500 transition" onclick="return confirm('ì´ ìƒí’ˆì„ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        {% elif tab == 'categories' %}
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 text-left">
                <div class="bg-white p-8 md:p-12 rounded-[2.5rem] md:rounded-[3.5rem] border border-gray-50 shadow-sm h-fit text-left">
                    <h3 class="text-[11px] md:text-sm text-gray-400 uppercase tracking-widest mb-10 font-black text-left">íŒë§¤ ì¹´í…Œê³ ë¦¬ ë° ì‚¬ì—…ì ì¶”ê°€</h3>
                    <form action="/admin/category/add" method="POST" class="space-y-5 text-left">
                        <input name="cat_name" placeholder="ì¹´í…Œê³ ë¦¬ëª… (ì˜ˆ: ì‚°ì§€ì§ì†¡ ë†ì‚°ë¬¼)" class="border border-gray-100 p-5 rounded-2xl w-full font-black text-sm text-left" required>
                        <textarea name="description" placeholder="ë°°ì†¡ê¸°í•œ ì •ë³´ ë“± ì„¤ëª…" class="border border-gray-100 p-5 rounded-2xl w-full h-24 font-black text-sm text-left"></textarea>
                        <input name="manager_email" placeholder="ê´€ë¦¬ ë§¤ë‹ˆì € ì´ë©”ì¼ (ID)" class="border border-gray-100 p-5 rounded-2xl w-full font-black text-sm text-left">
                        <select name="tax_type" class="border border-gray-100 p-5 rounded-2xl w-full font-black text-sm text-left bg-white"><option value="ê³¼ì„¸">ì¼ë°˜ ê³¼ì„¸ ìƒí’ˆ</option><option value="ë©´ì„¸">ë©´ì„¸ ë†ì¶•ì‚°ë¬¼</option></select>
                        <p class="text-[10px] text-amber-600 font-bold uppercase mt-2 text-left">ë…¸ì¶œ íšŒì›ë“±ê¸‰ (ëª‡ ë“±ê¸‰ ì´ìƒ)</p>
                        <select name="min_member_grade" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs text-left bg-white"><option value="">ì „ì²´ íšŒì›</option><option value="1">1ë‹¨ê³„ ì´ìƒ</option><option value="2">2ë‹¨ê³„ ì´ìƒ</option><option value="3">3ë‹¨ê³„ ì´ìƒ</option><option value="4">4ë‹¨ê³„ ì´ìƒ</option><option value="5">5ë‹¨ê³„ë§Œ</option></select>
                        <div class="border-t border-gray-100 pt-8 space-y-4 text-left">
                            <p class="text-[10px] text-teal-600 font-bold tracking-widest uppercase text-left">Seller Business Profile</p>
                            <input name="biz_name" placeholder="ì‚¬ì—…ì ìƒí˜¸ëª…" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm text-left">
                            <input name="biz_representative" placeholder="ëŒ€í‘œì ì„±í•¨" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm text-left">
                            <input name="biz_reg_number" placeholder="ì‚¬ì—…ì ë“±ë¡ë²ˆí˜¸ ( - í¬í•¨ )" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm text-left">
                            <input name="biz_address" placeholder="ì‚¬ì—…ì¥ ì†Œì¬ì§€" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm text-left">
                            <input name="biz_contact" placeholder="ê³ ê° ì„¼í„° ë²ˆí˜¸" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm text-left">
                            <input name="seller_link" placeholder="íŒë§¤ì ë¬¸ì˜ (ì¹´ì¹´ì˜¤/ì±„íŒ…) ë§í¬" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm text-left">
                            <p class="text-[10px] text-blue-600 font-bold tracking-widest uppercase pt-2 text-left">ì •ì‚° ê³„ì¢Œ</p>
                            <input name="bank_name" placeholder="ì€í–‰ëª…" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm text-left">
                            <input name="account_holder" placeholder="ì˜ˆê¸ˆì£¼" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm text-left">
                            <input name="settlement_account" placeholder="ì •ì‚°ê³„ì¢Œ (ê³„ì¢Œë²ˆí˜¸)" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm text-left">
                        </div>
                        <button class="w-full bg-teal-600 text-white py-5 rounded-3xl font-black text-base md:text-lg shadow-xl hover:bg-teal-700 transition text-center">ì‹ ê·œ ì¹´í…Œê³ ë¦¬ ìƒì„±</button>
                    </form>
                </div>
                
                <div class="bg-white rounded-[2.5rem] md:rounded-[3.5rem] border border-gray-50 shadow-sm overflow-hidden text-left">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b border-gray-100 font-bold uppercase text-[10px] md:text-xs">
                            <tr><th class="p-6">ì „ì‹œ ìˆœì„œ</th><th class="p-6">ì¹´í…Œê³ ë¦¬ëª…</th><th class="p-6 text-center">ê´€ë¦¬</th></tr>
                        </thead>
                        <tbody class="text-left">
                            {% for c in categories %}
                            <tr class="border-b border-gray-50 text-left hover:bg-gray-50/50 transition">
                                <td class="p-6 flex gap-4 text-left">
                                    <a href="/admin/category/move/{{c.id}}/up" class="text-blue-500 p-2"><i class="fas fa-chevron-up"></i></a>
                                    <a href="/admin/category/move/{{c.id}}/down" class="text-red-500 p-2"><i class="fas fa-chevron-down"></i></a>
                                </td>
                                <td class="p-6 text-left"><b class="text-gray-800">{{ c.name }}</b><br><span class="text-gray-400 text-[10px]">ë§¤ë‹ˆì €: {{ c.manager_email or 'ë¯¸ì§€ì •' }}</span></td>
                                <td class="p-6 text-center space-x-3 text-[10px] text-center">
                                    <a href="/admin/category/edit/{{c.id}}" class="text-blue-500 hover:underline">ìˆ˜ì •</a>
                                    <a href="/admin/category/delete/{{c.id}}" class="text-red-200 hover:text-red-500 transition" onclick="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        {% elif tab == 'sellers' %}
            <div class="mb-12 text-left">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6 text-left">
                    <div>
                        <h3 class="text-lg font-black text-gray-800 italic">Seller Business Profile (íŒë§¤ì ì •ë³´)</h3>
                        <p class="text-[11px] text-gray-500 font-bold mt-1">ì—‘ì…€ í˜•ì‹ìœ¼ë¡œ ì •ë ¬ëœ íŒë§¤ìë³„ ì‚¬ì—…ìÂ·ì •ì‚° ì •ë³´</p>
                    </div>
                    <a href="/admin/sellers/excel" class="bg-teal-600 text-white px-5 py-2.5 rounded-xl font-black text-xs shadow hover:bg-teal-700">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</a>
                </div>
                <div class="flex gap-2 mb-4">
                    <a href="/admin?tab=sellers&seller_tax=ì „ì²´" class="px-4 py-2 rounded-xl text-[11px] font-black {% if seller_tax == 'ì „ì²´' %}bg-teal-600 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">ì „ì²´</a>
                    <a href="/admin?tab=sellers&seller_tax=ê³¼ì„¸" class="px-4 py-2 rounded-xl text-[11px] font-black {% if seller_tax == 'ê³¼ì„¸' %}bg-teal-600 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">ê³¼ì„¸</a>
                    <a href="/admin?tab=sellers&seller_tax=ë©´ì„¸" class="px-4 py-2 rounded-xl text-[11px] font-black {% if seller_tax == 'ë©´ì„¸' %}bg-teal-600 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">ë©´ì„¸</a>
                </div>
                <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-x-auto text-left">
                    <table class="w-full text-left min-w-[1000px] text-[11px] font-bold border-collapse">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="p-3 border border-gray-600 w-12 text-center">ìˆœì„œ</th>
                                <th class="p-3 border border-gray-600 w-16 text-center">ê³¼ì„¸/ë©´ì„¸</th>
                                <th class="p-3 border border-gray-600">ì¹´í…Œê³ ë¦¬</th>
                                <th class="p-3 border border-gray-600">ìƒí˜¸</th>
                                <th class="p-3 border border-gray-600">ëŒ€í‘œì</th>
                                <th class="p-3 border border-gray-600">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</th>
                                <th class="p-3 border border-gray-600">ì†Œì¬ì§€</th>
                                <th class="p-3 border border-gray-600">ê³ ê°ì„¼í„°</th>
                                <th class="p-3 border border-gray-600">ë¬¸ì˜ë§í¬</th>
                                <th class="p-3 border border-gray-600">ì€í–‰ëª…</th>
                                <th class="p-3 border border-gray-600">ì˜ˆê¸ˆì£¼</th>
                                <th class="p-3 border border-gray-600">ì •ì‚°ê³„ì¢Œ</th>
                                <th class="p-3 border border-gray-600">ë§¤ë‹ˆì €ì´ë©”ì¼</th>
                                <th class="p-3 border border-gray-600 w-20 text-center">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody class="text-left">
                            {% for c in sellers_categories %}
                            <tr class="border-b border-gray-100 hover:bg-gray-50/50 text-left">
                                <td class="p-3 border border-gray-100 text-center text-gray-500">{{ loop.index }}</td>
                                <td class="p-3 border border-gray-100 text-center"><span class="{% if (c.tax_type or 'ê³¼ì„¸') == 'ë©´ì„¸' %}text-amber-600{% else %}text-teal-600{% endif %} font-black text-[10px]">{{ c.tax_type or 'ê³¼ì„¸' }}</span></td>
                                <td class="p-3 border border-gray-100 font-black text-teal-700">{{ c.name }}</td>
                                <td class="p-3 border border-gray-100">{{ c.biz_name or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.biz_representative or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.biz_reg_number or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.biz_address or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.biz_contact or '-' }}</td>
                                <td class="p-3 border border-gray-100 text-teal-600 truncate max-w-[120px]" title="{{ c.seller_inquiry_link or '' }}">{% if c.seller_inquiry_link %}{{ c.seller_inquiry_link[:30] }}{% if c.seller_inquiry_link|length > 30 %}...{% endif %}{% else %}-{% endif %}</td>
                                <td class="p-3 border border-gray-100">{{ c.bank_name or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.account_holder or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.settlement_account or '-' }}</td>
                                <td class="p-3 border border-gray-100 text-gray-500">{{ c.manager_email or '-' }}</td>
                                <td class="p-3 border border-gray-100 text-center"><a href="/admin/category/edit/{{ c.id }}" class="text-blue-600 font-black hover:underline text-[10px]">ìˆ˜ì •</a></td>
                            </tr>
                            {% else %}
                            <tr><td colspan="14" class="p-8 text-center text-gray-400 font-bold">ë“±ë¡ëœ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬ ì„¤ì •ì—ì„œ ì¶”ê°€í•´ ì£¼ì„¸ìš”.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        {% elif tab == 'settlement' %}
            <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm mb-12">
                <div class="flex gap-2 mb-6">
                    <button type="button" onclick="setDateRange('today')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ì˜¤ëŠ˜</button>
                    <button type="button" onclick="setDateRange('7days')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ìµœê·¼ 7ì¼</button>
                    <button type="button" onclick="setDateRange('month')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ì´ë²ˆ ë‹¬</button>
                </div>
                <form action="/admin" method="GET" id="date-filter-form" class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                    <input type="hidden" name="tab" value="settlement">
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì‹œì‘ ì¼ì‹œ</label><input type="datetime-local" name="start_date" id="start_date" value="{{ start_date_str.replace(' ', 'T') }}" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs"></div>
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì¢…ë£Œ ì¼ì‹œ</label><input type="datetime-local" name="end_date" id="end_date" value="{{ end_date_str.replace(' ', 'T') }}" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs"></div>
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì¹´í…Œê³ ë¦¬ í•„í„°</label><select name="order_cat" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs bg-white"><option value="ì „ì²´">ëª¨ë“  í’ˆëª© í•©ì‚°</option>{% for c in selectable_categories %}<option value="{{c.name}}" {% if sel_order_cat == c.name %}selected{% endif %}>{{c.name}}</option>{% endfor %}</select></div>
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì…ê¸ˆìƒíƒœ</label><select name="settlement_status" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs bg-white"><option value="ì „ì²´" {% if sel_settlement_status == 'ì „ì²´' %}selected{% endif %}>ì „ì²´</option><option value="ì…ê¸ˆëŒ€ê¸°" {% if sel_settlement_status == 'ì…ê¸ˆëŒ€ê¸°' %}selected{% endif %}>ì…ê¸ˆëŒ€ê¸°</option><option value="ì…ê¸ˆì™„ë£Œ" {% if sel_settlement_status == 'ì…ê¸ˆì™„ë£Œ' %}selected{% endif %}>ì…ê¸ˆì™„ë£Œ</option><option value="ì·¨ì†Œ" {% if sel_settlement_status == 'ì·¨ì†Œ' %}selected{% endif %}>ì·¨ì†Œ</option><option value="ë³´ë¥˜" {% if sel_settlement_status == 'ë³´ë¥˜' %}selected{% endif %}>ë³´ë¥˜</option></select></div>
                    <button type="submit" class="bg-teal-600 text-white py-4 rounded-2xl font-black shadow-lg">ì¡°íšŒí•˜ê¸°</button>
                </form>
                <p class="mt-3 text-[11px] text-gray-600 font-bold">ì—‘ì…€: <a href="/admin/orders/settlement_detail_excel?start_date={{ start_date_str.replace(' ', '%20') }}&end_date={{ end_date_str.replace(' ', '%20') }}&order_cat={{ sel_order_cat | urlencode }}&settlement_status={{ sel_settlement_status | urlencode }}" class="text-teal-600 hover:underline">ì •ì‚° ìƒì„¸ (në„˜ë²„)</a> Â· <a href="/admin/settlement/category_excel?start_date={{ start_date_str.replace(' ', '%20') }}&end_date={{ end_date_str.replace(' ', '%20') }}&category={{ sel_order_cat | urlencode }}" class="text-teal-600 hover:underline">ì¹´í…Œê³ ë¦¬ë³„ íŒë§¤ í’ˆëª© (í’ˆëª©Â·ê·œê²©Â·ìˆ˜ëŸ‰)</a></p>
            </div>
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 mb-4 italic">ğŸ“Š ì •ì‚° ìƒì„¸ (në„˜ë²„ ê¸°ì¤€)</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-4">ê³ ê° ê²°ì œ ì‹œ í’ˆëª©ë³„ ê³ ìœ  në„˜ë²„ê°€ ë¶€ì—¬ë˜ë©°, í•´ë‹¹ ë²ˆí˜¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì •ì‚°í•©ë‹ˆë‹¤.</p>
                <div class="flex items-center gap-4 mb-4 flex-wrap">
                    <span class="text-[11px] font-bold text-gray-600">ì„ íƒ í•­ëª© ì…ê¸ˆìƒíƒœ ë³€ê²½:</span>
                    <select id="settlement-bulk-status-2" class="border border-gray-200 rounded-xl px-3 py-2 text-xs font-black bg-white">
                        <option value="ì…ê¸ˆëŒ€ê¸°">ì…ê¸ˆëŒ€ê¸°</option>
                        <option value="ì…ê¸ˆì™„ë£Œ">ì…ê¸ˆì™„ë£Œ</option>
                        <option value="ì·¨ì†Œ">ì·¨ì†Œ</option>
                        <option value="ë³´ë¥˜">ë³´ë¥˜</option>
                    </select>
                    <button type="button" id="settlement-bulk-status-btn-2" class="bg-teal-600 text-white px-5 py-2 rounded-xl text-xs font-black shadow">ì ìš©</button>
                </div>
                <div id="settlement-detail-table-wrap-2" class="bg-white rounded-[2rem] border border-gray-100 shadow-sm overflow-x-auto">
                    <table class="w-full text-left min-w-[900px] text-[10px] font-black">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="p-3 w-12"><input type="checkbox" id="selectAllSettlement2" title="ì „ì²´ì„ íƒ" class="rounded"></th>
                                <th class="p-3">ì •ì‚°ë²ˆí˜¸(n)</th>
                                <th class="p-3">íŒë§¤ì¼ì‹œ</th>
                                <th class="p-3">ì¹´í…Œê³ ë¦¬</th>
                                <th class="p-3 text-center">ë©´ì„¸ì—¬ë¶€</th>
                                <th class="p-3">í’ˆëª©</th>
                                <th class="p-3 text-right">íŒë§¤ê¸ˆì•¡</th>
                                <th class="p-3 text-right">ìˆ˜ìˆ˜ë£Œ</th>
                                <th class="p-3 text-right">ë°°ì†¡ê´€ë¦¬ë¹„</th>
                                <th class="p-3 text-right">ì •ì‚°í•©ê³„</th>
                                <th class="p-3 text-center">ì…ê¸ˆìƒíƒœ(ì…ê¸ˆì¼)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in settlement_detail_rows %}
                            <tr class="border-b border-gray-50 hover:bg-teal-50/20">
                                <td class="p-3"><input type="checkbox" class="settlement-row-checkbox-2 rounded" value="{{ r.order_item_id }}" data-order-item-id="{{ r.order_item_id }}"></td>
                                <td class="p-3 font-mono text-gray-700">{{ r.settlement_no or '-' }}</td>
                                <td class="p-3 text-gray-700">{{ r.sale_dt }}</td>
                                <td class="p-3 text-gray-600">{{ r.category }}</td>
                                <td class="p-3 text-center text-[9px]">{{ r.tax_exempt }}</td>
                                <td class="p-3 text-gray-800">{{ r.product_name }}</td>
                                <td class="p-3 text-right">{{ "{:,}".format(r.sales_amount) }}ì›</td>
                                <td class="p-3 text-right">{{ "{:,}".format(r.fee) }}ì›</td>
                                <td class="p-3 text-right">{{ "{:,}".format(r.delivery_fee) }}ì›</td>
                                <td class="p-3 text-right font-black text-blue-600">{{ "{:,}".format(r.settlement_total) }}ì›</td>
                                <td class="p-3 text-center align-top"><span class="{% if r.settlement_status == 'ì…ê¸ˆì™„ë£Œ' %}bg-green-100 text-green-700{% else %}bg-orange-100 text-orange-600{% endif %} px-2 py-1 rounded-full text-[9px]">{{ r.settlement_status }}</span>{% if r.settled_at %}<div class="text-[8px] text-gray-500 mt-1">{{ r.settled_at }}</div>{% endif %}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="11" class="p-10 text-center text-gray-400 font-bold text-sm">í•´ë‹¹ ê¸°ê°„ ì •ì‚° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="mt-6 p-6 bg-gray-50 rounded-2xl border border-gray-200">
                    <h4 class="text-sm font-black text-gray-700 mb-4">ğŸ“Œ ì¹´í…Œê³ ë¦¬ë³„ ì´í•©ê³„ê¸ˆì•¡</h4>
                    <ul class="space-y-2 text-[11px] font-black">
                        {% for cat_name, total_amt in settlement_category_totals.items() %}
                        <li class="flex justify-between"><span class="text-gray-600">{{ cat_name }}</span><span class="text-teal-600">{{ "{:,}".format(total_amt) }}ì›</span></li>
                        {% endfor %}
                        <li class="flex justify-between pt-3 border-t-2 border-gray-300 mt-3"><span class="text-gray-800">ì´í•©ê³„</span><span class="text-blue-600 font-black">{{ "{:,}".format(settlement_category_totals.values() | sum) }}ì›</span></li>
                    </ul>
                </div>
            </div>
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 mb-6 italic">ğŸ“‹ ì˜¤ë”ë³„ ì •ì‚° í˜„í™©</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-4">ê´€ë¦¬ ì¤‘ì¸ ì¹´í…Œê³ ë¦¬ í’ˆëª©ë§Œ í‘œì‹œë©ë‹ˆë‹¤.</p>
                <div class="bg-white rounded-[2rem] border border-gray-100 shadow-sm overflow-x-auto">
                    <table class="w-full text-left min-w-[800px]">
                        <thead class="bg-gray-50 border-b border-gray-100 text-[10px] text-gray-400 font-black">
                            <tr>
                                <th class="p-5">ì˜¤ë”ë„˜ë²„</th>
                                <th class="p-5">íŒë§¤ì¼</th>
                                <th class="p-5">í’ˆëª©</th>
                                <th class="p-5 text-center">ìˆ˜ëŸ‰</th>
                                <th class="p-5 text-center">ë°°ì†¡í˜„í™©</th>
                                <th class="p-5 text-right">ê°€ê²©(ì •ì‚°ëŒ€ìƒ)</th>
                                <th class="p-5 text-right">í•©ê³„ê¸ˆì•¡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for o in filtered_orders %}
                            <tr class="border-b border-gray-50 hover:bg-teal-50/20">
                                <td class="p-5 font-mono text-[11px] text-gray-700">{{ o.order_id[-12:] if o.order_id else '-' }}</td>
                                <td class="p-5 text-gray-700 font-bold">{{ o.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td class="p-5 text-gray-700 text-[11px] leading-relaxed">{{ (o._manager_items | default([])) | join(', ') }}</td>
                                <td class="p-5 text-center font-black">{{ o._manager_qty | default(0) }}</td>
                                <td class="p-5 text-center"><span class="{% if o.status == 'ê²°ì œì·¨ì†Œ' %}text-red-500{% else %}text-teal-600{% endif %} font-bold text-[11px]">{{ o.status }}</span></td>
                                <td class="p-5 text-right font-black text-blue-600">{{ "{:,}".format(o._manager_subtotal | default(0)) }}ì›</td>
                                <td class="p-5 text-right font-black text-gray-800">{{ "{:,}".format(o._manager_subtotal | default(0)) }}ì›</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="7" class="p-10 text-center text-gray-400 font-bold text-sm">í•´ë‹¹ ê¸°ê°„ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="bg-gray-100 border-t-2 border-gray-200">
                            <tr>
                                <td class="p-5 font-black text-gray-500 text-[11px]" colspan="3">ì´í•©ê³„</td>
                                <td class="p-5 text-center font-black text-gray-800">{{ order_total_qty }}</td>
                                <td class="p-5"></td>
                                <td class="p-5 text-right font-black text-blue-600">{{ "{:,}".format(order_total_subtotal) }}ì›</td>
                                <td class="p-5 text-right font-black text-gray-800">{{ "{:,}".format(order_total_subtotal) }}ì›</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <script>
            function setDateRange(range) {
                const startInput = document.getElementById('start_date');
                const endInput = document.getElementById('end_date');
                if (!startInput || !endInput) return;
                const now = new Date();
                let start = new Date();
                let end = new Date();
                if (range === 'today') { start.setHours(0,0,0,0); end.setHours(23,59,59,999); }
                else if (range === '7days') { start.setDate(now.getDate()-7); start.setHours(0,0,0,0); }
                else if (range === 'month') { start.setDate(1); start.setHours(0,0,0,0); }
                const format = (d) => new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                startInput.value = format(start);
                endInput.value = format(end);
                document.getElementById('date-filter-form').submit();
            }
            document.getElementById('selectAllSettlement2')?.addEventListener('change', function() {
                document.querySelectorAll('.settlement-row-checkbox-2').forEach(cb => cb.checked = this.checked);
            });
            document.getElementById('settlement-bulk-status-btn-2')?.addEventListener('click', async function() {
                const ids = Array.from(document.querySelectorAll('.settlement-row-checkbox-2:checked')).map(cb => cb.value).filter(Boolean);
                if (!ids.length) { alert('ì„ íƒí•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
                const status = document.getElementById('settlement-bulk-status-2')?.value;
                if (!status) return;
                try {
                    const r = await fetch('/admin/settlement/bulk_item_status', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ order_item_ids: ids, settlement_status: status }), credentials: 'same-origin' });
                    const j = await r.json();
                    if (j.success) { alert(j.message); document.getElementById('date-filter-form')?.submit(); } else { alert(j.message || 'ë³€ê²½ ì‹¤íŒ¨'); }
                } catch (e) { alert('ìš”ì²­ ì‹¤íŒ¨'); }
            });
            </script>

        {% elif tab == 'reviews' %}
            <div class="bg-white rounded-[2.5rem] shadow-xl border border-gray-50 overflow-hidden">
                <table class="w-full text-[10px] md:text-xs font-black text-left">
                    <thead class="bg-gray-800 text-white">
                        <tr><th class="p-6">íŒë§¤ì(ì¹´í…Œê³ ë¦¬)</th><th class="p-6">ìƒí’ˆ/ì‘ì„±ì</th><th class="p-6">ë‚´ìš©</th><th class="p-6 text-center">ê´€ë¦¬</th></tr>
                    </thead>
                    <tbody>
                        {% for r in reviews %}
                        <tr class="border-b border-gray-100 hover:bg-red-50/30">
                            <td class="p-6 text-gray-500 font-bold">{{ category_names.get(r.category_id, '-') }}</td>
                            <td class="p-6"><span class="text-teal-600">[{{ r.product_name }}]</span><br>{{ r.user_name }}</td>
                            <td class="p-6">{{ r.content }}</td>
                            <td class="p-6 text-center"><a href="/admin/review/delete/{{ r.id }}" class="bg-red-500 text-white px-4 py-2 rounded-full" onclick="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}
    </div>""" 

# --------------------------------------------------------------------------------
# 7. ì—‘ì…€ ëŒ€ëŸ‰ ì—…ë¡œë“œ (ì‚¬ìš©ì ì»¤ìŠ¤í…€ ì–‘ì‹ ëŒ€ì‘)
# --------------------------------------------------------------------------------
@login_required
def admin_product_bulk_upload_template():
    """ìƒí’ˆ ì—‘ì…€ ì—…ë¡œë“œìš© ì–‘ì‹ íŒŒì¼ ë‹¤ìš´ë¡œë“œ (í•„ìˆ˜ ì»¬ëŸ¼: ì¹´í…Œê³ ë¦¬, ìƒí’ˆëª…, ê·œê²©, ê°€ê²©, ì´ë¯¸ì§€íŒŒì¼ëª…)"""
    if not current_user.is_admin:
        return redirect('/')
    df = pd.DataFrame(columns=['ì¹´í…Œê³ ë¦¬', 'ìƒí’ˆëª…', 'ê·œê²©', 'ê°€ê²©', 'ì´ë¯¸ì§€íŒŒì¼ëª…'])
    df.loc[0] = ['(ì¹´í…Œê³ ë¦¬ëª…)', '(ìƒí’ˆëª…)', '(ì˜ˆ: 1ë°•ìŠ¤)', 0, '(íŒŒì¼ëª….jpg)']
    out = BytesIO()
    with pd.ExcelWriter(out, engine='openpyxl') as w:
        df.to_excel(w, index=False)
    out.seek(0)
    return send_file(out, download_name='ìƒí’ˆ_ì—‘ì…€_ì—…ë¡œë“œ_ì–‘ì‹.xlsx', as_attachment=True)


@admin_bp.route('/admin/product/bulk_upload', methods=['POST'])
@login_required
def admin_product_bulk_upload():
    """ì‚¬ìš©ì ì—‘ì…€ ì–‘ì‹(í•œê¸€ í—¤ë”) ê¸°ë°˜ ëŒ€ëŸ‰ ì—…ë¡œë“œ ë¡œì§"""
    if not current_user.is_admin: return redirect('/')
    file = request.files.get('excel_file')
    if not file: return redirect('/admin')
    try:
        df = pd.read_excel(file)
        # ì‚¬ìš©ì ìš”ì²­ í—¤ë”: ì¹´í…Œê³ ë¦¬, ìƒí’ˆëª…, ê·œê²©, ê°€ê²©, ì´ë¯¸ì§€íŒŒì¼ëª…
        required_cols = ['ì¹´í…Œê³ ë¦¬', 'ìƒí’ˆëª…', 'ê·œê²©', 'ê°€ê²©', 'ì´ë¯¸ì§€íŒŒì¼ëª…']
        if not all(col in df.columns for col in required_cols): 
            flash("ì—‘ì…€ í—¤ë” ë¶ˆì¼ì¹˜ (í•„ìš”: ì¹´í…Œê³ ë¦¬, ìƒí’ˆëª…, ê·œê²©, ê°€ê²©, ì´ë¯¸ì§€íŒŒì¼ëª…)"); return redirect('/admin')
        
        count = 0
        for _, row in df.iterrows():
            cat_name = str(row['ì¹´í…Œê³ ë¦¬']).strip()
            cat_exists = Category.query.filter_by(name=cat_name).first()
            if not cat_exists: continue
            
            # ì´ë¯¸ì§€ ê²½ë¡œ ë§¤í•‘ ë° ìƒì„¸ì‚¬ì§„ ìë™ ì„¤ì •
            raw_img_name = str(row['ì´ë¯¸ì§€íŒŒì¼ëª…']).strip()
            img_url = f"/static/uploads/{raw_img_name}" if raw_img_name != 'nan' else ""
            
            new_p = Product(
                category=cat_name, 
                name=str(row['ìƒí’ˆëª…']), 
                price=int(row['ê°€ê²©']), 
                spec=str(row['ê·œê²©']), 
                origin="êµ­ì‚°", 
                farmer="ë°”êµ¬ë‹ˆì‚¼ì´Œ", 
                stock=50, # ê¸°ë³¸ ì¬ê³  50ê°œ ì„¤ì •
                image_url=img_url, 
                detail_image_url=img_url, # ë©”ì¸ê³¼ ìƒì„¸ ë™ì¼í•˜ê²Œ ë³µì‚¬
                is_active=True, 
                tax_type=cat_exists.tax_type
            )
            db.session.add(new_p); count += 1
            
        db.session.commit()
        flash(f"{count}ê°œì˜ ìƒí’ˆì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."); return redirect('/admin')
    except Exception as e: 
        db.session.rollback()
        flash(f"ì—…ë¡œë“œ ì‹¤íŒ¨: {str(e)}"); return redirect('/admin')
        db.session.commit()
        flash(f"{count}ê°œì˜ ìƒí’ˆì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."); return redirect('/admin')
    except Exception as e: 
        db.session.rollback()
        flash(f"ì—…ë¡œë“œ ì‹¤íŒ¨: {str(e)}"); return redirect('/admin')

@admin_bp.route('/admin/board/restaurant-request/<int:rid>/comment', methods=['POST'])
@login_required
def admin_restaurant_request_comment(rid):
    """ê´€ë¦¬ì: ì „êµ­ë§›ì§‘ìš”ì²­ ê¸€ì— ëŒ“ê¸€(admin_notes) ì €ì¥. ìƒì„¸ í˜ì´ì§€ì— ë…¸ì¶œ."""
    if not current_user.is_admin:
        return redirect('/')
    r = RestaurantRequest.query.get_or_404(rid)
    r.admin_notes = (request.form.get('admin_notes') or '').strip() or None
    db.session.commit()
    flash("ê´€ë¦¬ì ëŒ“ê¸€ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
    return redirect('/admin?tab=restaurant_request')


@admin_bp.route('/admin/board/restaurant-request/<int:rid>/hide', methods=['POST'])
@login_required
def admin_restaurant_request_hide(rid):
    if not current_user.is_admin:
        return redirect('/')
    r = RestaurantRequest.query.get_or_404(rid)
    r.is_hidden = not r.is_hidden
    db.session.commit()
    flash("ìˆ¨ê¹€ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤." if r.is_hidden else "ë‹¤ì‹œ ë…¸ì¶œë©ë‹ˆë‹¤.")
    return redirect('/admin?tab=restaurant_request')


@login_required
def admin_delivery_request_comment(did):
    """ê´€ë¦¬ì: ë°°ì†¡ìš”ì²­ ê¸€ì— ëŒ“ê¸€(admin_notes) ì €ì¥. ìƒì„¸ í˜ì´ì§€ì— ë…¸ì¶œ."""
    if not current_user.is_admin:
        return redirect('/')
    r = DeliveryRequest.query.get_or_404(did)
    r.admin_notes = (request.form.get('admin_notes') or '').strip() or None
    db.session.commit()
    flash("ê´€ë¦¬ì ëŒ“ê¸€ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
    return redirect('/admin?tab=delivery_request')


@login_required
def admin_delivery_request_hide(did):
    if not current_user.is_admin:
        return redirect('/')
    r = DeliveryRequest.query.get_or_404(did)
    r.is_hidden = not r.is_hidden
    db.session.commit()
    flash("ìˆ¨ê¹€ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤." if r.is_hidden else "ë‹¤ì‹œ ë…¸ì¶œë©ë‹ˆë‹¤.")
    return redirect('/admin?tab=delivery_request')


@admin_bp.route('/admin/board/partnership/<int:pid>/comment', methods=['POST'])
@login_required
def admin_partnership_comment(pid):
    """ê´€ë¦¬ì: ì œíœ´ë¬¸ì˜ì— ëŒ“ê¸€(admin_notes) ì €ì¥. ê¸€ì“´ì´ê°€ ìƒì„¸ì—ì„œ í™•ì¸ ê°€ëŠ¥."""
    if not current_user.is_admin:
        return redirect('/')
    p = PartnershipInquiry.query.get_or_404(pid)
    p.admin_notes = (request.form.get('admin_notes') or '').strip() or None
    db.session.commit()
    flash("ê´€ë¦¬ì ëŒ“ê¸€ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
    return redirect('/admin?tab=partnership')


@login_required
def admin_partnership_hide(pid):
    if not current_user.is_admin:
        return redirect('/')
    p = PartnershipInquiry.query.get_or_404(pid)
    p.is_hidden = not p.is_hidden
    db.session.commit()
    flash("ìˆ¨ê¹€ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤." if p.is_hidden else "ë‹¤ì‹œ ë…¸ì¶œë©ë‹ˆë‹¤.")
    return redirect('/admin?tab=partnership')


@login_required
def admin_email_setup():
    """ì´ë©”ì¼ í‚¤(ë¹„ë°€ë²ˆí˜¸) ë°›ëŠ” ë°©ë²• ì•ˆë‚´. ê´€ë¦¬ì ì „ìš©."""
    if not current_user.is_admin:
        return redirect('/')
    configured = bool(MAIL_SERVER and MAIL_USERNAME and MAIL_PASSWORD)
    try:
        with open(os.path.join(os.path.dirname(__file__), "EMAIL_SETUP.md"), "r", encoding="utf-8") as f:
            guide = f.read()
    except Exception:
        guide = "EMAIL_SETUP.md íŒŒì¼ì„ ì°¸ê³ í•˜ì„¸ìš”. Gmail: ì•± ë¹„ë°€ë²ˆí˜¸, Naver: SMTP ì‚¬ìš© ì„¤ì • í›„ MAIL_* í™˜ê²½ë³€ìˆ˜ ì„¤ì •."
    return render_template_string(
        _header_html() + """
        <div class="max-w-3xl mx-auto px-4 py-12">
            <a href="/admin?tab=email_order" class="text-gray-400 hover:text-teal-600 text-sm font-bold mb-6 inline-block">â† emailë°œì£¼</a>
            <h1 class="text-2xl font-black text-gray-800 mb-2">ì´ë©”ì¼ ë°œì†¡ ì„¤ì • ì•ˆë‚´</h1>
            <p class="text-sm text-gray-500 mb-4">íŒë§¤ì ë°œì£¼ ë©”ì¼ ë°œì†¡ì„ ìœ„í•´ SMTP ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ì•„ë˜ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ í™˜ê²½ ë³€ìˆ˜ì— ë„£ì–´ ì£¼ì„¸ìš”.</p>
            <div class="mb-6 p-4 rounded-2xl {{ 'bg-teal-50 border border-teal-200' if configured else 'bg-amber-50 border border-amber-200' }}">
                <p class="font-black {{ 'text-teal-800' if configured else 'text-amber-800' }}">í˜„ì¬ ìƒíƒœ: {{ 'ì„¤ì •ë¨ (MAIL_SERVER, MAIL_USERNAME, MAIL_PASSWORD)' if configured else 'ë¯¸ì„¤ì • â€” MAIL_SERVER, MAIL_USERNAME, MAIL_PASSWORD í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ì„¸ìš”.' }}</p>
            </div>
            <div class="bg-white rounded-2xl border border-gray-100 p-6 whitespace-pre-wrap text-sm font-medium text-gray-700">{{ guide }}</div>
        </div>
        """ + _footer_html(),
        guide=guide,
        configured=configured
    )


def _get_email_order_lines(category_name, order_date):
    """í•´ë‹¹ ì¹´í…Œê³ ë¦¬Â·ì¼ìì˜ ë°œì£¼ í’ˆëª© ëª©ë¡ (ê²°ì œ í’ˆëª©ë„˜ë²„ë³„ 1ê±´). íŒë§¤ì‹œê°, í’ˆëª…, ìˆ˜ëŸ‰, ê¸ˆì•¡í•©ê³„, VAT, ë°œì£¼ìƒíƒœ."""
    start_dt = datetime.combine(order_date, datetime.min.time())
    end_dt = datetime.combine(order_date, datetime.max.time().replace(microsecond=0))
    items = db.session.query(OrderItem, Order, Settlement).join(
        Order, OrderItem.order_id == Order.id
    ).outerjoin(Settlement, Settlement.order_item_id == OrderItem.id).filter(
        Order.status != 'ê²°ì œì·¨ì†Œ',
        OrderItem.cancelled == False,
        OrderItem.product_category == category_name,
        Order.created_at >= start_dt,
        Order.created_at <= end_dt
    ).order_by(Order.created_at.asc(), OrderItem.id.asc()).all()
    status_map = {}
    for e in EmailOrderLineStatus.query.filter(
        EmailOrderLineStatus.order_item_id.in_([x[0].id for x in items])
    ).all():
        status_map[e.order_item_id] = e.status
    result = []
    for oi, ord, st in items:
        sale_dt = (st.sale_dt if st else ord.created_at) or ord.created_at
        settlement_no = (st.settlement_no if st else None) or ("N" + str(oi.id).zfill(10))
        total = oi.price * oi.quantity
        vat_label = (getattr(oi, 'tax_type', None) or 'ê³¼ì„¸') == 'ë©´ì„¸' and 'ë©´ì„¸' or 'ê³¼ì„¸'
        result.append({
            'order_item_id': oi.id,
            'sale_dt': sale_dt,
            'settlement_no': settlement_no,
            'product_name': oi.product_name,
            'quantity': oi.quantity,
            'amount_total': total,
            'vat_label': vat_label,
            'status': status_map.get(oi.id, 'ëŒ€ê¸°'),
        })
    return result


def _build_order_items_text(category_name, order_date):
    """í•´ë‹¹ ì¹´í…Œê³ ë¦¬Â·ì¼ìì˜ ë°œì£¼ í’ˆëª© í…ìŠ¤íŠ¸ (íŒë§¤ì‹œê°Â·í’ˆëª©Â·ê·œê²©Â·ìˆ˜ëŸ‰Â·ê¸ˆì•¡í•©ê³„Â·VAT)."""
    lines_data = _get_email_order_lines(category_name, order_date)
    if not lines_data:
        return "í•´ë‹¹ ì¼ì ë°œì£¼ í’ˆëª© ì—†ìŒ"
    oi_ids = [x['order_item_id'] for x in lines_data]
    order_items = OrderItem.query.filter(OrderItem.id.in_(oi_ids)).all()
    oi_map = {oi.id: oi for oi in order_items}
    products = Product.query.filter(Product.id.in_([oi.product_id for oi in order_items])).all()
    p_map = {p.id: (p.spec or "-") for p in products}
    lines = ["íŒë§¤ì‹œê°\tí’ˆëª©\tê·œê²©\tìˆ˜ëŸ‰\të‹¨ê°€\tê¸ˆì•¡í•©ê³„\tVAT"]
    for row in lines_data:
        oi = oi_map.get(row['order_item_id'])
        spec = p_map.get(oi.product_id, "-") if oi else "-"
        sale_str = row['sale_dt'].strftime('%Y-%m-%d %H:%M') if row.get('sale_dt') else '-'
        price_str = f"{oi.price:,}" if oi else "-"
        lines.append(f"{sale_str}\t{row['product_name']}\t{spec}\t{row['quantity']}\t{price_str}\t{row['amount_total']:,}\t{row['vat_label']}")
    return "\n".join(lines)


@admin_bp.route('/admin/seller/order_preview', methods=['GET'])
@login_required
def admin_seller_order_preview():
    """ë°œì£¼ ì–‘ì‹ ë¯¸ë¦¬ë³´ê¸° (ì´ë©”ì¼ ë¯¸ë°œì†¡). category_id, order_date, to_email(ì„ íƒ) ë°›ì•„ subject/body ë°˜í™˜."""
    if not current_user.is_admin:
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    category_id = request.args.get("category_id", type=int)
    order_date_str = (request.args.get("order_date") or "").strip() or datetime.now().strftime("%Y-%m-%d")
    try:
        order_date = datetime.strptime(order_date_str, "%Y-%m-%d").date()
    except Exception:
        order_date = datetime.now().date()
    cat = Category.query.get(category_id)
    if not cat:
        return jsonify({"success": False, "message": "ì¹´í…Œê³ ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 400
    items_text = _build_order_items_text(cat.name, order_date)
    base_url = (os.getenv("SITE_URL") or request.url_root or "").rstrip("/")
    body = f"""ì˜¤ëŠ˜ ë°œì£¼ í’ˆëª©ì…ë‹ˆë‹¤.

ë°œì£¼ ì¼ì: {order_date}

{items_text}

---
ã€ë°œì£¼ í™•ì¸ã€‘
ì•„ë˜ ë§í¬ë¥¼ í´ë¦­í•˜ì‹œë©´ ë°œì£¼ í™•ì¸ì´ ì™„ë£Œë˜ë©°, ê´€ë¦¬ìì—ê²Œ í™•ì¸ ë©”ì‹œì§€ê°€ ì „ì†¡ë©ë‹ˆë‹¤.
(ë°œì†¡ ì‹œ í™•ì¸ ë§í¬Â·ì½”ë“œê°€ ì±„ì›Œì§‘ë‹ˆë‹¤)

ë‚´ ë°œì£¼ ëª©ë¡(ë¡œê·¸ì¸ í›„ í™•ì¸): {base_url}/seller/orders
"""
    subject = f"[ë°”êµ¬ë‹ˆì‚¼ì´Œ] ë°œì£¼ í’ˆëª© ì•ˆë‚´ ({cat.name}) {order_date}"
    return jsonify({"success": True, "subject": subject, "body": body, "items_text": items_text})


@admin_bp.route('/admin/seller/send_manual_email', methods=['POST'])
@login_required
def admin_seller_send_manual_email():
    """ìˆ˜ê¸° ì´ë©”ì¼ ë°œì†¡ (ë™ì¼ ë°œì£¼ ì–‘ì‹ìœ¼ë¡œ ì§ì ‘ ì…ë ¥í•˜ì—¬ ë°œì†¡)."""
    if not current_user.is_admin:
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    data = request.get_json() or request.form
    to_email = (data.get("to_email") or "").strip()
    subject = (data.get("subject") or "").strip()
    body = (data.get("body") or "").strip()
    if not to_email or "@" not in to_email:
        return jsonify({"success": False, "message": "ìˆ˜ì‹  ì´ë©”ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."}), 400
    if not subject:
        return jsonify({"success": False, "message": "ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."}), 400
    try:
        send_mail(to_email, subject, body)
    except Exception as e:
        return jsonify({"success": False, "message": str(e) or "ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨."}), 500
    return jsonify({"success": True, "message": "ì´ë©”ì¼ì„ ë°œì†¡í–ˆìŠµë‹ˆë‹¤."})


@admin_bp.route('/admin/seller/send_order_email', methods=['POST'])
@login_required
def admin_seller_send_order_email():
    """íŒë§¤ì(ì¹´í…Œê³ ë¦¬)ì—ê²Œ ë°œì£¼ ì´ë©”ì¼ ë°œì†¡. í™•ì¸ì½”ë“œ ìƒì„±Â·ì €ì¥ í›„ ì´ë©”ì¼ ë³¸ë¬¸ì— í™•ì¸ ë§í¬/ì½”ë“œ í¬í•¨."""
    if not current_user.is_admin:
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    data = request.get_json() or request.form
    category_id = data.get("category_id", type=int)
    order_date_str = (data.get("order_date") or "").strip() or datetime.now().strftime("%Y-%m-%d")
    try:
        order_date = datetime.strptime(order_date_str, "%Y-%m-%d").date()
    except Exception:
        order_date = datetime.now().date()
    cat = Category.query.get(category_id)
    if not cat:
        return jsonify({"success": False, "message": "ì¹´í…Œê³ ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 400
    to_email = (data.get("to_email") or "").strip() or (cat.manager_email or "").strip()
    if not to_email or "@" not in to_email:
        return jsonify({"success": False, "message": "ìˆ˜ì‹  ì´ë©”ì¼ì„ ì…ë ¥í•˜ê±°ë‚˜ ì¹´í…Œê³ ë¦¬ì— íŒë§¤ì ì´ë©”ì¼ì„ ë“±ë¡í•˜ì„¸ìš”."}), 400
    import random
    import string
    code = "".join(random.choices(string.digits, k=6))
    while SellerOrderConfirmation.query.filter_by(confirmation_code=code).first():
        code = "".join(random.choices(string.digits, k=6))
    conf = SellerOrderConfirmation(
        category_id=cat.id,
        category_name=cat.name,
        confirmation_code=code,
        order_date=order_date,
        recipient_email=to_email,
    )
    db.session.add(conf)
    db.session.flush()
    # ê²°ì œ í’ˆëª©ë„˜ë²„ë³„ ë°œì£¼ìƒíƒœ í–‰ ìƒì„±/ê°±ì‹  (ë°œì†¡ì™„ë£Œ)
    order_lines = _get_email_order_lines(cat.name, order_date)
    for row in order_lines:
        ex = EmailOrderLineStatus.query.filter_by(order_item_id=row['order_item_id']).first()
        if ex:
            ex.status = 'ë°œì†¡ì™„ë£Œ'
            ex.confirmation_id = conf.id
        else:
            db.session.add(EmailOrderLineStatus(order_item_id=row['order_item_id'], status='ë°œì†¡ì™„ë£Œ', confirmation_id=conf.id))
    db.session.commit()
    items_text = _build_order_items_text(cat.name, order_date)
    base_url = (os.getenv("SITE_URL") or request.url_root or "").rstrip("/")
    confirm_url = f"{base_url}/seller/confirm?code={code}"
    my_orders_url = f"{base_url}/seller/orders"
    body = f"""ì˜¤ëŠ˜ ë°œì£¼ í’ˆëª©ì…ë‹ˆë‹¤.

ë°œì£¼ ì¼ì: {order_date}

{items_text}

---
ã€ë°œì£¼ í™•ì¸ã€‘
ì•„ë˜ ë§í¬ë¥¼ í´ë¦­í•˜ì‹œë©´ ë°œì£¼ í™•ì¸ì´ ì™„ë£Œë˜ë©°, ê´€ë¦¬ìì—ê²Œ í™•ì¸ ë©”ì‹œì§€ê°€ ì „ì†¡ë©ë‹ˆë‹¤.
í™•ì¸ ë§í¬: {confirm_url}
í™•ì¸ì½”ë“œ(ë§í¬ ì ‘ì†ì´ ì–´ë ¤ìš¸ ë•Œ): {code}

ë‚´ ë°œì£¼ ëª©ë¡(ë¡œê·¸ì¸ í›„ í™•ì¸): {my_orders_url}
"""
    subject = f"[ë°”êµ¬ë‹ˆì‚¼ì´Œ] ë°œì£¼ í’ˆëª© ì•ˆë‚´ ({cat.name}) {order_date}"
    try:
        send_mail(to_email, subject, body)
    except Exception as e:
        db.session.rollback()
        return jsonify({"success": False, "message": str(e) or "ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨. ì´ë©”ì¼ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”."}), 500
    return jsonify({
        "success": True,
        "message": "ì´ë©”ì¼ì„ ë°œì†¡í–ˆìŠµë‹ˆë‹¤.",
        "confirmation_code": code,
        "confirm_url": confirm_url,
    })


@admin_bp.route('/admin/backup/run', methods=['POST'])
@login_required
def admin_backup_run():
    """ê´€ë¦¬ì: ìˆ˜ë™ ë°±ì—… ì‹¤í–‰ (SQLite â†’ zip â†’ GitHub Release ë˜ëŠ” ë¡œì»¬)."""
    if not current_user.is_admin:
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    ok, msg = run_backup()
    if ok:
        return jsonify({"success": True, "message": msg})
    return jsonify({"success": False, "message": msg}), 500


@admin_bp.route('/admin/backup/cron')
def admin_backup_cron():
    """ì™¸ë¶€ cronì—ì„œ í˜¸ì¶œ (í•œêµ­ì‹œê°„ ìƒˆë²½ 4ì‹œ ë“±). ì¿¼ë¦¬ key=BACKUP_CRON_SECRET ê³¼ ì¼ì¹˜í•´ì•¼ í•¨."""
    key = (request.args.get("key") or "").strip()
    secret = os.getenv("BACKUP_CRON_SECRET", "").strip()
    if not secret or key != secret:
        return "Unauthorized", 401
    ok, msg = run_backup()
    return jsonify({"success": ok, "message": msg})


@admin_bp.route('/admin/review/delete/<int:rid>')
@login_required
def admin_review_delete(rid):
    if not (current_user.is_admin or Category.query.filter_by(manager_email=current_user.email).first()):
        return redirect('/')
    r = Review.query.get_or_404(rid)
    db.session.delete(r)
    db.session.commit()
    flash("ë¦¬ë·°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")
    return redirect('/admin?tab=reviews')

# --------------------------------------------------------------------------------
# 7-2. í…ŒìŠ¤íŠ¸ ì¹´í…Œê³ ë¦¬ 3ê°œ + ê°€ìƒ ìƒí’ˆ 10ê°œì”© ì‹œë“œ (ì „ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ìš©)
# --------------------------------------------------------------------------------
def _seed_test_categories_and_products():
    """í…ŒìŠ¤íŠ¸ ì¹´í…Œê³ ë¦¬ 3ê°œì™€ ì¹´í…Œê³ ë¦¬ë‹¹ ê°€ìƒ ìƒí’ˆ 10ê°œ ìƒì„±. ë“±ë¡ ê¸°ëŠ¥ ì „ í•„ë“œ í™œìš©."""
    now = datetime.now()
    today_evening = now.replace(hour=20, minute=0, second=0, microsecond=0)
    tomorrow = (now + timedelta(days=1)).replace(hour=18, minute=0, second=0, microsecond=0)
    categories_data = [
        {"name": "í…ŒìŠ¤íŠ¸-ì±„ì†Œ", "description": "í…ŒìŠ¤íŠ¸ìš© ì±„ì†Œ ì¹´í…Œê³ ë¦¬ (ìƒí’ˆ ë“±ë¡Â·ìˆ˜ì •Â·ë°°ì§€Â·ë§ˆê° í…ŒìŠ¤íŠ¸)", "order": 900},
        {"name": "í…ŒìŠ¤íŠ¸-ê³¼ì¼", "description": "í…ŒìŠ¤íŠ¸ìš© ê³¼ì¼ ì¹´í…Œê³ ë¦¬", "order": 901},
        {"name": "í…ŒìŠ¤íŠ¸-ìˆ˜ì‚°", "description": "í…ŒìŠ¤íŠ¸ìš© ìˆ˜ì‚° ì¹´í…Œê³ ë¦¬", "order": 902},
    ]
    for cdata in categories_data:
        if not Category.query.filter_by(name=cdata["name"]).first():
            db.session.add(Category(name=cdata["name"], description=cdata["description"], order=cdata["order"], tax_type="ê³¼ì„¸"))
    db.session.commit()

    products_data = []
    # í…ŒìŠ¤íŠ¸-ì±„ì†Œ 10ì¢…: description(ë‹¹ì¼/+1/+2), badge(ì˜¤ëŠ˜ë§ˆê°/ì‚¼ì´Œì¶”ì²œ/ì—†ìŒ), deadline(ì˜¤ëŠ˜/ë‚´ì¼/ì—†ìŒ), stock ë‹¤ì–‘
    veg_names = ["ì²­ê²½ì±„ 1ë‹¨", "ìƒì¶” 2ì¢… ëª¨ë‘ ", "ê¹»ì 1ë‹¨", "ì‹œê¸ˆì¹˜ 1ë‹¨", "ë¸Œë¡œì½œë¦¬ 1ì†¡ì´", "ë‹¹ê·¼ 1kg", "ì–‘íŒŒ 2kg", "ëŒ€íŒŒ 3ëŒ€", "ìª½íŒŒ 1ë‹¨", "ë¯¸ë‚˜ë¦¬ 1ë‹¨"]
    for i, name in enumerate(veg_names):
        products_data.append({
            "category": "í…ŒìŠ¤íŠ¸-ì±„ì†Œ", "name": name, "description": ["ë‹¹ì¼ë°°ì†¡", "+1ì¼", "+2ì¼", "+3ì¼"][i % 4],
            "price": [3500, 4500, 2800, 3200, 2200, 4000, 3500, 1500, 1800, 2500][i],
            "spec": ["1ë‹¨", "1íŒ©", "1ë‹¨", "1ë‹¨", "1ì†¡ì´", "1kg", "2kg", "3ëŒ€", "1ë‹¨", "1ë‹¨"][i],
            "origin": "êµ­ì‚°", "farmer": "ë°”êµ¬ë‹ˆì‚¼ì´Œ", "stock": [5, 10, 20, 15, 30, 50, 40, 99, 10, 8][i],
            "deadline": today_evening if i % 3 == 0 else (tomorrow if i % 3 == 1 else None),
            "badge": ["ì˜¤ëŠ˜ë§ˆê°", "ì‚¼ì´Œì¶”ì²œ", ""][i % 3], "image_url": f"https://placehold.co/400x400/dcfce7/166534?text=V{i+1}",
            "detail_image_url": f"https://placehold.co/600x400/bbf7d0/166534?text={name[:4]}",
        })
    # í…ŒìŠ¤íŠ¸-ê³¼ì¼ 10ì¢…
    fruit_names = ["ì‚¬ê³¼ 2kg", "ë°° 1.5kg", "í¬ë„ 1kg", "ê·¤ 2kg", "ìˆ˜ë°• 1í†µ", "ì°¸ì™¸ 2kg", "ë³µìˆ­ì•„ 1kg", "ë¸”ë£¨ë² ë¦¬ 125g", "ë”¸ê¸° 500g", "ë°”ë‚˜ë‚˜ 1kg"]
    for i, name in enumerate(fruit_names):
        products_data.append({
            "category": "í…ŒìŠ¤íŠ¸-ê³¼ì¼", "name": name, "description": ["+1ì¼", "+2ì¼", "ë‹¹ì¼ë°°ì†¡", "+3ì¼"][i % 4],
            "price": [12000, 15000, 8000, 9000, 18000, 14000, 11000, 6500, 12000, 4500][i],
            "spec": ["2kg", "1.5kg", "1kg", "2kg", "1í†µ", "2kg", "1kg", "125g", "500g", "1kg"][i],
            "origin": "êµ­ì‚°", "farmer": "ë°”êµ¬ë‹ˆì‚¼ì´Œ", "stock": [20, 15, 30, 40, 10, 25, 18, 50, 12, 60][i],
            "deadline": tomorrow if i % 2 == 0 else None, "badge": ["ì‚¼ì´Œì¶”ì²œ", "", "ì˜¤ëŠ˜ë§ˆê°"][i % 3],
            "image_url": f"https://placehold.co/400x400/fef3c7/d97706?text=F{i+1}",
            "detail_image_url": f"https://placehold.co/600x400/fde68a/d97706?text={name[:4]}",
        })
    # í…ŒìŠ¤íŠ¸-ìˆ˜ì‚° 10ì¢…
    fish_names = ["ê³ ë“±ì–´ 2ë§ˆë¦¬", "ê°ˆì¹˜ 1kg", "ë™íƒœ 1ë§ˆë¦¬", "ìƒˆìš° 300g", "ì˜¤ì§•ì–´ 1ë§ˆë¦¬", "ë¬¸ì–´ 1ë§ˆë¦¬", "ì—°ì–´ 200g", "ì°¸ì¹˜ìº” 3ìº”", "ë©¸ì¹˜ 100g", "ê¹€ 10ì¥"]
    for i, name in enumerate(fish_names):
        products_data.append({
            "category": "í…ŒìŠ¤íŠ¸-ìˆ˜ì‚°", "name": name, "description": ["+1ì¼", "+2ì¼", "+3ì¼", "ë‹¹ì¼ë°°ì†¡"][i % 4],
            "price": [8000, 12000, 6500, 15000, 9000, 18000, 7000, 4500, 3500, 4000][i],
            "spec": ["2ë§ˆë¦¬", "1kg", "1ë§ˆë¦¬", "300g", "1ë§ˆë¦¬", "1ë§ˆë¦¬", "200g", "3ìº”", "100g", "10ì¥"][i],
            "origin": "êµ­ì‚°/ìˆ˜ì…", "farmer": "ë°”êµ¬ë‹ˆì‚¼ì´Œ", "stock": [10, 8, 25, 15, 12, 5, 30, 50, 40, 20][i],
            "deadline": today_evening if i % 4 == 0 else (tomorrow if i % 4 == 1 else None),
            "badge": ["", "ì˜¤ëŠ˜ë§ˆê°", "ì‚¼ì´Œì¶”ì²œ", ""][i % 4],
            "image_url": f"https://placehold.co/400x400/dbeafe/1d4ed8?text=S{i+1}",
            "detail_image_url": f"https://placehold.co/600x400/bfdbfe/1d4ed8?text={name[:4]}",
        })

    # ë§ˆê°ì‹œê°„ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ìš© ê°€ìƒ ìƒí’ˆ: í˜„ì¬ì‹œê° + 15ë¶„ ë§ˆê° (í…ŒìŠ¤íŠ¸-ì±„ì†Œì— 1ì¢…)
    deadline_test_at = now + timedelta(minutes=15)
    if not Product.query.filter_by(category="í…ŒìŠ¤íŠ¸-ì±„ì†Œ", name="ë§ˆê°í…ŒìŠ¤íŠ¸-ê°€ìƒìƒí’ˆ").first():
        products_data.append({
            "category": "í…ŒìŠ¤íŠ¸-ì±„ì†Œ", "name": "ë§ˆê°í…ŒìŠ¤íŠ¸-ê°€ìƒìƒí’ˆ", "description": "ë‹¹ì¼ë°°ì†¡",
            "price": 1000, "spec": "1ê°œ", "origin": "ë§ˆê° ì¹´ìš´íŠ¸ë‹¤ìš´ í…ŒìŠ¤íŠ¸ìš©", "farmer": "ë°”êµ¬ë‹ˆì‚¼ì´Œ",
            "stock": 99, "deadline": deadline_test_at, "badge": "ì˜¤ëŠ˜ë§ˆê°",
            "image_url": "https://placehold.co/400x400/fecaca/dc2626?text=ë§ˆê°í…ŒìŠ¤íŠ¸",
            "detail_image_url": "https://placehold.co/600x400/fecaca/dc2626?text=ë§ˆê°í…ŒìŠ¤íŠ¸",
        })

    created = 0
    for pdata in products_data:
        exists = Product.query.filter_by(category=pdata["category"], name=pdata["name"]).first()
        if not exists:
            p = Product(
                category=pdata["category"], name=pdata["name"], description=pdata["description"],
                price=pdata["price"], spec=pdata["spec"], origin=pdata["origin"], farmer=pdata["farmer"],
                stock=pdata["stock"], deadline=pdata["deadline"], badge=pdata.get("badge", ""),
                image_url=pdata["image_url"], detail_image_url=pdata.get("detail_image_url", pdata["image_url"]),
                is_active=True, tax_type="ê³¼ì„¸"
            )
            db.session.add(p)
            created += 1
    db.session.commit()
    return created


def _seed_virtual_reviews_per_product(count_per_product=10):
    """ìƒí’ˆë³„ ê°€ìƒ êµ¬ë§¤ í›„ê¸° count_per_productê°œì”© ìƒì„±. order_idëŠ” ê°€ìƒ ê³ ìœ ê°’(ìŒìˆ˜) ì‚¬ìš©."""
    reviews_content = [
        "ë§›ìˆê³  ì‹ ì„ í•´ìš”. ë‹¤ìŒì—ë„ ì£¼ë¬¸í• ê²Œìš”!",
        "ë°°ì†¡ ë¹¨ë¼ì„œ ì¢‹ì•˜ì–´ìš”. í’ˆì§ˆë„ ë§Œì¡±í•©ë‹ˆë‹¤.",
        "ìƒê°ë³´ë‹¤ ì–‘ ë§ê³  ê°€ì„±ë¹„ ì¢‹ì•„ìš”.",
        "ì¹œêµ¬ ì¶”ì²œìœ¼ë¡œ ì²˜ìŒ ì£¼ë¬¸í–ˆëŠ”ë° ëŒ€ë§Œì¡±ì…ë‹ˆë‹¤.",
        "í¬ì¥ ê¼¼ê¼¼í•˜ê³  ìƒíƒœ ì¢‹ì•˜ì–´ìš”. ì¶”ì²œí•©ë‹ˆë‹¤.",
        "ë§›ì´ ì¢‹ì•„ì„œ ìì£¼ ì‹œì¼œë¨¹ì„ ê²ƒ ê°™ì•„ìš”.",
        "ë‹¹ì¼ ë°›ì•„ì„œ ë„ˆë¬´ ë§Œì¡±ìŠ¤ëŸ¬ì›Œìš”.",
        "ê°€ê²© ëŒ€ë¹„ í€„ë¦¬í‹° ì¢‹ìŠµë‹ˆë‹¤. ê°ì‚¬í•´ìš”.",
        "ì‹ ì„ í•˜ê³  ë§›ìˆì–´ìš”. ì¬ì£¼ë¬¸ ì˜ì‚¬ ìˆìŠµë‹ˆë‹¤.",
        "ì„œë¹„ìŠ¤ë„ ì¢‹ê³  ìƒí’ˆë„ ë§Œì¡±í•©ë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.",
    ]
    user_names = ["ê¹€**", "ì´**", "ë°•**", "ìµœ**", "ì •**", "ê°•**", "ì¡°**", "ìœ¤**", "ì¥**", "í•œ**"]
    products = Product.query.filter_by(is_active=True).all()
    cat_ids = {}
    created = 0
    for p in products:
        if p.category and p.category not in cat_ids:
            c = Category.query.filter_by(name=p.category).first()
            cat_ids[p.category] = c.id if c else None
        category_id = cat_ids.get(p.category)
        existing = Review.query.filter_by(product_id=p.id).count()
        to_add = max(0, count_per_product - existing)
        for j in range(to_add):
            # ê°€ìƒ order_id: ìŒìˆ˜ë¡œ ì‹¤ì£¼ë¬¸ê³¼ êµ¬ë¶„, ìƒí’ˆë³„Â·ìˆœë²ˆë³„ ê³ ìœ  (ê¸°ì¡´ í›„ê¸° ìˆ˜ + j)
            virtual_order_id = -(p.id * 1000 + existing + j)
            if Review.query.filter_by(order_id=virtual_order_id).first():
                continue
            content = reviews_content[j % len(reviews_content)]
            uname = user_names[j % len(user_names)]
            img = f"https://placehold.co/400x400/e0f2fe/1e40af?text=í›„ê¸°"
            r = Review(
                order_id=virtual_order_id,
                user_id=0,
                user_name=uname,
                product_id=p.id,
                product_name=p.name[:100] if p.name else "",
                category_id=category_id,
                content=content,
                image_url=img,
            )
            db.session.add(r)
            created += 1
    if created:
        db.session.commit()
    return created


@admin_bp.route('/admin/seed_test_data')
@login_required
def admin_seed_test_data():
    """í…ŒìŠ¤íŠ¸ ì¹´í…Œê³ ë¦¬ 3ê°œ + ê°€ìƒ ìƒí’ˆ 10ê°œì”© ìƒì„± (ê´€ë¦¬ì ì „ìš©)."""
    if not current_user.is_admin:
        return redirect('/')
    created = _seed_test_categories_and_products()
    flash(f"í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì™„ë£Œ. ìƒˆë¡œ ë“±ë¡ëœ ìƒí’ˆ {created}ê±´ (ì¹´í…Œê³ ë¦¬Â·ê¸°ì¡´ ìƒí’ˆì€ ì¤‘ë³µ ìƒì„± ì•ˆ í•¨).")
    return redirect('/admin')


def _delete_test_categories_and_products():
    """í…ŒìŠ¤íŠ¸ ì¹´í…Œê³ ë¦¬(í…ŒìŠ¤íŠ¸-ì±„ì†Œ/ê³¼ì¼/ìˆ˜ì‚°)ì™€ í•´ë‹¹ ìƒí’ˆ ì „ë¶€ ì‚­ì œ. ì‚­ì œëœ ìƒí’ˆ ìˆ˜ ë°˜í™˜."""
    test_cat_names = ["í…ŒìŠ¤íŠ¸-ì±„ì†Œ", "í…ŒìŠ¤íŠ¸-ê³¼ì¼", "í…ŒìŠ¤íŠ¸-ìˆ˜ì‚°"]
    deleted_products = Product.query.filter(Product.category.in_(test_cat_names)).all()
    deleted_count = len(deleted_products)
    pids = [p.id for p in deleted_products]
    if pids:
        Review.query.filter(Review.product_id.in_(pids)).delete(synchronize_session=False)
    for p in deleted_products:
        db.session.delete(p)
    for name in test_cat_names:
        cat = Category.query.filter_by(name=name).first()
        if cat:
            db.session.delete(cat)
    db.session.commit()
    return deleted_count


@admin_bp.route('/admin/delete_test_data')
@login_required
def admin_delete_test_data():
    """í…ŒìŠ¤íŠ¸ ì¹´í…Œê³ ë¦¬ ë° í•´ë‹¹ ìƒí’ˆ ì „ë¶€ ì‚­ì œ (ê´€ë¦¬ì ì „ìš©)."""
    if not current_user.is_admin:
        return redirect('/')
    deleted = _delete_test_categories_and_products()
    flash(f"í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ ì™„ë£Œ. ìƒí’ˆ {deleted}ê±´ ë° í…ŒìŠ¤íŠ¸ ì¹´í…Œê³ ë¦¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")
    return redirect('/admin')


@admin_bp.route('/admin/seed_virtual_reviews')
@login_required
def admin_seed_virtual_reviews():
    """ìƒí’ˆë³„ ê°€ìƒ êµ¬ë§¤ í›„ê¸° 10ê°œì”© ìƒì„± (ê´€ë¦¬ì ì „ìš©)."""
    if not current_user.is_admin:
        return redirect('/')
    created = _seed_virtual_reviews_per_product(10)
    flash(f"ê°€ìƒ êµ¬ë§¤ í›„ê¸° ìƒì„± ì™„ë£Œ. ìƒˆë¡œ ë“±ë¡ëœ í›„ê¸° {created}ê±´ (ìƒí’ˆë‹¹ 10ê°œì”©, ê¸°ì¡´ í›„ê¸°ëŠ” ê±´ë„ˆëœ€).")
    return redirect('/admin?tab=reviews')


def _seed_virtual_orders(num_orders=20, days_back=10, min_items=2, max_items=3):
    """ìµœê·¼ days_back ì¼ ì´ë‚´ ê°€ìƒ ì£¼ë¬¸ num_ordersê±´ ìƒì„±. ì£¼ë¬¸ë‹¹ min_items~max_itemsê°œ í’ˆëª©. í…ŒìŠ¤íŠ¸ìš©."""
    user = User.query.filter(User.is_admin == False).first() or User.query.filter_by(is_admin=True).first()
    if not user:
        return 0
    products = Product.query.filter_by(is_active=True).limit(100).all()
    if len(products) < 2:
        return 0
    now = datetime.now()
    created_count = 0
    for i in range(num_orders):
        # ìµœê·¼ 10ì¼ ì´ë‚´ ëœë¤ ì‹œê°
        created_at = now - timedelta(days=random.uniform(0, days_back), hours=random.uniform(0, 24))
        n_items = random.randint(min_items, max_items)
        chosen = random.sample(products, min(n_items, len(products)))
        quantities = [random.randint(1, 3) for _ in chosen]
        total_price = sum(p.price * q for p, q in zip(chosen, quantities))
        delivery_fee = 3000 if total_price < 40000 else 0
        tax_free = sum(p.price * q for p, q in zip(chosen, quantities) if getattr(p, 'tax_type', None) == 'ë©´ì„¸')
        product_details = " | ".join(f"[{p.category}] {p.name}({q})" for p, q in zip(chosen, quantities))
        order_id = f"ORDER_VIRT_{now.strftime('%Y%m%d%H%M%S')}_{i}_{random.randint(1000, 9999)}"
        payment_key = f"virtual_pk_{order_id}"
        delivery_address_str = "(ì¸ì²œ ì—°ìˆ˜êµ¬ ì†¡ë„ë™ 123-45) 101ë™ 101í˜¸ (í˜„ê´€:1234)"
        order = Order(
            user_id=user.id,
            customer_name=user.name or "í…ŒìŠ¤íŠ¸ê³ ê°",
            customer_phone=user.phone or "010-0000-0000",
            customer_email=user.email or "test@test.com",
            product_details=product_details,
            total_price=total_price + delivery_fee,
            delivery_fee=delivery_fee,
            tax_free_amount=tax_free,
            status='ê²°ì œì™„ë£Œ',
            order_id=order_id,
            payment_key=payment_key,
            delivery_address=delivery_address_str,
            request_memo="",
            points_used=0,
            quick_extra_fee=0,
            created_at=created_at,
        )
        db.session.add(order)
        db.session.flush()
        for p, qty in zip(chosen, quantities):
            tax_type = getattr(p, 'tax_type', None) or 'ê³¼ì„¸'
            oi = OrderItem(
                order_id=order.id,
                product_id=p.id,
                product_name=p.name,
                product_category=p.category,
                price=p.price,
                quantity=qty,
                tax_type=tax_type,
                cancelled=False,
                item_status='ê²°ì œì™„ë£Œ',
            )
            db.session.add(oi)
            db.session.flush()
            sales_amount = p.price * qty
            fee = round(sales_amount * 0.055)
            delivery_fee_per = 990
            total = sales_amount - fee - delivery_fee_per
            settlement_no = "N" + str(oi.id).zfill(10)
            cat = Category.query.filter_by(name=p.category).first()
            tax_exempt_val = (getattr(cat, 'tax_type', None) or 'ê³¼ì„¸') == 'ë©´ì„¸'
            db.session.add(Settlement(
                settlement_no=settlement_no,
                order_id=order.id,
                order_item_id=oi.id,
                sale_dt=created_at,
                category=p.category,
                tax_exempt=tax_exempt_val,
                product_name=p.name,
                sales_amount=sales_amount,
                fee=fee,
                delivery_fee=delivery_fee_per,
                settlement_total=total,
                settlement_status='ì…ê¸ˆëŒ€ê¸°',
                settled_at=None,
            ))
        created_count += 1
    if created_count:
        db.session.commit()
    return created_count


@admin_bp.route('/admin/seed_virtual_orders')
@login_required
def admin_seed_virtual_orders():
    """ìµœê·¼ 10ì¼ ì´ë‚´ ê°€ìƒ ì£¼ë¬¸ 20ê±´ ìƒì„± (í’ˆëª© 2~3ê°œì”©, í…ŒìŠ¤íŠ¸ìš©)."""
    if not current_user.is_admin:
        return redirect('/')
    created = _seed_virtual_orders(num_orders=20, days_back=10, min_items=2, max_items=3)
    flash(f"ê°€ìƒ ì£¼ë¬¸ ìƒì„± ì™„ë£Œ. ì£¼ë¬¸ {created}ê±´ (ìµœê·¼ 10ì¼ ì´ë‚´, í’ˆëª© 2~3ê°œì”©).")
    return redirect('/admin?tab=orders')


# --------------------------------------------------------------------------------
# 8. ê°œë³„ ìƒí’ˆ ë“±ë¡/ìˆ˜ì •/ì‚­ì œ ë° ì¹´í…Œê³ ë¦¬ ê´€ë¦¬
# --------------------------------------------------------------------------------

@admin_bp.route('/admin/add', methods=['GET', 'POST'])
@login_required
def admin_product_add():
    """ê°œë³„ ìƒí’ˆ ë“±ë¡"""
    categories = Category.query.order_by(Category.order.asc(), Category.id.asc()).all()
    my_categories = [c.name for c in categories if c.manager_email == current_user.email]
    is_master = current_user.is_admin
    selectable_categories = [c for c in categories if is_master or c.name in my_categories]
    if request.method == 'POST':
        cat_name = request.form['category']
        if not check_admin_permission(cat_name): return redirect('/admin')
        main_img = save_uploaded_file(request.files.get('main_image'))
        detail_files = request.files.getlist('detail_images')
        detail_img_url_str = ",".join(filter(None, [save_uploaded_file(f) for f in detail_files if f.filename != '']))
        deadline_val = datetime.strptime(request.form['deadline'], '%Y-%m-%dT%H:%M') if request.form.get('deadline') else None
        rt = request.form.get('reset_time', '').strip()[:5] if request.form.get('reset_time') else None
        rq = request.form.get('reset_to_quantity', '').strip()
        reset_to_q = int(rq) if rq.isdigit() else None
        sp = request.form.get('supply_price', '').strip()
        supply_price = int(sp) if sp.isdigit() else None
        new_p = Product(name=request.form['name'], description=request.form['description'], category=cat_name, price=int(request.form['price']), supply_price=supply_price, spec=request.form['spec'], origin=request.form['origin'], farmer="ë°”êµ¬ë‹ˆì‚¼ì´Œ", stock=int(request.form['stock']), image_url=main_img or "", detail_image_url=detail_img_url_str, deadline=deadline_val, badge=request.form.get('badge', ''), reset_time=rt or None, reset_to_quantity=reset_to_q)
        db.session.add(new_p); db.session.commit(); return redirect('/admin')
    return render_template_string(_header_html() + """<div class="max-w-xl mx-auto py-20 px-6 font-black text-left"><h2 class="text-3xl font-black mb-12 border-l-8 border-teal-600 pl-6 uppercase italic text-left">Add Product</h2><p class="text-[11px] text-gray-500 font-bold mb-6 bg-gray-50 p-4 rounded-xl border border-gray-100">ê° í•­ëª©ì´ <strong>ëª©ë¡Â·ìƒì„¸ í˜ì´ì§€ ì–´ë””ì—</strong> ë‚˜ê°€ëŠ”ì§€: ìƒí’ˆëª…â†’ëª©ë¡ ì¹´ë“œÂ·ìƒì„¸ ì œëª© / Short Introâ†’ìƒí’ˆëª… ì˜† / Detailed Introâ†’ìƒì„¸ ì‚¬ì§„ ìœ„ / Deliveryâ†’ëª©ë¡ ë°°ì§€Â·ìƒì„¸ ë°°ì†¡ë¬¸êµ¬ / ê°€ê²©Â·ê·œê²©â†’ëª©ë¡Â·ìƒì„¸ / ì¬ê³ â†’ì”ì—¬ Nê°œ / ë§ˆê°ì¼â†’ì¹´ìš´íŠ¸ë‹¤ìš´Â·ì˜¤ëŠ˜ë§ˆê° / Main Imageâ†’ëª©ë¡Â·ëŒ€í‘œì‚¬ì§„ / Detail Imagesâ†’ìƒì„¸ ë³¸ë¬¸ ì—¬ëŸ¬ ì¥.</p><form method="POST" enctype="multipart/form-data" class="bg-white p-10 rounded-[3rem] shadow-2xl space-y-7 text-left"><select name="category" class="w-full p-5 bg-gray-50 rounded-2xl font-black outline-none focus:ring-4 focus:ring-teal-50 text-left">{% for c in selectable_categories %}<option value="{{c.name}}">{{c.name}}</option>{% endfor %}</select>
   <input name="name" placeholder="ìƒí’ˆ ëª…ì¹­ (ì˜ˆ: ê¿€ë¶€ì‚¬ ì‚¬ê³¼)" class="w-full p-5 bg-gray-50 rounded-2xl font-black text-left text-sm" value="{{ p.name if p else '' }}" required>

<div class="space-y-1">
    <label class="text-[10px] text-orange-500 font-black ml-4 uppercase tracking-widest">Short Intro (ìƒí’ˆëª… ì˜† í•œì¤„ì†Œê°œ)</label>
    <input name="badge" placeholder="ì˜ˆ: ì•„ì‚­í•˜ê³  ë‹¬ì½¤í•œ, ì‚°ì§€ì§ì†¡" class="w-full p-5 bg-orange-50 border border-orange-100 rounded-2xl font-black text-left text-sm focus:ring-4 focus:ring-orange-100 outline-none transition" value="{{ p.badge if p else '' }}">
</div>

<div class="space-y-1">
    <label class="text-[10px] text-teal-600 font-black ml-4 uppercase tracking-widest">Detailed Intro (ì‚¬ì§„ ìœ„ ë…¸ì¶œ ë¬¸êµ¬)</label>
    <input name="origin" placeholder="ìƒì„¸í˜ì´ì§€ ì‚¬ì§„ ë°”ë¡œ ìœ„ì— ë…¸ì¶œë  ë¬¸êµ¬" class="w-full p-5 bg-teal-50 border border-teal-100 rounded-2xl font-black text-left text-sm focus:ring-4 focus:ring-teal-100 outline-none transition" value="{{ p.origin if p else '' }}">
</div>

<div class="space-y-1">
    <label class="text-[10px] text-blue-600 font-black ml-4 uppercase tracking-widest">Delivery (ë°°ì†¡ ì˜ˆì •ì¼)</label>
    <select name="description" class="w-full p-5 bg-blue-50 text-blue-700 rounded-2xl font-black text-sm outline-none border-none focus:ring-4 focus:ring-blue-100">
        <option value="+1ì¼" {% if p and p.description == '+1ì¼' %}selected{% endif %}>ğŸšš ì£¼ë¬¸ ì™„ë£Œ í›„ +1ì¼ ë°°ì†¡</option>
        <option value="+2ì¼" {% if p and p.description == '+2ì¼' %}selected{% endif %}>ğŸšš ì£¼ë¬¸ ì™„ë£Œ í›„ +2ì¼ ë°°ì†¡</option>
        <option value="+3ì¼" {% if p and p.description == '+3ì¼' %}selected{% endif %}>ğŸšš ì£¼ë¬¸ ì™„ë£Œ í›„ +3ì¼ ë°°ì†¡</option>
        <option value="ë‹¹ì¼ë°°ì†¡" {% if p and p.description == 'ë‹¹ì¼ë°°ì†¡' %}selected{% endif %}>âš¡ ì†¡ë„ ì§€ì—­ ë‹¹ì¼ ë°°ì†¡</option>
    </select>
</div>
<div class="grid grid-cols-2 gap-5 text-left"><input name="price" type="number" placeholder="íŒë§¤ ê°€ê²©(ì›)" class="p-5 bg-gray-50 rounded-2xl font-black text-left text-sm" required><input name="spec" placeholder="ê·œê²© (ì˜ˆ: 5kg/1ë°•ìŠ¤)" class="p-5 bg-gray-50 rounded-2xl font-black text-left text-sm"></div>
<div class="grid grid-cols-1 gap-5 text-left"><label class="text-[10px] text-gray-400 font-black ml-4 uppercase tracking-widest">ì—…ì²´ê³µê¸‰ê°€ê²© (ì›)</label><input name="supply_price" type="number" min="0" placeholder="ì—…ì²´ê³µê¸‰ê°€ê²© (ì„ íƒ)" class="p-5 bg-gray-50 rounded-2xl font-black text-left text-sm"></div>
<div class="grid grid-cols-2 gap-5 text-left"><input name="stock" type="number" placeholder="í•œì • ìˆ˜ëŸ‰" class="p-5 bg-gray-50 rounded-2xl font-black text-left text-sm" value="50"><input name="deadline" type="datetime-local" id="add-deadline" class="p-5 bg-gray-50 rounded-2xl font-black text-left text-sm"></div>
<div id="add-reset-time-block" class="grid grid-cols-2 gap-5 text-left">
    <div><label class="text-[10px] text-amber-600 font-black ml-4 block mb-1">ì¬ê³  ì´ˆê¸°í™” ì‹œê° (ë§ˆê°ì¼ ì—†ì„ ë•Œ)</label><input name="reset_time" type="time" class="w-full p-5 bg-amber-50 rounded-2xl font-black text-left text-sm border border-amber-100" placeholder="09:00"></div>
    <div><label class="text-[10px] text-amber-600 font-black ml-4 block mb-1">ì´ˆê¸°í™” ì‹œ ë³µì› ìˆ˜ëŸ‰</label><input name="reset_to_quantity" type="number" min="0" placeholder="ì˜ˆ: 50" class="w-full p-5 bg-amber-50 rounded-2xl font-black text-left text-sm border border-amber-100"></div>
</div>
<script>(function(){ var d=document.getElementById('add-deadline'); var b=document.getElementById('add-reset-time-block'); if(d&&b){ function t(){ b.classList.toggle('hidden', !!d.value); } d.addEventListener('change',t); d.addEventListener('input',t); } })();</script>
<select name="badge" class="w-full p-5 bg-gray-50 rounded-2xl font-black text-left text-sm"><option value="">ë…¸ì¶œ ë±ƒì§€ ì—†ìŒ</option><option value="ì˜¤ëŠ˜ë§ˆê°">ğŸ”¥ ì˜¤ëŠ˜ë§ˆê°</option><option value="ì‚¼ì´Œì¶”ì²œ">â­ ì‚¼ì´Œì¶”ì²œ</option></select>
<div class="p-6 border-2 border-dashed border-gray-100 rounded-3xl text-left"><label class="text-[10px] text-gray-400 uppercase font-black block mb-4 text-left">Main Image (ëª©ë¡Â·ëŒ€í‘œ ì‚¬ì§„)</label><input type="file" name="main_image" accept="image/*" class="text-xs text-left product-image-input"></div>
<div class="p-6 border-2 border-dashed border-blue-50 rounded-3xl text-left"><label class="text-[10px] text-blue-400 uppercase font-black block mb-4 text-left">Detail Images (ìƒì„¸ ë³¸ë¬¸ ì—¬ëŸ¬ ì¥)</label><input type="file" name="detail_images" multiple accept="image/*" class="text-xs text-left product-image-input"></div>
<button type="submit" class="w-full bg-teal-600 text-white py-6 rounded-3xl font-black text-xl shadow-xl hover:bg-teal-700 transition active:scale-95 text-center admin-product-submit-btn">ìƒí’ˆ ë“±ë¡ ì™„ë£Œ</button></form></div>
<script>
(function(){
function processImageFile(file) {
  if (!file || !file.type || !file.type.match(/^image\//)) return Promise.resolve(file);
  return new Promise(function(resolve) {
    var img = new Image();
    var url = URL.createObjectURL(file);
    img.onload = function() {
      URL.revokeObjectURL(url);
      var w = img.naturalWidth, h = img.naturalHeight;
      var minSide = Math.min(w, h);
      var size = Math.min(1200, minSide);
      var canvas = document.createElement('canvas');
      canvas.width = size; canvas.height = size;
      var ctx = canvas.getContext('2d');
      var sx = (w - minSide) / 2, sy = (h - minSide) / 2;
      ctx.drawImage(img, sx, sy, minSide, minSide, 0, 0, size, size);
      canvas.toBlob(function(blob) { resolve(blob ? new File([blob], file.name || 'image.jpg', { type: 'image/jpeg' }) : file); }, 'image/jpeg', 0.82);
    };
    img.onerror = function() { URL.revokeObjectURL(url); resolve(file); };
    img.src = url;
  });
}
var form = document.querySelector('form[enctype="multipart/form-data"]');
if (form && form.action && form.action.indexOf('/admin/add') !== -1) {
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    var f = this;
    var btn = f.querySelector('.admin-product-submit-btn');
    var originalText = btn ? btn.textContent : '';
    if (btn) { btn.disabled = true; btn.textContent = 'ì €ì¥ ì¤‘...'; }
    var formData = new FormData(f);
    var mainIn = f.querySelector('input[name="main_image"]');
    if (mainIn && mainIn.files && mainIn.files[0]) {
      var p = await processImageFile(mainIn.files[0]);
      if (p) formData.set('main_image', p, p.name || 'main.jpg');
    }
    var detailIn = f.querySelector('input[name="detail_images"]');
    if (detailIn && detailIn.files && detailIn.files.length) {
      formData.delete('detail_images');
      for (var i = 0; i < detailIn.files.length; i++) {
        var q = await processImageFile(detailIn.files[i]);
        if (q) formData.append('detail_images', q, q.name || ('detail_' + i + '.jpg'));
      }
    }
    try {
      var r = await fetch(f.action, { method: 'POST', body: formData, redirect: 'follow' });
      if (r.ok) { window.location.href = r.url || '/admin'; } else { alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); if (btn) { btn.disabled = false; btn.textContent = originalText; } }
    } catch (err) { alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); if (btn) { btn.disabled = false; btn.textContent = originalText; } }
  });
}
})();
</script>
""", selectable_categories=selectable_categories, p=None)

@admin_bp.route('/admin/edit/<int:pid>', methods=['GET', 'POST'])
@login_required
def admin_product_edit(pid):
    """ê°œë³„ ìƒí’ˆ ìˆ˜ì • (ìƒí’ˆ ë“±ë¡í¼ê³¼ ë™ì¼í•œ ë””ìì¸ ë° êµ¬ì„± ì ìš©)"""
    p = Product.query.get_or_404(pid)
    if request.method == 'POST':
        # ë°ì´í„° ì—…ë°ì´íŠ¸ ë¡œì§
        p.name = request.form['name']
        p.description = request.form['description']
        p.price = int(request.form['price'])
        sp = request.form.get('supply_price', '').strip()
        p.supply_price = int(sp) if sp.isdigit() else None
        p.spec = request.form['spec']
        p.stock = int(request.form['stock'])
        p.origin = request.form['origin']
        p.badge = request.form.get('badge', '')
        p.deadline = datetime.strptime(request.form['deadline'], '%Y-%m-%dT%H:%M') if request.form.get('deadline') else None
        rt = request.form.get('reset_time', '').strip()
        p.reset_time = rt[:5] if rt else None
        rq = request.form.get('reset_to_quantity', '').strip()
        p.reset_to_quantity = int(rq) if rq.isdigit() else None
        if not p.reset_time:
            p.last_reset_at = None
        
        # ë©”ì¸ ì´ë¯¸ì§€ ë³€ê²½ ì‹œ ì²˜ë¦¬
        main_img = save_uploaded_file(request.files.get('main_image'))
        if main_img: p.image_url = main_img
        
        # ìƒì„¸ ì´ë¯¸ì§€ ë³€ê²½ ì‹œ ì²˜ë¦¬
        detail_files = request.files.getlist('detail_images')
        if detail_files and detail_files[0].filename != '':
            p.detail_image_url = ",".join(filter(None, [save_uploaded_file(f) for f in detail_files if f.filename != '']))
            
        db.session.commit()
        flash("ìƒí’ˆ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.")
        return redirect('/admin')

    # ìˆ˜ì • í¼ ë Œë”ë§ (ë“±ë¡ í¼ê³¼ ë””ìì¸ í†µì¼)
    return render_template_string(_header_html() + """
    <div class="max-w-xl mx-auto py-12 md:py-20 px-6 font-black text-left">
        <h2 class="text-2xl md:text-3xl font-black mb-10 border-l-8 border-blue-600 pl-5 uppercase italic text-gray-800">
            Edit Product
        </h2>
        <p class="text-[11px] text-gray-500 font-bold mb-6 bg-gray-50 p-4 rounded-xl border border-gray-100">ì•„ë˜ ê° í•­ëª©ì€ ìƒí’ˆ ëª©ë¡Â·ìƒì„¸ í˜ì´ì§€ì˜ <strong>ì–´ëŠ ìœ„ì¹˜ì— ì–´ë–¤ ê¸€ê·€</strong>ë¡œ ë…¸ì¶œë˜ëŠ”ì§€ ì ì–´ ë‘ì—ˆìŠµë‹ˆë‹¤. ë“±ë¡ ì‹œ ì°¸ê³ í•˜ì„¸ìš”.</p>
        
        <form id="admin-product-form-edit" method="POST" enctype="multipart/form-data" class="bg-white p-8 md:p-12 rounded-[2.5rem] md:rounded-[3.5rem] shadow-2xl space-y-7 text-left">
            <div class="space-y-1">
                <label class="text-[10px] text-gray-400 font-black ml-4 uppercase tracking-widest">Product Name (ìƒí’ˆëª…)</label>
                <p class="text-[10px] text-gray-500 ml-4 mb-0.5">ë…¸ì¶œ ìœ„ì¹˜: ë©”ì¸Â·ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì¹´ë“œì˜ <strong>ìƒí’ˆëª… í•œ ì¤„</strong>, ìƒì„¸ í˜ì´ì§€ ì œëª©</p>
                <input name="name" placeholder="ìƒí’ˆ ëª…ì¹­ (ì˜ˆ: ê¿€ë¶€ì‚¬ ì‚¬ê³¼)" 
                       class="w-full p-5 bg-gray-50 rounded-2xl font-black text-left text-sm focus:ring-4 focus:ring-blue-50 outline-none transition" 
                       value="{{ p.name }}" required>
            </div>

            <div class="space-y-1">
                <label class="text-[10px] text-orange-500 font-black ml-4 uppercase tracking-widest">Short Intro / Badge (í•œì¤„ì†Œê°œÂ·ë±ƒì§€)</label>
                <p class="text-[10px] text-gray-500 ml-4 mb-0.5">ë…¸ì¶œ ìœ„ì¹˜: ëª©ë¡ ì¹´ë“œì—ì„œ <strong>ìƒí’ˆëª… ë°”ë¡œ ì˜†</strong> (ì˜ˆ: | ì‚°ì§€ì§ì†¡), ìƒì„¸ì—ì„œë„ ìƒí’ˆëª… ì˜†. ë±ƒì§€ ì„ íƒ ì‹œ ì˜¤ëŠ˜ë§ˆê°Â·ì‚¼ì´Œì¶”ì²œ ë“±</p>
                <input name="badge" placeholder="ì˜ˆ: ì•„ì‚­í•˜ê³  ë‹¬ì½¤í•œ, ì‚°ì§€ì§ì†¡" 
                       class="w-full p-5 bg-orange-50 border border-orange-100 rounded-2xl font-black text-left text-sm focus:ring-4 focus:ring-orange-100 outline-none transition" 
                       value="{{ p.badge or '' }}">
            </div>

            <div class="space-y-1">
                <label class="text-[10px] text-teal-600 font-black ml-4 uppercase tracking-widest">Detailed Intro / Origin (ì‚¬ì§„ ìœ„ ë¬¸êµ¬)</label>
                <p class="text-[10px] text-gray-500 ml-4 mb-0.5">ë…¸ì¶œ ìœ„ì¹˜: <strong>ìƒì„¸ í˜ì´ì§€ ë©”ì¸ ì´ë¯¸ì§€ ë°”ë¡œ ìœ„</strong> í•œ ì¤„ ë¬¸êµ¬ (ì›ì‚°ì§€Â·í’ˆì§ˆ ì„¤ëª… ë“±)</p>
                <input name="origin" placeholder="ìƒì„¸í˜ì´ì§€ ì‚¬ì§„ ë°”ë¡œ ìœ„ì— ë…¸ì¶œë  ë¬¸êµ¬" 
                       class="w-full p-5 bg-teal-50 border border-teal-100 rounded-2xl font-black text-left text-sm focus:ring-4 focus:ring-teal-100 outline-none transition" 
                       value="{{ p.origin or '' }}">
            </div>

            <div class="space-y-1">
                <label class="text-[10px] text-blue-600 font-black ml-4 uppercase tracking-widest">Delivery (ë°°ì†¡ ì˜ˆì •ì¼)</label>
                <p class="text-[10px] text-gray-500 ml-4 mb-0.5">ë…¸ì¶œ ìœ„ì¹˜: ëª©ë¡ ì¹´ë“œ <strong>ì´ë¯¸ì§€ ì¢Œì¸¡ ë°°ì§€</strong> (ë‹¹ì¼ë°°ì†¡/+1ì¼/+2ì¼ ë“±), ìƒì„¸ í˜ì´ì§€ ë°°ì†¡ ì•ˆë‚´ ë¬¸êµ¬</p>
                <select name="description" class="w-full p-5 bg-blue-50 text-blue-700 rounded-2xl font-black text-sm outline-none border-none focus:ring-4 focus:ring-blue-100">
                    <option value="+1ì¼" {% if p.description == '+1ì¼' %}selected{% endif %}>ğŸšš ì£¼ë¬¸ ì™„ë£Œ í›„ +1ì¼ ë°°ì†¡</option>
                    <option value="+2ì¼" {% if p.description == '+2ì¼' %}selected{% endif %}>ğŸšš ì£¼ë¬¸ ì™„ë£Œ í›„ +2ì¼ ë°°ì†¡</option>
                    <option value="+3ì¼" {% if p.description == '+3ì¼' %}selected{% endif %}>ğŸšš ì£¼ë¬¸ ì™„ë£Œ í›„ +3ì¼ ë°°ì†¡</option>
                    <option value="ë‹¹ì¼ë°°ì†¡" {% if p.description == 'ë‹¹ì¼ë°°ì†¡' %}selected{% endif %}>âš¡ ì†¡ë„ ì§€ì—­ ë‹¹ì¼ ë°°ì†¡</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-5">
                <div class="space-y-1">
                    <label class="text-[10px] text-gray-400 font-black ml-4 uppercase tracking-widest">Price (ì›)</label>
                    <p class="text-[10px] text-gray-500 ml-4 mb-0.5">ë…¸ì¶œ: ëª©ë¡Â·ìƒì„¸ <strong>ê°€ê²©</strong></p>
                    <input name="price" type="number" placeholder="íŒë§¤ ê°€ê²©" 
                           class="w-full p-5 bg-gray-50 rounded-2xl font-black text-left text-sm outline-none" 
                           value="{{ p.price }}" required>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] text-gray-400 font-black ml-4 uppercase tracking-widest">Spec (ê·œê²©)</label>
                    <p class="text-[10px] text-gray-500 ml-4 mb-0.5">ë…¸ì¶œ: ëª©ë¡ ì¹´ë“œ <strong>ê·œê²© ë±ƒì§€</strong> (ì˜ˆ: 1ë°•ìŠ¤, 1kg)</p>
                    <input name="spec" placeholder="ì˜ˆ: 5kg/1ë°•ìŠ¤" 
                           class="w-full p-5 bg-gray-50 rounded-2xl font-black text-left text-sm outline-none" 
                           value="{{ p.spec or '' }}">
                </div>
            </div>

            <div class="grid grid-cols-1 gap-5">
                <div class="space-y-1">
                    <label class="text-[10px] text-gray-400 font-black ml-4 uppercase tracking-widest">ì—…ì²´ê³µê¸‰ê°€ê²© (ì›)</label>
                    <p class="text-[10px] text-gray-500 ml-4 mb-0.5">ê´€ë¦¬ìš©. ê³ ê°ì—ê²Œ ë…¸ì¶œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                    <input name="supply_price" type="number" min="0" placeholder="ì—…ì²´ê³µê¸‰ê°€ê²© (ì„ íƒ)" 
                           class="w-full p-5 bg-gray-50 rounded-2xl font-black text-left text-sm outline-none" 
                           value="{{ p.supply_price if p.supply_price is not none else '' }}">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-5">
                <div class="space-y-1">
                    <label class="text-[10px] text-gray-400 font-black ml-4 uppercase tracking-widest">Stock (í•œì • ìˆ˜ëŸ‰)</label>
                    <p class="text-[10px] text-gray-500 ml-4 mb-0.5">ë…¸ì¶œ: ìƒì„¸ í˜ì´ì§€ <strong>ì”ì—¬ Nê°œ</strong>, ëª©ë¡ ì¹´ë“œ í•˜ë‹¨ ì”ì—¬ ìˆ˜</p>
                    <input name="stock" type="number" placeholder="ì¬ê³  ìˆ˜ëŸ‰" 
                           class="w-full p-5 bg-gray-50 rounded-2xl font-black text-left text-sm outline-none" 
                           value="{{ p.stock }}">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] text-red-400 font-black ml-4 uppercase tracking-widest">Deadline (ë§ˆê°ì¼)</label>
                    <p class="text-[10px] text-gray-500 ml-4 mb-0.5">ë…¸ì¶œ: ë§ˆê° ìˆìœ¼ë©´ ìƒì„¸Â·ëª©ë¡ì— <strong>ì¹´ìš´íŠ¸ë‹¤ìš´Â·ì˜¤ëŠ˜ë§ˆê°</strong> ë“±. ë¹„ìš°ë©´ ìƒì‹œ íŒë§¤</p>
                    <input name="deadline" type="datetime-local" id="edit-deadline"
                           class="w-full p-5 bg-gray-50 rounded-2xl font-black text-left text-sm outline-none" 
                           value="{{ p.deadline.strftime('%Y-%m-%dT%H:%M') if p.deadline else '' }}">
                </div>
            </div>

            <div id="edit-reset-time-block" class="grid grid-cols-2 gap-5 {% if p.deadline %}hidden{% endif %}">
                <div class="space-y-1">
                    <label class="text-[10px] text-amber-600 font-black ml-4 uppercase tracking-widest">ì¬ê³  ì´ˆê¸°í™” ì‹œê° (ë§ˆê°ì¼ ì—†ì„ ë•Œ)</label>
                    <p class="text-[10px] text-gray-500 ml-4 mb-0.5">ë§¤ì¼ ì´ ì‹œê°ì´ ë˜ë©´ ì•„ë˜ Â«ì´ˆê¸°í™” ìˆ˜ëŸ‰Â»ìœ¼ë¡œ ì¬ê³ ê°€ ìë™ ë³µì›ë©ë‹ˆë‹¤.</p>
                    <input name="reset_time" type="time" placeholder="09:00" 
                           class="w-full p-5 bg-amber-50 rounded-2xl font-black text-left text-sm outline-none border border-amber-100" 
                           value="{{ p.reset_time or '' }}">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] text-amber-600 font-black ml-4 uppercase tracking-widest">ì´ˆê¸°í™” ì‹œ ë³µì› ìˆ˜ëŸ‰</label>
                    <p class="text-[10px] text-gray-500 ml-4 mb-0.5">ìœ„ ì‹œê°ì— ì¬ê³ ë¥¼ ì´ ìˆ«ìë¡œ ë§ì¶¥ë‹ˆë‹¤. ë¹„ìš°ë©´ ì´ˆê¸°í™” ì•ˆ í•¨.</p>
                    <input name="reset_to_quantity" type="number" placeholder="ì˜ˆ: 50" min="0"
                           class="w-full p-5 bg-amber-50 rounded-2xl font-black text-left text-sm outline-none border border-amber-100" 
                           value="{{ p.reset_to_quantity if p.reset_to_quantity is not none else '' }}">
                </div>
            </div>
            <script>
            (function(){
                var deadlineInput = document.getElementById('edit-deadline');
                var block = document.getElementById('edit-reset-time-block');
                if (deadlineInput && block) {
                    function toggle() { block.classList.toggle('hidden', !!deadlineInput.value); }
                    deadlineInput.addEventListener('change', toggle);
                    deadlineInput.addEventListener('input', toggle);
                }
            })();
            </script>

            <div class="pt-4 space-y-4">
                <div class="p-6 border-2 border-dashed border-gray-100 rounded-3xl">
                    <label class="text-[10px] text-gray-400 uppercase font-black block mb-3">Main Image (ë©”ì¸ ì´ë¯¸ì§€)</label>
                    <p class="text-[10px] text-gray-500 ml-0 mb-2">ë…¸ì¶œ ìœ„ì¹˜: <strong>ë©”ì¸Â·ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì¹´ë“œ</strong> ë° ìƒì„¸ í˜ì´ì§€ ëŒ€í‘œ ì‚¬ì§„ (ê¸°ì¡´ ì´ë¯¸ì§€ ìœ ì§€ ê°€ëŠ¥)</p>
                    <input type="file" name="main_image" accept="image/*" class="text-[10px] font-bold product-image-input">
                    {% if p.image_url %}
                    <p class="text-[9px] text-blue-500 mt-2 font-bold italic">í˜„ì¬ ë“±ë¡ë¨: {{ p.image_url.split('/')[-1] }}</p>
                    {% endif %}
                </div>
                
                <div class="p-6 border-2 border-dashed border-blue-50 rounded-3xl">
                    <label class="text-[10px] text-blue-400 uppercase font-black block mb-3">Detail Images (ìƒì„¸ ì´ë¯¸ì§€)</label>
                    <p class="text-[10px] text-gray-500 ml-0 mb-2">ë…¸ì¶œ ìœ„ì¹˜: <strong>ìƒí’ˆ ìƒì„¸ í˜ì´ì§€</strong> ë³¸ë¬¸ì— ì—¬ëŸ¬ ì¥ ë…¸ì¶œ (ìƒˆë¡œ ë“±ë¡ ì‹œ ê¸°ì¡´ ëŒ€ì²´)</p>
                    <input type="file" name="detail_images" multiple accept="image/*" class="text-[10px] font-bold product-image-input">
                </div>
            </div>

            <button type="submit" class="w-full bg-blue-600 text-white py-6 rounded-3xl font-black text-xl shadow-xl hover:bg-blue-700 transition active:scale-95 text-center admin-product-submit-btn">
                ìƒí’ˆ ì •ë³´ ìˆ˜ì • ì™„ë£Œ
            </button>
            
            <div class="text-center mt-4">
                <a href="/admin" class="text-gray-300 text-xs font-bold hover:text-gray-500 transition">ìˆ˜ì • ì·¨ì†Œí•˜ê³  ëŒì•„ê°€ê¸°</a>
            </div>
        </form>
    </div>
    <script>
    (function(){
    function processImageFile(file) {
      if (!file || !file.type || !file.type.match(/^image\//)) return Promise.resolve(file);
      return new Promise(function(resolve) {
        var img = new Image();
        var url = URL.createObjectURL(file);
        img.onload = function() {
          URL.revokeObjectURL(url);
          var w = img.naturalWidth, h = img.naturalHeight;
          var minSide = Math.min(w, h);
          var size = Math.min(1200, minSide);
          var canvas = document.createElement('canvas');
          canvas.width = size; canvas.height = size;
          var ctx = canvas.getContext('2d');
          var sx = (w - minSide) / 2, sy = (h - minSide) / 2;
          ctx.drawImage(img, sx, sy, minSide, minSide, 0, 0, size, size);
          canvas.toBlob(function(blob) { resolve(blob ? new File([blob], file.name || 'image.jpg', { type: 'image/jpeg' }) : file); }, 'image/jpeg', 0.82);
        };
        img.onerror = function() { URL.revokeObjectURL(url); resolve(file); };
        img.src = url;
      });
    }
    var form = document.getElementById('admin-product-form-edit');
    if (form) {
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        var f = this;
        var btn = f.querySelector('.admin-product-submit-btn');
        var originalText = btn ? btn.textContent : '';
        if (btn) { btn.disabled = true; btn.textContent = 'ì €ì¥ ì¤‘...'; }
        var formData = new FormData(f);
        var mainIn = f.querySelector('input[name="main_image"]');
        if (mainIn && mainIn.files && mainIn.files[0]) {
          var p = await processImageFile(mainIn.files[0]);
          if (p) formData.set('main_image', p, p.name || 'main.jpg');
        }
        var detailIn = f.querySelector('input[name="detail_images"]');
        if (detailIn && detailIn.files && detailIn.files.length) {
          formData.delete('detail_images');
          for (var i = 0; i < detailIn.files.length; i++) {
            var q = await processImageFile(detailIn.files[i]);
            if (q) formData.append('detail_images', q, q.name || ('detail_' + i + '.jpg'));
          }
        }
        try {
          var r = await fetch(f.action, { method: 'POST', body: formData, redirect: 'follow' });
          if (r.ok) { window.location.href = r.url || '/admin'; } else { alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); if (btn) { btn.disabled = false; btn.textContent = originalText; } }
        } catch (err) { alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); if (btn) { btn.disabled = false; btn.textContent = originalText; } }
      });
    }
    })();
    </script>
    """ + _footer_html(), p=p)
@admin_bp.route('/admin/delete/<int:pid>')
@login_required
def admin_delete(pid):
    """ìƒí’ˆ ì‚­ì œ"""
    p = Product.query.get(pid)
    if p and check_admin_permission(p.category): db.session.delete(p); db.session.commit()
    return redirect('/admin')

@admin_bp.route('/admin/category/add', methods=['POST'])
@login_required
def admin_category_add():
    """ì¹´í…Œê³ ë¦¬ ì¶”ê°€"""
    if not current_user.is_admin: return redirect('/')
    last_cat = Category.query.order_by(Category.order.desc()).first()
    next_order = (last_cat.order + 1) if last_cat else 0
    mg = request.form.get('min_member_grade', '').strip()
    min_mg = int(mg) if mg and mg.isdigit() and mg in ('1', '2', '3', '4', '5') else None
    db.session.add(Category(name=request.form['cat_name'], description=request.form.get('description'), tax_type=request.form['tax_type'], manager_email=request.form.get('manager_email'), seller_name=request.form.get('biz_name'), seller_inquiry_link=request.form.get('seller_link'), biz_name=request.form.get('biz_name'), biz_representative=request.form.get('biz_representative'), biz_reg_number=request.form.get('biz_reg_number'), biz_address=request.form.get('biz_address'), biz_contact=request.form.get('biz_contact'), bank_name=request.form.get('bank_name'), account_holder=request.form.get('account_holder'), settlement_account=request.form.get('settlement_account'), order=next_order, min_member_grade=min_mg))
    db.session.commit(); return redirect('/admin?tab=categories')

@admin_bp.route('/admin/category/edit/<int:cid>', methods=['GET', 'POST'])
@login_required
def admin_category_edit(cid):
    """ì¹´í…Œê³ ë¦¬ ìˆ˜ì •"""
    if not current_user.is_admin: return redirect('/')
    cat = Category.query.get_or_404(cid)
    if request.method == 'POST':
        cat.name, cat.description, cat.tax_type, cat.manager_email = request.form['cat_name'], request.form['description'], request.form['tax_type'], request.form.get('manager_email')
        cat.biz_name, cat.biz_representative, cat.biz_reg_number, cat.biz_address, cat.biz_contact, cat.seller_inquiry_link = request.form.get('biz_name'), request.form.get('biz_representative'), request.form.get('biz_reg_number'), request.form.get('biz_address'), request.form.get('biz_contact'), request.form.get('seller_link')
        cat.bank_name, cat.account_holder, cat.settlement_account = request.form.get('bank_name'), request.form.get('account_holder'), request.form.get('settlement_account')
        cat.seller_name = cat.biz_name
        mg = request.form.get('min_member_grade', '').strip()
        cat.min_member_grade = int(mg) if mg and mg.isdigit() and mg in ('1', '2', '3', '4', '5') else None
        db.session.commit(); return redirect('/admin?tab=categories')
    mg_val = getattr(cat, 'min_member_grade', None)
    return render_template_string(_header_html() + """<div class="max-w-xl mx-auto py-20 px-6 font-black text-left"><h2 class="text-2xl md:text-3xl font-black mb-12 tracking-tighter uppercase text-teal-600 text-left">Edit Category Profile</h2><form method="POST" class="bg-white p-10 rounded-[3rem] shadow-2xl space-y-8 text-left"><div><label class="text-[10px] text-gray-400 uppercase font-black ml-4 text-left">Settings</label><input name="cat_name" value="{{cat.name}}" class="border border-gray-100 p-5 rounded-2xl w-full font-black mt-2 text-sm text-left" required><textarea name="description" class="border border-gray-100 p-5 rounded-2xl w-full h-24 font-black mt-3 text-sm text-left" placeholder="í•œì¤„ ì†Œê°œ">{{cat.description or ''}}</textarea><input name="manager_email" value="{{cat.manager_email or ''}}" class="border border-gray-100 p-5 rounded-2xl w-full font-black mt-3 text-sm text-left" placeholder="ë§¤ë‹ˆì € ì´ë©”ì¼"><select name="tax_type" class="border border-gray-100 p-5 rounded-2xl w-full font-black mt-3 text-sm text-left bg-white"><option value="ê³¼ì„¸" {% if cat.tax_type == 'ê³¼ì„¸' %}selected{% endif %}>ê³¼ì„¸</option><option value="ë©´ì„¸" {% if cat.tax_type == 'ë©´ì„¸' %}selected{% endif %}>ë©´ì„¸</option></select><p class="text-[10px] text-amber-600 font-bold uppercase mt-4 ml-4 text-left">íšŒì› ë“±ê¸‰ë³„ ë…¸ì¶œ (ë¹„ì›Œë‘ë©´ ì „ì²´)</p><select name="min_member_grade" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs text-left mt-2 bg-white"><option value="">ì „ì²´ íšŒì›</option><option value="1" {% if mg_val == 1 %}selected{% endif %}>1ë‹¨ê³„ ì´ìƒ</option><option value="2" {% if mg_val == 2 %}selected{% endif %}>2ë‹¨ê³„ ì´ìƒ</option><option value="3" {% if mg_val == 3 %}selected{% endif %}>3ë‹¨ê³„ ì´ìƒ</option><option value="4" {% if mg_val == 4 %}selected{% endif %}>4ë‹¨ê³„ ì´ìƒ</option><option value="5" {% if mg_val == 5 %}selected{% endif %}>5ë‹¨ê³„ë§Œ</option></select></div><div class="border-t border-gray-50 pt-10 space-y-4 text-left"><label class="text-[10px] text-teal-600 uppercase font-black ml-4 text-left">Business Info</label><input name="biz_name" value="{{cat.biz_name or ''}}" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs text-left" placeholder="ìƒí˜¸ëª…"><input name="biz_representative" value="{{cat.biz_representative or ''}}" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs text-left" placeholder="ëŒ€í‘œì"><input name="biz_reg_number" value="{{cat.biz_reg_number or ''}}" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs text-left" placeholder="ì‚¬ì—…ìë²ˆí˜¸"><input name="biz_address" value="{{cat.biz_address or ''}}" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs text-left" placeholder="ì£¼ì†Œ"><input name="biz_contact" value="{{cat.biz_contact or ''}}" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs text-left" placeholder="ê³ ê°ì„¼í„°"><input name="seller_link" value="{{cat.seller_inquiry_link or ''}}" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs text-left" placeholder="ë¬¸ì˜ ë§í¬ URL"><p class="text-[10px] text-blue-600 font-bold uppercase mt-4 text-left">ì •ì‚° ê³„ì¢Œ</p><input name="bank_name" value="{{cat.bank_name or ''}}" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs text-left mt-2" placeholder="ì€í–‰ëª…"><input name="account_holder" value="{{cat.account_holder or ''}}" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs text-left mt-2" placeholder="ì˜ˆê¸ˆì£¼"><input name="settlement_account" value="{{cat.settlement_account or ''}}" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs text-left mt-2" placeholder="ì •ì‚°ê³„ì¢Œ (ê³„ì¢Œë²ˆí˜¸)"></div><button class="w-full bg-blue-600 text-white py-6 rounded-3xl font-black shadow-xl hover:bg-blue-700 transition text-center text-center">Save Profile Updates</button></form></div>""", cat=cat, mg_val=mg_val)

@admin_bp.route('/admin/category/move/<int:cid>/<string:direction>')
@login_required
def admin_category_move(cid, direction):
    """ì¹´í…Œê³ ë¦¬ ìˆœì„œ ì´ë™"""
    if not current_user.is_admin: return redirect('/')
    curr = Category.query.get_or_404(cid)
    if direction == 'up': target = Category.query.filter(Category.order < curr.order).order_by(Category.order.desc()).first()
    else: target = Category.query.filter(Category.order > curr.order).order_by(Category.order.asc()).first()
    if target: curr.order, target.order = target.order, curr.order; db.session.commit()
    return redirect('/admin?tab=categories')

@admin_bp.route('/admin/category/delete/<int:cid>')
@login_required
def admin_category_delete(cid):
    """ì¹´í…Œê³ ë¦¬ ì‚­ì œ"""
    if not current_user.is_admin: return redirect('/')
    db.session.delete(Category.query.get(cid)); db.session.commit(); return redirect('/admin?tab=categories')


@admin_bp.route('/admin/sellers/excel')
@login_required
def admin_sellers_excel():
    """íŒë§¤ì ì •ë³´(Seller Business Profile) ì—‘ì…€ ë‹¤ìš´ë¡œë“œ"""
    if not current_user.is_admin:
        flash("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin')
    categories = Category.query.order_by(Category.order.asc(), Category.id.asc()).all()
    rows = []
    for i, c in enumerate(categories, 1):
        rows.append({
            'ìˆœì„œ': i,
            'ì¹´í…Œê³ ë¦¬': c.name or '',
            'ìƒí˜¸': c.biz_name or '',
            'ëŒ€í‘œì': c.biz_representative or '',
            'ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸': c.biz_reg_number or '',
            'ì†Œì¬ì§€': c.biz_address or '',
            'ê³ ê°ì„¼í„°': c.biz_contact or '',
            'ë¬¸ì˜ë§í¬': c.seller_inquiry_link or '',
            'ì€í–‰ëª…': c.bank_name or '',
            'ì˜ˆê¸ˆì£¼': c.account_holder or '',
            'ì •ì‚°ê³„ì¢Œ': c.settlement_account or '',
            'ë§¤ë‹ˆì €ì´ë©”ì¼': c.manager_email or '',
        })
    if not rows:
        flash("ë‹¤ìš´ë¡œë“œí•  íŒë§¤ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin?tab=sellers')
    df = pd.DataFrame(rows)
    out = BytesIO()
    with pd.ExcelWriter(out, engine='openpyxl') as w:
        df.to_excel(w, index=False)
    out.seek(0)
    filename = f"íŒë§¤ìì •ë³´_{datetime.now().strftime('%m%d_%H%M')}.xlsx"
    return send_file(out, download_name=filename, as_attachment=True)


from urllib.parse import quote


@admin_bp.route('/admin/orders/sales_excel')
@login_required
def admin_orders_sales_excel():
    """ì¡°íšŒ ê²°ê³¼ ìƒì„¸ í…Œì´ë¸” ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ì£¼ë¬¸ì¼ì‹œ, íŒë§¤ìƒí’ˆëª…, íŒë§¤ìˆ˜ëŸ‰, ê²°ì œìƒíƒœ)"""
    categories = Category.query.all()
    my_categories = [c.name for c in categories if c.manager_email == current_user.email]
    if not (current_user.is_admin or my_categories):
        flash("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin')
    is_master = current_user.is_admin
    now = datetime.now()
    start_date_str = request.args.get('start_date', now.strftime('%Y-%m-%d 00:00')).replace('T', ' ')
    end_date_str = request.args.get('end_date', now.strftime('%Y-%m-%d 23:59')).replace('T', ' ')
    query = Order.query.filter(Order.status != 'ê²°ì œì·¨ì†Œ')
    order_ids_param = request.args.get('order_ids', '').strip()
    if order_ids_param:
        allowed_ids = [x.strip() for x in order_ids_param.split(',') if x.strip()]
        if allowed_ids:
            query = query.filter(Order.order_id.in_(allowed_ids))
    else:
        try:
            sd = datetime.strptime(start_date_str, '%Y-%m-%d %H:%M')
            ed = datetime.strptime(end_date_str, '%Y-%m-%d %H:%M')
            query = query.filter(Order.created_at >= sd, Order.created_at <= ed)
        except Exception:
            pass
    sel_order_cat = request.args.get('order_cat', 'ì „ì²´')
    orders = query.order_by(Order.created_at.desc()).all()
    sales_table_rows = []
    for o in orders:
        if is_master:
            order_show = True
        else:
            order_show = False
            parts = (o.product_details or '').split(' | ')
            for part in parts:
                match = re.search(r'\[(.*?)\] (.*)', part)
                if match and match.group(1).strip() in my_categories:
                    order_show = True
                    break
        if not order_show:
            continue
        parts = (o.product_details or '').split(' | ')
        order_date_str = o.created_at.strftime('%Y-%m-%d %H:%M') if o.created_at else ''
        status_str = o.status or 'ê²°ì œì™„ë£Œ'
        items = OrderItem.query.filter_by(order_id=o.id).order_by(OrderItem.id.asc()).all()
        if items:
            for oi in items:
                if (is_master or oi.product_category in my_categories) and (sel_order_cat == 'ì „ì²´' or oi.product_category == sel_order_cat):
                    is_cancelled = getattr(oi, 'cancelled', False) or (getattr(oi, 'item_status', None) in ('ë¶€ë¶„ì·¨ì†Œ', 'í’ˆì ˆì·¨ì†Œ'))
                    sales_table_rows.append({
                        'order_date': order_date_str,
                        'product_name': oi.product_name,
                        'category': oi.product_category,
                        'quantity': 0 if is_cancelled else oi.quantity,
                        'status': 'ì·¨ì†Œ' if is_cancelled else (getattr(oi, 'item_status', None) or status_str)
                    })
        else:
            for part in parts:
                match = re.search(r'\[(.*?)\] (.*)', part)
                if match:
                    cat_n, items_str = match.groups()
                    if (is_master or cat_n in my_categories) and (sel_order_cat == 'ì „ì²´' or cat_n == sel_order_cat):
                        for item in items_str.split(', '):
                            it_match = re.search(r'(.*?)\((\d+)\)', item)
                            if it_match:
                                pn, qt = it_match.groups()
                                sales_table_rows.append({'order_date': order_date_str, 'product_name': pn.strip(), 'category': cat_n, 'quantity': int(qt), 'status': status_str})
    if not sales_table_rows:
        flash("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin?tab=orders')
    df = pd.DataFrame(sales_table_rows, columns=['order_date', 'product_name', 'category', 'quantity', 'status'])
    df.columns = ['ì£¼ë¬¸ì¼ì‹œ', 'íŒë§¤ìƒí’ˆëª…', 'ì¹´í…Œê³ ë¦¬', 'íŒë§¤ìˆ˜ëŸ‰', 'ê²°ì œìƒíƒœ']
    out = BytesIO()
    with pd.ExcelWriter(out, engine='openpyxl') as w:
        df.to_excel(w, index=False)
    out.seek(0)
    filename = f"ë§¤ì¶œìƒì„¸_{datetime.now().strftime('%m%d_%H%M')}.xlsx"
    return send_file(out, download_name=filename, as_attachment=True)


@admin_bp.route('/admin/orders/sales_summary_excel')
@login_required
def admin_orders_sales_summary_excel():
    """íŒë§¤ìƒí’ˆëª…ë³„ íŒë§¤ìˆ˜ëŸ‰ ì´í•©ê³„ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (í’ˆëª©Â·íŒë§¤ìƒí’ˆëª…Â·ì´í•©ê³„)"""
    categories = Category.query.all()
    my_categories = [c.name for c in categories if c.manager_email == current_user.email]
    if not (current_user.is_admin or my_categories):
        flash("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin')
    is_master = current_user.is_admin
    now = datetime.now()
    start_date_str = request.args.get('start_date', now.strftime('%Y-%m-%d 00:00')).replace('T', ' ')
    end_date_str = request.args.get('end_date', now.strftime('%Y-%m-%d 23:59')).replace('T', ' ')
    query = Order.query.filter(Order.status != 'ê²°ì œì·¨ì†Œ')
    order_ids_param = request.args.get('order_ids', '').strip()
    if order_ids_param:
        allowed_ids = [x.strip() for x in order_ids_param.split(',') if x.strip()]
        if allowed_ids:
            query = query.filter(Order.order_id.in_(allowed_ids))
    else:
        try:
            sd = datetime.strptime(start_date_str, '%Y-%m-%d %H:%M')
            ed = datetime.strptime(end_date_str, '%Y-%m-%d %H:%M')
            query = query.filter(Order.created_at >= sd, Order.created_at <= ed)
        except Exception:
            pass
    sel_order_cat = request.args.get('order_cat', 'ì „ì²´')
    orders = query.order_by(Order.created_at.desc()).all()
    sales_table_rows = []
    for o in orders:
        if is_master:
            order_show = True
        else:
            order_show = False
            parts = (o.product_details or '').split(' | ')
            for part in parts:
                match = re.search(r'\[(.*?)\] (.*)', part)
                if match and match.group(1).strip() in my_categories:
                    order_show = True
                    break
        if not order_show:
            continue
        parts = (o.product_details or '').split(' | ')
        order_date_str = o.created_at.strftime('%Y-%m-%d %H:%M') if o.created_at else ''
        status_str = o.status or 'ê²°ì œì™„ë£Œ'
        items = OrderItem.query.filter_by(order_id=o.id).order_by(OrderItem.id.asc()).all()
        if items:
            for oi in items:
                if (is_master or oi.product_category in my_categories) and (sel_order_cat == 'ì „ì²´' or oi.product_category == sel_order_cat):
                    is_cancelled = getattr(oi, 'cancelled', False) or (getattr(oi, 'item_status', None) in ('ë¶€ë¶„ì·¨ì†Œ', 'í’ˆì ˆì·¨ì†Œ'))
                    sales_table_rows.append({
                        'order_date': order_date_str,
                        'product_name': oi.product_name,
                        'category': oi.product_category,
                        'quantity': 0 if is_cancelled else oi.quantity,
                        'status': 'ì·¨ì†Œ' if is_cancelled else (getattr(oi, 'item_status', None) or status_str)
                    })
        else:
            for part in parts:
                match = re.search(r'\[(.*?)\] (.*)', part)
                if match:
                    cat_n, items_str = match.groups()
                    if (is_master or cat_n in my_categories) and (sel_order_cat == 'ì „ì²´' or cat_n == sel_order_cat):
                        for item in items_str.split(', '):
                            it_match = re.search(r'(.*?)\((\d+)\)', item)
                            if it_match:
                                pn, qt = it_match.groups()
                                sales_table_rows.append({'order_date': order_date_str, 'product_name': pn.strip(), 'category': cat_n, 'quantity': int(qt), 'status': status_str})
    from collections import defaultdict
    agg = defaultdict(int)
    for r in sales_table_rows:
        key = (r.get('category', ''), r.get('product_name', ''))
        agg[key] += r.get('quantity', 0)
    product_summary_rows = [{'category': k[0], 'product_name': k[1], 'total_quantity': v} for k, v in sorted(agg.items())]
    if not product_summary_rows:
        flash("ë‹¤ìš´ë¡œë“œí•  ì§‘ê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin?tab=orders')
    df = pd.DataFrame(product_summary_rows, columns=['category', 'product_name', 'total_quantity'])
    df.columns = ['í’ˆëª©(ì¹´í…Œê³ ë¦¬)', 'íŒë§¤ìƒí’ˆëª…', 'íŒë§¤ìˆ˜ëŸ‰ ì´í•©ê³„']
    out = BytesIO()
    with pd.ExcelWriter(out, engine='openpyxl') as w:
        df.to_excel(w, index=False)
    out.seek(0)
    filename = f"íŒë§¤ìƒí’ˆëª…ë³„_ì´í•©ê³„_{datetime.now().strftime('%m%d_%H%M')}.xlsx"
    return send_file(out, download_name=filename, as_attachment=True)


@admin_bp.route('/admin/orders/settlement_detail_excel')
@login_required
def admin_orders_settlement_detail_excel():
    """ì •ì‚° ìƒì„¸ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (Settlement í…Œì´ë¸” në„˜ë²„ ê¸°ì¤€, ë‚ ì§œÂ·ì¹´í…Œê³ ë¦¬Â·ì…ê¸ˆìƒíƒœ í•„í„°)"""
    categories = Category.query.all()
    my_categories = [c.name for c in categories if c.manager_email == current_user.email]
    if not (current_user.is_admin or my_categories):
        flash("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin')
    is_master = current_user.is_admin
    now = datetime.now()
    start_date_str = request.args.get('start_date', now.strftime('%Y-%m-%d 00:00')).replace('T', ' ')
    end_date_str = request.args.get('end_date', now.strftime('%Y-%m-%d 23:59')).replace('T', ' ')
    sel_order_cat = request.args.get('order_cat', 'ì „ì²´')
    sel_settlement_status = request.args.get('settlement_status', 'ì „ì²´')
    if sel_settlement_status == 'ì •ì‚°ëŒ€ê¸°': sel_settlement_status = 'ì…ê¸ˆëŒ€ê¸°'
    if sel_settlement_status == 'ì •ì‚°ì™„ë£Œ': sel_settlement_status = 'ì…ê¸ˆì™„ë£Œ'
    try:
        start_dt = datetime.strptime(start_date_str, '%Y-%m-%d %H:%M')
        end_dt = datetime.strptime(end_date_str, '%Y-%m-%d %H:%M')
    except Exception:
        start_dt = now.replace(hour=0, minute=0, second=0)
        end_dt = now.replace(hour=23, minute=59, second=59)
    q = Settlement.query.filter(Settlement.sale_dt >= start_dt, Settlement.sale_dt <= end_dt)
    if not is_master:
        q = q.filter(Settlement.category.in_(my_categories))
    if sel_order_cat != 'ì „ì²´':
        q = q.filter(Settlement.category == sel_order_cat)
    if sel_settlement_status and sel_settlement_status != 'ì „ì²´':
        q = q.filter(Settlement.settlement_status == sel_settlement_status)
    rows = []
    for s in q.order_by(Settlement.sale_dt.desc()).all():
        rows.append({
            'settlement_no': s.settlement_no,
            'sale_dt': s.sale_dt.strftime('%Y-%m-%d %H:%M') if s.sale_dt else '',
            'category': s.category,
            'tax_exempt': 'ë©´ì„¸' if s.tax_exempt else 'ê³¼ì„¸',
            'product_name': s.product_name,
            'sales_amount': s.sales_amount,
            'fee': s.fee,
            'delivery_fee': s.delivery_fee,
            'settlement_total': s.settlement_total,
            'settlement_status': s.settlement_status,
            'settled_at': s.settled_at.strftime('%Y-%m-%d %H:%M') if s.settled_at else '',
        })
    if not rows:
        flash("ë‹¤ìš´ë¡œë“œí•  ì •ì‚° ìƒì„¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin?tab=settlement')
    df = pd.DataFrame(rows, columns=['settlement_no', 'sale_dt', 'category', 'tax_exempt', 'product_name', 'sales_amount', 'fee', 'delivery_fee', 'settlement_total', 'settlement_status', 'settled_at'])
    df.columns = ['ì •ì‚°ë²ˆí˜¸(n)', 'íŒë§¤ì¼ì‹œ', 'ì¹´í…Œê³ ë¦¬', 'ë©´ì„¸ì—¬ë¶€', 'í’ˆëª©', 'íŒë§¤ê¸ˆì•¡', 'ìˆ˜ìˆ˜ë£Œ', 'ë°°ì†¡ê´€ë¦¬ë¹„', 'ì •ì‚°í•©ê³„', 'ì…ê¸ˆìƒíƒœ', 'ì…ê¸ˆì¼']
    out = BytesIO()
    with pd.ExcelWriter(out, engine='openpyxl') as w:
        df.to_excel(w, index=False)
    out.seek(0)
    filename = f"ì •ì‚°ìƒì„¸_{datetime.now().strftime('%m%d_%H%M')}.xlsx"
    return send_file(out, download_name=filename, as_attachment=True)


@admin_bp.route('/admin/settlement/category_excel')
@login_required
def admin_settlement_category_excel():
    """ì •ì‚°ê´€ë¦¬: ì¹´í…Œê³ ë¦¬ë³„ íŒë§¤ í’ˆëª© ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (í’ˆëª©ëª…Â·ê·œê²©Â·ìˆ˜ëŸ‰Â·ë‹¨ê°€Â·í•©ê³„)"""
    categories = Category.query.all()
    my_categories = [c.name for c in categories if c.manager_email == current_user.email]
    if not (current_user.is_admin or my_categories):
        flash("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin')
    is_master = current_user.is_admin
    now = datetime.now()
    start_date_str = request.args.get('start_date', now.strftime('%Y-%m-%d 00:00')).replace('T', ' ')
    end_date_str = request.args.get('end_date', now.strftime('%Y-%m-%d 23:59')).replace('T', ' ')
    sel_cat = request.args.get('category', 'ì „ì²´')
    try:
        start_dt = datetime.strptime(start_date_str, '%Y-%m-%d %H:%M')
        end_dt = datetime.strptime(end_date_str, '%Y-%m-%d %H:%M')
    except Exception:
        start_dt = now.replace(hour=0, minute=0, second=0)
        end_dt = now.replace(hour=23, minute=59, second=59)
    q = db.session.query(OrderItem, Order, Product).join(
        Order, OrderItem.order_id == Order.id
    ).outerjoin(Product, OrderItem.product_id == Product.id)
    q = q.filter(Order.status != 'ê²°ì œì·¨ì†Œ', OrderItem.cancelled == False)
    q = q.filter(Order.created_at >= start_dt, Order.created_at <= end_dt)
    if not is_master:
        q = q.filter(OrderItem.product_category.in_(my_categories))
    if sel_cat != 'ì „ì²´':
        q = q.filter(OrderItem.product_category == sel_cat)
    rows = []
    for oi, o, p in q.order_by(Order.created_at.desc(), OrderItem.id.asc()).all():
        spec = (p.spec if p else None) or "-"
        rows.append({
            "sale_dt": o.created_at.strftime('%Y-%m-%d %H:%M') if o and o.created_at else '',
            "category": oi.product_category,
            "product_name": oi.product_name,
            "spec": spec,
            "quantity": oi.quantity,
            "price": oi.price,
            "total": oi.price * oi.quantity,
        })
    if not rows:
        flash("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin?tab=settlement')
    df = pd.DataFrame(rows, columns=["sale_dt", "category", "product_name", "spec", "quantity", "price", "total"])
    df.columns = ["íŒë§¤ì¼ì‹œ", "ì¹´í…Œê³ ë¦¬", "í’ˆëª©ëª…", "ê·œê²©", "ìˆ˜ëŸ‰", "ë‹¨ê°€", "í•©ê³„"]
    out = BytesIO()
    with pd.ExcelWriter(out, engine='openpyxl') as w:
        df.to_excel(w, index=False)
    out.seek(0)
    filename = f"ì¹´í…Œê³ ë¦¬ë³„_íŒë§¤í’ˆëª©_{datetime.now().strftime('%m%d_%H%M')}.xlsx"
    return send_file(out, download_name=filename, as_attachment=True)


@admin_bp.route('/admin/orders/excel')
@login_required
def admin_orders_excel():
    """ì£¼ë¬¸ ë‚´ì—­ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ì •ì‚°ì—¬ë¶€/ì¼ì‹œ í¬í•¨ + í’ˆëª© ë¶„ë¦¬ ìµœì¢… ì™„ì„±ë³¸)"""
    categories = Category.query.all()
    my_categories = [c.name for c in categories if c.manager_email == current_user.email]
    
    if not (current_user.is_admin or my_categories):
        flash("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin')



    is_master = current_user.is_admin
    now = datetime.now()
    
    # [ê¸°ì¡´ ë¡œì§ ìœ ì§€] ë‚ ì§œ ë³€ìˆ˜ ì •ì˜
    start_date_str = request.args.get('start_date', now.strftime('%Y-%m-%d 00:00')).replace('T', ' ')
    end_date_str = request.args.get('end_date', now.strftime('%Y-%m-%d 23:59')).replace('T', ' ')
    
    query = Order.query.filter(Order.status != 'ê²°ì œì·¨ì†Œ')
    
    # í˜„ì¬ ê¶Œí•œ ìˆëŠ” ì˜¤ë”ë§Œ ì‚¬ìš©: order_idsê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì£¼ë¬¸ë§Œ ëŒ€ìƒ(ë‚ ì§œëŠ” ì°¸ê³ ìš©), ì—†ìœ¼ë©´ ë‚ ì§œë¡œë§Œ í•„í„°
    order_ids_param = request.args.get('order_ids', '').strip()
    if order_ids_param:
        allowed_ids = [x.strip() for x in order_ids_param.split(',') if x.strip()]
        if allowed_ids:
            query = query.filter(Order.order_id.in_(allowed_ids))
    else:
        try:
            sd = datetime.strptime(start_date_str, '%Y-%m-%d %H:%M')
            ed = datetime.strptime(end_date_str, '%Y-%m-%d %H:%M')
            query = query.filter(Order.created_at >= sd, Order.created_at <= ed)
        except:
            pass

    orders = query.order_by(Order.created_at.desc()).all()
    
    data = []
    all_product_columns = set()

    for o in orders:
        # ê¶Œí•œ ìˆëŠ” í’ˆëª©ë§Œ í•©ì‚° (ì˜¤ë”ë³„ ì •ì‚°ëŒ€ìƒê¸ˆì•¡)
        row_manager_subtotal = 0

        row = {
            "ì¼ì‹œ": o.created_at.strftime('%Y-%m-%d %H:%M') if o.created_at else "-",
            "ì£¼ë¬¸ë²ˆí˜¸": o.order_id[-8:] if o.order_id else "-",
            "ê³ ê°ëª…": o.customer_name or "-",
            "ì „í™”ë²ˆí˜¸": o.customer_phone or "-",
            "ì£¼ì†Œ": o.delivery_address or "-",
            "ë©”ëª¨": o.request_memo or "-",
            "ê²°ì œê¸ˆì•¡": 0,  # ì•„ë˜ì—ì„œ ê¶Œí•œë³„ë¡œ ì±„ì›€
            "ìƒíƒœ": o.status or "-",
            "ì…ê¸ˆì—¬ë¶€": "ì…ê¸ˆì™„ë£Œ" if getattr(o, 'is_settled', False) else "ëŒ€ê¸°",
            "ì •ì‚°ì¼ì‹œ": o.settled_at.strftime('%Y-%m-%d %H:%M') if (getattr(o, 'is_settled', False) and o.settled_at) else "-"
        }
        
        parts = o.product_details.split(' | ') if o.product_details else []
        row_show_flag = False
        
        for part in parts:
            match = re.search(r'\[(.*?)\] (.*)', part)
            if match:
                cat_n, items_str = match.groups()
                if is_master or cat_n in my_categories:
                    row_show_flag = True
                    items = items_str.split(', ')
                    for item in items:
                        item_match = re.search(r'(.*?)\((\d+)\)', item)
                        if item_match:
                            p_name = item_match.group(1).strip()
                            p_qty = int(item_match.group(2))
                            col_name = f"[{cat_n}] {p_name}"
                            row[col_name] = p_qty
                            all_product_columns.add(col_name)
                            # ê¶Œí•œ ìˆëŠ” í’ˆëª©ë§Œ ì •ì‚°ëŒ€ìƒê¸ˆì•¡ì— í•©ì‚°
                            p_obj = Product.query.filter_by(name=p_name).first()
                            if p_obj:
                                row_manager_subtotal += p_obj.price * p_qty

        if row_show_flag:
            # ë§ˆìŠ¤í„°ëŠ” ì£¼ë¬¸ ì „ì²´ ê²°ì œê¸ˆì•¡, ë§¤ë‹ˆì €ëŠ” í•´ë‹¹ ì˜¤ë”ì˜ ê¶Œí•œ í’ˆëª© í•©ê³„ë§Œ
            row["ê²°ì œê¸ˆì•¡"] = o.total_price if is_master else row_manager_subtotal
            data.append(row)

    if not data:
        flash("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin?tab=orders')

    # ë°ì´í„°í”„ë ˆì„ ìƒì„± ë° ì—´ ìˆœì„œ í™•ì •
    df = pd.DataFrame(data)
    
    # í—¤ë” ìˆœì„œ ê³ ì • (ì •ë³´ì„± ì—´ë“¤ì„ ì•ìœ¼ë¡œ ë°°ì¹˜)
    base_cols = ["ì¼ì‹œ", "ì£¼ë¬¸ë²ˆí˜¸", "ê³ ê°ëª…", "ì „í™”ë²ˆí˜¸", "ì£¼ì†Œ", "ë©”ëª¨", "ê²°ì œê¸ˆì•¡", "ìƒíƒœ", "ì •ì‚°ì—¬ë¶€", "ì •ì‚°ì¼ì‹œ"]
    
    # ì‹¤ì œ ìƒì„±ëœ ìƒí’ˆ ì—´ë“¤ë§Œ ì¶”ì¶œí•˜ì—¬ ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬
    existing_base_cols = [c for c in base_cols if c in df.columns]
    product_cols = sorted([c for c in df.columns if c not in base_cols])
    
    df = df[existing_base_cols + product_cols]
    df = df.fillna('') # ìˆ˜ëŸ‰ ì—†ëŠ” ì¹¸ ë¹ˆì¹¸ ì²˜ë¦¬

    # ì´í•©ê³„ í–‰ ì¶”ê°€ (ê¶Œí•œ ìˆëŠ” í’ˆëª© í•©ê³„ë§Œ)
    total_row = {c: "" for c in df.columns}
    total_row["ì£¼ë¬¸ë²ˆí˜¸"] = "ì´í•©ê³„"
    if "ê²°ì œê¸ˆì•¡" in df.columns:
        total_row["ê²°ì œê¸ˆì•¡"] = pd.to_numeric(df["ê²°ì œê¸ˆì•¡"], errors="coerce").fillna(0).astype(int).sum()
    df = pd.concat([df, pd.DataFrame([total_row])], ignore_index=True)

    out = BytesIO()
    with pd.ExcelWriter(out, engine='openpyxl') as w:
        df.to_excel(w, index=False)
    
    out.seek(0)
    filename = f"ë°”êµ¬ë‹ˆì‚¼ì´Œ_ì£¼ë¬¸ì •ì‚°_{datetime.now().strftime('%m%d_%H%M')}.xlsx"
    return send_file(out, download_name=filename, as_attachment=True)
    # ë°ì´í„°í”„ë ˆì„ ìƒì„± ë° ì—´ ìˆœì„œ ì •ë¦¬
    df = pd.DataFrame(data)
    
    # ê¸°ë³¸ ì •ë³´ ì—´ ë¦¬ìŠ¤íŠ¸
    base_cols = ["ì¼ì‹œ", "ì£¼ë¬¸ë²ˆí˜¸", "ê³ ê°ëª…", "ì „í™”ë²ˆí˜¸", "ì£¼ì†Œ", "ë©”ëª¨", "ê²°ì œê¸ˆì•¡", "ìƒíƒœ"]
    # ì‹¤ì œ ìƒì„±ëœ ìƒí’ˆ ì—´ë“¤ë§Œ ì¶”ì¶œí•˜ì—¬ ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬
    exist_prod_cols = sorted([c for c in all_product_columns if c in df.columns])
    
    # ìµœì¢… ì—´ ìˆœì„œ í™•ì • (ê¸°ë³¸ì •ë³´ + ìƒí’ˆì—´)
    df = df[base_cols + exist_prod_cols]
    # ìˆ˜ëŸ‰ì´ ì—†ëŠ” ì¹¸(NaN)ì€ 0 ë˜ëŠ” ë¹ˆì¹¸ìœ¼ë¡œ ì²˜ë¦¬ (ìˆ˜ëŸ‰ ì§‘ê³„ë¥¼ ìœ„í•´ 0 ì¶”ì²œ)
    df = df.fillna('') 

    # ë©”ëª¨ë¦¬ ë²„í¼ì— ì—‘ì…€ ì“°ê¸°
    out = BytesIO()
    with pd.ExcelWriter(out, engine='openpyxl') as w:
        df.to_excel(w, index=False, sheet_name='ì£¼ë¬¸ë¦¬ìŠ¤íŠ¸')
        
        # ì—‘ì…€ ì—´ ë„ˆë¹„ ìë™ ìµœì í™”
        worksheet = w.sheets['ì£¼ë¬¸ë¦¬ìŠ¤íŠ¸']
        for idx, col in enumerate(df.columns):
            column_len = df[col].astype(str).str.len().max()
            column_len = max(column_len, len(col)) + 5
            worksheet.column_dimensions[chr(65 + idx)].width = min(column_len, 60)

    out.seek(0)
    
    # íŒŒì¼ëª… í•œê¸€ ê¹¨ì§ ë°©ì§€ ì¸ì½”ë”©
    filename = f"ë°”êµ¬ë‹ˆì‚¼ì´Œ_ì£¼ë¬¸ë°ì´í„°_{datetime.now().strftime('%m%d_%H%M')}.xlsx"
    encoded_filename = quote(filename)
    
    response = send_file(
        out, 
        mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        as_attachment=True, 
        download_name=filename
    )
    response.headers["Content-Disposition"] = f"attachment; filename={encoded_filename}; filename*=UTF-8''{encoded_filename}"
    
    return response

# --------------------------------------------------------------------------------
# 9. ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ë° ì„œë²„ ì‹¤í–‰
# --------------------------------------------------------------------------------

def init_db():
    """ë°ì´í„°ë² ì´ìŠ¤ ë° ê¸°ì´ˆ ë°ì´í„° ìƒì„±"""
    with app.app_context():
        # ëª¨ë“  í…Œì´ë¸”(Settlement í¬í•¨) ìƒì„±
        db.create_all()
        # ëˆ„ë½ëœ ì»¬ëŸ¼ ìˆ˜ë™ ì¶”ê°€ (ALTER TABLE ë¡œì§). ë°°í¬ í›„ì—ë„ ìƒˆ ì»¬ëŸ¼ì´ ì—†ìœ¼ë©´ ìë™ ì¶”ê°€ë˜ì–´ DB ì˜¤ë¥˜ ë°©ì§€.
        cols = [
            ("product", "description", "VARCHAR(200)"),
            ("product", "detail_image_url", "TEXT"),
            ("user", "request_memo", "VARCHAR(500)"),
            ("order", "delivery_fee", "INTEGER DEFAULT 0"),
            ("product", "badge", "VARCHAR(50)"),
            ("category", "seller_name", "VARCHAR(100)"),
            ("category", "seller_inquiry_link", "VARCHAR(500)"),
            ("category", "order", "INTEGER DEFAULT 0"),
            ("category", "description", "VARCHAR(200)"),
            ("category", "biz_name", "VARCHAR(100)"),
            ("category", "biz_representative", "VARCHAR(50)"),
            ("category", "biz_reg_number", "VARCHAR(50)"),
            ("category", "biz_address", "VARCHAR(200)"),
            ("category", "biz_contact", "VARCHAR(50)"),
            ("category", "bank_name", "VARCHAR(50)"),
            ("category", "account_holder", "VARCHAR(100)"),
            ("category", "settlement_account", "VARCHAR(50)"),
            ("order", "status", "VARCHAR(20) DEFAULT 'ê²°ì œì™„ë£Œ'"),
            ("review", "user_name", "VARCHAR(50)"),
            ("review", "product_name", "VARCHAR(100)"),
            ("review", "order_id", "INTEGER"),
            ("review", "category_id", "INTEGER"),
            ("order_item", "item_status", "VARCHAR(30) DEFAULT 'ê²°ì œì™„ë£Œ'"),
            ("order_item", "status_message", "TEXT"),
            ("order_item", "delivery_proof_image_url", "VARCHAR(500)"),
            ("user_message", "image_url", "VARCHAR(500)"),
            ("restaurant_request", "admin_notes", "TEXT"),
            ("partnership_inquiry", "is_secret", "BOOLEAN DEFAULT 1"),
            ("partnership_inquiry", "admin_notes", "TEXT"),
            ("partnership_inquiry", "is_hidden", "BOOLEAN DEFAULT 0"),
            ("product", "view_count", "INTEGER DEFAULT 0"),
            ("product", "supply_price", "INTEGER"),
            ("user", "utm_source", "VARCHAR(100)"),
            ("user", "utm_medium", "VARCHAR(100)"),
            ("user", "utm_campaign", "VARCHAR(100)"),
            ("order", "utm_source", "VARCHAR(100)"),
            ("order", "utm_medium", "VARCHAR(100)"),
            ("order", "utm_campaign", "VARCHAR(100)"),
        ]
        for t, c, ct in cols:
            try:
                existing = []
                if db.engine.dialect.name == "sqlite":
                    rp = db.session.execute(text(f'PRAGMA table_info("{t}")')).fetchall()
                    existing = [row[1] for row in rp] if rp else []
                if c in existing:
                    continue
                db.session.execute(text(f"ALTER TABLE \"{t}\" ADD COLUMN \"{c}\" {ct}"))
                db.session.commit()
            except Exception:
                db.session.rollback()

        # ê¸°ì¡´ ë¦¬ë·°ì— íŒë§¤ì(category_id) ë³´ì •: product_id -> ìƒí’ˆì˜ ì¹´í…Œê³ ë¦¬ -> category.id
        try:
            for r in Review.query.filter(Review.category_id == None):
                if r.product_id:
                    p = Product.query.get(r.product_id)
                    if p:
                        cat = Category.query.filter_by(name=p.category).first()
                        if cat:
                            r.category_id = cat.id
            db.session.commit()
        except Exception:
            db.session.rollback()
        
        # ê´€ë¦¬ì ê³„ì • ìƒì„± ë¡œì§ ë™ì¼ ìœ ì§€
        if not User.query.filter_by(email="admin@uncle.com").first():
            db.session.add(User(email="admin@uncle.com", password=generate_password_hash("1234"), name="ë°”êµ¬ë‹ˆì‚¼ì´Œ", is_admin=True))
        db.session.commit()
            
        # ê¸°ì´ˆ ë°ì´í„° (ê´€ë¦¬ì ë° ìƒ˜í”Œ ì¹´í…Œê³ ë¦¬)
        if not User.query.filter_by(email="admin@uncle.com").first():
            db.session.add(User(email="admin@uncle.com", password=generate_password_hash("1234"), name="ë°”êµ¬ë‹ˆì‚¼ì´Œ", is_admin=True))
        if not Category.query.first():
            db.session.add(Category(name="ì‹ ì„  ë†ì‚°ë¬¼", tax_type="ë©´ì„¸", order=0, description="ë¬¼ë¥˜ ì „ë¬¸ê°€ê°€ ì—„ì„ í•œ ì‚°ì§€ì§ì†¡ ì œì²  ë†ì‚°ë¬¼ì…ë‹ˆë‹¤.")); 
            db.session.add(Category(name="í”„ë¦¬ë¯¸ì—„ ê³µë™êµ¬ë§¤", tax_type="ê³¼ì„¸", order=1, description="ìœ í†µ ë‹¨ê³„ë¥¼ íŒŒê²©ì ìœ¼ë¡œ ì¤„ì¸ ì†¡ë„ ì „ìš© ê³µêµ¬ ìƒí’ˆì…ë‹ˆë‹¤."));
        db.session.commit()

# [ìˆ˜ì • ìœ„ì¹˜: app.py íŒŒì¼ ê°€ì¥ ë§ˆì§€ë§‰ ë¶€ë¶„]

import subprocess

# --- ìˆ˜ì • ì „ ê¸°ì¡´ ì½”ë“œ ---
# if __name__ == "__main__":
#     init_db()
#     if os.environ.get("WERKZEUG_RUN_MAIN") != "true":
#         subprocess.Popen(["python", delivery_script])
#     app.run(host="0.0.0.0", port=5000, debug=True)

# --- ìˆ˜ì • í›„ (ì´ ë¶€ë¶„ìœ¼ë¡œ êµì²´í•˜ì„¸ìš”) ---
if __name__ == "__main__":
    with app.app_context():
        # ì‡¼í•‘ëª° í…Œì´ë¸”ê³¼ ë°°ì†¡ í…Œì´ë¸”ì„ ê°ê°ì˜ DB íŒŒì¼ì— ìƒì„±í•©ë‹ˆë‹¤.
        db.create_all() # BINDS ì„¤ì •ì— ë”°ë¼ ìë™ìœ¼ë¡œ ë¶„ë¦¬ ìƒì„±ë¨
        
        # [ë³µêµ¬] ë°°ì†¡ ì‹œìŠ¤í…œ ìµœì´ˆ ê´€ë¦¬ì ìƒì„± ë¡œì§ ì¶”ê°€
        from delivery_system import AdminUser
        if not AdminUser.query.filter_by(username='admin').first():
            db.session.add(AdminUser(username="admin", password="1234"))
            db.session.commit()
    # ë¡œì»¬ ì‹¤í–‰ ì‹œ ë§¤ì¼ í•œêµ­ì‹œê°„ ìƒˆë²½ 4ì‹œ ìë™ ë°±ì—…
    if GITHUB_BACKUP_TOKEN and GITHUB_BACKUP_REPO:
        try:
            from apscheduler.schedulers.background import BackgroundScheduler  # type: ignore[reportMissingImports]
            from apscheduler.triggers.cron import CronTrigger  # type: ignore[reportMissingImports]
            _scheduler = BackgroundScheduler(timezone="Asia/Seoul")
            def _scheduled_backup():
                with app.app_context():
                    run_backup()
            _scheduler.add_job(_scheduled_backup, CronTrigger(hour=4, minute=0), id="daily_backup")
            _scheduler.start()
        except Exception:
            pass
# í”„ë¡œë•ì…˜(gunicorn ë“±) ì•± ë¡œë“œ ì‹œ í…Œì´ë¸” ìƒì„± + ë§ˆì´ê·¸ë ˆì´ì…˜
with app.app_context():
    db.create_all()
    from sqlalchemy import text
    try:
        rp = db.session.execute(text("PRAGMA table_info(settlement)")).fetchall()
        cols = [row[1] for row in rp] if rp else []
        if cols and 'settlement_no' not in cols:
            # ê¸°ì¡´ settlementëŠ” êµ¬ ìŠ¤í‚¤ë§ˆ â†’ category_settlementë¡œ ì´ë¦„ ë³€ê²½ í›„ ìƒˆ settlement ìƒì„±
            try:
                db.session.execute(text("ALTER TABLE settlement RENAME TO category_settlement"))
                db.session.commit()
            except Exception:
                db.session.rollback()
                try:
                    db.session.execute(text("DROP TABLE IF EXISTS category_settlement"))
                    db.session.execute(text("ALTER TABLE settlement RENAME TO category_settlement"))
                    db.session.commit()
                except Exception:
                    db.session.rollback()
    except Exception:
        db.session.rollback()
    try:
        db.session.execute(text("SELECT 1 FROM settlement LIMIT 1"))
    except Exception:
        db.create_all()
    try:
        db.session.execute(text('ALTER TABLE "order" ADD COLUMN is_settled INTEGER DEFAULT 0'))
        db.session.execute(text('ALTER TABLE "order" ADD COLUMN settled_at DATETIME'))
        db.session.commit()
    except: pass
    try:
        db.session.execute(text('ALTER TABLE "order" ADD COLUMN settlement_status VARCHAR(20) DEFAULT \'ì…ê¸ˆëŒ€ê¸°\''))
        db.session.commit()
    except: pass
    try:
        db.session.execute(text('UPDATE "order" SET settlement_status = \'ì…ê¸ˆëŒ€ê¸°\' WHERE settlement_status = \'ì •ì‚°ëŒ€ê¸°\''))
        db.session.execute(text('UPDATE "order" SET settlement_status = \'ì…ê¸ˆì™„ë£Œ\' WHERE settlement_status = \'ì •ì‚°ì™„ë£Œ\''))
        db.session.commit()
    except: pass
    try:
        db.session.execute(text('ALTER TABLE order_item ADD COLUMN settlement_status VARCHAR(20) DEFAULT \'ì…ê¸ˆëŒ€ê¸°\''))
        db.session.commit()
    except: pass
    try:
        db.session.execute(text('ALTER TABLE order_item ADD COLUMN settled_at DATETIME'))
        db.session.commit()
    except: pass
    # íšŒì› ë“±ê¸‰ ì»¬ëŸ¼ ì¶”ê°€ (ê¸°ì¡´ DB í˜¸í™˜)
    try:
        db.session.execute(text('ALTER TABLE user ADD COLUMN member_grade INTEGER DEFAULT 1'))
        db.session.commit()
    except Exception:
        db.session.rollback()
    try:
        db.session.execute(text('ALTER TABLE user ADD COLUMN member_grade_overridden INTEGER DEFAULT 0'))
        db.session.commit()
    except Exception:
        db.session.rollback()
    try:
        db.session.execute(text('ALTER TABLE category ADD COLUMN min_member_grade INTEGER'))
        db.session.commit()
    except Exception:
        db.session.rollback()
    try:
        db.session.execute(text('ALTER TABLE user ADD COLUMN points INTEGER DEFAULT 0'))
        db.session.commit()
    except Exception:
        db.session.rollback()
    # ì†Œì…œ ë¡œê·¸ì¸ ì»¬ëŸ¼ (ê¸°ì¡´ DB í˜¸í™˜)
    try:
        db.session.execute(text('ALTER TABLE user ADD COLUMN auth_provider VARCHAR(20)'))
        db.session.commit()
    except Exception:
        db.session.rollback()
    try:
        db.session.execute(text('ALTER TABLE user ADD COLUMN auth_provider_id VARCHAR(100)'))
        db.session.commit()
    except Exception:
        db.session.rollback()
    try:
        db.session.execute(text('ALTER TABLE "order" ADD COLUMN points_used INTEGER DEFAULT 0'))
        db.session.commit()
    except Exception:
        db.session.rollback()
    try:
        db.session.execute(text('ALTER TABLE point_log ADD COLUMN order_item_id INTEGER'))
        db.session.commit()
    except Exception:
        db.session.rollback()
    try:
        db.session.execute(text('ALTER TABLE point_log ADD COLUMN adjusted_by INTEGER'))
        db.session.commit()
    except Exception:
        db.session.rollback()
    # product ì¬ê³  ì´ˆê¸°í™” ì»¬ëŸ¼ (ê¸°ì¡´ DB í˜¸í™˜)
    try:
        db.session.execute(text('ALTER TABLE product ADD COLUMN reset_time VARCHAR(5)'))
        db.session.commit()
    except Exception:
        db.session.rollback()
    try:
        db.session.execute(text('ALTER TABLE product ADD COLUMN reset_to_quantity INTEGER'))
        db.session.commit()
    except Exception:
        db.session.rollback()
    try:
        db.session.execute(text('ALTER TABLE product ADD COLUMN last_reset_at DATETIME'))
        db.session.commit()
    except Exception:
        db.session.rollback()
    init_db() # ê¸°ì¡´ ì‡¼í•‘ëª° ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
    
    # ë¡œì»¬ í…ŒìŠ¤íŠ¸ ë° Render ë°°í¬ í˜¸í™˜ í¬íŠ¸ ì„¤ì • (ê¸°ë³¸ 5000)
    port = int(os.environ.get("PORT", 5000))
    root = os.path.dirname(os.path.abspath(__file__))
    extra_files = [
        os.path.join(root, "app.py"),
        os.path.join(root, "delivery_system.py"),
    ]
    app.run(host="0.0.0.0", port=port, debug=True, use_reloader=True, extra_files=extra_files)