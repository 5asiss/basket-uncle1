@app.route('/admin/settlement/complete', methods=['POST'])
# --------------------------------------------------------------------------------
# 5. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë° ë¼ìš°íŒ… (ë³´ì™„ ì™„ë£Œ ë²„ì „)
# --------------------------------------------------------------------------------
@login_required
def admin_settlement_complete():
    """ë§ˆìŠ¤í„° ê´€ë¦¬ìê°€ íŠ¹ì • ì¹´í…Œê³ ë¦¬ì˜ ë§¤ì¶œì„ ì •ì‚° ì™„ë£Œ ì²˜ë¦¬"""
    if not current_user.is_admin:
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403

    data = request.get_json()
    cat_name = data.get('category_name')
    amount = data.get('amount')
    manager_email = data.get('manager_email')

    try:
        # 1. ì •ì‚° ê¸°ë¡ ìƒì„± (ì¹´í…Œê³ ë¦¬ë³„ ì •ì‚° ë‚´ì—­)
        new_settle = CategorySettlement(
            category_name=cat_name,
            manager_email=manager_email,
            total_sales=amount,
            settlement_amount=amount,
            status='ì…ê¸ˆì™„ë£Œ',
            completed_at=datetime.now()
        )
        db.session.add(new_settle)
        
        # 2. í•´ë‹¹ ê¸°ê°„/ì¹´í…Œê³ ë¦¬ì˜ ì£¼ë¬¸ ìƒíƒœë¥¼ 'ì •ì‚°ì™„ë£Œ'ë¡œ ì—…ë°ì´íŠ¸í•˜ê³  ì‹¶ë‹¤ë©´ 
        # ì—¬ê¸°ì— ì¶”ê°€ ë¡œì§ì„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (í˜„ì¬ëŠ” ê¸°ë¡ë§Œ ë‚¨ê¹€)
        
        db.session.commit()
        return jsonify({"success": True, "message": f"{cat_name} ì •ì‚° ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."})
    except Exception as e:
        db.session.rollback()
@app.route('/admin/settlement/order_status', methods=['POST'])
        return jsonify({"success": False, "message": str(e)})


@login_required
def admin_settlement_order_status():
    """ê´€ë¦¬ìÂ·ì¹´í…Œê³ ë¦¬ê´€ë¦¬ì: ì£¼ë¬¸ë³„ ì •ì‚°ìƒíƒœ(ì…ê¸ˆìƒíƒœ) ë³€ê²½ (ì…ê¸ˆëŒ€ê¸°/ì…ê¸ˆì™„ë£Œ/ì·¨ì†Œ/ë³´ë¥˜)"""
    data = request.get_json() or {}
    try:
        order_id = data.get('order_id')
        if order_id is None:
            return jsonify({"success": False, "message": "order_idê°€ ì—†ìŠµë‹ˆë‹¤."}), 400
        order_id = int(order_id)
    except (TypeError, ValueError):
        return jsonify({"success": False, "message": "order_idê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."}), 400
    settlement_status = (data.get('settlement_status') or '').strip()
    if settlement_status not in ('ì…ê¸ˆëŒ€ê¸°', 'ì…ê¸ˆì™„ë£Œ', 'ì·¨ì†Œ', 'ë³´ë¥˜'):
        return jsonify({"success": False, "message": "ìœ íš¨í•œ ì…ê¸ˆìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤."}), 400
    o = Order.query.get(order_id)
    if not o:
        return jsonify({"success": False, "message": "ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 404
    if not current_user.is_admin:
        my_cats = [c.name for c in Category.query.filter_by(manager_email=current_user.email).all()]
        if not my_cats:
            return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
        order_items = OrderItem.query.filter_by(order_id=o.id).all()
        if not any(getattr(oi, 'product_category', None) in my_cats for oi in order_items):
            return jsonify({"success": False, "message": "í•´ë‹¹ ì£¼ë¬¸ì— ëŒ€í•œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    # ì´ë¯¸ ìš”ì²­í•œ ìƒíƒœì™€ ê°™ìœ¼ë©´ ì„±ê³µ ì²˜ë¦¬ (ì¬í´ë¦­ ì‹œ ì˜¤ë¥˜ ë°©ì§€)
    if getattr(o, 'settlement_status', None) == settlement_status:
        return jsonify({"success": True, "message": "ì´ë¯¸ í•´ë‹¹ ìƒíƒœì…ë‹ˆë‹¤."})
    if getattr(o, 'settlement_status', None) == 'ì…ê¸ˆì™„ë£Œ' and settlement_status != 'ì…ê¸ˆì™„ë£Œ':
        return jsonify({"success": False, "message": "ì´ë¯¸ ì…ê¸ˆì™„ë£Œëœ ì£¼ë¬¸ì€ ë‹¤ë¥¸ ìƒíƒœë¡œ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 400
    old_settlement = getattr(o, 'settlement_status', None) or 'ì…ê¸ˆëŒ€ê¸°'
    o.settlement_status = settlement_status
    if settlement_status == 'ì…ê¸ˆì™„ë£Œ':
        o.is_settled = True
        o.settled_at = datetime.now()
    else:
        o.is_settled = False
        o.settled_at = None
    # í•´ë‹¹ ì£¼ë¬¸ì˜ ëª¨ë“  í’ˆëª©(OrderItem)ë„ ë™ì¼í•œ ì…ê¸ˆìƒíƒœë¡œ ì¼ê´„ ë°˜ì˜ (ì •ì‚°ìƒì„¸ëŠ” í’ˆëª© ë‹¨ìœ„ í‘œì‹œ)
    for oi in OrderItem.query.filter_by(order_id=o.id).all():
        oi.settlement_status = settlement_status
        if settlement_status == 'ì…ê¸ˆì™„ë£Œ':
            oi.settled_at = datetime.now()
        else:
            oi.settled_at = None
        db.session.add(OrderItemLog(order_id=o.id, order_item_id=oi.id, log_type='settlement_status', old_value=old_settlement, new_value=settlement_status, created_at=datetime.now()))
    db.session.add(OrderItemLog(order_id=o.id, order_item_id=None, log_type='settlement_status', old_value=old_settlement, new_value=settlement_status, created_at=datetime.now()))
    try:
        db.session.commit()
    except Exception as e:
        db.session.rollback()
        return jsonify({"success": False, "message": "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + str(e)}), 500
@app.route('/admin/settlement/item_status', methods=['POST'])
    return jsonify({"success": True, "message": "ì…ê¸ˆìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."})


@login_required
def admin_settlement_item_status():
    """í’ˆëª©ID(OrderItem) ê¸°ì¤€ ì…ê¸ˆìƒíƒœ ê°œë³„ ë³€ê²½ (ì…ê¸ˆì™„ë£ŒëŠ” í’ˆëª©ë³„ ì ìš©)"""
    data = request.get_json() or {}
    order_id = data.get('order_id')  # Order.id (pk)
    item_id = data.get('item_id')    # OrderItem.id (pk)
    settlement_status = (data.get('settlement_status') or '').strip()
    if settlement_status not in ('ì…ê¸ˆëŒ€ê¸°', 'ì…ê¸ˆì™„ë£Œ', 'ì·¨ì†Œ', 'ë³´ë¥˜'):
        return jsonify({"success": False, "message": "ìœ íš¨í•œ ì…ê¸ˆìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤."}), 400
    if not order_id or not item_id:
        return jsonify({"success": False, "message": "order_idì™€ item_idê°€ í•„ìš”í•©ë‹ˆë‹¤."}), 400
    o = Order.query.get(order_id)
    if not o:
        return jsonify({"success": False, "message": "ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 404
    oi = OrderItem.query.filter_by(id=int(item_id), order_id=int(order_id)).first()
    if not oi:
        return jsonify({"success": False, "message": "í’ˆëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 404
    if not current_user.is_admin:
        my_cats = [c.name for c in Category.query.filter_by(manager_email=current_user.email).all()]
        if not my_cats or oi.product_category not in my_cats:
            return jsonify({"success": False, "message": "í•´ë‹¹ í’ˆëª©ì— ëŒ€í•œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    old_settlement = getattr(oi, 'settlement_status', None) or 'ì…ê¸ˆëŒ€ê¸°'
    oi.settlement_status = settlement_status
    if settlement_status == 'ì…ê¸ˆì™„ë£Œ':
        oi.settled_at = datetime.now()
    else:
        oi.settled_at = None
    db.session.add(OrderItemLog(order_id=o.id, order_item_id=oi.id, log_type='settlement_status', old_value=old_settlement, new_value=settlement_status, created_at=datetime.now()))
    # Settlement í…Œì´ë¸”ë„ ë™ê¸°í™” (ì •ì‚° ìƒì„¸ëŠ” Settlement ê¸°ì¤€ ì¡°íšŒ)
    st = Settlement.query.filter_by(order_item_id=oi.id).first()
    if st:
        st.settlement_status = settlement_status
        st.settled_at = datetime.now() if settlement_status == 'ì…ê¸ˆì™„ë£Œ' else None
    db.session.commit()
@app.route('/admin/settlement/bulk_item_status', methods=['POST'])
    return jsonify({"success": True, "message": "í’ˆëª© ì…ê¸ˆìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."})


@login_required
def admin_settlement_bulk_item_status():
    """ì •ì‚° ìƒì„¸ì—ì„œ ì„ íƒí•œ í’ˆëª©ë“¤(OrderItem) ì…ê¸ˆìƒíƒœ ì¼ê´„ ë³€ê²½"""
    data = request.get_json() or {}
    item_ids = data.get('order_item_ids') or data.get('item_ids') or []
    if isinstance(item_ids, str):
        item_ids = [x.strip() for x in item_ids.split(',') if x.strip()]
    item_ids = [int(x) for x in item_ids if str(x).isdigit()]
    settlement_status = (data.get('settlement_status') or '').strip()
    if settlement_status not in ('ì…ê¸ˆëŒ€ê¸°', 'ì…ê¸ˆì™„ë£Œ', 'ì·¨ì†Œ', 'ë³´ë¥˜'):
        return jsonify({"success": False, "message": "ìœ íš¨í•œ ì…ê¸ˆìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤."}), 400
    if not item_ids:
        return jsonify({"success": False, "message": "ì„ íƒí•œ í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤."}), 400
    is_master = current_user.is_admin
    my_cats = [] if is_master else [c.name for c in Category.query.filter_by(manager_email=current_user.email).all()]
    updated = 0
    for oi_id in item_ids:
        oi = OrderItem.query.get(oi_id)
        if not oi:
            continue
        if not is_master and (not my_cats or getattr(oi, 'product_category', None) not in my_cats):
            continue
        old_st = getattr(oi, 'settlement_status', None) or 'ì…ê¸ˆëŒ€ê¸°'
        oi.settlement_status = settlement_status
        if settlement_status == 'ì…ê¸ˆì™„ë£Œ':
            oi.settled_at = datetime.now()
        else:
            oi.settled_at = None
        db.session.add(OrderItemLog(order_id=oi.order_id, order_item_id=oi.id, log_type='settlement_status', old_value=old_st, new_value=settlement_status, created_at=datetime.now()))
        st = Settlement.query.filter_by(order_item_id=oi.id).first()
        if st:
            st.settlement_status = settlement_status
            st.settled_at = datetime.now() if settlement_status == 'ì…ê¸ˆì™„ë£Œ' else None
        updated += 1
    db.session.commit()
@app.route('/admin/messages/send', methods=['POST'])
    return jsonify({"success": True, "message": f"{updated}ê±´ ì…ê¸ˆìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.", "updated": updated})


@login_required
def admin_messages_send():
    """ê´€ë¦¬ì: íšŒì› ë“±ê¸‰ë³„ë¡œ ë©”ì‹œì§€ ì¼ê´„ ë°œì†¡ (ê°€ì…ì¸ì‚¬Â·ì´ë²¤íŠ¸Â·ê³µì§€Â·ì•ˆë‚´Â·ì§ì ‘ì‘ì„±)"""
    if not current_user.is_admin:
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    data = request.get_json() or request.form
    target = data.get('target_grade', 'all')  # 1,2,3,4,5 or 'all'
    msg_type = (data.get('msg_type') or 'custom').strip() or 'custom'
    title = (data.get('title') or '').strip()
    body = (data.get('body') or '').strip()
    if not title:
        return jsonify({"success": False, "message": "ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."})
    q = User.query.filter(User.is_admin == False)
    if target != 'all' and str(target).isdigit():
        g = int(target)
        if 1 <= g <= 5:
            q = q.filter(User.member_grade == g)
    users = q.all()
    count = 0
    for u in users:
        send_message(u.id, title, body, msg_type, None)
        count += 1
    db.session.commit()
@app.route('/admin/messages/template', methods=['POST'])
    return jsonify({"success": True, "message": f"{count}ëª…ì—ê²Œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.", "count": count})


@login_required
def admin_messages_template():
    """ê´€ë¦¬ì: ìë™ ë°œì†¡ í…œí”Œë¦¿ ì €ì¥. msg_type, title, body. {order_id}ëŠ” ë°œì†¡ ì‹œ ì£¼ë¬¸ë²ˆí˜¸ë¡œ ì¹˜í™˜ë¨."""
    if not current_user.is_admin:
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    data = request.get_json() or request.form
    msg_type = (data.get('msg_type') or '').strip()
    title = (data.get('title') or '').strip()
    body = (data.get('body') or '').strip()
    if not msg_type:
        return jsonify({"success": False, "message": "msg_typeì´ í•„ìš”í•©ë‹ˆë‹¤."})
    t = MessageTemplate.query.filter_by(msg_type=msg_type).first()
    if not t:
        t = MessageTemplate(msg_type=msg_type, title=title or 'ì•Œë¦¼', body=body)
        db.session.add(t)
    else:
        t.title = title or t.title or 'ì•Œë¦¼'
        t.body = body
    db.session.commit()
    return jsonify({"success": True, "message": "í…œí”Œë¦¿ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."})


@app.route('/api/messages/unread_count')
@login_required
def api_messages_unread_count():
    """ë¡œê·¸ì¸ ì‚¬ìš©ìì˜ ë¯¸ì½ìŒ ë©”ì‹œì§€ ê°œìˆ˜ (ì•Œë¦¼ ë°” í‘œì‹œìš©)."""
    n = UserMessage.query.filter_by(user_id=current_user.id, read_at=None).count()
    return jsonify({"count": n})


@app.route('/api/popup/current')
def api_popup_current():
    """í˜„ì¬ ë…¸ì¶œí•  ì•Œë¦¼ íŒì—… 1ê±´. ë…¸ì¶œ ê¸°ê°„ ë‚´Â·í™œì„±ë§Œ. ì—†ìœ¼ë©´ null."""
    now = datetime.now()
    q = SitePopup.query.filter(
        SitePopup.is_active == True,
        db.or_(SitePopup.start_at.is_(None), SitePopup.start_at <= now),
        db.or_(SitePopup.end_at.is_(None), SitePopup.end_at >= now)
    ).order_by(SitePopup.sort_order.asc(), SitePopup.end_at.asc().nullslast())
    pop = q.first()
    if not pop:
        return jsonify(None)
    return jsonify({
        'id': pop.id,
        'title': pop.title or '',
        'body': pop.body or '',
        'popup_type': pop.popup_type or 'notice',
        'image_url': pop.image_url or '',
        'display_date': pop.display_date or ''
@app.route('/admin/popup/save', methods=['POST'])
    })


@login_required
def admin_popup_save():
    """ì•Œë¦¼ íŒì—… ì €ì¥. id ìˆìœ¼ë©´ ìˆ˜ì •, ì—†ìœ¼ë©´ ì‹ ê·œ."""
    if not current_user.is_admin:
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    data = request.get_json() or request.form
    try:
        pid = data.get('id')
        pid = int(pid) if pid not in (None, '') else None
    except (TypeError, ValueError):
        pid = None
    title = (data.get('title') or '').strip()
    if not title:
        return jsonify({"success": False, "message": "ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."})
    body = (data.get('body') or '').strip()
    popup_type = (data.get('popup_type') or 'notice').strip() or 'notice'
    image_url = (data.get('image_url') or '').strip() or None
    display_date = (data.get('display_date') or '').strip() or None
    start_at = None
    if data.get('start_at'):
        try:
            start_at = datetime.strptime(data.get('start_at')[:19], '%Y-%m-%dT%H:%M:%S')
        except Exception:
            try:
                start_at = datetime.strptime(data.get('start_at')[:16], '%Y-%m-%dT%H:%M')
            except Exception:
                pass
    end_at = None
    if data.get('end_at'):
        try:
            end_at = datetime.strptime(data.get('end_at')[:19], '%Y-%m-%dT%H:%M:%S')
        except Exception:
            try:
                end_at = datetime.strptime(data.get('end_at')[:16], '%Y-%m-%dT%H:%M')
            except Exception:
                pass
    is_active = data.get('is_active') not in (False, 'false', '0', 0)
    sort_order = int(data.get('sort_order') or 0)
    if pid:
        pop = SitePopup.query.get(pid)
        if not pop:
            return jsonify({"success": False, "message": "í•´ë‹¹ íŒì—…ì´ ì—†ìŠµë‹ˆë‹¤."})
    else:
        pop = SitePopup()
    pop.title = title
    pop.body = body
    pop.popup_type = popup_type
    pop.image_url = image_url
    pop.display_date = display_date
    pop.start_at = start_at
    pop.end_at = end_at
    pop.is_active = is_active
    pop.sort_order = sort_order
    if not pid:
        db.session.add(pop)
    db.session.commit()
@app.route('/admin/popup/delete/<int:pid>', methods=['POST'])
    return jsonify({"success": True, "message": "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.", "id": pop.id})


@login_required
def admin_popup_delete(pid):
    if not current_user.is_admin:
        return jsonify({"success": False}), 403
    pop = SitePopup.query.get(pid)
    if pop:
        db.session.delete(pop)
        db.session.commit()
@app.route('/admin/popup/upload', methods=['POST'])
    return jsonify({"success": True})


@login_required
def admin_popup_upload():
    """ì•Œë¦¼ íŒì—…ìš© ì´ë¯¸ì§€ ì—…ë¡œë“œ. ë°˜í™˜: { url: /static/uploads/... }"""
    if not current_user.is_admin:
        return jsonify({"success": False}), 403
    f = request.files.get('image')
    if not f or f.filename == '':
        return jsonify({"success": False, "message": "ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”."}), 400
    path = save_uploaded_file(f)
    if not path:
        return jsonify({"success": False, "message": "ì—…ë¡œë“œ ì‹¤íŒ¨"}), 400
    return jsonify({"success": True, "url": path})


@app.route('/api/push/vapid-public')
def api_push_vapid_public():
    """Web Push êµ¬ë… ì‹œ í•„ìš”í•œ VAPID ê³µê°œí‚¤. ë¡œê·¸ì¸ ë¶ˆí•„ìš”."""
    key = os.getenv('VAPID_PUBLIC_KEY')
    if not key:
        return jsonify({"error": "í‘¸ì‹œ ì•Œë¦¼ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."}), 503
    return jsonify({"publicKey": key})


@app.route('/api/push/subscribe', methods=['POST'])
@login_required
def api_push_subscribe():
    """í˜„ì¬ ì‚¬ìš©ìì˜ í‘¸ì‹œ êµ¬ë… ë“±ë¡. body: { subscription: { endpoint, keys: { p256dh, auth } } }"""
    key = os.getenv('VAPID_PUBLIC_KEY')
    if not key:
        return jsonify({"success": False, "message": "í‘¸ì‹œ ì•Œë¦¼ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."}), 503
    data = request.get_json()
    if not data or not data.get('subscription'):
        return jsonify({"success": False, "message": "subscriptionì´ í•„ìš”í•©ë‹ˆë‹¤."}), 400
    sub = data['subscription']
    endpoint = (sub.get('endpoint') or '').strip()
    keys = sub.get('keys') or {}
    p256dh = (keys.get('p256dh') or keys.get('p256dh') or '').strip()
    auth = (keys.get('auth') or '').strip()
    if not endpoint or not p256dh or not auth:
        return jsonify({"success": False, "message": "endpoint, keys.p256dh, keys.authê°€ í•„ìš”í•©ë‹ˆë‹¤."}), 400
    existing = PushSubscription.query.filter_by(user_id=current_user.id, endpoint=endpoint).first()
    if existing:
        existing.p256dh = p256dh
        existing.auth = auth
    else:
        db.session.add(PushSubscription(user_id=current_user.id, endpoint=endpoint, p256dh=p256dh, auth=auth))
    db.session.commit()
@app.route('/admin/order/print')
    return jsonify({"success": True, "message": "ì•Œë¦¼ì´ ì¼œì¡ŒìŠµë‹ˆë‹¤."})


@login_required
def admin_order_print():
    if not (current_user.is_admin or Category.query.filter_by(manager_email=current_user.email).first()):
        return "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.", 403

    categories = Category.query.all()
    my_categories = [c.name for c in categories if c.manager_email == current_user.email]
    is_master = current_user.is_admin

    order_ids = request.args.get('ids', '').split(',')
    target_orders = Order.query.filter(Order.order_id.in_(order_ids)).all()

    # ë°ì´í„° ê°€ê³µ (ë§ˆìŠ¤í‚¹ ë° ìš”ì•½)
    processed_orders = []
    for o in target_orders:
        # ì„±í•¨/ë²ˆí˜¸ ë§ˆìŠ¤í‚¹ ë™ì¼
        name = o.customer_name or ""
        masked_name = name[0] + "*" * (len(name)-1) if len(name) > 1 else name
        
        phone = o.customer_phone or ""
        phone_parts = phone.split('-')
        masked_phone = f"{phone_parts[0]}-****-{phone_parts[2]}" if len(phone_parts) == 3 else "****"

        # âœ… í’ˆëª©: ë§ˆìŠ¤í„°ëŠ” ì „ì²´, ì¹´í…Œê³ ë¦¬ ë§¤ë‹ˆì €ëŠ” í•´ë‹¹ ì¹´í…Œê³ ë¦¬ í’ˆëª©ë§Œ
        all_items = []
        if o.product_details:
            parts = o.product_details.split(' | ')
            for part in parts:
                match = re.search(r'\[(.*?)\] (.*)', part)
                if match:
                    cat_n = match.group(1).strip()
                    items_str = match.group(2).strip()
                    if is_master or cat_n in my_categories:
                        for item in items_str.split(', '):
                            clean_item = item.strip()
                            if clean_item:
                                all_items.append(clean_item)

        # ì¹´í…Œê³ ë¦¬ ë§¤ë‹ˆì €ëŠ” í•´ë‹¹ í’ˆëª©ì´ ì—†ëŠ” ì£¼ë¬¸ì€ ì†¡ì¥ì—ì„œ ì œì™¸
        if not is_master and not all_items:
            continue

        # âœ… í˜„ê´€ ë¹„ë°€ë²ˆí˜¸ ì œì™¸ ë¡œì§ (ìˆ«ì í¬í•¨ ë‹¨ì–´ í•„í„°ë§ ê°•í™”)
        raw_memo = o.request_memo or ""
        clean_words = [w for w in raw_memo.split() if not (any(c.isdigit() for c in w) or any(k in w for k in ['ë¹„ë²ˆ', 'ë²ˆí˜¸', 'í˜„ê´€', '#', '*']))]
        clean_memo = " ".join(clean_words) if clean_words else "ìš”ì²­ì‚¬í•­ ì—†ìŒ"

        processed_orders.append({
            'order_id': o.order_id,
            'masked_name': masked_name,
            'masked_phone': masked_phone,
            'all_items': all_items,
            'delivery_address': o.delivery_address,
            'clean_memo': clean_memo,
            'created_at': o.created_at
        })
# SyntaxWarning ë°©ì§€ë¥¼ ìœ„í•´ ì‹œì‘ ë¶€ë¶„ì— rì„ ë¶™ì—¬ r""" ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
    invoice_html = r"""
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&display=swap');
            body { font-family: 'Noto Sans KR', sans-serif; background: #f1f1f1; margin: 0; padding: 0; --inv-scale: 1; --inv-width-mm: 80; }
            .print-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; padding: 1rem; align-items: flex-start; }
            .invoice-card { background: white; border: 2px solid #000; box-sizing: border-box; display: flex; flex-direction: column; position: relative; transform-origin: top left; }
            .item-list { overflow: hidden; }
            .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

            /* A4 1ì¥: 1ê±´ì´ A4 í•œ í˜ì´ì§€ ì „ì²´ */
            body.layout-a4-1 .invoice-card { width: 21cm; min-height: 29.2cm; padding: 1.5rem; margin: 0 auto 1rem; }
            body.layout-a4-1 .item-list { max-height: 12cm; }
            /* A4 2ë¶„í•  */
            body.layout-a4-2 .print-container { flex-direction: column; align-items: center; }
            body.layout-a4-2 .invoice-card { width: 21cm; height: 14.6cm; padding: 1rem; margin: 0 auto 0.5rem; }
            body.layout-a4-2 .item-list { max-height: 4.2cm; }
            /* A4 3ë¶„í•  */
            body.layout-a4-3 .print-container { flex-direction: column; align-items: center; }
            body.layout-a4-3 .invoice-card { width: 21cm; height: 9.7cm; padding: 0.6rem; margin: 0 auto 0.3rem; }
            body.layout-a4-3 .item-list { max-height: 2.6cm; }
            /* A4 4ë“±ë¶„: ì„¸ë¡œ 2ì—´(2x2), ë¹„ìœ¨ë§ì¶° ì…€ ì•ˆì— ì¶•ì†Œ */
            body.layout-a4-4 .print-container {
                display: grid; grid-template-columns: 1fr 1fr; grid-auto-rows: 14.6cm;
                gap: 0; padding: 0; max-width: 21cm; margin: 0 auto;
            }
            body.layout-a4-4 .invoice-card {
                width: 100%; height: 100%; min-height: 0; padding: 0.4rem;
                box-sizing: border-box; margin: 0; overflow: hidden;
            }
            body.layout-a4-4 .invoice-card .text-4xl { font-size: 1rem !important; }
            body.layout-a4-4 .invoice-card .text-2xl { font-size: 0.8rem !important; }
            body.layout-a4-4 .invoice-card .text-xl { font-size: 0.7rem !important; }
            body.layout-a4-4 .item-list { max-height: 4.5cm; }
            /* íœ´ëŒ€ìš©: ê°€ë¡œí­ mm + ìŠ¤ì¼€ì¼ë¡œ ì¡°ì ˆ */
            body.layout-portable .invoice-card {
                width: calc(var(--inv-width-mm) * 0.2645833rem);
                min-height: 8cm;
                padding: 0.4rem;
                transform: scale(var(--inv-scale));
                margin: 0.5rem;
            }
            body.layout-portable .item-list { max-height: 3.5cm; }

            @media print {
                @page { size: A4; margin: 8mm; }
                .no-print { display: none !important; }
                body { background: white; }
                .print-container { gap: 0; padding: 0; }
                .invoice-card { border: 1.5px solid #000; page-break-inside: avoid; }
                body.layout-a4-1 .invoice-card { margin: 0 auto; page-break-after: always; }
                body.layout-a4-1 .invoice-card:last-child { page-break-after: auto; }
                body.layout-a4-2 .invoice-card { margin: 0 auto; }
                body.layout-a4-2 .invoice-card:nth-child(2n) { page-break-after: always; }
                body.layout-a4-2 .invoice-card:last-child:nth-child(2n-1) { page-break-after: always; }
                body.layout-a4-3 .invoice-card { margin: 0 auto; }
                body.layout-a4-3 .invoice-card:nth-child(3n) { page-break-after: always; }
                body.layout-a4-3 .invoice-card:last-child { page-break-after: always; }
                body.layout-a4-4 .print-container { display: grid; grid-template-columns: 1fr 1fr; grid-auto-rows: 14.6cm; max-width: 21cm; }
                body.layout-a4-4 .invoice-card { margin: 0; }
                body.layout-a4-4 .invoice-card:nth-child(4n) { page-break-after: always; }
                body.layout-a4-4 .invoice-card:last-child { page-break-after: always; }
                body.layout-portable .invoice-card {
                    width: calc(var(--inv-width-mm) * 0.2645833rem) !important;
                    transform: scale(var(--inv-scale)) !important;
                    margin: 0 auto 2mm !important;
                    page-break-after: always;
                }
                body.layout-portable .invoice-card:last-child { page-break-after: auto; }
            }
        </style>
    </head>
    <body class="layout-a4-2">
        <div class="no-print p-4 bg-white border-b sticky top-0 z-50 shadow-md">
            <p class="text-sm font-bold text-blue-600 mb-3">ì´ {{ orders|length }}ê±´ Â· ì¶œë ¥ ì–‘ì‹ ì„ íƒ í›„ ì¸ì‡„í•˜ì„¸ìš”.</p>
            <div class="flex flex-wrap items-center gap-3 mb-2">
                <span class="text-xs font-black text-gray-500">ì–‘ì‹:</span>
                <button type="button" onclick="setLayout('layout-a4-1')" class="layout-btn px-4 py-2 rounded-xl text-xs font-black border-2 border-gray-300 hover:border-teal-500 hover:bg-teal-50" data-layout="layout-a4-1">A4 1ì¥</button>
                <button type="button" onclick="setLayout('layout-a4-2')" class="layout-btn px-4 py-2 rounded-xl text-xs font-black border-2 border-teal-500 bg-teal-50 text-teal-700" data-layout="layout-a4-2">A4 2ë¶„í• </button>
                <button type="button" onclick="setLayout('layout-a4-3')" class="layout-btn px-4 py-2 rounded-xl text-xs font-black border-2 border-gray-300 hover:border-teal-500 hover:bg-teal-50" data-layout="layout-a4-3">A4 3ë¶„í• </button>
                <button type="button" onclick="setLayout('layout-a4-4')" class="layout-btn px-4 py-2 rounded-xl text-xs font-black border-2 border-gray-300 hover:border-teal-500 hover:bg-teal-50" data-layout="layout-a4-4">A4 4ë“±ë¶„</button>
                <button type="button" onclick="setLayout('layout-portable')" class="layout-btn px-4 py-2 rounded-xl text-xs font-black border-2 border-gray-300 hover:border-teal-500 hover:bg-teal-50" data-layout="layout-portable">íœ´ëŒ€ìš©</button>
            </div>
            <div id="portable-options" class="hidden flex-wrap items-center gap-4 mt-3 p-3 bg-gray-50 rounded-xl">
                <label class="flex items-center gap-2">
                    <span class="text-xs font-black text-gray-600">í­(mm):</span>
                    <select id="portable-width" onchange="applyPortableSize()" class="border rounded-lg px-2 py-1 text-xs font-black">
                        <option value="58">58mm</option>
                        <option value="80" selected>80mm</option>
                        <option value="100">100mm</option>
                    </select>
                </label>
                <label class="flex items-center gap-2">
                    <span class="text-xs font-black text-gray-600">í¬ê¸°:</span>
                    <input type="range" id="portable-scale" min="0.5" max="1.5" step="0.05" value="1" oninput="applyPortableSize()" class="w-24">
                    <span id="portable-scale-val" class="text-xs font-black text-gray-700">100%</span>
                </label>
            </div>
            <div class="mt-3">
                <button onclick="window.print()" class="bg-blue-600 text-white px-8 py-2.5 rounded-xl font-black text-sm shadow-lg hover:bg-blue-700">ğŸ–¨ï¸ ì¸ì‡„</button>
            </div>
        </div>

        <div class="print-container">
            {% for o in orders %}
            <div class="invoice-card">
                <div class="flex justify-between items-center border-b-4 border-black pb-2 mb-2">
                    <h1 class="text-2xl font-black tracking-tighter text-teal-700 italic">ë°”êµ¬ë‹ˆì‚¼ì´Œ</h1>
                    <p class="text-[11px] font-black bg-black text-white px-3 py-1 rounded">ì†¡ë„ ì „ìš© ë°°ì†¡</p>
                </div>
                <div class="flex justify-between items-start mb-2">
                    <div class="w-2/3">
                        <p class="text-[9px] text-gray-400 font-black uppercase mb-1">Recipient</p>
                        <p class="text-4xl font-black text-gray-900 leading-none mb-1">{{ o.masked_name }}</p>
                        <p class="text-2xl font-black text-gray-700">{{ o.masked_phone }}</p>
                    </div>
                    <div class="w-1/3 text-right">
                        <p class="text-[9px] text-gray-400 font-black uppercase mb-1">Order ID</p>
                        <p class="text-xs font-black bg-gray-100 px-2 py-1 inline-block rounded">{{ o.order_id[-8:] }}</p>
                        <p class="text-[10px] text-gray-400 mt-1 font-bold">{{ o.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    </div>
                </div>
                <div class="bg-gray-50 p-3 rounded-xl border-l-8 border-teal-600 mb-2">
                    <p class="text-[9px] text-gray-400 font-black mb-1 uppercase">Shipping Address</p>
                    <p class="text-xl font-black text-black leading-tight mb-1">{{ o.delivery_address }}</p>
                    <div class="bg-white px-2 py-1.5 rounded-lg border border-red-100 mt-1">
                        <p class="text-[11px] font-black text-red-600">ìš”ì²­: {{ o.clean_memo }}</p>
                    </div>
                </div>
                <div class="flex-grow overflow-hidden">
                    <p class="text-[9px] text-gray-400 font-black mb-1 border-b pb-1 uppercase">Order Items</p>
                    <div class="item-list space-y-1">
                        {% for item in o.all_items %}
                        <div class="flex items-center justify-between border-b border-gray-50 pb-0.5">
                            <span class="text-[13px] font-black text-gray-800 line-clamp-1">â–¡ {{ item }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="pt-2 border-t border-dashed border-gray-300 text-center opacity-40">
                    <p class="text-[8px] font-black italic uppercase">Basket Uncle</p>
                </div>
            </div>
            {% endfor %}
        </div>
        <script>
        function setLayout(cls) {
            document.body.className = cls;
            document.querySelectorAll('.layout-btn').forEach(function(b) {
                b.classList.remove('border-teal-500', 'bg-teal-50', 'text-teal-700');
                b.classList.add('border-gray-300');
                if (b.getAttribute('data-layout') === cls) {
                    b.classList.add('border-teal-500', 'bg-teal-50', 'text-teal-700');
                    b.classList.remove('border-gray-300');
                }
            });
            var po = document.getElementById('portable-options');
            if (po) po.classList.toggle('hidden', cls !== 'layout-portable');
        }
        function applyPortableSize() {
            var w = document.getElementById('portable-width');
            var s = document.getElementById('portable-scale');
            var v = document.getElementById('portable-scale-val');
            if (w) document.body.style.setProperty('--inv-width-mm', w.value);
            if (s) {
                document.body.style.setProperty('--inv-scale', s.value);
                if (v) v.textContent = Math.round(parseFloat(s.value) * 100) + '%';
            }
        }
        </script>
    </body>
    </html>
    """
    return render_template_string(invoice_html, orders=processed_orders)
@app.context_processor
def inject_globals():
    """ì „ì—­ í…œí”Œë¦¿ ë³€ìˆ˜ ì£¼ì…"""
    cart_count = 0
    unread_message_count = 0
    grade = 1
    if current_user.is_authenticated:
        total_qty = db.session.query(db.func.sum(Cart.quantity)).filter(Cart.user_id == current_user.id).scalar()
        cart_count = total_qty if total_qty else 0
        grade = getattr(current_user, 'member_grade', 1) or 1
        unread_message_count = UserMessage.query.filter_by(user_id=current_user.id, read_at=None).count()
    categories = categories_for_member_grade(grade).all()
    managers = [c.manager_email for c in categories if c.manager_email]
    return dict(cart_count=cart_count, unread_message_count=unread_message_count, now=datetime.now(), managers=managers, nav_categories=categories)

@app.route('/api/search')
def api_search():
    """ê²€ìƒ‰ ë¬´í•œ ìŠ¤í¬ë¡¤ìš© API (30ê°œ ë‹¨ìœ„, offset/limit)"""
    q = request.args.get('q', '').strip()
    if not q:
        return jsonify([])
    offset = int(request.args.get('offset', 0))
    limit = min(int(request.args.get('limit', 30)), 50)
    query = Product.query.filter(Product.is_active == True, Product.name.contains(q)).order_by(Product.id.desc())
    products = query.offset(offset).limit(limit).all()
    return jsonify([{
        "id": p.id, "name": p.name, "price": p.price, "image_url": p.image_url,
        "description": p.description or "", "stock": p.stock,
        "is_sold_out": (p.deadline and p.deadline < datetime.now()) or p.stock <= 0,
    } for p in products])


@app.route('/search')
def search_view():
    """ê²€ìƒ‰ ê²°ê³¼ ì „ìš© í˜ì´ì§€ (30ê°œ ì´ˆê¸° ë¡œë”© + ë¬´í•œ ìŠ¤í¬ë¡¤, íŠ¸ë˜í”½ ì ˆê°)"""
    query = request.args.get('q', '').strip()
    if not query:
        return redirect(url_for('index'))

    base_query = Product.query.filter(Product.is_active == True, Product.name.contains(query)).order_by(Product.id.desc())
    total_count = base_query.count()
    search_products = base_query.limit(30).all()
    search_has_more = total_count > 30

    grade = (getattr(current_user, 'member_grade', 1) or 1) if current_user.is_authenticated else 1
    recommend_cats = categories_for_member_grade(grade).limit(3).all()
    cat_previews = {cat: Product.query.filter_by(category=cat.name, is_active=True).limit(4).all() for cat in recommend_cats}

    content = """
    <div class="max-w-7xl mx-auto px-4 md:px-6 py-12 md:py-20 text-left">
        <h2 class="text-2xl md:text-4xl font-black text-gray-800 mb-8">
            <span class="text-teal-600">"{{ query }}"</span> ê²€ìƒ‰ ê²°ê³¼ ({{ total_count }}ê±´)
        </h2>

        {% if search_products %}
        <div id="search-product-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6 mb-12">
            {% for p in search_products %}
            <div class="product-card bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden relative flex flex-col transition-all hover:shadow-2xl {% if p.stock <= 0 %}sold-out{% endif %}">
                <a href="/product/{{p.id}}" class="relative aspect-square block bg-white overflow-hidden">
                    <img src="{{ p.image_url }}" loading="lazy" class="w-full h-full object-cover p-2 md:p-6">
                </a>
                <div class="p-3 md:p-8 flex flex-col flex-1">
                    <h3 class="font-black text-gray-800 text-[11px] md:text-base mb-1 truncate">{{ p.name }}</h3>
                    <div class="mt-auto flex justify-between items-end">
                        <span class="text-[13px] md:text-2xl font-black text-teal-600">{{ "{:,}".format(p.price) }}ì›</span>
                        <button onclick="addToCart('{{p.id}}')" class="bg-teal-600 w-8 h-8 md:w-14 md:h-14 rounded-xl text-white flex items-center justify-center transition active:scale-90"><i class="fas fa-plus text-[10px] md:text-xl"></i></button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div id="search-load-more-trigger" class="h-4"></div>
        <div id="search-spinner" class="hidden py-8 text-center text-gray-400"><i class="fas fa-spinner fa-spin text-2xl"></i></div>
        <div id="search-end-message" class="hidden py-6 text-center text-gray-400 text-sm font-bold">ëª¨ë“  ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.</div>
        {% else %}
            <div class="py-20 text-center bg-gray-50 rounded-[3rem] border-2 border-dashed border-gray-200 mb-20">
                <p class="text-gray-400 font-black text-lg">ì°¾ìœ¼ì‹œëŠ” ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤. ğŸ˜¥</p>
            </div>
        {% endif %}

        <hr class="border-gray-100 mb-20">
        
        <h3 class="text-xl md:text-3xl font-black text-gray-800 mb-10 italic">ì´ëŸ° ìƒí’ˆì€ ì–´ë– ì„¸ìš”?</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
            {% for cat, prods in cat_previews.items() %}
            <div class="bg-gray-50 p-8 rounded-[3rem] border border-gray-100 shadow-inner">
                <h3 class="text-xl font-black mb-6">{{ cat.name }} <a href="/category/{{ cat.name }}" class="text-xs text-gray-400 ml-2">ë”ë³´ê¸° ></a></h3>
                <div class="grid grid-cols-2 gap-4">
                    {% for cp in prods %}
                    <a href="/product/{{ cp.id }}" class="bg-white p-3 rounded-2xl shadow-sm hover:scale-105 transition"><img src="{{ cp.image_url }}" class="w-full aspect-square object-contain"></a>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="mt-20 text-center">
            <a href="/" class="inline-block bg-gray-800 text-white px-12 py-5 rounded-full font-black shadow-xl hover:bg-black transition">ë©”ì¸ìœ¼ë¡œ ì´ë™</a>
        </div>
    </div>
    {% if search_has_more %}
    <script>
    (function(){
        var searchOffset = 30;
        var searchLoading = false;
        var searchHasMore = true;
        var searchQ = {{ query|tojson }};
        var scrollDebounceTimer = null;
        function searchLoadMore(){
            if (searchLoading || !searchHasMore) return;
            searchLoading = true;
            document.getElementById('search-spinner').classList.remove('hidden');
            fetch('/api/search?q=' + encodeURIComponent(searchQ) + '&offset=' + searchOffset + '&limit=30')
                .then(function(r){ return r.json(); })
                .then(function(data){
                    if (!data || data.length === 0){ searchHasMore = false; document.getElementById('search-end-message').classList.remove('hidden'); }
                    else {
                        var grid = document.getElementById('search-product-grid');
                        data.forEach(function(p){
                            var sold = p.is_sold_out ? ' sold-out' : '';
                            grid.insertAdjacentHTML('beforeend',
                                '<div class="product-card bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden relative flex flex-col transition-all hover:shadow-2xl' + sold + '">'
                                + '<a href="/product/' + p.id + '" class="relative aspect-square block bg-white overflow-hidden"><img src="' + p.image_url + '" loading="lazy" class="w-full h-full object-cover p-2 md:p-6"></a>'
                                + '<div class="p-3 md:p-8 flex flex-col flex-1"><h3 class="font-black text-gray-800 text-[11px] md:text-base mb-1 truncate">' + p.name + '</h3>'
                                + '<div class="mt-auto flex justify-between items-end"><span class="text-[13px] md:text-2xl font-black text-teal-600">' + (p.price || 0).toLocaleString() + 'ì›</span>'
                                + '<button onclick="addToCart(\\'' + p.id + '\\')" class="bg-teal-600 w-8 h-8 md:w-14 md:h-14 rounded-xl text-white flex items-center justify-center transition active:scale-90"><i class="fas fa-plus text-[10px] md:text-xl"></i></button></div></div></div>');
                        });
                        searchOffset += data.length;
                        if (data.length < 30) { searchHasMore = false; document.getElementById('search-end-message').classList.remove('hidden'); }
                    }
                })
                .catch(function(e){ searchHasMore = false; })
                .finally(function(){
                    searchLoading = false;
                    document.getElementById('search-spinner').classList.add('hidden');
                });
        }
        var searchTrigger = document.getElementById('search-load-more-trigger');
        if (searchTrigger){
            var searchObserver = new IntersectionObserver(function(entries){
                if (!entries[0].isIntersecting) return;
                if (scrollDebounceTimer) clearTimeout(scrollDebounceTimer);
                scrollDebounceTimer = setTimeout(function(){ searchLoadMore(); scrollDebounceTimer = null; }, 1000);
            }, { threshold: 0.1, rootMargin: '300px' });
            searchObserver.observe(searchTrigger);
        }
    })();
    </script>
    {% endif %}
    """
    return render_template_string(HEADER_HTML + content + FOOTER_HTML, query=query, search_products=search_products, total_count=total_count, search_has_more=search_has_more, cat_previews=cat_previews, recommend_cats=recommend_cats)

@app.route('/')
def index():
    """ë©”ì¸ í˜ì´ì§€ (ë””ìì¸ ìœ ì§€). ì¹´í…Œê³ ë¦¬ëŠ” 8ê°œë§Œ ë…¸ì¶œ, ë”ë³´ê¸°/ì „ì²´ë³´ê¸°ë¡œ ì „ì²´ í™•ì¸."""
    _record_page_view('main')
    run_product_stock_reset()
    grade = (getattr(current_user, 'member_grade', 1) or 1) if current_user.is_authenticated else 1
    all_categories = categories_for_member_grade(grade).order_by(Category.order.asc(), Category.id.asc()).all()
    main_categories = all_categories[:8]  # ë©”ì¸ì—ëŠ” 8ê°œë§Œ
    grouped_products = {}
    order_logic = (Product.stock <= 0) | (Product.deadline < datetime.now())
    
    latest_all = Product.query.filter_by(is_active=True).order_by(Product.id.desc()).limit(30).all()
    random_latest = random.sample(latest_all, min(len(latest_all), 30)) if latest_all else []
    
    today_end = datetime.now().replace(hour=23, minute=59, second=59)
    closing_today = Product.query.filter(Product.is_active == True, Product.deadline > datetime.now(), Product.deadline <= today_end).order_by(Product.deadline.asc()).limit(50).all()
    latest_reviews = Review.query.order_by(Review.created_at.desc()).limit(4).all()

    for cat in main_categories:
        prods = Product.query.filter_by(category=cat.name, is_active=True).order_by(order_logic, Product.id.desc()).limit(20).all()
        if prods: grouped_products[cat] = prods

    all_pids = set()
    for p in random_latest: all_pids.add(p.id)
    for p in closing_today: all_pids.add(p.id)
    for prods in grouped_products.values():
        for p in prods: all_pids.add(p.id)
    review_counts = {}
    if all_pids:
        review_counts = dict(db.session.query(Review.product_id, func.count(Review.id)).filter(Review.product_id.in_(all_pids)).group_by(Review.product_id).all())
    now = datetime.now()
    
    content = """
<style>
/* ========== ë©”ì¸ í˜ì´ì§€ ì „ìš© í”„ë¦¬ë¯¸ì—„ ìŠ¤íƒ€ì¼ ========== */
.page-main { --hero-bg: linear-gradient(165deg, #0c1222 0%, #1a2744 35%, #0f172a 70%, #020617 100%); }
.page-main .hero-wrap {
    background: var(--hero-bg);
    color: #f8fafc;
    padding: clamp(4rem, 12vw, 8rem) 1.5rem;
    position: relative;
    overflow: hidden;
    min-height: 70vh;
    display: flex;
    align-items: center;
}
.page-main .hero-wrap::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(13, 148, 136, 0.18) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 80% 60%, rgba(13, 148, 136, 0.08) 0%, transparent 40%);
    pointer-events: none;
}
.page-main .hero-wrap::after {
    content: '';
    position: absolute;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    opacity: 0.6;
}
.page-main .hero-inner { position: relative; z-index: 1; max-width: 56rem; margin: 0 auto; text-align: center; }
.page-main .hero-label {
    font-size: clamp(0.65rem, 1.5vw, 0.8rem);
    font-weight: 800;
    letter-spacing: 0.35em;
    text-transform: uppercase;
    color: rgba(134, 239, 172, 0.9);
    margin-bottom: 1.5rem;
    display: inline-block;
}
.page-main .hero-title {
    font-size: clamp(1.75rem, 5vw, 3.75rem);
    font-weight: 900;
    line-height: 1.1;
    letter-spacing: -0.03em;
    margin-bottom: 1.5rem;
    color: #f1f5f9;
}
.page-main .hero-title .accent { color: #4ade80; font-weight: 900; letter-spacing: -0.02em; }
.page-main .hero-divider {
    width: 4rem;
    height: 3px;
    background: linear-gradient(90deg, transparent, rgba(74, 222, 128, 0.6), transparent);
    margin: 0 auto 2rem;
    border-radius: 2px;
}
.page-main .hero-desc {
    font-size: clamp(0.9rem, 1.8vw, 1.15rem);
    color: rgba(226, 232, 240, 0.85);
    line-height: 1.7;
    max-width: 36rem;
    margin: 0 auto 2.5rem;
    font-weight: 600;
}
.page-main .hero-desc .highlight { color: #e2e8f0; text-decoration: underline; text-underline-offset: 6px; text-decoration-color: rgba(45, 212, 191, 0.8); }
.page-main .hero-cta {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 1rem 2.25rem;
    font-weight: 800;
    font-size: 0.95rem;
    color: #fff;
    background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
    border-radius: 9999px;
    box-shadow: 0 4px 20px rgba(13, 148, 136, 0.35), 0 1px 0 rgba(255,255,255,0.1) inset;
    transition: transform 0.2s ease, box-shadow 0.25s ease;
}
.page-main .hero-cta:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(13, 148, 136, 0.45); }
.page-main .hero-link {
    color: rgba(248, 250, 252, 0.7);
    font-weight: 700;
    font-size: 0.85rem;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    padding-bottom: 2px;
    transition: color 0.2s, border-color 0.2s;
}
.page-main .hero-link:hover { color: #fff; border-color: rgba(255,255,255,0.5); }
.page-main #products {
    max-width: 80rem;
    margin: 0 auto;
    padding: clamp(3rem, 8vw, 5rem) 1.5rem;
}
.page-main .section-title {
    font-size: clamp(1.15rem, 2.2vw, 1.6rem);
    font-weight: 900;
    color: #1c1917;
    letter-spacing: -0.02em;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
}
.page-main .section-title .bar { width: 4px; height: 1.5rem; border-radius: 2px; flex-shrink: 0; }
.page-main .section-title.bar-orange .bar { background: linear-gradient(180deg, #fb923c, #ea580c); }
.page-main .section-title.bar-green .bar { background: linear-gradient(180deg, #14b8a6, #0d9488); }
.page-main .review-card {
    background: #fff;
    border-radius: 1rem;
    padding: 0.6rem;
    border: 1px solid #f1f5f9;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    transition: transform 0.25s ease, box-shadow 0.25s ease;
}
.page-main .review-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.06); }
.page-main .review-card img { border-radius: 0.5rem; object-fit: cover; width: 100%; height: 100%; }
.page-main .review-card .review-img-wrap { width: 100%; max-width: 5rem; aspect-ratio: 1; border-radius: 0.5rem; overflow: hidden; border: 1px solid #f1f5f9; background: #f8fafc; }
.page-main .review-card .review-meta { font-size: 0.5rem; }
.page-main .review-card .review-content { font-size: 0.6rem; line-height: 1.3; }
.page-main .product-card {
    background: #fff;
    border-radius: 1.75rem;
    border: 1px solid #f1f5f9;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.35s ease, border-color 0.25s;
}
.page-main .product-card:hover { transform: translateY(-6px); box-shadow: 0 20px 50px rgba(0,0,0,0.08); border-color: #d6d3d1; }
.page-main .product-card .price { font-weight: 900; color: #0f766e; letter-spacing: -0.02em; }
.page-main .product-card .add-btn {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 0.75rem;
    background: linear-gradient(135deg, #0d9488, #0f766e);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);
    transition: transform 0.2s, box-shadow 0.2s;
}
@media (min-width: 768px) { .page-main .product-card .add-btn { width: 3.5rem; height: 3.5rem; border-radius: 1.25rem; } }
.page-main .product-card .add-btn:hover { transform: scale(1.05); box-shadow: 0 6px 18px rgba(13, 148, 136, 0.4); }
.page-main .product-card .add-btn:active { transform: scale(0.96); }
</style>

<div class="page-main">
<div class="hero-wrap">
    <div class="hero-inner">
        <span class="hero-label">Direct Delivery & Agency Service</span>
        <h1 class="hero-title">
            íŒë§¤ê°€ ì•„ë‹Œ, <span class="accent">ë°°ì†¡ ì„œë¹„ìŠ¤</span> ì…ë‹ˆë‹¤.<br>
            <span class="accent">Premium 6PL Service</span>
        </h1>
        <div class="hero-divider"></div>
        <p class="hero-desc">
            ë°”êµ¬ë‹ˆì‚¼ì´Œì€ ì¬ê³ ë¥¼ ìŒ“ì•„ë‘ëŠ” íŒë§¤ì²˜ê°€ ì•„ë‹Œ, <br class="hidden md:block">
            ì´ìš©ìì˜ ìš”ì²­ì— ë”°ë¼ <span class="highlight">êµ¬ë§¤ì™€ ë°°ì†¡ì„ ì±…ì„ ëŒ€í–‰</span>í•˜ëŠ” ë¬¼ë¥˜ ì¸í”„ë¼ì…ë‹ˆë‹¤.
        </p>
        <div class="flex flex-col md:flex-row justify-center items-center gap-6">
            <a href="#products" class="hero-cta">ëŒ€í–‰ ì„œë¹„ìŠ¤ ì´ìš©í•˜ê¸°</a>
            <a href="/about" class="hero-link">6PL êµ¬ë§¤ëŒ€í–‰ì´ë€? <i class="fas fa-arrow-right ml-2"></i></a>
        </div>
    </div>
</div>

<div id="products">
    <!-- ì¹´í…Œê³ ë¦¬ ë°”ë¡œê°€ê¸° (ê¸°ëŠ¥ë³„/ì¹´í…Œê³ ë¦¬ë³„) -->
    <section class="mb-10">
        <div class="flex justify-between items-end border-b border-slate-100 pb-3 mb-4">
            <h2 class="section-title bar-green"><span class="bar"></span> ì¹´í…Œê³ ë¦¬</h2>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
            {% for cat, prods in grouped_products.items() %}
            <a href="/category/{{ cat.name }}" class="flex flex-col items-center justify-center p-5 rounded-2xl border border-slate-100 bg-white hover:border-teal-200 hover:shadow-lg transition-all text-center">
                <span class="w-12 h-12 rounded-xl bg-teal-50 flex items-center justify-center text-teal-600 text-xl mb-2"><i class="fas fa-th-large"></i></span>
                <span class="text-xs md:text-sm font-black text-slate-700">{{ cat.name }}</span>
                <span class="text-[10px] text-slate-400 font-bold mt-0.5">{{ prods|length }}ì¢…</span>
            </a>
            {% endfor %}
            <a href="/category/ì˜¤ëŠ˜ë§ˆê°" class="flex flex-col items-center justify-center p-5 rounded-2xl border border-red-100 bg-red-50/50 hover:shadow-lg transition-all text-center">
                <span class="w-12 h-12 rounded-xl bg-red-100 flex items-center justify-center text-red-600 text-xl mb-2"><i class="fas fa-clock"></i></span>
                <span class="text-xs md:text-sm font-black text-red-800">ì˜¤ëŠ˜ ë§ˆê°</span>
            </a>
            <a href="/category/ìµœì‹ ìƒí’ˆ" class="flex flex-col items-center justify-center p-5 rounded-2xl border border-blue-100 bg-blue-50/50 hover:shadow-lg transition-all text-center">
                <span class="w-12 h-12 rounded-xl bg-blue-100 flex items-center justify-center text-blue-600 text-xl mb-2"><i class="fas fa-star"></i></span>
                <span class="text-xs md:text-sm font-black text-blue-800">ìµœì‹  ìƒí’ˆ</span>
            </a>
            {% if has_more_categories %}
            <a href="/categories" class="flex flex-col items-center justify-center p-5 rounded-2xl border-2 border-dashed border-slate-200 bg-slate-50 hover:border-teal-300 hover:bg-teal-50/50 transition-all text-center col-span-2 sm:col-span-3 md:col-span-2">
                <span class="w-12 h-12 rounded-xl bg-teal-100 flex items-center justify-center text-teal-600 text-xl mb-2"><i class="fas fa-th-list"></i></span>
                <span class="text-xs md:text-sm font-black text-slate-700">ì¹´í…Œê³ ë¦¬ ì „ì²´ë³´ê¸°</span>
                <span class="text-[10px] text-slate-400 font-bold mt-0.5">ì´ {{ total_categories_count }}ê°œ ë”ë³´ê¸°</span>
            </a>
            {% endif %}
        </div>
    </section>

    {% if closing_today %}
    <section class="mb-10">
        <div class="flex justify-between items-end border-b border-slate-100 pb-3 mb-4">
            <h2 class="section-title bar-orange"><span class="bar"></span> ğŸ”¥ ì˜¤ëŠ˜ ë§ˆê° ì„ë°•</h2>
            <a href="/category/ì˜¤ëŠ˜ë§ˆê°" class="text-xs md:text-sm font-bold text-stone-400 hover:text-teal-600 flex items-center gap-1 transition">ì „ì²´ë³´ê¸° <i class="fas fa-chevron-right text-[8px]"></i></a>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-5">
            {% for p in closing_today %}
            {% set is_expired = (p.deadline and p.deadline < now) %}
            <div class="product-card flex flex-col overflow-hidden relative rounded-2xl border border-red-50 bg-white shadow-sm hover:shadow-lg transition-all {% if is_expired or p.stock <= 0 %}sold-out opacity-80{% endif %}">
                {% if is_expired or p.stock <= 0 %}<div class="absolute top-2 right-2 z-10 bg-gray-800 text-white text-[9px] px-2 py-1 rounded-lg font-black">íŒë§¤ë§ˆê°</div>{% endif %}
                <a href="/product/{{p.id}}" class="relative aspect-square block bg-slate-50 overflow-hidden">
                    <img src="{{ p.image_url or 'https://placehold.co/400x400/f1f5f9/64748b?text=ìƒí’ˆ' }}" loading="lazy" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/400x400/f1f5f9/64748b?text=ìƒí’ˆ'">
                </a>
                <div class="p-3 md:p-4 flex flex-col flex-1">
                    <p class="countdown-timer text-[8px] md:text-[10px] font-bold text-red-500 mb-1" data-deadline="{{ p.deadline.strftime('%Y-%m-%dT%H:%M:%S') if p.deadline else '' }}"></p>
                    <h3 class="font-black text-slate-800 text-[11px] md:text-sm mb-0.5 line-clamp-2">{{ p.name }}</h3>
                    <p class="text-[9px] text-slate-400 font-bold mb-1">{{ p.description or '' }}</p>
                    {% if review_counts.get(p.id, 0) > 0 %}<p class="text-[9px] text-amber-600 font-bold mb-1">ë¦¬ë·° {{ review_counts.get(p.id, 0) }}ê°œ</p>{% endif %}
                    <div class="mt-auto flex justify-between items-end gap-2">
                        <span class="price text-[12px] md:text-lg font-black text-teal-700">{{ "{:,}".format(p.price) }}ì›</span>
                        {% if not is_expired and p.stock > 0 %}<button onclick="addToCart('{{p.id}}')" class="add-btn shrink-0"><i class="fas fa-plus text-[10px] md:text-base"></i></button>{% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {% if random_latest %}
    <section class="mb-10">
        <div class="flex justify-between items-end border-b border-slate-100 pb-3 mb-4">
            <h2 class="section-title bar-green"><span class="bar"></span> âœ¨ ìµœì‹  ìƒí’ˆ</h2>
            <a href="/category/ìµœì‹ ìƒí’ˆ" class="text-xs md:text-sm font-bold text-stone-400 hover:text-teal-600 flex items-center gap-1 transition">ì „ì²´ë³´ê¸° <i class="fas fa-chevron-right text-[8px]"></i></a>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-5">
            {% for p in random_latest %}
            {% set is_expired = (p.deadline and p.deadline < now) %}
            <div class="product-card flex flex-col overflow-hidden relative rounded-2xl border border-slate-100 bg-white shadow-sm hover:shadow-lg transition-all {% if is_expired or p.stock <= 0 %}sold-out opacity-80{% endif %}">
                {% if is_expired or p.stock <= 0 %}<div class="absolute top-2 right-2 z-10 bg-gray-800 text-white text-[9px] px-2 py-1 rounded-lg font-black">íŒë§¤ë§ˆê°</div>{% endif %}
                {% if p.description %}
                <div class="absolute top-2 left-0 z-20">
                    <span class="px-2 py-0.5 text-[8px] md:text-[10px] font-black text-white shadow-md rounded-r-full {% if 'ë‹¹ì¼' in p.description %} bg-red-600 {% elif '+1' in p.description %} bg-blue-600 {% elif '+2' in p.description %} bg-emerald-600 {% else %} bg-slate-600 {% endif %}"><i class="fas fa-truck-fast mr-1"></i> {{ p.description }}</span>
                </div>
                {% endif %}
                <a href="/product/{{p.id}}" class="relative aspect-square block bg-slate-50 overflow-hidden">
                    <img src="{{ p.image_url or 'https://placehold.co/400x400/f1f5f9/64748b?text=ìƒí’ˆ' }}" loading="lazy" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/400x400/f1f5f9/64748b?text=ìƒí’ˆ'">
                </a>
                <div class="p-3 md:p-4 flex flex-col flex-1">
                    <p class="countdown-timer text-[8px] md:text-[10px] font-bold text-red-500 mb-0.5" data-deadline="{{ p.deadline.strftime('%Y-%m-%dT%H:%M:%S') if p.deadline else '' }}"></p>
                    <h3 class="font-black text-slate-800 text-[11px] md:text-sm mb-0.5 line-clamp-2">{{ p.name }}{% if p.badge %} <span class="text-[9px] text-orange-500 font-bold">| {{ p.badge }}</span>{% endif %}</h3>
                    <p class="text-[9px] text-slate-400 font-bold mb-1">{{ p.spec or 'ì¼ë°˜' }}</p>
                    {% if review_counts.get(p.id, 0) > 0 %}<p class="text-[9px] text-amber-600 font-bold mb-1">ë¦¬ë·° {{ review_counts.get(p.id, 0) }}ê°œ</p>{% endif %}
                    <div class="mt-auto flex justify-between items-end gap-2">
                        <span class="price text-[12px] md:text-lg font-black text-teal-700">{{ "{:,}".format(p.price) }}ì›</span>
                        {% if not is_expired and p.stock > 0 %}<button onclick="addToCart('{{p.id}}')" class="add-btn shrink-0"><i class="fas fa-plus text-[10px] md:text-base"></i></button>{% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {% for cat, products in grouped_products.items() %}
    <section class="mb-10">
        <div class="flex justify-between items-end border-b border-slate-100 pb-3 mb-4">
            <div><h2 class="section-title bar-green"><span class="bar"></span> {{ cat.name }}</h2>{% if cat.description %}<p class="text-[10px] text-slate-400 font-bold mt-1">{{ cat.description }}</p>{% endif %}</div>
            <a href="/category/{{ cat.name }}" class="text-xs md:text-sm font-bold text-stone-400 hover:text-teal-600 flex items-center gap-1 transition">ì „ì²´ë³´ê¸° <i class="fas fa-chevron-right text-[8px]"></i></a>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-5">
            {% for p in products %}
            {% set is_expired = (p.deadline and p.deadline < now) %}
            <div class="product-card flex flex-col overflow-hidden relative rounded-2xl border border-slate-100 bg-white shadow-sm hover:shadow-lg transition-all {% if is_expired or p.stock <= 0 %}sold-out opacity-80{% endif %}">
                {% if is_expired or p.stock <= 0 %}<div class="absolute top-2 right-2 z-10 bg-gray-800 text-white text-[9px] px-2 py-1 rounded-lg font-black">íŒë§¤ë§ˆê°</div>{% endif %}
                {% if p.description %}
                <div class="absolute top-2 left-0 z-20">
                    <span class="px-2 py-0.5 text-[8px] md:text-[10px] font-black text-white shadow-md rounded-r-full {% if 'ë‹¹ì¼' in p.description %} bg-red-600 {% elif '+1' in p.description %} bg-blue-600 {% elif '+2' in p.description %} bg-emerald-600 {% else %} bg-slate-600 {% endif %}"><i class="fas fa-truck-fast mr-1"></i> {{ p.description }}</span>
                </div>
                {% endif %}
                <a href="/product/{{p.id}}" class="relative aspect-square block bg-slate-50 overflow-hidden">
                    <img src="{{ p.image_url or 'https://placehold.co/400x400/f1f5f9/64748b?text=ìƒí’ˆ' }}" loading="lazy" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/400x400/f1f5f9/64748b?text=ìƒí’ˆ'">
                </a>
                <div class="p-3 md:p-4 flex flex-col flex-1">
                    <p class="countdown-timer text-[8px] md:text-[10px] font-bold text-red-500 mb-0.5" data-deadline="{{ p.deadline.strftime('%Y-%m-%dT%H:%M:%S') if p.deadline else '' }}"></p>
                    <h3 class="font-black text-slate-800 text-[11px] md:text-sm mb-0.5 line-clamp-2">{{ p.name }}{% if p.badge %} <span class="text-[9px] text-orange-500 font-bold">| {{ p.badge }}</span>{% endif %}</h3>
                    <p class="text-[9px] text-slate-400 font-bold mb-1">{{ p.spec or 'ì¼ë°˜' }}</p>
                    {% if review_counts.get(p.id, 0) > 0 %}<p class="text-[9px] text-amber-600 font-bold mb-1">ë¦¬ë·° {{ review_counts.get(p.id, 0) }}ê°œ</p>{% endif %}
                    <div class="mt-auto flex justify-between items-end gap-2">
                        <span class="price text-[12px] md:text-lg font-black text-teal-700">{{ "{:,}".format(p.price) }}ì›</span>
                        {% if not is_expired and p.stock > 0 %}<button onclick="addToCart('{{p.id}}')" class="add-btn shrink-0"><i class="fas fa-plus text-[10px] md:text-base"></i></button>{% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endfor %}
</div>
</div>
    """
    return render_template_string(HEADER_HTML + content + FOOTER_HTML, 
                                  grouped_products=grouped_products, 
                                  random_latest=random_latest, 
                                  closing_today=closing_today, 
                                  latest_reviews=latest_reviews,
                                  review_counts=review_counts,
                                  now=now)

# --- ìƒë‹¨ HEADER_HTML ë‚´ì˜ ê²€ìƒ‰ì°½ ë¶€ë¶„ë„ ì•„ë˜ì™€ ê°™ì´ ë°˜ë“œì‹œ ìˆ˜ì •ë˜ì–´ì•¼ í•©ë‹ˆë‹¤ ---
# (HEADER_HTML ë³€ìˆ˜ë¥¼ ì°¾ì•„ì„œ í•´ë‹¹ ë¶€ë¶„ì˜ action="/"ì„ action="/search"ë¡œ ë°”ê¾¸ì„¸ìš”)
# 1. <form action="/search" method="GET" class="relative hidden md:block max-w-xs flex-1">
# 2. <form action="/search" method="GET" class="relative">
    """ë©”ì¸ í˜ì´ì§€"""
    query = request.args.get('q', '').strip()
    categories = Category.query.order_by(Category.order.asc(), Category.id.asc()).all()
    grouped_products = {}
    
    order_logic = (Product.stock <= 0) | (Product.deadline < datetime.now())
    
    # ìµœì‹  ìƒí’ˆ 30ê°œ ì¤‘ 30ê°œ ëœë¤
    latest_all = Product.query.filter_by(is_active=True).order_by(Product.id.desc()).limit(30).all()
    random_latest = random.sample(latest_all, min(len(latest_all), 30)) if latest_all else []
    
    # ì˜¤ëŠ˜ ë§ˆê° ìƒí’ˆ (íŠ¸ë˜í”½ ì ˆê°ìš© ìƒí•œ)
    today_end = datetime.now().replace(hour=23, minute=59, second=59)
    closing_today = Product.query.filter(
        Product.is_active == True,
        Product.deadline > datetime.now(),
        Product.deadline <= today_end
    ).order_by(Product.deadline.asc()).limit(50).all()

    # ìµœì‹  ë¦¬ë·° 4ê°œ (ë©”ì¸ ë…¸ì¶œ)
    latest_reviews = Review.query.order_by(Review.created_at.desc()).limit(4).all()

    for cat in categories:
        q_obj = Product.query.filter_by(category=cat.name, is_active=True)
        if query: q_obj = q_obj.filter(Product.name.contains(query))
        products = q_obj.order_by(order_logic, Product.id.desc(), Product.deadline.asc()).limit(20).all()
        if products: grouped_products[cat] = products
    
    content = """
   <div class="bg-gray-900 text-white py-20 md:py-32 px-4 shadow-inner relative overflow-hidden text-center">
    <div class="max-w-7xl mx-auto relative z-10 font-black text-center">
        
        <span class="text-teal-400 text-[10px] md:text-sm font-black mb-6 inline-block uppercase tracking-[0.3em]">
            Direct Delivery Service
        </span>

        <h1 class="hero-title text-3xl md:text-7xl font-black mb-8 leading-tight tracking-tighter">
            íŒë§¤ê°€ ì•„ë‹Œ, <span class="text-teal-500 uppercase">ë°°ì†¡ ì„œë¹„ìŠ¤</span> ì…ë‹ˆë‹¤.<br>
            <span class="text-teal-500 uppercase text-2xl md:text-4xl mt-4 inline-block">Premium Service</span>
        </h1>

        <div class="w-12 h-1 bg-white/20 mx-auto mb-8"></div>

        <p class="hero-desc text-gray-400 text-sm md:text-2xl font-bold max-w-2xl mx-auto mb-12">
            ë°”êµ¬ë‹ˆì‚¼ì´Œì€ ì¬ê³ ë¥¼ ìŒ“ì•„ë‘ëŠ” íŒë§¤ì²˜ê°€ ì•„ë‹Œ, ì´ìš©ìì˜ ìš”ì²­ì— ë”°ë¼ êµ¬ë§¤ì™€ ë°°ì†¡ì„ ì±…ì„ ëŒ€í–‰í•˜ëŠ” ë¬¼ë¥˜ ì¸í”„ë¼ì…ë‹ˆë‹¤.
        </p>

        <div class="flex flex-col md:flex-row justify-center items-center gap-6">
            <a href="#products"
               class="bg-teal-600 text-white px-10 py-4 md:px-12 md:py-5 rounded-full font-black shadow-2xl hover:bg-teal-700 transition active:scale-95">
                ì‡¼í•‘í•˜ëŸ¬ ê°€ê¸°
            </a>

            <a href="/about"
               class="text-white/60 hover:text-white font-bold border-b border-white/20 pb-1 transition text-xs md:text-base">
                ë°”êµ¬ë‹ˆì‚¼ì´Œì´ë€? <i class="fas fa-arrow-right ml-2"></i>
            </a>
        </div>

    </div>

    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] opacity-30"></div>
</div>

    <div id="products" class="max-w-7xl mx-auto px-4 py-10 text-left">
        {% if query %}
            <p class="mb-5 font-black text-gray-400 text-lg md:text-xl border-b border-gray-100 pb-3 text-left">
                <span class="text-teal-600">"{{ query }}"</span>ì— ëŒ€í•œ ìƒí’ˆ ê²€ìƒ‰ ê²°ê³¼ì…ë‹ˆë‹¤.
            </p>
        {% endif %}

        {% if latest_reviews and not query %}
        <section class="mb-8 text-left">
            <div class="mb-4 flex justify-between items-end border-b border-gray-100 pb-3 text-left">
                <h2 class="text-xl md:text-3xl font-black text-gray-800 flex items-center gap-3 tracking-tighter">
                    <span class="w-1.5 h-8 bg-orange-400 rounded-full"></span> ğŸ“¸ ìƒìƒí•œ êµ¬ë§¤ í›„ê¸°
                </h2>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 text-left">
                {% for r in latest_reviews %}
                <div class="bg-white rounded-[2rem] p-4 shadow-sm border border-gray-50 flex flex-col gap-3 transition hover:shadow-xl hover:-translate-y-1">
                    <div class="w-full max-w-[160px] mx-auto aspect-square rounded-2xl overflow-hidden border border-gray-100 bg-gray-50"><img src="{{ r.image_url }}" class="w-full h-full object-cover" loading="lazy" alt=""></div>
                    <div>
                        <p class="text-[10px] text-gray-400 font-bold mb-1">{{ r.user_name[:1] }}**ë‹˜ | {{ r.product_name }}</p>
                        <p class="text-[11px] font-bold text-gray-700 line-clamp-2 leading-relaxed">{{ r.content }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        {% if random_latest and not query %}
        <section class="mb-8 text-left">
            <div class="mb-4 flex justify-between items-end border-b border-gray-100 pb-3 text-left">
                <h2 class="text-xl md:text-3xl font-black text-gray-800 flex items-center gap-3 tracking-tighter">
                    <span class="w-1.5 h-8 bg-blue-500 rounded-full"></span> âœ¨ ìµœì‹  ìƒí’ˆ
                </h2>
                <a href="/category/ìµœì‹ ìƒí’ˆ" class="text-[10px] md:text-sm font-bold text-gray-400 hover:text-teal-600 flex items-center gap-1 transition">
                    ì „ì²´ë³´ê¸° <i class="fas fa-chevron-right text-[8px]"></i>
                </a>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-5 text-left">
                {% for p in random_latest %}
                <div class="product-card bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden relative flex flex-col transition-all hover:shadow-xl">
                    <a href="/product/{{p.id}}" class="relative aspect-square block bg-gray-50 overflow-hidden">
                        <img src="{{ p.image_url or 'https://placehold.co/400x400?text=NEW' }}" loading="lazy" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/400x400/f1f5f9/64748b?text=ìƒí’ˆ'">
                        <div class="absolute top-2 left-2"><span class="bg-blue-500 text-white text-[9px] md:text-[10px] px-2 py-0.5 rounded-lg uppercase font-black">NEW</span></div>
                    </a>
                    <div class="p-3 md:p-4 flex flex-col flex-1 text-left">
                        <h3 class="font-black text-gray-800 text-[11px] md:text-sm line-clamp-2 mb-0.5">{{ p.name }}</h3>
                        <p class="text-[9px] md:text-[11px] text-teal-600 mb-2 font-medium truncate">{{ p.description or '' }}</p>
                        <div class="mt-auto flex justify-between items-end">
                            <span class="text-[12px] md:text-lg text-gray-900 font-black">{{ "{:,}".format(p.price) }}ì›</span>
                            <button onclick="addToCart('{{p.id}}')" class="bg-teal-600 w-8 h-8 md:w-10 md:h-10 rounded-xl text-white flex items-center justify-center transition active:scale-90"><i class="fas fa-plus text-[10px]"></i></button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        {% if closing_today and not query %}
        <section class="mb-8 text-left">
            <div class="mb-4 flex justify-between items-end border-b border-gray-100 pb-3 text-left">
                <h2 class="text-xl md:text-3xl font-black text-gray-800 flex items-center gap-3 tracking-tighter">
                    <span class="w-1.5 h-8 bg-red-500 rounded-full"></span> ğŸ”¥ ì˜¤ëŠ˜ ë§ˆê° ì„ë°•!
                </h2>
                <a href="/category/ì˜¤ëŠ˜ë§ˆê°" class="text-[10px] md:text-sm font-bold text-gray-400 hover:text-teal-600 flex items-center gap-1 transition">
                    ì „ì²´ë³´ê¸° <i class="fas fa-chevron-right text-[8px]"></i>
                </a>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-5 text-left">
                {% for p in closing_today %}
                <div class="product-card bg-white rounded-2xl shadow-sm border border-red-50 overflow-hidden relative flex flex-col transition-all hover:shadow-xl">
                    <a href="/product/{{p.id}}" class="relative aspect-square block bg-white overflow-hidden">
                        <img src="{{ p.image_url }}"loading="lazy" class="w-full h-full object-cover p-1.5 md:p-5">
                        <div class="absolute bottom-2 left-2 md:bottom-5 md:left-5"><span class="bg-red-600 text-white text-[7px] md:text-[10px] px-1.5 py-0.5 md:px-3 md:py-1 rounded md:rounded-lg font-black animate-pulse uppercase">CLOSING</span></div>
                    </a>
                    <div class="p-3 md:p-7 flex flex-col flex-1 text-left">
                        <p class="countdown-timer text-[8px] md:text-[10px] font-bold text-red-500 mb-1.5" data-deadline="{{ p.deadline.strftime('%Y-%m-%dT%H:%M:%S') if p.deadline else '' }}"></p>
                        <h3 class="font-black text-gray-800 text-[11px] md:text-base truncate mb-0.5">{{ p.name }}</h3>
                        <p class="text-[9px] md:text-[11px] text-teal-600 mb-2 font-medium truncate">{{ p.description or '' }}</p>
                        <div class="mt-auto flex justify-between items-end">
                            <span class="text-[13px] md:text-2xl text-gray-900 font-black tracking-tighter">{{ "{:,}".format(p.price) }}ì›</span>
                            <button onclick="addToCart('{{p.id}}')" class="bg-teal-600 w-8 h-8 md:w-14 md:h-14 rounded-xl md:rounded-[1.5rem] text-white shadow-xl hover:bg-teal-700 flex items-center justify-center transition active:scale-90"><i class="fas fa-plus text-[10px] md:text-xl"></i></button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}
        
        {% for cat, products in grouped_products.items() %}
        <section class="mb-8 text-left">
            <div class="mb-4 flex justify-between items-end border-b border-gray-100 pb-3 text-left">
                <div class="text-left">
                    <h2 class="text-xl md:text-3xl font-black text-gray-800 flex items-center gap-3 tracking-tighter text-left">
                        <span class="w-1.5 h-8 bg-teal-500 rounded-full"></span> {{ cat.name }} ë¦¬ìŠ¤íŠ¸
                    </h2>
                    {% if cat.description %}<p class="text-[11px] md:text-sm text-gray-400 mt-2 font-bold text-left">{{ cat.description }}</p>{% endif %}
                </div>
                <a href="/category/{{ cat.name }}" class="text-[10px] md:text-sm font-bold text-gray-400 hover:text-teal-600 flex items-center gap-1 transition">
                    ì „ì²´ë³´ê¸° <i class="fas fa-chevron-right text-[8px]"></i>
                </a>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-5 text-left">
                {% for p in products %}
                {% set is_expired = (p.deadline and p.deadline < now) %}
                <div class="product-card bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden relative flex flex-col transition-all hover:shadow-xl {% if is_expired or p.stock <= 0 %}sold-out opacity-80{% endif %} text-left">
                    {% if is_expired or p.stock <= 0 %}<div class="sold-out-badge absolute top-2 right-2 z-10 bg-gray-800 text-white text-[9px] px-2 py-1 rounded-lg font-black">íŒë§¤ë§ˆê°</div>{% endif %}
                    <a href="/product/{{p.id}}" class="relative aspect-square block bg-gray-50 overflow-hidden text-left">
                        <img src="{{ p.image_url or 'https://placehold.co/400x400/f1f5f9/64748b?text=ìƒí’ˆ' }}" loading="lazy" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/400x400/f1f5f9/64748b?text=ìƒí’ˆ'">
                        <div class="absolute bottom-2 left-2 text-left">
                            <span class="bg-black/70 text-white text-[9px] md:text-[10px] px-2 py-0.5 rounded font-black backdrop-blur-sm">ì”ì—¬ {{ p.stock }}</span>
                        </div>
                    </a>
                    <div class="p-3 md:p-8 flex flex-col flex-1 text-left">
                        <p class="countdown-timer text-[8px] md:text-[10px] font-bold text-red-500 mb-1.5 text-left" data-deadline="{{ p.deadline.strftime('%Y-%m-%dT%H:%M:%S') if p.deadline else '' }}"></p>
                        <h3 class="font-black text-gray-800 text-[11px] md:text-base truncate mb-0.5 text-left">{{ p.name }}</h3>
                        <p class="text-[9px] md:text-[11px] text-teal-600 mb-2 font-medium truncate text-left">{{ p.description or '' }}</p>
                        <div class="mt-auto flex justify-between items-end text-left">
                            <span class="text-[13px] md:text-2xl font-black text-teal-600 text-left">{{ "{:,}".format(p.price) }}ì›</span>
                            {% if not is_expired and p.stock > 0 %}
                            <button onclick="addToCart('{{p.id}}')" class="bg-teal-600 w-8 h-8 md:w-14 md:h-14 rounded-xl md:rounded-[1.5rem] text-white shadow-xl hover:bg-teal-700 flex items-center justify-center transition active:scale-90 text-center">
                                <i class="fas fa-plus text-[10px] md:text-xl"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endfor %}
    </div>

    <!-- ë©”ì¸ í•˜ë‹¨: í™ˆí™”ë©´ ë°”ë¡œê°€ê¸° ë°°ë„ˆ (ì„¤ëª… + ì„¤ì¹˜ ë²„íŠ¼ + ë‹«ê¸°) -->
    <div id="home-add-bar" class="fixed bottom-0 left-0 right-0 z-50 bg-stone-800/98 backdrop-blur border-t border-stone-600 shadow-2xl px-4 py-4 md:py-3 transition-transform duration-300" style="display: none;">
        <div class="max-w-4xl mx-auto flex flex-col sm:flex-row items-center justify-between gap-4">
            <div class="flex flex-col sm:flex-row items-center gap-3 flex-1 min-w-0">
                <button type="button" id="home-add-bar-install-btn" class="shrink-0 inline-flex items-center justify-center gap-2 bg-teal-500 hover:bg-teal-400 text-white font-black py-3 px-6 rounded-2xl shadow-lg transition text-sm">
                    <i class="fas fa-home"></i> í™ˆí™”ë©´ ë°”ë¡œê°€ê¸°
                </button>
                <p class="text-stone-300 text-xs md:text-sm font-bold text-center sm:text-left max-w-md">
                    <span class="text-teal-400 font-extrabold">ì„¤ì¹˜ ë°©ë²•:</span> ì•±ì²˜ëŸ¼ ë¹ ë¥´ê²Œ ì‡¼í•‘í•˜ì„¸ìš”. AndroidëŠ” Chrome <strong>ë©”ë‰´(â‹®)</strong> â†’ í™ˆ í™”ë©´ì— ì¶”ê°€, iOSëŠ” Safari <strong>ê³µìœ </strong> â†’ í™ˆ í™”ë©´ì— ì¶”ê°€
                </p>
            </div>
            <button type="button" id="home-add-bar-close" class="shrink-0 w-10 h-10 rounded-full bg-stone-600 hover:bg-stone-500 text-stone-300 hover:text-white flex items-center justify-center transition font-bold text-lg" aria-label="ë‹«ê¸°">Ã—</button>
        </div>
    </div>
    <script>
    (function(){
        var bar = document.getElementById('home-add-bar');
        if (!bar) return;
        var key = 'home_add_bar_closed';
        if (sessionStorage.getItem(key)) return;
        bar.style.display = 'block';
        if (typeof window.deferredPrompt === 'undefined') window.deferredPrompt = null;
        if (!window._pwaPromptBound) { window._pwaPromptBound = true; window.addEventListener('beforeinstallprompt', function(e) { e.preventDefault(); window.deferredPrompt = e; }); }
        document.getElementById('home-add-bar-install-btn').addEventListener('click', function(){
            if (window.deferredPrompt) {
                window.deferredPrompt.prompt();
                window.deferredPrompt.userChoice.then(function(r) { if (r.outcome === 'accepted') window.deferredPrompt = null; });
            } else {
                alert('Android: Chrome ë©”ë‰´(â‹®) â†’ í™ˆ í™”ë©´ì— ì¶”ê°€\\niOS: Safari ê³µìœ  ë²„íŠ¼ â†’ í™ˆ í™”ë©´ì— ì¶”ê°€');
            }
        });
        document.getElementById('home-add-bar-close').addEventListener('click', function(){
            sessionStorage.setItem(key, '1');
            bar.style.transform = 'translateY(100%)';
            setTimeout(function(){ bar.style.display = 'none'; }, 300);
        });
    })();
    </script>
    </div>
    """
    has_more_categories = len(all_categories) > 8
    total_categories_count = len(all_categories)
    return render_template_string(HEADER_HTML + content + FOOTER_HTML, grouped_products=grouped_products, random_latest=random_latest, closing_today=closing_today, latest_reviews=latest_reviews, review_counts=review_counts, now=now, has_more_categories=has_more_categories, total_categories_count=total_categories_count)


@app.route('/categories')
def categories_all():
    """ì¹´í…Œê³ ë¦¬ ì „ì²´ë³´ê¸° (ë©”ì¸ì—ì„œ 8ê°œ ì´ˆê³¼ ì‹œ ë”ë³´ê¸°/ì „ì²´ë³´ê¸°ë¡œ ì´ë™)"""
    grade = (getattr(current_user, 'member_grade', 1) or 1) if current_user.is_authenticated else 1
    all_categories = categories_for_member_grade(grade).order_by(Category.order.asc(), Category.id.asc()).all()
    grouped_products = {}
    order_logic = (Product.stock <= 0) | (Product.deadline < datetime.now())
    for cat in all_categories:
        prods = Product.query.filter_by(category=cat.name, is_active=True).order_by(order_logic, Product.id.desc()).limit(20).all()
        if prods:
            grouped_products[cat] = prods
    content = """
    <div class="max-w-5xl mx-auto px-4 py-10">
        <div class="flex items-center gap-3 mb-6">
            <a href="/" class="text-slate-400 hover:text-teal-600 font-bold text-sm"><i class="fas fa-arrow-left mr-1"></i> ë©”ì¸ìœ¼ë¡œ</a>
            <h1 class="text-xl md:text-2xl font-black text-slate-800"><span class="w-1 h-8 bg-teal-500 rounded-full inline-block mr-2 align-middle"></span> ì¹´í…Œê³ ë¦¬ ì „ì²´ë³´ê¸°</h1>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
            {% for cat, prods in grouped_products.items() %}
            <a href="/category/{{ cat.name }}" class="flex flex-col items-center justify-center p-5 rounded-2xl border border-slate-100 bg-white hover:border-teal-200 hover:shadow-lg transition-all text-center">
                <span class="w-12 h-12 rounded-xl bg-teal-50 flex items-center justify-center text-teal-600 text-xl mb-2"><i class="fas fa-th-large"></i></span>
                <span class="text-xs md:text-sm font-black text-slate-700">{{ cat.name }}</span>
                <span class="text-[10px] text-slate-400 font-bold mt-0.5">{{ prods|length }}ì¢…</span>
            </a>
            {% endfor %}
            <a href="/category/ì˜¤ëŠ˜ë§ˆê°" class="flex flex-col items-center justify-center p-5 rounded-2xl border border-red-100 bg-red-50/50 hover:shadow-lg transition-all text-center">
                <span class="w-12 h-12 rounded-xl bg-red-100 flex items-center justify-center text-red-600 text-xl mb-2"><i class="fas fa-clock"></i></span>
                <span class="text-xs md:text-sm font-black text-red-800">ì˜¤ëŠ˜ ë§ˆê°</span>
            </a>
            <a href="/category/ìµœì‹ ìƒí’ˆ" class="flex flex-col items-center justify-center p-5 rounded-2xl border border-blue-100 bg-blue-50/50 hover:shadow-lg transition-all text-center">
                <span class="w-12 h-12 rounded-xl bg-blue-100 flex items-center justify-center text-blue-600 text-xl mb-2"><i class="fas fa-star"></i></span>
                <span class="text-xs md:text-sm font-black text-blue-800">ìµœì‹  ìƒí’ˆ</span>
            </a>
        </div>
    </div>
    """
    return render_template_string(HEADER_HTML + content + FOOTER_HTML, grouped_products=grouped_products)


@app.route('/about')
def about_page():
    """ì œê³µëœ HTML í˜•ì‹ì„ ë°˜ì˜í•œ ë°”êµ¬ë‹ˆì‚¼ì´Œ ë¸Œëœë“œ ì†Œê°œ í˜ì´ì§€"""
    content = """
    <style>
        /* ì†Œê°œ í˜ì´ì§€ ì „ìš© ìŠ¤íƒ€ì¼ */
        .about-body {
            margin: 0;
            background-color: #f9fafb;
            color: #111827;
            line-height: 1.7;
            font-family: "Pretendard", "Noto Sans KR", sans-serif;
        }

        .about-container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 80px 20px;
            text-align: left; /* ì™¼ìª½ ì •ë ¬ ìœ ì§€ */
        }

        .about-container h1 {
            font-size: 42px;
            font-weight: 800;
            margin-bottom: 24px;
            letter-spacing: -0.02em;
        }

        .about-container h2 {
            font-size: 28px;
            font-weight: 800;
            margin: 80px 0 24px;
            color: #111827;
        }

        .about-container p {
            font-size: 17px;
            margin-bottom: 20px;
            color: #374151;
        }

        .about-container b {
            color: #111827;
        }

        .about-highlight {
            font-weight: 700;
            color: #059669;
        }

        /* Core Value Boxes */
        .core-values {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-top: 40px;
        }

        .value-box {
            background: #ffffff;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            border: 1px solid #f3f4f6;
        }

        .value-box span {
            display: block;
            font-size: 14px;
            font-weight: 700;
            color: #6b7280;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .value-box strong {
            font-size: 48px;
            color: #059669;
            font-weight: 900;
            font-style: italic;
        }

        /* Premium 6PL Model Section */
        .premium-section {
            margin-top: 100px;
            background: #111827;
            color: #ffffff;
            border-radius: 32px;
            padding: 60px 50px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .premium-section h2 {
            color: #ffffff;
            margin-top: 0;
            font-size: 32px;
        }

        .premium-list {
            margin-top: 32px;
            padding: 0;
        }

        .premium-list li {
            list-style: none;
            font-size: 19px;
            margin-bottom: 18px;
            position: relative;
            padding-left: 32px;
            font-weight: 500;
            color: #d1d5db;
        }

        .premium-list li::before {
            content: "âœ”";
            position: absolute;
            left: 0;
            color: #10b981;
            font-weight: 900;
        }

        .premium-list li b {
            color: #ffffff;
        }

        /* Call To Action Button */
        .about-cta {
            text-align: center;
            margin-top: 100px;
            padding-bottom: 40px;
        }

        .about-cta a {
            display: inline-block;
            padding: 20px 48px;
            font-size: 20px;
            font-weight: 800;
            background: #059669;
            color: #ffffff;
            border-radius: 999px;
            text-decoration: none;
            transition: all 0.3s ease;
            box-shadow: 0 10px 20px rgba(5, 150, 105, 0.2);
        }

        .about-cta a:hover {
            background: #047857;
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(5, 150, 105, 0.3);
        }

        @media (max-width: 640px) {
            .about-container { padding: 60px 24px; }
            .about-container h1 { font-size: 32px; }
            .premium-section { padding: 40px 30px; }
            .value-box strong { font-size: 38px; }
        }
    </style>

    <div class="about-body">
        <div class="about-container">
    <h1>ë°”êµ¬ë‹ˆ ì‚¼ì´Œëª°</h1>
    <p>
        ë°”êµ¬ë‹ˆ ì‚¼ì´Œëª°ì€ <span class="about-highlight">ë¬¼ë¥˜ ì¸í”„ë¼ë¥¼ ì§ì ‘ ìš´ì˜í•˜ë©° ì£¼ë¬¸ ì „ ê³¼ì •ì„ ì±…ì„ì§€ëŠ” êµ¬ë§¤ëŒ€í–‰ ì„œë¹„ìŠ¤</span>ì…ë‹ˆë‹¤.
    </p>
    <p>
        ìš°ë¦¬ëŠ” ê¸°ì¡´ ìœ í†µì˜ ë¶ˆí•„ìš”í•œ ë‹¨ê³„ë¥¼ ì œê±°í•˜ê¸° ìœ„í•´ <b>ìƒí’ˆ ëŒ€ë¦¬ êµ¬ë§¤ Â· ì§ì˜ ë¬¼ë¥˜ Â· ë¼ìŠ¤íŠ¸ë§ˆì¼ ë°°ì†¡</b>ì„ í•˜ë‚˜ì˜ ì‹œìŠ¤í…œìœ¼ë¡œ í†µí•©í–ˆìŠµë‹ˆë‹¤.
    </p>
    <p>
        ë‹¨ìˆœíˆ íŒë§¤ìì™€ êµ¬ë§¤ìë¥¼ ì—°ê²°í•˜ëŠ” ì¤‘ê°œ í”Œë«í¼ì´ ì•„ë‹ˆë¼, ì´ìš©ìì˜ ìš”ì²­ì„ ë°›ì•„ <span class="about-highlight">ì‚¼ì´Œì´ ì§ì ‘ ê²€ìˆ˜í•˜ê³  êµ¬ë§¤í•˜ì—¬ ë¬¸ ì•ê¹Œì§€ ë°°ì†¡</span>í•˜ëŠ” ì±…ì„ ëŒ€í–‰ ëª¨ë¸ì„ ì§€í–¥í•©ë‹ˆë‹¤.
    </p>
    <p>
        ì§êµ¬/êµ¬ë§¤ëŒ€í–‰ ë°©ì‹ì˜ íš¨ìœ¨ì ì¸ ë¬¼ë¥˜ ì‹œìŠ¤í…œì„ í†µí•´ ê´‘ê³ ë¹„ì™€ ìœ í†µ ê±°í’ˆì„ ëºìœ¼ë©°, ê·¸ í˜œíƒì„ <b>ìƒí’ˆì˜ ì‹¤ì œ ì¡°ë‹¬ ì›ê°€ì™€ í•©ë¦¬ì ì¸ ë°°ì†¡ë¹„</b>ì— ê·¸ëŒ€ë¡œ ë°˜ì˜í•©ë‹ˆë‹¤.
    </p>

    <h2>Our Core Value</h2>
    <div class="core-values">
        <div class="value-box">
            <span>ë¶ˆí•„ìš” ìœ í†µ ë§ˆì§„</span>
            <strong>ZERO</strong>
        </div>
        <div class="value-box">
            <span>ë°°ì†¡ ì±…ì„ ì„œë¹„ìŠ¤</span>
            <strong>DIRECT</strong>
        </div>
    </div>

    <p style="margin-top: 60px; font-size: 19px; font-weight: 700; border-left: 4px solid #10b981; padding-left: 20px;">
        ë°”êµ¬ë‹ˆ ì‚¼ì´Œì€ ì¤‘ê°œë§Œ í•˜ëŠ” ì¥í„°ê°€ ì•„ë‹ˆë¼, <br>
        <span class="about-highlight">â€˜êµ¬ë§¤ë¶€í„° ë°°ì†¡ê¹Œì§€ ë‹¹ì‚¬ê°€ ì§ì ‘ ì±…ì„ì§€ê³  ì™„ë£Œí•˜ëŠ” ëŒ€í–‰ í”Œë«í¼â€™</span>ì…ë‹ˆë‹¤.
    </p>

            <div class="premium-section">
                <h2>Premium 6PL Model</h2>
                <ul class="premium-list">
                    <li><b>ì†¡ë„ ìƒí™œê¶Œ ì¤‘ì‹¬</b>ì˜ ì§ì˜ ë°°ì†¡ ë„¤íŠ¸ì›Œí¬</li>
                    <li>ì‚°ì§€ ì†Œì‹±ë¶€í„° ë¬¸ ì•ê¹Œì§€ <b>ì‚¼ì´Œì´ ì§ì ‘ ê´€ë¦¬</b></li>
                    <li>ìì²´ ê¸°ìˆ  ì¸í”„ë¼ë¥¼ í†µí•œ <b>ì••ë„ì  ë¹„ìš© ì ˆê°</b></li>
                    <li>ë¶ˆí•„ìš”í•œ ë§ˆì¼€íŒ…ë¹„ë¥¼ ëº€ <b>ì›ê°€ ì¤‘ì‹¬ ìœ í†µ</b></li>
                    <li>ê°€ì¥ í•©ë¦¬ì ì¸ ìœ í†µì„ <b>ì†¡ë„ì—ì„œ ì‹¤í˜„</b></li>
                </ul>
            </div>

            <div class="about-cta">
                <a href="/">ì§€ê¸ˆ ìƒí’ˆ í™•ì¸í•˜ê¸°</a>
            </div>
            <p class="text-center mt-6">
                <a href="/guide" class="text-teal-600 font-bold hover:text-teal-700 underline underline-offset-4">ì´ìš©ì•ˆë‚´</a>
            </p>
        </div>
    </div>
    """
    return render_template_string(HEADER_HTML + content + FOOTER_HTML)


GUIDE_HTML = """
<div class="max-w-3xl mx-auto px-4 py-12 md:py-20">
    <h1 class="text-2xl md:text-3xl font-black text-gray-900 mb-8">ğŸ›’ ë°”êµ¬ë‹ˆì‚¼ì´Œëª° ì´ìš©ì•ˆë‚´</h1>
    <div class="border border-gray-200 rounded-2xl p-6 md:p-8 bg-gray-50/80 text-gray-700 text-sm md:text-base leading-relaxed">
        <p class="mb-4">
            ë°”êµ¬ë‹ˆì‚¼ì´Œëª°ì€ <b class="text-gray-900">6PL êµ¬ë§¤ëŒ€í–‰ ê¸°ë°˜ ê³µë™êµ¬ë§¤ í”Œë«í¼</b>ìœ¼ë¡œ ìš´ì˜ë©ë‹ˆë‹¤.<br>
            ì¬ê³  ë³´ê´€ê³¼ ì˜¤í”„ë¼ì¸ ë§¤ì¥ì„ ì—†ì• ê³ , ê³ ê° ì£¼ë¬¸ í›„ ë„ë§¤ì²˜ì— ì§ì ‘ ë°œì£¼í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ
            <b class="text-gray-900">ìœ í†µ ê±°í’ˆì„ ìµœì†Œí™”</b>í•˜ì—¬ í•©ë¦¬ì ì¸ ê°€ê²©ì„ ì œê³µí•©ë‹ˆë‹¤.
        </p>
        <ul class="list-disc pl-5 mb-6 space-y-1">
            <li><b>ê°€ê²© ì •ì±…:</b> ê³µë™êµ¬ë§¤ ë„ë§¤ê°€ ê·¸ëŒ€ë¡œ ê³µê¸‰ + ë°°ì†¡ë¹„ 1,900ì›</li>
            <li><b>ìš´ì˜ êµ¬ì¡°:</b> ë¬´ì¬ê³  Â· ë¬´ë§¤ì¥ Â· ë„ë§¤ì²˜ ì§ë°œì£¼ ì‹œìŠ¤í…œ</li>
            <li><b>ë°°ì†¡ ë°©ì‹:</b> ë„ë§¤ì²˜ â†’ ê³ ê° ì§‘ì• ì§ë°°ì†¡</li>
            <li><b>ë¬¶ìŒ ë°°ì†¡:</b> ê°€ëŠ¥ (ìƒí’ˆë³„ ì¡°ê±´ ìƒì´)</li>
        </ul>
        <h2 class="text-lg font-black text-gray-900 mt-6 mb-2">ğŸ¥¬ ë†ì‚°Â·ì¶•ì‚° ì‹ ì„  ë°°ì†¡ í”„ë¡œì„¸ìŠ¤</h2>
        <p class="mb-2">
            ë°”êµ¬ë‹ˆì‚¼ì´Œëª°ì˜ ë†ì‚°Â·ì¶•ì‚° ìƒí’ˆì€ <b>ë‹¹ì¼ ê²½ë§¤ Â· ë‹¹ì¼ ë„ì¶• ìƒí’ˆë§Œ ì·¨ê¸‰</b>í•©ë‹ˆë‹¤.
        </p>
        <ul class="list-disc pl-5 mb-4 space-y-1">
            <li>ë°¤ 12ì‹œ ì£¼ë¬¸ ë§ˆê°</li>
            <li>ë„ë§¤ì²˜ ì£¼ë¬¸ ì •ë³´ ìë™ ì „ì†¡</li>
            <li>ë‹¹ì¼ ê²½ë§¤ ë° ë„ì¶• ì§„í–‰</li>
            <li>ì˜¤ì „ ìƒí’ˆ í”½ì—…</li>
            <li>ì˜¤í›„ ê³ ê° ë°°ì†¡</li>
        </ul>
        <p class="mb-6">
            â†’ ì¬ê³  ë³´ê´€ ìƒí’ˆì´ ì•„ë‹Œ <b>ì‹¤ì‹œê°„ ìˆ˜ê¸‰ ê¸°ë°˜ ì‹ ì„  ìƒí’ˆ</b>ìœ¼ë¡œ ë”ìš± ì‹ ì„ í•˜ê³  í•©ë¦¬ì ì¸ ê°€ê²©ì— ê³µê¸‰ë©ë‹ˆë‹¤.
        </p>
        <h2 class="text-lg font-black text-gray-900 mt-6 mb-2">ğŸ­ ê³µì‚°í’ˆ ìš´ì˜ ë°©ì‹</h2>
        <ul class="list-disc pl-5 mb-6 space-y-1">
            <li>ì£¼ë¬¸ í›„ ë„ë§¤ì²˜ êµ¬ë§¤ ì§„í–‰</li>
            <li>ë¬´ì¬ê³  ìš´ì˜ìœ¼ë¡œ ë³´ê´€ ë¹„ìš© ìµœì†Œí™”</li>
            <li>ê³µë™êµ¬ë§¤ ë‹¨ê°€ ì ìš©</li>
            <li>ë§¤ì¥ ìš´ì˜ë¹„ ì ˆê°ìœ¼ë¡œ ê°€ê²© ê²½ìŸë ¥ í™•ë³´</li>
        </ul>
        <h2 class="text-lg font-black text-gray-900 mt-6 mb-2">ğŸšš ë°°ì†¡ ì•ˆë‚´</h2>
        <ul class="list-disc pl-5 mb-4 space-y-1">
            <li><b>ê¸°ë³¸ ë°°ì†¡ë¹„:</b> 1,900ì›</li>
            <li>ëƒ‰ì¥/ëƒ‰ë™, ë¶€í”¼ ì´ˆê³¼, ì‚°ì§€ì§ì†¡ ìƒí’ˆì€ ì¶”ê°€ ë°°ì†¡ë¹„ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
            <li>ì¶”ê°€ ë°°ì†¡ë¹„ëŠ” ìƒí’ˆ ìƒì„¸í˜ì´ì§€ì— ë³„ë„ ì•ˆë‚´ë©ë‹ˆë‹¤.</li>
        </ul>
        <p class="mb-8">
            í–¥í›„ ì£¼ë¬¸ ê³ ê° ì¦ê°€ ì‹œ <b>ì˜¤ì „ Â· ìƒˆë²½ Â· ì €ë… ë°°ì†¡</b>ìœ¼ë¡œ ë‹¨ê³„ì  í™•ëŒ€ ì˜ˆì •ì´ë©°,<br>
            ì§€ì—­ ë¡œì»¬ë§›ì§‘ ë° ë°°ë‹¬ ìŒì‹ì  ìƒí’ˆë„ <b>ìµœëŒ€ 20% í• ì¸</b> í˜•íƒœë¡œ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤.
        </p>
        <hr class="border-gray-200 my-6">
        <h2 class="text-lg font-black text-gray-900 mb-3">âš ï¸ ì£¼ë¬¸ ì „ í•„ìˆ˜ í™•ì¸</h2>
        <ul class="list-disc pl-5 space-y-2">
            <li>ì¥ë°”êµ¬ë‹ˆ ë‹¨ê³„ì—ì„œëŠ” ì–¸ì œë“ ì§€ ì£¼ë¬¸ ì·¨ì†Œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
            <li>ë³¸ ì„œë¹„ìŠ¤ëŠ” ê³µë™êµ¬ë§¤ ë° ì‹¤ì‹œê°„ ìˆ˜ê¸‰ ê¸°ë°˜ íŠ¹ì„±ìƒ ë„ë§¤ì²˜ í’ˆì ˆ, ìˆ˜ê¸‰ ë³€ë™ ë“±ì˜ ì‚¬ìœ ë¡œ <b>ë¶€ë¶„ ë˜ëŠ” ì „ì²´ ì·¨ì†Œ</b>ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
            <li>ë¹„ì •ìƒì , ìƒì—…ì  ì¬íŒë§¤ ëª©ì , ì‹œìŠ¤í…œ ì•…ìš©ì´ ì˜ì‹¬ë˜ëŠ” ì£¼ë¬¸ì€ <b>ê´€ë¦¬ì íŒë‹¨ì— ë”°ë¼ ì‚¬ì „ ì•ˆë‚´ í›„ ì·¨ì†Œ</b>ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
            <li>ìƒí’ˆ ì¤€ë¹„ê°€ ì‹œì‘ëœ ì´í›„ì—ëŠ” ì·¨ì†ŒÂ·ë³€ê²½ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
        </ul>
        <p class="mt-8 text-center">
            <a href="/" class="inline-block bg-teal-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-teal-700 transition">ì‡¼í•‘í•˜ëŸ¬ ê°€ê¸°</a>
            <a href="/about" class="inline-block ml-3 text-teal-600 font-bold hover:underline">ë°”êµ¬ë‹ˆì‚¼ì´Œì´ë€?</a>
        </p>
    </div>
</div>
"""


@app.route('/guide')
def guide_page():
    """ë°”êµ¬ë‹ˆì‚¼ì´Œëª° ì´ìš©ì•ˆë‚´ ì „ìš© í˜ì´ì§€ (ê²°ì œ ë²„íŠ¼ ì—†ìŒ)"""
    return render_template_string(HEADER_HTML + GUIDE_HTML + FOOTER_HTML)


# ---------- ì „êµ­ë§›ì§‘ìš”ì²­ / ì œíœ´ë¬¸ì˜ ê²Œì‹œíŒ ----------
def _restaurant_recommend_count(rid):
    return RestaurantRecommend.query.filter_by(restaurant_request_id=rid).count()


def _restaurant_vote_counts(rid):
    """ì „êµ­ë§›ì§‘ìš”ì²­ ê²Œì‹œê¸€ë³„ ì¶”ì²œ(up)/ë¹„ì¶”ì²œ(down) ìˆ˜. RestaurantVote ì‚¬ìš©, ì—†ìœ¼ë©´ ë ˆê±°ì‹œ ì¶”ì²œ ìˆ˜ ë°˜í™˜."""
    up = RestaurantVote.query.filter_by(restaurant_request_id=rid, vote_type='up').count()
    down = RestaurantVote.query.filter_by(restaurant_request_id=rid, vote_type='down').count()
    # ë ˆê±°ì‹œ: ì•„ì§ Voteê°€ ì—†ëŠ” ê¸€ì€ ê¸°ì¡´ Recommendë¥¼ upìœ¼ë¡œ ê°„ì£¼í•´ í•©ì‚°
    if up == 0 and down == 0:
        leg = RestaurantRecommend.query.filter_by(restaurant_request_id=rid).count()
        if leg > 0:
            up = leg
    return up, down


def _migrate_restaurant_recommend_to_vote():
    """RestaurantRecommend ë°ì´í„°ë¥¼ RestaurantVote(up)ë¡œ í•œ ë²ˆ ì´ì „."""
    for rec in RestaurantRecommend.query.all():
        if not RestaurantVote.query.filter_by(user_id=rec.user_id, restaurant_request_id=rec.restaurant_request_id).first():
            db.session.add(RestaurantVote(user_id=rec.user_id, restaurant_request_id=rec.restaurant_request_id, vote_type='up'))
    try:
        db.session.commit()
    except Exception:
        db.session.rollback()


def _user_restaurant_vote(rid):
    """í˜„ì¬ ì‚¬ìš©ìì˜ í•´ë‹¹ ê¸€ íˆ¬í‘œ. 'up', 'down', None."""
    if not current_user.is_authenticated:
        return None
    v = RestaurantVote.query.filter_by(restaurant_request_id=rid, user_id=current_user.id).first()
    return v.vote_type if v else None


def _delivery_request_vote_counts(did):
    """ë°°ì†¡ìš”ì²­ ê¸€ë³„ ì¶”ì²œ(up)/ë¹„ì¶”ì²œ(down) ìˆ˜."""
    up = DeliveryRequestVote.query.filter_by(delivery_request_id=did, vote_type='up').count()
    down = DeliveryRequestVote.query.filter_by(delivery_request_id=did, vote_type='down').count()
    return up, down


def _user_delivery_request_vote(did):
    """í˜„ì¬ ì‚¬ìš©ìì˜ í•´ë‹¹ ë°°ì†¡ìš”ì²­ ê¸€ íˆ¬í‘œ. 'up', 'down', None."""
    if not current_user.is_authenticated:
        return None
    v = DeliveryRequestVote.query.filter_by(delivery_request_id=did, user_id=current_user.id).first()
    return v.vote_type if v else None


def _record_page_view(page_type):
    """ì¼ë³„ í˜ì´ì§€ë·° ê¸°ë¡. page_type: 'main', 'category', 'product', 'cart'. ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ."""
    try:
        today = datetime.now().date()
        row = DailyStat.query.filter_by(stat_date=today).first()
        if not row:
            row = DailyStat(stat_date=today)
            db.session.add(row)
        if page_type == 'main':
            row.main_views = (row.main_views or 0) + 1
        elif page_type == 'category':
            row.category_views = (row.category_views or 0) + 1
        elif page_type == 'product':
            row.product_views = (row.product_views or 0) + 1
        elif page_type == 'cart':
            row.cart_views = (row.cart_views or 0) + 1
        db.session.commit()
    except Exception:
        db.session.rollback()


def _user_recommended_restaurant(rid):
    if not current_user.is_authenticated:
        return False
    vt = _user_restaurant_vote(rid)
    if vt == 'up':
        return True
    if vt is None:
        return RestaurantRecommend.query.filter_by(restaurant_request_id=rid, user_id=current_user.id).first() is not None
    return False


@app.route('/board/restaurant-request')
def board_restaurant_request():
    """ì „êµ­ë§›ì§‘ìš”ì²­ ëª©ë¡"""
    posts = RestaurantRequest.query.filter_by(is_hidden=False).order_by(RestaurantRequest.id.desc()).all()
    vote_counts = {p.id: _restaurant_vote_counts(p.id) for p in posts}
    return render_template_string(
        HEADER_HTML + """
        <div class="max-w-3xl mx-auto py-8 md:py-12 px-4 font-black text-left">
            <a href="/" class="text-gray-400 hover:text-teal-600 text-sm font-bold mb-6 inline-block">â† í™ˆ</a>
            <h1 class="text-2xl md:text-3xl font-black text-gray-900 mb-2">ì „êµ­ë§›ì§‘ìš”ì²­</h1>
            <p class="text-gray-500 text-sm mb-6">ì‚¬ì§„Â·ì—…ì²´ì •ë³´Â·ë©”ë‰´ë¥¼ ë“±ë¡í•´ ë³´ì„¸ìš”. ì¶”ì²œ 100ê°œ ì´ìƒ ì‹œ ì „êµ­ ì–´ë””ë“  í¬ì¥ ê°€ëŠ¥í•˜ë©´ ë‹¹ì¼ ë°°ì†¡ ì†Œì‹±ì„ ì§„í–‰í•©ë‹ˆë‹¤.</p>
            <a href="/board/restaurant-request/write" class="inline-block mb-6 px-5 py-3 bg-teal-600 text-white rounded-xl text-sm font-black hover:bg-teal-700 transition">ê¸€ì“°ê¸°</a>
            <div class="space-y-4">
                {% for p in posts %}
                {% set up_down = vote_counts.get(p.id, (0, 0)) %}
                <a href="/board/restaurant-request/{{ p.id }}" class="block bg-white rounded-2xl border border-gray-100 p-4 shadow-sm hover:shadow-md transition text-left">
                    <div class="flex gap-4">
                        {% if p.image_url %}<img src="{{ p.image_url }}" class="w-24 h-24 rounded-xl object-cover shrink-0" alt="">{% endif %}
                        <div class="flex-1 min-w-0">
                            <p class="font-black text-gray-800 truncate">{{ p.store_name }}</p>
                            <p class="text-[10px] text-gray-400 mt-1">{{ p.created_at.strftime('%Y.%m.%d') if p.created_at else '' }}</p>
                            <p class="text-sm text-gray-600 mt-1 line-clamp-2">{{ (p.store_info or p.menu or '')[:80] }}...</p>
                            <span class="inline-block mt-2 text-teal-600 text-xs font-black">ğŸ‘ {{ up_down[0] }}</span>
                            <span class="inline-block mt-2 ml-2 text-gray-400 text-xs font-black">ğŸ‘ {{ up_down[1] }}</span>
                            {% if up_down[0] >= 100 %}
                            <span class="ml-2 text-amber-600 text-[10px] font-black">âœ“ 100ê°œ ë‹¬ì„± Â· ë‹¹ì¼ë°°ì†¡ ì†Œì‹± ëŒ€ìƒ</span>
                            {% endif %}
                        </div>
                    </div>
                </a>
                {% else %}
                <div class="bg-gray-50 rounded-2xl p-12 text-center text-gray-500">ë“±ë¡ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                {% endfor %}
            </div>
        </div>
        """ + FOOTER_HTML,
        posts=posts, vote_counts=vote_counts
    )


@app.route('/board/restaurant-request/write', methods=['GET', 'POST'])
@login_required
def board_restaurant_request_write():
    """ì „êµ­ë§›ì§‘ìš”ì²­ ê¸€ì“°ê¸° í¼"""
    if request.method == 'POST':
        store_name = (request.form.get('store_name') or '').strip()
        if not store_name:
            flash("ì—…ì²´ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
            return redirect(url_for('board_restaurant_request_write'))
        store_info = (request.form.get('store_info') or '').strip()
        menu = (request.form.get('menu') or '').strip()
        img_url = save_board_image(request.files.get('image'))
        r = RestaurantRequest(
            user_id=current_user.id,
            user_name=current_user.name,
            store_name=store_name,
            store_info=store_info or None,
            menu=menu or None,
            image_url=img_url
        )
        db.session.add(r)
        db.session.commit()
        flash("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.")
        return redirect(url_for('board_restaurant_request_detail', rid=r.id))
    return render_template_string(
        HEADER_HTML + """
        <div class="max-w-2xl mx-auto py-8 md:py-12 px-4 font-black text-left">
            <a href="/board/restaurant-request" class="text-gray-400 hover:text-teal-600 text-sm font-bold mb-6 inline-block">â† ëª©ë¡</a>
            <h1 class="text-2xl font-black text-gray-900 mb-6">ì „êµ­ë§›ì§‘ìš”ì²­ ê¸€ì“°ê¸°</h1>
            <form method="POST" action="/board/restaurant-request/write" enctype="multipart/form-data" class="space-y-4">
                <div><label class="block text-[10px] text-gray-500 uppercase mb-1">ì—…ì²´ëª… *</label><input type="text" name="store_name" required class="w-full px-4 py-3 rounded-xl border border-gray-200 text-sm font-bold" placeholder="ë§›ì§‘ ì´ë¦„"></div>
                <div><label class="block text-[10px] text-gray-500 uppercase mb-1">ì—…ì²´ ì •ë³´ (ì£¼ì†ŒÂ·ì—°ë½ì²˜ ë“±)</label><textarea name="store_info" rows="3" class="w-full px-4 py-3 rounded-xl border border-gray-200 text-sm font-bold" placeholder="ì—…ì²´ ì •ë³´"></textarea></div>
                <div><label class="block text-[10px] text-gray-500 uppercase mb-1">ë©”ë‰´</label><textarea name="menu" rows="4" class="w-full px-4 py-3 rounded-xl border border-gray-200 text-sm font-bold" placeholder="ë©”ë‰´Â·ëŒ€í‘œ ìš”ë¦¬"></textarea></div>
                <div><label class="block text-[10px] text-gray-500 uppercase mb-1">ì‚¬ì§„</label><input type="file" name="image" accept="image/*" class="w-full text-sm p-3 rounded-xl border border-gray-200"></div>
                <button type="submit" class="w-full py-4 bg-teal-600 text-white rounded-xl font-black hover:bg-teal-700 transition">ë“±ë¡</button>
            </form>
        </div>
        """ + FOOTER_HTML
    )


@app.route('/board/restaurant-request/<int:rid>')
def board_restaurant_request_detail(rid):
    """ì „êµ­ë§›ì§‘ìš”ì²­ ìƒì„¸. ì¶”ì²œ/ë¹„ì¶”ì²œ ê²Œì‹œê¸€ë‹¹ 1ì¸ 1í‘œ."""
    _migrate_restaurant_recommend_to_vote()
    p = RestaurantRequest.query.filter_by(id=rid, is_hidden=False).first_or_404()
    up_count, down_count = _restaurant_vote_counts(p.id)
    user_vote = _user_restaurant_vote(p.id)
    show_100_notice = up_count >= 100
    return render_template_string(
        HEADER_HTML + """
        <div class="max-w-3xl mx-auto py-8 md:py-12 px-4 font-black text-left">
            <a href="/board/restaurant-request" class="text-gray-400 hover:text-teal-600 text-sm font-bold mb-6 inline-block">â† ëª©ë¡</a>
            <div class="bg-white rounded-2xl border border-gray-100 p-6 shadow-sm">
                {% if p.image_url %}<img src="{{ p.image_url }}" class="w-full max-h-80 object-cover rounded-xl mb-4" alt="">{% endif %}
                <h1 class="text-xl font-black text-gray-900 mb-2">{{ p.store_name }}</h1>
                <p class="text-[10px] text-gray-400 mb-4">{{ p.created_at.strftime('%Y.%m.%d %H:%M') if p.created_at else '' }} Â· {{ p.user_name or 'ë¹„íšŒì›' }}</p>
                {% if p.store_info %}<div class="mb-4"><p class="text-[10px] text-gray-500 uppercase mb-1">ì—…ì²´ì •ë³´</p><p class="text-gray-700 text-sm whitespace-pre-wrap">{{ p.store_info }}</p></div>{% endif %}
                {% if p.menu %}<div class="mb-4"><p class="text-[10px] text-gray-500 uppercase mb-1">ë©”ë‰´</p><p class="text-gray-700 text-sm whitespace-pre-wrap">{{ p.menu }}</p></div>{% endif %}
                <div class="flex flex-wrap items-center gap-3 pt-4 border-t border-gray-100">
                    <span class="text-teal-600 font-black">ğŸ‘ ì¶”ì²œ {{ up_count }}</span>
                    <span class="text-gray-500 font-black">ğŸ‘ ë¹„ì¶”ì²œ {{ down_count }}</span>
                    {% if current_user.is_authenticated %}
                    <form action="/board/restaurant-request/{{ p.id }}/vote" method="POST" class="inline"><input type="hidden" name="vote_type" value="up"><button type="submit" class="px-4 py-2 rounded-xl text-xs font-black transition {% if user_vote == 'up' %}bg-teal-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-teal-100 hover:text-teal-700{% endif %}">ì¶”ì²œ</button></form>
                    <form action="/board/restaurant-request/{{ p.id }}/vote" method="POST" class="inline"><input type="hidden" name="vote_type" value="down"><button type="submit" class="px-4 py-2 rounded-xl text-xs font-black transition {% if user_vote == 'down' %}bg-gray-700 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">ë¹„ì¶”ì²œ</button></form>
                    {% if user_vote %}<span class="text-[10px] text-gray-400">(ê²Œì‹œê¸€ë‹¹ ì¶”ì²œ/ë¹„ì¶”ì²œ ì¤‘ í•˜ë‚˜ë§Œ ì„ íƒ ê°€ëŠ¥)</span>{% endif %}
                    {% else %}
                    <span class="text-gray-400 text-sm">ë¡œê·¸ì¸ í›„ ì¶”ì²œÂ·ë¹„ì¶”ì²œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
                    {% endif %}
                </div>
                {% if p.admin_notes %}
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <p class="text-[10px] text-teal-600 font-black uppercase mb-1">ê´€ë¦¬ì ëŒ“ê¸€</p>
                    <p class="text-gray-700 text-sm whitespace-pre-wrap">{{ p.admin_notes }}</p>
                </div>
                {% endif %}
                {% if show_100_notice %}
                <div class="mt-6 p-4 bg-amber-50 border border-amber-200 rounded-xl text-amber-800 text-sm font-bold">
                    âœ“ ì¶”ì²œ 100ê°œ ë‹¬ì„± Â· ì „êµ­ ì–´ë””ë§›ì§‘ì´ë“  í¬ì¥ë§Œ ê°€ëŠ¥í•˜ë‹¤ë©´ ìƒí’ˆ ì†Œì‹± í›„ ë‹¹ì¼ ë°°ì†¡ì„ ì§„í–‰í•©ë‹ˆë‹¤.
                </div>
                {% endif %}
            </div>
        </div>
        """ + FOOTER_HTML,
        p=p, up_count=up_count, down_count=down_count, user_vote=user_vote, show_100_notice=show_100_notice
    )


@app.route('/board/restaurant-request/<int:rid>/recommend', methods=['POST'])
@login_required
def board_restaurant_request_recommend(rid):
    """ì¶”ì²œ (ë ˆê±°ì‹œ: vote upìœ¼ë¡œ ì „í™˜)"""
    post = RestaurantRequest.query.filter_by(id=rid, is_hidden=False).first_or_404()
    v = RestaurantVote.query.filter_by(restaurant_request_id=rid, user_id=current_user.id).first()
    if v:
        v.vote_type = 'up'
    else:
        db.session.add(RestaurantVote(restaurant_request_id=rid, user_id=current_user.id, vote_type='up'))
    db.session.commit()
    flash("ì¶”ì²œë˜ì—ˆìŠµë‹ˆë‹¤.")
    return redirect(url_for('board_restaurant_request_detail', rid=rid))


@app.route('/board/restaurant-request/<int:rid>/vote', methods=['POST'])
@login_required
def board_restaurant_request_vote(rid):
    """ì¶”ì²œ(up) ë˜ëŠ” ë¹„ì¶”ì²œ(down). ê²Œì‹œê¸€ë‹¹ 1ì¸ 1í‘œ."""
    post = RestaurantRequest.query.filter_by(id=rid, is_hidden=False).first_or_404()
    vote_type = (request.form.get('vote_type') or '').strip().lower()
    if vote_type not in ('up', 'down'):
        flash("ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤.")
        return redirect(url_for('board_restaurant_request_detail', rid=rid))
    v = RestaurantVote.query.filter_by(restaurant_request_id=rid, user_id=current_user.id).first()
    if v:
        v.vote_type = vote_type
    else:
        db.session.add(RestaurantVote(restaurant_request_id=rid, user_id=current_user.id, vote_type=vote_type))
    db.session.commit()
    flash("ì¶”ì²œë˜ì—ˆìŠµë‹ˆë‹¤." if vote_type == 'up' else "ë¹„ì¶”ì²œë˜ì—ˆìŠµë‹ˆë‹¤.")
    return redirect(url_for('board_restaurant_request_detail', rid=rid))


# ---------- ë°°ì†¡ìš”ì²­ ê²Œì‹œíŒ ----------
@app.route('/board/delivery-request')
def board_delivery_request():
    """ë°°ì†¡ìš”ì²­ ëª©ë¡. ì§€ì—­ëª…Â·ê¸€ë‚´ìš©, ì¶”ì²œ ë§ìœ¼ë©´ ë°°ì†¡êµ¬ì—­ í™•ì¥ ê²€í† ."""
    posts = DeliveryRequest.query.filter_by(is_hidden=False).order_by(DeliveryRequest.id.desc()).all()
    vote_counts = {p.id: _delivery_request_vote_counts(p.id) for p in posts}
    return render_template_string(
        HEADER_HTML + """
        <div class="max-w-3xl mx-auto py-8 md:py-12 px-4 font-black text-left">
            <a href="/" class="text-gray-400 hover:text-teal-600 text-sm font-bold mb-6 inline-block">â† í™ˆ</a>
            <h1 class="text-2xl md:text-3xl font-black text-gray-900 mb-2">ë°°ì†¡ìš”ì²­</h1>
            <p class="text-gray-500 text-sm mb-6">ë°°ì†¡ì´ ë˜ì—ˆìœ¼ë©´ í•˜ëŠ” ì§€ì—­ì„ ì•Œë ¤ì£¼ì„¸ìš”. ì¶”ì²œì´ ë§ì€ ì§€ì—­ë¶€í„° ë°°ì†¡êµ¬ì—­ í™•ì¥ì„ ê²€í† í•©ë‹ˆë‹¤.</p>
            <a href="/board/delivery-request/write" class="inline-block mb-6 px-5 py-3 bg-teal-600 text-white rounded-xl text-sm font-black hover:bg-teal-700 transition">ê¸€ì“°ê¸°</a>
            <div class="space-y-4">
                {% for p in posts %}
                {% set up_down = vote_counts.get(p.id, (0, 0)) %}
                <a href="/board/delivery-request/{{ p.id }}" class="block bg-white rounded-2xl border border-gray-100 p-4 shadow-sm hover:shadow-md transition text-left">
                    <div class="flex gap-4">
                        <div class="flex-1 min-w-0">
                            <p class="font-black text-teal-700 text-sm">{{ p.region_name }}</p>
                            <p class="text-gray-700 text-sm mt-1 line-clamp-2">{{ (p.content or '')[:100] }}{% if (p.content or '')|length > 100 %}...{% endif %}</p>
                            <p class="text-[10px] text-gray-400 mt-2">{{ p.created_at.strftime('%Y.%m.%d') if p.created_at else '' }} Â· {{ p.user_name or 'ë¹„íšŒì›' }}</p>
                            <span class="inline-block mt-2 text-teal-600 text-xs font-black">ğŸ‘ {{ up_down[0] }}</span>
                            <span class="inline-block mt-2 ml-2 text-gray-400 text-xs font-black">ğŸ‘ {{ up_down[1] }}</span>
                            {% if up_down[0] >= 20 %}
                            <span class="ml-2 text-amber-600 text-[10px] font-black">âœ“ ì¶”ì²œ ë§ìŒ Â· ë°°ì†¡êµ¬ì—­ ê²€í†  ëŒ€ìƒ</span>
                            {% endif %}
                        </div>
                    </div>
                </a>
                {% else %}
                <div class="bg-gray-50 rounded-2xl p-12 text-center text-gray-500">ë“±ë¡ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                {% endfor %}
            </div>
        </div>
        """ + FOOTER_HTML,
        posts=posts, vote_counts=vote_counts
    )


@app.route('/board/delivery-request/write', methods=['GET', 'POST'])
@login_required
def board_delivery_request_write():
    """ë°°ì†¡ìš”ì²­ ê¸€ì“°ê¸°. ì§€ì—­ëª…, ê¸€ë‚´ìš©(ì—¬ê¸°ë„ ë°°ì†¡í•´ì£¼ì„¸ìš” ë“±)."""
    if request.method == 'POST':
        region_name = (request.form.get('region_name') or '').strip()
        if not region_name:
            flash("ì§€ì—­ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
            return redirect(url_for('board_delivery_request_write'))
        content = (request.form.get('content') or '').strip()
        r = DeliveryRequest(
            user_id=current_user.id,
            user_name=current_user.name or current_user.email or 'íšŒì›',
            region_name=region_name,
            content=content or None
        )
        db.session.add(r)
        db.session.commit()
        flash("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.")
        return redirect(url_for('board_delivery_request_detail', did=r.id))
    return render_template_string(
        HEADER_HTML + """
        <div class="max-w-2xl mx-auto py-8 md:py-12 px-4 font-black text-left">
            <a href="/board/delivery-request" class="text-gray-400 hover:text-teal-600 text-sm font-bold mb-6 inline-block">â† ëª©ë¡</a>
            <h1 class="text-2xl font-black text-gray-900 mb-6">ë°°ì†¡ìš”ì²­ ê¸€ì“°ê¸°</h1>
            <p class="text-gray-500 text-sm mb-4">ë°°ì†¡ì´ ë˜ì—ˆìœ¼ë©´ í•˜ëŠ” ì§€ì—­ê³¼ í•˜ê³  ì‹¶ì€ ë§ì„ ì ì–´ì£¼ì„¸ìš”. ì¶”ì²œì´ ë§ì€ ì§€ì—­ë¶€í„° ë°°ì†¡êµ¬ì—­ í™•ì¥ì„ ê²€í† í•©ë‹ˆë‹¤.</p>
            <form method="POST" action="/board/delivery-request/write" class="space-y-4">
                <div><label class="block text-[10px] text-gray-500 uppercase mb-1">ì§€ì—­ëª… *</label><input type="text" name="region_name" required class="w-full px-4 py-3 rounded-xl border border-gray-200 text-sm font-bold" placeholder="ì˜ˆ: OOë™, OOêµ¬, OOì‹œ OOë™"></div>
                <div><label class="block text-[10px] text-gray-500 uppercase mb-1">ê¸€ë‚´ìš©</label><textarea name="content" rows="4" class="w-full px-4 py-3 rounded-xl border border-gray-200 text-sm font-bold" placeholder="ì˜ˆ: ì—¬ê¸°ë„ ë°°ì†¡í•´ì£¼ì„¸ìš”! / ìš°ë¦¬ ë™ë„¤ë„ ë¶€íƒë“œë ¤ìš”"></textarea></div>
                <button type="submit" class="w-full py-4 bg-teal-600 text-white rounded-xl font-black hover:bg-teal-700 transition">ë“±ë¡</button>
            </form>
        </div>
        """ + FOOTER_HTML
    )


@app.route('/board/delivery-request/<int:did>')
def board_delivery_request_detail(did):
    """ë°°ì†¡ìš”ì²­ ìƒì„¸. ì¶”ì²œ/ë¹„ì¶”ì²œ 1ì¸ 1í‘œ."""
    p = DeliveryRequest.query.filter_by(id=did, is_hidden=False).first_or_404()
    up_count, down_count = _delivery_request_vote_counts(p.id)
    user_vote = _user_delivery_request_vote(p.id)
    show_notice = up_count >= 20
    return render_template_string(
        HEADER_HTML + """
        <div class="max-w-3xl mx-auto py-8 md:py-12 px-4 font-black text-left">
            <a href="/board/delivery-request" class="text-gray-400 hover:text-teal-600 text-sm font-bold mb-6 inline-block">â† ëª©ë¡</a>
            <div class="bg-white rounded-2xl border border-gray-100 p-6 shadow-sm">
                <h1 class="text-xl font-black text-teal-700 mb-2">{{ p.region_name }}</h1>
                <p class="text-[10px] text-gray-400 mb-4">{{ p.created_at.strftime('%Y.%m.%d %H:%M') if p.created_at else '' }} Â· {{ p.user_name or 'ë¹„íšŒì›' }}</p>
                {% if p.content %}<div class="mb-4"><p class="text-gray-700 text-sm whitespace-pre-wrap">{{ p.content }}</p></div>{% endif %}
                <div class="flex flex-wrap items-center gap-3 pt-4 border-t border-gray-100">
                    <span class="text-teal-600 font-black">ğŸ‘ ì¶”ì²œ {{ up_count }}</span>
                    <span class="text-gray-500 font-black">ğŸ‘ ë¹„ì¶”ì²œ {{ down_count }}</span>
                    {% if current_user.is_authenticated %}
                    <form action="/board/delivery-request/{{ p.id }}/vote" method="POST" class="inline"><input type="hidden" name="vote_type" value="up"><button type="submit" class="px-4 py-2 rounded-xl text-xs font-black transition {% if user_vote == 'up' %}bg-teal-600 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-teal-100 hover:text-teal-700{% endif %}">ì¶”ì²œ</button></form>
                    <form action="/board/delivery-request/{{ p.id }}/vote" method="POST" class="inline"><input type="hidden" name="vote_type" value="down"><button type="submit" class="px-4 py-2 rounded-xl text-xs font-black transition {% if user_vote == 'down' %}bg-gray-700 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">ë¹„ì¶”ì²œ</button></form>
                    {% if user_vote %}<span class="text-[10px] text-gray-400">(ê²Œì‹œê¸€ë‹¹ ì¶”ì²œ/ë¹„ì¶”ì²œ ì¤‘ í•˜ë‚˜ë§Œ ì„ íƒ ê°€ëŠ¥)</span>{% endif %}
                    {% else %}
                    <span class="text-gray-400 text-sm">ë¡œê·¸ì¸ í›„ ì¶”ì²œÂ·ë¹„ì¶”ì²œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
                    {% endif %}
                </div>
                {% if p.admin_notes %}
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <p class="text-[10px] text-teal-600 font-black uppercase mb-1">ê´€ë¦¬ì ëŒ“ê¸€</p>
                    <p class="text-gray-700 text-sm whitespace-pre-wrap">{{ p.admin_notes }}</p>
                </div>
                {% endif %}
                {% if show_notice %}
                <div class="mt-6 p-4 bg-amber-50 border border-amber-200 rounded-xl text-amber-800 text-sm font-bold">
                    âœ“ ì¶”ì²œì´ ë§ì•„ ë°°ì†¡êµ¬ì—­ í™•ì¥ ê²€í†  ëŒ€ìƒì…ë‹ˆë‹¤. ì ìš© ì‹œ ë°°ì†¡êµ¬ì—­ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
                {% endif %}
            </div>
        </div>
        """ + FOOTER_HTML,
        p=p, up_count=up_count, down_count=down_count, user_vote=user_vote, show_notice=show_notice
    )


@app.route('/board/delivery-request/<int:did>/vote', methods=['POST'])
@login_required
def board_delivery_request_vote(did):
    """ì¶”ì²œ(up) ë˜ëŠ” ë¹„ì¶”ì²œ(down). ê²Œì‹œê¸€ë‹¹ 1ì¸ 1í‘œ."""
    post = DeliveryRequest.query.filter_by(id=did, is_hidden=False).first_or_404()
    vote_type = (request.form.get('vote_type') or '').strip().lower()
    if vote_type not in ('up', 'down'):
        flash("ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤.")
        return redirect(url_for('board_delivery_request_detail', did=did))
    v = DeliveryRequestVote.query.filter_by(delivery_request_id=did, user_id=current_user.id).first()
    if v:
        v.vote_type = vote_type
    else:
        db.session.add(DeliveryRequestVote(delivery_request_id=did, user_id=current_user.id, vote_type=vote_type))
    db.session.commit()
    flash("ì¶”ì²œë˜ì—ˆìŠµë‹ˆë‹¤." if vote_type == 'up' else "ë¹„ì¶”ì²œë˜ì—ˆìŠµë‹ˆë‹¤.")
    return redirect(url_for('board_delivery_request_detail', did=did))


@app.route('/board/partnership', methods=['GET', 'POST'])
def board_partnership():
    """ì œíœ´ë¬¸ì˜ ëª©ë¡ ë° ì‘ì„± (ë¹„ë°€ê¸€)"""
    if request.method == 'POST':
        partnership_type = (request.form.get('partnership_type') or '').strip()
        content = (request.form.get('content') or '').strip()
        is_secret = request.form.get('is_secret') in ('1', 'on', 'yes')
        user_id = current_user.id if current_user.is_authenticated else None
        user_name = current_user.name if current_user.is_authenticated else (request.form.get('writer_name') or 'ë¹„íšŒì›')[:50]
        r = PartnershipInquiry(
            user_id=user_id,
            user_name=user_name,
            partnership_type=partnership_type or None,
            content=content or None,
            is_secret=is_secret
        )
        db.session.add(r)
        db.session.commit()
        flash("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.")
        return redirect(url_for('board_partnership'))
    all_posts = PartnershipInquiry.query.filter_by(is_hidden=False).order_by(PartnershipInquiry.id.desc()).all()
    if current_user.is_authenticated and current_user.is_admin:
        posts = all_posts
    else:
        posts = [p for p in all_posts if not p.is_secret or (current_user.is_authenticated and p.user_id == current_user.id)]
    return render_template_string(
        HEADER_HTML + """
        <div class="max-w-3xl mx-auto py-8 md:py-12 px-4 font-black text-left">
            <a href="/" class="text-gray-400 hover:text-teal-600 text-sm font-bold mb-6 inline-block">â† í™ˆ</a>
            <h1 class="text-2xl md:text-3xl font-black text-gray-900 mb-2">ì œíœ´ë¬¸ì˜</h1>
            <p class="text-gray-500 text-sm mb-6">ì œíœ´ ì¢…ë¥˜Â·ì•„ì´í…œ ë“±ì„ ì‘ì„±í•´ ì£¼ì„¸ìš”. ë¹„ë°€ê¸€ë¡œ ë“±ë¡ë©ë‹ˆë‹¤.</p>
            <div class="mb-6 p-4 bg-gray-50 rounded-2xl border border-gray-100">
                <form method="POST" action="/board/partnership" class="space-y-4">
                    <div><label class="block text-[10px] text-gray-500 uppercase mb-1">ì œíœ´ ì¢…ë¥˜</label><input type="text" name="partnership_type" placeholder="ì˜ˆ: ë¡œì»¬ë§›ì§‘, ë°°ë‹¬ì—…ì²´" class="w-full px-4 py-3 rounded-xl border border-gray-200 text-sm font-bold"></div>
                    <div><label class="block text-[10px] text-gray-500 uppercase mb-1">ë‚´ìš© (ì•„ì´í…œÂ·ë¬¸ì˜ì‚¬í•­)</label><textarea name="content" rows="4" placeholder="ì œíœ´ í¬ë§ ì•„ì´í…œ, ì—°ë½ì²˜ ë“±" class="w-full px-4 py-3 rounded-xl border border-gray-200 text-sm font-bold"></textarea></div>
                    <label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" name="is_secret" value="1" checked class="rounded"> <span class="text-sm font-bold">ë¹„ë°€ê¸€ë¡œ ë“±ë¡</span></label>
                    <button type="submit" class="px-5 py-3 bg-teal-600 text-white rounded-xl text-sm font-black hover:bg-teal-700 transition">ë“±ë¡</button>
                </form>
            </div>
            <div class="space-y-3">
                {% for p in posts %}
                <a href="/board/partnership/{{ p.id }}" class="block bg-white rounded-2xl border border-gray-100 p-4 shadow-sm hover:shadow-md transition text-left">
                    <p class="font-black text-gray-800">{% if p.is_secret %}ğŸ”’ ë¹„ë°€ê¸€{% else %}ì œíœ´ ë¬¸ì˜{% endif %} Â· {{ p.partnership_type or '-' }}</p>
                    <p class="text-[10px] text-gray-400 mt-1">{{ p.created_at.strftime('%Y.%m.%d') if p.created_at else '' }} Â· {{ p.user_name or 'ë¹„íšŒì›' }}</p>
                </a>
                {% else %}
                <div class="bg-gray-50 rounded-2xl p-12 text-center text-gray-500">ë“±ë¡ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                {% endfor %}
            </div>
        </div>
        """ + FOOTER_HTML,
        posts=posts
    )


@app.route('/board/partnership/<int:pid>')
def board_partnership_detail(pid):
    """ì œíœ´ë¬¸ì˜ ìƒì„¸ (ë¹„ë°€ê¸€ì€ ë³¸ì¸Â·ê´€ë¦¬ìë§Œ)"""
    p = PartnershipInquiry.query.filter_by(id=pid, is_hidden=False).first_or_404()
    can_view = not p.is_secret or (current_user.is_authenticated and (p.user_id == current_user.id or current_user.is_admin))
    if not can_view:
        flash("ë¹„ë°€ê¸€ì€ ì‘ì„±ìë§Œ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
        return redirect(url_for('board_partnership'))
    return render_template_string(
        HEADER_HTML + """
        <div class="max-w-3xl mx-auto py-8 md:py-12 px-4 font-black text-left">
            <a href="/board/partnership" class="text-gray-400 hover:text-teal-600 text-sm font-bold mb-6 inline-block">â† ëª©ë¡</a>
            <div class="bg-white rounded-2xl border border-gray-100 p-6 shadow-sm">
                <p class="text-[10px] text-gray-500 uppercase mb-1">ì œíœ´ ì¢…ë¥˜</p>
                <p class="font-black text-gray-900 mb-4">{{ p.partnership_type or '-' }}</p>
                <p class="text-[10px] text-gray-400 mb-2">{{ p.created_at.strftime('%Y.%m.%d %H:%M') if p.created_at else '' }} Â· {{ p.user_name or 'ë¹„íšŒì›' }}</p>
                <p class="text-[10px] text-gray-500 uppercase mb-1">ë‚´ìš©</p>
                <p class="text-gray-700 text-sm whitespace-pre-wrap">{{ p.content or '' }}</p>
                {% if p.admin_notes %}
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <p class="text-[10px] text-teal-600 font-black uppercase mb-1">ê´€ë¦¬ì ëŒ“ê¸€</p>
                    <p class="text-gray-700 text-sm whitespace-pre-wrap">{{ p.admin_notes }}</p>
                </div>
                {% endif %}
            </div>
        </div>
        """ + FOOTER_HTML,
        p=p
    )


# ---------- ììœ ê²Œì‹œíŒ ----------
@app.route('/board/free', methods=['GET', 'POST'])
def board_free():
    """ììœ ê²Œì‹œíŒ ëª©ë¡ ë° ê¸€ì“°ê¸° (ì•„ì´ë””ì–´Â·ì œì•ˆ ë“± ììœ  ì…ë ¥)"""
    if request.method == 'POST':
        if not current_user.is_authenticated:
            flash("ë¡œê·¸ì¸ í›„ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
            return redirect(url_for('login'))
        title = (request.form.get('title') or '').strip()
        content = (request.form.get('content') or '').strip()
        if not title:
            flash("ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
            return redirect(url_for('board_free'))
        db.session.add(FreeBoard(
            user_id=current_user.id,
            user_name=current_user.name or current_user.email or 'íšŒì›',
            title=title[:200],
            content=content or None
        ))
        db.session.commit()
        flash("ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.")
        return redirect(url_for('board_free'))
    posts = FreeBoard.query.filter_by(is_hidden=False).order_by(FreeBoard.id.desc()).all()
    return render_template_string(
        HEADER_HTML + """
        <div class="max-w-3xl mx-auto px-4 py-12">
            <a href="/" class="text-gray-400 hover:text-teal-600 text-sm font-bold mb-6 inline-block">â† ë©”ì¸</a>
            <h1 class="text-2xl md:text-3xl font-black text-gray-900 mb-2">ììœ ê²Œì‹œíŒ</h1>
            <p class="text-gray-500 text-sm mb-6">ì•„ì´ë””ì–´, ì œì•ˆ, í•˜ê³  ì‹¶ì€ ë§ ë“±ì„ ììœ ë¡­ê²Œ ë‚¨ê²¨ ì£¼ì„¸ìš”.</p>
            <div class="flex flex-col sm:flex-row gap-4 mb-8">
                <form method="POST" action="/board/free" class="bg-white rounded-2xl border border-gray-100 p-6 shadow-sm flex-1">
                    <div class="mb-4"><label class="block text-[10px] text-gray-500 uppercase mb-1">ì œëª© *</label><input type="text" name="title" required maxlength="200" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" class="w-full px-4 py-3 rounded-xl border border-gray-200 text-sm font-bold"></div>
                    <div class="mb-4"><label class="block text-[10px] text-gray-500 uppercase mb-1">ë‚´ìš©</label><textarea name="content" rows="4" placeholder="ì•„ì´ë””ì–´, ì œì•ˆ, í•˜ê³  ì‹¶ì€ ë§ ë“± ììœ ë¡­ê²Œ ì‘ì„±í•´ ì£¼ì„¸ìš”." class="w-full px-4 py-3 rounded-xl border border-gray-200 text-sm font-bold"></textarea></div>
                    <button type="submit" class="w-full py-3 bg-teal-600 text-white rounded-xl text-sm font-black hover:bg-teal-700 transition">ê¸€ì“°ê¸°</button>
                </form>
            </div>
            <div class="space-y-3">
                {% for p in posts %}
                <a href="/board/free/{{ p.id }}" class="block bg-white rounded-2xl border border-gray-100 p-4 shadow-sm hover:shadow-md transition text-left">
                    <p class="font-black text-gray-800">{{ p.title }}</p>
                    <p class="text-[10px] text-gray-400 mt-1">{{ p.created_at.strftime('%Y.%m.%d %H:%M') if p.created_at else '' }} Â· {{ p.user_name or 'ìµëª…' }}</p>
                    {% if p.content %}<p class="text-gray-500 text-sm mt-2 line-clamp-2">{{ p.content[:120] }}{% if p.content|length > 120 %}...{% endif %}</p>{% endif %}
                </a>
                {% else %}
                <p class="text-gray-400 text-sm py-8 text-center">ì•„ì§ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ê¸€ì„ ë‚¨ê²¨ ë³´ì„¸ìš”!</p>
                {% endfor %}
            </div>
        </div>
        """ + FOOTER_HTML,
        posts=posts
    )


@app.route('/board/free/<int:fid>')
def board_free_detail(fid):
    """ììœ ê²Œì‹œíŒ ìƒì„¸"""
    p = FreeBoard.query.filter_by(id=fid, is_hidden=False).first_or_404()
    return render_template_string(
        HEADER_HTML + """
        <div class="max-w-3xl mx-auto px-4 py-12">
            <a href="/board/free" class="text-gray-400 hover:text-teal-600 text-sm font-bold mb-6 inline-block">â† ëª©ë¡</a>
            <div class="bg-white rounded-2xl border border-gray-100 p-6 shadow-sm">
                <h1 class="text-xl md:text-2xl font-black text-gray-900 mb-2">{{ p.title }}</h1>
                <p class="text-[10px] text-gray-400 mb-4">{{ p.created_at.strftime('%Y.%m.%d %H:%M') if p.created_at else '' }} Â· {{ p.user_name or 'ìµëª…' }}</p>
                <div class="text-gray-700 text-sm whitespace-pre-wrap">{{ p.content or '' }}</div>
            </div>
        </div>
        """ + FOOTER_HTML,
        p=p
    )


# [ì¶”ê°€] ë¬´í•œ ìŠ¤í¬ë¡¤ì„ ìœ„í•œ ìƒí’ˆ ë°ì´í„° ì œê³µ API
@app.route('/api/category_products/<string:cat_name>')
def api_category_products(cat_name):
    """ë¬´í•œ ìŠ¤í¬ë¡¤ìš© ë°ì´í„° ì œê³µ API (30ê°œ ë‹¨ìœ„)"""
    page = int(request.args.get('page', 1))
    per_page = 30
    offset = (page - 1) * per_page
    
    query = Product.query.filter_by(is_active=True)
    if cat_name == 'ìµœì‹ ìƒí’ˆ':
        query = query.order_by(Product.id.desc())
    elif cat_name == 'ì˜¤ëŠ˜ë§ˆê°':
        today_end = datetime.now().replace(hour=23, minute=59, second=59)
        query = query.filter(Product.deadline > datetime.now(), Product.deadline <= today_end).order_by(Product.deadline.asc())
    else:
        query = query.filter_by(category=cat_name).order_by(Product.id.desc())
    
    products = query.offset(offset).limit(per_page).all()
    
    res_data = []
    for p in products:
        res_data.append({
            "id": p.id,
            "name": p.name,
            "price": p.price,
            "image_url": p.image_url,
            "description": p.description or "",
            "stock": p.stock,
            "is_sold_out": (p.deadline and p.deadline < datetime.now()) or p.stock <= 0,
            "deadline": p.deadline.strftime('%Y-%m-%dT%H:%M:%S') if p.deadline else ""
        })
    return jsonify(res_data)
@app.route('/category/<string:cat_name>')
def category_view(cat_name):
    """ì¹´í…Œê³ ë¦¬ë³„ ìƒí’ˆ ëª©ë¡ ë·° (ë¬´í•œ ìŠ¤í¬ë¡¤, 30ê°œ ë‹¨ìœ„, ìŠ¤í¬ë¡¤ ì‹œ 1ì´ˆ ëŒ€ê¸° í›„ ì¶”ê°€ ë¡œë”©)"""
    _record_page_view('category')
    order_logic = (Product.stock <= 0) | (Product.deadline < datetime.now())
    cat = None
    limit_num = 30
    
    if cat_name == 'ìµœì‹ ìƒí’ˆ':
        products = Product.query.filter_by(is_active=True).order_by(Product.id.desc()).limit(limit_num).all()
        display_name = "âœ¨ ìµœì‹  ìƒí’ˆ"
    elif cat_name == 'ì˜¤ëŠ˜ë§ˆê°':
        today_end = datetime.now().replace(hour=23, minute=59, second=59)
        products = Product.query.filter(Product.is_active == True, Product.deadline > datetime.now(), Product.deadline <= today_end).order_by(Product.deadline.asc()).limit(limit_num).all()
        display_name = "ğŸ”¥ ì˜¤ëŠ˜ ë§ˆê° ì„ë°•!"
    else:
        cat = Category.query.filter_by(name=cat_name).first_or_404()
        user_grade = (getattr(current_user, 'member_grade', 1) or 1) if current_user.is_authenticated else 1
        if getattr(cat, 'min_member_grade', None) is not None and user_grade < cat.min_member_grade:
            abort(404)
        products = Product.query.filter_by(category=cat_name, is_active=True).order_by(order_logic, Product.id.desc()).limit(limit_num).all()
        display_name = f"{cat_name} ìƒí’ˆ ë¦¬ìŠ¤íŠ¸"

    # í•˜ë‹¨ ì¶”ì²œ ì„¹ì…˜ ë°ì´í„° (ë“±ê¸‰ë³„ ì¹´í…Œê³ ë¦¬)
    grade = (getattr(current_user, 'member_grade', 1) or 1) if current_user.is_authenticated else 1
    latest_all = Product.query.filter(Product.is_active == True, Product.category != cat_name).order_by(Product.id.desc()).limit(10).all()
    recommend_cats = categories_for_member_grade(grade).filter(Category.name != cat_name).limit(3).all()
    cat_previews = {c: Product.query.filter_by(category=c.name, is_active=True).limit(4).all() for c in recommend_cats}

    content = """
    <div class="max-w-7xl mx-auto px-4 md:px-6 py-20 text-left">
        <div class="mb-16 text-left">
            <h2 class="text-3xl md:text-5xl text-gray-800 font-black text-left">{{ display_name }}</h2>
            {% if cat and cat.description %}<p class="text-gray-400 font-bold mt-4 text-base md:text-xl text-left">{{ cat.description }}</p>{% endif %}
        </div>
        
        <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 md:gap-10 text-left mb-12">
            {% for p in products %}
            <div class="product-card bg-white rounded-3xl md:rounded-[3rem] shadow-sm border border-gray-100 overflow-hidden relative flex flex-col transition-all hover:shadow-2xl {% if p.stock <= 0 %}sold-out{% endif %}">
                
                {% if p.description %}
                <div class="absolute top-4 left-0 z-20">
                    <span class="px-3 py-1.5 text-[9px] md:text-[11px] font-black text-white shadow-md rounded-r-full 
                        {% if 'ë‹¹ì¼' in p.description %} bg-red-600 
                        {% elif '+1' in p.description %} bg-blue-600 
                        {% elif '+2' in p.description %} bg-emerald-600 
                        {% else %} bg-gray-600 {% endif %}">
                        <i class="fas fa-truck-fast mr-1"></i> {{ p.description }}
                    </span>
                </div>
                {% endif %}

                <a href="/product/{{p.id}}" class="relative aspect-square block bg-white overflow-hidden">
                    <img src="{{ p.image_url }}" loading="lazy" class="w-full h-full object-cover p-4 md:p-8">
                </a>
                <div class="p-5 md:p-10 flex flex-col flex-1 text-left">
                    <a href="/product/{{p.id}}">
                        <h3 class="font-black text-gray-800 text-sm md:text-lg truncate mb-2 text-left">{{ p.name }}</h3>
                    </a>
                    
                    <p class="text-[10px] md:text-xs text-gray-400 font-bold mb-3">{{ p.spec or 'ì¼ë°˜' }}</p>

                    <div class="mt-auto flex justify-between items-center text-left">
                        <span class="text-base md:text-2xl font-black text-teal-600 text-left">{{ "{:,}".format(p.price) }}ì›</span>
                        <button onclick="addToCart('{{p.id}}')" class="bg-teal-600 w-8 h-8 md:w-12 md:h-12 rounded-full text-white shadow-lg flex items-center justify-center transition active:scale-90 text-center">
                            <i class="fas fa-plus text-[10px] md:text-base"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div id="load-more-trigger" class="w-full min-h-[100px] flex flex-col items-center justify-center py-10">
            <div id="spinner" class="w-10 h-10 border-4 border-teal-100 border-t-teal-600 rounded-full animate-spin hidden"></div>
            <div id="end-message" class="hidden text-gray-300 font-black text-lg py-4 w-full text-center">ë§ˆì§€ë§‰ ìƒí’ˆì…ë‹ˆë‹¤. ğŸ˜Š</div>
        </div>

        <hr class="border-gray-100 mb-24">

        <div class="grid grid-cols-1 md:grid-cols-3 gap-10 text-left mb-24">
            {% for c_info, c_prods in cat_previews.items() %}
            <div class="bg-gray-50 p-6 md:p-8 rounded-[3rem] border border-gray-100 shadow-inner text-left">
                <h3 class="text-xl font-black mb-6 flex justify-between items-center text-left">
                    {{ c_info.name }}
                    <a href="/category/{{ c_info.name }}" class="text-xs text-gray-400 font-bold hover:text-teal-600">ì „ì²´ë³´ê¸° ></a>
                </h3>
                <div class="grid grid-cols-2 gap-4">
                    {% for cp in c_prods %}
                    <div class="bg-white p-3 rounded-2xl shadow-sm relative flex flex-col">
                        {% if cp.description %}
                        <div class="absolute top-2 left-0 z-20">
                            <span class="px-2 py-1 text-[7px] md:text-[9px] font-black text-white shadow-sm rounded-r-full 
                                {% if 'ë‹¹ì¼' in cp.description %} bg-red-600 
                                {% elif '+1' in cp.description %} bg-blue-600 
                                {% elif '+2' in cp.description %} bg-emerald-600 
                                {% else %} bg-gray-600 {% endif %}">
                                {{ cp.description }}
                            </span>
                        </div>
                        {% endif %}

                        <a href="/product/{{ cp.id }}" class="block mb-2">
                            <img src="{{ cp.image_url }}" class="w-full aspect-square object-contain rounded-xl p-1">
                        </a>
                        <div class="px-1">
                            <p class="text-[10px] md:text-xs font-black text-gray-800 truncate">{{ cp.name }}</p>
                            <p class="text-[8px] md:text-[10px] text-gray-400 font-bold mb-1">{{ cp.spec or 'ì¼ë°˜' }}</p>
                            <p class="text-xs md:text-sm font-black text-teal-600">{{ "{:,}".format(cp.price) }}ì›</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="flex justify-center mt-24">
            <a href="/" class="bg-gray-800 text-white px-12 py-5 rounded-full font-black shadow-xl hover:bg-black transition active:scale-95 text-center">
                <i class="fas fa-home mr-2"></i> ë©”ì¸í™”ë©´ìœ¼ë¡œ ì´ë™í•˜ê¸°
            </a>
        </div>
    </div>

    <script>
    let page = 1;
    let loading = false;
    let hasMore = true;
    const catName = "{{ cat_name }}";

    async function loadMore() {
        if (loading || !hasMore) return;
        loading = true;
        document.getElementById('spinner').classList.remove('hidden');

        page++;
        try {
            const res = await fetch(`/api/category_products/${encodeURIComponent(catName)}?page=${page}&per_page=30`);
            const data = await res.json();

            if (!data || data.length === 0) {
                hasMore = false;
                document.getElementById('end-message').classList.remove('hidden');
                document.getElementById('spinner').classList.add('hidden');
                return;
            }

            const grid = document.getElementById('product-grid');
            data.forEach(p => {
                const soldOutClass = p.is_sold_out ? 'sold-out' : '';
                
                // âœ… ë°°ì†¡ ì¼ì • ë°°ì§€ ìƒ‰ìƒ ê²°ì • ë¡œì§ (JS)
                let badgeColor = 'bg-gray-600';
                if (p.description.includes('ë‹¹ì¼')) badgeColor = 'bg-red-600';
                else if (p.description.includes('+1')) badgeColor = 'bg-blue-600';
                else if (p.description.includes('+2')) badgeColor = 'bg-emerald-600';

                // âœ… ë°°ì†¡ ì¼ì • HTML
                const deliveryBadge = p.description ? `
                    <div class="absolute top-4 left-0 z-20">
                        <span class="px-3 py-1.5 text-[9px] md:text-[11px] font-black text-white shadow-md rounded-r-full ${badgeColor}">
                            <i class="fas fa-truck-fast mr-1"></i> ${p.description}
                        </span>
                    </div>` : '';

                const html = `
                    <div class="product-card bg-white rounded-3xl md:rounded-[3rem] shadow-sm border border-gray-100 overflow-hidden relative flex flex-col transition-all hover:shadow-2xl ${soldOutClass}">
                        ${deliveryBadge}
                        <a href="/product/${p.id}" class="relative aspect-square block bg-white overflow-hidden">
                            <img src="${p.image_url}" loading="lazy" class="w-full h-full object-cover p-4 md:p-10">
                        </a>
                        <div class="p-5 md:p-10 flex flex-col flex-1 text-left">
                            <a href="/product/${p.id}">
                                <h3 class="font-black text-gray-800 text-sm md:text-lg truncate mb-2 text-left">${p.name}</h3>
                            </a>
                            <div class="mt-auto flex justify-between items-center text-left">
                                <span class="text-base md:text-2xl font-black text-teal-600 text-left">${p.price.toLocaleString()}ì›</span>
                                <button onclick="addToCart('${p.id}')" class="bg-teal-600 w-8 h-8 md:w-12 md:h-12 rounded-full text-white shadow-lg flex items-center justify-center transition active:scale-90">
                                    <i class="fas fa-plus text-[10px] md:text-base"></i>
                                </button>
                            </div>
                        </div>
                    </div>`;
                grid.insertAdjacentHTML('beforeend', html);
            });

            if (data.length < 30) {
                hasMore = false;
                document.getElementById('end-message').classList.remove('hidden');
            }
        } catch (e) { console.error("Infinity Scroll Error:", e); }
        finally {
            loading = false;
            if (hasMore) document.getElementById('spinner').classList.add('hidden');
        }
    }

    let scrollDebounceTimer = null;
    const observer = new IntersectionObserver((entries) => {
        if (!entries[0].isIntersecting) return;
        if (scrollDebounceTimer) clearTimeout(scrollDebounceTimer);
        scrollDebounceTimer = setTimeout(() => { loadMore(); scrollDebounceTimer = null; }, 1000);
    }, { threshold: 0.1, rootMargin: '300px' });

    observer.observe(document.getElementById('load-more-trigger'));
    </script>
    """
    return render_template_string(HEADER_HTML + content + FOOTER_HTML, **locals())

@app.route('/api/product_reviews')
def api_product_reviews():
    """ìƒí’ˆ ìƒì„¸ êµ¬ë§¤í›„ê¸° ë”ë³´ê¸°ìš© API (í˜ì´ì§€ë‹¹ 5ê°œ)"""
    category_id = request.args.get('category_id', type=int)
    product_id = request.args.get('product_id', type=int)
    page = max(1, int(request.args.get('page', 1)))
    per_page = 5
    offset = (page - 1) * per_page
    if category_id is not None:
        q = Review.query.filter_by(category_id=category_id).order_by(Review.created_at.desc())
    elif product_id is not None:
        q = Review.query.filter_by(product_id=product_id).order_by(Review.created_at.desc())
    else:
        return jsonify([])
    reviews = q.offset(offset).limit(per_page).all()
    return jsonify([{
        "id": r.id,
        "image_url": r.image_url or "",
        "user_name": (r.user_name or "")[:1] + "**",
        "created_at": r.created_at.strftime("%Y.%m.%d") if r.created_at else "",
        "content": r.content or "",
    } for r in reviews])


@app.route('/product/<int:pid>')
def product_detail(pid):
    """ìƒí’ˆ ìƒì„¸ ì •ë³´ í˜ì´ì§€ (ìµœê·¼ë“±ë¡ìƒí’ˆ ë³µêµ¬ ë° ì¶”ì²œ ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ì™„ë£Œë³¸)"""
    p = Product.query.get_or_404(pid)
    try:
        p.view_count = (getattr(p, 'view_count', 0) or 0) + 1
        db.session.commit()
    except Exception:
        db.session.rollback()
    _record_page_view('product')
    is_expired = (p.deadline and p.deadline < datetime.now())
    detail_images = p.detail_image_url.split(',') if p.detail_image_url else []
    cat_info = Category.query.filter_by(name=p.category).first()
    
    # 1. ì—°ê´€ ì¶”ì²œ ìƒí’ˆ: í‚¤ì›Œë“œ(ìƒí’ˆëª… ì²« ë‹¨ì–´) ê¸°ë°˜
    keyword = p.name.split()[0] if p.name else ""
    keyword_recommends = Product.query.filter(
        Product.name.contains(keyword),
        Product.id != pid,
        Product.is_active == True,
        Product.stock > 0
    ).limit(10).all()

    # 2. ìµœê·¼ ë“±ë¡ ìƒí’ˆ 10ê°œ (ì´ ë°ì´í„°ê°€ ì •ìƒì ìœ¼ë¡œ ì „ë‹¬ë˜ì–´ì•¼ í•©ë‹ˆë‹¤)
    latest_all = Product.query.filter(Product.is_active == True, Product.id != pid).order_by(Product.id.desc()).limit(10).all()
    
    # 3. í•˜ë‹¨ ë…¸ì¶œìš© ì¶”ì²œ ì¹´í…Œê³ ë¦¬ 3ê°œ ë° ë¯¸ë¦¬ë³´ê¸° ìƒí’ˆ
    recommend_cats_detail = Category.query.filter(Category.name != p.category).order_by(Category.order.asc()).limit(3).all()
    cat_previews_detail = {c: Product.query.filter_by(category=c.name, is_active=True).limit(4).all() for c in recommend_cats_detail}
    
    # 4. ë¦¬ë·°: í•´ë‹¹ ìƒí’ˆì˜ íŒë§¤ì(ì¹´í…Œê³ ë¦¬)ë³„ë¡œ ë¬¶ì–´ì„œ ë…¸ì¶œ, 5ê°œë§Œ ì´ˆê¸° ë¡œë”©Â·ë”ë³´ê¸° 5ê°œì”©
    if cat_info:
        review_base = Review.query.filter_by(category_id=cat_info.id).order_by(Review.created_at.desc())
    else:
        review_base = Review.query.filter_by(product_id=pid).order_by(Review.created_at.desc())
    reviews_total_count = review_base.count()
    product_reviews = review_base.limit(5).all()
    reviews_has_more = reviews_total_count > 5

    content = """
    <div class="max-w-5xl mx-auto px-0 md:px-6 pb-16 font-black text-left">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-0 md:gap-16 items-start">
            <div class="relative w-full aspect-square bg-white overflow-hidden md:rounded-[3rem] md:shadow-xl border-b md:border border-gray-100">
                {% if p.description %}
                <div class="absolute top-6 left-0 z-20">
                    <span class="px-5 py-2 text-xs md:text-sm font-black text-white shadow-xl rounded-r-full 
                        {% if 'ë‹¹ì¼' in p.description %} bg-red-600 
                        {% elif '+1' in p.description %} bg-blue-600 
                        {% elif '+2' in p.description %} bg-emerald-600 
                        {% else %} bg-gray-600 {% endif %}">
                        <i class="fas fa-truck-fast mr-2"></i> {{ p.description }}
                    </span>
                </div>
                {% endif %}

                <img src="{{ p.image_url }}" class="w-full h-full object-contain p-6 md:p-12" loading="lazy">
                
                {% if is_expired or p.stock <= 0 %}
                <div class="absolute inset-0 bg-black/50 flex items-center justify-center backdrop-blur-[2px]">
                    <span class="text-white font-black text-2xl border-4 border-white px-8 py-3 rounded-2xl rotate-[-5deg]">íŒë§¤ë§ˆê°</span>
                </div>
                {% endif %}
            </div>

            <div class="p-6 md:p-0 flex flex-col justify-start">
                <nav class="flex items-center gap-2 text-[10px] md:text-xs text-gray-400 mb-6 uppercase tracking-[0.2em] font-bold">
                    <a href="/" class="hover:text-teal-600">Home</a>
                    <i class="fas fa-chevron-right text-[8px]"></i>
                    <a href="/category/{{ p.category }}" class="hover:text-teal-600 text-teal-600">{{ p.category }}</a>
                </nav>

                <h2 class="text-3xl md:text-5xl text-gray-900 mb-4 leading-tight tracking-tighter break-keep">
                    {{ p.name }}
                    {% if p.badge %}
                    <span class="block mt-2 text-orange-500 text-sm md:text-lg font-black italic tracking-normal">
                        # {{ p.badge }}
                    </span>
                    {% endif %}
                </h2>

                <div class="flex items-baseline gap-2 mb-10">
                    <span class="text-4xl md:text-6xl text-teal-600 font-black italic tracking-tighter">{{ "{:,}".format(p.price) }}</span>
                    <span class="text-xl text-gray-400 font-bold">ì›</span>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-10">
                    <div class="bg-gray-50 p-5 rounded-2xl border border-gray-100 shadow-sm">
                        <p class="text-[9px] text-gray-400 uppercase mb-1 font-black">Standard</p>
                        <p class="text-sm md:text-base font-black text-gray-700">{{ p.spec or 'ê¸°ë³¸ê·œê²©' }}</p>
                    </div>
                    <div class="bg-gray-50 p-5 rounded-2xl border border-gray-100 shadow-sm">
                        <p class="text-[9px] text-gray-400 uppercase mb-1 font-black">Stock Status</p>
                        <p class="text-sm md:text-base font-black text-gray-700">{{ p.stock }}ê°œ ë‚¨ìŒ</p>
                    </div>
                    <div class="bg-blue-50 p-5 rounded-2xl border border-blue-100 col-span-2 shadow-sm">
                        <p class="text-[9px] text-blue-400 uppercase mb-1 font-black">Direct Delivery (ì†¡ë„ì „ìš©)</p>
                        <p class="text-sm md:text-base font-black text-blue-700">
                            <i class="fas fa-truck-fast mr-2"></i>ë°”êµ¬ë‹ˆì‚¼ì´Œ {{ p.description }} ë‚´ ì§ì ‘ ë°°ì†¡
                        </p>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-2xl mb-6 border border-gray-100">
                    <p class="text-[11px] text-gray-500 leading-relaxed font-bold">
                        <i class="fas fa-info-circle mr-1"></i> ë°”êµ¬ë‹ˆì‚¼ì´Œì€ êµ¬ë§¤ëŒ€í–‰í˜• ì„œë¹„ìŠ¤ë¡œì„œ ë³¸ ìƒí’ˆì˜ ì‹¤ì œ íŒë§¤ì²˜ì™€ ê³ ê°ì„ ì—°ê²°í•˜ê³  ê²°ì œ ë° ë°°ì†¡ ì „ë°˜ì„ ì±…ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.
                    </p>
                </div>
                {% if p.stock > 0 and not is_expired %}
                <button onclick="addToCart('{{p.id}}')" class="w-full bg-teal-600 text-white py-5 md:py-7 rounded-[2rem] font-black text-xl md:text-2xl shadow-2xl hover:bg-teal-700 transition active:scale-95 flex items-center justify-center gap-2">
                    <i class="fas fa-shopping-basket"></i> ë¬¼ê±´ ë‹´ê¸°
                </button>
                {% else %}
                <button class="w-full bg-gray-200 text-gray-400 py-5 md:py-7 rounded-[2rem] font-black text-xl md:text-2xl cursor-not-allowed italic" disabled>íŒë§¤ê°€ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤</button>
                {% endif %}
            </div>
        </div>

        <div class="mt-20 md:mt-32">
            <div class="sticky top-16 md:top-20 bg-white/90 backdrop-blur-md z-30 border-y border-gray-100 flex justify-around mb-12 shadow-sm">
                <a href="#details" class="py-5 px-4 text-sm font-black text-gray-800 border-b-4 border-teal-600 transition-all">ìƒì„¸ì •ë³´</a>
                <a href="#reviews" class="py-5 px-4 text-sm font-black text-gray-400 hover:text-orange-500 transition-all">êµ¬ë§¤í›„ê¸° ({{ reviews_total_count }})</a>
                <a href="#related" class="py-5 px-4 text-sm font-black text-gray-400 hover:text-blue-500 transition-all">ì¶”ì²œìƒí’ˆ</a>
            </div>

            <div id="details" class="space-y-12 px-4 md:px-0">
                <div class="bg-teal-50/50 p-10 md:p-20 rounded-[2.5rem] md:rounded-[4.5rem] text-center border-none shadow-inner">
                    <i class="fas fa-quote-left text-teal-200 text-4xl mb-6"></i>
                    <p class="text-xl md:text-3xl font-black text-gray-800 leading-relaxed break-keep">
                        {{ p.origin or 'ë°”êµ¬ë‹ˆì‚¼ì´Œì´ ê¼¼ê¼¼í•˜ê²Œ ê²€ìˆ˜í•˜ì—¬\\nì†¡ë„ ì´ì›ƒì—ê²Œ ë³´ë‚´ë“œë¦¬ëŠ” ë¯¿ì„ ìˆ˜ ìˆëŠ” ìƒí’ˆì…ë‹ˆë‹¤.' }}
                    </p>
                    <i class="fas fa-quote-right text-teal-200 text-4xl mt-6"></i>
                </div>
                <div class="flex flex-col gap-0 max-w-4xl mx-auto">
                    {% if detail_images %}
                        {% for img in detail_images %}
                        <img src="{{ img.strip() }}" class="w-full shadow-sm" loading="lazy" onerror="this.style.display='none'">
                        {% endfor %}
                    {% else %}
                        <img src="{{ p.image_url }}" class="w-full rounded-3xl opacity-60 grayscale p-10">
                    {% endif %}
                </div>
            </div>
        </div>

        <div id="reviews" class="mt-40 px-4 md:px-0">
            <h3 class="text-2xl md:text-4xl font-black text-gray-900 mb-12 flex items-center gap-4 tracking-tighter">
                <span class="w-2 h-10 bg-orange-400 rounded-full"></span> ğŸ“¸ ìƒìƒí•œ êµ¬ë§¤ í›„ê¸°
            </h3>
            {% if product_reviews %}
            <div id="reviews-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for r in product_reviews %}
                <div class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col sm:flex-row gap-4 hover:shadow-md transition-all">
                    {% if r.image_url %}<div class="w-20 h-20 sm:w-24 sm:h-24 flex-shrink-0 rounded-xl overflow-hidden border border-gray-100 bg-gray-50"><img src="{{ r.image_url }}" class="w-full h-full object-cover" loading="lazy" alt=""></div>{% else %}<div class="w-20 h-20 sm:w-24 sm:h-24 rounded-xl bg-gray-100 flex items-center justify-center text-gray-400 text-[10px] font-bold flex-shrink-0 border border-gray-100">ì‚¬ì§„ ì—†ìŒ</div>{% endif %}
                    <div class="flex-1 text-left min-w-0">
                        <div class="flex items-center justify-between mb-1.5 gap-2">
                            <span class="text-[10px] font-black text-gray-800 truncate">{{ r.user_name[:1] }}**ë‹˜</span>
                            <span class="text-[9px] text-gray-300 font-bold shrink-0">{{ r.created_at.strftime('%Y.%m.%d') if r.created_at else '' }}</span>
                        </div>
                        <p class="text-[11px] font-bold text-gray-600 leading-relaxed line-clamp-4">{{ r.content }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div id="reviews-load-more-wrap" class="mt-10 text-center {% if not reviews_has_more %}hidden{% endif %}">
                <button type="button" id="reviews-load-more-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-black py-4 px-10 rounded-2xl shadow-lg transition">
                    ë”ë³´ê¸° ({{ reviews_total_count - 5 }}ê°œ ë”)
                </button>
            </div>
            <div id="reviews-end-msg" class="hidden mt-8 text-center text-gray-400 text-sm font-bold">ë§ˆì§€ë§‰ í›„ê¸°ì…ë‹ˆë‹¤.</div>
            {% if reviews_has_more %}
            <script>
            (function(){
                var reviewsTotal = {{ reviews_total_count }};
                var reviewsLoaded = 5;
                var reviewPage = 2;
                var categoryId = {{ cat_info.id if cat_info else 'null' }};
                var productId = {{ p.id }};
                var btn = document.getElementById('reviews-load-more-btn');
                var wrap = document.getElementById('reviews-load-more-wrap');
                var endMsg = document.getElementById('reviews-end-msg');
                var grid = document.getElementById('reviews-grid');
                function updateBtnText(){ var left = reviewsTotal - reviewsLoaded; btn.textContent = left > 0 ? 'ë”ë³´ê¸° (' + left + 'ê°œ ë”)' : 'ë”ë³´ê¸°'; }
                btn.addEventListener('click', function(){
                    if (btn.disabled) return;
                    btn.disabled = true;
                    var url = '/api/product_reviews?page=' + reviewPage + '&per_page=5';
                    if (categoryId != null) url += '&category_id=' + categoryId; else url += '&product_id=' + productId;
                    fetch(url).then(function(r){ return r.json(); }).then(function(data){
                        data.forEach(function(r){
                            var imgPart = r.image_url ? '<div class="w-20 h-20 sm:w-24 sm:h-24 flex-shrink-0 rounded-xl overflow-hidden border border-gray-100 bg-gray-50"><img src="' + r.image_url.replace(/"/g,'&quot;') + '" class="w-full h-full object-cover" loading="lazy" alt=""></div>' : '<div class="w-20 h-20 sm:w-24 sm:h-24 rounded-xl bg-gray-100 flex items-center justify-center text-gray-400 text-[10px] font-bold flex-shrink-0 border border-gray-100">ì‚¬ì§„ ì—†ìŒ</div>';
                            var el = document.createElement('div');
                            el.className = 'bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col sm:flex-row gap-4 hover:shadow-md transition-all';
                            el.innerHTML = imgPart + '<div class="flex-1 text-left min-w-0"><div class="flex items-center justify-between mb-1.5 gap-2"><span class="text-[10px] font-black text-gray-800 truncate">' + (r.user_name || '') + 'ë‹˜</span><span class="text-[9px] text-gray-300 font-bold shrink-0">' + (r.created_at || '') + '</span></div><p class="text-[11px] font-bold text-gray-600 leading-relaxed line-clamp-4">' + (r.content || '').replace(/</g,'&lt;').replace(/>/g,'&gt;') + '</p></div>';
                            grid.appendChild(el);
                        });
                        reviewsLoaded += data.length;
                        reviewPage++;
                        updateBtnText();
                        if (reviewsLoaded >= reviewsTotal || data.length < 5){ wrap.classList.add('hidden'); endMsg.classList.remove('hidden'); }
                        else { btn.disabled = false; }
                    }).catch(function(){ btn.disabled = false; });
                });
            })();
            </script>
            {% endif %}
            {% else %}
            <div class="py-24 text-center bg-gray-50 rounded-[3rem] border-2 border-dashed border-gray-200">
                <p class="text-gray-300 font-black text-lg">ì•„ì§ ë“±ë¡ëœ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« í›„ê¸°ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”! ğŸ˜Š</p>
            </div>
            {% endif %}
        </div>

        <div id="related" class="mt-40">
            {% if keyword_recommends %}
            <div class="border-t border-gray-100 pt-24">
                <h3 class="font-black text-2xl md:text-4xl mb-12 flex items-center gap-4 tracking-tighter px-4 md:px-0">
                    <span class="w-2 h-10 bg-teal-500 rounded-full"></span> â­ ì—°ê´€ ì¶”ì²œ ìƒí’ˆ
                </h3>
                <div class="horizontal-scroll no-scrollbar px-4 md:px-0">
                    {% for rp in keyword_recommends %}
                    <a href="/product/{{rp.id}}" class="group flex-shrink-0 w-44 md:w-64 relative">
                        {% if rp.description %}
                        <div class="absolute top-2 left-0 z-20">
                            <span class="px-2 py-1 text-[7px] md:text-[10px] font-black text-white shadow-sm rounded-r-full 
                                {% if 'ë‹¹ì¼' in rp.description %} bg-red-600 {% elif '+1' in rp.description %} bg-blue-600 {% elif '+2' in rp.description %} bg-emerald-600 {% else %} bg-gray-600 {% endif %}">
                                {{ rp.description }}
                            </span>
                        </div>
                        {% endif %}
                        <div class="bg-white rounded-[2rem] border border-gray-100 p-4 shadow-sm transition hover:shadow-2xl hover:-translate-y-2 text-left h-full flex flex-col">
                            <img src="{{ rp.image_url }}" class="w-full aspect-square object-contain mb-4 rounded-2xl bg-gray-50 p-2">
                            <p class="text-xs md:text-sm font-black text-gray-800 truncate mb-1">{{ rp.name }}</p>
                            <p class="text-[9px] md:text-[11px] text-gray-400 font-bold mb-3">{{ rp.spec or 'ì¼ë°˜' }}</p>
                            <p class="text-sm md:text-lg font-black text-teal-600 mt-auto">{{ "{:,}".format(rp.price) }}ì›</p>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        {% if latest_all %}
        <div class="mt-20">
            <h3 class="font-black text-2xl md:text-4xl mb-12 flex items-center gap-4 tracking-tighter px-4 md:px-0">
                <span class="w-2 h-10 bg-blue-500 rounded-full"></span> âœ¨ ìµœê·¼ ë“±ë¡ ìƒí’ˆ
            </h3>
            <div class="horizontal-scroll no-scrollbar px-4 md:px-0">
                {% for rp in latest_all %}
                <a href="/product/{{rp.id}}" class="group flex-shrink-0 w-44 md:w-64 relative">
                    {% if rp.description %}
                    <div class="absolute top-2 left-0 z-20">
                        <span class="px-2 py-1 text-[7px] md:text-[10px] font-black text-white shadow-sm rounded-r-full 
                            {% if 'ë‹¹ì¼' in rp.description %} bg-red-600 {% elif '+1' in rp.description %} bg-blue-600 {% elif '+2' in rp.description %} bg-emerald-600 {% else %} bg-gray-600 {% endif %}">
                            {{ rp.description }}
                        </span>
                    </div>
                    {% endif %}
                    <div class="bg-white rounded-[2rem] border border-gray-100 p-4 shadow-sm transition hover:shadow-2xl hover:-translate-y-2 text-left h-full flex flex-col">
                        <img src="{{ rp.image_url }}" class="w-full aspect-square object-contain mb-4 rounded-2xl bg-gray-50 p-2">
                        <p class="text-xs md:text-sm font-black text-gray-800 truncate mb-1">{{ rp.name }}</p>
                        <p class="text-[9px] md:text-[11px] text-gray-400 font-bold mb-3">{{ rp.spec or 'ì¼ë°˜' }}</p>
                        <p class="text-sm md:text-lg font-black text-teal-600 mt-auto">{{ "{:,}".format(rp.price) }}ì›</p>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="mt-40 border-t border-gray-100 pt-24 px-4 md:px-0">
            <h3 class="font-black text-2xl md:text-4xl mb-12 flex items-center gap-4 tracking-tighter text-left">
                <span class="w-2 h-10 bg-teal-600 rounded-full"></span> ğŸ“¦ ì¹´í…Œê³ ë¦¬ ë” ë‘˜ëŸ¬ë³´ê¸°
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
                {% for c_info in recommend_cats_detail %}
                <div class="bg-gray-50 p-6 md:p-8 rounded-[3rem] border border-gray-100 shadow-inner text-left">
                    <h3 class="text-lg md:text-xl font-black mb-6 flex justify-between items-center">
                        {{ c_info.name }}
                        <a href="/category/{{ c_info.name }}" class="text-xs text-gray-400 font-bold hover:text-teal-600">ì „ì²´ë³´ê¸° ></a>
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        {% for cp in cat_previews_detail[c_info] %}
                        <div class="bg-white p-3 rounded-2xl shadow-sm relative flex flex-col">
                            {% if cp.description %}
                            <div class="absolute top-2 left-0 z-20">
                                <span class="px-2 py-1 text-[7px] font-black text-white shadow-sm rounded-r-full 
                                    {% if 'ë‹¹ì¼' in cp.description %} bg-red-600 {% elif '+1' in cp.description %} bg-blue-600 {% elif '+2' in cp.description %} bg-emerald-600 {% else %} bg-gray-600 {% endif %}">
                                    {{ cp.description }}
                                </span>
                            </div>
                            {% endif %}
                            <a href="/product/{{ cp.id }}" class="block mb-2">
                                <img src="{{ cp.image_url }}" class="w-full aspect-square object-contain rounded-xl p-1 bg-gray-50">
                            </a>
                            <div class="px-1">
                                <p class="text-[10px] font-black text-gray-800 truncate">{{ cp.name }}</p>
                                <p class="text-[9px] text-gray-400 font-bold">{{ "{:,}".format(cp.price) }}ì›</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="mt-24 px-4 md:px-0 grid grid-cols-1 md:grid-cols-2 gap-6">
            <a href="/category/ìµœì‹ ìƒí’ˆ" class="bg-gray-800 text-white py-8 rounded-[2.5rem] text-center text-base font-black shadow-xl hover:bg-black transition flex items-center justify-center gap-4">
                <i class="fas fa-rocket text-xl text-blue-400"></i> ìµœì‹  ìƒí’ˆ ì „ì²´ë³´ê¸°
            </a>
            <a href="/" class="bg-white border-2 border-teal-600 text-teal-600 py-8 rounded-[2.5rem] text-center text-base font-black shadow-sm hover:bg-teal-50 transition flex items-center justify-center gap-4">
                <i class="fas fa-home text-xl"></i> ë°”êµ¬ë‹ˆì‚¼ì´Œ í™ˆìœ¼ë¡œ
            </a>
        </div>
    </div>
    """
    return render_template_string(HEADER_HTML + content + FOOTER_HTML, 
                                  p=p, is_expired=is_expired, detail_images=detail_images, 
                                  cat_info=cat_info, latest_all=latest_all, 
                                  keyword_recommends=keyword_recommends, 
                                  product_reviews=product_reviews,
                                  reviews_total_count=reviews_total_count,
                                  reviews_has_more=reviews_has_more,
                                  recommend_cats_detail=recommend_cats_detail,
                                  cat_previews_detail=cat_previews_detail)
@app.route('/category/seller/<int:cid>')
def seller_info_page(cid):
    """íŒë§¤ ì‚¬ì—…ì ì •ë³´ ìƒì„¸ í˜ì´ì§€"""
    cat = Category.query.get_or_404(cid)
    content = """
    <div class="max-w-xl mx-auto py-24 md:py-32 px-6 font-black text-left">
        <nav class="mb-12 text-left"><a href="javascript:history.back()" class="text-teal-600 font-black hover:underline flex items-center gap-2"><i class="fas fa-arrow-left"></i> ì´ì „ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a></nav>
        <div class="bg-white rounded-[3rem] md:rounded-[5rem] shadow-2xl border border-gray-100 overflow-hidden text-left">
            <div class="bg-teal-600 p-12 md:p-16 text-white text-center">
                <div class="w-20 h-20 md:w-24 md:h-24 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-8 text-3xl md:text-4xl text-center"><i class="fas fa-store"></i></div>
                <h2 class="text-3xl md:text-4xl font-black tracking-tight mb-3 italic uppercase text-center">Business Info</h2>
                <p class="opacity-80 font-bold text-sm md:text-lg text-center">ë³¸ ìƒí’ˆì˜ ì‹¤ì œ íŒë§¤ ì‚¬ì—…ì ì •ë³´ì…ë‹ˆë‹¤.</p>
            </div>
            
            <div class="p-10 md:p-20 space-y-10 md:space-y-14 text-left">
                <div class="text-left"><p class="text-[10px] text-gray-400 uppercase tracking-[0.3em] mb-3 font-black text-left">Company Name</p><p class="text-2xl md:text-3xl text-gray-800 font-black text-left">ìƒí˜¸ëª… : {{ cat.biz_name or '-' }}</p></div>
                <div class="grid grid-cols-2 gap-10 text-left">
                    <div class="text-left"><p class="text-[10px] text-gray-400 uppercase tracking-[0.3em] mb-3 font-black text-left">Representative</p><p class="text-gray-800 font-black text-lg md:text-xl text-left">ëŒ€í‘œì : {{ cat.biz_representative or '-' }}</p></div>
                    <div class="text-left"><p class="text-[10px] text-gray-400 uppercase tracking-[0.3em] mb-3 font-black text-left">Tax ID</p><p class="text-gray-800 font-black text-lg md:text-xl text-left">{{ cat.biz_reg_number or '-' }}</p></div>
                </div>
                <div class="text-left"><p class="text-[10px] text-gray-400 uppercase tracking-[0.3em] mb-3 font-black text-left">Location</p><p class="text-gray-700 font-bold leading-relaxed text-sm md:text-lg text-left">{{ cat.biz_address or '-' }}</p></div>
                <div class="p-8 md:p-12 bg-gray-50 rounded-[2rem] md:rounded-[3rem] border border-dashed border-gray-200 text-left"><p class="text-[10px] text-gray-400 uppercase tracking-[0.3em] mb-3 font-black text-left">Inquiry Center</p><p class="text-teal-600 text-2xl md:text-4xl font-black italic text-left">{{ cat.biz_contact or '-' }}</p></div>
            </div>
            
            <div class="bg-gray-50 p-8 text-center border-t border-gray-100 text-[11px] text-gray-400 font-black uppercase tracking-[0.5em] text-center">
                ë°”êµ¬ë‹ˆ ì‚¼ì´Œ Premium Service
            </div>
        </div>
    </div>"""
    return render_template_string(HEADER_HTML + content + FOOTER_HTML, cat=cat)

def _find_or_create_social_user(provider, provider_id, email, name):
    """ì†Œì…œ ë¡œê·¸ì¸: provider+provider_id ë˜ëŠ” emailë¡œ íšŒì› ì°¾ê¸°, ì—†ìœ¼ë©´ ìƒì„±. ë°˜í™˜: User"""
    user = User.query.filter_by(auth_provider=provider, auth_provider_id=str(provider_id)).first()
    if user:
        if (email and not user.email):
            user.email = email
        if name and not user.name:
            user.name = name
        db.session.commit()
        return user
    if email:
        user = User.query.filter_by(email=email).first()
        if user:
            user.auth_provider = provider
            user.auth_provider_id = str(provider_id)
            if name and not user.name:
                user.name = name
            db.session.commit()
            return user
    new_user = User(
        email=email or (provider + '_' + str(provider_id) + '@social.local'),
        password=None,
        name=name or '',
        auth_provider=provider,
        auth_provider_id=str(provider_id)
    )
    db.session.add(new_user)
    db.session.commit()
    return new_user


def _oauth_redirect_base():
    """OAuth redirect_uri ê¸°ì¤€ URL. OAUTH_REDIRECT_BASE ë˜ëŠ” SITE_URL ì„¤ì • ì‹œ ì‚¬ìš©(redirect_uri_mismatch ë°©ì§€)."""
    base = (os.getenv('OAUTH_REDIRECT_BASE') or os.getenv('SITE_URL') or '').strip().rstrip('/')
    if base:
        return base
    return request.url_root.rstrip('/')


@app.route('/auth/naver')
def auth_naver():
    """ë„¤ì´ë²„ ë¡œê·¸ì¸ ì§„ì…: ë„¤ì´ë²„ ì¸ì¦ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸"""
    client_id = os.getenv('NAVER_CLIENT_ID')
    if not client_id:
        flash("ë„¤ì´ë²„ ë¡œê·¸ì¸ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return redirect('/login')
    redirect_uri = _oauth_redirect_base() + '/auth/naver/callback'
    state = os.urandom(16).hex()
    session['oauth_state'] = state
    session['oauth_next'] = request.args.get('next') or '/'
    url = (
        'https://nid.naver.com/oauth2.0/authorize'
        '?response_type=code&client_id={}&redirect_uri={}&state={}'
    ).format(client_id, requests.utils.quote(redirect_uri), state)
    # í…ŒìŠ¤íŠ¸ ì‹œ ë™ì˜ í™”ë©´ ìº¡ì²˜ìš©: .envì— FORCE_NAVER_CONSENT_SCREEN=1 ì„¤ì • ì‹œ ë™ì˜ í™”ë©´ ì¬í‘œì‹œ íŒŒë¼ë¯¸í„° ì¶”ê°€ (ë„¤ì´ë²„ê°€ ë¯¸ì§€ì› ì‹œ ë¬´ì‹œë¨)
    if os.getenv('FORCE_NAVER_CONSENT_SCREEN', '').strip() in ('1', 'true', 'yes'):
        url += '&auth_type=reprompt&prompt=consent'
    return redirect(url)


@app.route('/auth/naver/callback')
def auth_naver_callback():
    """ë„¤ì´ë²„ ë¡œê·¸ì¸ ì½œë°±: codeë¡œ í† í°Â·í”„ë¡œí•„ ì¡°íšŒ í›„ ë¡œê·¸ì¸ ì²˜ë¦¬"""
    state = request.args.get('state')
    if not state or state != session.get('oauth_state'):
        flash("ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤."); return redirect('/login')
    session.pop('oauth_state', None)
    next_url = session.pop('oauth_next', '/')
    code = request.args.get('code')
    if not code:
        flash("ë„¤ì´ë²„ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); return redirect('/login')
    client_id = os.getenv('NAVER_CLIENT_ID')
    client_secret = os.getenv('NAVER_CLIENT_SECRET')
    if not client_id or not client_secret:
        flash("ë„¤ì´ë²„ ë¡œê·¸ì¸ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return redirect('/login')
    redirect_uri = _oauth_redirect_base() + '/auth/naver/callback'
    token_res = requests.post(
        'https://nid.naver.com/oauth2.0/token',
        data={
            'grant_type': 'authorization_code',
            'client_id': client_id,
            'client_secret': client_secret,
            'code': code,
            'state': state,
            'redirect_uri': redirect_uri
        },
        headers={'Accept': 'application/json'}
    )
    if token_res.status_code != 200:
        flash("ë„¤ì´ë²„ ë¡œê·¸ì¸(í† í°)ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); return redirect('/login')
    try:
        token_data = token_res.json()
        access_token = token_data.get('access_token')
    except Exception:
        flash("ë„¤ì´ë²„ ë¡œê·¸ì¸ ì‘ë‹µ ì˜¤ë¥˜."); return redirect('/login')
    if not access_token:
        flash("ë„¤ì´ë²„ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); return redirect('/login')
    profile_res = requests.get(
        'https://openapi.naver.com/v1/nid/me',
        headers={'Authorization': 'Bearer ' + access_token}
    )
    if profile_res.status_code != 200:
        flash("í”„ë¡œí•„ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); return redirect('/login')
    try:
        profile_data = profile_res.json()
        res = profile_data.get('response') or {}
        pid = res.get('id')
        email = (res.get('email') or '').strip() or None
        name = (res.get('name') or '').strip() or None
    except Exception:
        flash("í”„ë¡œí•„ í˜•ì‹ ì˜¤ë¥˜."); return redirect('/login')
    if not pid:
        flash("ë„¤ì´ë²„ í”„ë¡œí•„ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return redirect('/login')
    user = _find_or_create_social_user('naver', pid, email, name)
    session.permanent = True
    login_user(user)
    if user.email and user.email.endswith('@social.local'):
        flash("ë„¤ì´ë²„ë¡œ ë¡œê·¸ì¸í–ˆìŠµë‹ˆë‹¤. ë§ˆì´í˜ì´ì§€ì—ì„œ ì´ë©”ì¼Â·ì£¼ì†Œë¥¼ ë³´ì™„í•´ ì£¼ì„¸ìš”.")
    resp = redirect(next_url)
    resp.set_cookie('last_login_method', 'naver', max_age=365*24*3600, samesite='Lax')
    return resp


@app.route('/auth/google')
def auth_google():
    """êµ¬ê¸€ ë¡œê·¸ì¸ ì§„ì…: êµ¬ê¸€ ì¸ì¦ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸"""
    client_id = os.getenv('GOOGLE_CLIENT_ID')
    if not client_id:
        flash("êµ¬ê¸€ ë¡œê·¸ì¸ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return redirect('/login')
    redirect_uri = _oauth_redirect_base() + '/auth/google/callback'
    state = os.urandom(16).hex()
    session['oauth_state'] = state
    session['oauth_next'] = request.args.get('next') or '/'
    scope = requests.utils.quote('openid email profile')
    url = (
        'https://accounts.google.com/o/oauth2/v2/auth'
        '?client_id={}&redirect_uri={}&response_type=code&scope={}&state={}&access_type=offline&prompt=consent'
    ).format(client_id, requests.utils.quote(redirect_uri), scope, state)
    return redirect(url)


@app.route('/auth/google/callback')
def auth_google_callback():
    """êµ¬ê¸€ ë¡œê·¸ì¸ ì½œë°±"""
    state = request.args.get('state')
    if not state or state != session.get('oauth_state'):
        flash("ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤."); return redirect('/login')
    session.pop('oauth_state', None)
    next_url = session.pop('oauth_next', '/')
    code = request.args.get('code')
    if not code:
        flash("êµ¬ê¸€ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); return redirect('/login')
    client_id = os.getenv('GOOGLE_CLIENT_ID')
    client_secret = os.getenv('GOOGLE_CLIENT_SECRET')
    if not client_id or not client_secret:
        flash("êµ¬ê¸€ ë¡œê·¸ì¸ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return redirect('/login')
    redirect_uri = _oauth_redirect_base() + '/auth/google/callback'
    token_res = requests.post(
        'https://oauth2.googleapis.com/token',
        data={
            'code': code,
            'client_id': client_id,
            'client_secret': client_secret,
            'redirect_uri': redirect_uri,
            'grant_type': 'authorization_code'
        },
        headers={'Content-Type': 'application/x-www-form-urlencoded'}
    )
    if token_res.status_code != 200:
        flash("êµ¬ê¸€ ë¡œê·¸ì¸(í† í°)ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); return redirect('/login')
    try:
        token_data = token_res.json()
        access_token = token_data.get('access_token')
    except Exception:
        flash("êµ¬ê¸€ ë¡œê·¸ì¸ ì‘ë‹µ ì˜¤ë¥˜."); return redirect('/login')
    if not access_token:
        flash("êµ¬ê¸€ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); return redirect('/login')
    profile_res = requests.get(
        'https://www.googleapis.com/oauth2/v2/userinfo',
        headers={'Authorization': 'Bearer ' + access_token}
    )
    if profile_res.status_code != 200:
        flash("í”„ë¡œí•„ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); return redirect('/login')
    try:
        res = profile_res.json()
        pid = res.get('id')
        email = (res.get('email') or '').strip() or None
        name = (res.get('name') or '').strip() or None
    except Exception:
        flash("í”„ë¡œí•„ í˜•ì‹ ì˜¤ë¥˜."); return redirect('/login')
    if not pid:
        flash("êµ¬ê¸€ í”„ë¡œí•„ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return redirect('/login')
    user = _find_or_create_social_user('google', str(pid), email, name)
    session.permanent = True
    login_user(user)
    if user.email and user.email.endswith('@social.local'):
        flash("êµ¬ê¸€ë¡œ ë¡œê·¸ì¸í–ˆìŠµë‹ˆë‹¤. ë§ˆì´í˜ì´ì§€ì—ì„œ ì´ë©”ì¼Â·ì£¼ì†Œë¥¼ ë³´ì™„í•´ ì£¼ì„¸ìš”.")
    resp = redirect(next_url)
    resp.set_cookie('last_login_method', 'google', max_age=365*24*3600, samesite='Lax')
    return resp


@app.route('/auth/kakao')
def auth_kakao():
    """ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì§„ì…: ì¹´ì¹´ì˜¤ ì¸ì¦ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸"""
    client_id = os.getenv('KAKAO_REST_API_KEY') or os.getenv('KAKAO_CLIENT_ID')
    if not client_id:
        flash("ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return redirect('/login')
    redirect_uri = _oauth_redirect_base() + '/auth/kakao/callback'
    state = os.urandom(16).hex()
    session['oauth_state'] = state
    session['oauth_next'] = request.args.get('next') or '/'
    url = (
        'https://kauth.kakao.com/oauth/authorize'
        '?client_id={}&redirect_uri={}&response_type=code&state={}'
    ).format(client_id, requests.utils.quote(redirect_uri), state)
    return redirect(url)


@app.route('/auth/kakao/callback')
def auth_kakao_callback():
    """ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì½œë°±"""
    state = request.args.get('state')
    if not state or state != session.get('oauth_state'):
        flash("ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤."); return redirect('/login')
    session.pop('oauth_state', None)
    next_url = session.pop('oauth_next', '/')
    code = request.args.get('code')
    if not code:
        flash("ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); return redirect('/login')
    client_id = os.getenv('KAKAO_REST_API_KEY') or os.getenv('KAKAO_CLIENT_ID')
    client_secret = os.getenv('KAKAO_CLIENT_SECRET', '')  # ì¹´ì¹´ì˜¤ëŠ” ì„ íƒ
    if not client_id:
        flash("ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return redirect('/login')
    redirect_uri = _oauth_redirect_base() + '/auth/kakao/callback'
    token_payload = {
        'grant_type': 'authorization_code',
        'client_id': client_id,
        'redirect_uri': redirect_uri,
        'code': code
    }
    if client_secret:
        token_payload['client_secret'] = client_secret
    token_res = requests.post(
        'https://kauth.kakao.com/oauth/token',
        data=token_payload,
        headers={'Content-Type': 'application/x-www-form-urlencoded'}
    )
    if token_res.status_code != 200:
        flash("ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸(í† í°)ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); return redirect('/login')
    try:
        token_data = token_res.json()
        access_token = token_data.get('access_token')
    except Exception:
        flash("ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‘ë‹µ ì˜¤ë¥˜."); return redirect('/login')
    if not access_token:
        flash("ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); return redirect('/login')
    profile_res = requests.get(
        'https://kapi.kakao.com/v2/user/me',
        headers={'Authorization': 'Bearer ' + access_token}
    )
    if profile_res.status_code != 200:
        flash("ì¹´ì¹´ì˜¤ í”„ë¡œí•„ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); return redirect('/login')
    try:
        res = profile_res.json()
        pid = res.get('id')
        acc = res.get('kakao_account') or {}
        email = (acc.get('email') or '').strip() or None
        prof = acc.get('profile') or {}
        name = (prof.get('nickname') or '').strip() or None
    except Exception:
        flash("ì¹´ì¹´ì˜¤ í”„ë¡œí•„ í˜•ì‹ ì˜¤ë¥˜."); return redirect('/login')
    if not pid:
        flash("ì¹´ì¹´ì˜¤ í”„ë¡œí•„ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return redirect('/login')
    user = _find_or_create_social_user('kakao', str(pid), email, name)
    session.permanent = True
    login_user(user)
    if user.email and user.email.endswith('@social.local'):
        flash("ì¹´ì¹´ì˜¤ë¡œ ë¡œê·¸ì¸í–ˆìŠµë‹ˆë‹¤. ë§ˆì´í˜ì´ì§€ì—ì„œ ì´ë©”ì¼Â·ì£¼ì†Œë¥¼ ë³´ì™„í•´ ì£¼ì„¸ìš”.")
    resp = redirect(next_url)
    resp.set_cookie('last_login_method', 'kakao', max_age=365*24*3600, samesite='Lax')
    return resp


def _auth_status_json():
    """í†µí•© ë¡œê·¸ì¸ ì„¤ì • ì ê²€ JSON (ê´€ë¦¬ì í™•ì¸ í›„ ë°˜í™˜)."""
    base = _oauth_redirect_base()
    return jsonify({
        "flask_secret_set": bool(os.getenv("FLASK_SECRET_KEY")),
        "naver": {
            "client_id_set": bool(os.getenv("NAVER_CLIENT_ID")),
            "client_secret_set": bool(os.getenv("NAVER_CLIENT_SECRET")),
            "redirect_uri": base + "/auth/naver/callback",
        },
        "google": {
            "client_id_set": bool(os.getenv("GOOGLE_CLIENT_ID")),
            "client_secret_set": bool(os.getenv("GOOGLE_CLIENT_SECRET")),
            "redirect_uri": base + "/auth/google/callback",
        },
        "kakao": {
            "rest_api_key_set": bool(os.getenv("KAKAO_REST_API_KEY") or os.getenv("KAKAO_CLIENT_ID")),
            "client_secret_set": bool(os.getenv("KAKAO_CLIENT_SECRET")),
            "redirect_uri": base + "/auth/kakao/callback",
        },
        "hint": "ê° redirect_urië¥¼ í•´ë‹¹ ê°œë°œì ì½˜ì†”ì— ë™ì¼í•˜ê²Œ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤. FLASK_SECRET_KEYê°€ ì—†ìœ¼ë©´ ì„¸ì…˜ì´ ìœ ì§€ë˜ì§€ ì•Šì•„ ì½œë°± ì‹œ ì˜¤ë¥˜ê°€ ë‚©ë‹ˆë‹¤.",
@app.route('/admin/auth-status')
    })


@login_required
def admin_auth_status():
    """í†µí•© ë¡œê·¸ì¸ ì„¤ì • ì ê²€ (ê´€ë¦¬ì ì „ìš©)."""
    if not getattr(current_user, 'is_admin', False):
        return jsonify({"error": "ê¶Œí•œ ì—†ìŒ"}), 403
    return _auth_status_json()


@app.route('/auth/status')
@login_required
def auth_status():
    """í†µí•© ë¡œê·¸ì¸ ì„¤ì • ì ê²€ (ê´€ë¦¬ì ì „ìš©). /admin/auth-status ê°€ 404ì¼ ë•Œ ì´ URL ì‚¬ìš©."""
    if not getattr(current_user, 'is_admin', False):
        return jsonify({"error": "ê¶Œí•œ ì—†ìŒ"}), 403
    return _auth_status_json()


@app.route('/login', methods=['GET', 'POST'])
def login():
    """ë¡œê·¸ì¸ ë¼ìš°íŠ¸"""
    if request.method == 'POST':
        user = User.query.filter_by(email=request.form.get('email')).first()
        if user and user.password and check_password_hash(user.password, request.form.get('password')):
            session.permanent = True
            login_user(user)
            resp = redirect(request.args.get('next') or '/')
            resp.set_cookie('last_login_method', 'email', max_age=365*24*3600, samesite='Lax')
            return resp
        flash("ë¡œê·¸ì¸ ì •ë³´ë¥¼ ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸í•´ì£¼ì„¸ìš”.")
    next_arg = request.args.get('next', '')
    next_q = ('?next=' + requests.utils.quote(next_arg)) if next_arg else ''
    recent_login = request.cookies.get('last_login_method') or ''
    return render_template_string(HEADER_HTML + """
    <div class="max-w-sm mx-auto mt-12 md:mt-16 mb-16 p-6 md:p-8 bg-white rounded-2xl md:rounded-3xl shadow-lg border border-gray-100 text-left">
        <h2 class="text-xl md:text-2xl font-black text-center mb-6 text-teal-600 uppercase italic tracking-tight">Login</h2>
        <div class="mb-5">
            <p class="text-[10px] text-gray-400 font-black uppercase tracking-widest text-center mb-3">ë„¤ì´ë²„ Â· êµ¬ê¸€ Â· ì¹´ì¹´ì˜¤ í†µí•© ë¡œê·¸ì¸</p>
            <div class="flex flex-col gap-2">
                <div class="relative" id="login-option-naver">
                    {% if recent_login == 'naver' %}<p class="text-[9px] text-teal-600 font-black mb-1 flex items-center justify-center gap-1"><span>ìµœê·¼ ë¡œê·¸ì¸ (ë„¤ì´ë²„)</span><span class="text-teal-500 text-xs" aria-hidden="true">â†“</span></p>{% endif %}
                    <a href="/auth/naver{{ next_q }}" class="flex items-center justify-center gap-2 w-full py-3 rounded-xl font-black text-xs bg-[#03C75A] text-white hover:opacity-90 transition shadow-sm{% if recent_login == 'naver' %} ring-2 ring-teal-400 ring-offset-1{% endif %}"><span class="w-4 h-4 rounded-full bg-white/20 flex items-center justify-center text-[9px]">N</span> ë„¤ì´ë²„ë¡œ ë¡œê·¸ì¸</a>
                </div>
                <div class="relative" id="login-option-google">
                    {% if recent_login == 'google' %}<p class="text-[9px] text-teal-600 font-black mb-1 flex items-center justify-center gap-1"><span>ìµœê·¼ ë¡œê·¸ì¸ (êµ¬ê¸€)</span><span class="text-teal-500 text-xs" aria-hidden="true">â†“</span></p>{% endif %}
                    <a href="/auth/google{{ next_q }}" class="flex items-center justify-center gap-2 w-full py-3 rounded-xl font-black text-xs bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 transition{% if recent_login == 'google' %} ring-2 ring-teal-400 ring-offset-1{% endif %}"><span class="w-4 h-4 rounded-full bg-[#4285F4] flex items-center justify-center text-white text-[9px]">G</span> êµ¬ê¸€ë¡œ ë¡œê·¸ì¸</a>
                </div>
                <div class="relative" id="login-option-kakao">
                    {% if recent_login == 'kakao' %}<p class="text-[9px] text-teal-600 font-black mb-1 flex items-center justify-center gap-1"><span>ìµœê·¼ ë¡œê·¸ì¸ (ì¹´ì¹´ì˜¤)</span><span class="text-teal-500 text-xs" aria-hidden="true">â†“</span></p>{% endif %}
                    <a href="/auth/kakao{{ next_q }}" class="flex items-center justify-center gap-2 w-full py-3 rounded-xl font-black text-xs bg-[#FEE500] text-[#191919] hover:opacity-90 transition{% if recent_login == 'kakao' %} ring-2 ring-teal-400 ring-offset-1{% endif %}"><span class="w-4 h-4 rounded-full bg-[#191919] flex items-center justify-center text-[#FEE500] text-[9px]">K</span> ì¹´ì¹´ì˜¤ë¡œ ë¡œê·¸ì¸</a>
                </div>
            </div>
        </div>
        <div class="pt-5 border-t border-gray-100" id="login-option-email">
            <p class="text-[10px] text-gray-400 font-black uppercase tracking-widest text-center mb-3">ì´ë©”ì¼ ë¡œê·¸ì¸</p>
            {% if recent_login == 'email' %}<p class="text-[9px] text-teal-600 font-black mb-1 flex items-center justify-center gap-1"><span>ìµœê·¼ ë¡œê·¸ì¸ (ì´ë©”ì¼)</span><span class="text-teal-500 text-xs" aria-hidden="true">â†“</span></p>{% endif %}
            <div class="relative{% if recent_login == 'email' %} rounded-xl ring-2 ring-teal-400 ring-offset-1 p-1{% endif %}">
            <form method="POST" class="space-y-3 text-left">
                <div class="space-y-1">
                    <label class="text-[10px] text-gray-400 font-black uppercase tracking-widest block ml-1">ID (Email)</label>
                    <input name="email" type="email" placeholder="email@example.com" class="w-full px-4 py-2.5 bg-gray-50 rounded-xl font-bold text-sm focus:ring-2 focus:ring-teal-200 outline-none border border-gray-100" required>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] text-gray-400 font-black uppercase tracking-widest block ml-1">Password</label>
                    <input name="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full px-4 py-2.5 bg-gray-50 rounded-xl font-bold text-sm focus:ring-2 focus:ring-teal-200 outline-none border border-gray-100" required>
                </div>
                <button type="submit" class="w-full bg-teal-600 text-white py-3 rounded-xl font-black text-sm shadow-md hover:bg-teal-700 transition active:scale-[0.98]">ë¡œê·¸ì¸</button>
            </form>
            </div>
        </div>
        <div class="text-center mt-6"><a href="/register" class="text-gray-400 text-[11px] font-bold hover:text-teal-600 transition">ì•„ì§ íšŒì›ì´ ì•„ë‹ˆì‹ ê°€ìš”? íšŒì›ê°€ì…</a></div>
    </div>""" + FOOTER_HTML, next_q=next_q, recent_login=recent_login)

@app.route('/register', methods=['GET', 'POST'])
def register():
    """íšŒì›ê°€ì… ë¼ìš°íŠ¸ (ì „ììƒê±°ë˜ ë™ì˜ í¬í•¨)"""
    if request.method == 'POST':
        name, email, pw, phone = request.form['name'], request.form['email'], request.form['password'], request.form['phone']
        addr, addr_d, ent_pw, memo = request.form['address'], request.form['address_detail'], request.form['entrance_pw'], request.form['request_memo']
        
        # ë°°ì†¡êµ¬ì—­ ì²´í¬ (ê´€ë¦¬ì ì„¤ì • í´ë¦¬ê³¤ ë˜ëŠ” ê¸°ë³¸ ì†¡ë„ë™)
        if not is_address_in_delivery_zone(addr or ""):
            flash("í•´ë‹¹ ì£¼ì†ŒëŠ” ë°°ì†¡ ê°€ëŠ¥ êµ¬ì—­ì´ ì•„ë‹™ë‹ˆë‹¤. ì„¤ì •ëœ í€µì§€ì—­ ë‚´ ì£¼ì†Œë§Œ ê°€ì… ê°€ëŠ¥í•˜ë©°, ê·¸ ì™¸ ì§€ì—­ì€ ë°°ì†¡ ë¶ˆê°€ì…ë‹ˆë‹¤."); return redirect('/register')

        if not request.form.get('consent_e_commerce'):
            flash("ì „ììƒê±°ë˜ ì´ìš© ì•½ê´€ ë° ìœ ì˜ì‚¬í•­ì— ë™ì˜í•´ì•¼ í•©ë‹ˆë‹¤."); return redirect('/register')

        if User.query.filter_by(email=email).first(): flash("ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤."); return redirect('/register')
        new_user = User(
            email=email, password=generate_password_hash(pw), name=name, phone=phone,
            address=addr, address_detail=addr_d, entrance_pw=ent_pw, request_memo=memo,
            utm_source=session.get('utm_source'), utm_medium=session.get('utm_medium'), utm_campaign=session.get('utm_campaign')
        )
        db.session.add(new_user)
        db.session.commit()
        title, body = get_template_content('welcome')
        send_message(new_user.id, title, body, 'welcome')
        db.session.commit()
        return redirect('/login')
    return render_template_string(HEADER_HTML + """
    <div class="max-w-md mx-auto mt-12 mb-24 p-10 md:p-16 bg-white rounded-[3rem] md:rounded-[4rem] shadow-2xl border text-left">
        <h2 class="text-2xl md:text-3xl font-black mb-12 tracking-tighter uppercase text-teal-600 text-left">Join Us</h2>
        <form method="POST" class="space-y-6 text-left">
            <div class="space-y-4 text-left">
                <input name="name" placeholder="ì‹¤ëª… (ì„±í•¨)" class="w-full p-5 bg-gray-50 rounded-2xl font-black text-sm text-left" required>
                <input name="email" type="email" placeholder="ì´ë©”ì¼ ì£¼ì†Œ" class="w-full p-5 bg-gray-50 rounded-2xl font-black text-sm text-left" required>
                <input name="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full p-5 bg-gray-50 rounded-2xl font-black text-sm text-left" required>
                <input name="phone" placeholder="íœ´ëŒ€í° ë²ˆí˜¸ ( - ì œì™¸ )" class="w-full p-5 bg-gray-50 rounded-2xl font-black text-sm text-left" required>
            </div>
            
            <div class="space-y-4 border-t border-gray-100 pt-6 text-left">
                <div class="flex gap-2 text-left text-left">
                    <input id="address" name="address" placeholder="ì¸ì²œê´‘ì—­ì‹œ ì—°ìˆ˜êµ¬ ì†¡ë„ë™..." class="flex-1 p-5 bg-gray-100 rounded-2xl font-black text-xs md:text-sm text-left" readonly onclick="execDaumPostcode()">
                    <button type="button" onclick="execDaumPostcode()" class="bg-gray-800 text-white px-6 rounded-2xl font-black text-xs text-center">ê²€ìƒ‰</button>
                </div>
                <input id="address_detail" name="address_detail" placeholder="ìƒì„¸ì£¼ì†Œ (ë™/í˜¸ìˆ˜)" class="w-full p-5 bg-gray-50 rounded-2xl font-black text-sm text-left" required>
                <input name="entrance_pw" placeholder="ê³µë™í˜„ê´€ ë¹„ë°€ë²ˆí˜¸ (í•„ìˆ˜)" class="w-full p-5 bg-red-50 rounded-2xl font-black border border-red-100 text-sm text-left" required>
                <textarea name="request_memo" placeholder="ë°°ì†¡ ì‹œ ìš”ì²­ì‚¬í•­ì„ ë‚¨ê²¨ì£¼ì„¸ìš”" class="w-full p-5 bg-white border border-gray-100 rounded-2xl font-black h-28 text-sm text-left"></textarea>
            </div>
            
            <div class="p-5 bg-gray-50 rounded-2xl border border-gray-100 text-[10px] space-y-3 mt-6 text-left">
                <label class="flex items-start gap-3 cursor-pointer group text-left text-left">
                    <span class="group-hover:text-gray-800 transition leading-normal md:leading-relaxed break-keep text-[11px] md:text-sm">
    [í•„ìˆ˜] ë³¸ ì„œë¹„ìŠ¤ëŠ” <b>êµ¬ë§¤ëŒ€í–‰í˜• í†µí•© ë¬¼ë¥˜ ì„œë¹„ìŠ¤</b>ì´ë©°, ì´ìš©ìì˜ ì£¼ë¬¸ ìš”ì²­ì— ë”°ë¼ ë‹¹ì‚¬ê°€ ìƒí’ˆì„ êµ¬ë§¤ ë° ë°°ì†¡í•¨ì„ í™•ì¸í•˜ê³  ì´ì— ë™ì˜í•©ë‹ˆë‹¤.
</span>
                </label>
            </div>

            <button class="w-full bg-teal-600 text-white py-6 rounded-3xl font-black text-lg shadow-xl mt-6 hover:bg-teal-700 transition active:scale-95 text-center text-center">ê°€ì… ì™„ë£Œ</button>
        </form>
    </div>""" + FOOTER_HTML)

@app.route('/logout')
def logout(): 
    """ë¡œê·¸ì•„ì›ƒ"""
    logout_user(); return redirect('/')
@app.route('/mypage/update_address', methods=['POST'])
@login_required
def update_address():
    """ë§ˆì´í˜ì´ì§€ ì£¼ì†Œ ì—…ë°ì´íŠ¸ ë° ê°•ì œ ë°ì´í„° ê°±ì‹ """
    addr = request.form.get('address')
    addr_d = request.form.get('address_detail')
    ent_pw = request.form.get('entrance_pw')

    if not addr or not is_address_in_delivery_zone(addr):
        flash("í•´ë‹¹ ì£¼ì†ŒëŠ” ë°°ì†¡ ê°€ëŠ¥ êµ¬ì—­ì´ ì•„ë‹™ë‹ˆë‹¤. í€µì§€ì—­ ì„¤ì • êµ¬ì—­ ë‚´ ì£¼ì†Œë§Œ ë°°ì†¡ ê°€ëŠ¥í•˜ë©°, ê·¸ ì™¸ ì§€ì—­ì€ ë°°ì†¡ ë¶ˆê°€ì…ë‹ˆë‹¤.")
        return redirect(url_for('mypage'))

    try:
        # 1. DB ë°ì´í„° ì—…ë°ì´íŠ¸
        current_user.address = addr
        current_user.address_detail = addr_d
        current_user.entrance_pw = ent_pw
        
        # 2. ë³€ê²½ì‚¬í•­ ì €ì¥ ë° ê°ì²´ ìƒˆë¡œê³ ì¹¨ (í•µì‹¬)
        db.session.commit()
        try:
            db.session.refresh(current_user)
        except Exception:
            pass
        flash("íšŒì› ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨")
    except Exception as e:
        db.session.rollback()
        flash("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
        print(f"Error: {e}")

    return redirect(url_for('mypage'))

@app.route('/mypage/messages')
@login_required
def mypage_messages():
    """ë‚´ ë©”ì‹œì§€ ëª©ë¡ (ì½ìŒ ì²˜ë¦¬ ì§€ì›). ?id= ìˆìœ¼ë©´ í•´ë‹¹ ë©”ì‹œì§€ ì—´ê¸° ë° ì½ìŒ ì²˜ë¦¬."""
    msg_id = request.args.get('id', type=int)
    open_msg = None
    if msg_id:
        open_msg = UserMessage.query.filter_by(id=msg_id, user_id=current_user.id).first()
        if open_msg and not open_msg.read_at:
            open_msg.read_at = datetime.now()
            db.session.commit()
    messages = UserMessage.query.filter_by(user_id=current_user.id).order_by(UserMessage.created_at.desc()).limit(200).all()
    unread_count = UserMessage.query.filter_by(user_id=current_user.id, read_at=None).count()
    return render_template_string(
        HEADER_HTML + """
        <div class="max-w-2xl mx-auto py-8 md:py-12 px-4 font-black text-left">
            <div class="flex justify-between items-center mb-8">
                <a href="/mypage" class="text-gray-400 hover:text-teal-600 transition flex items-center gap-1.5 text-sm font-bold"><i class="fas fa-arrow-left"></i> ë§ˆì´í˜ì´ì§€</a>
                <a href="/logout" class="text-gray-400 hover:text-red-500 transition text-sm font-black">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
            <h2 class="text-2xl md:text-3xl font-black text-gray-800 mb-2">ë‚´ ë©”ì‹œì§€</h2>
            <p class="text-gray-500 text-sm mb-4">ì£¼ë¬¸Â·ë°°ì†¡ ì•Œë¦¼ê³¼ ê³µì§€ì‚¬í•­ì„ í™•ì¸í•˜ì„¸ìš”.</p>
            {% if unread_count and unread_count > 0 %}
            <div class="mb-6 flex justify-end">
                <button type="button" id="messages-read-all-btn" class="touch-target px-4 py-2.5 bg-gray-100 text-gray-700 rounded-xl text-xs font-black hover:bg-gray-200 transition">ì½ìŒì²˜ë¦¬</button>
            </div>
            {% endif %}
            {% if open_msg %}
            <div class="bg-teal-50/50 border border-teal-100 rounded-2xl p-6 mb-8 relative">
                <div class="flex justify-between items-start gap-3 mb-3">
                    <span class="text-[10px] text-teal-600 font-bold">{{ open_msg.created_at.strftime('%Y-%m-%d %H:%M') if open_msg.created_at else '' }}</span>
                    <a href="/mypage/messages" class="touch-target inline-flex items-center gap-1.5 px-3 py-2 rounded-xl bg-gray-100 text-gray-600 text-xs font-black hover:bg-gray-200 transition">ë‹«ê¸° <i class="fas fa-times"></i></a>
                </div>
                <h3 class="font-black text-gray-800 text-lg">{{ open_msg.title or 'ì•Œë¦¼' }}</h3>
                <p class="text-gray-700 text-sm mt-3 whitespace-pre-wrap">{{ open_msg.body or '' }}</p>
                {% if open_msg.image_url %}
                <div class="mt-4">
                    <p class="text-[10px] text-gray-500 font-bold mb-2">ë°°ì†¡ ì™„ë£Œ ì‚¬ì§„</p>
                    <a href="{{ open_msg.image_url }}" target="_blank" class="block rounded-xl overflow-hidden border border-gray-100 max-w-sm"><img src="{{ open_msg.image_url }}" alt="ë°°ì†¡ ì‚¬ì§„" class="w-full h-auto object-cover"></a>
                </div>
                {% endif %}
            </div>
            {% endif %}
            <div class="space-y-3">
                {% for m in messages %}
                <div class="rounded-2xl border shadow-sm overflow-hidden {% if m.read_at %}bg-gray-50 border-gray-200{% else %}bg-white border-gray-100 border-l-4 border-l-teal-500{% endif %} {% if open_msg and open_msg.id == m.id %}ring-2 ring-teal-300{% endif %}">
                    <div class="p-5 text-left flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                        <a href="/mypage/messages?id={{ m.id }}" class="flex-1 min-w-0 hover:opacity-90 transition">
                            <div class="flex justify-between items-start gap-3">
                                <span class="text-[10px] font-bold {% if m.read_at %}text-gray-400{% else %}text-gray-500{% endif %}">{{ m.created_at.strftime('%Y-%m-%d %H:%M') if m.created_at else '' }}</span>
                                <span class="text-[10px] px-2 py-0.5 rounded-full {% if m.read_at %}bg-gray-200 text-gray-500{% elif m.msg_type in ['order_created','delivery_requested','delivery_in_progress','delivery_complete'] %}bg-teal-100 text-teal-700{% elif m.msg_type in ['order_cancelled','part_cancelled','out_of_stock'] %}bg-red-100 text-red-700{% else %}bg-gray-100 text-gray-600{% endif %}">{{ m.msg_type or 'ì•Œë¦¼' }}</span>
                            </div>
                            <h3 class="font-black mt-2 {% if m.read_at %}text-gray-500{% else %}text-gray-800{% endif %}">{{ m.title or 'ì•Œë¦¼' }}</h3>
                            <p class="text-sm mt-1 line-clamp-2 {% if m.read_at %}text-gray-400{% else %}text-gray-600{% endif %}">{{ (m.body or '')[:120] }}{% if (m.body or '')|length > 120 %}...{% endif %}</p>
                            {% if m.related_order_id %}<p class="text-[10px] mt-2 {% if m.read_at %}text-gray-400{% else %}text-teal-600{% endif %}">ì£¼ë¬¸ ê´€ë ¨</p>{% endif %}
                        </a>
                        {% if m.read_at %}
                        <span class="shrink-0 px-4 py-2.5 bg-gray-200 text-gray-400 rounded-xl text-xs font-black text-center cursor-default">í™•ì¸ë¨</span>
                        {% else %}
                        <a href="/mypage/messages?id={{ m.id }}" class="touch-target shrink-0 px-4 py-2.5 bg-teal-600 text-white rounded-xl text-xs font-black hover:bg-teal-700 transition text-center">í™•ì¸</a>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="bg-gray-50 rounded-2xl p-12 text-center text-gray-500">ë°›ì€ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                {% endfor %}
            </div>
        </div>
        <script>
        (function(){
            var btn = document.getElementById('messages-read-all-btn');
            if (!btn) return;
            btn.addEventListener('click', function() {
                btn.disabled = true;
                btn.textContent = 'ì²˜ë¦¬ ì¤‘...';
                fetch('/mypage/messages/read-all', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' })
                    .then(function(r) { return r.json(); })
                    .then(function(d) { if (d.success) location.reload(); else btn.disabled = false; })
                    .catch(function() { btn.disabled = false; btn.textContent = 'ì½ìŒì²˜ë¦¬'; });
            });
        })();
        </script>
        """ + FOOTER_HTML,
        messages=messages, unread_count=unread_count, open_msg=open_msg
    )


@app.route('/mypage/messages/<int:msg_id>/read', methods=['POST'])
@login_required
def mypage_message_read(msg_id):
    """ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬"""
    m = UserMessage.query.filter_by(id=msg_id, user_id=current_user.id).first()
    if not m:
        return jsonify({"success": False}), 404
    if not m.read_at:
        m.read_at = datetime.now()
        db.session.commit()
    return jsonify({"success": True})


@app.route('/mypage/messages/read-all', methods=['POST'])
@login_required
def mypage_messages_read_all():
    """ì „ì²´ ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬"""
    now = datetime.now()
    unread = UserMessage.query.filter_by(user_id=current_user.id, read_at=None).all()
    for m in unread:
        m.read_at = now
    db.session.commit()
    return jsonify({"success": True, "count": len(unread)})


@app.route('/mypage/points')
@login_required
def mypage_points():
    """í¬ì¸íŠ¸ ë‚´ì—­ (íšŒì› ë³¸ì¸) - ì ë¦½ë‚´ì—­ / ì‚¬ìš©ë‚´ì—­ êµ¬ë¶„"""
    all_logs = PointLog.query.filter_by(user_id=current_user.id).order_by(PointLog.created_at.desc()).limit(200).all()
    earned_logs = [l for l in all_logs if l.amount > 0]
    used_logs = [l for l in all_logs if l.amount < 0]
    current_points = getattr(current_user, 'points', 0) or 0
    return render_template_string(
        HEADER_HTML + """
        <div class="max-w-2xl mx-auto py-8 md:py-12 px-4 font-black text-left">
            <div class="flex justify-between items-center mb-8">
                <a href="/mypage" class="text-gray-400 hover:text-teal-600 transition flex items-center gap-1.5 text-sm font-bold"><i class="fas fa-arrow-left"></i> ë§ˆì´í˜ì´ì§€</a>
                <a href="/logout" class="text-gray-400 hover:text-red-500 transition text-sm font-black">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
            <h2 class="text-2xl md:text-3xl font-black text-gray-800 mb-2">í¬ì¸íŠ¸ ë‚´ì—­</h2>
            <p class="text-gray-500 text-sm mb-6">ë³´ìœ  í¬ì¸íŠ¸: <span class="text-teal-600 font-black">{{ current_points }}</span> P</p>

            <div class="mb-8">
                <h3 class="text-lg font-black text-gray-700 mb-3 flex items-center gap-2"><i class="fas fa-plus-circle text-teal-500"></i> ì ë¦½ë‚´ì—­</h3>
                <div class="space-y-2">
                    {% for log in earned_logs %}
                    <div class="bg-white rounded-2xl border border-gray-100 p-4 flex justify-between items-center">
                        <div>
                            <span class="text-[10px] text-gray-400 font-bold">{{ log.created_at.strftime('%Y-%m-%d %H:%M') if log.created_at else '' }}</span>
                            <p class="text-sm font-bold text-gray-800 mt-0.5">{{ log.memo or 'ì ë¦½' }}</p>
                        </div>
                        <span class="font-black text-teal-600">+{{ log.amount }} P</span>
                    </div>
                    {% else %}
                    <div class="bg-gray-50 rounded-2xl p-8 text-center text-gray-500 text-sm">ì ë¦½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                    {% endfor %}
                </div>
            </div>

            <div>
                <h3 class="text-lg font-black text-gray-700 mb-3 flex items-center gap-2"><i class="fas fa-minus-circle text-amber-500"></i> ì‚¬ìš©ë‚´ì—­</h3>
                <div class="space-y-2">
                    {% for log in used_logs %}
                    <div class="bg-white rounded-2xl border border-gray-100 p-4 flex justify-between items-center">
                        <div>
                            <span class="text-[10px] text-gray-400 font-bold">{{ log.created_at.strftime('%Y-%m-%d %H:%M') if log.created_at else '' }}</span>
                            <p class="text-sm font-bold text-gray-800 mt-0.5">{{ log.memo or 'ì‚¬ìš©' }}</p>
                        </div>
                        <span class="font-black text-gray-500">{{ log.amount }} P</span>
                    </div>
                    {% else %}
                    <div class="bg-gray-50 rounded-2xl p-8 text-center text-gray-500 text-sm">ì‚¬ìš© ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
        """ + FOOTER_HTML,
        earned_logs=earned_logs, used_logs=used_logs, current_points=current_points
    )


@app.route('/mypage/reviews')
@login_required
def mypage_reviews():
    """ë‚´ê°€ ë“±ë¡í•œ ë¦¬ë·° ëª©ë¡"""
    reviews = Review.query.filter_by(user_id=current_user.id).order_by(Review.created_at.desc()).all()
    return render_template_string(
        HEADER_HTML + """
        <div class="max-w-2xl mx-auto py-8 md:py-12 px-4 font-black text-left">
            <div class="flex justify-between items-center mb-8">
                <a href="/mypage" class="text-gray-400 hover:text-teal-600 transition flex items-center gap-1.5 text-sm font-bold"><i class="fas fa-arrow-left"></i> ë§ˆì´í˜ì´ì§€</a>
                <a href="/logout" class="text-gray-400 hover:text-red-500 transition text-sm font-black">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
            <h2 class="text-2xl md:text-3xl font-black text-gray-800 mb-2">ë¦¬ë·°ê´€ë¦¬</h2>
            <p class="text-gray-500 text-sm mb-6">ë‚´ê°€ ì‘ì„±í•œ êµ¬ë§¤ í›„ê¸°ì…ë‹ˆë‹¤.</p>
            <div class="space-y-4">
                {% for r in reviews %}
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden flex flex-col sm:flex-row gap-4 p-4">
                    {% if r.image_url %}
                    {% if r.product_id %}<a href="/product/{{ r.product_id }}" class="shrink-0 w-20 h-20 rounded-xl overflow-hidden border border-gray-100 bg-gray-50">{% else %}<div class="shrink-0 w-20 h-20 rounded-xl overflow-hidden border border-gray-100 bg-gray-50">{% endif %}
                        <img src="{{ r.image_url }}" class="w-full h-full object-cover" alt="" loading="lazy">
                    {% if r.product_id %}</a>{% else %}</div>{% endif %}
                    {% else %}
                    <div class="shrink-0 w-20 h-20 rounded-xl bg-gray-100 flex items-center justify-center text-gray-400 text-[10px] font-bold border border-gray-100">ì‚¬ì§„ ì—†ìŒ</div>
                    {% endif %}
                    <div class="flex-1 min-w-0">
                        <p class="text-[10px] text-gray-400 font-bold">{{ r.created_at.strftime('%Y.%m.%d') if r.created_at else '' }}</p>
                        <p class="font-black text-gray-800 mt-0.5 truncate">{{ r.product_name or 'ìƒí’ˆ' }}</p>
                        <p class="text-sm text-gray-600 mt-1 line-clamp-2">{{ (r.content or '')[:100] }}{% if (r.content or '')|length > 100 %}...{% endif %}</p>
                        {% if r.product_id %}
                        <a href="/product/{{ r.product_id }}" class="inline-block mt-2 text-[10px] font-black text-teal-600 hover:underline">ìƒí’ˆ ë³´ê¸°</a>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="bg-gray-50 rounded-2xl p-12 text-center text-gray-500">ë“±ë¡í•œ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                {% endfor %}
            </div>
        </div>
        """ + FOOTER_HTML,
        reviews=reviews
    )


@app.route('/mypage')
@login_required
def mypage():
    """ë§ˆì´í˜ì´ì§€ (ìµœì¢… ì™„ì„±ë³¸: í°íŠ¸ ìµœì í™” ë° í•œê¸€í™” ë²„ì „). ì£¼ì†Œ ìˆ˜ì •ì€ ì—¬ê¸°ì„œë§Œ ê°€ëŠ¥."""
    try:
        db.session.refresh(current_user)
    except Exception:
        pass  # current_userê°€ ì„¸ì…˜ì— ì—†ìœ¼ë©´ ë¬´ì‹œ (í˜ì´ì§€ëŠ” ì •ìƒ í‘œì‹œ)
    # í…œí”Œë¦¿ì—ì„œ current_user ì†ì„± ì ‘ê·¼ ì‹œ DetachedInstanceError ë°©ì§€: ë¯¸ë¦¬ ê°’ë§Œ ì¶”ì¶œ
    user_id = getattr(current_user, "id", None)
    mypage_name = getattr(current_user, "name", None) or getattr(current_user, "email", None) or "íšŒì›"
    mypage_email = getattr(current_user, "email", None) or ""
    mypage_address = getattr(current_user, "address", None) or ""
    mypage_address_detail = getattr(current_user, "address_detail", None) or ""
    mypage_entrance_pw = getattr(current_user, "entrance_pw", None) or ""
    mypage_points = getattr(current_user, "points", 0) or 0
    need_address = request.args.get("need_address") == "1"
    from_cart = request.args.get("from") == "cart"
    if need_address:
        flash("ì£¼ì†Œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
    # ì•Œë¦¼ ì´ë¯¸ í—ˆìš©í•œ íšŒì›ì—ê²ŒëŠ” 'ì•Œë¦¼ ì¼œê¸°' ë¸”ë¡ ë¯¸í‘œì‹œ
    push_sub_count = PushSubscription.query.filter_by(user_id=user_id).count()
    push_already_set = push_sub_count > 0  # Trueë©´ ì•Œë¦¼ í—ˆìš©ë¨ â†’ ì•Œë¦¼ ì¼œê¸° ìˆ¨ê¹€
    unread_message_count = UserMessage.query.filter_by(user_id=user_id, read_at=None).count()
    orders = Order.query.filter_by(user_id=user_id).order_by(Order.created_at.desc()).all()
    cutoff_7d = datetime.now() - timedelta(days=7)

    # í’ˆëª©ë³„ ê¸ˆì•¡ ìƒì„¸ + í’ˆëª©ë³„ ì·¨ì†Œìš© OrderItem ëª©ë¡ (ì·¨ì†Œ í’ˆëª©ë„ í‘œê¸°)
    enhanced_orders = []
    for o in orders:
        o.order_items = OrderItem.query.filter_by(order_id=o.id).order_by(OrderItem.id.asc()).all()
        details_with_price = []
        if o.order_items:
            for oi in o.order_items:
                if oi.cancelled:
                    details_with_price.append(f"{oi.product_name}({oi.quantity}ê°œ) --- ì·¨ì†Œ")
                else:
                    details_with_price.append(f"{oi.product_name}({oi.quantity}ê°œ) --- {(oi.price * oi.quantity):,}ì›")
        elif o.product_details:
            parts = o.product_details.split(' | ')
            for part in parts:
                match = re.search(r'\[(.*?)\] (.*?)\((\d+)\)', part)
                if match:
                    cat_n, p_name, qty = match.groups()
                    p_obj = Product.query.filter_by(name=p_name.strip()).first()
                    price = p_obj.price if p_obj else 0
                    line_total = price * int(qty)
                    details_with_price.append(f"{p_name.strip()}({qty}ê°œ) --- {line_total:,}ì›")
                else:
                    details_with_price.append(part)
        o.enhanced_details = "\\n".join(details_with_price) if details_with_price else "ì£¼ë¬¸ ì·¨ì†Œë¨"
        if o.order_items:
            o.display_summary = ", ".join(f"{oi.product_name}({oi.quantity})" + (" [ì·¨ì†Œ]" if oi.cancelled else "") for oi in o.order_items)
            o.can_cancel_order = o.status == 'ê²°ì œì™„ë£Œ' and not any(not getattr(oi, 'cancelled', False) and getattr(oi, 'item_status', None) in ('ë°°ì†¡ìš”ì²­', 'ë°°ì†¡ì¤‘', 'ë°°ì†¡ì™„ë£Œ') for oi in o.order_items)
        else:
            o.display_summary = (o.product_details or "ì£¼ë¬¸ ì·¨ì†Œë¨")[:80]
            o.can_cancel_order = (o.status == 'ê²°ì œì™„ë£Œ')
        enhanced_orders.append(o)
    recent_orders = [o for o in enhanced_orders if not o.created_at or o.created_at >= cutoff_7d]
    older_orders = [o for o in enhanced_orders if o.created_at and o.created_at < cutoff_7d]

    # ìµœê·¼ ì£¼ë¬¸ ìƒí’ˆ 10ê°œ (í´ë¦­ ì‹œ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™)
    recent_order_items = db.session.query(OrderItem).join(Order, OrderItem.order_id == Order.id).filter(
        Order.user_id == user_id, OrderItem.cancelled == False
    ).order_by(Order.created_at.desc()).limit(10).all()
    # ì£¼ë¬¸ì¼ í¬í•¨í•˜ë ¤ë©´ Orderë„ ê°€ì ¸ì™€ì•¼ í•¨
    recent_items_with_date = []
    for oi in recent_order_items:
        o = Order.query.get(oi.order_id)
        recent_items_with_date.append({"item": oi, "order_date": o.created_at if o else None})
    recent_items_with_date = recent_items_with_date[:10]

    content = """
    <div class="max-w-4xl mx-auto py-6 md:py-12 px-4 md:px-6 font-black text-left mobile-px">
        {% if from_cart %}
        <div class="mb-6 p-4 bg-teal-50 border border-teal-200 rounded-2xl text-teal-800 text-sm font-bold flex flex-wrap items-center justify-between gap-3">
            <span><i class="fas fa-shopping-cart mr-2"></i>ì£¼ì†Œ ìˆ˜ì • í›„ ì¥ë°”êµ¬ë‹ˆì—ì„œ ë‹¤ì‹œ ì£¼ë¬¸í•˜ê¸°ë¥¼ ëˆŒëŸ¬ ì£¼ì„¸ìš”.</span>
            <a href="/cart" class="shrink-0 px-5 py-2.5 bg-teal-600 text-white rounded-xl text-xs font-black hover:bg-teal-700 transition">ì¥ë°”êµ¬ë‹ˆë¡œ ì´ë™</a>
        </div>
        {% endif %}
        <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4 mb-8">
            <div class="flex flex-wrap items-center gap-3">
                <a href="/" class="text-gray-400 hover:text-teal-600 transition flex items-center gap-1.5 text-xs md:text-sm font-bold touch-target">
                    <i class="fas fa-home"></i> í™ˆìœ¼ë¡œ
                </a>
                <a href="/mypage/messages" class="text-gray-400 hover:text-teal-600 transition flex items-center gap-1.5 text-xs md:text-sm font-bold touch-target">
                    <i class="fas fa-envelope"></i> ë‚´ ë©”ì‹œì§€
                    {% if unread_message_count and unread_message_count > 0 %}<span class="bg-teal-500 text-white text-[10px] px-1.5 py-0.5 rounded-full">{{ unread_message_count }}</span>{% endif %}
                </a>
                <a href="/mypage/reviews" class="text-gray-400 hover:text-teal-600 transition flex items-center gap-1.5 text-xs md:text-sm font-bold touch-target">
                    <i class="fas fa-star"></i> ë¦¬ë·°ê´€ë¦¬
                </a>
                <a href="/mypage/points" class="text-gray-400 hover:text-teal-600 transition flex items-center gap-1.5 text-xs md:text-sm font-bold touch-target">
                    <i class="fas fa-coins"></i> í¬ì¸íŠ¸ ë‚´ì—­
                </a>
                <a href="/logout" class="text-gray-400 hover:text-red-500 transition flex items-center gap-1.5 text-xs md:text-sm font-black touch-target">
                    ë¡œê·¸ì•„ì›ƒ <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
            {% if not push_already_set %}
            <div id="push-enable-block" class="p-4 bg-teal-50/50 border border-teal-100 rounded-2xl text-left">
                <p class="text-[11px] md:text-xs text-teal-800 font-bold mb-2">ì•Œë¦¼ í—ˆìš© ì‹œ ì´ë²¤íŠ¸ ë° ë°°ì†¡ í˜„í™©ì„ ì•ˆë‚´ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <button type="button" id="push-enable-btn" class="touch-target px-4 py-2.5 bg-teal-600 text-white rounded-xl text-xs font-black hover:bg-teal-700 transition">ì•Œë¦¼ ì¼œê¸°</button>
                <span id="push-enable-status" class="ml-3 text-xs text-gray-500"></span>
            </div>
            {% endif %}
        </div>

        <div class="bg-white rounded-2xl md:rounded-[2.5rem] shadow-sm border border-gray-100 mb-8 md:mb-10 overflow-hidden">
            <div class="p-6 md:p-12">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 md:gap-6 mb-8 md:mb-10">
                    <div class="text-left w-full">
                        <span class="bg-teal-100 text-teal-700 text-[10px] px-3 py-1 rounded-lg tracking-widest uppercase mb-2 inline-block font-black">ìš°ìˆ˜ íšŒì›</span>
                        <h2 class="text-2xl md:text-4xl font-black text-gray-800 leading-tight">
                            {{ mypage_name }} <span class="text-gray-400 font-medium text-lg md:text-xl">ë‹˜</span>
                        </h2>
                        <p class="text-gray-400 text-xs md:text-sm mt-1 font-bold break-all">{{ mypage_email }}</p>
                    </div>
                    <button type="button" onclick="toggleAddressEdit()" id="edit-btn" class="touch-target bg-gray-50 text-gray-600 px-5 py-3 rounded-xl text-xs md:text-sm font-black hover:bg-gray-100 transition border border-gray-100 shrink-0">
                        {% if need_address %}<i class="fas fa-times"></i> ì·¨ì†Œ{% else %}<i class="fas fa-edit mr-1"></i> ì£¼ì†Œ ìˆ˜ì •{% endif %}
                    </button>
                </div>

                <div class="pt-8 border-t border-gray-50 text-left">
                    {% if need_address %}
                    <div class="mb-4 p-4 bg-amber-50 border border-amber-200 rounded-2xl text-amber-800 font-black text-sm flex items-center gap-2">
                        <i class="fas fa-map-marker-alt"></i> ì£¼ì†Œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.
                    </div>
                    {% endif %}
                    <div id="address-display" class="grid grid-cols-1 md:grid-cols-2 gap-4 {% if need_address %}hidden{% endif %}">
                        <div class="bg-gray-50/50 p-5 md:p-6 rounded-2xl md:rounded-3xl border border-gray-50 text-left">
                            <p class="text-[10px] text-gray-400 uppercase mb-2 tracking-widest font-black">ê¸°ë³¸ ë°°ì†¡ì§€</p>
                            <p class="text-gray-700 text-sm md:text-base leading-snug font-black break-keep">
                                {{ mypage_address or 'ì •ë³´ ì—†ìŒ' }}<br>
                                <span class="text-gray-400 text-xs md:text-sm font-bold">{{ mypage_address_detail or '' }}</span>
                            </p>
                        </div>
                        <div class="bg-orange-50/30 p-5 md:p-6 rounded-2xl md:rounded-3xl border border-orange-50 text-left">
                            <p class="text-[10px] text-orange-400 uppercase mb-2 tracking-widest font-black">ê³µë™í˜„ê´€ ë¹„ë°€ë²ˆí˜¸</p>
                            <p class="text-orange-600 text-base md:text-lg flex items-center gap-2 font-black">
                                <span class="text-xl md:text-2xl">ğŸ”‘</span> {{ mypage_entrance_pw or 'ë¯¸ë“±ë¡' }}
                            </p>
                        </div>
                    </div>

                    <form id="address-edit-form" action="/mypage/update_address" method="POST" class="space-y-4 {% if not need_address %}hidden{% endif %}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                            <div class="space-y-3">
                                <div class="flex gap-2">
                                    <input id="address" name="address" value="{{ mypage_address or '' }}" class="flex-1 min-w-0 p-4 md:p-5 bg-gray-50 rounded-xl md:rounded-2xl text-xs md:text-sm font-black border border-gray-100" readonly onclick="execDaumPostcode()" placeholder="ì£¼ì†Œ ê²€ìƒ‰">
                                    <button type="button" onclick="execDaumPostcode()" class="touch-target shrink-0 bg-gray-800 text-white px-4 md:px-6 rounded-xl md:rounded-2xl text-xs font-black">ê²€ìƒ‰</button>
                                </div>
                                <input id="address_detail" name="address_detail" value="{{ mypage_address_detail or '' }}" class="w-full p-4 md:p-5 bg-gray-50 rounded-xl md:rounded-2xl text-xs md:text-sm font-black border border-gray-100" required placeholder="ìƒì„¸ì£¼ì†Œ (ë™/í˜¸ìˆ˜)">
                            </div>
                            <div class="space-y-3">
                                <input name="entrance_pw" value="{{ mypage_entrance_pw or '' }}" class="w-full p-4 md:p-5 bg-orange-50 rounded-xl md:rounded-2xl text-xs md:text-sm font-black border border-orange-100" required placeholder="ê³µë™í˜„ê´€ ë¹„ë°€ë²ˆí˜¸">
                                <div class="flex gap-2">
                                    <button type="button" onclick="toggleAddressEdit()" class="flex-1 touch-target py-4 md:py-5 bg-gray-100 text-gray-500 rounded-xl md:rounded-2xl text-xs md:text-sm font-black">ì·¨ì†Œ</button>
                                    <button type="submit" class="flex-[2] touch-target py-4 md:py-5 bg-teal-600 text-white rounded-xl md:rounded-2xl text-xs md:text-sm font-black shadow-lg">ì €ì¥í•˜ê¸°</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <a href="/mypage/points" class="block mb-8 p-5 md:p-6 rounded-2xl border border-gray-100 bg-white hover:shadow-md transition text-left touch-target">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <span class="w-12 h-12 rounded-xl bg-teal-50 flex items-center justify-center shrink-0"><i class="fas fa-coins text-teal-600 text-xl"></i></span>
                    <div>
                        <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">ë³´ìœ  í¬ì¸íŠ¸</p>
                        <p class="text-xl font-black text-gray-800">{{ mypage_points }} P</p>
                    </div>
                </div>
                <span class="text-teal-600 text-sm font-black">ì ë¦½/ì‚¬ìš© ë‚´ì—­ <i class="fas fa-chevron-right ml-1"></i></span>
            </div>
        </a>

        <h3 class="text-lg md:text-2xl font-black text-gray-800 mb-4 md:mb-6 flex items-center gap-3 px-1 text-left">
            <span class="w-1.5 h-6 md:h-8 bg-blue-500 rounded-full shrink-0"></span> ìµœê·¼ ì£¼ë¬¸ ìƒí’ˆ
        </h3>
        <div class="mb-8 overflow-x-auto rounded-2xl border border-gray-100 bg-white shadow-sm">
            <table class="w-full text-left text-sm font-black min-w-[280px]">
                <thead>
                    <tr class="bg-gray-50 border-b border-gray-100">
                        <th class="py-3 px-4 text-[10px] uppercase text-gray-500 font-black">ì£¼ë¬¸ì¼</th>
                        <th class="py-3 px-4 text-[10px] uppercase text-gray-500 font-black">ìƒí’ˆëª…</th>
                        <th class="py-3 px-4 text-[10px] uppercase text-gray-500 font-black">ì¹´í…Œê³ ë¦¬</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in recent_items_with_date %}
                    <tr class="border-b border-gray-50 hover:bg-gray-50/50 transition">
                        <td class="py-3 px-4 text-[10px] text-gray-500">{{ row.order_date.strftime('%Y.%m.%d') if row.order_date else '-' }}</td>
                        <td class="py-3 px-4 text-gray-800 truncate max-w-[180px]">{{ row.item.product_name }}</td>
                        <td class="py-3 px-4">
                            <a href="/category/{{ row.item.product_category }}" class="text-teal-600 hover:underline font-bold">{{ row.item.product_category }}</a>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="3" class="py-8 text-center text-gray-400 text-sm">ìµœê·¼ ì£¼ë¬¸ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <h3 class="text-lg md:text-2xl font-black text-gray-800 mb-4 md:mb-6 flex items-center gap-3 px-1 text-left">
            <span class="w-1.5 h-6 md:h-8 bg-teal-500 rounded-full shrink-0"></span> ìµœê·¼ ì£¼ë¬¸ ë‚´ì—­
        </h3>
        <div class="mb-6 flex flex-col sm:flex-row gap-3">
            <input type="text" id="mypage-order-search" placeholder="ì£¼ë¬¸ ê²€ìƒ‰ (ìƒí’ˆëª…, ì£¼ë¬¸ë²ˆí˜¸, ìƒíƒœ)" class="flex-1 min-w-0 px-4 py-2.5 rounded-xl border border-gray-200 text-sm font-medium placeholder-gray-400 focus:ring-2 focus:ring-teal-500/20 focus:border-teal-300 outline-none transition">
        </div>

        <div class="space-y-4 md:space-y-6 text-left" id="mypage-orders-wrap">
            {% if recent_orders or older_orders %}
                <div id="mypage-orders-recent" class="space-y-4 md:space-y-6">
                {% for o in recent_orders %}
                <div class="mypage-order-card bg-white p-5 md:p-8 rounded-2xl md:rounded-[2.5rem] border border-gray-100 transition-all hover:shadow-md text-left" data-order-search="{{ (o.order_id or '') }} {{ (o.display_summary or o.product_details or '') }} {{ (o.status or '') }} {{ o.created_at.strftime('%Y.%m.%d') if o.created_at else '' }}">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 md:gap-4 mb-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 md:gap-3 mb-2 flex-wrap">
                                <span class="text-[10px] md:text-xs text-gray-400 font-bold">{{ o.created_at.strftime('%Y.%m.%d') }}</span>
                                <span class="text-[10px] md:text-xs font-black {% if o.status == 'ê²°ì œì·¨ì†Œ' %}text-red-400{% else %}text-teal-500{% endif %}">[{{ o.status }}]</span>
                            </div>
                            <p class="text-sm md:text-xl font-black text-gray-700 leading-tight break-keep">
                                {{ (o.display_summary or o.product_details or 'ì£¼ë¬¸ ì·¨ì†Œë¨')[:80] }}{% if (o.display_summary or o.product_details or '')|length > 80 %}...{% endif %}
                            </p>
                        </div>
                        <div class="flex items-center gap-3 md:gap-4 flex-wrap shrink-0">
                            <span class="text-base md:text-2xl font-black text-gray-800 tracking-tighter">{{ "{:,}".format(o.total_price) }}ì›</span>
                            <div class="flex gap-2">
                                <button onclick='openReceiptModal({{ o.id }}, {{ o.enhanced_details | tojson }}, "{{ o.total_price }}", {{ (o.delivery_address or "") | tojson }}, "{{ o.order_id }}", "{{ o.delivery_fee }}")' class="text-xs font-black text-gray-400 bg-gray-50 px-4 py-2.5 rounded-xl border border-gray-100 hover:bg-gray-100 transition">ì˜ìˆ˜ì¦</button>
                                {% if o.status == 'ê²°ì œì™„ë£Œ' %}
                                    {% set existing_review = Review.query.filter_by(order_id=o.id).first() %}
                                    {% if existing_review %}
                                        <button class="text-xs font-black text-gray-300 bg-gray-50 px-4 py-2.5 rounded-xl border border-gray-100 cursor-not-allowed" disabled>ì‘ì„±ì™„ë£Œ</button>
                                    {% else %}
                                        <button onclick='openReviewModal({{ o.id }}, "{{ (o.product_details or "")[:80]|e }}")' class="text-xs font-black text-orange-500 bg-orange-50 px-4 py-2.5 rounded-xl border border-orange-100 hover:bg-orange-100 transition shadow-sm">í›„ê¸°ì‘ì„±</button>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% if o.order_items %}
                    <div class="border-t border-gray-100 pt-4 mt-4 space-y-2">
                        <p class="text-[10px] text-gray-400 font-black uppercase tracking-widest mb-2">í’ˆëª©ë³„ ìƒíƒœ</p>
                        {% for oi in o.order_items %}
                        <div class="flex flex-wrap items-center justify-between gap-2 py-2 {% if oi.cancelled %}opacity-60{% endif %}">
                            <div class="flex-1 min-w-0">
                                <span class="{% if oi.cancelled %}line-through text-gray-400{% else %}text-gray-700 font-bold{% endif %}">{{ oi.product_name }} Ã— {{ oi.quantity }} â€” {{ "{:,}".format(oi.price * oi.quantity) }}ì›</span>
                                {% if oi.item_status and oi.item_status not in ('ê²°ì œì™„ë£Œ', '') %}
                                <span class="ml-2 text-[10px] font-black {% if oi.item_status == 'í’ˆì ˆì·¨ì†Œ' or oi.item_status == 'ë¶€ë¶„ì·¨ì†Œ' %}text-red-500{% elif oi.item_status == 'ë°°ì†¡ì§€ì—°' %}text-amber-600{% else %}text-teal-600{% endif %}">[{{ oi.item_status }}]</span>
                                {% endif %}
                                {% if oi.status_message %}
                                <p class="text-[10px] text-gray-500 mt-0.5">{{ oi.status_message }}</p>
                                {% endif %}
                            </div>
                            {% if oi.cancelled %}
                                <span class="text-red-500 text-xs font-black">ì·¨ì†Œë¨</span>
                            {% elif o.status == 'ê²°ì œì™„ë£Œ' and (not oi.item_status or oi.item_status == 'ê²°ì œì™„ë£Œ') %}
                                <form action="/order/cancel_item/{{ o.id }}/{{ oi.id }}" method="POST" class="inline" onsubmit="return confirm('ì´ í’ˆëª©ë§Œ ì·¨ì†Œí•˜ê³  í•´ë‹¹ ê¸ˆì•¡ì„ í™˜ë¶ˆë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?');">
                                    <button type="submit" class="text-xs font-black text-red-500 bg-red-50 px-3 py-1.5 rounded-lg border border-red-100 hover:bg-red-100 transition">í’ˆëª© ì·¨ì†Œ</button>
                                </form>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% if o.can_cancel_order %}
                        <form action="/order/cancel/{{ o.id }}" method="POST" class="pt-2 border-t border-gray-100" onsubmit="return confirm('ì£¼ë¬¸ ì „ì²´ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                            <button type="submit" class="text-xs font-black text-gray-500 bg-gray-100 px-4 py-2 rounded-xl hover:bg-gray-200 transition">ì „ì²´ ì£¼ë¬¸ ì·¨ì†Œ</button>
                        </form>
                        {% else %}
                        <p class="pt-2 border-t border-gray-100 text-[10px] text-amber-600 font-black">ë°°ì†¡ ìš”ì²­/ì§„í–‰ëœ í’ˆëª©ì´ ìˆì–´ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                        {% endif %}
                    </div>
                    {% elif o.status == 'ê²°ì œì™„ë£Œ' and o.can_cancel_order %}
                    <div class="border-t border-gray-100 pt-4 mt-4">
                        <form action="/order/cancel/{{ o.id }}" method="POST" class="inline" onsubmit="return confirm('ì£¼ë¬¸ ì „ì²´ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                            <button type="submit" class="text-xs font-black text-red-500 bg-red-50 px-4 py-2 rounded-xl border border-red-100 hover:bg-red-100 transition">ì „ì²´ ì£¼ë¬¸ ì·¨ì†Œ</button>
                        </form>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                </div>
                {% if older_orders %}
                <div class="mt-6 pt-6 border-t border-gray-100">
                    <button type="button" id="mypage-orders-more-btn" class="w-full py-4 rounded-2xl bg-gray-100 text-gray-600 font-black text-sm hover:bg-gray-200 transition">
                        ëª©ë¡ ë”ë³´ê¸° (1ì£¼ì¼ ì´ì „ ì£¼ë¬¸ {{ older_orders|length }}ê±´)
                    </button>
                    <div id="mypage-orders-older" class="hidden space-y-4 md:space-y-6 mt-6">
                    {% for o in older_orders %}
                    <div class="mypage-order-card mypage-order-older bg-white p-5 md:p-8 rounded-2xl md:rounded-[2.5rem] border border-gray-100 transition-all hover:shadow-md text-left" data-order-search="{{ (o.order_id or '') }} {{ (o.display_summary or o.product_details or '') }} {{ (o.status or '') }} {{ o.created_at.strftime('%Y.%m.%d') if o.created_at else '' }}">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 md:gap-4 mb-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 md:gap-3 mb-2 flex-wrap">
                                <span class="text-[10px] md:text-xs text-gray-400 font-bold">{{ o.created_at.strftime('%Y.%m.%d') if o.created_at else '' }}</span>
                                <span class="text-[10px] md:text-xs font-black {% if o.status == 'ê²°ì œì·¨ì†Œ' %}text-red-400{% else %}text-teal-500{% endif %}">[{{ o.status }}]</span>
                            </div>
                            <p class="text-sm md:text-xl font-black text-gray-700 leading-tight break-keep">
                                {{ (o.display_summary or o.product_details or 'ì£¼ë¬¸ ì·¨ì†Œë¨')[:80] }}{% if (o.display_summary or o.product_details or '')|length > 80 %}...{% endif %}
                            </p>
                        </div>
                        <div class="flex items-center gap-3 md:gap-4 flex-wrap shrink-0">
                            <span class="text-base md:text-2xl font-black text-gray-800 tracking-tighter">{{ "{:,}".format(o.total_price) }}ì›</span>
                            <div class="flex gap-2">
                                <button onclick='openReceiptModal({{ o.id }}, {{ o.enhanced_details | tojson }}, "{{ o.total_price }}", {{ (o.delivery_address or "") | tojson }}, "{{ o.order_id }}", "{{ o.delivery_fee }}")' class="text-xs font-black text-gray-400 bg-gray-50 px-4 py-2.5 rounded-xl border border-gray-100 hover:bg-gray-100 transition">ì˜ìˆ˜ì¦</button>
                                {% if o.status == 'ê²°ì œì™„ë£Œ' %}
                                    {% set existing_review = Review.query.filter_by(order_id=o.id).first() %}
                                    {% if existing_review %}
                                        <button class="text-xs font-black text-gray-300 bg-gray-50 px-4 py-2.5 rounded-xl border border-gray-100 cursor-not-allowed" disabled>ì‘ì„±ì™„ë£Œ</button>
                                    {% else %}
                                        <button onclick='openReviewModal({{ o.id }}, "{{ (o.product_details or "")[:80]|e }}")' class="text-xs font-black text-orange-500 bg-orange-50 px-4 py-2.5 rounded-xl border border-orange-100 hover:bg-orange-100 transition shadow-sm">í›„ê¸°ì‘ì„±</button>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% if o.order_items %}
                    <div class="border-t border-gray-100 pt-4 mt-4 space-y-2">
                        <p class="text-[10px] text-gray-400 font-black uppercase tracking-widest mb-2">í’ˆëª©ë³„ ìƒíƒœ</p>
                        {% for oi in o.order_items %}
                        <div class="flex flex-wrap items-center justify-between gap-2 py-2 {% if oi.cancelled %}opacity-60{% endif %}">
                            <div class="flex-1 min-w-0">
                                <span class="{% if oi.cancelled %}line-through text-gray-400{% else %}text-gray-700 font-bold{% endif %}">{{ oi.product_name }} Ã— {{ oi.quantity }} â€” {{ "{:,}".format(oi.price * oi.quantity) }}ì›</span>
                                {% if oi.item_status and oi.item_status not in ('ê²°ì œì™„ë£Œ', '') %}
                                <span class="ml-2 text-[10px] font-black {% if oi.item_status == 'í’ˆì ˆì·¨ì†Œ' or oi.item_status == 'ë¶€ë¶„ì·¨ì†Œ' %}text-red-500{% elif oi.item_status == 'ë°°ì†¡ì§€ì—°' %}text-amber-600{% else %}text-teal-600{% endif %}">[{{ oi.item_status }}]</span>
                                {% endif %}
                                {% if oi.status_message %}
                                <p class="text-[10px] text-gray-500 mt-0.5">{{ oi.status_message }}</p>
                                {% endif %}
                            </div>
                            {% if oi.cancelled %}
                                <span class="text-red-500 text-xs font-black">ì·¨ì†Œë¨</span>
                            {% elif o.status == 'ê²°ì œì™„ë£Œ' and (not oi.item_status or oi.item_status == 'ê²°ì œì™„ë£Œ') %}
                                <form action="/order/cancel_item/{{ o.id }}/{{ oi.id }}" method="POST" class="inline" onsubmit="return confirm('ì´ í’ˆëª©ë§Œ ì·¨ì†Œí•˜ê³  í•´ë‹¹ ê¸ˆì•¡ì„ í™˜ë¶ˆë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?');">
                                    <button type="submit" class="text-xs font-black text-red-500 bg-red-50 px-3 py-1.5 rounded-lg border border-red-100 hover:bg-red-100 transition">í’ˆëª© ì·¨ì†Œ</button>
                                </form>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% if o.can_cancel_order %}
                        <form action="/order/cancel/{{ o.id }}" method="POST" class="pt-2 border-t border-gray-100" onsubmit="return confirm('ì£¼ë¬¸ ì „ì²´ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                            <button type="submit" class="text-xs font-black text-gray-500 bg-gray-100 px-4 py-2 rounded-xl hover:bg-gray-200 transition">ì „ì²´ ì£¼ë¬¸ ì·¨ì†Œ</button>
                        </form>
                        {% else %}
                        <p class="pt-2 border-t border-gray-100 text-[10px] text-amber-600 font-black">ë°°ì†¡ ìš”ì²­/ì§„í–‰ëœ í’ˆëª©ì´ ìˆì–´ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                        {% endif %}
                    </div>
                    {% elif o.status == 'ê²°ì œì™„ë£Œ' and o.can_cancel_order %}
                    <div class="border-t border-gray-100 pt-4 mt-4">
                        <form action="/order/cancel/{{ o.id }}" method="POST" class="inline" onsubmit="return confirm('ì£¼ë¬¸ ì „ì²´ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                            <button type="submit" class="text-xs font-black text-red-500 bg-red-50 px-4 py-2 rounded-xl border border-red-100 hover:bg-red-100 transition">ì „ì²´ ì£¼ë¬¸ ì·¨ì†Œ</button>
                        </form>
                    </div>
                    {% endif %}
                </div>
                    {% endfor %}
                    </div>
                    <button type="button" id="mypage-orders-fold-btn" class="hidden w-full mt-4 py-3 rounded-xl bg-gray-100 text-gray-500 font-bold text-xs hover:bg-gray-200 transition">ëª©ë¡ ì ‘ê¸°</button>
                </div>
                {% endif %}
            {% else %}
                <div class="py-32 text-center bg-white rounded-[2.5rem] border-2 border-dashed border-gray-100">
                    <p class="text-gray-300 text-lg font-black">ì•„ì§ ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. ğŸ˜Š</p>
                </div>
            {% endif %}
        </div>
    </div>

    <div id="receipt-modal" class="fixed inset-0 bg-black/60 z-[6000] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div id="printable-receipt" class="bg-white w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl animate-in zoom-in duration-200 flex flex-col">
            <div class="p-5 bg-gray-50 border-b border-gray-100 flex justify-between items-center no-print">
                <h4 class="text-xs font-black uppercase tracking-widest text-gray-500">ì‹ ìš©ì¹´ë“œ ë§¤ì¶œì „í‘œ</h4>
                <button onclick="closeReceiptModal()" class="text-gray-300 text-2xl hover:text-black transition">âœ•</button>
            </div>
            
            <div class="p-8 space-y-8 text-left bg-white">
                <div class="text-center border-b-2 border-gray-800 pb-6">
                    <h3 class="text-2xl font-black text-gray-900 mb-2 italic">ë°”êµ¬ë‹ˆì‚¼ì´Œ</h3>
                    <div class="text-[10px] text-gray-500 font-bold space-y-1">
                        <p>ì‚¬ì—…ìë²ˆí˜¸: 472-93-02262</p>
                        <p>ëŒ€í‘œ: ê¸ˆì°½ê¶Œ | ê³ ê°ì„¼í„°: 1666-8320</p>
                        <p>ì¸ì²œê´‘ì—­ì‹œ ì—°ìˆ˜êµ¬ í•˜ëª¨ë‹ˆë¡œ158, Dë™ 317í˜¸</p>
                    </div>
                </div>

                <div class="space-y-5 font-bold">
                    <div class="flex justify-between text-xs font-black"><span class="text-gray-400">ì£¼ë¬¸ë²ˆí˜¸</span><span id="modal-order-id" class="text-gray-700"></span></div>
                    <div>
                        <p class="text-[10px] text-gray-400 uppercase font-black mb-2 tracking-widest">êµ¬ë§¤ ë‚´ì—­</p>
                        <p id="modal-items" class="text-gray-800 text-sm leading-relaxed whitespace-pre-wrap border-y border-gray-50 py-4 font-black"></p>
                    </div>
                    <div>
                        <p class="text-[10px] text-gray-400 uppercase font-black mb-2 tracking-widest">ë°°ì†¡ì§€</p>
                        <p id="modal-address" class="text-gray-700 text-xs font-black"></p>
                    </div>
                </div>

                <div class="pt-6 border-t-4 border-double border-gray-200 flex justify-between items-center">
                    <span class="text-base font-black text-gray-800">í•©ê³„ ê¸ˆì•¡</span>
                    <span id="modal-total" class="text-3xl font-black text-teal-600 italic tracking-tighter"></span>
                </div>
                <div class="text-center opacity-30 pt-4"><p class="text-[9px] font-black uppercase tracking-[0.4em]">ì´ìš©í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤</p></div>
            </div>

            <div class="p-6 bg-gray-50 flex gap-3 no-print">
                <button onclick="closeReceiptModal()" class="flex-1 py-5 bg-gray-200 text-gray-500 rounded-2xl text-sm font-black">ë‹«ê¸°</button>
                <button onclick="printReceipt()" class="flex-[2] py-5 bg-gray-800 text-white rounded-2xl text-sm font-black shadow-lg hover:bg-black transition">ì¶œë ¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="review-modal" class="fixed inset-0 bg-black/60 z-[6000] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] overflow-hidden shadow-2xl">
            <div class="p-6 bg-orange-500 text-white flex justify-between items-center">
                <h4 class="text-base font-black">ğŸ“¸ ì†Œì¤‘í•œ í›„ê¸° ì‘ì„±</h4>
                <button onclick="closeReviewModal()" class="text-white/60 text-2xl hover:text-white transition">âœ•</button>
            </div>
            <form action="/review/add" method="POST" enctype="multipart/form-data" class="p-8 space-y-6 text-left">
                <input type="hidden" name="order_id" id="review-order-id">
                <input type="hidden" name="rating" id="review-rating-value" value="5">
                <div>
                    <p id="review-product-name" class="text-gray-800 font-black text-sm mb-4"></p>
                    <div class="flex gap-2 text-3xl text-gray-200" id="star-rating-container">
                        {% for i in range(1, 6) %}<i class="fas fa-star cursor-pointer transition-colors" data-value="{{i}}"></i>{% endfor %}
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] text-gray-400 font-black ml-2 uppercase">ì‚¬ì§„ ì²¨ë¶€ (ì„ íƒ)</label>
                    <input type="file" name="review_image" id="review_image_input" class="w-full text-xs p-4 bg-gray-50 rounded-2xl border border-dashed border-gray-200" accept="image/*">
                    <div id="review_image_preview" class="hidden mt-2 rounded-xl overflow-hidden bg-gray-100 border border-gray-200 max-h-32"><img id="review_image_preview_img" src="" alt="" class="w-full h-full object-contain max-h-32"></div>
                </div>
                <textarea name="content" class="w-full p-5 h-32 bg-gray-50 rounded-2xl border-none text-sm font-black" placeholder="ë§›ê³¼ ì‹ ì„ í•¨ì€ ì–´ë• ë‚˜ìš”? ë‹¤ë¥¸ ì´ì›ƒë“¤ì„ ìœ„í•´ ì†”ì§í•œ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”! ğŸ˜Š" required></textarea>
                <button type="submit" class="w-full py-5 bg-teal-600 text-white rounded-[1.5rem] text-base font-black shadow-xl shadow-teal-100 hover:bg-teal-700 transition">ë“±ë¡ ì™„ë£Œ</button>
            </form>
        </div>
    </div>

    <style>
        @media print {
            .no-print { display: none !important; }
            body * { visibility: hidden; }
            #printable-receipt, #printable-receipt * { visibility: visible; }
            #printable-receipt { position: absolute; left: 0; top: 0; width: 100%; box-shadow: none; border: none; }
        }
    </style>

    <script>
        function toggleAddressEdit() {
            const f = document.getElementById('address-edit-form');
            const d = document.getElementById('address-display');
            const b = document.getElementById('edit-btn');
            const isHidden = f.classList.contains('hidden');
            f.classList.toggle('hidden', !isHidden);
            d.classList.toggle('hidden', isHidden);
            b.innerHTML = isHidden ? '<i class="fas fa-times"></i> ì·¨ì†Œ' : '<i class="fas fa-edit mr-1"></i> ì£¼ì†Œ ìˆ˜ì •';
        }

        function openReceiptModal(id, items, total, address, orderFullId, deliveryFee) {
            document.getElementById('modal-order-id').innerText = orderFullId || ('ORD-' + id);
            let itemText = items.replace(/\\\\n/g, '\\n');
            const fee = parseInt(deliveryFee) || 0;
            if (fee > 0) { itemText += "\\n[ë°°ì†¡ë¹„] --- " + fee.toLocaleString() + "ì›"; }
            else { itemText += "\\n[ë°°ì†¡ë¹„] --- 0ì› (ë¬´ë£Œ)"; }
            document.getElementById('modal-items').innerText = itemText;
            document.getElementById('modal-address').innerText = address;
            document.getElementById('modal-total').innerText = Number(total).toLocaleString() + 'ì›';
            document.getElementById('receipt-modal').classList.remove('hidden');
        }

        function closeReceiptModal() { document.getElementById('receipt-modal').classList.add('hidden'); }
        function printReceipt() { window.print(); }

        const stars = document.querySelectorAll('#star-rating-container i');
        const ratingInput = document.getElementById('review-rating-value');
        stars.forEach(star => {
            star.addEventListener('click', function() {
                ratingInput.value = this.dataset.value;
                updateStars(this.dataset.value);
            });
            star.addEventListener('mouseover', function() { updateStars(this.dataset.value); });
            star.addEventListener('mouseleave', function() { updateStars(ratingInput.value); });
        });
        function updateStars(value) {
            stars.forEach(s => {
                const active = parseInt(s.dataset.value) <= parseInt(value);
                s.classList.toggle('text-orange-400', active);
                s.classList.toggle('text-gray-200', !active);
            });
        }

        function openReviewModal(oid, pName) {
            document.getElementById('review-order-id').value = oid;
            document.getElementById('review-product-name').innerText = pName;
            ratingInput.value = 5; updateStars(5);
            var inp = document.getElementById('review_image_input');
            if (inp) { inp.value = ''; }
            var prev = document.getElementById('review_image_preview');
            if (prev) { prev.classList.add('hidden'); }
            document.getElementById('review-modal').classList.remove('hidden');
        }
        function closeReviewModal() { document.getElementById('review-modal').classList.add('hidden'); }
        var reviewImageInput = document.getElementById('review_image_input');
        if (reviewImageInput) {
            reviewImageInput.addEventListener('change', function() {
                var prev = document.getElementById('review_image_preview');
                var img = document.getElementById('review_image_preview_img');
                if (!prev || !img) return;
                if (this.files && this.files[0]) {
                    var r = new FileReader();
                    r.onload = function(e) { img.src = e.target.result; prev.classList.remove('hidden'); };
                    r.readAsDataURL(this.files[0]);
                } else { prev.classList.add('hidden'); img.src = ''; }
            });
        }

        (function mypageOrdersMore() {
            var moreBtn = document.getElementById('mypage-orders-more-btn');
            var foldBtn = document.getElementById('mypage-orders-fold-btn');
            var olderWrap = document.getElementById('mypage-orders-older');
            if (moreBtn && olderWrap) {
                moreBtn.addEventListener('click', function() {
                    olderWrap.classList.remove('hidden');
                    moreBtn.classList.add('hidden');
                    if (foldBtn) foldBtn.classList.remove('hidden');
                });
            }
            if (foldBtn && olderWrap) {
                foldBtn.addEventListener('click', function() {
                    olderWrap.classList.add('hidden');
                    if (moreBtn) moreBtn.classList.remove('hidden');
                    foldBtn.classList.add('hidden');
                });
            }
            var searchInput = document.getElementById('mypage-order-search');
            var cards = document.querySelectorAll('.mypage-order-card');
            if (searchInput && cards.length) {
                searchInput.addEventListener('input', function() {
                    var q = (this.value || '').trim().toLowerCase();
                    cards.forEach(function(card) {
                        var text = (card.getAttribute('data-order-search') || '').toLowerCase();
                        card.style.display = q === '' || text.indexOf(q) !== -1 ? '' : 'none';
                    });
                    if (q && olderWrap && olderWrap.classList.contains('hidden')) {
                        olderWrap.classList.remove('hidden');
                        if (moreBtn) moreBtn.classList.add('hidden');
                        if (foldBtn) foldBtn.classList.remove('hidden');
                    }
                    if (moreBtn) moreBtn.style.display = olderWrap && olderWrap.classList.contains('hidden') ? '' : 'none';
                    if (foldBtn) foldBtn.style.display = olderWrap && !olderWrap.classList.contains('hidden') ? '' : 'none';
                });
            }
        })();

        (function pushEnable() {
            var block = document.getElementById('push-enable-block');
            var btn = document.getElementById('push-enable-btn');
            var status = document.getElementById('push-enable-status');
            if (!block || !btn) return;
            function setStatus(t, isErr) { if (status) { status.textContent = t; status.className = 'ml-3 text-xs ' + (isErr ? 'text-red-600' : 'text-teal-600'); } }
            btn.addEventListener('click', function() {
                if (!('Notification' in window) || !('serviceWorker' in navigator) || !('PushManager' in window)) {
                    setStatus('Chrome ë˜ëŠ” Safari ì•±ì„ ì—´ê³ , ì£¼ì†Œì°½ì— ì´ ì‚¬ì´íŠ¸ ì£¼ì†Œë¥¼ ì…ë ¥í•´ ì ‘ì†í•œ ë’¤ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”. ì¹´ì¹´ì˜¤Â·ë„¤ì´ë²„ ë“± ì•± ì•ˆì—ì„œ ì—° ì°½ì—ì„œëŠ” í‘¸ì‹œ ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', true); return;
                }
                if (typeof window.isSecureContext !== 'undefined' && !window.isSecureContext) {
                    setStatus('í‘¸ì‹œ ì•Œë¦¼ì€ https ì£¼ì†Œì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì£¼ì†Œê°€ https:// ë¡œ ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.', true); return;
                }
                if (Notification.permission === 'denied') { setStatus('ì•Œë¦¼ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš©í•´ ì£¼ì„¸ìš”.', true); return; }
                setStatus('ì²˜ë¦¬ ì¤‘...', false);
                fetch('/api/push/vapid-public').then(function(r) { return r.json(); }).then(function(d) {
                    if (d.error || !d.publicKey) { setStatus('ì•Œë¦¼ ê¸°ëŠ¥ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', true); return; }
                    var key = d.publicKey.replace(/-/g, '+').replace(/_/g, '/');
                    var keyBytes = new Uint8Array(atob(key).split('').map(function(c) { return c.charCodeAt(0); }));
                    return navigator.serviceWorker.ready.then(function(reg) {
                        return reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: keyBytes });
                    }).then(function(sub) {
                        function abToB64Url(buf) { var b = new Uint8Array(buf); var s = ''; for (var i = 0; i < b.length; i++) s += String.fromCharCode(b[i]); return btoa(s).replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/, ''); }
                        var subJson = { endpoint: sub.endpoint, keys: { p256dh: abToB64Url(sub.getKey('p256dh')), auth: abToB64Url(sub.getKey('auth')) } };
                        return fetch('/api/push/subscribe', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ subscription: subJson }), credentials: 'same-origin' });
                    }).then(function(r) { return r.json(); }).then(function(d) {
                        if (d.success) { setStatus('ì•Œë¦¼ì´ ì¼œì¡ŒìŠµë‹ˆë‹¤.'); btn.disabled = true; btn.textContent = 'ì•Œë¦¼ ì¼œì§'; } else { setStatus(d.message || 'ë“±ë¡ ì‹¤íŒ¨', true); }
                    });
                }).catch(function() { setStatus('ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ìŠµë‹ˆë‹¤.', true); });
            });
        })();
    </script>
    """
    return render_template_string(HEADER_HTML + content + FOOTER_HTML, recent_orders=recent_orders, older_orders=older_orders, recent_items_with_date=recent_items_with_date, Review=Review, unread_message_count=unread_message_count, push_already_set=push_already_set, need_address=need_address, from_cart=from_cart, mypage_name=mypage_name, mypage_email=mypage_email, mypage_address=mypage_address, mypage_address_detail=mypage_address_detail, mypage_entrance_pw=mypage_entrance_pw, mypage_points=mypage_points)
def _recalc_order_from_items(order):
    """OrderItem ê¸°ì¤€ìœ¼ë¡œ ì£¼ë¬¸ í•©ê³„Â·ë°°ì†¡ë¹„Â·product_details ì¬ê³„ì‚° (ì·¨ì†Œ ë°˜ì˜)"""
    remaining = OrderItem.query.filter_by(order_id=order.id, cancelled=False).all()
    if not remaining:
        order.status = 'ê²°ì œì·¨ì†Œ'
        order.product_details = ''
        order.total_price = 0
        order.delivery_fee = 0
        order.tax_free_amount = 0
        return
    cat_groups = {}
    for oi in remaining:
        cat_groups.setdefault(oi.product_category, []).append(f"{oi.product_name}({oi.quantity})")
    order.product_details = " | ".join([f"[{cat}] {', '.join(prods)}" for cat, prods in cat_groups.items()])
    cat_price_sums = {}
    for oi in remaining:
        cat_price_sums[oi.product_category] = cat_price_sums.get(oi.product_category, 0) + (oi.price * oi.quantity)
    order.delivery_fee = sum(1900 + (1900 if amt >= 50000 else 0) for amt in cat_price_sums.values())
    order.total_price = sum(oi.price * oi.quantity for oi in remaining) + order.delivery_fee
    order.tax_free_amount = sum(oi.price * oi.quantity for oi in remaining if oi.tax_type == 'ë©´ì„¸')

@app.route('/order/cancel_item/<int:order_id>/<int:item_id>', methods=['POST'])
@login_required
def order_cancel_item(order_id, item_id):
    """í’ˆëª©ë³„ ë¶€ë¶„ ì·¨ì†Œ (í† ìŠ¤ ë¶€ë¶„ ì·¨ì†Œ API í˜¸ì¶œ)"""
    order = Order.query.get_or_404(order_id)
    if order.user_id != current_user.id:
        flash("ë³¸ì¸ ì£¼ë¬¸ë§Œ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return redirect('/mypage')
    if order.status != 'ê²°ì œì™„ë£Œ':
        flash("ì·¨ì†Œ ê°€ëŠ¥í•œ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤."); return redirect('/mypage')
    oi = OrderItem.query.filter_by(id=item_id, order_id=order_id).first()
    if not oi or oi.cancelled:
        flash("í•´ë‹¹ í’ˆëª©ì„ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return redirect('/mypage')
    if getattr(oi, 'item_status', None) in ('ë°°ì†¡ìš”ì²­', 'ë°°ì†¡ì¤‘', 'ë°°ì†¡ì™„ë£Œ'):
        flash("ë°°ì†¡ ìš”ì²­/ì§„í–‰ëœ í’ˆëª©ì€ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return redirect('/mypage')

    cancel_amount = oi.price * oi.quantity
    tax_free_cancel = (oi.price * oi.quantity) if (oi.tax_type == 'ë©´ì„¸') else 0

    # í† ìŠ¤í˜ì´ë¨¼ì¸  ë¶€ë¶„ ì·¨ì†Œ API
    if order.payment_key:
        url = f"https://api.tosspayments.com/v1/payments/{order.payment_key}/cancel"
        auth_key = base64.b64encode(f"{TOSS_SECRET_KEY}:".encode()).decode()
        body = {"cancelAmount": cancel_amount, "cancelReason": "í’ˆëª© ë¶€ë¶„ ì·¨ì†Œ"}
        if tax_free_cancel:
            body["taxFreeAmount"] = tax_free_cancel
        res = requests.post(url, json=body, headers={"Authorization": f"Basic {auth_key}", "Content-Type": "application/json"})
        if res.status_code not in (200, 201):
            try:
                err = res.json()
                flash(err.get("message", "í™˜ë¶ˆ ìš”ì²­ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê³ ê°ì„¼í„°ë¡œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”."))
            except Exception:
                flash("í™˜ë¶ˆ ìš”ì²­ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê³ ê°ì„¼í„°ë¡œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.")
            return redirect('/mypage')

    oi.cancelled = True
    oi.item_status = 'ë¶€ë¶„ì·¨ì†Œ'
    p = Product.query.get(oi.product_id)
    if p:
        p.stock += oi.quantity
    _recalc_order_from_items(order)
    db.session.commit()
    title, body = get_template_content('part_cancelled', order_id=order.order_id)
    send_message(order.user_id, title, body, 'part_cancelled', order.id)
    db.session.commit()
    flash("í•´ë‹¹ í’ˆëª©ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. í™˜ë¶ˆì€ ì¹´ë“œì‚¬ ì •ì±…ì— ë”°ë¼ 3~7ì¼ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    return redirect('/mypage')

@app.route('/order/cancel/<int:oid>', methods=['POST'])
@login_required
def order_cancel(oid):
    """ì „ì•¡ ê²°ì œ ì·¨ì†Œ (ì¬ê³  ë³µêµ¬ + í† ìŠ¤ ì „ì•¡ ì·¨ì†Œ)"""
    order = Order.query.get_or_404(oid)
    if order.user_id != current_user.id: return redirect('/mypage')
    if order.status != 'ê²°ì œì™„ë£Œ':
        flash("ì·¨ì†Œ ê°€ëŠ¥í•œ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤. ì´ë¯¸ ë°°ì†¡ì´ ì‹œì‘ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return redirect('/mypage')
    order_items_check = OrderItem.query.filter_by(order_id=order.id).all()
    if order_items_check and any(not getattr(oi, 'cancelled', False) and getattr(oi, 'item_status', None) in ('ë°°ì†¡ìš”ì²­', 'ë°°ì†¡ì¤‘', 'ë°°ì†¡ì™„ë£Œ') for oi in order_items_check):
        flash("ë°°ì†¡ ìš”ì²­/ì§„í–‰ëœ í’ˆëª©ì´ ìˆì–´ ì£¼ë¬¸ ì „ì²´ ì·¨ì†Œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤."); return redirect('/mypage')

    # í† ìŠ¤í˜ì´ë¨¼ì¸  ì „ì•¡ ì·¨ì†Œ
    if order.payment_key and order.total_price and order.total_price > 0:
        url = f"https://api.tosspayments.com/v1/payments/{order.payment_key}/cancel"
        auth_key = base64.b64encode(f"{TOSS_SECRET_KEY}:".encode()).decode()
        res = requests.post(url, json={"cancelReason": "ì£¼ë¬¸ ì „ì•¡ ì·¨ì†Œ"}, headers={"Authorization": f"Basic {auth_key}", "Content-Type": "application/json"})
        if res.status_code not in (200, 201):
            try:
                err = res.json()
                flash(err.get("message", "í™˜ë¶ˆ ìš”ì²­ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê³ ê°ì„¼í„°ë¡œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”."))
            except Exception:
                flash("í™˜ë¶ˆ ìš”ì²­ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê³ ê°ì„¼í„°ë¡œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.")
            return redirect('/mypage')

    order.status = 'ê²°ì œì·¨ì†Œ'
    title, body = get_template_content('order_cancelled', order_id=order.order_id)
    send_message(order.user_id, title, body, 'order_cancelled', order.id)
    # ì¬ê³  ë³µêµ¬: OrderItem ìˆìœ¼ë©´ í’ˆëª©ë³„, ì—†ìœ¼ë©´ product_details íŒŒì‹±
    order_items = OrderItem.query.filter_by(order_id=order.id).all()
    if order_items:
        for oi in order_items:
            if not oi.cancelled:
                p = Product.query.get(oi.product_id)
                if p: p.stock += oi.quantity
        for oi in order_items:
            oi.cancelled = True
    else:
        try:
            parts = order.product_details.split(' | ')
            for part in parts:
                item_match = re.search(r'\] (.*?)\((\d+)\)', part)
                if item_match:
                    p_name, qty = item_match.groups()
                    p = Product.query.filter_by(name=p_name.strip()).first()
                    if p: p.stock += int(qty)
        except Exception as e:
            print(f"Stock recovery error: {str(e)}")
    db.session.commit()
    flash("ê²°ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. í™˜ë¶ˆì€ ì¹´ë“œì‚¬ ì •ì±…ì— ë”°ë¼ 3~7ì¼ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
    return redirect('/mypage')

@app.route('/review/add', methods=['POST'])
@login_required
def review_add():
    """ì‚¬ì§„ ë¦¬ë·° ë“±ë¡ (ì£¼ë¬¸ë‹¹ 1ê°œ ì œí•œ ë¡œì§ ì ìš©)"""
    oid = request.form.get('order_id')
    content = request.form.get('content')
    
    # 1. [ê²€ì¦] í•´ë‹¹ ì£¼ë¬¸ì— ì´ë¯¸ ì‘ì„±ëœ í›„ê¸°ê°€ ìˆëŠ”ì§€ ì²´í¬
    existing_review = Review.query.filter_by(order_id=oid).first()
    if existing_review:
        flash("ì´ë¯¸ í›„ê¸°ë¥¼ ì‘ì„±í•˜ì‹  ì£¼ë¬¸ì…ë‹ˆë‹¤. ğŸ˜Š")
        return redirect('/mypage')
        
    order = Order.query.get(oid)
    if not order or order.user_id != current_user.id: 
        return redirect('/mypage')
    
    img_path = save_review_image(request.files.get('review_image'))
    
    # ë¦¬ë·° ëŒ€ìƒ ìƒí’ˆ ì •ë³´ íŒŒì‹±
    p_name = order.product_details.split('(')[0].split(']')[-1].strip()
    match = re.search(r'\[(.*?)\] (.*?)\(', order.product_details)
    p_id = 0
    category_id = None
    if match:
        first_p = Product.query.filter_by(name=match.group(2).strip()).first()
        if first_p:
            p_id = first_p.id
            cat = Category.query.filter_by(name=first_p.category).first()
            if cat:
                category_id = cat.id  # íŒë§¤ì(ì¹´í…Œê³ ë¦¬) idë³„ë¡œ í›„ê¸° ë¬¶ìŒ

    # 2. [ì €ì¥] Review ìƒì„± ì‹œ order_id, category_id(íŒë§¤ì) í•¨ê»˜ ê¸°ë¡
    new_review = Review(
        user_id=current_user.id,
        user_name=current_user.name,
        product_id=p_id,
        product_name=p_name,
        category_id=category_id,
        content=content,
        image_url=img_path or None,
        order_id=oid
    )
    db.session.add(new_review)
    db.session.commit()
    flash("ì†Œì¤‘í•œ í›„ê¸°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!"); 
    return redirect('/mypage')

@app.route('/cart/add/<int:pid>', methods=['POST'])
@login_required
def add_cart(pid):
    """ì¥ë°”êµ¬ë‹ˆ ì¶”ê°€ (íŒë§¤ì¤‘ ì²´í¬ í¬í•¨)"""
    p = Product.query.get_or_404(pid)
    if (p.deadline and p.deadline < datetime.now()) or p.stock <= 0: 
        return jsonify({"success": False, "message": "íŒë§¤ê°€ ë§ˆê°ëœ ìƒí’ˆì…ë‹ˆë‹¤."})
    
    item = Cart.query.filter_by(user_id=current_user.id, product_id=pid).first()
    if item: item.quantity += 1
    else: db.session.add(Cart(user_id=current_user.id, product_id=pid, product_name=p.name, product_category=p.category, price=p.price, tax_type=p.tax_type))
    
    db.session.commit()
    total_qty = db.session.query(db.func.sum(Cart.quantity)).filter(Cart.user_id == current_user.id).scalar() or 0
    return jsonify({"success": True, "cart_count": total_qty})

@app.route('/cart/minus/<int:pid>', methods=['POST'])
@login_required
def minus_cart(pid):
    """ì¥ë°”êµ¬ë‹ˆ ìˆ˜ëŸ‰ ì°¨ê°"""
    item = Cart.query.filter_by(user_id=current_user.id, product_id=pid).first()
    if item:
        if item.quantity > 1: item.quantity -= 1
        else: db.session.delete(item)
    db.session.commit()
    total_qty = db.session.query(db.func.sum(Cart.quantity)).filter(Cart.user_id == current_user.id).scalar() or 0
    return jsonify({"success": True, "cart_count": total_qty})

@app.route('/cart/delete/<int:pid>', methods=['POST'])
@login_required
def delete_cart(pid): 
    """ì¥ë°”êµ¬ë‹ˆ í•­ëª© ì‚­ì œ"""
    Cart.query.filter_by(user_id=current_user.id, product_id=pid).delete(); db.session.commit(); return redirect('/cart')

@app.route('/cart')
@login_required
def cart():
    """ì¥ë°”êµ¬ë‹ˆ í™”ë©´ (í•œê¸€í™” ë° í°íŠ¸ ì‚¬ì´ì¦ˆ ìµœì í™” ë²„ì „). ê³ ê° ì£¼ì†Œ ì—†ìœ¼ë©´ ë§ˆì´í˜ì´ì§€ë¡œ ì´ë™."""
    _record_page_view('cart')
    items = Cart.query.filter_by(user_id=current_user.id).all()
    if items and not (current_user.address or "").strip():
        flash("ì£¼ë¬¸í•˜ë ¤ë©´ ë°°ì†¡ì§€ ì£¼ì†Œë¥¼ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”.")
        return redirect(url_for("mypage", need_address=1))

    # ë°°ì†¡ë¹„: ì¹´í…Œê³ ë¦¬ë³„ 1,900ì› + (ì¹´í…Œê³ ë¦¬ í•©ê³„ 50,000ì› ì´ìƒì´ë©´ 1,900ì› ì¶”ê°€) â€” í•©ì‚°ì´ ì•„ë‹Œ ì¹´í…Œê³ ë¦¬ë³„ ë”°ë¡œ ê³„ì‚°
    cat_price_sums = {}
    for i in items: 
        cat_price_sums[i.product_category] = cat_price_sums.get(i.product_category, 0) + (i.price * i.quantity)
    delivery_fee = sum(1900 + (1900 if amt >= 50000 else 0) for amt in cat_price_sums.values()) if items else 0
    subtotal = sum(i.price * i.quantity for i in items)
    total = subtotal + delivery_fee
    
    # ìƒë‹¨ í—¤ë” ë° ë¹ˆ ì¥ë°”êµ¬ë‹ˆ ì²˜ë¦¬
    content = f"""
    <div class="max-w-4xl mx-auto py-10 md:py-20 px-4 md:px-6 font-black text-left">
        <h2 class="text-2xl md:text-3xl font-black mb-10 border-l-8 border-teal-600 pl-4 md:pl-6 tracking-tighter uppercase italic">
            ì¥ë°”êµ¬ë‹ˆ
        </h2>
        
        <div class="bg-white rounded-[2rem] md:rounded-[3rem] shadow-xl border border-gray-50 overflow-hidden">
            {" " if items else f'''
            <div class="py-32 md:py-48 text-center">
                <p class="text-7xl md:text-8xl mb-8 opacity-20">ğŸ§º</p>
                <p class="text-lg md:text-2xl mb-10 text-gray-400 font-bold">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
                <a href="/" class="inline-block bg-teal-600 text-white px-10 py-4 rounded-full shadow-lg font-black text-base md:text-lg hover:bg-teal-700 transition">
                    ì¸ê¸° ìƒí’ˆ ë³´ëŸ¬ê°€ê¸°
                </a>
            </div>
            '''}
    """

    # ì¥ë°”êµ¬ë‹ˆ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸
    if items:
        content += '<div class="p-6 md:p-12 space-y-8">'
        for i in items:
            content += f"""
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-b border-gray-50 pb-8 gap-4">
                <div class="flex-1 text-left">
                    <p class="text-[10px] text-teal-600 font-black mb-1 uppercase tracking-widest">[{ i.product_category }]</p>
                    <p class="font-black text-lg md:text-xl text-gray-800 leading-tight mb-2">{ i.product_name }</p>
                    <p class="text-gray-400 font-bold text-sm">{ "{:,}".format(i.price) }ì›</p>
                </div>
                
                <div class="flex items-center justify-between w-full md:w-auto gap-4">
                    <div class="flex items-center gap-6 bg-gray-50 px-5 py-3 rounded-2xl border border-gray-100">
                        <button onclick="minusFromCart({i.product_id})" class="text-gray-400 hover:text-red-500 transition text-xl">
                            <i class="fas fa-minus"></i>
                        </button>
                        <span class="font-black text-lg w-6 text-center">{ i.quantity }</span>
                        <button onclick="addToCart({i.product_id})" class="text-gray-400 hover:text-teal-600 transition text-xl">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <form action="/cart/delete/{i.product_id}" method="POST" class="md:ml-4">
                        <button class="text-gray-200 hover:text-red-500 transition text-2xl p-2">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </form>
                </div>
            </div>
            """
        
        # ê²°ì œ ìš”ì•½ ì˜ì—­
        content += f"""
            <div class="bg-gray-50 p-8 md:p-10 rounded-[2rem] md:rounded-[2.5rem] space-y-4 mt-12 border border-gray-100">
                <div class="flex justify-between text-sm md:text-base text-gray-500 font-bold">
                    <span>ì£¼ë¬¸ ìƒí’ˆ í•©ê³„</span>
                    <span>{ "{:,}".format(subtotal) }ì›</span>
                </div>
                <div class="flex justify-between text-sm md:text-base text-orange-500 font-bold">
                    <span>ì¹´í…Œê³ ë¦¬ë³„ ë°°ì†¡ë£Œ</span>
                    <span>+ { "{:,}".format(delivery_fee) }ì›</span>
                </div>
                <div class="flex justify-between items-center pt-6 border-t border-gray-200 mt-6">
                    <span class="text-lg md:text-xl text-gray-800 font-black">ìµœì¢… ê²°ì œ ê¸ˆì•¡</span>
                    <span class="text-3xl md:text-5xl text-teal-600 font-black italic tracking-tighter">
                        { "{:,}".format(total) }ì›
                    </span>
                </div>
                <p class="text-[10px] md:text-xs text-gray-400 mt-6 leading-relaxed font-medium">
                    â€» ë°°ì†¡ë¹„: ì¹´í…Œê³ ë¦¬ë³„ 1,900ì›. ì¹´í…Œê³ ë¦¬ë³„ í•©ê³„ê¸ˆì•¡ì´ 50,000ì› ì´ìƒì´ë©´ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— 1,900ì› ì¶”ê°€ (ì¹´í…Œê³ ë¦¬ë§ˆë‹¤ ë”°ë¡œ ê³„ì‚°).
                </p>
                <p class="text-[10px] md:text-xs text-teal-600 mt-2 font-bold">ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ë°°ì†¡ì§€ í™•ì¸Â·ë³€ê²½ì´ ê°€ëŠ¥í•˜ë©°, ë³€ê²½ ì£¼ì†Œë¥¼ íšŒì›ì •ë³´ì— ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            
            <a href="/order/confirm" class="block text-center bg-teal-600 text-white py-6 md:py-8 rounded-[1.5rem] md:rounded-[2rem] font-black text-xl md:text-2xl shadow-xl shadow-teal-100 mt-12 hover:bg-teal-700 hover:-translate-y-1 transition active:scale-95">
                ì£¼ë¬¸í•˜ê¸°
            </a>
        </div>
        """

    content += "</div>"
    return render_template_string(HEADER_HTML + content + FOOTER_HTML, items=items, subtotal=subtotal, delivery_fee=delivery_fee, total=total)
@app.route('/order/confirm')
@login_required
def order_confirm():
    """ê²°ì œ ì „ í™•ì¸. ë°°ì†¡ì§€ í™•ì¸Â·ê²°ì œ ì „ ì•ˆë‚´ ë¬¸êµ¬ë¥¼ ëª¨ë‘ ë³´ì—¬ì¤€ ë’¤ ê²°ì œí•˜ê¸°ë¡œ ì§„í–‰."""
    items = Cart.query.filter_by(user_id=current_user.id).all()
    if not items: return redirect('/')
    
    zone_type = get_delivery_zone_type(current_user.address or "")
    cat_price_sums = {}
    for i in items: 
        cat_price_sums[i.product_category] = cat_price_sums.get(i.product_category, 0) + (i.price * i.quantity)
    delivery_fee = sum(1900 + (1900 if amt >= 50000 else 0) for amt in cat_price_sums.values())
    total = sum(i.price * i.quantity for i in items) + delivery_fee
    
    _, min_order_to_use, max_points_per_order = _get_point_config()
    user_points = getattr(current_user, 'points', 0) or 0
    can_use_points = total >= min_order_to_use and user_points > 0
    max_use = min(user_points, max_points_per_order, total) if can_use_points else 0
    
    quick_extra_fee, quick_extra_message = get_quick_extra_config()
    is_songdo = zone_type in ('normal', 'quick')
    is_quick_zone = (zone_type == 'quick')
    total_with_quick = total + quick_extra_fee if is_quick_zone else total

    # ì¼ë°˜ êµ¬ì—­: ì£¼ë¬¸ í™•ì¸ í˜ì´ì§€ (ë°°ì†¡ì§€ í™•ì¸ + ê²°ì œ ì „ ì•ˆë‚´ ë¬¸êµ¬ í¬í•¨)
    if zone_type == 'normal':
        content = f"""
    <div class="max-w-xl mx-auto py-12 md:py-20 px-4 md:px-6 font-black text-left">
        <h2 class="text-2xl md:text-3xl font-black mb-10 border-b-4 border-teal-600 pb-4 text-center uppercase italic">
            ì£¼ë¬¸ í™•ì¸
        </h2>
        
        <div class="bg-white p-8 md:p-12 rounded-[2.5rem] md:rounded-[3.5rem] shadow-2xl border border-gray-50 space-y-10 text-left">
            <div class="p-4 rounded-2xl bg-teal-50 border border-teal-100 text-[11px] text-teal-800 font-bold">
                <p class="font-black">ë°°ì†¡ì§€ ì£¼ì†Œë¥¼ í™•ì¸í•œ ë’¤ ê²°ì œí•´ ì£¼ì„¸ìš”.</p>
            </div>
            
            <div class="p-6 md:p-8 bg-gray-50 border border-gray-200 rounded-3xl">
                <span class="text-teal-600 text-[10px] block uppercase font-black mb-3 tracking-widest">ë°°ì†¡ì§€ ì •ë³´</span>
                <p class="text-sm text-gray-500 mb-3 font-bold leading-relaxed">ì£¼ì†Œ ìˆ˜ì •ì€ ë§ˆì´í˜ì´ì§€ì—ì„œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                <p class="text-lg md:text-xl text-gray-800 font-black leading-snug" id="display-address-text">
                    { (current_user.address or 'ì •ë³´ ì—†ìŒ').replace('<', '&lt;').replace('>', '&gt;') }<br>
                    <span class="text-gray-500">{ (current_user.address_detail or '').replace('<', '&lt;').replace('>', '&gt;') }</span>
                </p>
                <a href="/mypage?from=cart" class="inline-flex items-center gap-2 mt-4 px-5 py-2.5 bg-teal-600 text-white rounded-xl text-sm font-black hover:bg-teal-700 transition">
                    <i class="fas fa-edit"></i> ë§ˆì´í˜ì´ì§€ì—ì„œ ì£¼ì†Œ ìˆ˜ì •
                </a>
                <p class="mt-4 font-black text-sm text-teal-600 flex items-center gap-2"><i class="fas fa-check-circle"></i> ì¼ë°˜ ë°°ì†¡ êµ¬ì—­ì…ë‹ˆë‹¤.</p>
            </div>

            <div class="space-y-4 pt-4">
                <div class="flex justify-between items-end font-black">
                    <span class="text-gray-400 text-xs uppercase tracking-widest">ì£¼ë¬¸ ê¸ˆì•¡</span>
                    <span class="text-2xl text-gray-700">{ "{:,}".format(total) }ì›</span>
                </div>
                {f'''<div class="bg-amber-50 p-5 rounded-2xl border border-amber-100 text-[10px] md:text-xs text-amber-800 font-bold">
                    ğŸ ë³´ìœ  í¬ì¸íŠ¸: { "{:,}".format(user_points) }ì› ({ "{:,}".format(min_order_to_use) }ì› ì´ìƒ êµ¬ë§¤ ì‹œ ìµœëŒ€ { "{:,}".format(max_points_per_order) }ì›ê¹Œì§€ ì‚¬ìš© ê°€ëŠ¥)
                    <div class="mt-3 flex items-center gap-2 flex-wrap">
                        <label class="font-black">ì‚¬ìš©í•  í¬ì¸íŠ¸</label>
                        <input type="number" id="points_used_input" min="0" max="{ max_use }" value="0" step="1" class="w-28 border border-amber-200 rounded-lg px-2 py-1.5 text-sm font-black">
                        <span>ì› (ìµœëŒ€ { "{:,}".format(max_use) }ì›)</span>
                    </div>
                </div>''' if can_use_points else f'<div class="bg-gray-50 p-4 rounded-2xl text-[10px] text-gray-500 font-bold">ë³´ìœ  í¬ì¸íŠ¸: { "{:,}".format(user_points) }ì›. { min_order_to_use and total < min_order_to_use and ("{:,}".format(min_order_to_use) + "ì› ì´ìƒ êµ¬ë§¤ ì‹œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.") or "ì‚¬ìš© ê°€ëŠ¥í•œ í¬ì¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤." }</div>'}
                <div class="flex justify-between items-end font-black border-t border-gray-100 pt-4">
                    <span class="text-gray-400 text-xs uppercase tracking-widest">ìµœì¢… ê²°ì œ ê¸ˆì•¡</span>
                    <span class="text-4xl md:text-5xl text-teal-600 font-black italic underline underline-offset-8" id="final_amount_display">{ "{:,}".format(total) }ì›</span>
                </div>
                <div class="bg-orange-50 p-5 rounded-2xl border border-orange-100 text-[10px] md:text-xs text-orange-700 font-bold leading-relaxed">
                    ğŸ“¢ ë°°ì†¡ë¹„: ì¹´í…Œê³ ë¦¬ë³„ 1,900ì›, ì¹´í…Œê³ ë¦¬ í•©ê³„ 50,000ì› ì´ìƒì´ë©´ 1,900ì› ì¶”ê°€. í˜„ì¬ ë°°ì†¡ë¹„: { "{:,}".format(delivery_fee) }ì›
                </div>
            </div>

            <div class="p-6 md:p-8 bg-gray-50 rounded-3xl text-[11px] md:text-xs text-gray-500 space-y-6 font-black border border-gray-100">
                <div class="bg-gray-100 border border-gray-200 rounded-2xl p-4 text-gray-700 text-[10px] md:text-[11px] leading-relaxed">
                    <span class="font-extrabold text-gray-900">âš ï¸ ì£¼ë¬¸ ì „ í•„ìˆ˜ í™•ì¸</span>
                    <ul class="mt-2 pl-4 space-y-1 list-disc">
                        <li>ì¥ë°”êµ¬ë‹ˆ ë‹¨ê³„ì—ì„œëŠ” ì–¸ì œë“ ì§€ ì£¼ë¬¸ ì·¨ì†Œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
                        <li>ê³µë™êµ¬ë§¤Â·ì‹¤ì‹œê°„ ìˆ˜ê¸‰ íŠ¹ì„±ìƒ ë„ë§¤ì²˜ í’ˆì ˆÂ·ìˆ˜ê¸‰ ë³€ë™ìœ¼ë¡œ <b>ë¶€ë¶„ ë˜ëŠ” ì „ì²´ ì·¨ì†Œ</b>ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                        <li>ë¹„ì •ìƒì Â·ìƒì—…ì  ì¬íŒë§¤Â·ì‹œìŠ¤í…œ ì•…ìš© ì‹œ <b>ê´€ë¦¬ì íŒë‹¨ì— ë”°ë¼ ì‚¬ì „ ì•ˆë‚´ í›„ ì·¨ì†Œ</b>ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                        <li>ìƒí’ˆ ì¤€ë¹„ê°€ ì‹œì‘ëœ ì´í›„ì—ëŠ” ì·¨ì†ŒÂ·ë³€ê²½ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                    </ul>
                </div>
                <div class="bg-amber-50/80 border border-amber-200 rounded-2xl p-4 text-amber-800 text-[10px] md:text-[11px] leading-relaxed">
                    <span class="font-extrabold">âš ï¸ ì£¼ë¬¸Â·ê²°ì œ ì „ ì·¨ì†Œ ì•ˆë‚´</span><br>
                    ê³µë™êµ¬ë§¤ ë°©ì‹ì˜ êµ¬ë§¤ íŠ¹ì„±ìƒ ì¬ê³  ì†Œì§„ ì‹œ í’ˆì ˆ ì²˜ë¦¬ë  ìˆ˜ ìˆìœ¼ë©°, ê´€ë¦¬ì íŒë‹¨ì— ë”°ë¼ ìƒì—…ì Â·ë¹„ìƒì‹ì Â·ì•…ì˜ì  ì´ìš©ìœ¼ë¡œ ë³´ì´ëŠ” ê²½ìš° í•´ë‹¹ í’ˆëª©ì´ ë¶€ë¶„ ì·¨ì†Œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
                <label class="flex items-start gap-4 cursor-pointer group">
                    <input type="checkbox" id="consent_partial_cancel" class="mt-1 w-4 h-4 rounded-full border-gray-300 text-teal-600 focus:ring-teal-500" required>
                    <span class="group-hover:text-gray-800 transition leading-relaxed">[í•„ìˆ˜] ìœ„ ì·¨ì†Œ ì•ˆë‚´(í’ˆì ˆÂ·ë¶€ë¶„ ì·¨ì†Œ ê°€ëŠ¥)ë¥¼ í™•ì¸í–ˆìœ¼ë©° ì´ì— ë™ì˜í•©ë‹ˆë‹¤.</span>
                </label>
                <label class="flex items-start gap-4 pt-4 border-t border-gray-200 cursor-pointer group">
                    <input type="checkbox" id="consent_agency" class="mt-1 w-4 h-4 rounded-full border-gray-300 text-teal-600 focus:ring-teal-500" required>
                    <span class="group-hover:text-gray-800 transition leading-relaxed">[í•„ìˆ˜] ë³¸ì¸ì€ ë°”êµ¬ë‹ˆì‚¼ì´Œì´ ìƒí’ˆ íŒë§¤ìê°€ ì•„ë‹ˆë©°, ìš”ì²­ì— ë”°ë¼ êµ¬ë§¤ ë° ë°°ì†¡ì„ ëŒ€í–‰í•˜ëŠ” ì„œë¹„ìŠ¤ì„ì„ í™•ì¸í•˜ê³  ì´ì— ë™ì˜í•©ë‹ˆë‹¤.</span>
                </label>
                <label class="flex items-start gap-4 pt-4 border-t border-gray-200 cursor-pointer group">
                    <input type="checkbox" id="consent_third_party_order" class="mt-1 w-4 h-4 rounded-full border-gray-300 text-teal-600 focus:ring-teal-500" required>
                    <span class="group-hover:text-gray-800 transition leading-relaxed">[í•„ìˆ˜] ê°œì¸ì •ë³´ ì œ3ì ì œê³µ ë™ì˜: ì›í™œí•œ ë°°ì†¡ ì²˜ë¦¬ë¥¼ ìœ„í•´ íŒë§¤ì²˜ ë° ë°°ì†¡ ë‹´ë‹¹ìì—ê²Œ ì •ë³´ê°€ ì œê³µë¨ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.</span>
                </label>
            </div>

            <form id="payForm" action="/order/payment" method="POST" class="mt-4">
                <input type="hidden" name="points_used" id="points_used_hidden" value="0">
                <input type="hidden" name="quick_agree" id="quick_agree_hidden" value="0">
                <input type="hidden" name="order_address" id="order_address_hidden" value="{ (current_user.address or '').replace('&', '&amp;').replace('"', '&quot;') }">
                <input type="hidden" name="order_address_detail" id="order_address_detail_hidden" value="{ (current_user.address_detail or '').replace('&', '&amp;').replace('"', '&quot;') }">
                <input type="hidden" name="order_entrance_pw" id="order_entrance_pw_hidden" value="{ (current_user.entrance_pw or '').replace('&', '&amp;').replace('"', '&quot;') }">
                <input type="hidden" name="save_address_to_profile" id="save_address_to_profile_hidden" value="0">
                <button type="button" id="payBtn" onclick="startPayment()" class="w-full bg-teal-600 text-white py-6 md:py-8 rounded-[1.5rem] md:rounded-[2rem] font-black text-xl md:text-2xl shadow-xl shadow-teal-100 hover:bg-teal-700 transition active:scale-95">ë°°ì†¡ì§€ í™•ì¸ í›„ ê²°ì œí•˜ê¸°</button>
            </form>
        </div>
    </div>
    <script>
    var orderTotal = { total };
    var maxUse = { max_use };
    function startPayment() {{
        if(!document.getElementById('consent_partial_cancel').checked) {{ alert("ì£¼ë¬¸Â·ê²°ì œ ì „ ì·¨ì†Œ ì•ˆë‚´ì— ë™ì˜í•´ ì£¼ì„¸ìš”."); return; }}
        if(!document.getElementById('consent_agency').checked) {{ alert("êµ¬ë§¤ ëŒ€í–‰ ì„œë¹„ìŠ¤ ì´ìš© ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤."); return; }}
        if(!document.getElementById('consent_third_party_order').checked) {{ alert("ê°œì¸ì •ë³´ ì œê³µ ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤."); return; }}
        var ptsInput = document.getElementById('points_used_input');
        var pts = ptsInput ? parseInt(ptsInput.value, 10) || 0 : 0;
        if (pts < 0) pts = 0;
        if (pts > maxUse) pts = maxUse;
        document.getElementById('points_used_hidden').value = pts;
        document.getElementById('payForm').submit();
    }}
    var ptsIn = document.getElementById('points_used_input');
    if (ptsIn) {{
        ptsIn.addEventListener('input', function() {{
            var v = parseInt(this.value, 10) || 0;
            if (v > maxUse) this.value = maxUse;
            var final = orderTotal - (parseInt(this.value, 10) || 0);
            var el = document.getElementById('final_amount_display');
            if (el) el.textContent = final.toLocaleString() + 'ì›';
        }});
    }}
    </script>
    """
        return render_template_string(HEADER_HTML + content + FOOTER_HTML, total=total, delivery_fee=delivery_fee, is_songdo=True, zone_type='normal', quick_extra_fee=0, quick_extra_message='', total_with_quick=total, is_quick_zone=False, user_points=user_points, max_use=max_use, min_order_to_use=min_order_to_use)

    # í€µ êµ¬ì—­ ë˜ëŠ” ë°°ì†¡ ë¶ˆê°€: 2ì°¨ í™•ì¸ í˜ì´ì§€
    content = f"""
    <div class="max-w-xl mx-auto py-12 md:py-20 px-4 md:px-6 font-black text-left">
        <h2 class="text-2xl md:text-3xl font-black mb-10 border-b-4 border-teal-600 pb-4 text-center uppercase italic">
            ì£¼ë¬¸ í™•ì¸ (2ì°¨: í€µ êµ¬ì—­ í™•ì¸)
        </h2>
        
        <div class="bg-white p-8 md:p-12 rounded-[2.5rem] md:rounded-[3.5rem] shadow-2xl border border-gray-50 space-y-10 text-left">
            <div class="p-4 rounded-2xl bg-gray-100 border border-gray-200 text-[11px] text-gray-600 font-bold">
                <p class="mb-1">1ì°¨: ì¼ë°˜ ë°°ì†¡ êµ¬ì—­ì´ ì•„ë‹™ë‹ˆë‹¤.</p>
                <p class="text-amber-700 font-black">2ì°¨: í€µ ì§€ì • êµ¬ì—­ ì ìš© ì—¬ë¶€ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.</p>
            </div>
            
            <div class="p-6 md:p-8 {'bg-amber-50 border-amber-200' if zone_type == 'quick' else 'bg-red-50 border-red-100'} rounded-3xl border relative overflow-hidden">
                <span class="{'text-amber-700' if zone_type == 'quick' else 'text-red-600'} text-[10px] block uppercase font-black mb-3 tracking-widest">
                    ë°°ì†¡ì§€ ì •ë³´
                </span>
                <p class="text-sm text-gray-500 mb-3 font-bold leading-relaxed">ì£¼ì†Œ ìˆ˜ì •ì€ ë§ˆì´í˜ì´ì§€ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. ìˆ˜ì • í›„ ì¥ë°”êµ¬ë‹ˆì—ì„œ ë‹¤ì‹œ ì£¼ë¬¸í•˜ê¸°ë¥¼ ëˆŒëŸ¬ ì£¼ì„¸ìš”.</p>
                <div id="address-display-block">
                    <p class="text-lg md:text-xl text-gray-800 font-black leading-snug" id="display-address-text">
                        { (current_user.address or 'ì •ë³´ ì—†ìŒ').replace('<', '&lt;').replace('>', '&gt;') }<br>
                        <span class="text-gray-500">{ (current_user.address_detail or '').replace('<', '&lt;').replace('>', '&gt;') }</span>
                    </p>
                    <a href="/mypage?from=cart" class="inline-flex items-center gap-2 mt-4 px-5 py-2.5 bg-teal-600 text-white rounded-xl text-sm font-black hover:bg-teal-700 transition">
                        <i class="fas fa-edit"></i> ë§ˆì´í˜ì´ì§€ì—ì„œ ì£¼ì†Œ ìˆ˜ì •
                    </a>
                </div>
                <p class="mt-4 font-black text-sm" id="zone-status-msg">
                    {'<span class="text-amber-700 flex items-center gap-2"><i class="fas fa-truck-fast"></i> 2ì°¨ í™•ì¸: í€µ ì§€ì • êµ¬ì—­ì…ë‹ˆë‹¤. ì¶”ê°€ ë°°ì†¡ë£Œ ë™ì˜ ì‹œ ì£¼ë¬¸ ê°€ëŠ¥.</span>' if zone_type == 'quick' else '<span class="text-red-600 flex items-center gap-2"><i class="fas fa-exclamation-triangle"></i> 2ì°¨: í€µ ì§€ì • êµ¬ì—­ë„ ì•„ë‹™ë‹ˆë‹¤. ë°°ì†¡ ë¶ˆê°€.</span>'}
                </p>
            </div>

            {f'<div class="p-6 bg-red-100 rounded-2xl text-red-700 text-xs md:text-sm font-bold leading-relaxed">âš ï¸ 1ì°¨Â·2ì°¨ ëª¨ë‘ í•´ë‹¹ êµ¬ì—­ì´ ì—†ìŠµë‹ˆë‹¤. ë°°ì†¡ ê°€ëŠ¥ ì£¼ì†Œë¡œ ìˆ˜ì •í•´ ì£¼ì„¸ìš”.</div>' if zone_type == 'unavailable' else ''}
            {f'''<div class="p-6 bg-amber-50 border border-amber-200 rounded-2xl text-amber-900 text-xs md:text-sm font-bold leading-relaxed">
                <p class="mb-2 font-black">2ì°¨: í€µ ì§€ì • êµ¬ì—­ â€” ì¶”ê°€ ë°°ì†¡ë£Œ ì ìš©</p>
                <p class="mb-3">{ quick_extra_message }</p>
                <p class="mb-3">í€µ ì¶”ê°€ ë°°ì†¡ë£Œ: <strong>{ "{:,}".format(quick_extra_fee) }ì›</strong></p>
                <label class="flex items-start gap-3 cursor-pointer mt-4">
                    <input type="checkbox" id="quick_agree" class="mt-1 w-4 h-4 rounded border-amber-400 text-amber-600 focus:ring-amber-500">
                    <span>ìœ„ ì¶”ê°€ ë°°ì†¡ë£Œì— ë™ì˜í•˜ê³  í€µìœ¼ë¡œ ì£¼ë¬¸í•©ë‹ˆë‹¤.</span>
                </label>
            </div>''' if is_quick_zone else ''}

            <div class="space-y-4 pt-4">
                <div class="flex justify-between items-end font-black">
                    <span class="text-gray-400 text-xs uppercase tracking-widest">ì£¼ë¬¸ ê¸ˆì•¡</span>
                    <span class="text-2xl text-gray-700">{ "{:,}".format(total) }ì›</span>
                </div>
                {f'''<div class="bg-amber-50 p-5 rounded-2xl border border-amber-100 text-[10px] md:text-xs text-amber-800 font-bold">
                    ğŸ ë³´ìœ  í¬ì¸íŠ¸: { "{:,}".format(user_points) }ì› ({ "{:,}".format(min_order_to_use) }ì› ì´ìƒ êµ¬ë§¤ ì‹œ ìµœëŒ€ { "{:,}".format(max_points_per_order) }ì›ê¹Œì§€ ì‚¬ìš© ê°€ëŠ¥)
                    <div class="mt-3 flex items-center gap-2 flex-wrap">
                        <label class="font-black">ì‚¬ìš©í•  í¬ì¸íŠ¸</label>
                        <input type="number" id="points_used_input" min="0" max="{ max_use }" value="0" step="1" class="w-28 border border-amber-200 rounded-lg px-2 py-1.5 text-sm font-black">
                        <span>ì› (ìµœëŒ€ { "{:,}".format(max_use) }ì›)</span>
                    </div>
                </div>''' if can_use_points else f'<div class="bg-gray-50 p-4 rounded-2xl text-[10px] text-gray-500 font-bold">ë³´ìœ  í¬ì¸íŠ¸: { "{:,}".format(user_points) }ì›. { min_order_to_use and total < min_order_to_use and ("{:,}".format(min_order_to_use) + "ì› ì´ìƒ êµ¬ë§¤ ì‹œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.") or "ì‚¬ìš© ê°€ëŠ¥í•œ í¬ì¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤." }</div>'}
                <div class="flex justify-between items-end font-black border-t border-gray-100 pt-4">
                    <span class="text-gray-400 text-xs uppercase tracking-widest">ìµœì¢… ê²°ì œ ê¸ˆì•¡</span>
                    <span class="text-4xl md:text-5xl text-teal-600 font-black italic underline underline-offset-8" id="final_amount_display">{ "{:,}".format(total if not is_quick_zone else total) }ì›</span>
                </div>
                {f'<p class="text-[10px] text-amber-700 font-bold">í€µ ë™ì˜ ì‹œ ê²°ì œ ê¸ˆì•¡: <span id="final_with_quick_display">{ "{:,}".format(total_with_quick) }ì›</span></p>' if is_quick_zone else ''}
                <div class="bg-orange-50 p-5 rounded-2xl border border-orange-100 text-[10px] md:text-xs text-orange-700 font-bold leading-relaxed">
                    ğŸ“¢ ë°°ì†¡ë¹„: ì¹´í…Œê³ ë¦¬ë³„ 1,900ì›, ì¹´í…Œê³ ë¦¬ í•©ê³„ 50,000ì› ì´ìƒì´ë©´ 1,900ì› ì¶”ê°€. í˜„ì¬ ë°°ì†¡ë¹„: { "{:,}".format(delivery_fee) }ì›
                </div>
            </div>

            <div class="p-6 md:p-8 bg-gray-50 rounded-3xl text-[11px] md:text-xs text-gray-500 space-y-6 font-black border border-gray-100">
                <div class="bg-gray-100 border border-gray-200 rounded-2xl p-4 text-gray-700 text-[10px] md:text-[11px] leading-relaxed">
                    <span class="font-extrabold text-gray-900">âš ï¸ ì£¼ë¬¸ ì „ í•„ìˆ˜ í™•ì¸</span>
                    <ul class="mt-2 pl-4 space-y-1 list-disc">
                        <li>ì¥ë°”êµ¬ë‹ˆ ë‹¨ê³„ì—ì„œëŠ” ì–¸ì œë“ ì§€ ì£¼ë¬¸ ì·¨ì†Œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
                        <li>ê³µë™êµ¬ë§¤Â·ì‹¤ì‹œê°„ ìˆ˜ê¸‰ íŠ¹ì„±ìƒ ë„ë§¤ì²˜ í’ˆì ˆÂ·ìˆ˜ê¸‰ ë³€ë™ìœ¼ë¡œ <b>ë¶€ë¶„ ë˜ëŠ” ì „ì²´ ì·¨ì†Œ</b>ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                        <li>ë¹„ì •ìƒì Â·ìƒì—…ì  ì¬íŒë§¤Â·ì‹œìŠ¤í…œ ì•…ìš© ì‹œ <b>ê´€ë¦¬ì íŒë‹¨ì— ë”°ë¼ ì‚¬ì „ ì•ˆë‚´ í›„ ì·¨ì†Œ</b>ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                        <li>ìƒí’ˆ ì¤€ë¹„ê°€ ì‹œì‘ëœ ì´í›„ì—ëŠ” ì·¨ì†ŒÂ·ë³€ê²½ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                    </ul>
                </div>
                <div class="bg-amber-50/80 border border-amber-200 rounded-2xl p-4 text-amber-800 text-[10px] md:text-[11px] leading-relaxed">
                    <span class="font-extrabold">âš ï¸ ì£¼ë¬¸Â·ê²°ì œ ì „ ì·¨ì†Œ ì•ˆë‚´</span><br>
                    ê³µë™êµ¬ë§¤ ë°©ì‹ì˜ êµ¬ë§¤ íŠ¹ì„±ìƒ ì¬ê³  ì†Œì§„ ì‹œ í’ˆì ˆ ì²˜ë¦¬ë  ìˆ˜ ìˆìœ¼ë©°, ê´€ë¦¬ì íŒë‹¨ì— ë”°ë¼ ìƒì—…ì Â·ë¹„ìƒì‹ì Â·ì•…ì˜ì  ì´ìš©ìœ¼ë¡œ ë³´ì´ëŠ” ê²½ìš° í•´ë‹¹ í’ˆëª©ì´ ë¶€ë¶„ ì·¨ì†Œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
                <label class="flex items-start gap-4 cursor-pointer group">
                    <input type="checkbox" id="consent_partial_cancel" class="mt-1 w-4 h-4 rounded-full border-gray-300 text-teal-600 focus:ring-teal-500" required>
                    <span class="group-hover:text-gray-800 transition leading-relaxed">
                        [í•„ìˆ˜] ìœ„ ì·¨ì†Œ ì•ˆë‚´(í’ˆì ˆÂ·ë¶€ë¶„ ì·¨ì†Œ ê°€ëŠ¥)ë¥¼ í™•ì¸í–ˆìœ¼ë©° ì´ì— ë™ì˜í•©ë‹ˆë‹¤.
                    </span>
                </label>
                <label class="flex items-start gap-4 pt-4 border-t border-gray-200 cursor-pointer group">
                    <input type="checkbox" id="consent_agency" class="mt-1 w-4 h-4 rounded-full border-gray-300 text-teal-600 focus:ring-teal-500" required>
                    <span class="group-hover:text-gray-800 transition leading-relaxed">
                        [í•„ìˆ˜] ë³¸ì¸ì€ ë°”êµ¬ë‹ˆì‚¼ì´Œì´ ìƒí’ˆ íŒë§¤ìê°€ ì•„ë‹ˆë©°, ìš”ì²­ì— ë”°ë¼ êµ¬ë§¤ ë° ë°°ì†¡ì„ ëŒ€í–‰í•˜ëŠ” ì„œë¹„ìŠ¤ì„ì„ í™•ì¸í•˜ê³  ì´ì— ë™ì˜í•©ë‹ˆë‹¤.
                    </span>
                </label>
                <label class="flex items-start gap-4 pt-4 border-t border-gray-200 cursor-pointer group">
                    <input type="checkbox" id="consent_third_party_order" class="mt-1 w-4 h-4 rounded-full border-gray-300 text-teal-600 focus:ring-teal-500" required>
                    <span class="group-hover:text-gray-800 transition leading-relaxed">
                        [í•„ìˆ˜] ê°œì¸ì •ë³´ ì œ3ì ì œê³µ ë™ì˜: ì›í™œí•œ ë°°ì†¡ ì²˜ë¦¬ë¥¼ ìœ„í•´ íŒë§¤ì²˜ ë° ë°°ì†¡ ë‹´ë‹¹ìì—ê²Œ ì •ë³´ê°€ ì œê³µë¨ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.
                    </span>
                </label>
            </div>

            <form id="payForm" action="/order/payment" method="POST" class="mt-4">
                <input type="hidden" name="points_used" id="points_used_hidden" value="0">
                <input type="hidden" name="quick_agree" id="quick_agree_hidden" value="0">
                <input type="hidden" name="order_address" id="order_address_hidden" value="{ (current_user.address or '').replace('&', '&amp;').replace('"', '&quot;') }">
                <input type="hidden" name="order_address_detail" id="order_address_detail_hidden" value="{ (current_user.address_detail or '').replace('&', '&amp;').replace('"', '&quot;') }">
                <input type="hidden" name="order_entrance_pw" id="order_entrance_pw_hidden" value="{ (current_user.entrance_pw or '').replace('&', '&amp;').replace('"', '&quot;') }">
                <input type="hidden" name="save_address_to_profile" id="save_address_to_profile_hidden" value="0">
                {f'<button type="button" id="payBtn" onclick="startPayment()" class="w-full bg-teal-600 text-white py-6 md:py-8 rounded-[1.5rem] md:rounded-[2rem] font-black text-xl md:text-2xl shadow-xl shadow-teal-100 hover:bg-teal-700 transition active:scale-95">ì•ˆì „ ê²°ì œí•˜ê¸°</button>' if zone_type == 'normal' else f'<button type="button" id="payBtn" onclick="startPayment()" class="w-full bg-amber-500 text-white py-6 md:py-8 rounded-[1.5rem] md:rounded-[2rem] font-black text-xl md:text-2xl shadow-xl hover:bg-amber-600 transition active:scale-95">í€µ ì¶”ê°€ë£Œ ë™ì˜ í›„ ê²°ì œí•˜ê¸°</button>' if zone_type == 'quick' else '<button type="button" class="w-full bg-gray-300 text-white py-6 md:py-8 rounded-[1.5rem] md:rounded-[2rem] font-black text-xl cursor-not-allowed" disabled>ë°°ì†¡ì§€ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”</button>'}
            </form>
        </div>
    </div>

    <script>
    var orderTotal = { total };
    var quickExtraFee = { quick_extra_fee };
    var isQuickZone = { 'true' if is_quick_zone else 'false' };
    var totalWithQuick = { total_with_quick };
    function startPayment() {{
        if(!document.getElementById('consent_partial_cancel').checked) {{ alert("ì£¼ë¬¸Â·ê²°ì œ ì „ ì·¨ì†Œ ì•ˆë‚´(í’ˆì ˆÂ·ë¶€ë¶„ ì·¨ì†Œ ê°€ëŠ¥)ì— ë™ì˜í•´ ì£¼ì„¸ìš”."); return; }}
        if(!document.getElementById('consent_agency').checked) {{ alert("êµ¬ë§¤ ëŒ€í–‰ ì„œë¹„ìŠ¤ ì´ìš© ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤."); return; }}
        if(!document.getElementById('consent_third_party_order').checked) {{ alert("ê°œì¸ì •ë³´ ì œê³µ ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤."); return; }}
        if (isQuickZone) {{
            var q = document.getElementById('quick_agree');
            if (!q || !q.checked) {{ alert("í€µ ì¶”ê°€ ë°°ì†¡ë£Œì— ë™ì˜í•´ ì£¼ì„¸ìš”."); return; }}
            document.getElementById('quick_agree_hidden').value = '1';
        }}
        var ptsInput = document.getElementById('points_used_input');
        var pts = ptsInput ? parseInt(ptsInput.value, 10) || 0 : 0;
        var maxUse = { max_use };
        if (pts < 0) pts = 0;
        if (pts > maxUse) pts = maxUse;
        document.getElementById('points_used_hidden').value = pts;
        document.getElementById('payForm').submit();
    }}
    var ptsIn = document.getElementById('points_used_input');
    if (ptsIn) {{
        ptsIn.addEventListener('input', function() {{
            var v = parseInt(this.value, 10) || 0;
            var m = { max_use };
            if (v > m) this.value = m;
            var base = orderTotal;
            if (isQuickZone) base = totalWithQuick;
            var final = base - (parseInt(this.value, 10) || 0);
            var el = document.getElementById('final_amount_display');
            if (el) el.textContent = final.toLocaleString() + 'ì›';
        }});
    }}
    if (isQuickZone) {{
        var qAgree = document.getElementById('quick_agree');
        if (qAgree) qAgree.addEventListener('change', function() {{
            var el = document.getElementById('final_amount_display');
            if (el) el.textContent = (this.checked ? totalWithQuick : orderTotal).toLocaleString() + 'ì›';
        }});
    }}
    </script>
    """
    return render_template_string(HEADER_HTML + content + FOOTER_HTML, total=total, delivery_fee=delivery_fee, is_songdo=is_songdo, zone_type=zone_type, quick_extra_fee=quick_extra_fee, quick_extra_message=quick_extra_message, total_with_quick=total_with_quick, is_quick_zone=is_quick_zone, user_points=user_points, max_use=max_use, min_order_to_use=min_order_to_use)
@app.route('/order/payment', methods=['GET', 'POST'])
@login_required
def order_payment():
    """í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œì°½ í˜¸ì¶œ ë° ë³´ì•ˆ ê°•í™” ë²„ì „"""
    if request.method == 'POST':
        points_used = request.form.get('points_used', '0').strip()
        try:
            points_used = int(points_used) if points_used else 0
        except ValueError:
            points_used = 0
        quick_agree = request.form.get('quick_agree', '0').strip() in ('1', 'on', 'yes')
        order_address = request.form.get('order_address', '').strip()
        order_address_detail = request.form.get('order_address_detail', '').strip()
        order_entrance_pw = request.form.get('order_entrance_pw', '').strip()
        save_address_to_profile = request.form.get('save_address_to_profile', '0').strip() in ('1', 'on', 'yes')
        effective_address = order_address if order_address else (current_user.address or "")
        items = Cart.query.filter_by(user_id=current_user.id).all()
        if not items:
            return redirect('/order/confirm')
        if not is_address_in_delivery_zone(effective_address):
            flash("ì„ íƒí•œ ë°°ì†¡ì§€ëŠ” ë°°ì†¡ ê°€ëŠ¥ êµ¬ì—­ì´ ì•„ë‹™ë‹ˆë‹¤. ì£¼ì†Œë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.")
            return redirect('/order/confirm')
        zone_type = get_delivery_zone_type(effective_address)
        if zone_type == 'quick' and not quick_agree:
            return redirect('/order/confirm')
        session['order_address'] = effective_address
        session['order_address_detail'] = order_address_detail if order_address else (current_user.address_detail or "")
        session['order_entrance_pw'] = order_entrance_pw if order_address else (current_user.entrance_pw or "")
        session['save_address_to_profile'] = save_address_to_profile
        subtotal = sum(i.price * i.quantity for i in items)
        cat_price_sums = {}
        for i in items:
            cat_price_sums[i.product_category] = cat_price_sums.get(i.product_category, 0) + (i.price * i.quantity)
        delivery_fee = sum(1900 + (1900 if amt >= 50000 else 0) for amt in cat_price_sums.values())
        total = subtotal + delivery_fee
        quick_extra_fee_val = 0
        if zone_type == 'quick' and quick_agree:
            quick_extra_fee_val, _ = get_quick_extra_config()
            total += quick_extra_fee_val
        _, min_order_to_use, max_points_per_order = _get_point_config()
        user_points = getattr(current_user, 'points', 0) or 0
        if points_used < 0:
            points_used = 0
        if total < min_order_to_use or points_used > min(user_points, max_points_per_order, total):
            points_used = 0
        session['points_used'] = points_used
        session['quick_extra_fee'] = quick_extra_fee_val
        return redirect(url_for('order_payment'))
    items = Cart.query.filter_by(user_id=current_user.id).all()
    effective_addr = session.get('order_address') or current_user.address or ""
    if not items or not is_address_in_delivery_zone(effective_addr):
        return redirect('/order/confirm')
    
    subtotal = sum(i.price * i.quantity for i in items)
    cat_price_sums = {}
    for i in items: 
        cat_price_sums[i.product_category] = cat_price_sums.get(i.product_category, 0) + (i.price * i.quantity)
    delivery_fee = sum(1900 + (1900 if amt >= 50000 else 0) for amt in cat_price_sums.values())
    points_used = session.get('points_used', 0) or 0
    quick_extra_fee_val = session.get('quick_extra_fee', 0) or 0
    total_before_points = int(subtotal + delivery_fee + quick_extra_fee_val)
    total = total_before_points - points_used  # í† ìŠ¤ì— ë„˜ê¸¸ ì‹¤ì œ ê²°ì œ ê¸ˆì•¡
    tax_free = int(sum(i.price * i.quantity for i in items if i.tax_type == 'ë©´ì„¸'))
    order_id = f"ORDER_{datetime.now().strftime('%Y%m%d%H%M%S')}_{current_user.id}"
    order_name = f"{items[0].product_name} ì™¸ {len(items)-1}ê±´" if len(items) > 1 else items[0].product_name
    
    content = f"""
    <div class="max-w-md mx-auto py-24 md:py-40 px-6 text-center font-black">
        <div class="w-24 h-24 bg-blue-50 rounded-full flex items-center justify-center text-5xl mx-auto mb-10 text-blue-600 shadow-inner animate-pulse">
            <i class="fas fa-shield-alt"></i>
        </div>
        
        <h2 class="text-2xl md:text-3xl font-black mb-4 text-gray-800 tracking-tighter">
            ì•ˆì „ ê²°ì œ ì‹œìŠ¤í…œ ì—°ê²°
        </h2>
        <p class="text-gray-400 font-bold text-sm md:text-base mb-12 leading-relaxed">
            ë°”êµ¬ë‹ˆì‚¼ì´Œì€ í† ìŠ¤í˜ì´ë¨¼ì¸ ì˜ ë³´ì•ˆë§ì„ í†µí•´<br>ê³ ê°ë‹˜ì˜ ê²°ì œ ì •ë³´ë¥¼ ì•ˆì „í•˜ê²Œ ë³´í˜¸í•©ë‹ˆë‹¤.
        </p>

        <div class="bg-white p-8 rounded-3xl border border-gray-100 shadow-xl mb-12 text-left space-y-4">
            <div class="flex justify-between text-xs font-bold text-gray-400 uppercase tracking-widest">
                <span>ì£¼ë¬¸ ìƒí’ˆ</span>
                <span class="text-gray-800">{ order_name }</span>
            </div>
            {f'<div class="flex justify-between items-center text-sm text-amber-700 font-bold">í¬ì¸íŠ¸ ì‚¬ìš© <span>- { "{:,}".format(points_used) }ì›</span></div>' if points_used else ''}
            <div class="flex justify-between items-center border-t border-gray-50 pt-4 font-black">
                <span class="text-sm text-gray-600">ì´ ê²°ì œ ê¸ˆì•¡</span>
                <span class="text-2xl text-teal-600 italic underline underline-offset-4">{ "{:,}".format(total) }ì›</span>
            </div>
        </div>

        <button id="payment-button" class="w-full bg-blue-600 text-white py-6 rounded-[1.5rem] md:rounded-[2rem] font-black text-xl shadow-xl shadow-blue-100 hover:bg-blue-700 transition active:scale-95 flex items-center justify-center gap-3">
            <i class="fas fa-credit-card"></i> ê²°ì œì°½ ì—´ê¸°
        </button>
        
        <p class="mt-8 text-[10px] text-gray-300 font-medium">
            ê²°ì œì°½ì´ ì—´ë¦¬ì§€ ì•Šê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí•  ê²½ìš°<br>ê³ ê°ì„¼í„°(1666-8320)ë¡œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.
        </p>
    </div>

    <script>
    // 1. í† ìŠ¤í˜ì´ë¨¼ì¸  ì´ˆê¸°í™”
    var tossPayments = TossPayments("{TOSS_CLIENT_KEY}");
    var isProcessing = false; // ì¤‘ë³µ ê²°ì œ ë°©ì§€ ìƒíƒœ ë³€ìˆ˜

    document.getElementById('payment-button').addEventListener('click', function() {{
        // 2. ì¤‘ë³µ í´ë¦­ ì²´í¬
        if (isProcessing) {{
            alert("í˜„ì¬ ê²°ì œê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.");
            return;
        }}

        try {{
            isProcessing = true; // ì²˜ë¦¬ ì‹œì‘
            this.innerHTML = '<i class="fas fa-spinner animate-spin"></i> ì—°ê²° ì¤‘...';
            this.classList.add('opacity-50', 'cursor-not-allowed');

            tossPayments.requestPayment('ì¹´ë“œ', {{
                amount: { total },
                taxFreeAmount: { min(tax_free, total) },
                orderId: '{ order_id }',
                orderName: '{ order_name }',
                customerName: '{ current_user.name }',
                successUrl: window.location.origin + '/payment/success',
                failUrl: window.location.origin + '/payment/fail'
            }}).catch(function (error) {{
                // ê²°ì œì°½ í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ìƒíƒœ ë³µêµ¬
                isProcessing = false;
                document.getElementById('payment-button').innerHTML = '<i class="fas fa-credit-card"></i> ê²°ì œì°½ ì—´ê¸°';
                document.getElementById('payment-button').classList.remove('opacity-50', 'cursor-not-allowed');
                
                if (error.code === 'USER_CANCEL') {{
                    alert("ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                }} else {{
                    alert("ê²°ì œ ì˜¤ë¥˜: " + error.message);
                }}
            }});
        }} catch (err) {{
            alert("ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
            isProcessing = false;
        }}
    }});
    </script>
    """
    return render_template_string(HEADER_HTML + content + FOOTER_HTML)

# [ìˆ˜ì •] ê²°ì œ ì„±ê³µ í™”ë©´ ë‚´ 'ë°”ë¡œê°€ê¸° ì¶”ê°€' ë²„íŠ¼ í¬í•¨
@app.route('/payment/success')
@login_required
def payment_success():
    """ê²°ì œ ì„±ê³µ ë° ì£¼ë¬¸ ìƒì„± (ì„¸ë ¨ëœ ë””ìì¸ ë° í°íŠ¸ ìµœì í™” ë²„ì „)"""
    pk, oid, amt = request.args.get('paymentKey'), request.args.get('orderId'), request.args.get('amount')
    url, auth_key = "https://api.tosspayments.com/v1/payments/confirm", base64.b64encode(f"{TOSS_SECRET_KEY}:".encode()).decode()
    res = requests.post(url, json={"paymentKey": pk, "amount": amt, "orderId": oid}, headers={"Authorization": f"Basic {auth_key}", "Content-Type": "application/json"})
    
    if res.status_code == 200:
        items = Cart.query.filter_by(user_id=current_user.id).all()
        if not items: return redirect('/') # ì¤‘ë³µ ìƒˆë¡œê³ ì¹¨ ë°©ì§€

        cat_groups = {i.product_category: [] for i in items}
        for i in items: cat_groups[i.product_category].append(f"{i.product_name}({i.quantity})")
        details = " | ".join([f"[{cat}] {', '.join(prods)}" for cat, prods in cat_groups.items()])
        
        cat_price_sums = {}
        for i in items: cat_price_sums[i.product_category] = cat_price_sums.get(i.product_category, 0) + (i.price * i.quantity)
        delivery_fee = sum(1900 + (1900 if amt_ >= 50000 else 0) for amt_ in cat_price_sums.values())
        points_used = session.get('points_used', 0) or 0
        quick_extra = session.get('quick_extra_fee', 0) or 0
        original_total = int(amt) + points_used  # ê²°ì œì°½ì— ë„˜ê¸´ ê¸ˆì•¡(amt) + ì‚¬ìš© í¬ì¸íŠ¸ = ì£¼ë¬¸ ì›ê¸ˆì•¡

        # ì£¼ë¬¸ ì‹œ ë³€ê²½í•œ ë°°ì†¡ì§€ê°€ ìˆìœ¼ë©´ session ê°’ ì‚¬ìš©, ì—†ìœ¼ë©´ íšŒì› ê¸°ë³¸ ì£¼ì†Œ ì‚¬ìš©
        delivery_addr = session.get('order_address') or current_user.address or ""
        delivery_addr_detail = session.get('order_address_detail') or current_user.address_detail or ""
        delivery_entrance_pw = session.get('order_entrance_pw') or current_user.entrance_pw or ""
        delivery_address_str = f"({delivery_addr}) {delivery_addr_detail} (í˜„ê´€:{delivery_entrance_pw})"

        # ì£¼ë¬¸ ì €ì¥ í›„ í’ˆëª©ë³„ OrderItem ìƒì„± (ë¶€ë¶„ ì·¨ì†Œ ê°€ëŠ¥í•˜ë„ë¡). í€µ ì¶”ê°€ë£ŒëŠ” ì£¼ë¬¸ì— ê¸°ë¡. UTM ìœ ì… ê²½ë¡œ ì €ì¥.
        order = Order(
            user_id=current_user.id, customer_name=current_user.name, customer_phone=current_user.phone, customer_email=current_user.email,
            product_details=details, total_price=original_total, delivery_fee=delivery_fee, tax_free_amount=sum(i.price * i.quantity for i in items if i.tax_type == 'ë©´ì„¸'),
            order_id=oid, payment_key=pk, delivery_address=delivery_address_str, request_memo=current_user.request_memo,
            status='ê²°ì œì™„ë£Œ', points_used=points_used, quick_extra_fee=quick_extra,
            utm_source=session.get('utm_source'), utm_medium=session.get('utm_medium'), utm_campaign=session.get('utm_campaign')
        )
        db.session.add(order)
        db.session.flush()  # order.id í™•ë³´
        for i in items:
            db.session.add(OrderItem(order_id=order.id, product_id=i.product_id, product_name=i.product_name, product_category=i.product_category, price=i.price, quantity=i.quantity, tax_type=i.tax_type or 'ê³¼ì„¸', item_status='ê²°ì œì™„ë£Œ'))
        db.session.flush()  # OrderItem.id í™•ë³´
        
        # ì •ì‚° ì „ìš© í…Œì´ë¸”: í’ˆëª©ë³„ ê³ ìœ  në„˜ë²„(settlement_no) ë¶€ì—¬. ì •ì‚°í•©ê³„=íŒë§¤ê¸ˆì•¡-ìˆ˜ìˆ˜ë£Œ5.5%-ë°°ì†¡ê´€ë¦¬ë¹„990ì›(ì „ì²´í•­ëª© VATí¬í•¨ê°€ê²©)
        order_items = OrderItem.query.filter_by(order_id=order.id).order_by(OrderItem.id.asc()).all()
        delivery_fee_per_settlement = 990  # ì •ì‚°ë²ˆí˜¸ë‹¹ ë°°ì†¡ê´€ë¦¬ë¹„ 990ì›
        for oi in order_items:
            sales_amount = oi.price * oi.quantity
            fee = round(sales_amount * 0.055)
            total = sales_amount - fee - delivery_fee_per_settlement
            settlement_no = "N" + str(oi.id).zfill(10)  # í’ˆëª©ë³„ ê³ ìœ  ì¤‘ë³µ ì—†ëŠ” në„˜ë²„
            # ë©´ì„¸ì—¬ë¶€: íŒë§¤ì ê´€ë¦¬(ì¹´í…Œê³ ë¦¬)ì˜ ê³¼ì„¸/ë©´ì„¸ ì„¤ì • ê¸°ì¤€
            cat = Category.query.filter_by(name=oi.product_category).first()
            tax_exempt_val = (getattr(cat, 'tax_type', None) or 'ê³¼ì„¸') == 'ë©´ì„¸'
            db.session.add(Settlement(
                settlement_no=settlement_no, order_id=order.id, order_item_id=oi.id,
                sale_dt=order.created_at, category=oi.product_category,
                tax_exempt=tax_exempt_val,
                product_name=oi.product_name, sales_amount=sales_amount, fee=fee,
                delivery_fee=delivery_fee_per_settlement, settlement_total=total,
                settlement_status='ì…ê¸ˆëŒ€ê¸°', settled_at=None
            ))
        
        # ì¬ê³  ì°¨ê°
        for i in items:
            p = Product.query.get(i.product_id)
            if p: p.stock -= i.quantity
        
        apply_order_points(current_user, original_total, points_used, order.id)
        if session.get('save_address_to_profile') and delivery_addr:
            try:
                current_user.address = delivery_addr
                current_user.address_detail = delivery_addr_detail
                current_user.entrance_pw = delivery_entrance_pw
            except Exception:
                pass
        session.pop('points_used', None)
        session.pop('quick_extra_fee', None)
        session.pop('order_address', None)
        session.pop('order_address_detail', None)
        session.pop('order_entrance_pw', None)
        session.pop('save_address_to_profile', None)
        Cart.query.filter_by(user_id=current_user.id).delete()
        db.session.commit()
        title, body = get_template_content('order_created', order_id=oid)
        send_message(current_user.id, title, body, 'order_created', order.id)
        db.session.commit()

        # âœ… ì„¸ë ¨ëœ ì„±ê³µ í™”ë©´ êµ¬ì„± (í’ˆëª© ìˆ˜Â·í•©ê³„ ê¸ˆì•¡ ì•ˆë‚´ + ì•±/ì•Œë¦¼ ì•ˆë‚´)
        item_count = sum(i.quantity for i in items)
        total_amount = int(amt)
        success_content = f"""
        <div class="max-w-md mx-auto py-20 md:py-32 px-6 text-center font-black">
            <div class="w-24 h-24 bg-teal-500 rounded-full flex items-center justify-center text-white text-4xl mx-auto mb-10 shadow-2xl animate-bounce">
                <i class="fas fa-check"></i>
            </div>
            
            <h2 class="text-3xl md:text-4xl font-black mb-4 text-gray-800 tracking-tighter italic uppercase">
                ì£¼ë¬¸ ì„±ê³µ!
            </h2>
            <p class="text-gray-700 font-bold text-sm md:text-base mb-4 leading-relaxed">
                í’ˆëª© {item_count}ê°œ, í•©ê³„ {total_amount:,}ì›ì´ ì£¼ë¬¸ë˜ì—ˆìŠµë‹ˆë‹¤.
            </p>
            <p class="text-gray-400 font-bold text-xs md:text-sm mb-12 leading-relaxed">
                ì•± ì„¤ì¹˜ í›„ ì•Œë¦¼ ì„¤ì • ì‹œ ë°°ì†¡ ì§„í–‰ ê³¼ì •ì„ ì•ˆë‚´ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>

            <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-xl mb-12 text-left space-y-5">
                <div class="pb-4 border-b border-gray-50">
                    <p class="text-[10px] text-gray-400 uppercase tracking-widest mb-1 font-black">Order ID</p>
                    <p class="text-sm font-black text-gray-700">{ oid }</p>
                </div>
                <div>
                    <p class="text-[10px] text-gray-400 uppercase tracking-widest mb-1 font-black">ê²°ì œ ê¸ˆì•¡</p>
                    <p class="text-2xl font-black text-teal-600 italic">{ "{:,}".format(total_amount) }ì›</p>
                </div>
            </div>

            <div class="flex flex-col gap-4">
                <a href="/mypage" class="bg-gray-800 text-white py-6 rounded-3xl font-black text-lg shadow-xl hover:bg-black transition active:scale-95">
                    ì£¼ë¬¸ ë‚´ì—­ í™•ì¸í•˜ê¸°
                </a>
                <a href="/" class="bg-white text-gray-400 py-4 rounded-3xl font-black text-sm hover:text-teal-600 transition">
                    ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </a>
            </div>
            
            <p class="mt-12 text-[10px] text-gray-300 font-medium">
                ë¬¸ì˜ ì‚¬í•­ì´ ìˆìœ¼ì‹œë©´ 1666-8320ìœ¼ë¡œ ì—°ë½ì£¼ì„¸ìš”.
            </p>
        </div>
        """
        return render_template_string(HEADER_HTML + success_content + FOOTER_HTML)

    return redirect('/')

# --------------------------------------------------------------------------------
# 6. ê´€ë¦¬ì ì „ìš© ê¸°ëŠ¥ (Dashboard / Bulk Upload / Excel)
# --------------------------------------------------------------------------------
# --- [ì‹ ê·œ ì¶”ê°€] ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ìì˜ ë°°ì†¡ ìš”ì²­ ê¸°ëŠ¥ ---
# âœ… ê°œë³„ ì •ì‚° ìŠ¹ì¸ì„ ìœ„í•œ ë¼ìš°íŠ¸ ì‹ ì„¤
@login_required
def admin_settle_order(order_id):
    """ì£¼ë¬¸ë³„ ì •ì‚° í™•ì • ì²˜ë¦¬ ë° DB ì €ì¥"""
    if not current_user.is_admin:
        flash("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.")
        return redirect('/')
    
    order = Order.query.get_or_404(order_id)
    
    if not order.is_settled:
        order.is_settled = True
        order.settled_at = datetime.now() # ì •ì‚° ì‹œì  ê¸°ë¡
        
        try:
            db.session.commit() # âœ… ì‹¤ì œ DBì— ê°•ì œ ê¸°ë¡
            flash(f"ì£¼ë¬¸ {order.order_id[-8:]} ì…ê¸ˆ ìŠ¹ì¸ ì™„ë£Œ!")
        except Exception as e:
            db.session.rollback()
            flash(f"ì €ì¥ ì˜¤ë¥˜: {str(e)}")
    else:
        flash("ì´ë¯¸ ì²˜ë¦¬ëœ ì£¼ë¬¸ì…ë‹ˆë‹¤.")
        
    # âœ… ì‚¬ìš©ìê°€ ë³´ë˜ ë‚ ì§œ í•„í„°ê°€ ìœ ì§€ë˜ë„ë¡ ì´ì „ í˜ì´ì§€(referrer)ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    return redirect(request.referrer or url_for('admin_dashboard', tab='orders'))
@app.route('/admin/order/bulk_request_delivery', methods=['POST'])

# admin() í•¨ìˆ˜ ë‚´ ì£¼ë¬¸ ì¡°íšŒ ë¶€ë¶„ì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€í•˜ë˜ UIì—ì„œ í•„ë“œë¥¼ ì‚¬ìš©í•¨
@login_required
def admin_bulk_request_delivery():
    """ì—¬ëŸ¬ ì£¼ë¬¸ì„ í•œêº¼ë²ˆì— ë°°ì†¡ ìš”ì²­ ìƒíƒœë¡œ ë³€ê²½ (ìƒˆë¡œê³ ì¹¨ ì—†ìŒ)"""
    if not (current_user.is_admin or Category.query.filter_by(manager_email=current_user.email).first()):
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    
    data = request.get_json()
    order_ids = data.get('order_ids', [])
    
    if not order_ids:
        return jsonify({"success": False, "message": "ì„ íƒëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤."})

    # 'ê²°ì œì™„ë£Œ' ìƒíƒœì¸ ì£¼ë¬¸ë“¤ë§Œ ì°¾ì•„ì„œ 'ë°°ì†¡ìš”ì²­'ìœ¼ë¡œ ì¼ê´„ ë³€ê²½ + í’ˆëª©ë³„ ìƒíƒœ ë°˜ì˜
    orders = Order.query.filter(Order.order_id.in_(order_ids), Order.status == 'ê²°ì œì™„ë£Œ').all()
    
    count = 0
    for o in orders:
        o.status = 'ë°°ì†¡ìš”ì²­'
        # í•´ë‹¹ ì£¼ë¬¸ì˜ ëª¨ë“  í’ˆëª©ì—ë„ ë°°ì†¡ìš”ì²­ ìƒíƒœ ì ìš©
        for oi in OrderItem.query.filter_by(order_id=o.id, cancelled=False).all():
            oi.item_status = 'ë°°ì†¡ìš”ì²­'
        title, body = get_template_content('delivery_requested', order_id=o.order_id)
        send_message(o.user_id, title, body, 'delivery_requested', o.id)
        count += 1

    db.session.commit()
    return jsonify({"success": True, "message": f"{count}ê±´ì˜ ë°°ì†¡ ìš”ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."})


def _save_delivery_proof_image(file):
    """ë°°ì†¡ì™„ë£Œ ì¦ë¹™ ì‚¬ì§„ ì €ì¥. ë°˜í™˜: URL ë˜ëŠ” None. í—ˆìš© í™•ì¥ìë§Œ ì €ì¥."""
    if not file or not getattr(file, 'filename', None) or file.filename == '' or not _is_allowed_image_filename(file.filename):
        return None
    folder = os.path.join(app.config['UPLOAD_FOLDER'], 'delivery_proof')
    os.makedirs(folder, exist_ok=True)
    ext = os.path.splitext(secure_filename(file.filename))[1].lower() or '.jpg'
    if ext not in ALLOWED_IMAGE_EXTENSIONS:
        ext = '.jpg'
    new_name = f"proof_{datetime.now().strftime('%Y%m%d_%H%M%S_%f')}{ext}"
    path = os.path.join(folder, new_name)
    try:
        file.save(path)
        return f"/static/uploads/delivery_proof/{new_name}"
    except Exception:
@app.route('/admin/order/item_status', methods=['POST'])
        return None


@login_required
def admin_order_item_status():
    """ê´€ë¦¬ì: í’ˆëª©ë³„ ìƒíƒœ ì ìš© (í’ˆì ˆì·¨ì†ŒÂ·ë°°ì†¡ì§€ì—°Â·ë°°ì†¡ì¤‘Â·ë°°ì†¡ì™„ë£Œ ë“±). ë°°ì†¡ì™„ë£Œ ì‹œ ì²¨ë¶€ ì´ë¯¸ì§€ ìˆìœ¼ë©´ ê³ ê° ë©”ì‹œì§€ì— í¬í•¨."""
    if not (current_user.is_admin or Category.query.filter_by(manager_email=current_user.email).first()):
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    if request.content_type and 'multipart/form-data' in request.content_type:
        order_id = request.form.get('order_id', type=int)
        item_id = request.form.get('item_id', type=int)
        item_status = (request.form.get('item_status') or '').strip()
        status_message = (request.form.get('status_message') or '').strip() or None
        delivery_photo = request.files.get('delivery_photo')
    else:
        data = request.get_json() or {}
        order_id = data.get('order_id')
        item_id = data.get('item_id')
        item_status = (data.get('item_status') or '').strip()
        status_message = (data.get('status_message') or '').strip() or None
        delivery_photo = None
    if not order_id or not item_id or not item_status:
        return jsonify({"success": False, "message": "order_id, item_id, item_statusê°€ í•„ìš”í•©ë‹ˆë‹¤."})
    order = Order.query.get(order_id)
    oi = OrderItem.query.filter_by(id=item_id, order_id=order_id).first()
    if not order or not oi:
        return jsonify({"success": False, "message": "ì£¼ë¬¸ ë˜ëŠ” í’ˆëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."})
    # ì¹´í…Œê³ ë¦¬ ë§¤ë‹ˆì €ëŠ” ìê¸° ì¹´í…Œê³ ë¦¬ í’ˆëª©ë§Œ
    if not current_user.is_admin and oi.product_category not in [c.name for c in Category.query.filter_by(manager_email=current_user.email).all()]:
        return jsonify({"success": False, "message": "í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ê´€ë¦¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    allowed = ('ê²°ì œì™„ë£Œ', 'ë°°ì†¡ìš”ì²­', 'ë°°ì†¡ì¤‘', 'ë°°ì†¡ì™„ë£Œ', 'í’ˆì ˆì·¨ì†Œ', 'ë°°ì†¡ì§€ì—°', 'ë¶€ë¶„ì·¨ì†Œ')
    if item_status not in allowed:
        return jsonify({"success": False, "message": f"item_statusëŠ” {allowed} ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•©ë‹ˆë‹¤."})

    old_item_status = getattr(oi, 'item_status', None) or 'ê²°ì œì™„ë£Œ'
    if item_status == 'í’ˆì ˆì·¨ì†Œ':
        if oi.cancelled:
            return jsonify({"success": False, "message": "ì´ë¯¸ ì·¨ì†Œëœ í’ˆëª©ì…ë‹ˆë‹¤."})
        cancel_amount = oi.price * oi.quantity
        tax_free_cancel = (oi.price * oi.quantity) if (oi.tax_type == 'ë©´ì„¸') else 0
        if order.payment_key and cancel_amount > 0:
            url = f"https://api.tosspayments.com/v1/payments/{order.payment_key}/cancel"
            auth_key = base64.b64encode(f"{TOSS_SECRET_KEY}:".encode()).decode()
            body = {"cancelAmount": cancel_amount, "cancelReason": "í’ˆì ˆë¡œ ì¸í•œ ë¶€ë¶„ ì·¨ì†Œ"}
            if tax_free_cancel:
                body["taxFreeAmount"] = tax_free_cancel
            res = requests.post(url, json=body, headers={"Authorization": f"Basic {auth_key}", "Content-Type": "application/json"})
            if res.status_code not in (200, 201):
                try:
                    err = res.json()
                    return jsonify({"success": False, "message": err.get("message", "í™˜ë¶ˆ ìš”ì²­ ì‹¤íŒ¨")})
                except Exception:
                    return jsonify({"success": False, "message": "í™˜ë¶ˆ ìš”ì²­ ì‹¤íŒ¨"})
        oi.cancelled = True
        oi.item_status = 'í’ˆì ˆì·¨ì†Œ'
        oi.status_message = status_message or "í’ˆì ˆë¡œ ì¸í•œ ë¶€ë¶„ ì·¨ì†Œ"
        p = Product.query.get(oi.product_id)
        if p:
            p.stock += oi.quantity
        _recalc_order_from_items(order)
        title, body = get_template_content('out_of_stock', order_id=order.order_id)
        send_message(order.user_id, title, body, 'out_of_stock', order.id)
    else:
        oi.item_status = item_status
        oi.status_message = status_message
        if item_status == 'ë°°ì†¡ì™„ë£Œ' and delivery_photo:
            proof_url = _save_delivery_proof_image(delivery_photo)
            if proof_url:
                oi.delivery_proof_image_url = proof_url
        if not oi.cancelled and item_status == 'ë°°ì†¡ì™„ë£Œ':
            apply_points_on_delivery_complete(oi)  # ì •ì‚°ë²ˆí˜¸(sales_amount) ê¸°ì¤€ í¬ì¸íŠ¸ ì ë¦½ (1íšŒë§Œ)

    db.session.add(OrderItemLog(order_id=order_id, order_item_id=item_id, log_type='item_status', old_value=old_item_status, new_value=item_status, created_at=datetime.now()))
    db.session.commit()
    # ë°°ì†¡ ìƒíƒœ ë³€ê²½ ì‹œ íšŒì›ì—ê²Œ ìë™ ë©”ì‹œì§€ (ë°°ì†¡ì™„ë£Œ ì‹œ ê¸°ì‚¬ ì‚¬ì§„ ìˆìœ¼ë©´ ì²¨ë¶€)
    if item_status in ('ë°°ì†¡ìš”ì²­', 'ë°°ì†¡ì¤‘', 'ë°°ì†¡ì™„ë£Œ', 'ë°°ì†¡ì§€ì—°'):
        if item_status == 'ë°°ì†¡ìš”ì²­':
            title, body = get_template_content('delivery_requested', order_id=order.order_id)
            send_message(order.user_id, title, body, 'delivery_requested', order.id)
        elif item_status == 'ë°°ì†¡ì¤‘':
            title, body = get_template_content('delivery_in_progress', order_id=order.order_id)
            send_message(order.user_id, title, body, 'delivery_in_progress', order.id)
        elif item_status == 'ë°°ì†¡ì™„ë£Œ':
            title, body = get_template_content('delivery_complete', order_id=order.order_id)
            proof_url = getattr(oi, 'delivery_proof_image_url', None) or None
            send_message(order.user_id, title, body, 'delivery_complete', order.id, image_url=proof_url)
        elif item_status == 'ë°°ì†¡ì§€ì—°':
            title, body = get_template_content('delivery_delayed', order_id=order.order_id)
            send_message(order.user_id, title, body, 'delivery_delayed', order.id)
        db.session.commit()
@app.route('/admin/order/<int:order_id>/items')
    return jsonify({"success": True, "message": f"í’ˆëª© ìƒíƒœê°€ '{item_status}'(ìœ¼)ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤."})


@login_required
def admin_order_items(order_id):
    """ê´€ë¦¬ì: ì£¼ë¬¸ë³„ í’ˆëª© ëª©ë¡ ë° í’ˆëª©ë³„ ìƒíƒœ/ë©”ì‹œì§€ ì ìš© í™”ë©´"""
    if not (current_user.is_admin or Category.query.filter_by(manager_email=current_user.email).first()):
        flash("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin')
    order = Order.query.get_or_404(order_id)
    my_categories = [c.name for c in Category.query.filter_by(manager_email=current_user.email).all()]
    if not current_user.is_admin and order.id:  # ì£¼ë¬¸ì— ë‚´ ì¹´í…Œê³ ë¦¬ í’ˆëª©ì´ ìˆëŠ”ì§€ í™•ì¸
        items = OrderItem.query.filter_by(order_id=order_id).all()
        if not any(oi.product_category in my_categories for oi in items):
            flash("í•´ë‹¹ ì£¼ë¬¸ì— ëŒ€í•œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")
            return redirect('/admin?tab=orders')
    order_items = OrderItem.query.filter_by(order_id=order_id).order_by(OrderItem.id.asc()).all()
    _order_item_status_tpl = """
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="bg-gray-50 p-6 font-sans text-sm">
        <div class="max-w-4xl mx-auto">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-xl font-black text-gray-800">í’ˆëª©ë³„ ìƒíƒœ ê´€ë¦¬ Â· ì£¼ë¬¸ {{ order.order_id[-12:] if order.order_id else order_id }}</h1>
                <a href="/admin?tab=orders" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-xl font-bold hover:bg-gray-300">ëª©ë¡ìœ¼ë¡œ</a>
            </div>
            <p class="text-gray-500 mb-4">ê° í’ˆëª©ì— ìƒíƒœ(í’ˆì ˆì·¨ì†ŒÂ·ë°°ì†¡ì§€ì—°Â·ë°°ì†¡ì¤‘Â·ë°°ì†¡ì™„ë£Œ ë“±)ì™€ ì‚¬ìœ  ë©”ì‹œì§€ë¥¼ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-gray-100 border-b border-gray-200">
                        <tr>
                            <th class="p-4 font-black">í’ˆëª©</th>
                            <th class="p-4 font-black">ìˆ˜ëŸ‰/ê¸ˆì•¡</th>
                            <th class="p-4 font-black">í˜„ì¬ ìƒíƒœ</th>
                            <th class="p-4 font-black">ìƒíƒœ ë³€ê²½</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for oi in order_items %}
                        <tr class="border-b border-gray-50 hover:bg-gray-50/50" data-item-id="{{ oi.id }}">
                            <td class="p-4">
                                <span class="font-bold text-gray-800">{{ oi.product_name }}</span>
                                {% if oi.cancelled %}<span class="ml-2 text-red-500 text-xs font-black">ì·¨ì†Œë¨</span>{% endif %}
                            </td>
                            <td class="p-4 text-gray-600">{{ oi.quantity }}ê°œ Â· {{ "{:,}".format(oi.price * oi.quantity) }}ì›</td>
                            <td class="p-4">
                                <span class="font-bold {% if oi.item_status in ['í’ˆì ˆì·¨ì†Œ','ë¶€ë¶„ì·¨ì†Œ'] %}text-red-600{% elif oi.item_status == 'ë°°ì†¡ì§€ì—°' %}text-amber-600{% else %}text-teal-600{% endif %}">{{ oi.item_status or 'ê²°ì œì™„ë£Œ' }}</span>
                                {% if oi.status_message %}<p class="text-xs text-gray-500 mt-1">{{ oi.status_message }}</p>{% endif %}
                            </td>
                            <td class="p-4">
                                {% if not oi.cancelled %}
                                <div class="flex flex-wrap gap-2 items-end">
                                    <select class="item-status-select border border-gray-200 rounded-lg px-3 py-2 font-bold text-xs" data-order-id="{{ order.id }}" data-item-id="{{ oi.id }}">
                                        {% set current = oi.item_status or 'ê²°ì œì™„ë£Œ' %}
                                        <option value="ê²°ì œì™„ë£Œ" {% if current == 'ê²°ì œì™„ë£Œ' %}selected{% endif %}>ê²°ì œì™„ë£Œ</option>
                                        <option value="ë°°ì†¡ìš”ì²­" {% if current == 'ë°°ì†¡ìš”ì²­' %}selected{% endif %}>ë°°ì†¡ìš”ì²­</option>
                                        <option value="ë°°ì†¡ì§€ì—°" {% if current == 'ë°°ì†¡ì§€ì—°' %}selected{% endif %}>ë°°ì†¡ì§€ì—°</option>
                                        <option value="ë°°ì†¡ì¤‘" {% if current == 'ë°°ì†¡ì¤‘' %}selected{% endif %}>ë°°ì†¡ì¤‘</option>
                                        <option value="ë°°ì†¡ì™„ë£Œ" {% if current == 'ë°°ì†¡ì™„ë£Œ' %}selected{% endif %}>ë°°ì†¡ì™„ë£Œ</option>
                                        <option value="í’ˆì ˆì·¨ì†Œ" {% if current == 'í’ˆì ˆì·¨ì†Œ' %}selected{% endif %}>í’ˆì ˆì·¨ì†Œ</option>
                                    </select>
                                    <input type="text" class="item-message border border-gray-200 rounded-lg px-3 py-2 w-40 text-xs" placeholder="ì‚¬ìœ  ë©”ì‹œì§€" value="{{ oi.status_message or '' }}">
                                    <div class="item-delivery-photo-wrap hidden">
                                        <label class="text-[10px] text-gray-500 block mb-1">ë°°ì†¡ì™„ë£Œ ì‚¬ì§„ (ê³ ê° ë©”ì‹œì§€ì— ì²¨ë¶€)</label>
                                        <input type="file" class="item-delivery-photo border border-gray-200 rounded-lg px-2 py-1 text-[10px]" accept="image/*">
                                    </div>
                                    {% if getattr(oi, 'delivery_proof_image_url', None) %}<a href="{{ oi.delivery_proof_image_url }}" target="_blank" class="text-[10px] text-teal-600 font-bold">ê¸°ì¡´ ì‚¬ì§„ ë³´ê¸°</a>{% endif %}
                                    <button type="button" class="apply-item-status bg-teal-600 text-white px-4 py-2 rounded-lg font-bold text-xs hover:bg-teal-700" data-order-id="{{ order.id }}" data-item-id="{{ oi.id }}">ì ìš©</button>
                                </div>
                                {% else %}
                                <span class="text-gray-400 text-xs">ì·¨ì†Œëœ í’ˆëª©</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <p id="api-message" class="mt-4 text-sm font-bold hidden"></p>
        </div>
        <script>
        document.querySelectorAll('.item-status-select').forEach(function(select) {
            select.addEventListener('change', function() {
                var row = this.closest('tr');
                var wrap = row ? row.querySelector('.item-delivery-photo-wrap') : null;
                if (wrap) { wrap.classList.toggle('hidden', this.value !== 'ë°°ì†¡ì™„ë£Œ'); }
            });
            var row = select.closest('tr');
            var wrap = row ? row.querySelector('.item-delivery-photo-wrap') : null;
            if (wrap && select.value === 'ë°°ì†¡ì™„ë£Œ') wrap.classList.remove('hidden');
        });
        document.querySelectorAll('.apply-item-status').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var orderId = this.dataset.orderId;
                var itemId = this.dataset.itemId;
                var row = this.closest('tr');
                var select = row.querySelector('.item-status-select');
                var message = row.querySelector('.item-message');
                var photoInput = row.querySelector('.item-delivery-photo');
                var status = select ? select.value : '';
                var msg = message ? message.value.trim() : '';
                var hasFile = photoInput && photoInput.files && photoInput.files.length > 0 && status === 'ë°°ì†¡ì™„ë£Œ';
                if (hasFile) {
                    var fd = new FormData();
                    fd.append('order_id', orderId);
                    fd.append('item_id', itemId);
                    fd.append('item_status', status);
                    if (msg) fd.append('status_message', msg);
                    fd.append('delivery_photo', photoInput.files[0]);
                    fetch('/admin/order/item_status', { method: 'POST', body: fd }).then(function(r) { return r.json(); }).then(function(data) {
                        var el = document.getElementById('api-message');
                        el.textContent = data.message || (data.success ? 'ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì˜¤ë¥˜');
                        el.classList.remove('hidden');
                        el.className = 'mt-4 text-sm font-bold ' + (data.success ? 'text-teal-600' : 'text-red-600');
                        if (data.success) setTimeout(function() { location.reload(); }, 800);
                    }).catch(function() {
                        document.getElementById('api-message').textContent = 'í†µì‹  ì˜¤ë¥˜';
                        document.getElementById('api-message').classList.remove('hidden').classList.add('text-red-600');
                    });
                } else {
                    fetch('/admin/order/item_status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ order_id: parseInt(orderId), item_id: parseInt(itemId), item_status: status, status_message: msg || null })
                    }).then(function(r) { return r.json(); }).then(function(data) {
                        var el = document.getElementById('api-message');
                        el.textContent = data.message || (data.success ? 'ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì˜¤ë¥˜');
                        el.classList.remove('hidden');
                        el.className = 'mt-4 text-sm font-bold ' + (data.success ? 'text-teal-600' : 'text-red-600');
                        if (data.success) setTimeout(function() { location.reload(); }, 800);
                    }).catch(function() {
                        document.getElementById('api-message').textContent = 'í†µì‹  ì˜¤ë¥˜';
                        document.getElementById('api-message').classList.remove('hidden', 'text-teal-600').classList.add('text-red-600');
                    });
                }
            });
        });
        </script>
    </body>
    </html>
    """
    return render_template_string(_order_item_status_tpl, order=order, order_items=order_items)


def _ensure_delivery_zone_columns():
    """delivery_zone í…Œì´ë¸”ì— í€µì§€ì—­Â·ê·¸ ì™¸ ë°°ì†¡ë¶ˆê°€ìš© ì»¬ëŸ¼ì´ ì—†ìœ¼ë©´ ì¶”ê°€ (ê¸°ì¡´ DB í˜¸í™˜)."""
    try:
        from sqlalchemy import inspect
        insp = inspect(db.engine)
        cols = [c['name'] for c in insp.get_columns('delivery_zone')]
        if 'quick_region_names' not in cols:
            db.session.execute(text("ALTER TABLE delivery_zone ADD COLUMN quick_region_names TEXT"))
            db.session.commit()
    except Exception:
        try:
            db.session.rollback()
        except Exception:
            pass
    try:
        from sqlalchemy import inspect
        insp = inspect(db.engine)
        cols = [c['name'] for c in insp.get_columns('delivery_zone')]
        if 'use_quick_region_only' not in cols:
            db.session.execute(text("ALTER TABLE delivery_zone ADD COLUMN use_quick_region_only BOOLEAN DEFAULT 0"))
            db.session.commit()
    except Exception:
        try:
            db.session.rollback()
        except Exception:
            pass
    try:
        from sqlalchemy import inspect
        insp = inspect(db.engine)
        cols = [c['name'] for c in insp.get_columns('delivery_zone')]
        if 'quick_region_polygon_json' not in cols:
            db.session.execute(text("ALTER TABLE delivery_zone ADD COLUMN quick_region_polygon_json TEXT"))
            db.session.commit()
    except Exception:
        try:
            db.session.rollback()
        except Exception:
            pass
    for col, sql in [
        ('quick_extra_fee', 'ALTER TABLE delivery_zone ADD COLUMN quick_extra_fee INTEGER DEFAULT 10000'),
        ('quick_extra_message', 'ALTER TABLE delivery_zone ADD COLUMN quick_extra_message TEXT'),
    ]:
        try:
            insp = inspect(db.engine)
            cols = [c['name'] for c in insp.get_columns('delivery_zone')]
            if col not in cols:
                db.session.execute(text(sql))
                db.session.commit()
        except Exception:
            try:
                db.session.rollback()
            except Exception:
                pass
    try:
        insp = inspect(db.engine)
        cols = [c['name'] for c in insp.get_columns('order')]
        if 'quick_extra_fee' not in cols:
            db.session.execute(text("ALTER TABLE \"order\" ADD COLUMN quick_extra_fee INTEGER DEFAULT 0"))
            db.session.commit()
    except Exception:
        try:
            db.session.rollback()
        except Exception:
@app.route('/admin/delivery_zone/api', methods=['GET', 'POST'])
            pass


@login_required
def admin_delivery_zone_api():
    """ë°°ì†¡êµ¬ì—­: GET=í´ë¦¬ê³¤Â·í€µì§€ì—­ ë°˜í™˜, POST=í´ë¦¬ê³¤ ë˜ëŠ” í€µì§€ì—­ ì €ì¥ (ë§ˆìŠ¤í„° ê´€ë¦¬ì ì „ìš©). í€µì§€ì—­ë§Œ ì‚¬ìš© ì‹œ ê·¸ ì™¸ ì§€ì—­ ë°°ì†¡ë¶ˆê°€."""
    if not current_user.is_admin:
        return jsonify({'error': 'ê¶Œí•œ ì—†ìŒ'}), 403
    _ensure_delivery_zone_columns()
    if request.method == 'GET':
        z = DeliveryZone.query.order_by(DeliveryZone.updated_at.desc()).first()
        polygon = []
        quick_region_polygon = []
        quick_region_names = []
        use_quick_region_only = False
        quick_extra_fee = 10000
        quick_extra_message = ''
        if z:
            if z.polygon_json:
                try:
                    polygon = json.loads(z.polygon_json)
                except Exception:
                    pass
            if getattr(z, 'quick_region_polygon_json', None):
                try:
                    quick_region_polygon = json.loads(z.quick_region_polygon_json) or []
                except Exception:
                    pass
            if getattr(z, 'quick_region_names', None):
                try:
                    quick_region_names = json.loads(z.quick_region_names) or []
                except Exception:
                    pass
            use_quick_region_only = bool(getattr(z, 'use_quick_region_only', False))
            quick_extra_fee = int(getattr(z, 'quick_extra_fee', None) or 10000)
            quick_extra_message = (getattr(z, 'quick_extra_message', None) or '') or ''
        return jsonify({'polygon': polygon, 'quick_region_polygon': quick_region_polygon, 'quick_region_names': quick_region_names, 'use_quick_region_only': use_quick_region_only, 'quick_extra_fee': quick_extra_fee, 'quick_extra_message': quick_extra_message})
    # POST
    data = request.get_json() or {}
    z = DeliveryZone.query.order_by(DeliveryZone.updated_at.desc()).first()
    if not z:
        z = DeliveryZone(name='ì—°ìˆ˜êµ¬')
        db.session.add(z)
        db.session.flush()
    updated = False
    if 'polygon' in data:
        polygon = data['polygon']
        if polygon is not None:
            if not isinstance(polygon, list) or len(polygon) < 3:
                return jsonify({'error': 'ê¼­ì§“ì  3ê°œ ì´ìƒ í•„ìš”'}), 400
            try:
                json.dumps(polygon)
            except (TypeError, ValueError):
                return jsonify({'error': 'ìœ íš¨í•œ ì¢Œí‘œ ë°°ì—´ì´ ì•„ë‹˜'}), 400
            z.polygon_json = json.dumps(polygon)
            updated = True
    if 'quick_region_names' in data:
        val = data['quick_region_names']
        if isinstance(val, str):
            val = [n.strip() for n in val.replace('ï¼Œ', ',').split(',') if n.strip()]
        if isinstance(val, list):
            z.quick_region_names = json.dumps([str(n).strip() for n in val if str(n).strip()])
            updated = True
    if 'use_quick_region_only' in data:
        z.use_quick_region_only = data['use_quick_region_only'] in (True, 'true', '1', 1)
        updated = True
    if 'quick_region_polygon' in data:
        qrp = data['quick_region_polygon']
        if qrp is None or (isinstance(qrp, list) and len(qrp) == 0):
            z.quick_region_polygon_json = None
            updated = True
        elif isinstance(qrp, list) and len(qrp) >= 3:
            try:
                json.dumps(qrp)
                z.quick_region_polygon_json = json.dumps(qrp)
                updated = True
            except (TypeError, ValueError):
                return jsonify({'error': 'í€µì§€ì—­ í´ë¦¬ê³¤ ì¢Œí‘œê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'}), 400
        else:
            return jsonify({'error': 'í€µì§€ì—­ í´ë¦¬ê³¤ì€ ê¼­ì§“ì  3ê°œ ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤.'}), 400
    if 'quick_extra_fee' in data:
        try:
            v = data['quick_extra_fee']
            z.quick_extra_fee = int(v) if v not in (None, '') else 10000
            updated = True
        except (TypeError, ValueError):
            z.quick_extra_fee = 10000
            updated = True
    if 'quick_extra_message' in data:
        z.quick_extra_message = (data['quick_extra_message'] or '').strip() or None
        updated = True
    if updated:
        z.updated_at = datetime.utcnow()
    db.session.commit()
    return jsonify({'ok': True})


@login_required
def admin_member_grade_set():
    """íšŒì› ë“±ê¸‰ ì§ì ‘ ì„¤ì • (ë§ˆìŠ¤í„° ì „ìš©). user_id, grade(1~5), overridden(true|false)"""
    if not current_user.is_admin:
        return jsonify({'error': 'ê¶Œí•œ ì—†ìŒ'}), 403
    data = request.get_json() or request.form
    try:
        uid = int(data.get('user_id', 0))
        grade = int(data.get('grade', 1))
        overridden = data.get('overridden', 'true').lower() in ('1', 'true', 'yes')
    except (TypeError, ValueError):
        return jsonify({'error': 'user_id, grade í•„ìš”'}), 400
    if grade not in (1, 2, 3, 4, 5):
        return jsonify({'error': 'gradeëŠ” 1~5ë§Œ ê°€ëŠ¥'}), 400
    u = User.query.get(uid)
    if not u:
        return jsonify({'error': 'íšŒì› ì—†ìŒ'}), 404
    u.member_grade = grade
    u.member_grade_overridden = overridden
    db.session.commit()
    return jsonify({'ok': True})
@app.route('/admin/member_grade/config', methods=['POST'])


@login_required
def admin_member_grade_config():
    """ìë™ ë“±ê¸‰ ê¸°ì¤€ ì €ì¥ (ë§ˆìŠ¤í„° ì „ìš©). min_amount_grade2~5 (ì›)"""
    if not current_user.is_admin:
        return jsonify({'error': 'ê¶Œí•œ ì—†ìŒ'}), 403
    data = request.get_json() or request.form
    def set_val(k, v):
        try:
            val = str(int(v)) if v not in (None, '') else '0'
        except (TypeError, ValueError):
            val = '0'
        row = MemberGradeConfig.query.filter_by(key=k).first()
        if not row:
            row = MemberGradeConfig(key=k, value=val)
            db.session.add(row)
        else:
            row.value = val
    set_val('min_amount_grade2', data.get('min_amount_grade2'))
    set_val('min_amount_grade3', data.get('min_amount_grade3'))
    set_val('min_amount_grade4', data.get('min_amount_grade4'))
    set_val('min_amount_grade5', data.get('min_amount_grade5'))
    db.session.commit()
@app.route('/admin/member_grade/auto_apply', methods=['POST'])
    return jsonify({'ok': True})


@login_required
def admin_member_grade_auto_apply():
    """êµ¬ë§¤ì´ë ¥ìœ¼ë¡œ ë“±ê¸‰ ìë™ ë°˜ì˜ (ì§ì ‘ì„¤ì • ì•„ë‹Œ íšŒì›ë§Œ, ë§ˆìŠ¤í„° ì „ìš©)"""
    if not current_user.is_admin:
        return jsonify({'error': 'ê¶Œí•œ ì—†ìŒ'}), 403
    count = 0
    for u in User.query.filter_by(member_grade_overridden=False).all():
        if recompute_member_grade_for_user(u):
            count += 1
    db.session.commit()
@app.route('/admin/point/config', methods=['POST'])
    return jsonify({'ok': True, 'updated': count})


@login_required
def admin_point_config():
    """í¬ì¸íŠ¸ ì •ì±… ì €ì¥ (ë§ˆìŠ¤í„° ì „ìš©). accumulation_rate(1=0.1%), min_order_to_use, max_points_per_order"""
    if not current_user.is_admin:
        return jsonify({'error': 'ê¶Œí•œ ì—†ìŒ'}), 403
    data = request.get_json() or request.form
    def set_val(k, v):
        try:
            val = str(int(v)) if v not in (None, '') else '0'
        except (TypeError, ValueError):
            val = '0'
        row = PointConfig.query.filter_by(key=k).first()
        if not row:
            row = PointConfig(key=k, value=val)
            db.session.add(row)
        else:
            row.value = val
    set_val('accumulation_rate', data.get('accumulation_rate'))
    set_val('min_order_to_use', data.get('min_order_to_use'))
    set_val('max_points_per_order', data.get('max_points_per_order'))
    db.session.commit()
@app.route('/admin/point/adjust', methods=['POST'])
    return jsonify({'ok': True})


@login_required
def admin_point_adjust():
    """íšŒì› í¬ì¸íŠ¸ ì§€ê¸‰/ì°¨ê° (ë§ˆìŠ¤í„° ì „ìš©). user_id, amount(ì–‘ìˆ˜=ì§€ê¸‰/ìŒìˆ˜=ì°¨ê°), memo"""
    if not current_user.is_admin:
        return jsonify({'error': 'ê¶Œí•œ ì—†ìŒ'}), 403
    data = request.get_json() or request.form
    try:
        uid = int(data.get('user_id', 0))
        amount = int(data.get('amount', 0))
    except (TypeError, ValueError):
        return jsonify({'error': 'user_id, amount í•„ìš”'}), 400
    u = User.query.get(uid)
    if not u:
        return jsonify({'error': 'íšŒì› ì—†ìŒ'}), 404
    memo = (data.get('memo') or '')[:200]
    current_pts = getattr(u, 'points', 0) or 0
    after = current_pts + amount
    if after < 0:
        return jsonify({'error': 'í¬ì¸íŠ¸ê°€ ìŒìˆ˜ê°€ ë  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}), 400
    u.points = after
    db.session.add(PointLog(user_id=u.id, amount=amount, memo=memo or ('ê´€ë¦¬ì ì¡°ì •' if amount >= 0 else 'ê´€ë¦¬ì ì°¨ê°'), adjusted_by=current_user.id))
    db.session.commit()
@app.route('/admin/point/log')
    return jsonify({'ok': True, 'after': after})


@login_required
def admin_point_log():
    """íšŒì›ë³„ í¬ì¸íŠ¸ ë‚´ì—­ (ë§ˆìŠ¤í„° ì „ìš©). user_id, limit ê¸°ë³¸ 30"""
    if not current_user.is_admin:
        return jsonify({'error': 'ê¶Œí•œ ì—†ìŒ'}), 403
    uid = request.args.get('user_id', type=int)
    limit = min(100, max(1, request.args.get('limit', type=int) or 30))
    if not uid:
        return jsonify({'error': 'user_id í•„ìš”'}), 400
    logs = PointLog.query.filter_by(user_id=uid).order_by(PointLog.created_at.desc()).limit(limit).all()
    out = []
    for l in logs:
        modifier = None
        if getattr(l, 'adjusted_by', None):
            mod_user = User.query.get(l.adjusted_by)
            modifier = mod_user.email if mod_user else str(l.adjusted_by)
        out.append({
            'id': l.id, 'amount': l.amount, 'order_id': l.order_id, 'memo': l.memo or '',
            'created_at': l.created_at.strftime('%Y-%m-%d %H:%M') if l.created_at else '',
            'date': l.created_at.strftime('%Y-%m-%d') if l.created_at else '',
            'modifier': modifier  # ìˆ˜ì •ì ì´ë©”ì¼(ê´€ë¦¬ì), ì—†ìœ¼ë©´ ì‹œìŠ¤í…œ
        })
@app.route('/admin/api/member/<int:uid>/message', methods=['POST'])
    return jsonify({'logs': out})


@login_required
def admin_member_send_message(uid):
    """ê´€ë¦¬ì: íŠ¹ì • íšŒì›ì—ê²Œ ë©”ì‹œì§€ ë°œì†¡ (ì œëª©Â·ë‚´ìš©). í‘¸ì‹œ ì•Œë¦¼ í¬í•¨."""
    if not current_user.is_admin:
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    u = User.query.get(uid)
    if not u:
        return jsonify({"success": False, "message": "íšŒì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 404
    data = request.get_json() or request.form
    title = (data.get('title') or '').strip()
    body = (data.get('body') or '').strip()
    if not title:
        return jsonify({"success": False, "message": "ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."})
    mid = send_message(uid, title, body, 'custom', None)
    if mid:
        db.session.commit()
        return jsonify({"success": True, "message": "ë©”ì‹œì§€ë¥¼ ë°œì†¡í–ˆìŠµë‹ˆë‹¤."})
@app.route('/admin/api/member/<int:uid>/delete', methods=['POST'])
    return jsonify({"success": False, "message": "ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."}), 500


@login_required
def admin_member_delete(uid):
    """ê´€ë¦¬ì: íšŒì› ì‚­ì œ. ì£¼ë¬¸ ì´ë ¥ì´ ìˆìœ¼ë©´ ì‚­ì œ ë¶ˆê°€. ê´€ë¦¬ì ê³„ì •ì€ ì‚­ì œ ë¶ˆê°€."""
    if not current_user.is_admin:
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    u = User.query.get(uid)
    if not u:
        return jsonify({"success": False, "message": "íšŒì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 404
    if u.is_admin:
        return jsonify({"success": False, "message": "ê´€ë¦¬ì ê³„ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 400
    if uid == current_user.id:
        return jsonify({"success": False, "message": "ë³¸ì¸ ê³„ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 400
    order_count = Order.query.filter_by(user_id=uid).count()
    if order_count > 0:
        return jsonify({"success": False, "message": f"ì£¼ë¬¸ ì´ë ¥ì´ ìˆëŠ” íšŒì›({order_count}ê±´)ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 400
    try:
        PointLog.query.filter_by(user_id=uid).delete()
        PushSubscription.query.filter_by(user_id=uid).delete()
        UserMessage.query.filter_by(user_id=uid).delete()
        Cart.query.filter_by(user_id=uid).delete()
        db.session.delete(u)
        db.session.commit()
        return jsonify({"success": True, "message": "íšŒì›ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."})
    except Exception as e:
        db.session.rollback()
        return jsonify({"success": False, "message": str(e) or "ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."}), 500


@login_required
def admin_dashboard():
    """ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ - [ë§¤ì¶œ+ë¬¼ë¥˜+ì¹´í…Œê³ ë¦¬+ë¦¬ë·°] ì „ì²´ ê¸°ëŠ¥ í†µí•© ë³µêµ¬ë³¸"""
    categories = Category.query.order_by(Category.order.asc(), Category.id.asc()).all()
    managers = [c.manager_email for c in categories if c.manager_email]
    
    if not (current_user.is_admin or current_user.email in managers):
        flash("ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/')
    
    is_master = current_user.is_admin
    tab = request.args.get('tab', 'products')
    seller_tax = request.args.get('seller_tax', 'ì „ì²´')  # íŒë§¤ì ê´€ë¦¬ ì„œë¸Œíƒ­: ì „ì²´ / ê³¼ì„¸ / ë©´ì„¸
    my_categories = [c.name for c in categories if c.manager_email == current_user.email]
    # ì¹´í…Œê³ ë¦¬ ì„ íƒ: ê¶Œí•œ ìˆëŠ” ì¹´í…Œê³ ë¦¬ë§Œ (ë§ˆìŠ¤í„°=ì „ì²´, ë§¤ë‹ˆì €=ìê¸° ì¹´í…Œê³ ë¦¬ë§Œ)
    selectable_categories = [c for c in categories if is_master or c.name in my_categories]
    sellers_categories = categories
    if tab == 'sellers' and seller_tax in ('ê³¼ì„¸', 'ë©´ì„¸'):
        sellers_categories = [c for c in categories if (getattr(c, 'tax_type', None) or 'ê³¼ì„¸') == seller_tax]
    
    # 1. ë‚ ì§œ ë³€ìˆ˜ ì •ì˜
    now = datetime.now()
    start_date_str = request.args.get('start_date', now.strftime('%Y-%m-%d 00:00')).replace('T', ' ')
    end_date_str = request.args.get('end_date', now.strftime('%Y-%m-%d 23:59')).replace('T', ' ')
    
    # 2. ê³µí†µ ë³€ìˆ˜ ì´ˆê¸°í™”
    sel_cat = request.args.get('category', 'ì „ì²´')
    sel_order_cat = request.args.get('order_cat', 'ì „ì²´')
    products, filtered_orders, summary, daily_stats, reviews = [], [], {}, {}, []
    product_q, product_page, products_total, product_total_pages, per_page = '', 1, 0, 1, 30
    stats = {"sales": 0, "delivery": 0, "count": 0, "grand_total": 0}
    category_names = {}
    order_total_qty, order_total_subtotal = 0, 0
    sales_table_rows = []
    sales_total_quantity = 0
    product_summary_rows = []
    settlement_detail_rows = []
    settlement_detail_orders = []
    settlement_category_totals = {}

    if tab == 'products':
        product_q = (request.args.get('q') or request.args.get('product_q') or '').strip()
        product_page = max(1, int(request.args.get('page', 1)))
        per_page = 30
        q = Product.query
        if not is_master:
            q = q.filter(Product.category.in_(my_categories))
        if product_q:
            q = q.filter(or_(
                Product.name.contains(product_q),
                Product.description.contains(product_q),
                Product.category.contains(product_q)
            ))
        else:
            if sel_cat != 'ì „ì²´':
                q = q.filter_by(category=sel_cat)
        q = q.order_by(Product.id.desc())
        products_total = q.count()
        products = q.offset((product_page - 1) * per_page).limit(per_page).all()
        product_total_pages = max(1, (products_total + per_page - 1) // per_page)
     
    elif tab in ('orders', 'settlement'):
        try:
            # ë‚ ì§œ íŒŒì‹± ì‹œë„
            start_dt = datetime.strptime(start_date_str, '%Y-%m-%d %H:%M')
            end_dt = datetime.strptime(end_date_str, '%Y-%m-%d %H:%M')
        except Exception as e:
            # íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ (ì˜¤ëŠ˜ 00:00 ~ 23:59)
            print(f"Date parsing error: {e}")
            start_dt = now.replace(hour=0, minute=0, second=0)
            end_dt = now.replace(hour=23, minute=59, second=59)

        # ê²°ì œì·¨ì†Œ ì œì™¸ ì£¼ë¬¸ í•„í„°ë§
        all_orders = Order.query.filter(
            Order.created_at >= start_dt, 
            Order.created_at <= end_dt,
            Order.status != 'ê²°ì œì·¨ì†Œ'
        ).order_by(Order.created_at.desc()).all()
        
        for o in all_orders:
            order_date = o.created_at.strftime('%Y-%m-%d')
            if order_date not in daily_stats:
                daily_stats[order_date] = {"sales": 0, "count": 0}

            order_show_flag = False
            current_order_sales = 0  # ë§¤ë‹ˆì €ë³„ ì •ì‚° ëŒ€ìƒ ê¸ˆì•¡ ë³€ìˆ˜
            manager_items_list = []  # ì˜¤ë”ë³„ ì •ì‚°: ë‚´ ì¹´í…Œê³ ë¦¬ í’ˆëª© ëª©ë¡
            manager_qty_total = 0    # ì˜¤ë”ë³„ ì •ì‚°: ë‚´ ì¹´í…Œê³ ë¦¬ ìˆ˜ëŸ‰ í•©ê³„

            # OrderItemì´ ìˆìœ¼ë©´ DB ê¸°ì¤€ìœ¼ë¡œ ê¸ˆì•¡Â·ìˆ˜ëŸ‰ ì§‘ê³„ (ì·¨ì†Œ í’ˆëª© ì œì™¸)
            items = OrderItem.query.filter_by(order_id=o.id, cancelled=False).order_by(OrderItem.id.asc()).all()
            if items:
                for oi in items:
                    if is_master or oi.product_category in my_categories:
                        order_show_flag = True
                        if oi.product_category not in summary:
                            summary[oi.product_category] = {"product_list": {}, "subtotal": 0}
                        item_price = oi.price * oi.quantity
                        manager_qty_total += oi.quantity
                        current_order_sales += item_price
                        summary[oi.product_category]["subtotal"] += item_price
                        summary[oi.product_category]["product_list"][oi.product_name] = summary[oi.product_category]["product_list"].get(oi.product_name, 0) + oi.quantity
                        manager_items_list.append(f"{oi.product_name}({oi.quantity})")
            else:
                # OrderItem ì—†ì„ ë•Œë§Œ product_details í…ìŠ¤íŠ¸ íŒŒì‹±
                parts = (o.product_details or '').split(' | ')
                for part in parts:
                    match = re.search(r'\[(.*?)\] (.*)', part)
                    if match:
                        cat_n = match.group(1).strip()
                        items_str = match.group(2).strip()
                        if is_master or cat_n in my_categories:
                            order_show_flag = True
                            if cat_n not in summary:
                                summary[cat_n] = {"product_list": {}, "subtotal": 0}
                            for item in items_str.split(', '):
                                it_match = re.search(r'(.*?)\((\d+)\)', item)
                                if it_match:
                                    pn = it_match.group(1).strip()
                                    qt = int(it_match.group(2))
                                    manager_items_list.append(f"{pn}({qt})")
                                    manager_qty_total += qt
                                    p_obj = Product.query.filter_by(name=pn).first()
                                    if p_obj:
                                        item_price = p_obj.price * qt
                                        summary[cat_n]["subtotal"] += item_price
                                        summary[cat_n]["product_list"][pn] = summary[cat_n]["product_list"].get(pn, 0) + qt
                                        current_order_sales += item_price

            # ê¶Œí•œì´ ìˆëŠ” ì£¼ë¬¸ ë°ì´í„°ë§Œ í†µê³„ì— ë°˜ì˜ + ì˜¤ë”ë³„ ì •ì‚°ìš© ì†ì„±
            if order_show_flag:
                o._manager_items = manager_items_list
                o._manager_qty = manager_qty_total
                o._manager_subtotal = current_order_sales
                filtered_orders.append(o)
                stats["sales"] += current_order_sales
                stats["count"] += 1
                daily_stats[order_date]["sales"] += current_order_sales
                daily_stats[order_date]["count"] += 1
                if is_master: stats["delivery"] += (o.delivery_fee or 0)

        daily_stats = dict(sorted(daily_stats.items(), reverse=True))
        stats["grand_total"] = stats["sales"] + stats["delivery"]
        # ì˜¤ë”ë³„ ì •ì‚° í˜„í™© í•˜ë‹¨ ì´í•©ê³„ìš©
        order_total_qty = sum(getattr(o, '_manager_qty', 0) for o in filtered_orders)
        order_total_subtotal = sum(getattr(o, '_manager_subtotal', 0) for o in filtered_orders)
        # ë§¤ì¶œ ìƒì„¸ í…Œì´ë¸”ìš©: ìƒë‹¨ ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ ì„ íƒëœ ì¹´í…Œê³ ë¦¬ë§Œ í‘œì‹œ
        sales_table_rows = []
        for o in filtered_orders:
            order_date_str = o.created_at.strftime('%Y-%m-%d %H:%M') if o.created_at else ''
            status_str = o.status or 'ê²°ì œì™„ë£Œ'
            items = OrderItem.query.filter_by(order_id=o.id).order_by(OrderItem.id.asc()).all()
            if items:
                for oi in items:
                    if (is_master or oi.product_category in my_categories) and (sel_order_cat == 'ì „ì²´' or oi.product_category == sel_order_cat):
                        is_cancelled = getattr(oi, 'cancelled', False) or (getattr(oi, 'item_status', None) in ('ë¶€ë¶„ì·¨ì†Œ', 'í’ˆì ˆì·¨ì†Œ'))
                        sales_table_rows.append({
                            'order_date': order_date_str,
                            'product_name': oi.product_name,
                            'category': oi.product_category,
                            'quantity': 0 if is_cancelled else oi.quantity,
                            'status': 'ì·¨ì†Œ' if is_cancelled else (getattr(oi, 'item_status', None) or status_str)
                        })
            else:
                parts = (o.product_details or '').split(' | ')
                for part in parts:
                    match = re.search(r'\[(.*?)\] (.*)', part)
                    if match:
                        cat_n, items_str = match.groups()
                        if (is_master or cat_n in my_categories) and (sel_order_cat == 'ì „ì²´' or cat_n == sel_order_cat):
                            for item in items_str.split(', '):
                                it_match = re.search(r'(.*?)\((\d+)\)', item)
                                if it_match:
                                    pn, qt = it_match.groups()
                                    sales_table_rows.append({'order_date': order_date_str, 'product_name': pn.strip(), 'category': cat_n, 'quantity': int(qt), 'status': status_str})
        # ì¡°íšŒ ê²°ê³¼ ì´í•©ê³„ ìˆ˜ëŸ‰ + í’ˆëª©Â·íŒë§¤ìƒí’ˆëª…ë³„ íŒë§¤ìˆ˜ëŸ‰ ì´í•©ê³„ (ì§‘ê³„ í…Œì´ë¸”ìš©)
        sales_total_quantity = sum(r.get('quantity', 0) for r in sales_table_rows)
        product_summary_rows = []
        from collections import defaultdict
        agg = defaultdict(int)
        for r in sales_table_rows:
            key = (r.get('category') or '', r.get('product_name') or '')
            agg[key] += r.get('quantity', 0)
        for (cat, pname), total_qty in sorted(agg.items(), key=lambda x: (x[0][0], x[0][1])):
            product_summary_rows.append({'category': cat, 'product_name': pname, 'total_quantity': total_qty})

        # ì •ì‚° ì „ìš© í…Œì´ë¸”(Settlement) ê¸°ì¤€: në„˜ë²„(ì •ì‚°ë²ˆí˜¸), íŒë§¤ì¼ì‹œ, ì¹´í…Œê³ ë¦¬, ë©´ì„¸ì—¬ë¶€, í’ˆëª©, íŒë§¤ê¸ˆì•¡, ìˆ˜ìˆ˜ë£Œ, ë°°ì†¡ê´€ë¦¬ë¹„, ì •ì‚°í•©ê³„, ì…ê¸ˆìƒíƒœ(ì…ê¸ˆì¼)
        sel_settlement_status = request.args.get('settlement_status', 'ì „ì²´')
        if sel_settlement_status == 'ì •ì‚°ëŒ€ê¸°': sel_settlement_status = 'ì…ê¸ˆëŒ€ê¸°'
        if sel_settlement_status == 'ì •ì‚°ì™„ë£Œ': sel_settlement_status = 'ì…ê¸ˆì™„ë£Œ'
        # ê¸°ì¡´ OrderItemì— ëŒ€í•œ Settlement ë°±í•„ (ê²°ì œ ì‹œ ìƒì„± ëˆ„ë½ë¶„ ë³´ì¶©)
        for o in filtered_orders:
            items = OrderItem.query.filter_by(order_id=o.id, cancelled=False).order_by(OrderItem.id.asc()).all()
            if not items:
                continue
            for oi in items:
                if not (is_master or oi.product_category in my_categories):
                    continue
                if Settlement.query.filter_by(order_item_id=oi.id).first():
                    continue
                delivery_fee_per_settlement = 990  # ì •ì‚°ë²ˆí˜¸ë‹¹ ë°°ì†¡ê´€ë¦¬ë¹„ 990ì›
                sales_amount = oi.price * oi.quantity
                fee = round(sales_amount * 0.055)
                total = sales_amount - fee - delivery_fee_per_settlement
                settlement_no = "N" + str(oi.id).zfill(10)
                st = getattr(oi, 'settlement_status', None) or getattr(o, 'settlement_status', None) or 'ì…ê¸ˆëŒ€ê¸°'
                if st not in ('ì…ê¸ˆëŒ€ê¸°', 'ì…ê¸ˆì™„ë£Œ', 'ì·¨ì†Œ', 'ë³´ë¥˜'):
                    st = 'ì…ê¸ˆëŒ€ê¸°'
                # ë©´ì„¸ì—¬ë¶€: íŒë§¤ì ê´€ë¦¬(ì¹´í…Œê³ ë¦¬)ì˜ ê³¼ì„¸/ë©´ì„¸ ì„¤ì • ê¸°ì¤€
                cat = Category.query.filter_by(name=oi.product_category).first()
                tax_exempt_val = (getattr(cat, 'tax_type', None) or 'ê³¼ì„¸') == 'ë©´ì„¸'
                db.session.add(Settlement(
                    settlement_no=settlement_no, order_id=o.id, order_item_id=oi.id,
                    sale_dt=o.created_at, category=oi.product_category,
                    tax_exempt=tax_exempt_val,
                    product_name=oi.product_name, sales_amount=sales_amount, fee=fee,
                    delivery_fee=delivery_fee_per_settlement, settlement_total=total,
                    settlement_status=st, settled_at=getattr(oi, 'settled_at', None)
                ))
        try:
            db.session.commit()
        except Exception:
            db.session.rollback()
        # ì •ì‚° ì „ìš© í…Œì´ë¸”ì—ì„œ ì¡°íšŒ (íŒë§¤ì¼ì‹œ, ì¹´í…Œê³ ë¦¬, ë©´ì„¸ì—¬ë¶€, í’ˆëª©, íŒë§¤ê¸ˆì•¡, ìˆ˜ìˆ˜ë£Œ, ë°°ì†¡ê´€ë¦¬ë¹„, ì •ì‚°í•©ê³„, ì…ê¸ˆìƒíƒœ(ì…ê¸ˆì¼))
        q = Settlement.query.filter(Settlement.sale_dt >= start_dt, Settlement.sale_dt <= end_dt)
        if not is_master:
            q = q.filter(Settlement.category.in_(my_categories))
        if sel_order_cat != 'ì „ì²´':
            q = q.filter(Settlement.category == sel_order_cat)
        if sel_settlement_status and sel_settlement_status != 'ì „ì²´':
            q = q.filter(Settlement.settlement_status == sel_settlement_status)
        for s in q.order_by(Settlement.sale_dt.desc()).all():
            settlement_detail_rows.append({
                'settlement_no': s.settlement_no,
                'order_item_id': s.order_item_id,
                'order_pk': s.order_id,
                'sale_dt': s.sale_dt.strftime('%Y-%m-%d %H:%M') if s.sale_dt else '-',
                'category': s.category,
                'tax_exempt': 'ë©´ì„¸' if s.tax_exempt else 'ê³¼ì„¸',
                'product_name': s.product_name,
                'sales_amount': s.sales_amount,
                'fee': s.fee,
                'delivery_fee': s.delivery_fee,
                'settlement_total': s.settlement_total,
                'settlement_status': s.settlement_status,
                'settled_at': s.settled_at.strftime('%Y-%m-%d %H:%M') if s.settled_at else None,
            })
        # ì •ì‚° ìƒì„¸ ì¹´í…Œê³ ë¦¬ë³„ ì´í•©ê³„
        settlement_category_totals = {}
        for r in settlement_detail_rows:
            cat = r.get('category', '')
            row_total = r.get('settlement_total', 0)
            settlement_category_totals[cat] = settlement_category_totals.get(cat, 0) + row_total
        # ì˜¤ë” ëª©ë¡ (ì •ì‚° í…Œì´ë¸”ì€ në„˜ë²„ ê¸°ì¤€ì´ë¯€ë¡œ ë¹ˆ ëª©ë¡ ìœ ì§€)
        settlement_detail_orders = []
            
    elif tab == 'reviews':
        reviews = Review.query.order_by(Review.created_at.desc()).all()
        category_names = {c.id: c.name for c in Category.query.all()}  # ë¦¬ë·° í…Œì´ë¸”ì—ì„œ íŒë§¤ìëª… í‘œì‹œìš©

    delivery_zone_polygon = []
    delivery_zone_quick_polygon = []
    delivery_zone_quick_regions = []
    delivery_zone_use_quick_only = False
    delivery_zone_quick_extra_fee = 10000
    delivery_zone_quick_extra_message = ''
    kakao_map_app_key = KAKAO_MAP_APP_KEY
    if tab == 'delivery_zone' and is_master:
        _ensure_delivery_zone_columns()
        z = DeliveryZone.query.order_by(DeliveryZone.updated_at.desc()).first()
        if z:
            if z.polygon_json:
                try:
                    delivery_zone_polygon = json.loads(z.polygon_json)
                except Exception:
                    pass
            if getattr(z, 'quick_region_polygon_json', None):
                try:
                    delivery_zone_quick_polygon = json.loads(z.quick_region_polygon_json) or []
                except Exception:
                    pass
            if getattr(z, 'quick_region_names', None):
                try:
                    delivery_zone_quick_regions = json.loads(z.quick_region_names) or []
                except Exception:
                    pass
            delivery_zone_use_quick_only = bool(getattr(z, 'use_quick_region_only', False))
            delivery_zone_quick_extra_fee = int(getattr(z, 'quick_extra_fee', None) or 10000)
            delivery_zone_quick_extra_message = (getattr(z, 'quick_extra_message', None) or '').strip() or 'í•´ë‹¹ ì£¼ì†ŒëŠ” ë°°ì†¡ì§€ì—­ì´ ì•„ë‹™ë‹ˆë‹¤. ë°°ì†¡ë£Œ ì¶”ê°€ ì‹œ í€µìœ¼ë¡œ ë°°ì†¡ë©ë‹ˆë‹¤. ì¶”ê°€í•˜ì‹œê³  ì£¼ë¬¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'

    member_grade_users = []
    member_grade_min2 = member_grade_min3 = member_grade_min4 = member_grade_min5 = 0
    if tab == 'member_grade' and is_master:
        min2, min3, min4, min5 = _get_member_grade_config()
        member_grade_min2, member_grade_min3 = min2, min3
        member_grade_min4, member_grade_min5 = min4, min5
        for u in User.query.order_by(User.id.asc()).all():
            if u.is_admin:
                continue
            total_paid = _get_user_total_paid(u.id)
            order_count = Order.query.filter(Order.user_id == u.id, Order.status.notin_(['ì·¨ì†Œ', 'í™˜ë¶ˆ'])).count()
            member_grade_users.append({
                'id': u.id, 'email': u.email or '', 'name': u.name or '',
                'member_grade': getattr(u, 'member_grade', 1) or 1,
                'member_grade_overridden': getattr(u, 'member_grade_overridden', False),
                'total_paid': total_paid, 'order_count': order_count
            })

    point_accumulation_rate = point_min_order = point_max_use = 0
    point_users = []
    if tab == 'point_manage' and is_master:
        rate, min_ord, max_pts = _get_point_config()
        point_accumulation_rate, point_min_order, point_max_use = rate, min_ord, max_pts
        for u in User.query.order_by(User.id.asc()).all():
            point_users.append({
                'id': u.id, 'email': u.email or '', 'name': u.name or '',
                'points': getattr(u, 'points', 0) or 0
            })

    marketing_cost_list = []
    marketing_cost_total = 0
    if tab == 'marketing_cost' and is_master:
        rows = MarketingCost.query.order_by(MarketingCost.created_at.desc()).limit(500).all()
        for mc in rows:
            u = User.query.get(mc.user_id) if mc.user_id else None
            marketing_cost_list.append({
                'id': mc.id, 'order_id': mc.order_id, 'user_id': mc.user_id,
                'user_email': u.email if u else '', 'user_name': u.name if u else '',
                'amount': mc.amount, 'memo': mc.memo or '', 'created_at': mc.created_at
            })
        marketing_cost_total = db.session.query(db.func.coalesce(db.func.sum(MarketingCost.amount), 0)).scalar() or 0

    admin_members = []
    if tab == 'members' and is_master:
        admin_members = User.query.order_by(User.id.asc()).all()

    message_templates = []
    messages_history = []
    if tab == 'messages' and is_master:
        template_types = ['welcome', 'order_created', 'order_cancelled', 'part_cancelled', 'out_of_stock', 'delivery_requested', 'delivery_in_progress', 'delivery_complete', 'delivery_delayed']
        for mt in template_types:
            t = MessageTemplate.query.filter_by(msg_type=mt).first()
            def_title, def_body = _DEFAULT_MESSAGES.get(mt, ('', ''))
            message_templates.append({'msg_type': mt, 'title': t.title if t else def_title, 'body': t.body if t else def_body})
        history_rows = db.session.query(UserMessage, User).join(User, UserMessage.user_id == User.id).order_by(UserMessage.created_at.desc()).limit(150).all()
        messages_history = [{'msg': m, 'user_email': u.email or '', 'user_name': u.name or ''} for m, u in history_rows]

    popup_list = []
    if tab == 'popup' and is_master:
        popup_list = SitePopup.query.order_by(SitePopup.sort_order.asc(), SitePopup.start_at.desc().nullslast()).all()

    admin_restaurant_requests = []
    admin_partnership_inquiries = []
    restaurant_recommend_counts = {}  # tab==restaurant_requestì¼ ë•Œ ì±„ì›€
    if tab == 'restaurant_request' and is_master:
        admin_restaurant_requests = RestaurantRequest.query.order_by(RestaurantRequest.id.desc()).all()
        restaurant_recommend_counts = {}
        for p in admin_restaurant_requests:
            u, d = _restaurant_vote_counts(p.id)
            restaurant_recommend_counts[p.id] = (u, d)
    admin_delivery_requests = []
    delivery_request_vote_counts = {}
    if tab == 'delivery_request' and is_master:
        admin_delivery_requests = DeliveryRequest.query.order_by(DeliveryRequest.id.desc()).all()
        for p in admin_delivery_requests:
            u, d = _delivery_request_vote_counts(p.id)
            delivery_request_vote_counts[p.id] = (u, d)
    if tab == 'partnership' and is_master:
        admin_partnership_inquiries = PartnershipInquiry.query.order_by(PartnershipInquiry.id.desc()).all()

    utm_aggregates = []
    if tab == 'utm' and is_master:
        # ì£¼ë¬¸ ê¸°ì¤€: utm_sourceë³„ ì£¼ë¬¸ ìˆ˜, ë§¤ì¶œ, êµ¬ë§¤ì ìˆ˜(ê²°ì œ ì™„ë£Œ ì£¼ë¬¸ì˜ distinct user_id)
        from sqlalchemy import distinct
        order_stats = db.session.query(
            Order.utm_source,
            func.count(Order.id).label('order_count'),
            func.coalesce(func.sum(Order.total_price), 0).label('revenue'),
            func.count(distinct(Order.user_id)).label('buyer_count')
        ).filter(Order.status != 'ê²°ì œì·¨ì†Œ').group_by(Order.utm_source).all()
        # íšŒì›ê°€ì… ìˆ˜: User.utm_sourceë³„
        signup_counts = db.session.query(
            User.utm_source,
            func.count(User.id).label('signup_count')
        ).group_by(User.utm_source).all()
        signup_map = {(r.utm_source or '').strip() or 'ì§ì ‘/ê¸°íƒ€': r.signup_count for r in signup_counts}
        # ì†ŒìŠ¤ í‚¤ í†µì¼ (None/ë¹ˆê°’ â†’ ì§ì ‘/ê¸°íƒ€)
        def _src(s):
            return (s or '').strip() or 'ì§ì ‘/ê¸°íƒ€'
        utm_aggregates = [
            {
                'source': _src(r.utm_source),
                'order_count': r.order_count,
                'revenue': int(r.revenue or 0),
                'buyer_count': r.buyer_count or 0,
                'signup_count': signup_map.get(_src(r.utm_source), 0)
            }
            for r in order_stats
        ]
        # ìœ ì €ëŠ” ê°€ì…ë§Œ í•˜ê³  ì£¼ë¬¸ ì•ˆ í•œ ì†ŒìŠ¤ë„ í‘œì‹œ
        for usrc, cnt in signup_map.items():
            if not any(a['source'] == usrc for a in utm_aggregates):
                utm_aggregates.append({'source': usrc, 'order_count': 0, 'revenue': 0, 'buyer_count': 0, 'signup_count': cnt})
        utm_aggregates.sort(key=lambda x: (-x['revenue'], -x['order_count']))

    seller_request_categories = []
    seller_confirmations_recent = []
    email_order_date = None
    email_order_lines_by_category = {}
    if (tab == 'seller_request' or tab == 'email_order') and is_master:
        seller_request_categories = Category.query.filter(Category.manager_email.isnot(None), Category.manager_email != '').order_by(Category.order.asc(), Category.id.asc()).all()
        seller_confirmations_recent = SellerOrderConfirmation.query.order_by(SellerOrderConfirmation.created_at.desc()).limit(100).all()
        order_date_str = request.args.get('order_date', '').strip() or datetime.now().strftime('%Y-%m-%d')
        try:
            email_order_date = datetime.strptime(order_date_str, '%Y-%m-%d').date()
        except Exception:
            email_order_date = datetime.now().date()
        for c in seller_request_categories:
            email_order_lines_by_category[c.id] = _get_email_order_lines(c.name, email_order_date)

    # í†µê³„(í˜ì´ì§€ë·°) íƒ­: ì¡°íšŒìˆ˜Â·ì£¼ë¬¸Â·ìƒí’ˆÂ·íšŒì› ë“±
    stats_page_views_today = stats_page_views_week = stats_page_views_total = {'main': 0, 'category': 0, 'product': 0, 'cart': 0}
    stats_orders_today = stats_orders_week = stats_orders_total = 0
    stats_revenue_today = stats_revenue_week = stats_revenue_total = 0
    stats_products_total = stats_categories_total = stats_low_stock_count = 0
    stats_top_products_by_sold = []
    stats_top_products_by_views = []
    stats_members_total = stats_members_today = stats_members_week = 0
    stats_reviews_total = 0
    stats_cart_items_total = 0
    stats_product_views_total = 0
    stats_daily_table = []
    if tab == 'stats':
        now = datetime.now()
        today_start = now.replace(hour=0, minute=0, second=0, microsecond=0)
        week_start = today_start - timedelta(days=7)
        # DailyStat: ì˜¤ëŠ˜ / ìµœê·¼ 7ì¼ / ì „ì²´
        all_daily = DailyStat.query.order_by(DailyStat.stat_date.desc()).limit(365).all()
        for row in all_daily:
            d = row.stat_date
            main = (row.main_views or 0)
            cat = (row.category_views or 0)
            prod = (row.product_views or 0)
            cart = (row.cart_views or 0)
            if d == today_start.date():
                stats_page_views_today['main'] += main
                stats_page_views_today['category'] += cat
                stats_page_views_today['product'] += prod
                stats_page_views_today['cart'] += cart
            if d >= week_start.date():
                stats_page_views_week['main'] += main
                stats_page_views_week['category'] += cat
                stats_page_views_week['product'] += prod
                stats_page_views_week['cart'] += cart
            stats_page_views_total['main'] += main
            stats_page_views_total['category'] += cat
            stats_page_views_total['product'] += prod
            stats_page_views_total['cart'] += cart
            stats_daily_table.append({'date': d, 'main': main, 'category': cat, 'product': prod, 'cart': cart})
        # ì£¼ë¬¸ (ê²°ì œì·¨ì†Œ ì œì™¸)
        q_order = Order.query.filter(Order.status != 'ê²°ì œì·¨ì†Œ')
        stats_orders_today = q_order.filter(Order.created_at >= today_start).count()
        stats_orders_week = q_order.filter(Order.created_at >= week_start).count()
        stats_orders_total = q_order.count()
        rev_today = db.session.query(db.func.coalesce(db.func.sum(Order.total_price), 0)).filter(Order.status != 'ê²°ì œì·¨ì†Œ', Order.created_at >= today_start).scalar()
        rev_week = db.session.query(db.func.coalesce(db.func.sum(Order.total_price), 0)).filter(Order.status != 'ê²°ì œì·¨ì†Œ', Order.created_at >= week_start).scalar()
        rev_all = db.session.query(db.func.coalesce(db.func.sum(Order.total_price), 0)).filter(Order.status != 'ê²°ì œì·¨ì†Œ').scalar()
        stats_revenue_today = int(rev_today or 0)
        stats_revenue_week = int(rev_week or 0)
        stats_revenue_total = int(rev_all or 0)
        # ìƒí’ˆ
        stats_products_total = Product.query.count()
        stats_categories_total = Category.query.count()
        stats_low_stock_count = Product.query.filter(Product.is_active == True, Product.stock < 5).count()
        # ì¸ê¸° ìƒí’ˆ: OrderItem ê¸°ì¤€ íŒë§¤ ìˆ˜ëŸ‰ ìƒìœ„
        from sqlalchemy import func
        sold_q = db.session.query(OrderItem.product_id, OrderItem.product_name, func.sum(OrderItem.quantity).label('qty')).filter(OrderItem.cancelled == False).group_by(OrderItem.product_id, OrderItem.product_name).order_by(func.sum(OrderItem.quantity).desc()).limit(15).all()
        stats_top_products_by_sold = [{'product_id': r.product_id, 'product_name': r.product_name, 'qty': r.qty} for r in sold_q]
        # ì¡°íšŒìˆ˜ ë§ì€ ìƒí’ˆ
        stats_top_products_by_views = Product.query.order_by(Product.view_count.desc().nullslast()).limit(10).all()
        stats_product_views_total = db.session.query(db.func.coalesce(db.func.sum(Product.view_count), 0)).scalar() or 0
        # íšŒì› (ê´€ë¦¬ì ì œì™¸). Userì— created_at ì—†ìœ¼ë©´ ì‹ ê·œ ì§‘ê³„ëŠ” 0
        stats_members_total = User.query.filter(User.is_admin == False).count()
        stats_members_today = 0
        stats_members_week = 0
        if hasattr(User, 'created_at'):
            try:
                stats_members_today = User.query.filter(User.is_admin == False, User.created_at >= today_start).count()
                stats_members_week = User.query.filter(User.is_admin == False, User.created_at >= week_start).count()
            except Exception:
                pass
        stats_reviews_total = Review.query.count()
        stats_cart_items_total = db.session.query(db.func.coalesce(db.func.sum(Cart.quantity), 0)).scalar() or 0

    # 3. HTML í…œí”Œë¦¿ ì½”ë“œ
    # 3. HTML í…œí”Œë¦¿ ì½”ë“œ (ì¹´í…Œê³ ë¦¬ ì„¤ì • íƒ­ ì™„ë²½ ë³µêµ¬ë³¸)
    admin_html = """
    <div class="max-w-7xl mx-auto py-12 px-4 md:px-6 font-black text-xs md:text-sm text-left">
        <div class="flex justify-between items-center mb-10">
            <h2 class="text-2xl md:text-3xl font-black text-orange-700 italic">Admin Panel</h2>
            <div class="flex gap-2">
                 <a href="/" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] hover:bg-gray-200 transition">í™ˆìœ¼ë¡œ</a>
                 <a href="/logout" class="px-4 py-2 bg-red-50 text-red-500 rounded-xl text-[10px] hover:bg-red-100 transition">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </div>
        
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 p-4 mb-12 bg-white rounded-2xl border border-gray-100 shadow-sm">
            {% if my_categories %}<a href="/seller/orders" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition bg-teal-50 border border-teal-200 text-teal-700 hover:bg-teal-100 hover:border-teal-300">ë‚´ ë°œì£¼ ëª©ë¡</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=email_order" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'seller_request' or tab == 'email_order' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">emailë°œì£¼</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=marketing_cost" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'marketing_cost' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë§ˆì¼€íŒ…ë¹„ ì‚¬ìš©ë‚´ì—­</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=messages" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'messages' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë©”ì‹œì§€ ë°œì†¡</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=delivery_zone" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'delivery_zone' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë°°ì†¡êµ¬ì—­ê´€ë¦¬</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=delivery_request" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'delivery_request' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë°°ì†¡ìš”ì²­</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=backup" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'backup' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë°±ì—…</a>{% endif %}
            <a href="/admin?tab=products" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'products' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ìƒí’ˆ ê´€ë¦¬</a>
            {% if is_master %}<a href="/admin?tab=popup" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'popup' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì•Œë¦¼íŒì—…</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=partnership" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'partnership' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì œíœ´ë¬¸ì˜</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=restaurant_request" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'restaurant_request' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì „êµ­ë§›ì§‘ìš”ì²­</a>{% endif %}
            <a href="/admin?tab=settlement" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'settlement' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì •ì‚°ê´€ë¦¬</a>
            <a href="/admin?tab=orders" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'orders' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì£¼ë¬¸ ë° ë§¤ì¶œ ì§‘ê³„</a>
            {% if is_master %}<a href="/admin?tab=utm" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'utm' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ìœ ì…/ê´‘ê³ </a>{% endif %}
            {% if is_master %}<a href="/admin?tab=categories" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'categories' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì¹´í…Œê³ ë¦¬ ì„¤ì •</a>{% endif %}
            <a href="/admin?tab=stats" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'stats' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">í†µê³„</a>
            <a href="/admin?tab=reviews" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'reviews' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë¦¬ë·° ê´€ë¦¬</a>
            {% if is_master %}<a href="/admin?tab=sellers" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'sellers' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">íŒë§¤ì ê´€ë¦¬</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=point_manage" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'point_manage' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">í¬ì¸íŠ¸ ê´€ë¦¬</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=member_grade" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'member_grade' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">íšŒì› ë“±ê¸‰</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=members" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'members' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">íšŒì›ê´€ë¦¬</a>{% endif %}
        </div>

        {% if tab == 'products' %}
            <div class="mb-8 p-6 rounded-[2rem] border-2 border-amber-200 bg-amber-50/80 text-left">
                <p class="font-black text-amber-800 text-sm mb-3 flex items-center gap-2"><span class="text-lg">ğŸ‘‹</span> ì²˜ìŒ ì‚¬ìš©í•˜ì‹œëŠ” ê´€ë¦¬ììš© ì•ˆë‚´</p>
                <ul class="text-[11px] text-gray-700 space-y-1.5 mb-4">
                    <li><b>ì—‘ì…€ ëŒ€ëŸ‰ ë“±ë¡</b>: ì•„ë˜ ã€Œì—‘ì…€ ì—…ë¡œë“œã€ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì–‘ì‹ ë‹¤ìš´ë¡œë“œì™€ ì—…ë¡œë“œ ì°½ì´ ë‚˜ì˜µë‹ˆë‹¤.</li>
                    <li><b>ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</b>: <a href="/admin/product/bulk_upload_template" class="text-blue-600 font-black underline hover:no-underline">ğŸ“¥ ìƒí’ˆ ì—‘ì…€ ì—…ë¡œë“œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</a></li>
                    <li><b>í•„ìˆ˜ ì»¬ëŸ¼</b>: ì¹´í…Œê³ ë¦¬, ìƒí’ˆëª…, ê·œê²©, ê°€ê²©, ì´ë¯¸ì§€íŒŒì¼ëª… (ì²« ì¤„ í—¤ë” ì´ë¦„ì„ ì •í™•íˆ ë§ì¶°ì£¼ì„¸ìš”)</li>
                    <li><b>ì´ë¯¸ì§€ í´ë” ìœ„ì¹˜</b>: ì„œë²„/í”„ë¡œì íŠ¸ì˜ <code class="bg-white px-1.5 py-0.5 rounded border border-amber-200 font-mono text-[10px]">static/uploads/</code> í´ë”ì— ì´ë¯¸ì§€ íŒŒì¼ì„ ë„£ê³ , ì—‘ì…€ì—ëŠ” <b>íŒŒì¼ëª…ë§Œ</b> ì…ë ¥ (ì˜ˆ: apple.jpg)</li>
                    <li>ì¹´í…Œê³ ë¦¬ëŠ” ë¨¼ì € ã€Œì¹´í…Œê³ ë¦¬ ì„¤ì •ã€ íƒ­ì—ì„œ ë“±ë¡í•œ ì´ë¦„ê³¼ ë™ì¼í•´ì•¼ í•©ë‹ˆë‹¤. ê°€ê²©ì€ ìˆ«ìë§Œ ì…ë ¥í•˜ì„¸ìš”.</li>
                </ul>
                <p class="text-[10px] text-amber-700/90">ê°œë³„ ìƒí’ˆì€ ã€Œ+ ìƒí’ˆ ë“±ë¡ã€ìœ¼ë¡œ í•˜ë‚˜ì”© ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
            <div id="excel_upload_form" class="hidden mb-8 bg-blue-50 p-8 rounded-[2rem] border border-blue-100">
                <p class="font-black text-blue-700 mb-4">ğŸ“¦ ì—‘ì…€ ìƒí’ˆ ëŒ€ëŸ‰ ë“±ë¡</p>
                <div class="flex flex-wrap items-center gap-3 mb-4">
                    <a href="/admin/product/bulk_upload_template" class="bg-white text-blue-600 border border-blue-200 px-5 py-2.5 rounded-xl font-black text-[10px] shadow-sm hover:bg-blue-50 transition">ğŸ“¥ ì—…ë¡œë“œ ì–‘ì‹ ë‹¤ìš´</a>
                </div>
                <form action="/admin/product/bulk_upload" method="POST" enctype="multipart/form-data" class="flex gap-4">
                    <input type="file" name="excel_file" class="bg-white p-3 rounded-xl flex-1 text-xs" accept=".xlsx,.xls" required>
                    <button type="submit" class="bg-blue-600 text-white px-8 rounded-xl font-black">ì—…ë¡œë“œ ì‹œì‘</button>
                </form>
                <div class="mt-5 p-5 bg-white/70 rounded-xl border border-blue-100 text-left text-[11px] text-gray-700 space-y-2">
                    <p class="font-black text-gray-800 mb-2">ğŸ“‹ ì—…ë¡œë“œ ì–‘ì‹ ì‚¬ìš©ë²• (ìƒì„¸)</p>
                    <p>Â· <b>í•„ìˆ˜ ì»¬ëŸ¼</b>: ì¹´í…Œê³ ë¦¬, ìƒí’ˆëª…, ê·œê²©, ê°€ê²©, ì´ë¯¸ì§€íŒŒì¼ëª… (í—¤ë” ì´ë¦„ ì •í™•íˆ ì¼ì¹˜)</p>
                    <p>Â· <b>ì´ë¯¸ì§€ íŒŒì¼ í´ë” ìœ„ì¹˜</b>: í”„ë¡œì íŠ¸ ë‚´ <code class="bg-gray-100 px-1 rounded">static/uploads/</code> í´ë”ì— ìƒí’ˆ ì´ë¯¸ì§€ íŒŒì¼ì„ ë„£ê³ , ì—‘ì…€ì˜ ã€Œì´ë¯¸ì§€íŒŒì¼ëª…ã€ë€ì—ëŠ” <b>íŒŒì¼ëª…ë§Œ</b> ì…ë ¥ (ì˜ˆ: apple.jpg). í•´ë‹¹ ê²½ë¡œì— ì—†ëŠ” íŒŒì¼ëª…ì€ ì´ë¯¸ì§€ ì—†ì´ ë“±ë¡ë©ë‹ˆë‹¤.</p>
                    <p>Â· ì¹´í…Œê³ ë¦¬ëŠ” ë¯¸ë¦¬ ã€Œì¹´í…Œê³ ë¦¬ ì„¤ì •ã€ì—ì„œ ë“±ë¡ëœ ì´ë¦„ê³¼ ë™ì¼í•´ì•¼ í•©ë‹ˆë‹¤. ê°€ê²©ì€ ìˆ«ìë§Œ ì…ë ¥í•˜ì„¸ìš”.</p>
                </div>
            </div>
            <div class="flex flex-wrap justify-between items-center gap-4 mb-8">
                <form action="/admin" method="GET" class="flex flex-wrap gap-3 items-center">
                    <input type="hidden" name="tab" value="products">
                    <input type="text" name="q" value="{{ product_q or '' }}" placeholder="ìƒí’ˆëª…Â·ì„¤ëª…Â·ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰" class="border border-gray-200 rounded-2xl px-4 py-2.5 text-[11px] font-black w-52 focus:ring-2 focus:ring-teal-500">
                    <select name="category" onchange="this.form.submit()" class="border-none bg-white shadow-sm p-3 rounded-2xl text-[11px] font-black">
                        <option value="ì „ì²´">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                        {% for c in selectable_categories %}<option value="{{c.name}}" {% if sel_cat == c.name %}selected{% endif %}>{{c.name}}</option>{% endfor %}
                    </select>
                    <button type="submit" class="bg-teal-600 text-white px-5 py-2.5 rounded-2xl font-black text-[10px]">ê²€ìƒ‰</button>
                    {% if product_q %}<a href="/admin?tab=products" class="text-gray-500 text-[10px]">ê²€ìƒ‰ì´ˆê¸°í™”</a>{% endif %}
                </form>
                <div class="flex gap-3">
                    <button onclick="document.getElementById('excel_upload_form').classList.toggle('hidden')" class="bg-blue-600 text-white px-5 py-3 rounded-2xl font-black text-[10px] shadow-lg">ì—‘ì…€ ì—…ë¡œë“œ</button>
                    <a href="/admin/add" class="bg-teal-600 text-white px-5 py-3 rounded-2xl font-black text-[10px] shadow-lg">+ ìƒí’ˆ ë“±ë¡</a>
                    {% if is_master %}<a href="/admin/seed_test_data" class="bg-amber-500 text-white px-5 py-3 rounded-2xl font-black text-[10px] shadow-lg hover:bg-amber-600" onclick="return confirm('í…ŒìŠ¤íŠ¸ ì¹´í…Œê³ ë¦¬ 3ê°œ(í…ŒìŠ¤íŠ¸-ì±„ì†Œ/ê³¼ì¼/ìˆ˜ì‚°)ì™€ ê° 10ê°œì”© ê°€ìƒ ìƒí’ˆì„ ìƒì„±í•©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?');">ğŸ§ª í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±</a><a href="/admin/delete_test_data" class="bg-red-500 text-white px-5 py-3 rounded-2xl font-black text-[10px] shadow-lg hover:bg-red-600" onclick="return confirm('í…ŒìŠ¤íŠ¸-ì±„ì†Œ/ê³¼ì¼/ìˆ˜ì‚° ì¹´í…Œê³ ë¦¬ì™€ í•´ë‹¹ ìƒí’ˆì„ ëª¨ë‘ ì‚­ì œí•©ë‹ˆë‹¤. ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?');">ğŸ—‘ í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ</a><a href="/admin/seed_virtual_reviews" class="bg-violet-500 text-white px-5 py-3 rounded-2xl font-black text-[10px] shadow-lg hover:bg-violet-600" onclick="return confirm('ì „ì²´ ìƒí’ˆë³„ë¡œ ê°€ìƒ êµ¬ë§¤ í›„ê¸° 10ê°œì”© ìƒì„±í•©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?');">ğŸ“ ê°€ìƒ í›„ê¸° 10ê°œì”©</a><a href="/admin/seed_virtual_orders" class="bg-emerald-500 text-white px-5 py-3 rounded-2xl font-black text-[10px] shadow-lg hover:bg-emerald-600" onclick="return confirm('ìµœê·¼ 10ì¼ ì´ë‚´ ê°€ìƒ ì£¼ë¬¸ 20ê±´(í’ˆëª© 2~3ê°œì”©)ì„ ìƒì„±í•©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?');">ğŸ›’ ê°€ìƒ ì£¼ë¬¸ 20ê±´</a>{% endif %}
                </div>
            </div>
            <div class="bg-white rounded-[2rem] shadow-sm border border-gray-50 overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 border-b border-gray-100 text-gray-400 text-[10px]">
                        <tr><th class="p-6 w-20">ì‚¬ì§„</th><th class="p-6">ìƒí’ˆì •ë³´</th><th class="p-6 text-center">ì¬ê³ </th><th class="p-6 text-center">ê´€ë¦¬</th></tr>
                    </thead>
                    <tbody>
                        {% for p in products %}
                        <tr class="border-b border-gray-50 hover:bg-gray-50/50 transition">
                            <td class="p-4">
                                {% if p.image_url %}
                                <a href="{{ p.image_url }}" target="_blank" class="block w-16 h-16 rounded-xl overflow-hidden border border-gray-100 bg-gray-50 shrink-0"><img src="{{ p.image_url }}" alt="" class="w-full h-full object-cover"></a>
                                {% else %}
                                <span class="w-16 h-16 rounded-xl bg-gray-100 flex items-center justify-center text-gray-400 text-[9px] font-bold">ì—†ìŒ</span>
                                {% endif %}
                            </td>
                            <td class="p-6"><b class="text-gray-800 text-sm">{{ p.name }}</b><br><span class="text-teal-600 text-[10px]">{{ p.description or '' }}</span></td>
                            <td class="p-6 text-center font-black">{{ p.stock }}ê°œ</td>
                            <td class="p-6 text-center space-x-2"><a href="/admin/edit/{{p.id}}" class="text-blue-500">ìˆ˜ì •</a><a href="/admin/delete/{{p.id}}" class="text-red-300" onclick="return confirm('ì‚­ì œ?')">ì‚­ì œ</a></td>
                        </tr>
                        {% endfor %}
                        {% if not products %}
                        <tr><td colspan="4" class="p-10 text-center text-gray-400 font-bold">ì¡°íšŒëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            {% if products_total > per_page or product_page > 1 %}
            <div class="flex flex-wrap items-center justify-between gap-4 mt-6">
                <p class="text-[11px] text-gray-500 font-bold">ì´ {{ products_total }}ê±´ Â· {{ product_page }} / {{ product_total_pages }} í˜ì´ì§€ (30ê°œì”©)</p>
                <div class="flex gap-2">
                    {% if product_page > 1 %}
                    <a href="/admin?tab=products&page={{ product_page - 1 }}{% if product_q %}&q={{ product_q | e }}{% endif %}{% if sel_cat != 'ì „ì²´' %}&category={{ sel_cat }}{% endif %}" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-xl font-black text-[10px] hover:bg-gray-300">ì´ì „</a>
                    {% endif %}
                    {% if product_page < product_total_pages %}
                    <a href="/admin?tab=products&page={{ product_page + 1 }}{% if product_q %}&q={{ product_q | e }}{% endif %}{% if sel_cat != 'ì „ì²´' %}&category={{ sel_cat }}{% endif %}" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-xl font-black text-[10px] hover:bg-gray-300">ë‹¤ìŒ</a>
                    {% endif %}
                </div>
            </div>
            {% endif %}

        {% elif tab == 'stats' %}
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-6">ğŸ“Š í˜ì´ì§€ë·° Â· ì£¼ë¬¸ Â· ìƒí’ˆ í†µê³„</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] text-gray-500 font-black uppercase mb-1">ì˜¤ëŠ˜ ì¡°íšŒìˆ˜</p>
                        <p class="text-xl font-black text-teal-600">{{ stats_page_views_today['main'] + stats_page_views_today['category'] + stats_page_views_today['product'] + stats_page_views_today['cart'] }}</p>
                        <p class="text-[9px] text-gray-400 mt-1">ë©”ì¸ {{ stats_page_views_today['main'] }} Â· ì¹´í…Œê³ ë¦¬ {{ stats_page_views_today['category'] }} Â· ìƒí’ˆ {{ stats_page_views_today['product'] }} Â· ì¥ë°”êµ¬ë‹ˆ {{ stats_page_views_today['cart'] }}</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] text-gray-500 font-black uppercase mb-1">ì´ë²ˆ ì£¼ ì¡°íšŒìˆ˜</p>
                        <p class="text-xl font-black text-teal-600">{{ stats_page_views_week['main'] + stats_page_views_week['category'] + stats_page_views_week['product'] + stats_page_views_week['cart'] }}</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] text-gray-500 font-black uppercase mb-1">ì „ì²´ ì¡°íšŒìˆ˜</p>
                        <p class="text-xl font-black text-gray-800">{{ stats_page_views_total['main'] + stats_page_views_total['category'] + stats_page_views_total['product'] + stats_page_views_total['cart'] }}</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] text-gray-500 font-black uppercase mb-1">ìƒí’ˆ ìƒì„¸ ì¡°íšŒìˆ˜ í•©ê³„</p>
                        <p class="text-xl font-black text-blue-600">{{ stats_product_views_total }}</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-5 rounded-2xl border border-orange-100 shadow-sm">
                        <p class="text-[10px] text-orange-600 font-black uppercase mb-1">ì˜¤ëŠ˜ ì£¼ë¬¸</p>
                        <p class="text-xl font-black text-orange-600">{{ stats_orders_today }}ê±´</p>
                        <p class="text-[10px] text-gray-600 font-bold">{{ "{:,}".format(stats_revenue_today) }}ì›</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border border-orange-100 shadow-sm">
                        <p class="text-[10px] text-orange-600 font-black uppercase mb-1">ì´ë²ˆ ì£¼ ì£¼ë¬¸</p>
                        <p class="text-xl font-black text-orange-600">{{ stats_orders_week }}ê±´</p>
                        <p class="text-[10px] text-gray-600 font-bold">{{ "{:,}".format(stats_revenue_week) }}ì›</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border border-orange-100 shadow-sm">
                        <p class="text-[10px] text-orange-600 font-black uppercase mb-1">ì „ì²´ ì£¼ë¬¸</p>
                        <p class="text-xl font-black text-orange-700">{{ stats_orders_total }}ê±´</p>
                        <p class="text-[10px] text-gray-600 font-bold">{{ "{:,}".format(stats_revenue_total) }}ì›</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] text-gray-500 font-black uppercase mb-1">ë¦¬ë·° ìˆ˜</p>
                        <p class="text-xl font-black text-gray-800">{{ stats_reviews_total }}ê°œ</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] text-gray-500 font-black uppercase mb-1">ìƒí’ˆ ìˆ˜</p>
                        <p class="text-xl font-black text-gray-800">{{ stats_products_total }}ê°œ</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] text-gray-500 font-black uppercase mb-1">ì¹´í…Œê³ ë¦¬ ìˆ˜</p>
                        <p class="text-xl font-black text-gray-800">{{ stats_categories_total }}ê°œ</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border border-amber-100 shadow-sm">
                        <p class="text-[10px] text-amber-600 font-black uppercase mb-1">ì¬ê³  ë¶€ì¡± (5ê°œ ë¯¸ë§Œ)</p>
                        <p class="text-xl font-black text-amber-600">{{ stats_low_stock_count }}ê°œ</p>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                        <p class="text-[10px] text-gray-500 font-black uppercase mb-1">íšŒì› ìˆ˜</p>
                        <p class="text-xl font-black text-gray-800">{{ stats_members_total }}ëª…</p>
                        {% if stats_members_today or stats_members_week %}<p class="text-[9px] text-gray-400">ì˜¤ëŠ˜ {{ stats_members_today }} Â· ì´ë²ˆ ì£¼ {{ stats_members_week }}</p>{% endif %}
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
                        <h4 class="p-4 border-b border-gray-100 text-sm font-black text-gray-800">íŒë§¤ëŸ‰ ìƒìœ„ ìƒí’ˆ (ì·¨ì†Œ ì œì™¸)</h4>
                        <div class="overflow-x-auto max-h-80 overflow-y-auto">
                            <table class="w-full text-[11px]">
                                <thead class="bg-gray-50"><tr><th class="p-3 text-left">ìƒí’ˆëª…</th><th class="p-3 text-right">íŒë§¤ìˆ˜ëŸ‰</th></tr></thead>
                                <tbody>
                                    {% for r in stats_top_products_by_sold %}
                                    <tr class="border-b border-gray-50"><td class="p-3 font-bold text-gray-800 truncate max-w-[200px]">{{ r.product_name }}</td><td class="p-3 text-right font-black text-teal-600">{{ r.qty }}</td></tr>
                                    {% else %}
                                    <tr><td colspan="2" class="p-4 text-center text-gray-400">ë°ì´í„° ì—†ìŒ</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
                        <h4 class="p-4 border-b border-gray-100 text-sm font-black text-gray-800">ìƒí’ˆ ìƒì„¸ ì¡°íšŒìˆ˜ ìƒìœ„</h4>
                        <div class="overflow-x-auto max-h-80 overflow-y-auto">
                            <table class="w-full text-[11px]">
                                <thead class="bg-gray-50"><tr><th class="p-3 text-left">ìƒí’ˆëª…</th><th class="p-3 text-right">ì¡°íšŒìˆ˜</th></tr></thead>
                                <tbody>
                                    {% for p in stats_top_products_by_views %}
                                    <tr class="border-b border-gray-50"><td class="p-3 font-bold text-gray-800 truncate max-w-[200px]">{{ p.name }}</td><td class="p-3 text-right font-black text-blue-600">{{ getattr(p, 'view_count', 0) or 0 }}</td></tr>
                                    {% else %}
                                    <tr><td colspan="2" class="p-4 text-center text-gray-400">ë°ì´í„° ì—†ìŒ</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden mb-8">
                    <h4 class="p-4 border-b border-gray-100 text-sm font-black text-gray-800">ì¼ë³„ í˜ì´ì§€ë·° (ìµœê·¼ 30ì¼)</h4>
                    <div class="overflow-x-auto max-h-64 overflow-y-auto">
                        <table class="w-full text-[11px]">
                            <thead class="bg-gray-50"><tr><th class="p-3 text-left">ë‚ ì§œ</th><th class="p-3 text-right">ë©”ì¸</th><th class="p-3 text-right">ì¹´í…Œê³ ë¦¬</th><th class="p-3 text-right">ìƒí’ˆ</th><th class="p-3 text-right">ì¥ë°”êµ¬ë‹ˆ</th><th class="p-3 text-right">í•©ê³„</th></tr></thead>
                            <tbody>
                                {% for row in stats_daily_table[:30] %}
                                <tr class="border-b border-gray-50">
                                    <td class="p-3 font-bold">{{ row.date }}</td>
                                    <td class="p-3 text-right">{{ row.main }}</td>
                                    <td class="p-3 text-right">{{ row.category }}</td>
                                    <td class="p-3 text-right">{{ row.product }}</td>
                                    <td class="p-3 text-right">{{ row.cart }}</td>
                                    <td class="p-3 text-right font-black text-teal-600">{{ row.main + row.category + row.product + row.cart }}</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="6" class="p-4 text-center text-gray-400">ê¸°ë¡ ì—†ìŒ</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-2xl p-4 border border-gray-100 text-[11px] text-gray-600">
                    <p class="font-black text-gray-700 mb-1">í†µê³„ ì•ˆë‚´</p>
                    <p>ì¡°íšŒìˆ˜ëŠ” ë©”ì¸Â·ì¹´í…Œê³ ë¦¬Â·ìƒí’ˆìƒì„¸Â·ì¥ë°”êµ¬ë‹ˆ í˜ì´ì§€ ë°©ë¬¸ ì‹œ ì¼ë³„ë¡œ ì§‘ê³„ë©ë‹ˆë‹¤. ì£¼ë¬¸Â·ë§¤ì¶œì€ ê²°ì œì·¨ì†Œë¥¼ ì œì™¸í•œ ê±´ìˆ˜ì™€ ê²°ì œê¸ˆì•¡ í•©ê³„ì…ë‹ˆë‹¤. ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸´ ìˆ˜: {{ stats_cart_items_total }}ê°œ(í˜„ì¬ ë‹´ê¸´ ìˆ˜ëŸ‰ í•©ê³„).</p>
                </div>
            </div>

        {% elif tab == 'categories' %}
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 text-left">
                <div class="bg-white p-8 md:p-12 rounded-[2.5rem] md:rounded-[3.5rem] border border-gray-50 shadow-sm h-fit">
                    <h3 class="text-[11px] md:text-sm text-gray-400 uppercase tracking-widest mb-10 font-black">íŒë§¤ ì¹´í…Œê³ ë¦¬ ë° ì‚¬ì—…ì ì¶”ê°€</h3>
                    <form action="/admin/category/add" method="POST" class="space-y-5">
                        <input name="cat_name" placeholder="ì¹´í…Œê³ ë¦¬ëª… (ì˜ˆ: ì‚°ì§€ì§ì†¡ ë†ì‚°ë¬¼)" class="border border-gray-100 p-5 rounded-2xl w-full font-black text-sm" required>
                        <textarea name="description" placeholder="ì¹´í…Œê³ ë¦¬ ì„¤ëª… (ë°°ì†¡ ì •ì±… ë“±)" class="border border-gray-100 p-5 rounded-2xl w-full h-24 font-black text-sm"></textarea>
                        <input name="manager_email" placeholder="ê´€ë¦¬ ë§¤ë‹ˆì € ì´ë©”ì¼ (ë¡œê·¸ì¸ ID)" class="border border-gray-100 p-5 rounded-2xl w-full font-black text-sm">
                        <select name="tax_type" class="border border-gray-100 p-5 rounded-2xl w-full font-black text-sm bg-white">
                            <option value="ê³¼ì„¸">ì¼ë°˜ ê³¼ì„¸ ìƒí’ˆ</option>
                            <option value="ë©´ì„¸">ë©´ì„¸ ë†ì¶•ì‚°ë¬¼</option>
                        </select>
                        <p class="text-[10px] text-amber-600 font-bold uppercase mt-2">ë…¸ì¶œ íšŒì›ë“±ê¸‰ (ëª‡ ë“±ê¸‰ ì´ìƒ)</p>
                        <select name="min_member_grade" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs bg-white">
                            <option value="">ì „ì²´ íšŒì›</option>
                            <option value="1">1ë‹¨ê³„ ì´ìƒ</option>
                            <option value="2">2ë‹¨ê³„ ì´ìƒ</option>
                            <option value="3">3ë‹¨ê³„ ì´ìƒ</option>
                            <option value="4">4ë‹¨ê³„ ì´ìƒ</option>
                            <option value="5">5ë‹¨ê³„ë§Œ</option>
                        </select>
                        <div class="border-t border-gray-100 pt-8 space-y-4">
                            <p class="text-[10px] text-teal-600 font-bold tracking-widest uppercase">Seller Business Profile</p>
                            <input name="biz_name" placeholder="ì‚¬ì—…ì ìƒí˜¸ëª…" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm">
                            <input name="biz_representative" placeholder="ëŒ€í‘œì ì„±í•¨" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm">
                            <input name="biz_reg_number" placeholder="ì‚¬ì—…ì ë“±ë¡ë²ˆí˜¸ ( - í¬í•¨ )" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm">
                            <input name="biz_address" placeholder="ì‚¬ì—…ì¥ ì†Œì¬ì§€" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm">
                            <input name="biz_contact" placeholder="ê³ ê° ì„¼í„° ë²ˆí˜¸" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm">
                            <input name="seller_link" placeholder="íŒë§¤ì ë¬¸ì˜ ë§í¬" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm">
                            <p class="text-[10px] text-blue-600 font-bold tracking-widest uppercase pt-2">ì •ì‚° ê³„ì¢Œ</p>
                            <input name="bank_name" placeholder="ì€í–‰ëª…" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm">
                            <input name="account_holder" placeholder="ì˜ˆê¸ˆì£¼" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm">
                            <input name="settlement_account" placeholder="ì •ì‚°ê³„ì¢Œ (ê³„ì¢Œë²ˆí˜¸)" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm">
                        </div>
                        <button class="w-full bg-teal-600 text-white py-5 rounded-3xl font-black text-base md:text-lg shadow-xl hover:bg-teal-700 transition">ì‹ ê·œ ì¹´í…Œê³ ë¦¬ ìƒì„±</button>
                    </form>
                </div>
                
                <div class="bg-white rounded-[2.5rem] md:rounded-[3.5rem] border border-gray-50 shadow-sm overflow-hidden h-fit">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b border-gray-100 font-bold uppercase text-[10px] md:text-xs">
                            <tr><th class="p-6">ìˆœì„œ</th><th class="p-6">ì¹´í…Œê³ ë¦¬ ì •ë³´</th><th class="p-6 text-center">ê´€ë¦¬</th></tr>
                        </thead>
                        <tbody>
                            {% for c in categories %}
                            <tr class="border-b border-gray-50 hover:bg-gray-50/50 transition">
                                <td class="p-6 flex gap-2">
                                    <a href="/admin/category/move/{{c.id}}/up" class="text-blue-500 hover:scale-125 transition"><i class="fas fa-chevron-up"></i></a>
                                    <a href="/admin/category/move/{{c.id}}/down" class="text-red-500 hover:scale-125 transition"><i class="fas fa-chevron-down"></i></a>
                                </td>
                                <td class="p-6">
                                    <b class="text-gray-800">{{ c.name }}</b><br>
                                    <span class="text-gray-400 text-[10px]">ë§¤ë‹ˆì €: {{ c.manager_email or 'ë¯¸ì§€ì •' }}</span>
                                </td>
                                <td class="p-6 text-center space-x-3 text-[10px]">
                                    <a href="/admin/category/edit/{{c.id}}" class="text-blue-500 font-bold hover:underline">ìˆ˜ì •</a>
                                    <a href="/admin/category/delete/{{c.id}}" class="text-red-200 hover:text-red-500 transition" onclick="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        {% elif tab == 'delivery_zone' %}
            {% if kakao_map_app_key %}
            <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey={{ kakao_map_app_key }}"></script>
            {% else %}
            <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
            <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
            {% endif %}
            <div class="mb-10 p-6 bg-teal-50 border border-teal-200 rounded-2xl">
                <h3 class="text-base font-black text-teal-800 italic mb-2">í€µì§€ì—­ ì„¤ì • <span class="text-teal-600 text-xs font-bold">(ìš°ì„  ì ìš©, ê·¸ ì™¸ ë°°ì†¡ë¶ˆê°€)</span></h3>
                <p class="text-[11px] text-teal-700 font-bold mb-3"><strong>ë°©ë²• 1) ì§€ë„ì—ì„œ ì¢Œí‘œë¡œ ì„¤ì •</strong> â€” ì•„ë˜ ì§€ë„ì—ì„œ ã€Œí€µì§€ì—­ í¸ì§‘ã€ ì„ íƒ í›„ í´ë¦­í•´ ê¼­ì§“ì ì„ ì°ê³  <strong>í€µì§€ì—­ í´ë¦¬ê³¤ ì €ì¥</strong>. <strong>ë°©ë²• 2) ì§€ì—­ëª… ì…ë ¥</strong> â€” ì£¼ì†Œì— í¬í•¨ë˜ë©´ ë°°ì†¡ê°€ëŠ¥ì¸ ì§€ì—­ëª…ì„ ì‰¼í‘œë¡œ ì…ë ¥.</p>
                <p class="text-[10px] text-teal-600 mb-3">â€» í€µì§€ì—­ ì¢Œí‘œ(í´ë¦¬ê³¤)ê°€ ìˆìœ¼ë©´ ì¢Œí‘œë¡œë§Œ íŒë‹¨í•©ë‹ˆë‹¤. ì—†ìœ¼ë©´ ì§€ì—­ëª…ìœ¼ë¡œ íŒë‹¨í•˜ë©°, ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ì¼ë°˜ í´ë¦¬ê³¤ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
                <div class="flex gap-2 flex-wrap items-center mb-3">
                    <input type="text" id="quick_region_input" value="{{ delivery_zone_quick_regions | join(', ') }}" placeholder="ì†¡ë„ë™, ì„ ë¦°ë™ (ì¢Œí‘œ ëŒ€ì‹  ì‚¬ìš© ì‹œ)" class="flex-1 min-w-[200px] border border-teal-200 rounded-xl px-4 py-2.5 text-sm font-bold text-gray-800">
                    <button type="button" id="quick_region_save_btn" class="px-5 py-2.5 bg-teal-600 text-white rounded-xl font-black text-xs shadow hover:bg-teal-700">í€µì§€ì—­(ì´ë¦„) ì €ì¥</button>
                </div>
                <label class="flex items-center gap-2 cursor-pointer mb-2">
                    <input type="checkbox" id="use_quick_region_only" {% if delivery_zone_use_quick_only %}checked{% endif %} class="rounded border-teal-300 text-teal-600 focus:ring-teal-500">
                    <span class="text-sm font-bold text-teal-800">í€µì§€ì—­ë§Œ ì‚¬ìš© â€” í€µì§€ì—­(ì¢Œí‘œ/ì´ë¦„) ìˆìœ¼ë©´ ê·¸ë§Œ ë°°ì†¡ê°€ëŠ¥, ê·¸ ì™¸ ë°°ì†¡ë¶ˆê°€</span>
                </label>
            </div>
            <div class="mb-10 p-6 bg-amber-50 border border-amber-200 rounded-2xl">
                <h3 class="text-base font-black text-amber-800 italic mb-2">í€µ ì§€ì—­ ì¶”ê°€ ë°°ì†¡ë£Œ Â· ì•ˆë‚´ ë¬¸êµ¬ <span class="text-amber-600 text-xs font-bold">(ìˆ˜ì • ê°€ëŠ¥)</span></h3>
                <p class="text-[11px] text-amber-700 font-bold mb-3">í€µ í´ë¦¬ê³¤ ì§€ì—­ ì£¼ë¬¸ ì‹œ ê²°ì œ í™”ë©´ì— ì•ˆë‚´ë˜ëŠ” ë¬¸êµ¬ì™€ ì¶”ê°€ ë°°ì†¡ë£Œ(ì›)ì…ë‹ˆë‹¤. ë™ì˜ ì‹œ í•´ë‹¹ ê¸ˆì•¡ì´ ê²°ì œì— í¬í•¨ë©ë‹ˆë‹¤.</p>
                <div class="flex flex-wrap gap-3 items-end mb-3">
                    <label class="flex flex-col gap-1">
                        <span class="text-[10px] text-amber-700 font-black uppercase">í€µ ì¶”ê°€ ë°°ì†¡ë£Œ (ì›)</span>
                        <input type="number" id="quick_extra_fee_input" min="0" step="1" value="{{ delivery_zone_quick_extra_fee }}" class="w-32 border border-amber-200 rounded-xl px-3 py-2 text-sm font-black text-gray-800">
                    </label>
                    <button type="button" id="quick_extra_save_btn" class="px-5 py-2.5 bg-amber-600 text-white rounded-xl font-black text-xs shadow hover:bg-amber-700">ì €ì¥</button>
                </div>
                <label class="flex flex-col gap-1">
                    <span class="text-[10px] text-amber-700 font-black uppercase">í€µ ë°°ì†¡ ì•ˆë‚´ ë¬¸êµ¬ (ê²°ì œ ì „ ê³ ê°ì—ê²Œ í‘œì‹œ)</span>
                    <textarea id="quick_extra_message_input" rows="3" class="w-full border border-amber-200 rounded-xl px-4 py-3 text-sm font-bold text-gray-800 placeholder-gray-400" placeholder="í•´ë‹¹ ì£¼ì†ŒëŠ” ë°°ì†¡ì§€ì—­ì´ ì•„ë‹™ë‹ˆë‹¤. ë°°ì†¡ë£Œ ì¶”ê°€ ì‹œ í€µìœ¼ë¡œ ë°°ì†¡ë©ë‹ˆë‹¤. ì¶”ê°€í•˜ì‹œê³  ì£¼ë¬¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?">{{ delivery_zone_quick_extra_message }}</textarea>
                </label>
            </div>
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-2">ì§€ë„ì—ì„œ ë°°ì†¡êµ¬ì—­ ì„¤ì • (ì¢Œí‘œ í´ë¦­)</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-2">í¸ì§‘í•  êµ¬ì—­ì„ ì„ íƒí•œ ë’¤ ì§€ë„ë¥¼ í´ë¦­í•´ ê¼­ì§“ì ì„ ì¶”ê°€í•˜ì„¸ìš”. <span class="text-orange-600 font-black">ì£¼í™©ìƒ‰ = ì¼ë°˜ ë°°ì†¡êµ¬ì—­</span> (í€µì§€ì—­ ë¹„ì—ˆì„ ë•Œë§Œ ì‚¬ìš©), <span class="text-teal-600 font-black">í‹¸ìƒ‰ = í€µì§€ì—­</span> (ìš°ì„  ì ìš©).</p>
                <div class="flex flex-wrap gap-3 mb-3 items-center">
                    <span class="text-xs font-black text-gray-600">ì§€ê¸ˆ í¸ì§‘:</span>
                    <button type="button" id="dz_edit_main_btn" class="px-4 py-2 rounded-xl font-black text-xs bg-orange-100 text-orange-700 border-2 border-orange-300">ì¼ë°˜ í´ë¦¬ê³¤</button>
                    <button type="button" id="dz_edit_quick_btn" class="px-4 py-2 rounded-xl font-black text-xs bg-teal-100 text-teal-700 border-2 border-teal-300">í€µì§€ì—­ í´ë¦¬ê³¤</button>
                </div>
                <div class="flex gap-3 mb-3 items-center flex-wrap">
                    <button type="button" id="dz_save_btn" class="px-5 py-2.5 bg-orange-600 text-white rounded-xl font-black text-xs shadow hover:bg-orange-700">ì¼ë°˜ í´ë¦¬ê³¤ ì €ì¥</button>
                    <button type="button" id="dz_reset_btn" class="px-5 py-2.5 bg-gray-200 text-gray-700 rounded-xl font-black text-xs hover:bg-gray-300">ì¼ë°˜ ì´ˆê¸°í™”</button>
                    <span id="dz_coords_display" class="text-[11px] text-gray-600 font-bold"></span>
                </div>
                <div class="flex gap-3 mb-3 items-center flex-wrap">
                    <button type="button" id="dz_quick_save_btn" class="px-5 py-2.5 bg-teal-600 text-white rounded-xl font-black text-xs shadow hover:bg-teal-700">í€µì§€ì—­ í´ë¦¬ê³¤ ì €ì¥</button>
                    <button type="button" id="dz_quick_reset_btn" class="px-5 py-2.5 bg-gray-200 text-gray-700 rounded-xl font-black text-xs hover:bg-gray-300">í€µì§€ì—­ ì´ˆê¸°í™”</button>
                    <span id="dz_quick_coords_display" class="text-[11px] text-teal-700 font-bold"></span>
                </div>
                <div id="delivery_zone_map" class="w-full rounded-2xl border border-gray-200 overflow-hidden" style="height: 500px;"></div>
                <p class="text-[10px] text-gray-500 mt-2">ê¼­ì§“ì  3ê°œ ì´ìƒ í•„ìš”. {% if not kakao_map_app_key %}(ì¹´ì¹´ì˜¤ë§µ: KAKAO_MAP_APP_KEY ì„¤ì •){% endif %}</p>
            </div>
            <script>
            (function(){
                var initialPolygon = {{ delivery_zone_polygon | tojson }};
                var initialQuickPolygon = {{ delivery_zone_quick_polygon | tojson }};
                var yeonsu = [37.3931, 126.6397];
                var points = Array.isArray(initialPolygon) ? initialPolygon.slice() : [];
                var quickPoints = Array.isArray(initialQuickPolygon) ? initialQuickPolygon.slice() : [];
                var editMode = 'main';
                var useKakao = {{ 'true' if kakao_map_app_key else 'false' }};

                function updateCoordsDisplay() {
                    var el = document.getElementById('dz_coords_display');
                    if (el) el.textContent = points.length ? 'ì¼ë°˜ ê¼­ì§“ì  ' + points.length + 'ê°œ' : '';
                    var qel = document.getElementById('dz_quick_coords_display');
                    if (qel) qel.textContent = quickPoints.length ? 'í€µì§€ì—­ ê¼­ì§“ì  ' + quickPoints.length + 'ê°œ' : '';
                    var mainBtn = document.getElementById('dz_edit_main_btn');
                    var quickBtn = document.getElementById('dz_edit_quick_btn');
                    if (mainBtn) { mainBtn.className = editMode === 'main' ? 'px-4 py-2 rounded-xl font-black text-xs bg-orange-600 text-white border-2 border-orange-700' : 'px-4 py-2 rounded-xl font-black text-xs bg-orange-100 text-orange-700 border-2 border-orange-300'; }
                    if (quickBtn) { quickBtn.className = editMode === 'quick' ? 'px-4 py-2 rounded-xl font-black text-xs bg-teal-600 text-white border-2 border-teal-700' : 'px-4 py-2 rounded-xl font-black text-xs bg-teal-100 text-teal-700 border-2 border-teal-300'; }
                }

                function bindButtons() {
                    document.getElementById('dz_save_btn').addEventListener('click', function() {
                        if (points.length < 3) { alert('ì¼ë°˜ í´ë¦¬ê³¤ ê¼­ì§“ì ì„ 3ê°œ ì´ìƒ ì°ì–´ì£¼ì„¸ìš”.'); return; }
                        fetch('/admin/delivery_zone/api', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, body: JSON.stringify({ polygon: points }) })
                        .then(function(r) { return r.json(); }).then(function(d) { if (d.error) alert(d.error); else alert('ì¼ë°˜ í´ë¦¬ê³¤ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); }).catch(function() { alert('ì €ì¥ ì‹¤íŒ¨'); });
                    });
                    document.getElementById('dz_reset_btn').addEventListener('click', function() { points = []; if (window.dzRedraw) window.dzRedraw(); updateCoordsDisplay(); });
                    document.getElementById('dz_quick_save_btn').addEventListener('click', function() {
                        if (quickPoints.length < 3) { alert('í€µì§€ì—­ í´ë¦¬ê³¤ ê¼­ì§“ì ì„ 3ê°œ ì´ìƒ ì°ì–´ì£¼ì„¸ìš”.'); return; }
                        fetch('/admin/delivery_zone/api', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, body: JSON.stringify({ quick_region_polygon: quickPoints }) })
                        .then(function(r) { return r.json(); }).then(function(d) { if (d.error) alert(d.error); else alert('í€µì§€ì—­ í´ë¦¬ê³¤ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ê·¸ ì™¸ ì§€ì—­ ë°°ì†¡ë¶ˆê°€ ì ìš©.'); }).catch(function() { alert('ì €ì¥ ì‹¤íŒ¨'); });
                    });
                    document.getElementById('dz_quick_reset_btn').addEventListener('click', function() { quickPoints = []; if (window.dzRedraw) window.dzRedraw(); updateCoordsDisplay(); });
                    document.getElementById('dz_edit_main_btn').addEventListener('click', function() { editMode = 'main'; updateCoordsDisplay(); });
                    document.getElementById('dz_edit_quick_btn').addEventListener('click', function() { editMode = 'quick'; updateCoordsDisplay(); });
                    var qrInput = document.getElementById('quick_region_input');
                    var useQuickOnlyCb = document.getElementById('use_quick_region_only');
                    document.getElementById('quick_region_save_btn').addEventListener('click', function() {
                        var raw = (qrInput && qrInput.value) ? qrInput.value.trim() : '';
                        var list = raw ? raw.replace(/ï¼Œ/g, ',').split(',').map(function(s){ return s.trim(); }).filter(Boolean) : [];
                        var useQuickOnly = useQuickOnlyCb && useQuickOnlyCb.checked;
                        fetch('/admin/delivery_zone/api', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, body: JSON.stringify({ quick_region_names: list, use_quick_region_only: useQuickOnly }) })
                        .then(function(r) { return r.json(); }).then(function(d) { if (d.error) alert(d.error); else alert('í€µì§€ì—­(ì´ë¦„) ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); }).catch(function() { alert('ì €ì¥ ì‹¤íŒ¨'); });
                    });
                    var feeIn = document.getElementById('quick_extra_fee_input');
                    var msgIn = document.getElementById('quick_extra_message_input');
                    document.getElementById('quick_extra_save_btn').addEventListener('click', function() {
                        var fee = feeIn ? (parseInt(feeIn.value, 10) || 0) : 10000;
                        var msg = (msgIn && msgIn.value) ? msgIn.value.trim() : '';
                        fetch('/admin/delivery_zone/api', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, body: JSON.stringify({ quick_extra_fee: fee, quick_extra_message: msg }) })
                        .then(function(r) { return r.json(); }).then(function(d) { if (d.error) alert(d.error); else alert('í€µ ì¶”ê°€ ë°°ì†¡ë£ŒÂ·ì•ˆë‚´ ë¬¸êµ¬ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'); }).catch(function() { alert('ì €ì¥ ì‹¤íŒ¨'); });
                    });
                }

                if (useKakao && typeof kakao !== 'undefined') {
                    kakao.maps.load(function() {
                        var container = document.getElementById('delivery_zone_map');
                        var map = new kakao.maps.Map(container, { center: new kakao.maps.LatLng(yeonsu[0], yeonsu[1]), level: 5 });
                        var mainMarkers = [], mainLine = null, quickMarkers = [], quickLine = null;

                        window.dzRedraw = function() {
                            mainMarkers.forEach(function(m) { m.setMap(null); }); mainMarkers = [];
                            if (mainLine) { mainLine.setMap(null); mainLine = null; }
                            points.forEach(function(p) { mainMarkers.push(new kakao.maps.Marker({ position: new kakao.maps.LatLng(p[0], p[1]), map: map })); });
                            if (points.length >= 2) { mainLine = new kakao.maps.Polyline({ path: points.map(function(p){ return new kakao.maps.LatLng(p[0],p[1]); }), strokeColor: '#ea580c', strokeWeight: 4 }); mainLine.setMap(map); }
                            quickMarkers.forEach(function(m) { m.setMap(null); }); quickMarkers = [];
                            if (quickLine) { quickLine.setMap(null); quickLine = null; }
                            quickPoints.forEach(function(p) { quickMarkers.push(new kakao.maps.Marker({ position: new kakao.maps.LatLng(p[0], p[1]), map: map })); });
                            if (quickPoints.length >= 2) { quickLine = new kakao.maps.Polyline({ path: quickPoints.map(function(p){ return new kakao.maps.LatLng(p[0],p[1]); }), strokeColor: '#0d9488', strokeWeight: 5 }); quickLine.setMap(map); }
                            updateCoordsDisplay();
                        };

                        kakao.maps.event.addListener(map, 'click', function(ev) {
                            var lat = ev.latLng.getLat(), lng = ev.latLng.getLng();
                            if (editMode === 'main') points.push([lat, lng]); else quickPoints.push([lat, lng]);
                            window.dzRedraw();
                        });

                        bindButtons();
                        window.dzRedraw();
                    });
                } else {
                    var map = L.map('delivery_zone_map').setView(yeonsu, 14);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
                    var mainLayer = L.layerGroup().addTo(map), quickLayer = L.layerGroup().addTo(map);
                    var mainPoly = null, quickPoly = null;

                    window.dzRedraw = function() {
                        mainLayer.clearLayers(); quickLayer.clearLayers();
                        if (mainPoly) { map.removeLayer(mainPoly); mainPoly = null; }
                        if (quickPoly) { map.removeLayer(quickPoly); quickPoly = null; }
                        points.forEach(function(p) { L.marker(p).addTo(mainLayer); });
                        quickPoints.forEach(function(p) { L.marker(p).addTo(quickLayer); });
                        if (points.length >= 2) { mainPoly = L.polyline(points, { color: '#ea580c', weight: 4 }).addTo(map); }
                        if (quickPoints.length >= 2) { quickPoly = L.polyline(quickPoints, { color: '#0d9488', weight: 5 }).addTo(map); }
                        updateCoordsDisplay();
                    };

                    map.on('click', function(e) {
                        var pt = [e.latlng.lat, e.latlng.lng];
                        if (editMode === 'main') points.push(pt); else quickPoints.push(pt);
                        window.dzRedraw();
                    });

                    bindButtons();
                    window.dzRedraw();
                }
            })();
            </script>

        {% elif tab == 'restaurant_request' %}
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-2">ì „êµ­ë§›ì§‘ìš”ì²­ ê´€ë¦¬</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-4">ê³ ê°ì´ ë“±ë¡í•œ ì „êµ­ë§›ì§‘ ìš”ì²­ ê¸€. ê´€ë¦¬ì ëŒ“ê¸€ì€ ìƒì„¸ í˜ì´ì§€ì— ë…¸ì¶œë©ë‹ˆë‹¤.</p>
                <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden">
                    <table class="w-full text-left text-[11px]">
                        <thead class="bg-gray-50 border-b border-gray-100"><tr><th class="p-4">ID</th><th class="p-4">ì—…ì²´ëª…</th><th class="p-4">ì‘ì„±ì</th><th class="p-4">ì‘ì„±ì¼</th><th class="p-4">ì¶”ì²œ</th><th class="p-4">ë¹„ì¶”ì²œ</th><th class="p-4">ê´€ë¦¬ì ëŒ“ê¸€</th><th class="p-4">ê´€ë¦¬</th></tr></thead>
                        <tbody>
                            {% for p in admin_restaurant_requests %}
                            {% set vc = restaurant_recommend_counts.get(p.id, (0, 0)) %}
                            <tr class="border-b border-gray-50 hover:bg-gray-50/50">
                                <td class="p-4">{{ p.id }}</td>
                                <td class="p-4 font-bold">{{ p.store_name }}</td>
                                <td class="p-4">{{ p.user_name or '-' }}</td>
                                <td class="p-4">{{ p.created_at.strftime('%Y-%m-%d %H:%M') if p.created_at else '-' }}</td>
                                <td class="p-4 text-teal-600 font-black">{{ vc[0] }}</td>
                                <td class="p-4 text-gray-500 font-black">{{ vc[1] }}</td>
                                <td class="p-4 max-w-[200px]">
                                    <form action="/admin/board/restaurant-request/{{ p.id }}/comment" method="POST" class="flex gap-2">
                                        <textarea name="admin_notes" rows="2" class="flex-1 min-w-0 text-[10px] border border-gray-200 rounded-lg px-2 py-1" placeholder="ëŒ“ê¸€ ì…ë ¥">{{ p.admin_notes or '' }}</textarea>
                                        <button type="submit" class="shrink-0 px-2 py-1 bg-teal-600 text-white rounded-lg text-[10px] font-black">ì €ì¥</button>
                                    </form>
                                </td>
                                <td class="p-4">
                                    <a href="/board/restaurant-request/{{ p.id }}" target="_blank" class="text-teal-600 font-black mr-2">ë³´ê¸°</a>
                                    <form action="/admin/board/restaurant-request/{{ p.id }}/hide" method="POST" class="inline" onsubmit="return confirm('ìˆ¨ê¸°ì‹œê² ìŠµë‹ˆê¹Œ?');"><button type="submit" class="text-amber-600 font-black">{{ 'ìˆ¨ê¹€í•´ì œ' if p.is_hidden else 'ìˆ¨ê¸°ê¸°' }}</button></form>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="8" class="p-8 text-center text-gray-400">ë“±ë¡ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% elif tab == 'delivery_request' %}
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-2">ë°°ì†¡ìš”ì²­ ê´€ë¦¬</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-4">ê³ ê°ì´ ìš”ì²­í•œ ë°°ì†¡ ì§€ì—­. ì¶”ì²œì´ ë§ì€ ì§€ì—­ë¶€í„° ë°°ì†¡êµ¬ì—­ í™•ì¥ì„ ê²€í† í•©ë‹ˆë‹¤. ì ìš© ì‹œ <a href="/admin?tab=delivery_zone" class="text-teal-600 font-black underline">ë°°ì†¡êµ¬ì—­ê´€ë¦¬</a> íƒ­ì—ì„œ ì„¤ì •í•˜ì„¸ìš”.</p>
                <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden">
                    <table class="w-full text-left text-[11px]">
                        <thead class="bg-gray-50 border-b border-gray-100"><tr><th class="p-4">ID</th><th class="p-4">ì§€ì—­ëª…</th><th class="p-4">ê¸€ë‚´ìš©</th><th class="p-4">ì‘ì„±ì</th><th class="p-4">ì‘ì„±ì¼</th><th class="p-4">ì¶”ì²œ</th><th class="p-4">ë¹„ì¶”ì²œ</th><th class="p-4">ê´€ë¦¬ì ëŒ“ê¸€</th><th class="p-4">ê´€ë¦¬</th></tr></thead>
                        <tbody>
                            {% for p in admin_delivery_requests %}
                            {% set vc = delivery_request_vote_counts.get(p.id, (0, 0)) %}
                            <tr class="border-b border-gray-50 hover:bg-gray-50/50">
                                <td class="p-4">{{ p.id }}</td>
                                <td class="p-4 font-bold text-teal-700">{{ p.region_name }}</td>
                                <td class="p-4 max-w-[180px] truncate" title="{{ (p.content or '')[:200] }}">{{ (p.content or '-')[:60] }}{% if (p.content or '')|length > 60 %}...{% endif %}</td>
                                <td class="p-4">{{ p.user_name or '-' }}</td>
                                <td class="p-4">{{ p.created_at.strftime('%Y-%m-%d %H:%M') if p.created_at else '-' }}</td>
                                <td class="p-4 text-teal-600 font-black">{{ vc[0] }}</td>
                                <td class="p-4 text-gray-500 font-black">{{ vc[1] }}</td>
                                <td class="p-4 max-w-[200px]">
                                    <form action="/admin/board/delivery-request/{{ p.id }}/comment" method="POST" class="flex gap-2">
                                        <textarea name="admin_notes" rows="2" class="flex-1 min-w-0 text-[10px] border border-gray-200 rounded-lg px-2 py-1" placeholder="ëŒ“ê¸€ ì…ë ¥">{{ p.admin_notes or '' }}</textarea>
                                        <button type="submit" class="shrink-0 px-2 py-1 bg-teal-600 text-white rounded-lg text-[10px] font-black">ì €ì¥</button>
                                    </form>
                                </td>
                                <td class="p-4">
                                    <a href="/board/delivery-request/{{ p.id }}" target="_blank" class="text-teal-600 font-black mr-2">ë³´ê¸°</a>
                                    <a href="/admin?tab=delivery_zone" class="text-blue-600 font-black mr-2">ë°°ì†¡êµ¬ì—­</a>
                                    <form action="/admin/board/delivery-request/{{ p.id }}/hide" method="POST" class="inline" onsubmit="return confirm('ìˆ¨ê¸°ì‹œê² ìŠµë‹ˆê¹Œ?');"><button type="submit" class="text-amber-600 font-black">{{ 'ìˆ¨ê¹€í•´ì œ' if p.is_hidden else 'ìˆ¨ê¸°ê¸°' }}</button></form>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="9" class="p-8 text-center text-gray-400">ë“±ë¡ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% elif tab == 'partnership' %}
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-2">ì œíœ´ë¬¸ì˜ ê´€ë¦¬</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-4">ë¹„ë°€ê¸€ì€ ê¸€ì“´ì´ë§Œ ëª©ë¡Â·ìƒì„¸ ì¡°íšŒ ê°€ëŠ¥. ê´€ë¦¬ì ëŒ“ê¸€ì€ ê¸€ì“´ì´/ê´€ë¦¬ì ìƒì„¸ì—ì„œ í™•ì¸ë©ë‹ˆë‹¤.</p>
                <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden">
                    <table class="w-full text-left text-[11px]">
                        <thead class="bg-gray-50 border-b border-gray-100"><tr><th class="p-4">ID</th><th class="p-4">ì œíœ´ì¢…ë¥˜</th><th class="p-4">ì‘ì„±ì</th><th class="p-4">ì‘ì„±ì¼</th><th class="p-4">ë¹„ë°€</th><th class="p-4">ê´€ë¦¬ì ëŒ“ê¸€</th><th class="p-4">ê´€ë¦¬</th></tr></thead>
                        <tbody>
                            {% for p in admin_partnership_inquiries %}
                            <tr class="border-b border-gray-50 hover:bg-gray-50/50">
                                <td class="p-4">{{ p.id }}</td>
                                <td class="p-4 font-bold">{{ p.partnership_type or '-' }}</td>
                                <td class="p-4">{{ p.user_name or '-' }}</td>
                                <td class="p-4">{{ p.created_at.strftime('%Y-%m-%d %H:%M') if p.created_at else '-' }}</td>
                                <td class="p-4">{{ 'Y' if p.is_secret else '-' }}</td>
                                <td class="p-4 max-w-[200px]">
                                    <form action="/admin/board/partnership/{{ p.id }}/comment" method="POST" class="flex gap-2">
                                        <textarea name="admin_notes" rows="2" class="flex-1 min-w-0 text-[10px] border border-gray-200 rounded-lg px-2 py-1" placeholder="ëŒ“ê¸€ ì…ë ¥">{{ p.admin_notes or '' }}</textarea>
                                        <button type="submit" class="shrink-0 px-2 py-1 bg-teal-600 text-white rounded-lg text-[10px] font-black">ì €ì¥</button>
                                    </form>
                                </td>
                                <td class="p-4">
                                    <a href="/board/partnership/{{ p.id }}" target="_blank" class="text-teal-600 font-black mr-2">ë³´ê¸°</a>
                                    <form action="/admin/board/partnership/{{ p.id }}/hide" method="POST" class="inline" onsubmit="return confirm('ìˆ¨ê¸°ì‹œê² ìŠµë‹ˆê¹Œ?');"><button type="submit" class="text-amber-600 font-black">{{ 'ìˆ¨ê¹€í•´ì œ' if p.is_hidden else 'ìˆ¨ê¸°ê¸°' }}</button></form>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="7" class="p-8 text-center text-gray-400">ë“±ë¡ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        {% elif tab == 'seller_request' or tab == 'email_order' %}
            <div class="mb-12">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <div>
                        <h3 class="text-lg font-black text-gray-800 italic mb-1">emailë°œì£¼</h3>
                        <p class="text-[11px] text-gray-500 font-bold">ì¹´í…Œê³ ë¦¬ë³„ ë°œì£¼ í’ˆëª©(ê²°ì œ í’ˆëª©ë„˜ë²„ë³„ ì˜¤ë”) ì¡°íšŒ, ë‚ ì§œë³„ ë¶„ë¥˜, ë°œì£¼ìƒíƒœ í™•ì¸. ì´ë©”ì¼ ê¸°ì… ì‹œ ë°œì£¼ì–‘ì‹ ìë™ ìƒì„± í›„ í™•ì¸ ì‹œ ë©”ì¼ ë°œì†¡.</p>
                    </div>
                    <div class="flex gap-2">
                        {% if my_categories %}<a href="/seller/orders" class="px-4 py-2.5 bg-teal-100 text-teal-700 rounded-xl text-xs font-black hover:bg-teal-200 transition">ë‚´ ë°œì£¼ ëª©ë¡</a>{% endif %}
                        <a href="/admin/email-setup" class="px-4 py-2.5 bg-gray-100 text-gray-700 rounded-xl text-xs font-black hover:bg-gray-200 transition">ì´ë©”ì¼ í‚¤ ì„¤ì • ì•ˆë‚´</a>
                    </div>
                </div>
                <form method="GET" action="/admin" class="flex flex-wrap items-center gap-3 mb-6 p-4 bg-gray-50 rounded-2xl border border-gray-100">
                    <input type="hidden" name="tab" value="email_order">
                    <label class="text-[11px] font-black text-gray-600">ë‚ ì§œë³„ ë¶„ë¥˜</label>
                    <input type="date" name="order_date" value="{{ email_order_date.strftime('%Y-%m-%d') if email_order_date else '' }}" class="border border-gray-200 rounded-xl px-3 py-2 text-sm font-bold">
                    <button type="submit" class="px-4 py-2 bg-teal-600 text-white rounded-xl text-xs font-black hover:bg-teal-700">ì¡°íšŒ</button>
                </form>
                {% for c in seller_request_categories %}
                <div class="mb-8">
                    <h4 class="text-sm font-black text-gray-800 mb-2 flex items-center gap-2">{{ c.name }} <span class="text-[10px] font-normal text-gray-500">(íŒë§¤ì ì´ë©”ì¼: {{ c.manager_email or '-' }})</span></h4>
                    <div class="overflow-x-auto rounded-2xl border border-gray-200 bg-white">
                        <table class="w-full text-left min-w-[640px] text-[11px] font-bold border-collapse">
                            <thead class="bg-gray-800 text-white">
                                <tr>
                                    <th class="p-3 border border-gray-600 w-36">íŒë§¤ì‹œê°</th>
                                    <th class="p-3 border border-gray-600">í’ˆëª…</th>
                                    <th class="p-3 border border-gray-600 w-16 text-center">ìˆ˜ëŸ‰</th>
                                    <th class="p-3 border border-gray-600 w-28 text-right">ê¸ˆì•¡í•©ê³„</th>
                                    <th class="p-3 border border-gray-600 w-16 text-center">VAT</th>
                                    <th class="p-3 border border-gray-600 w-24 text-center">ë°œì£¼ìƒíƒœ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in email_order_lines_by_category[c.id] %}
                                <tr class="border-b border-gray-100">
                                    <td class="p-3">{{ row.sale_dt.strftime('%Y-%m-%d %H:%M') if row.sale_dt else '-' }}</td>
                                    <td class="p-3">{{ row.product_name }}</td>
                                    <td class="p-3 text-center">{{ row.quantity }}</td>
                                    <td class="p-3 text-right">{{ "{:,}".format(row.amount_total) }}ì›</td>
                                    <td class="p-3 text-center">{{ row.vat_label }}</td>
                                    <td class="p-3 text-center">
                                        {% if row.status == 'í™•ì¸ì™„ë£Œ' %}<span class="text-teal-600">í™•ì¸ì™„ë£Œ</span>{% elif row.status == 'ë°œì†¡ì™„ë£Œ' %}<span class="text-amber-600">ë°œì†¡ì™„ë£Œ</span>{% else %}<span class="text-gray-500">ëŒ€ê¸°</span>{% endif %}
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td colspan="6" class="p-6 text-center text-gray-400 text-xs">í•´ë‹¹ ì¼ì ë°œì£¼ í’ˆëª© ì—†ìŒ</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if email_order_lines_by_category[c.id] %}
                    <div class="email-order-row mt-3 flex flex-wrap items-center gap-2">
                        <span class="text-[11px] font-black text-gray-600">ë°œì£¼ ì´ë©”ì¼ ìˆ˜ì‹ :</span>
                        <input type="email" class="email-order-to border border-gray-200 rounded-xl px-3 py-2 text-sm w-64" placeholder="ì´ë©”ì¼ ê¸°ì… ì‹œ ë°œì£¼ì–‘ì‹ ìë™ ìƒì„±" data-category-id="{{ c.id }}" data-category-name="{{ c.name }}" value="{{ c.manager_email or '' }}">
                        <button type="button" class="email-order-gen px-4 py-2 rounded-xl bg-teal-600 text-white text-xs font-black hover:bg-teal-700" data-category-id="{{ c.id }}" data-category-name="{{ c.name }}">ì–‘ì‹ ìƒì„±</button>
                        <a href="/admin/settlement/category_excel?category={{ c.name | urlencode }}&start_date={{ (email_order_date.strftime('%Y-%m-%d') if email_order_date else '') }}%2000:00&end_date={{ (email_order_date.strftime('%Y-%m-%d') if email_order_date else '') }}%2023:59" class="inline-block px-3 py-1.5 rounded-lg bg-blue-100 text-blue-700 text-[10px] font-black hover:bg-blue-200">ì¹´í…Œê³ ë¦¬ ì—‘ì…€</a>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <p class="text-gray-500 text-sm py-6">íŒë§¤ì ì´ë©”ì¼ì´ ë“±ë¡ëœ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬ ì„¤ì •ì—ì„œ ë§¤ë‹ˆì € ì´ë©”ì¼ì„ ë„£ì–´ ì£¼ì„¸ìš”.</p>
                {% endfor %}
                <div id="email-order-result" class="hidden mt-4 p-4 rounded-2xl bg-teal-50 border border-teal-200">
                    <p class="font-black text-teal-800 mb-2">ì´ë©”ì¼ ë°œì†¡ ì™„ë£Œ</p>
                    <p class="text-xs font-mono break-all" id="email-order-confirm-url"></p>
                    <p class="text-xs mt-2">í™•ì¸ì½”ë“œ: <strong id="email-order-confirm-code"></strong></p>
                </div>
                <div id="email-order-preview-modal" class="hidden fixed inset-0 z-50 overflow-auto bg-black/50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl max-w-2xl w-full p-6 max-h-[90vh] overflow-auto">
                        <h4 class="font-black text-gray-800 mb-2">ë°œì£¼ì–‘ì‹ ë¯¸ë¦¬ë³´ê¸° Â· í™•ì¸ ì‹œ ë©”ì¼ ë°œì†¡</h4>
                        <p class="text-[10px] text-gray-500 mb-2">ìˆ˜ì‹ : <span id="preview-to-email"></span></p>
                        <div class="border border-gray-200 rounded-xl p-3 mb-4 text-xs font-mono whitespace-pre-wrap break-words" id="preview-body"></div>
                        <div class="flex gap-2">
                            <button type="button" id="email-order-send-confirm" class="px-4 py-2 bg-teal-600 text-white rounded-xl font-black text-xs">í™•ì¸ ì‹œ ë©”ì¼ ë°œì†¡</button>
                            <button type="button" id="email-order-preview-close" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-xl font-black text-xs">ë‹«ê¸°</button>
                        </div>
                    </div>
                </div>
                <hr class="my-10 border-gray-200">
                <div class="mb-8">
                    <h3 class="text-base font-black text-gray-800 mb-2">ìˆ˜ê¸° ì´ë©”ì¼ ë°œì†¡</h3>
                    <p class="text-[11px] text-gray-500 font-bold mb-4">ë°œì£¼ì–‘ì‹ê³¼ ë³„ê°œë¡œ ìˆ˜ì‹ Â·ì œëª©Â·ë³¸ë¬¸ì„ ì§ì ‘ ì…ë ¥í•˜ì—¬ ì´ë©”ì¼ì„ ë°œì†¡í•©ë‹ˆë‹¤.</p>
                    <div class="bg-white rounded-2xl border border-gray-200 p-6 max-w-xl">
                        <label class="block text-[11px] font-black text-gray-600 mb-1">ìˆ˜ì‹  ì´ë©”ì¼</label>
                        <input type="email" id="manual-email-to" placeholder="ë°›ëŠ” ì‚¬ëŒ ì´ë©”ì¼" class="w-full border border-gray-200 rounded-xl px-3 py-2 text-sm mb-3">
                        <label class="block text-[11px] font-black text-gray-600 mb-1">ì œëª©</label>
                        <input type="text" id="manual-email-subject" placeholder="ì œëª©" class="w-full border border-gray-200 rounded-xl px-3 py-2 text-sm mb-3">
                        <label class="block text-[11px] font-black text-gray-600 mb-1">ë³¸ë¬¸</label>
                        <textarea id="manual-email-body" rows="8" placeholder="ë³¸ë¬¸ ë‚´ìš©" class="w-full border border-gray-200 rounded-xl px-3 py-2 text-sm mb-4"></textarea>
                        <button type="button" id="manual-email-send" class="px-5 py-2.5 bg-amber-600 text-white rounded-xl font-black text-xs hover:bg-amber-700">ë°œì†¡</button>
                        <span id="manual-email-msg" class="ml-3 text-xs font-bold hidden"></span>
                    </div>
                </div>
            </div>
            <script>
            (function(){
                var orderDate = '{{ email_order_date.strftime("%Y-%m-%d") if email_order_date else "" }}';
                var previewData = null;
                document.querySelectorAll('.email-order-gen').forEach(function(btn){
                    btn.addEventListener('click', function(){
                        var catId = parseInt(btn.dataset.categoryId, 10);
                        var catName = btn.dataset.categoryName || '';
                        var row = btn.closest('.email-order-row');
                        var toInput = row ? row.querySelector('.email-order-to') : null;
                        var toEmail = (toInput && toInput.value) ? toInput.value.trim() : '';
                        if (!toEmail) { alert('ìˆ˜ì‹  ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
                        fetch('/admin/seller/order_preview?category_id=' + catId + '&order_date=' + (orderDate || new Date().toISOString().slice(0,10)))
                            .then(function(r){ return r.json(); })
                            .then(function(d){
                                if (!d.success) { alert(d.message || 'ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨'); return; }
                                previewData = { category_id: catId, order_date: orderDate || new Date().toISOString().slice(0,10), to_email: toEmail };
                                document.getElementById('preview-to-email').textContent = toEmail;
                                document.getElementById('preview-body').textContent = d.body || '';
                                document.getElementById('email-order-preview-modal').classList.remove('hidden');
                            }).catch(function(){ alert('ìš”ì²­ ì‹¤íŒ¨'); });
                    });
                });
                document.getElementById('email-order-preview-close').addEventListener('click', function(){
                    document.getElementById('email-order-preview-modal').classList.add('hidden');
                    previewData = null;
                });
                document.getElementById('email-order-send-confirm').addEventListener('click', function(){
                    if (!previewData || !confirm('í•´ë‹¹ ë‚´ìš©ìœ¼ë¡œ ë©”ì¼ì„ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                    fetch('/admin/seller/send_order_email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                        credentials: 'same-origin',
                        body: JSON.stringify({ category_id: previewData.category_id, order_date: previewData.order_date, to_email: previewData.to_email })
                    }).then(function(r){ return r.json(); }).then(function(d){
                        if (d.success) {
                            document.getElementById('email-order-preview-modal').classList.add('hidden');
                            var resultEl = document.getElementById('email-order-result');
                            resultEl.classList.remove('hidden');
                            document.getElementById('email-order-confirm-url').textContent = d.confirm_url || '';
                            document.getElementById('email-order-confirm-code').textContent = d.confirmation_code || '';
                            resultEl.scrollIntoView({ behavior: 'smooth' });
                        } else { alert(d.message || 'ë°œì†¡ ì‹¤íŒ¨'); }
                    }).catch(function(){ alert('ìš”ì²­ ì‹¤íŒ¨'); });
                });
                document.getElementById('manual-email-send').addEventListener('click', function(){
                    var to = (document.getElementById('manual-email-to').value || '').trim();
                    var subj = (document.getElementById('manual-email-subject').value || '').trim();
                    var body = (document.getElementById('manual-email-body').value || '').trim();
                    if (!to) { alert('ìˆ˜ì‹  ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
                    if (!subj) { alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
                    var msgEl = document.getElementById('manual-email-msg');
                    msgEl.classList.remove('hidden'); msgEl.textContent = 'ë°œì†¡ ì¤‘...'; msgEl.className = 'ml-3 text-xs font-bold text-gray-600';
                    fetch('/admin/seller/send_manual_email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                        credentials: 'same-origin',
                        body: JSON.stringify({ to_email: to, subject: subj, body: body })
                    }).then(function(r){ return r.json(); }).then(function(d){
                        if (d.success) { msgEl.textContent = 'ë°œì†¡ ì™„ë£Œ'; msgEl.className = 'ml-3 text-xs font-bold text-teal-600'; }
                        else { msgEl.textContent = d.message || 'ë°œì†¡ ì‹¤íŒ¨'; msgEl.className = 'ml-3 text-xs font-bold text-red-600'; }
                    }).catch(function(){ msgEl.textContent = 'ìš”ì²­ ì‹¤íŒ¨'; msgEl.className = 'ml-3 text-xs font-bold text-red-600'; });
                });
            })();
            </script>

        {% elif tab == 'backup' %}
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-2">ë°±ì—… Â· ë³µì›</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-6">SQLite DBë¥¼ zipìœ¼ë¡œ ë°±ì—…í•©ë‹ˆë‹¤. GITHUB_BACKUP_TOKENÂ·GITHUB_BACKUP_REPO ì„¤ì • ì‹œ GitHub Releaseë¡œ ì—…ë¡œë“œë˜ë©°, ë¯¸ì„¤ì • ì‹œ instance/backups ì— ì €ì¥ë©ë‹ˆë‹¤.</p>
                <div class="flex flex-wrap items-center gap-4 mb-6">
                    <button type="button" id="backup-run-btn" class="px-6 py-3 bg-teal-600 text-white rounded-xl font-black text-sm hover:bg-teal-700 transition">ìˆ˜ë™ ë°±ì—… ì‹¤í–‰</button>
                    <span id="backup-result" class="text-sm font-bold"></span>
                </div>
                <div class="bg-amber-50 border border-amber-200 rounded-2xl p-6 text-left">
                    <h4 class="font-black text-amber-800 mb-3">ë°±ì—…ëœ íŒŒì¼ ì ìš© ë°©ë²• (ë³µì›)</h4>
                    <ol class="text-xs text-gray-700 space-y-2 list-decimal list-inside font-medium">
                        <li><strong>GitHubì— ë°±ì—…í•œ ê²½ìš°</strong>: GitHub ì €ì¥ì†Œ â†’ Releases â†’ í•´ë‹¹ backup-ë‚ ì§œ ì‹œê° íƒœê·¸ ì„ íƒ â†’ ì²¨ë¶€ëœ backup_YYYYMMDD_HHMM.zip ë‹¤ìš´ë¡œë“œ.</li>
                        <li>ì•±/ì„œë²„ë¥¼ <strong>ì¤‘ì§€</strong>í•œ ë’¤, zip ì••ì¶•ì„ í’€ì–´ ë‚˜ì˜¨ <code class="bg-white px-1 rounded">main.db</code>, <code class="bg-white px-1 rounded">delivery.db</code> ë“±ìœ¼ë¡œ ê¸°ì¡´ DB íŒŒì¼ì„ <strong>ë®ì–´ì“°ê¸°</strong>í•©ë‹ˆë‹¤. (ê¸°ì¡´ DBëŠ” ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ì˜®ê²¨ ë‘ê³  ë³µì›ìš© íŒŒì¼ë§Œ ì‚¬ìš©í•´ë„ ë©ë‹ˆë‹¤.)</li>
                        <li>ì•±ì„ ë‹¤ì‹œ <strong>ì‹œì‘</strong>í•©ë‹ˆë‹¤.</li>
                        <li>ë°°í¬ í™˜ê²½(Render ë“±)ì—ì„œëŠ” ì„œë²„ ë””ìŠ¤í¬ê°€ íœ˜ë°œì„±ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ë³µì›ì´ í•„ìš”í•  ë•Œ GitHub Releaseì—ì„œ zipì„ ë°›ì•„ ë¡œì»¬ì—ì„œ DBë¥¼ êµì²´í•œ ë’¤ ì¬ë°°í¬í•˜ê±°ë‚˜, ì¸ìŠ¤í„´ìŠ¤ ë””ìŠ¤í¬ì— DBë¥¼ ë³µì‚¬í•œ ë’¤ ì¬ì‹œì‘í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì ìš©í•˜ì„¸ìš”.</li>
                    </ol>
                </div>
                <p class="mt-4 text-[10px] text-gray-500">ë§¤ì¼ í•œêµ­ì‹œê°„ ìƒˆë²½ 4ì‹œ ìë™ ë°±ì—…: <code class="bg-gray-100 px-1 rounded">python app.py</code> ë¡œ ì‹¤í–‰ ì‹œ ìŠ¤ì¼€ì¤„ì´ ë™ì‘í•©ë‹ˆë‹¤. gunicorn ë°°í¬ ì‹œì—ëŠ” Cron ì„œë¹„ìŠ¤ì—ì„œ <code class="bg-gray-100 px-1 rounded">GET /admin/backup/cron?key=BACKUP_CRON_SECRET</code> ì„ ìƒˆë²½ 4ì‹œ(KST)ì— í˜¸ì¶œí•˜ë„ë¡ ì„¤ì •í•˜ë©´ ë©ë‹ˆë‹¤.</p>
            </div>
            <script>
            (function(){
                var btn = document.getElementById('backup-run-btn');
                var result = document.getElementById('backup-result');
                if (btn && result) {
                    btn.addEventListener('click', function(){
                        btn.disabled = true;
                        result.textContent = 'ë°±ì—… ì¤‘...';
                        fetch('/admin/backup/run', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' })
                            .then(function(r){ return r.json(); })
                            .then(function(d){
                                result.textContent = d.success ? ('âœ“ ' + (d.message || 'ì™„ë£Œ')) : ('âœ— ' + (d.message || 'ì‹¤íŒ¨'));
                                result.className = 'text-sm font-bold ' + (d.success ? 'text-teal-600' : 'text-red-600');
                                btn.disabled = false;
                            })
                            .catch(function(){ result.textContent = 'âœ— ìš”ì²­ ì‹¤íŒ¨'; result.className = 'text-sm font-bold text-red-600'; btn.disabled = false; });
                    });
                }
            })();
            </script>

        {% elif tab == 'member_grade' %}
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-2">íšŒì› ë“±ê¸‰ ê´€ë¦¬ (1Â·2Â·3ë‹¨ê³„)</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-4">ë“±ê¸‰ì€ í™”ë©´ì— ë…¸ì¶œí•˜ì§€ ì•Šìœ¼ë©°, ë“±ê¸‰ë³„ ì¹´í…Œê³ ë¦¬ ê³µê°œÂ·ë©”ì‹œì§€ ë°œì†¡ ë“±ì— ì‚¬ìš©í•©ë‹ˆë‹¤. ì§ì ‘ ì„¤ì •í•˜ê±°ë‚˜ êµ¬ë§¤ì´ë ¥ ê¸°ì¤€ìœ¼ë¡œ ìë™ ë°˜ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. êµ¬ë§¤ê¸ˆì•¡ì€ <strong>ë°°ì†¡ì™„ë£Œ</strong>ëœ í’ˆëª© ê¸ˆì•¡ë§Œ ì¸ì •ë©ë‹ˆë‹¤.</p>
                <div class="bg-amber-50 border border-amber-200 rounded-2xl p-6 mb-6">
                    <p class="font-black text-amber-800 text-xs mb-3">ìë™ ë“±ê¸‰ ê¸°ì¤€ (ëˆ„ì  ê²°ì œì•¡, ì›)</p>
                    <form id="mg_config_form" class="flex flex-wrap items-end gap-4">
                        <label class="flex flex-col gap-1"><span class="text-[10px] text-gray-600 font-bold">2ë‹¨ê³„ ìµœì†Œ</span><input type="number" name="min_amount_grade2" value="{{ member_grade_min2 }}" min="0" class="border border-gray-200 rounded-xl px-3 py-2 text-xs w-32"></label>
                        <label class="flex flex-col gap-1"><span class="text-[10px] text-gray-600 font-bold">3ë‹¨ê³„ ìµœì†Œ</span><input type="number" name="min_amount_grade3" value="{{ member_grade_min3 }}" min="0" class="border border-gray-200 rounded-xl px-3 py-2 text-xs w-32"></label>
                        <label class="flex flex-col gap-1"><span class="text-[10px] text-gray-600 font-bold">4ë‹¨ê³„ ìµœì†Œ</span><input type="number" name="min_amount_grade4" value="{{ member_grade_min4 }}" min="0" class="border border-gray-200 rounded-xl px-3 py-2 text-xs w-32"></label>
                        <label class="flex flex-col gap-1"><span class="text-[10px] text-gray-600 font-bold">5ë‹¨ê³„ ìµœì†Œ</span><input type="number" name="min_amount_grade5" value="{{ member_grade_min5 }}" min="0" class="border border-gray-200 rounded-xl px-3 py-2 text-xs w-32"></label>
                        <button type="submit" class="px-4 py-2 bg-amber-600 text-white rounded-xl font-black text-xs">ê¸°ì¤€ ì €ì¥</button>
                    </form>
                    <p class="text-[10px] text-amber-700 mt-2">ì €ì¥ í›„ ì•„ë˜ ã€Œêµ¬ë§¤ì´ë ¥ìœ¼ë¡œ ìë™ ë°˜ì˜ã€ ì‹œ ìœ„ ê¸°ì¤€ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤. ì§ì ‘ ì„¤ì •í•œ íšŒì›ì€ ìë™ ë°˜ì˜ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.</p>
                </div>
                <div class="flex gap-3 mb-4">
                    <button type="button" id="mg_auto_apply_btn" class="px-5 py-2.5 bg-teal-600 text-white rounded-xl font-black text-xs">êµ¬ë§¤ì´ë ¥ìœ¼ë¡œ ìë™ ë°˜ì˜</button>
                    <span id="mg_api_message" class="text-xs font-bold hidden"></span>
                </div>
                <div class="bg-white rounded-2xl border border-gray-200 overflow-x-auto">
                    <table class="w-full text-left min-w-[800px] text-[11px] font-bold border-collapse">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="p-3 border border-gray-600">ì´ë©”ì¼</th>
                                <th class="p-3 border border-gray-600">ì´ë¦„</th>
                                <th class="p-3 border border-gray-600 w-20 text-center">ë“±ê¸‰</th>
                                <th class="p-3 border border-gray-600 w-24 text-center">ì§ì ‘ì„¤ì •</th>
                                <th class="p-3 border border-gray-600 w-28 text-right">ëˆ„ì ê²°ì œ(ì›)</th>
                                <th class="p-3 border border-gray-600 w-20 text-center">ì£¼ë¬¸ìˆ˜</th>
                                <th class="p-3 border border-gray-600">ì„¤ì •</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for u in member_grade_users %}
                            <tr class="border-b border-gray-100">
                                <td class="p-3">{{ u.email }}</td>
                                <td class="p-3">{{ u.name }}</td>
                                <td class="p-3 text-center">{{ u.member_grade }}ë‹¨ê³„</td>
                                <td class="p-3 text-center">{% if u.member_grade_overridden %}Y{% else %}-{% endif %}</td>
                                <td class="p-3 text-right">{{ "{:,}".format(u.total_paid) }}</td>
                                <td class="p-3 text-center">{{ u.order_count }}</td>
                                <td class="p-3">
                                    <select class="mg_grade_select border border-gray-200 rounded-lg px-2 py-1 text-[10px]" data-user-id="{{ u.id }}">
                                        <option value="1" {% if u.member_grade == 1 %}selected{% endif %}>1ë‹¨ê³„</option>
                                        <option value="2" {% if u.member_grade == 2 %}selected{% endif %}>2ë‹¨ê³„</option>
                                        <option value="3" {% if u.member_grade == 3 %}selected{% endif %}>3ë‹¨ê³„</option>
                                        <option value="4" {% if u.member_grade == 4 %}selected{% endif %}>4ë‹¨ê³„</option>
                                        <option value="5" {% if u.member_grade == 5 %}selected{% endif %}>5ë‹¨ê³„</option>
                                    </select>
                                    <button type="button" class="mg_set_btn ml-1 px-2 py-1 bg-orange-100 text-orange-700 rounded-lg text-[10px] font-black" data-user-id="{{ u.id }}">ì§ì ‘ ì„¤ì •</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if not member_grade_users %}<p class="text-gray-400 text-sm mt-4">ë“±ë¡ëœ ì¼ë°˜ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>{% endif %}
            </div>
            <script>
            (function(){
                var msgEl = document.getElementById('mg_api_message');
                function showMsg(text, ok) { msgEl.textContent = text; msgEl.classList.remove('hidden'); msgEl.className = 'text-xs font-bold ' + (ok ? 'text-teal-600' : 'text-red-600'); }
                document.getElementById('mg_config_form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    var fd = new FormData(this);
                    fetch('/admin/member_grade/config', { method: 'POST', body: fd }).then(function(r) { return r.json(); }).then(function(d) {
                        showMsg(d.error || 'ê¸°ì¤€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', !d.error);
                        if (!d.error) setTimeout(function() { location.reload(); }, 600);
                    }).catch(function() { showMsg('í†µì‹  ì˜¤ë¥˜', false); });
                });
                document.getElementById('mg_auto_apply_btn').addEventListener('click', function() {
                    fetch('/admin/member_grade/auto_apply', { method: 'POST', headers: { 'Content-Type': 'application/json' } }).then(function(r) { return r.json(); }).then(function(d) {
                        showMsg(d.error || ('ìë™ ë°˜ì˜ ì™„ë£Œ. ' + (d.updated || 0) + 'ëª… ë°˜ì˜ë¨.'), !d.error);
                        if (!d.error) setTimeout(function() { location.reload(); }, 600);
                    }).catch(function() { showMsg('í†µì‹  ì˜¤ë¥˜', false); });
                });
                document.querySelectorAll('.mg_set_btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var uid = this.getAttribute('data-user-id');
                        var row = this.closest('tr');
                        var sel = row.querySelector('.mg_grade_select');
                        var grade = sel ? sel.value : 1;
                        fetch('/admin/member_grade/set', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ user_id: parseInt(uid, 10), grade: parseInt(grade, 10), overridden: true })
                        }).then(function(r) { return r.json(); }).then(function(d) {
                            showMsg(d.error || 'ì§ì ‘ ì„¤ì • ë°˜ì˜ë¨.', !d.error);
                            if (!d.error) setTimeout(function() { location.reload(); }, 600);
                        }).catch(function() { showMsg('í†µì‹  ì˜¤ë¥˜', false); });
                    });
                });
            })();
            </script>

        {% elif tab == 'messages' %}
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-2">ë©”ì‹œì§€ ë°œì†¡</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-4">íšŒì› ë“±ê¸‰ì„ ì„ íƒí•´ ê°€ì…ì¸ì‚¬Â·ì´ë²¤íŠ¸Â·ê³µì§€Â·ì•ˆë‚´ ë“±ì„ ì§ì ‘ ì‘ì„±í•´ ë°œì†¡í•©ë‹ˆë‹¤. ì•„ë˜ì—ì„œ ìë™ ë°œì†¡ ë¬¸êµ¬(í…œí”Œë¦¿)ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded-2xl border border-gray-200 p-8">
                        <p class="text-[10px] text-teal-600 font-black uppercase mb-3">ë“±ê¸‰ë³„ ì§ì ‘ ë°œì†¡</p>
                        <form id="admin_message_form" class="space-y-4">
                            <div class="flex flex-wrap gap-4 items-end">
                                <label class="flex flex-col gap-1">
                                    <span class="text-[10px] text-gray-600 font-bold">ëŒ€ìƒ ë“±ê¸‰</span>
                                    <select name="target_grade" class="border border-gray-200 rounded-xl px-4 py-2.5 text-xs font-black">
                                        <option value="all">ì „ì²´ íšŒì›</option>
                                        <option value="1">1ë‹¨ê³„</option>
                                        <option value="2">2ë‹¨ê³„</option>
                                        <option value="3">3ë‹¨ê³„</option>
                                        <option value="4">4ë‹¨ê³„</option>
                                        <option value="5">5ë‹¨ê³„</option>
                                    </select>
                                </label>
                                <label class="flex flex-col gap-1">
                                    <span class="text-[10px] text-gray-600 font-bold">ìœ í˜•</span>
                                    <select name="msg_type" class="border border-gray-200 rounded-xl px-4 py-2.5 text-xs font-black">
                                        <option value="welcome">ê°€ì…ì¸ì‚¬</option>
                                        <option value="event">ì´ë²¤íŠ¸</option>
                                        <option value="notice">ê³µì§€</option>
                                        <option value="guide">ì•ˆë‚´</option>
                                        <option value="custom">ì§ì ‘ì‘ì„±</option>
                                    </select>
                                </label>
                            </div>
                            <label class="block">
                                <span class="text-[10px] text-gray-600 font-bold">ì œëª©</span>
                                <input type="text" name="title" required placeholder="ë©”ì‹œì§€ ì œëª©" class="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm font-black mt-1">
                            </label>
                            <label class="block">
                                <span class="text-[10px] text-gray-600 font-bold">ë‚´ìš©</span>
                                <textarea name="body" rows="5" placeholder="ë©”ì‹œì§€ ë‚´ìš©" class="w-full border border-gray-200 rounded-xl px-4 py-3 text-sm font-black mt-1"></textarea>
                            </label>
                            <button type="submit" class="bg-teal-600 text-white px-8 py-3 rounded-xl font-black text-sm hover:bg-teal-700 transition">ë°œì†¡í•˜ê¸°</button>
                        </form>
                        <p id="admin_message_result" class="mt-4 text-sm font-bold hidden"></p>
                    </div>
                    <div class="bg-amber-50/80 rounded-2xl border border-amber-200 p-8">
                        <p class="text-[10px] text-amber-700 font-black uppercase mb-3">ìë™ ë°œì†¡ í…œí”Œë¦¿ í¸ì§‘</p>
                        <p class="text-[11px] text-gray-600 mb-4">ì£¼ë¬¸/ë°°ì†¡ ì‹œ ìë™ ë°œì†¡ë˜ëŠ” ë¬¸êµ¬ì…ë‹ˆë‹¤. <code class="bg-white px-1 rounded text-[10px]">{order_id}</code>ëŠ” ì£¼ë¬¸ë²ˆí˜¸ë¡œ ì¹˜í™˜ë©ë‹ˆë‹¤.</p>
                        <form id="admin_template_form" class="space-y-4">
                            <label class="block">
                                <span class="text-[10px] text-gray-600 font-bold">ìœ í˜•</span>
                                <select name="msg_type" id="template_msg_type" class="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-xs font-black mt-1">
                                    <option value="welcome">ê°€ì…ì¸ì‚¬</option>
                                    <option value="order_created">ì£¼ë¬¸ì ‘ìˆ˜</option>
                                    <option value="order_cancelled">ì£¼ë¬¸ì·¨ì†Œ</option>
                                    <option value="part_cancelled">ì¼ë¶€ì·¨ì†Œ</option>
                                    <option value="out_of_stock">í’ˆì ˆì·¨ì†Œ</option>
                                    <option value="delivery_requested">ë°°ì†¡ìš”ì²­</option>
                                    <option value="delivery_in_progress">ë°°ì†¡ì¤‘</option>
                                    <option value="delivery_complete">ë°°ì†¡ì™„ë£Œ</option>
                                    <option value="delivery_delayed">ë°°ì†¡ì§€ì—°</option>
                                </select>
                            </label>
                            <label class="block">
                                <span class="text-[10px] text-gray-600 font-bold">ì œëª©</span>
                                <input type="text" name="title" id="template_title" class="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm font-black mt-1">
                            </label>
                            <label class="block">
                                <span class="text-[10px] text-gray-600 font-bold">ë‚´ìš©</span>
                                <textarea name="body" id="template_body" rows="4" class="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm font-black mt-1"></textarea>
                            </label>
                            <button type="submit" class="bg-amber-600 text-white px-6 py-2.5 rounded-xl font-black text-xs hover:bg-amber-700 transition">í…œí”Œë¦¿ ì €ì¥</button>
                        </form>
                        <p id="admin_template_result" class="mt-3 text-sm font-bold hidden"></p>
                    </div>
                </div>
                <div class="mt-8 p-6 bg-gray-50 rounded-2xl border border-gray-100 text-left text-[11px] text-gray-600">
                    <p class="font-black text-gray-800 mb-2">ìë™ ë°œì†¡ ì•ˆë‚´</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li>ê°€ì… ì‹œ: ê°€ì… í™˜ì˜ ë©”ì‹œì§€</li>
                        <li>ì£¼ë¬¸ ê²°ì œ ì™„ë£Œ ì‹œ: ì£¼ë¬¸ ì ‘ìˆ˜ ì•ˆë‚´</li>
                        <li>ë°°ì†¡ ìš”ì²­/ë°°ì†¡ì¤‘/ë°°ì†¡ì™„ë£Œ/ë°°ì†¡ì§€ì—° ì‹œ: ë°°ì†¡ ìƒíƒœ ì•Œë¦¼</li>
                        <li>ì£¼ë¬¸Â·í’ˆëª© ì·¨ì†ŒÂ·í’ˆì ˆì·¨ì†Œ ì‹œ: ì·¨ì†ŒÂ·í™˜ë¶ˆ ì•ˆë‚´</li>
                    </ul>
                </div>
                <div class="mt-8 bg-white rounded-2xl border border-gray-200 overflow-hidden">
                    <p class="p-4 font-black text-gray-800 border-b border-gray-100">ë°œì†¡ ì´ë ¥ (ìµœê·¼ 150ê±´)</p>
                    <div class="overflow-x-auto max-h-[400px] overflow-y-auto">
                        <table class="w-full text-left text-[11px] border-collapse">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="p-3 border-b border-gray-200 w-36">ë°œì†¡ì¼ì‹œ</th>
                                    <th class="p-3 border-b border-gray-200">ìˆ˜ì‹ ì</th>
                                    <th class="p-3 border-b border-gray-200 w-24">ìœ í˜•</th>
                                    <th class="p-3 border-b border-gray-200">ì œëª©</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in messages_history %}
                                <tr class="border-b border-gray-50 hover:bg-gray-50/50">
                                    <td class="p-3 text-gray-600">{{ row.msg.created_at.strftime('%Y-%m-%d %H:%M') if row.msg.created_at else '-' }}</td>
                                    <td class="p-3">{{ row.user_email }} ({{ row.user_name }})</td>
                                    <td class="p-3">{{ row.msg.msg_type or 'custom' }}</td>
                                    <td class="p-3 font-bold">{{ (row.msg.title or '')[:50] }}{% if (row.msg.title or '')|length > 50 %}...{% endif %}</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="4" class="p-6 text-center text-gray-400">ë°œì†¡ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <script>
            (function(){
                var templateData = {{ message_templates | tojson | safe }};
                var form = document.getElementById('admin_message_form');
                var resultEl = document.getElementById('admin_message_result');
                if (form) form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    var fd = new FormData(form);
                    var obj = { target_grade: fd.get('target_grade') || 'all', msg_type: fd.get('msg_type') || 'custom', title: fd.get('title') || '', body: fd.get('body') || '' };
                    resultEl.classList.add('hidden');
                    fetch('/admin/messages/send', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(obj), credentials: 'same-origin' })
                        .then(function(r) { return r.json(); })
                        .then(function(d) {
                            resultEl.textContent = d.success ? (d.message || d.count + 'ëª… ë°œì†¡ë¨') : (d.message || 'ë°œì†¡ ì‹¤íŒ¨');
                            resultEl.className = 'mt-4 text-sm font-bold ' + (d.success ? 'text-teal-600' : 'text-red-600');
                            resultEl.classList.remove('hidden');
                            if (d.success) { form.querySelector('[name="title"]').value = ''; form.querySelector('[name="body"]').value = ''; }
                        })
                        .catch(function() { resultEl.textContent = 'í†µì‹  ì˜¤ë¥˜'; resultEl.className = 'mt-4 text-sm font-bold text-red-600'; resultEl.classList.remove('hidden'); });
                });
                var tForm = document.getElementById('admin_template_form');
                var tResult = document.getElementById('admin_template_result');
                var sel = document.getElementById('template_msg_type');
                var tTitle = document.getElementById('template_title');
                var tBody = document.getElementById('template_body');
                function fillTemplate() {
                    var val = sel ? sel.value : '';
                    var t = templateData && templateData.find(function(x) { return x.msg_type === val; });
                    if (t) { if (tTitle) tTitle.value = t.title || ''; if (tBody) tBody.value = t.body || ''; }
                }
                if (sel) sel.addEventListener('change', fillTemplate);
                if (templateData && templateData.length && sel) { fillTemplate(); }
                if (tForm) tForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    var fd = new FormData(tForm);
                    tResult.classList.add('hidden');
                    fetch('/admin/messages/template', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ msg_type: fd.get('msg_type'), title: fd.get('title'), body: fd.get('body') }), credentials: 'same-origin' })
                        .then(function(r) { return r.json(); })
                        .then(function(d) {
                            tResult.textContent = d.success ? 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : (d.message || 'ì €ì¥ ì‹¤íŒ¨');
                            tResult.className = 'mt-3 text-sm font-bold ' + (d.success ? 'text-teal-600' : 'text-red-600');
                            tResult.classList.remove('hidden');
                            if (d.success) { var t = templateData && templateData.find(function(x) { return x.msg_type === fd.get('msg_type'); }); if (t) { t.title = fd.get('title'); t.body = fd.get('body'); } }
                        })
                        .catch(function() { tResult.textContent = 'í†µì‹  ì˜¤ë¥˜'; tResult.className = 'mt-3 text-sm font-bold text-red-600'; tResult.classList.remove('hidden'); });
                });
            })();
            </script>

        {% elif tab == 'popup' %}
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-2">ì•Œë¦¼ íŒì—… ê´€ë¦¬</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-4">ì ‘ì† ì‹œ ë…¸ì¶œí•  ê³µì§€Â·ì´ë²¤íŠ¸Â·ì•Œë¦¼ íŒì—…. í‘œì‹œ ê¸°ê°„(ì‹œì‘/ì¢…ë£Œ)ê³¼ ì´ë¯¸ì§€Â·ë‚ ì§œ ë¬¸êµ¬ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded-2xl border border-gray-200 p-8">
                        <p class="text-[10px] text-teal-600 font-black uppercase mb-4">íŒì—… ë“±ë¡/ìˆ˜ì •</p>
                        <form id="popup_form" class="space-y-4 text-left">
                            <input type="hidden" name="id" id="popup_id" value="">
                            <label class="block">
                                <span class="text-[10px] text-gray-600 font-bold">ìœ í˜•</span>
                                <select name="popup_type" id="popup_type" class="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm font-black mt-1">
                                    <option value="notice">ê³µì§€</option>
                                    <option value="event">ì´ë²¤íŠ¸</option>
                                    <option value="alert">ì•Œë¦¼</option>
                                </select>
                            </label>
                            <label class="block">
                                <span class="text-[10px] text-gray-600 font-bold">ì œëª©</span>
                                <input type="text" name="title" id="popup_title" required class="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm font-black mt-1" placeholder="íŒì—… ì œëª©">
                            </label>
                            <label class="block">
                                <span class="text-[10px] text-gray-600 font-bold">ë‚´ìš©</span>
                                <textarea name="body" id="popup_body" rows="4" class="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm font-black mt-1" placeholder="ë³¸ë¬¸ (ì¤„ë°”ê¿ˆ ê°€ëŠ¥)"></textarea>
                            </label>
                            <label class="block">
                                <span class="text-[10px] text-gray-600 font-bold">ë…¸ì¶œìš© ë‚ ì§œ/ê¸°ê°„ ë¬¸êµ¬</span>
                                <input type="text" name="display_date" id="popup_display_date" class="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm font-black mt-1" placeholder="ì˜ˆ: 2025.02.22 ~ 02.28">
                            </label>
                            <label class="block">
                                <span class="text-[10px] text-gray-600 font-bold">ì´ë¯¸ì§€</span>
                                <div class="flex gap-2 mt-1">
                                    <input type="text" name="image_url" id="popup_image_url" class="flex-1 border border-gray-200 rounded-xl px-4 py-2.5 text-sm font-black" placeholder="/static/uploads/ì´ë¯¸ì§€.jpg ë˜ëŠ” URL">
                                    <input type="file" id="popup_image_file" accept="image/*" class="hidden">
                                    <button type="button" id="popup_image_upload_btn" class="px-4 py-2.5 bg-gray-200 text-gray-700 rounded-xl font-black text-xs whitespace-nowrap">ì—…ë¡œë“œ</button>
                                </div>
                            </label>
                            <div class="grid grid-cols-2 gap-4">
                                <label class="block">
                                    <span class="text-[10px] text-gray-600 font-bold">ë…¸ì¶œ ì‹œì‘ì¼ì‹œ</span>
                                    <input type="datetime-local" name="start_at" id="popup_start_at" class="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm font-black mt-1">
                                </label>
                                <label class="block">
                                    <span class="text-[10px] text-gray-600 font-bold">ë…¸ì¶œ ì¢…ë£Œì¼ì‹œ</span>
                                    <input type="datetime-local" name="end_at" id="popup_end_at" class="w-full border border-gray-200 rounded-xl px-4 py-2.5 text-sm font-black mt-1">
                                </label>
                            </div>
                            <div class="flex flex-wrap items-center gap-4">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" name="is_active" id="popup_is_active" checked class="rounded">
                                    <span class="text-xs font-bold">í™œì„±</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <span class="text-[10px] text-gray-600 font-bold">ìˆœì„œ</span>
                                    <input type="number" name="sort_order" id="popup_sort_order" value="0" class="border border-gray-200 rounded-lg px-2 py-1 w-16 text-xs">
                                </label>
                            </div>
                            <div class="flex gap-3">
                                <button type="submit" class="px-6 py-2.5 bg-teal-600 text-white rounded-xl font-black text-xs">ì €ì¥</button>
                                <button type="button" id="popup_form_reset" class="px-6 py-2.5 bg-gray-200 text-gray-700 rounded-xl font-black text-xs">ì´ˆê¸°í™”</button>
                            </div>
                        </form>
                        <p id="popup_form_result" class="mt-3 text-sm font-bold hidden"></p>
                    </div>
                    <div class="bg-gray-50 rounded-2xl border border-gray-200 p-6">
                        <p class="text-[10px] text-gray-600 font-black uppercase mb-4">ë“±ë¡ëœ íŒì—… ëª©ë¡</p>
                        <div class="space-y-3 max-h-[500px] overflow-y-auto">
                            {% for p in popup_list %}
                            <div class="bg-white rounded-xl border border-gray-100 p-4 flex justify-between items-start gap-3">
                                <div class="min-w-0 flex-1">
                                    <span class="text-[10px] px-2 py-0.5 rounded {{ 'bg-amber-100 text-amber-800' if p.popup_type == 'event' else ('bg-blue-100 text-blue-800' if p.popup_type == 'alert' else 'bg-gray-100 text-gray-700') }}">{{ 'ì´ë²¤íŠ¸' if p.popup_type == 'event' else ('ì•Œë¦¼' if p.popup_type == 'alert' else 'ê³µì§€') }}</span>
                                    <p class="font-black text-gray-800 mt-1 truncate">{{ p.title or '-' }}</p>
                                    <p class="text-[10px] text-gray-500">{% if p.start_at %}{{ p.start_at.strftime('%Y-%m-%d %H:%M') }}{% else %}ì‹œì‘ ë¯¸ì„¤ì •{% endif %} ~ {% if p.end_at %}{{ p.end_at.strftime('%Y-%m-%d %H:%M') }}{% else %}ì¢…ë£Œ ë¯¸ì„¤ì •{% endif %}</p>
                                </div>
                                <div class="flex gap-2 flex-shrink-0">
                                    <button type="button" class="popup-edit-btn px-3 py-1.5 bg-teal-100 text-teal-700 rounded-lg text-[10px] font-black" data-id="{{ p.id }}" data-title="{{ (p.title or '')|e }}" data-body="{{ (p.body or '')|e }}" data-type="{{ p.popup_type or 'notice' }}" data-display-date="{{ (p.display_date or '')|e }}" data-image-url="{{ (p.image_url or '')|e }}" data-start="{{ p.start_at.strftime('%Y-%m-%dT%H:%M') if p.start_at else '' }}" data-end="{{ p.end_at.strftime('%Y-%m-%dT%H:%M') if p.end_at else '' }}" data-active="{{ '1' if p.is_active else '0' }}" data-sort="{{ p.sort_order or 0 }}">ìˆ˜ì •</button>
                                    <button type="button" class="popup-del-btn px-3 py-1.5 bg-red-100 text-red-600 rounded-lg text-[10px] font-black" data-id="{{ p.id }}">ì‚­ì œ</button>
                                </div>
                            </div>
                            {% else %}
                            <p class="text-gray-400 text-sm">ë“±ë¡ëœ íŒì—…ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <script>
            (function(){
                var form = document.getElementById('popup_form');
                var resultEl = document.getElementById('popup_form_result');
                function toIsoLocal(d) { if (!d) return ''; var dt = new Date(d); var y=dt.getFullYear(), m=(''+(dt.getMonth()+1)).padStart(2,'0'), day=(''+dt.getDate()).padStart(2,'0'), h=(''+dt.getHours()).padStart(2,'0'), min=(''+dt.getMinutes()).padStart(2,'0'); return y+'-'+m+'-'+day+'T'+h+':'+min; }
                form.addEventListener('submit', function(e){
                    e.preventDefault();
                    var payload = { title: document.getElementById('popup_title').value, body: document.getElementById('popup_body').value, popup_type: document.getElementById('popup_type').value, display_date: document.getElementById('popup_display_date').value || null, image_url: document.getElementById('popup_image_url').value || null, start_at: document.getElementById('popup_start_at').value || null, end_at: document.getElementById('popup_end_at').value || null, is_active: document.getElementById('popup_is_active').checked, sort_order: parseInt(document.getElementById('popup_sort_order').value,10) || 0 };
                    var id = document.getElementById('popup_id').value; if (id) payload.id = parseInt(id,10);
                    resultEl.classList.add('hidden');
                    fetch('/admin/popup/save', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), credentials: 'same-origin' })
                        .then(function(r){ return r.json(); })
                        .then(function(d){ resultEl.textContent = d.success ? 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : (d.message || 'ì‹¤íŒ¨'); resultEl.className = 'mt-3 text-sm font-bold ' + (d.success ? 'text-teal-600' : 'text-red-600'); resultEl.classList.remove('hidden'); if (d.success) { document.getElementById('popup_form_reset').click(); location.reload(); } })
                        .catch(function(){ resultEl.textContent = 'í†µì‹  ì˜¤ë¥˜'; resultEl.className = 'mt-3 text-sm font-bold text-red-600'; resultEl.classList.remove('hidden'); });
                });
                document.getElementById('popup_form_reset').addEventListener('click', function(){ document.getElementById('popup_id').value = ''; document.getElementById('popup_title').value = ''; document.getElementById('popup_body').value = ''; document.getElementById('popup_type').value = 'notice'; document.getElementById('popup_display_date').value = ''; document.getElementById('popup_image_url').value = ''; document.getElementById('popup_start_at').value = ''; document.getElementById('popup_end_at').value = ''; document.getElementById('popup_is_active').checked = true; document.getElementById('popup_sort_order').value = '0'; });
                document.getElementById('popup_image_upload_btn').addEventListener('click', function(){ document.getElementById('popup_image_file').click(); });
                document.getElementById('popup_image_file').addEventListener('change', function(){
                    var fd = new FormData(); fd.append('image', this.files[0]);
                    fetch('/admin/popup/upload', { method: 'POST', body: fd, credentials: 'same-origin' }).then(function(r){ return r.json(); }).then(function(d){ if (d.success && d.url) document.getElementById('popup_image_url').value = d.url; else if (d.message) alert(d.message); }); this.value = '';
                });
                document.querySelectorAll('.popup-edit-btn').forEach(function(btn){
                    btn.addEventListener('click', function(){ var d=btn.dataset; document.getElementById('popup_id').value = d.id; document.getElementById('popup_title').value = d.title || ''; document.getElementById('popup_body').value = d.body || ''; document.getElementById('popup_type').value = d.type || 'notice'; document.getElementById('popup_display_date').value = d.displayDate || ''; document.getElementById('popup_image_url').value = d.imageUrl || ''; document.getElementById('popup_start_at').value = d.start || ''; document.getElementById('popup_end_at').value = d.end || ''; document.getElementById('popup_is_active').checked = d.active === '1'; document.getElementById('popup_sort_order').value = d.sort || '0'; });
                });
                document.querySelectorAll('.popup-del-btn').forEach(function(btn){
                    btn.addEventListener('click', function(){ if (!confirm('ì´ íŒì—…ì„ ì‚­ì œí• ê¹Œìš”?')) return; fetch('/admin/popup/delete/' + btn.dataset.id, { method: 'POST', credentials: 'same-origin' }).then(function(){ location.reload(); }); });
                });
            })();
            </script>

        {% elif tab == 'point_manage' %}
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-2">í¬ì¸íŠ¸ ì •ì±… ë° íšŒì›ë³„ ê´€ë¦¬</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-4">êµ¬ë§¤ê¸ˆì•¡ì˜ 0.1% ìë™ ì ë¦½, ì„¤ì •í•œ ê¸ˆì•¡ ì´ìƒ êµ¬ë§¤ ì‹œ ì„¤ì •í•œ í•œë„ê¹Œì§€ ì‚¬ìš© ê°€ëŠ¥.</p>
                <div class="bg-amber-50 border border-amber-200 rounded-2xl p-6 mb-6">
                    <p class="font-black text-amber-800 text-xs mb-3">í¬ì¸íŠ¸ ì •ì±… ì„¤ì •</p>
                    <form id="point_config_form" class="flex flex-wrap items-end gap-4">
                        <label class="flex flex-col gap-1"><span class="text-[10px] text-gray-600 font-bold">ì ë¦½ë¥  (1=0.1%)</span><input type="number" name="accumulation_rate" value="{{ point_accumulation_rate }}" min="0" max="100" class="border border-gray-200 rounded-xl px-3 py-2 text-xs w-24"></label>
                        <label class="flex flex-col gap-1"><span class="text-[10px] text-gray-600 font-bold">ì‚¬ìš© ê°€ëŠ¥ ìµœì†Œ ì£¼ë¬¸ê¸ˆì•¡(ì›)</span><input type="number" name="min_order_to_use" value="{{ point_min_order }}" min="0" class="border border-gray-200 rounded-xl px-3 py-2 text-xs w-36"></label>
                        <label class="flex flex-col gap-1"><span class="text-[10px] text-gray-600 font-bold">1íšŒ ìµœëŒ€ ì‚¬ìš©(ì›)</span><input type="number" name="max_points_per_order" value="{{ point_max_use }}" min="0" class="border border-gray-200 rounded-xl px-3 py-2 text-xs w-32"></label>
                        <button type="submit" class="px-4 py-2 bg-amber-600 text-white rounded-xl font-black text-xs">ì €ì¥</button>
                    </form>
                    <p class="text-[10px] text-amber-700 mt-2">ì ë¦½ë¥  1 = êµ¬ë§¤ê¸ˆì•¡ì˜ 0.1% ìë™ ì ë¦½. ì‚¬ìš© ê°€ëŠ¥ ìµœì†Œ ì£¼ë¬¸ê¸ˆì•¡(ì›) ì´ìƒ êµ¬ë§¤ ì‹œ, 1íšŒ ìµœëŒ€ ì‚¬ìš©(ì›)ê¹Œì§€ ê²°ì œ ì‹œ ì‚¬ìš© ê°€ëŠ¥.</p>
                </div>
                <div id="point_log_modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 p-4">
                    <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[85vh] overflow-hidden flex flex-col">
                        <div class="p-4 border-b border-gray-100 font-black text-gray-800" id="point_log_modal_title">í¬ì¸íŠ¸ ì ë¦½/ì‚¬ìš© ë‚´ì—­</div>
                        <div class="p-4 overflow-y-auto flex-1 text-[11px]" id="point_log_modal_body"></div>
                        <div class="p-4 border-t border-gray-100"><button type="button" id="point_log_modal_close" class="w-full py-2 bg-gray-200 rounded-xl font-black text-sm">ë‹«ê¸°</button></div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl border border-gray-200 overflow-x-auto">
                    <table class="w-full text-left min-w-[700px] text-[11px] font-bold border-collapse">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="p-3 border border-gray-600">ì´ë©”ì¼</th>
                                <th class="p-3 border border-gray-600">ì´ë¦„</th>
                                <th class="p-3 border border-gray-600 w-28 text-right">ë³´ìœ  í¬ì¸íŠ¸</th>
                                <th class="p-3 border border-gray-600">ì§€ê¸‰/ì°¨ê° Â· Log</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for u in point_users %}
                            <tr class="border-b border-gray-100">
                                <td class="p-3">{{ u.email }}</td>
                                <td class="p-3">{{ u.name }}</td>
                                <td class="p-3 text-right">{{ "{:,}".format(u.points) }}ì›</td>
                                <td class="p-3">
                                    <input type="number" class="point_adj_amount border border-gray-200 rounded-lg px-2 py-1 text-[10px] w-20" placeholder="ê¸ˆì•¡" data-user-id="{{ u.id }}">
                                    <select class="point_adj_type border border-gray-200 rounded-lg px-2 py-1 text-[10px] ml-1"><option value="1">ì§€ê¸‰</option><option value="-1">ì°¨ê°</option></select>
                                    <input type="text" class="point_adj_memo border border-gray-200 rounded-lg px-2 py-1 text-[10px] w-24 ml-1" placeholder="ì‚¬ìœ " maxlength="50">
                                    <button type="button" class="point_adj_btn ml-1 px-2 py-1 bg-teal-100 text-teal-700 rounded-lg text-[10px] font-black" data-user-id="{{ u.id }}">ì ìš©</button>
                                    <button type="button" class="point_log_btn ml-1 px-2 py-1 bg-gray-200 text-gray-700 rounded-lg text-[10px] font-black" data-user-id="{{ u.id }}" data-user-name="{{ u.name or u.email }}">Log</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if not point_users %}<p class="text-gray-400 text-sm mt-4">íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>{% endif %}
            </div>
            <script>
            (function(){
                var msgEl = document.getElementById('pt_api_message');
                function showMsg(text, ok) {
                    var el = document.getElementById('pt_api_message');
                    if (!el) return;
                    el.textContent = text; el.classList.remove('hidden');
                    el.className = 'text-xs font-bold ' + (ok ? 'text-teal-600' : 'text-red-600');
                }
                document.getElementById('point_config_form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    var fd = new FormData(this);
                    fetch('/admin/point/config', { method: 'POST', body: fd }).then(function(r) { return r.json(); }).then(function(d) {
                        showMsg(d.error || 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', !d.error);
                        if (!d.error) setTimeout(function() { location.reload(); }, 600);
                    }).catch(function() { showMsg('í†µì‹  ì˜¤ë¥˜', false); });
                });
                document.querySelectorAll('.point_adj_btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var uid = parseInt(this.getAttribute('data-user-id'), 10);
                        var row = this.closest('tr');
                        var amtInput = row.querySelector('.point_adj_amount');
                        var typeSel = row.querySelector('.point_adj_type');
                        var memoInput = row.querySelector('.point_adj_memo');
                        var amt = parseInt(amtInput && amtInput.value, 10) || 0;
                        if (amt <= 0) { alert('ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
                        var mult = typeSel && typeSel.value === '-1' ? -1 : 1;
                        var body = JSON.stringify({ user_id: uid, amount: amt * mult, memo: memoInput ? memoInput.value : '' });
                        fetch('/admin/point/adjust', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: body }).then(function(r) { return r.json(); }).then(function(d) {
                            showMsg(d.error || 'ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.', !d.error);
                            if (!d.error) setTimeout(function() { location.reload(); }, 600);
                        }).catch(function() { showMsg('í†µì‹  ì˜¤ë¥˜', false); });
                    });
                });
                var modal = document.getElementById('point_log_modal');
                var modalTitle = document.getElementById('point_log_modal_title');
                var modalBody = document.getElementById('point_log_modal_body');
                document.getElementById('point_log_modal_close').addEventListener('click', function() { modal.classList.add('hidden'); modal.classList.remove('flex'); });
                modal.addEventListener('click', function(e) { if (e.target === modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); } });
                document.querySelectorAll('.point_log_btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var uid = this.getAttribute('data-user-id');
                        var name = this.getAttribute('data-user-name') || '';
                        modalTitle.textContent = 'í¬ì¸íŠ¸ ë‚´ì—­ Â· ' + name;
                        modalBody.innerHTML = '<p class="text-gray-400">ë¡œë”© ì¤‘...</p>';
                        modal.classList.remove('hidden'); modal.classList.add('flex');
                        fetch('/admin/point/log?user_id=' + uid + '&limit=100').then(function(r) { return r.json(); }).then(function(d) {
                            if (d.error) { modalBody.innerHTML = '<p class="text-red-600">' + d.error + '</p>'; return; }
                            var logs = d.logs || [];
                            if (logs.length === 0) { modalBody.innerHTML = '<p class="text-gray-400">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
                            var byDate = {};
                            logs.forEach(function(l) {
                                var dk = l.date || '';
                                if (!byDate[dk]) byDate[dk] = { earn: [], use: [] };
                                if (l.amount >= 0) byDate[dk].earn.push(l); else byDate[dk].use.push(l);
                            });
                            var dates = Object.keys(byDate).sort().reverse();
                            var html = '';
                            dates.forEach(function(date) {
                                html += '<div class="mb-6"><p class="text-gray-500 font-black text-[10px] uppercase tracking-wider mb-2 border-b border-gray-100 pb-1">' + date + '</p>';
                                var earn = byDate[date].earn;
                                var use = byDate[date].use;
                                if (earn.length) {
                                    html += '<p class="text-teal-600 font-bold text-[10px] mb-1">ì ë¦½ ë‚´ì—­</p><table class="w-full text-left mb-3"><thead><tr class="border-b border-gray-200 text-gray-500"><th class="py-1 pr-2">ì¼ì‹œ</th><th class="py-1 pr-2 text-right">ê¸ˆì•¡</th><th class="py-1 pr-2">ë©”ëª¨</th><th class="py-1">ìˆ˜ì •ì</th></tr></thead><tbody>';
                                    earn.forEach(function(l) {
                                        html += '<tr class="border-b border-gray-50"><td class="py-1 pr-2 text-gray-500">' + (l.created_at || '') + '</td><td class="py-1 pr-2 text-right text-teal-600">+' + l.amount + 'ì›</td><td class="py-1 pr-2">' + (l.memo || '-') + '</td><td class="py-1 text-gray-500">' + (l.modifier || 'ì‹œìŠ¤í…œ') + '</td></tr>';
                                    });
                                    html += '</tbody></table>';
                                }
                                if (use.length) {
                                    html += '<p class="text-red-600 font-bold text-[10px] mb-1">ì‚¬ìš© ë‚´ì—­</p><table class="w-full text-left"><thead><tr class="border-b border-gray-200 text-gray-500"><th class="py-1 pr-2">ì¼ì‹œ</th><th class="py-1 pr-2 text-right">ê¸ˆì•¡</th><th class="py-1 pr-2">ë©”ëª¨</th><th class="py-1">ìˆ˜ì •ì</th></tr></thead><tbody>';
                                    use.forEach(function(l) {
                                        html += '<tr class="border-b border-gray-50"><td class="py-1 pr-2 text-gray-500">' + (l.created_at || '') + '</td><td class="py-1 pr-2 text-right text-red-600">' + l.amount + 'ì›</td><td class="py-1 pr-2">' + (l.memo || '-') + '</td><td class="py-1 text-gray-500">' + (l.modifier || 'ì‹œìŠ¤í…œ') + '</td></tr>';
                                    });
                                    html += '</tbody></table>';
                                }
                                html += '</div>';
                            });
                            modalBody.innerHTML = html;
                        }).catch(function() { modalBody.innerHTML = '<p class="text-red-600">í†µì‹  ì˜¤ë¥˜</p>'; });
                    });
                });
            })();
            </script>
            <p id="pt_api_message" class="hidden mt-2 text-xs font-bold"></p>

        {% elif tab == 'marketing_cost' %}
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-2">ë§ˆì¼€íŒ…ë¹„ ì‚¬ìš©ë‚´ì—­</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-4">ê³ ê° í¬ì¸íŠ¸ ì‚¬ìš©ë¶„ì€ íŒë§¤ì í’ˆëª©/ì •ì‚°ì—ì„œ ì°¨ê°ë˜ì§€ ì•Šê³  ë§ˆì¼€íŒ…ë¹„ë¡œë§Œ ì²˜ë¦¬ë©ë‹ˆë‹¤. ì•„ë˜ëŠ” í¬ì¸íŠ¸ ì‚¬ìš©ì— ë”°ë¥¸ ë§ˆì¼€íŒ…ë¹„ ì§€ì¶œ ë‚´ì—­ì…ë‹ˆë‹¤.</p>
                <div class="bg-amber-50 border border-amber-200 rounded-2xl p-4 mb-6">
                    <p class="text-amber-800 font-black text-sm">ì „ì²´ ë§ˆì¼€íŒ…ë¹„ í•©ê³„ (í¬ì¸íŠ¸ ì‚¬ìš©ë¶„): <span class="text-lg">{{ "{:,}".format(marketing_cost_total) }}</span>ì›</p>
                </div>
                <div class="bg-white rounded-2xl border border-gray-200 overflow-x-auto">
                    <table class="w-full text-left min-w-[700px] text-[11px] font-bold border-collapse">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="p-3 border border-gray-600 w-36">ì¼ì‹œ</th>
                                <th class="p-3 border border-gray-600 w-20">ì£¼ë¬¸ID</th>
                                <th class="p-3 border border-gray-600">ê³ ê°(ì´ë©”ì¼/ì´ë¦„)</th>
                                <th class="p-3 border border-gray-600 w-28 text-right">ê¸ˆì•¡(ì›)</th>
                                <th class="p-3 border border-gray-600">ë¹„ê³ </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mc in marketing_cost_list %}
                            <tr class="border-b border-gray-100">
                                <td class="p-3">{{ mc.created_at.strftime('%Y-%m-%d %H:%M') if mc.created_at else '-' }}</td>
                                <td class="p-3"><a href="/admin/order/{{ mc.order_id }}" class="text-teal-600 hover:underline font-black">{{ mc.order_id }}</a></td>
                                <td class="p-3">{{ mc.user_email }} {% if mc.user_name %}({{ mc.user_name }}){% endif %}</td>
                                <td class="p-3 text-right">{{ "{:,}".format(mc.amount) }}</td>
                                <td class="p-3 text-gray-600">{{ mc.memo or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if not marketing_cost_list %}<p class="text-gray-400 text-sm mt-4">ë§ˆì¼€íŒ…ë¹„ ì‚¬ìš© ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>{% endif %}
                <p class="text-[10px] text-gray-500 mt-2">ìµœê·¼ 500ê±´ë§Œ í‘œì‹œë©ë‹ˆë‹¤. ì „ì²´ í•©ê³„ëŠ” ìƒë‹¨ ê¸ˆì•¡ì„ ì°¸ê³ í•˜ì„¸ìš”.</p>
            </div>

        {% elif tab == 'members' %}
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 italic mb-2">íšŒì›ê´€ë¦¬</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-4">ê°€ì… íšŒì› ì •ë³´ ì „ì²´ ì¶œë ¥ (ë¹„ë°€ë²ˆí˜¸ëŠ” ë³´ì•ˆìƒ ë¹„í‘œì‹œ)</p>
                <div class="bg-white rounded-2xl border border-gray-200 overflow-x-auto">
                    <table class="w-full text-left min-w-[900px] text-[11px] font-bold border-collapse">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="p-3 border border-gray-600 w-12 text-center">ID</th>
                                <th class="p-3 border border-gray-600">ì´ë©”ì¼</th>
                                <th class="p-3 border border-gray-600 w-24">ì´ë¦„</th>
                                <th class="p-3 border border-gray-600 w-28">ì „í™”</th>
                                <th class="p-3 border border-gray-600">ì£¼ì†Œ</th>
                                <th class="p-3 border border-gray-600">ìƒì„¸ì£¼ì†Œ</th>
                                <th class="p-3 border border-gray-600 w-20">í˜„ê´€ë¹„ë°€ë²ˆí˜¸</th>
                                <th class="p-3 border border-gray-600">ìš”ì²­ë©”ëª¨</th>
                                <th class="p-3 border border-gray-600 w-16 text-center">ê´€ë¦¬ì</th>
                                <th class="p-3 border border-gray-600 w-16 text-center">ë§ˆì¼€íŒ…</th>
                                <th class="p-3 border border-gray-600 w-14 text-center">ë“±ê¸‰</th>
                                <th class="p-3 border border-gray-600 w-14 text-center">ì§ì ‘ì„¤ì •</th>
                                <th class="p-3 border border-gray-600 w-20 text-right">í¬ì¸íŠ¸</th>
                                <th class="p-3 border border-gray-600 w-32 text-center">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for u in admin_members %}
                            <tr class="border-b border-gray-100 hover:bg-gray-50/50" data-member-id="{{ u.id }}" data-member-name="{{ (u.name or u.email or '')|e }}">
                                <td class="p-3 border border-gray-100 text-center text-gray-500">{{ u.id }}</td>
                                <td class="p-3 border border-gray-100">{{ u.email or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ u.name or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ u.phone or '-' }}</td>
                                <td class="p-3 border border-gray-100 max-w-[180px] truncate" title="{{ u.address or '' }}">{{ u.address or '-' }}</td>
                                <td class="p-3 border border-gray-100 max-w-[120px] truncate" title="{{ u.address_detail or '' }}">{{ u.address_detail or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ u.entrance_pw or '-' }}</td>
                                <td class="p-3 border border-gray-100 max-w-[140px] truncate" title="{{ u.request_memo or '' }}">{{ u.request_memo or '-' }}</td>
                                <td class="p-3 border border-gray-100 text-center">{% if u.is_admin %}Y{% else %}-{% endif %}</td>
                                <td class="p-3 border border-gray-100 text-center">{% if u.consent_marketing %}Y{% else %}-{% endif %}</td>
                                <td class="p-3 border border-gray-100 text-center">{{ u.member_grade or 1 }}</td>
                                <td class="p-3 border border-gray-100 text-center">{% if u.member_grade_overridden|default(false) %}Y{% else %}-{% endif %}</td>
                                <td class="p-3 border border-gray-100 text-right">{{ "{:,}".format(u.points or 0) }}ì›</td>
                                <td class="p-3 border border-gray-100 text-center">
                                    <button type="button" class="member-msg-btn px-2 py-1.5 rounded-lg bg-teal-600 text-white text-[10px] font-black hover:bg-teal-700 transition" data-uid="{{ u.id }}" data-uname="{{ (u.name or u.email or '')|e }}">ë©”ì‹œì§€</button>
                                    {% if not u.is_admin and u.id != current_user.id %}
                                    <button type="button" class="member-del-btn px-2 py-1.5 rounded-lg bg-red-500 text-white text-[10px] font-black hover:bg-red-600 transition ml-1" data-uid="{{ u.id }}">ì‚­ì œ</button>
                                    {% else %}
                                    <span class="text-gray-300 text-[10px]">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="14" class="p-8 text-center text-gray-400 font-bold">ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- íšŒì› ë©”ì‹œì§€ ë°œì†¡ ëª¨ë‹¬ (íšŒì›ê´€ë¦¬ íƒ­) -->
            <div id="member-msg-modal" class="fixed inset-0 z-[60] hidden items-center justify-center bg-black/50 p-4">
                <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-5">
                    <h3 class="text-lg font-black text-gray-800 mb-3">íšŒì›ì—ê²Œ ë©”ì‹œì§€ ë³´ë‚´ê¸°</h3>
                    <p class="text-xs text-gray-500 mb-3" id="member-msg-target">ëŒ€ìƒ: </p>
                    <input type="hidden" id="member-msg-uid" value="">
                    <div class="mb-3">
                        <label class="block text-[10px] font-black text-gray-500 mb-1">ì œëª©</label>
                        <input type="text" id="member-msg-title" class="w-full border border-gray-200 p-3 rounded-xl text-sm font-bold" placeholder="ì œëª© ì…ë ¥" maxlength="200">
                    </div>
                    <div class="mb-4">
                        <label class="block text-[10px] font-black text-gray-500 mb-1">ë‚´ìš©</label>
                        <textarea id="member-msg-body" class="w-full border border-gray-200 p-3 rounded-xl text-sm font-bold min-h-[100px]" placeholder="ë‚´ìš© ì…ë ¥"></textarea>
                    </div>
                    <div class="flex gap-2">
                        <button type="button" id="member-msg-submit" class="flex-1 py-3 bg-teal-600 text-white rounded-xl font-black text-sm hover:bg-teal-700 transition">ë°œì†¡</button>
                        <button type="button" id="member-msg-cancel" class="px-4 py-3 bg-gray-100 text-gray-600 rounded-xl font-black text-sm hover:bg-gray-200 transition">ì·¨ì†Œ</button>
                    </div>
                    <p id="member-msg-status" class="mt-2 text-xs font-bold hidden"></p>
                </div>
            </div>
            <script>
            (function(){
                var modal = document.getElementById('member-msg-modal');
                var targetEl = document.getElementById('member-msg-target');
                var uidEl = document.getElementById('member-msg-uid');
                var titleEl = document.getElementById('member-msg-title');
                var bodyEl = document.getElementById('member-msg-body');
                var statusEl = document.getElementById('member-msg-status');
                var submitBtn = document.getElementById('member-msg-submit');
                var cancelBtn = document.getElementById('member-msg-cancel');
                if (!modal || !uidEl) return;
                function showModal(uid, uname) {
                    uidEl.value = uid;
                    targetEl.textContent = 'ëŒ€ìƒ: ' + (uname || 'íšŒì› #' + uid);
                    titleEl.value = '';
                    bodyEl.value = '';
                    statusEl.classList.add('hidden');
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    if (titleEl) titleEl.focus();
                }
                function hideModal() {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
                document.querySelectorAll('.member-msg-btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var uid = this.getAttribute('data-uid');
                        var uname = this.getAttribute('data-uname') || '';
                        showModal(uid, uname);
                    });
                });
                if (cancelBtn) cancelBtn.addEventListener('click', hideModal);
                modal.addEventListener('click', function(e) { if (e.target === modal) hideModal(); });
                if (submitBtn) submitBtn.addEventListener('click', function() {
                    var uid = uidEl.value;
                    var title = (titleEl && titleEl.value) ? titleEl.value.trim() : '';
                    if (!title) { statusEl.textContent = 'ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'; statusEl.classList.remove('hidden'); statusEl.className = 'mt-2 text-xs font-bold text-red-600'; return; }
                    statusEl.textContent = 'ë°œì†¡ ì¤‘...';
                    statusEl.classList.remove('hidden');
                    statusEl.className = 'mt-2 text-xs font-bold text-gray-600';
                    submitBtn.disabled = true;
                    fetch('/admin/api/member/' + uid + '/message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                        body: JSON.stringify({ title: title, body: (bodyEl && bodyEl.value) ? bodyEl.value.trim() : '' }),
                        credentials: 'same-origin'
                    }).then(function(r) { return r.json(); }).then(function(d) {
                        if (d.success) { statusEl.textContent = d.message || 'ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.'; statusEl.className = 'mt-2 text-xs font-bold text-teal-600'; setTimeout(hideModal, 1200); }
                        else { statusEl.textContent = d.message || 'ë°œì†¡ ì‹¤íŒ¨'; statusEl.className = 'mt-2 text-xs font-bold text-red-600'; }
                    }).catch(function() { statusEl.textContent = 'ìš”ì²­ ì‹¤íŒ¨'; statusEl.className = 'mt-2 text-xs font-bold text-red-600'; }).finally(function() { submitBtn.disabled = false; });
                });
                document.querySelectorAll('.member-del-btn').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        var uid = this.getAttribute('data-uid');
                        if (!confirm('ì´ íšŒì›ì„ ì •ë§ ì‚­ì œí• ê¹Œìš”? ì£¼ë¬¸ ì´ë ¥ì´ ìˆìœ¼ë©´ ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')) return;
                        fetch('/admin/api/member/' + uid + '/delete', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' })
                            .then(function(r) { return r.json(); })
                            .then(function(d) {
                                if (d.success) { var row = document.querySelector('tr[data-member-id="' + uid + '"]'); if (row) row.remove(); alert(d.message); }
                                else { alert(d.message || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
                            })
                            .catch(function() { alert('ìš”ì²­ ì‹¤íŒ¨'); });
                    });
                });
            })();
            </script>

        {% elif tab == 'sellers' %}
            <div class="mb-12">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <div>
                        <h3 class="text-lg font-black text-gray-800 italic">Seller Business Profile (íŒë§¤ì ì •ë³´)</h3>
                        <p class="text-[11px] text-gray-500 font-bold mt-1">ì—‘ì…€ í˜•ì‹ìœ¼ë¡œ ì •ë ¬ëœ íŒë§¤ìë³„ ì‚¬ì—…ìÂ·ì •ì‚° ì •ë³´</p>
                    </div>
                    <a href="/admin/sellers/excel" class="bg-teal-600 text-white px-5 py-2.5 rounded-xl font-black text-xs shadow hover:bg-teal-700">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</a>
                </div>
                <div class="flex gap-2 mb-4">
                    <a href="/admin?tab=sellers&seller_tax=ì „ì²´" class="px-4 py-2 rounded-xl text-[11px] font-black {% if seller_tax == 'ì „ì²´' %}bg-teal-600 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">ì „ì²´</a>
                    <a href="/admin?tab=sellers&seller_tax=ê³¼ì„¸" class="px-4 py-2 rounded-xl text-[11px] font-black {% if seller_tax == 'ê³¼ì„¸' %}bg-teal-600 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">ê³¼ì„¸</a>
                    <a href="/admin?tab=sellers&seller_tax=ë©´ì„¸" class="px-4 py-2 rounded-xl text-[11px] font-black {% if seller_tax == 'ë©´ì„¸' %}bg-teal-600 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">ë©´ì„¸</a>
                </div>
                <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-x-auto">
                    <table class="w-full text-left min-w-[1000px] text-[11px] font-bold border-collapse">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="p-3 border border-gray-600 w-12 text-center">ìˆœì„œ</th>
                                <th class="p-3 border border-gray-600 w-16 text-center">ê³¼ì„¸/ë©´ì„¸</th>
                                <th class="p-3 border border-gray-600">ì¹´í…Œê³ ë¦¬</th>
                                <th class="p-3 border border-gray-600">ìƒí˜¸</th>
                                <th class="p-3 border border-gray-600">ëŒ€í‘œì</th>
                                <th class="p-3 border border-gray-600">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</th>
                                <th class="p-3 border border-gray-600">ì†Œì¬ì§€</th>
                                <th class="p-3 border border-gray-600">ê³ ê°ì„¼í„°</th>
                                <th class="p-3 border border-gray-600">ë¬¸ì˜ë§í¬</th>
                                <th class="p-3 border border-gray-600">ì€í–‰ëª…</th>
                                <th class="p-3 border border-gray-600">ì˜ˆê¸ˆì£¼</th>
                                <th class="p-3 border border-gray-600">ì •ì‚°ê³„ì¢Œ</th>
                                <th class="p-3 border border-gray-600">ë§¤ë‹ˆì €ì´ë©”ì¼</th>
                                <th class="p-3 border border-gray-600 w-20 text-center">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in sellers_categories %}
                            <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                                <td class="p-3 border border-gray-100 text-center text-gray-500">{{ loop.index }}</td>
                                <td class="p-3 border border-gray-100 text-center"><span class="{% if (c.tax_type or 'ê³¼ì„¸') == 'ë©´ì„¸' %}text-amber-600{% else %}text-teal-600{% endif %} font-black text-[10px]">{{ c.tax_type or 'ê³¼ì„¸' }}</span></td>
                                <td class="p-3 border border-gray-100 font-black text-teal-700">{{ c.name }}</td>
                                <td class="p-3 border border-gray-100">{{ c.biz_name or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.biz_representative or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.biz_reg_number or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.biz_address or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.biz_contact or '-' }}</td>
                                <td class="p-3 border border-gray-100 text-teal-600 truncate max-w-[120px]" title="{{ c.seller_inquiry_link or '' }}">{% if c.seller_inquiry_link %}{{ c.seller_inquiry_link[:30] }}{% if c.seller_inquiry_link|length > 30 %}...{% endif %}{% else %}-{% endif %}</td>
                                <td class="p-3 border border-gray-100">{{ c.bank_name or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.account_holder or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.settlement_account or '-' }}</td>
                                <td class="p-3 border border-gray-100 text-gray-500">{{ c.manager_email or '-' }}</td>
                                <td class="p-3 border border-gray-100 text-center"><a href="/admin/category/edit/{{ c.id }}" class="text-blue-600 font-black hover:underline text-[10px]">ìˆ˜ì •</a></td>
                            </tr>
                            {% else %}
                            <tr><td colspan="14" class="p-8 text-center text-gray-400 font-bold">ë“±ë¡ëœ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬ ì„¤ì •ì—ì„œ ì¶”ê°€í•´ ì£¼ì„¸ìš”.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        {% elif tab == 'orders' %}
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-left">
                <div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm"><p class="text-[9px] text-gray-400 font-black uppercase mb-1">Total Sales</p><p class="text-xl font-black text-teal-600">{{ "{:,}".format(stats.sales) }}ì›</p></div>
                <div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm"><p class="text-[9px] text-gray-400 font-black uppercase mb-1">Orders</p><p class="text-xl font-black text-gray-800">{{ stats.count }}ê±´</p></div>
                <div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm"><p class="text-[9px] text-gray-400 font-black uppercase mb-1">Delivery Fees</p><p class="text-xl font-black text-orange-500">{{ "{:,}".format(stats.delivery) }}ì›</p></div>
                <div class="bg-gray-800 p-6 rounded-[2rem] shadow-xl"><p class="text-[9px] text-gray-400 font-black uppercase mb-1 text-white/50">Grand Total</p><p class="text-xl font-black text-white">{{ "{:,}".format(stats.grand_total) }}ì›</p></div>
            </div>

            <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm mb-12">
                <div class="flex gap-2 mb-6">
                    <button type="button" onclick="setDateRange('today')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ì˜¤ëŠ˜</button>
                    <button type="button" onclick="setDateRange('7days')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ìµœê·¼ 7ì¼</button>
                    <button type="button" onclick="setDateRange('month')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ì´ë²ˆ ë‹¬</button>
                </div>
                <form action="/admin" method="GET" id="date-filter-form" class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                    <input type="hidden" name="tab" value="orders">
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì‹œì‘ ì¼ì‹œ</label><input type="datetime-local" name="start_date" id="start_date" value="{{ start_date_str.replace(' ', 'T') }}" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs"></div>
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì¢…ë£Œ ì¼ì‹œ</label><input type="datetime-local" name="end_date" id="end_date" value="{{ end_date_str.replace(' ', 'T') }}" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs"></div>
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì¹´í…Œê³ ë¦¬</label><select name="order_cat" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs bg-white"><option value="ì „ì²´">ëª¨ë“  í’ˆëª© í•©ì‚°</option>{% for c in selectable_categories %}<option value="{{c.name}}" {% if sel_order_cat == c.name %}selected{% endif %}>{{c.name}}</option>{% endfor %}</select></div>
                    <button type="submit" class="bg-teal-600 text-white py-4 rounded-2xl font-black shadow-lg">ì¡°íšŒí•˜ê¸°</button>
                </form>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8">
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-base font-black text-gray-800">íŒë§¤ìƒí’ˆëª…ë³„ íŒë§¤ìˆ˜ëŸ‰ ì´í•©ê³„</h3>
                        <div class="flex gap-2 flex-wrap">
                            <button type="button" onclick="downloadSalesSummaryTableImage()" class="bg-gray-700 text-white px-5 py-2.5 rounded-xl font-black text-xs shadow hover:bg-gray-800">ì´ë¯¸ì§€</button>
                            <a href="/admin/orders/sales_summary_excel?start_date={{start_date_str}}&end_date={{end_date_str}}&order_ids={{ filtered_orders | map(attribute='order_id') | join(',') }}&order_cat={{ sel_order_cat }}" class="bg-teal-600 text-white px-5 py-2.5 rounded-xl font-black text-xs shadow hover:bg-teal-700">ì—‘ì…€</a>
                        </div>
                    </div>
                    <div id="sales-summary-table-wrap" class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-x-auto overflow-y-auto max-h-[32rem]">
                        <table id="sales-summary-table" class="w-full text-[11px] font-black min-w-[400px]">
                            <thead class="bg-gray-800 text-white">
                                <tr>
                                    <th class="p-4 text-left">í’ˆëª©(ì¹´í…Œê³ ë¦¬)</th>
                                    <th class="p-4 text-left">íŒë§¤ìƒí’ˆëª…</th>
                                    <th class="p-4 text-center">íŒë§¤ìˆ˜ëŸ‰ ì´í•©ê³„</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in product_summary_rows %}
                                <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                                    <td class="p-4 text-gray-600">{{ row.category }}</td>
                                    <td class="p-4 text-gray-800">{{ row.product_name }}</td>
                                    <td class="p-4 text-center font-black text-teal-600">{{ row.total_quantity }}</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="3" class="p-8 text-center text-gray-400">ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="bg-gray-200 border-t-2 border-gray-400">
                                <tr>
                                    <td colspan="2" class="p-4 text-right font-black text-gray-800">ì´í•©ê³„ ìˆ˜ëŸ‰</td>
                                    <td class="p-4 text-center font-black text-teal-600">{{ sales_total_quantity }}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-base font-black text-gray-800">ì¡°íšŒ ê²°ê³¼ ìƒì„¸ (ì£¼ë¬¸ì¼ì‹œ Â· í’ˆëª© Â· ìˆ˜ëŸ‰ Â· ìƒíƒœ)</h3>
                        <div class="flex gap-2 flex-wrap">
                            <button type="button" onclick="downloadSalesTableImage()" class="bg-gray-700 text-white px-5 py-2.5 rounded-xl font-black text-xs shadow hover:bg-gray-800">ì´ë¯¸ì§€</button>
                            <a href="/admin/orders/sales_excel?start_date={{start_date_str}}&end_date={{end_date_str}}&order_ids={{ filtered_orders | map(attribute='order_id') | join(',') }}&order_cat={{ sel_order_cat }}" class="bg-teal-600 text-white px-5 py-2.5 rounded-xl font-black text-xs shadow hover:bg-teal-700">ì—‘ì…€</a>
                        </div>
                    </div>
                    <div id="sales-detail-table-wrap" class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-x-auto overflow-y-auto max-h-[32rem]">
                        <table id="sales-detail-table" class="w-full text-[11px] font-black min-w-[600px]">
                            <thead class="bg-gray-800 text-white">
                                <tr>
                                    <th class="p-4 text-left">ì£¼ë¬¸ì¼ì‹œ</th>
                                    <th class="p-4 text-left">íŒë§¤ìƒí’ˆëª…</th>
                                    <th class="p-4 text-left">ì¹´í…Œê³ ë¦¬</th>
                                    <th class="p-4 text-center">íŒë§¤ìˆ˜ëŸ‰</th>
                                    <th class="p-4 text-center">ê²°ì œìƒíƒœ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in sales_table_rows %}
                                <tr class="border-b border-gray-100 hover:bg-gray-50/50">
                                    <td class="p-4 text-gray-700">{{ row.order_date }}</td>
                                    <td class="p-4 text-gray-800">{{ row.product_name }}</td>
                                    <td class="p-4 text-gray-600">{{ row.category | default('') }}</td>
                                    <td class="p-4 text-center font-black">{{ row.quantity }}</td>
                                    <td class="p-4 text-center {% if row.status in ('ê²°ì œì·¨ì†Œ', 'ì·¨ì†Œ') %}text-red-500{% else %}text-teal-600{% endif %}">{{ row.status }}</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="5" class="p-8 text-center text-gray-400">ì¡°íšŒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="bg-gray-200 border-t-2 border-gray-400">
                                <tr>
                                    <td colspan="3" class="p-4 text-right font-black text-gray-800">ì´í•©ê³„ ìˆ˜ëŸ‰</td>
                                    <td class="p-4 text-center font-black text-teal-600">{{ sales_total_quantity }}</td>
                                    <td class="p-4"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm mb-8">
                <div class="flex gap-2 mb-6">
                    <button type="button" onclick="setDateRange('today')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ì˜¤ëŠ˜</button>
                    <button type="button" onclick="setDateRange('7days')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ìµœê·¼ 7ì¼</button>
                    <button type="button" onclick="setDateRange('month')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ì´ë²ˆ ë‹¬</button>
                </div>
                <form action="/admin" method="GET" id="date-filter-form-2" class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                    <input type="hidden" name="tab" value="orders">
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì‹œì‘ ì¼ì‹œ</label><input type="datetime-local" name="start_date" id="start_date_2" value="{{ start_date_str.replace(' ', 'T') }}" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs"></div>
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì¢…ë£Œ ì¼ì‹œ</label><input type="datetime-local" name="end_date" id="end_date_2" value="{{ end_date_str.replace(' ', 'T') }}" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs"></div>
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì¹´í…Œê³ ë¦¬</label><select name="order_cat" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs bg-white"><option value="ì „ì²´">ëª¨ë“  í’ˆëª© í•©ì‚°</option>{% for c in selectable_categories %}<option value="{{c.name}}" {% if sel_order_cat == c.name %}selected{% endif %}>{{c.name}}</option>{% endfor %}</select></div>
                    <button type="submit" class="bg-teal-600 text-white py-4 rounded-2xl font-black shadow-lg">ì¡°íšŒí•˜ê¸°</button>
                </form>
            </div>

            <div class="flex flex-wrap items-center gap-4 mb-8 bg-gray-50 p-6 rounded-[2.5rem] border border-gray-100">
                <label class="flex items-center gap-2 cursor-pointer bg-white px-6 py-3 rounded-2xl shadow-sm">
                    <input type="checkbox" id="selectAllOrders" class="w-5 h-5 accent-blue-600" onchange="var c=this.checked;document.querySelectorAll('.order-checkbox').forEach(function(b){b.checked=c;});">
                    <span class="text-xs font-black">ì „ì²´ ì„ íƒ</span>
                </label>
                <button type="button" id="btnBulkDelivery" class="bg-blue-600 text-white px-8 py-3 rounded-2xl font-black text-xs shadow-lg">ì¼ê´„ ë°°ì†¡ìš”ì²­</button>
                <button type="button" id="btnPrintInvoices" class="bg-gray-800 text-white px-8 py-3 rounded-2xl font-black text-xs shadow-lg">ì†¡ì¥ ì¶œë ¥</button>
                <a href="/admin/orders/excel?start_date={{start_date_str}}&end_date={{end_date_str}}&order_ids={{ filtered_orders | map(attribute='order_id') | join(',') }}" class="bg-teal-100 text-teal-700 px-8 py-3 rounded-2xl font-black text-xs ml-auto">Excel</a>
            </div>

            <div class="bg-white rounded-[2.5rem] shadow-xl border border-gray-50 overflow-x-auto mb-12">
                <table class="w-full text-[10px] font-black min-w-[1200px]">
                    <thead class="bg-gray-800 text-white">
                        <tr><th class="p-6 text-center">ì„ íƒ</th><th class="p-6">ì˜¤ë”ë„˜ë²„</th><th class="p-6">ì£¼ë¬¸ì¼ ìƒíƒœ</th><th class="p-6">ê³ ê°ì •ë³´</th><th class="p-6">ë°°ì†¡ì§€</th><th class="p-6">í’ˆëª©</th><th class="p-6 text-center">ì†¡ì¥</th></tr>
                    </thead>
                    <tbody>
                        {% for o in filtered_orders %}
                        <tr id="row-{{ o.order_id }}" class="border-b border-gray-100 hover:bg-teal-50/30 transition">
                            <td class="p-6 text-center">
                                {% if o.status == 'ê²°ì œì™„ë£Œ' %}
                                <input type="checkbox" class="order-checkbox w-5 h-5 accent-blue-600" value="{{ o.order_id }}">
                                {% endif %}
                            </td>
                            <td class="p-6 text-gray-700 font-mono text-[11px]">{{ o.order_id }}</td>
                            <td class="p-6">
                                <span class="text-gray-400 text-[11px]">{{ o.created_at.strftime('%m/%d %H:%M') }}</span><br>
                                <span id="status-{{ o.order_id }}" class="{% if o.status == 'ê²°ì œì·¨ì†Œ' %}text-red-500{% else %}text-teal-600{% endif %} font-black">[{{ o.status }}]</span><br>
                                <a href="/admin/order/{{ o.id }}/items" class="text-[10px] text-teal-600 hover:underline font-bold">í’ˆëª©ìƒíƒœ</a>
                            </td>
                            <td class="p-6"><b>{{ o.customer_name }}</b><br><span class="text-gray-400">{{ o.customer_phone }}</span></td>
                            <td class="p-6 text-gray-500 text-[11px]">{{ o.delivery_address }}</td>
                            <td class="p-6 text-gray-600 font-medium text-[11px]">{{ (o._manager_items | default([])) | join(', ') }}</td>
                            <td class="p-6 text-center">
                                <button type="button" class="invoice-modal-btn bg-gray-700 text-white px-3 py-2 rounded-xl text-[10px] font-black hover:bg-gray-800" data-order-id="{{ o.order_id }}">ì†¡ì¥</button>
                            </td>
                        </tr>
                        {% endfor %}
                        {% if not filtered_orders %}
                        <tr><td colspan="7" class="p-10 text-center text-gray-400 font-bold">ì¡°íšŒëœ ì˜¤ë”ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <div id="invoice-print-modal" class="fixed inset-0 z-[9998] hidden flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 max-h-[90vh] flex flex-col">
                    <div class="flex justify-between items-center mb-4 flex-shrink-0">
                        <h3 class="text-lg font-black text-gray-800" id="invoice-modal-title">ì†¡ì¥ ì¶œë ¥</h3>
                        <button type="button" id="invoice-modal-close" class="w-8 h-8 rounded-xl text-gray-400 hover:text-gray-600 hover:bg-gray-100 flex items-center justify-center text-xl">&times;</button>
                    </div>
                    <div id="invoice-step-choice" class="flex flex-col gap-3 flex-shrink-0">
                        <p class="text-xs text-gray-500 mb-1">ì¶œë ¥ ë°©ì‹ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                        <button type="button" id="invoice-print-single" class="w-full bg-teal-600 text-white py-3 rounded-xl font-black text-sm hover:bg-teal-700">ê°œë³„ (ì´ ì£¼ë¬¸ 1ê±´)</button>
                        <button type="button" id="invoice-print-all-show" class="w-full bg-gray-700 text-white py-3 rounded-xl font-black text-sm hover:bg-gray-800">ì „ì²´ ì„ íƒ (ì˜¤ë”ë„˜ë²„ ì„ íƒ)</button>
                    </div>
                    <div id="invoice-step-list" class="hidden flex flex-col flex-1 min-h-0">
                        <p class="text-xs text-gray-500 mb-2">ì¶œë ¥í•  ì˜¤ë”ë„˜ë²„ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
                        <label class="flex items-center gap-2 cursor-pointer mb-2 p-2 rounded-lg hover:bg-gray-50">
                            <input type="checkbox" id="invoice-select-all-orders" class="w-4 h-4 accent-teal-600">
                            <span class="text-sm font-black text-gray-700">ì „ì²´ ì„ íƒ</span>
                        </label>
                        <div id="invoice-order-list" class="border border-gray-200 rounded-xl p-3 overflow-y-auto flex-1 mb-4 space-y-1 max-h-48 text-[11px] font-mono"></div>
                        <div class="flex gap-2 flex-shrink-0">
                            <button type="button" id="invoice-back-from-list" class="flex-1 py-2.5 rounded-xl font-black text-sm bg-gray-100 text-gray-700 hover:bg-gray-200">ë’¤ë¡œ</button>
                            <button type="button" id="invoice-do-print-selected" class="flex-1 py-2.5 rounded-xl font-black text-sm bg-teal-600 text-white hover:bg-teal-700">ì†¡ì¥ ì¶œë ¥</button>
                        </div>
                    </div>
                </div>
            </div>

            <script>
            (function() {
                var invoiceModalOrderId = null;
                function getCheckedOrderIds() {
                    var list = [];
                    document.querySelectorAll('.order-checkbox:checked').forEach(function(cb) { list.push(cb.value); });
                    return list;
                }
                function getAllOrderIds() {
                    var list = [];
                    document.querySelectorAll('.order-checkbox').forEach(function(cb) { list.push(cb.value); });
                    return list;
                }
                function openInvoiceModal(orderId) {
                    invoiceModalOrderId = orderId;
                    showInvoiceStep('choice');
                    var modal = document.getElementById('invoice-print-modal');
                    if (modal) { modal.style.display = 'flex'; modal.classList.remove('hidden'); modal.classList.add('flex'); }
                }
                function closeInvoiceModal() {
                    var modal = document.getElementById('invoice-print-modal');
                    if (modal) { modal.style.display = 'none'; modal.classList.add('hidden'); }
                    invoiceModalOrderId = null;
                    showInvoiceStep('choice');
                }
                function showInvoiceStep(step) {
                    var choiceEl = document.getElementById('invoice-step-choice');
                    var listEl = document.getElementById('invoice-step-list');
                    if (step === 'list') {
                        if (choiceEl) choiceEl.classList.add('hidden');
                        if (listEl) { listEl.classList.remove('hidden'); listEl.classList.add('flex'); fillInvoiceOrderList(); }
                    } else {
                        if (choiceEl) choiceEl.classList.remove('hidden');
                        if (listEl) { listEl.classList.add('hidden'); listEl.classList.remove('flex'); }
                    }
                }
                function fillInvoiceOrderList() {
                    var container = document.getElementById('invoice-order-list');
                    var selectAllCb = document.getElementById('invoice-select-all-orders');
                    if (!container) return;
                    var rows = document.querySelectorAll('tr[id^="row-"]');
                    var orderIds = [];
                    rows.forEach(function(tr) {
                        var id = tr.id.replace('row-', '');
                        if (id) orderIds.push(id);
                    });
                    var checkedInTable = {};
                    document.querySelectorAll('.order-checkbox:checked').forEach(function(cb) { checkedInTable[cb.value] = true; });
                    container.innerHTML = '';
                    orderIds.forEach(function(oid) {
                        var label = document.createElement('label');
                        label.className = 'flex items-center gap-2 cursor-pointer p-1.5 rounded hover:bg-gray-50';
                        var cb = document.createElement('input');
                        cb.type = 'checkbox';
                        cb.className = 'invoice-order-cb w-4 h-4 accent-teal-600';
                        cb.value = oid;
                        cb.checked = !!checkedInTable[oid];
                        label.appendChild(cb);
                        label.appendChild(document.createTextNode(oid));
                        container.appendChild(label);
                    });
                    if (selectAllCb) {
                        selectAllCb.checked = orderIds.length > 0 && orderIds.every(function(id) { return checkedInTable[id]; });
                        selectAllCb.onchange = function() {
                            container.querySelectorAll('.invoice-order-cb').forEach(function(c) { c.checked = selectAllCb.checked; });
                        };
                    }
                }
                function getSelectedInvoiceOrderIds() {
                    var list = [];
                    document.querySelectorAll('#invoice-order-list .invoice-order-cb:checked').forEach(function(cb) { list.push(cb.value); });
                    return list;
                }
                function doPrint(ids) {
                    if (!ids || ids.length === 0) { alert("ì¶œë ¥í•  ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
                    window.open('/admin/order/print?ids=' + ids.join(','), '_blank', 'width=800,height=900');
                    closeInvoiceModal();
                }
                document.querySelectorAll('.invoice-modal-btn').forEach(function(btn) {
                    btn.addEventListener('click', function() { openInvoiceModal(this.getAttribute('data-order-id')); });
                });
                var closeBtn = document.getElementById('invoice-modal-close');
                if (closeBtn) closeBtn.addEventListener('click', closeInvoiceModal);
                var singleBtn = document.getElementById('invoice-print-single');
                if (singleBtn) singleBtn.addEventListener('click', function() {
                    if (invoiceModalOrderId) doPrint([invoiceModalOrderId]);
                    else alert("ì£¼ë¬¸ì„ ì§€ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                });
                var allShowBtn = document.getElementById('invoice-print-all-show');
                if (allShowBtn) allShowBtn.addEventListener('click', function() { showInvoiceStep('list'); });
                var backBtn = document.getElementById('invoice-back-from-list');
                if (backBtn) backBtn.addEventListener('click', function() { showInvoiceStep('choice'); });
                var doPrintBtn = document.getElementById('invoice-do-print-selected');
                if (doPrintBtn) doPrintBtn.addEventListener('click', function() {
                    var ids = getSelectedInvoiceOrderIds();
                    if (ids.length === 0) { alert("ì¶œë ¥í•  ì˜¤ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”."); return; }
                    doPrint(ids);
                });
                document.getElementById('invoice-print-modal').addEventListener('click', function(e) {
                    if (e.target === this) closeInvoiceModal();
                });

                window.printSelectedInvoices = function() {
                    var ids = getCheckedOrderIds();
                    if (ids.length === 0) { alert("ì¶œë ¥í•  ì£¼ë¬¸ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
                    window.open('/admin/order/print?ids=' + ids.join(','), '_blank', 'width=800,height=900');
                };
                window.requestBulkDelivery = function() {
                    var ids = getCheckedOrderIds();
                    if (ids.length === 0) { alert("ì„ íƒëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
                    if (!confirm(ids.length + "ê±´ì„ ì¼ê´„ ë°°ì†¡ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                    fetch('/admin/order/bulk_request_delivery', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ order_ids: ids }),
                        credentials: 'same-origin'
                    }).then(function(r) { return r.json(); }).then(function(data) {
                        if (data.success) {
                            alert("ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.");
                            ids.forEach(function(id) {
                                var el = document.getElementById('status-' + id);
                                if (el) el.innerText = '[ë°°ì†¡ìš”ì²­]';
                                var row = document.getElementById('row-' + id);
                                if (row) {
                                    var cb = row.querySelector('.order-checkbox');
                                    if (cb) cb.remove();
                                }
                            });
                        } else { alert(data.message || 'ì²˜ë¦¬ ì‹¤íŒ¨'); }
                    }).catch(function() { alert("í†µì‹  ì˜¤ë¥˜"); });
                };
                var sel = document.getElementById('selectAllOrders');
                if (sel) sel.addEventListener('change', function() {
                    var c = this.checked;
                    document.querySelectorAll('.order-checkbox').forEach(function(b) { b.checked = c; });
                });
                var btnPrint = document.getElementById('btnPrintInvoices');
                if (btnPrint) btnPrint.addEventListener('click', window.printSelectedInvoices);
                var btnBulk = document.getElementById('btnBulkDelivery');
                if (btnBulk) btnBulk.addEventListener('click', window.requestBulkDelivery);
            })();
            </script>

        {% elif tab == 'settlement' %}
            <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm mb-12">
                <div class="flex gap-2 mb-6">
                    <button type="button" onclick="setDateRange('today')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ì˜¤ëŠ˜</button>
                    <button type="button" onclick="setDateRange('7days')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ìµœê·¼ 7ì¼</button>
                    <button type="button" onclick="setDateRange('month')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ì´ë²ˆ ë‹¬</button>
                </div>
                <form action="/admin" method="GET" id="date-filter-form" class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                    <input type="hidden" name="tab" value="settlement">
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì‹œì‘ ì¼ì‹œ</label><input type="datetime-local" name="start_date" id="start_date" value="{{ start_date_str.replace(' ', 'T') }}" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs"></div>
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì¢…ë£Œ ì¼ì‹œ</label><input type="datetime-local" name="end_date" id="end_date" value="{{ end_date_str.replace(' ', 'T') }}" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs"></div>
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì¹´í…Œê³ ë¦¬ í•„í„°</label><select name="order_cat" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs bg-white"><option value="ì „ì²´">ëª¨ë“  í’ˆëª© í•©ì‚°</option>{% for c in selectable_categories %}<option value="{{c.name}}" {% if sel_order_cat == c.name %}selected{% endif %}>{{c.name}}</option>{% endfor %}</select></div>
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì…ê¸ˆìƒíƒœ</label><select name="settlement_status" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs bg-white"><option value="ì „ì²´" {% if sel_settlement_status == 'ì „ì²´' %}selected{% endif %}>ì „ì²´</option><option value="ì…ê¸ˆëŒ€ê¸°" {% if sel_settlement_status == 'ì…ê¸ˆëŒ€ê¸°' %}selected{% endif %}>ì…ê¸ˆëŒ€ê¸°</option><option value="ì…ê¸ˆì™„ë£Œ" {% if sel_settlement_status == 'ì…ê¸ˆì™„ë£Œ' %}selected{% endif %}>ì…ê¸ˆì™„ë£Œ</option><option value="ì·¨ì†Œ" {% if sel_settlement_status == 'ì·¨ì†Œ' %}selected{% endif %}>ì·¨ì†Œ</option><option value="ë³´ë¥˜" {% if sel_settlement_status == 'ë³´ë¥˜' %}selected{% endif %}>ë³´ë¥˜</option></select></div>
                    <button type="submit" class="bg-teal-600 text-white py-4 rounded-2xl font-black shadow-lg">ì¡°íšŒí•˜ê¸°</button>
                </form>
                <p class="mt-3 text-[11px] text-gray-600 font-bold">ì—‘ì…€: <a href="/admin/orders/settlement_detail_excel?start_date={{ start_date_str.replace(' ', '%20') }}&end_date={{ end_date_str.replace(' ', '%20') }}&order_cat={{ sel_order_cat | urlencode }}&settlement_status={{ sel_settlement_status | urlencode }}" class="text-teal-600 hover:underline">ì •ì‚° ìƒì„¸ (në„˜ë²„)</a> Â· <a href="/admin/settlement/category_excel?start_date={{ start_date_str.replace(' ', '%20') }}&end_date={{ end_date_str.replace(' ', '%20') }}&category={{ sel_order_cat | urlencode }}" class="text-teal-600 hover:underline">ì¹´í…Œê³ ë¦¬ë³„ íŒë§¤ í’ˆëª© (í’ˆëª©Â·ê·œê²©Â·ìˆ˜ëŸ‰)</a></p>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-12">
                <div>
                    <h3 class="text-lg font-black text-gray-800 mb-4 italic">ğŸ“Š ì •ì‚° ìƒì„¸ (në„˜ë²„ ê¸°ì¤€)</h3>
                    <p class="text-[11px] text-gray-500 font-bold mb-4">ê³ ê° ê²°ì œ ì‹œ í’ˆëª©ë³„ ê³ ìœ  në„˜ë²„ê°€ ë¶€ì—¬ë˜ë©°, í•´ë‹¹ ë²ˆí˜¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì •ì‚°í•©ë‹ˆë‹¤.</p>
                    <div class="flex items-center gap-4 mb-4 flex-wrap">
                        <span class="text-[11px] font-bold text-gray-600">ì„ íƒ í•­ëª© ì…ê¸ˆìƒíƒœ ë³€ê²½:</span>
                        <select id="settlement-bulk-status" class="border border-gray-200 rounded-xl px-3 py-2 text-xs font-black bg-white">
                            <option value="ì…ê¸ˆëŒ€ê¸°">ì…ê¸ˆëŒ€ê¸°</option>
                            <option value="ì…ê¸ˆì™„ë£Œ">ì…ê¸ˆì™„ë£Œ</option>
                            <option value="ì·¨ì†Œ">ì·¨ì†Œ</option>
                            <option value="ë³´ë¥˜">ë³´ë¥˜</option>
                        </select>
                        <button type="button" id="settlement-bulk-status-btn" class="bg-teal-600 text-white px-5 py-2 rounded-xl text-xs font-black shadow">ì ìš©</button>
                    </div>
                    <div id="settlement-detail-table-wrap" class="bg-white rounded-[2rem] border border-gray-100 shadow-sm overflow-x-auto overflow-y-auto max-h-[32rem]">
                        <table class="w-full text-left min-w-[900px] text-[10px] font-black">
                            <thead class="bg-gray-800 text-white">
                                <tr>
                                    <th class="p-3 w-12"><input type="checkbox" id="selectAllSettlement" title="ì „ì²´ì„ íƒ" class="rounded"></th>
                                    <th class="p-3">ì •ì‚°ë²ˆí˜¸(n)</th>
                                    <th class="p-3">íŒë§¤ì¼ì‹œ</th>
                                    <th class="p-3">ì¹´í…Œê³ ë¦¬</th>
                                    <th class="p-3 text-center">ë©´ì„¸ì—¬ë¶€</th>
                                    <th class="p-3">í’ˆëª©</th>
                                    <th class="p-3 text-right">íŒë§¤ê¸ˆì•¡</th>
                                    <th class="p-3 text-right">ìˆ˜ìˆ˜ë£Œ</th>
                                    <th class="p-3 text-right">ë°°ì†¡ê´€ë¦¬ë¹„</th>
                                    <th class="p-3 text-right">ì •ì‚°í•©ê³„</th>
                                    <th class="p-3 text-center">ì…ê¸ˆìƒíƒœ(ì…ê¸ˆì¼)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for r in settlement_detail_rows %}
                                <tr class="border-b border-gray-50 hover:bg-teal-50/20">
                                    <td class="p-3"><input type="checkbox" class="settlement-row-checkbox rounded" value="{{ r.order_item_id }}" data-order-item-id="{{ r.order_item_id }}"></td>
                                    <td class="p-3 font-mono text-gray-700">{{ r.settlement_no or '-' }}</td>
                                    <td class="p-3 text-gray-700">{{ r.sale_dt }}</td>
                                    <td class="p-3 text-gray-600">{{ r.category }}</td>
                                    <td class="p-3 text-center text-[9px]">{{ r.tax_exempt }}</td>
                                    <td class="p-3 text-gray-800">{{ r.product_name }}</td>
                                    <td class="p-3 text-right">{{ "{:,}".format(r.sales_amount) }}ì›</td>
                                    <td class="p-3 text-right">{{ "{:,}".format(r.fee) }}ì›</td>
                                    <td class="p-3 text-right">{{ "{:,}".format(r.delivery_fee) }}ì›</td>
                                    <td class="p-3 text-right font-black text-blue-600">{{ "{:,}".format(r.settlement_total) }}ì›</td>
                                    <td class="p-3 text-center align-top"><span class="{% if r.settlement_status == 'ì…ê¸ˆì™„ë£Œ' %}bg-green-100 text-green-700{% else %}bg-orange-100 text-orange-600{% endif %} px-2 py-1 rounded-full text-[9px]">{{ r.settlement_status }}</span>{% if r.settled_at %}<div class="text-[8px] text-gray-500 mt-1">{{ r.settled_at }}</div>{% endif %}</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="11" class="p-10 text-center text-gray-400 font-bold text-sm">í•´ë‹¹ ê¸°ê°„ ì •ì‚° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-6 p-6 bg-gray-50 rounded-2xl border border-gray-200">
                        <h4 class="text-sm font-black text-gray-700 mb-4">ğŸ“Œ ì¹´í…Œê³ ë¦¬ë³„ ì´í•©ê³„ê¸ˆì•¡</h4>
                        <ul class="space-y-2 text-[11px] font-black">
                            {% for cat_name, total_amt in settlement_category_totals.items() %}
                            <li class="flex justify-between"><span class="text-gray-600">{{ cat_name }}</span><span class="text-teal-600">{{ "{:,}".format(total_amt) }}ì›</span></li>
                            {% endfor %}
                            <li class="flex justify-between pt-3 border-t-2 border-gray-300 mt-3"><span class="text-gray-800">ì´í•©ê³„</span><span class="text-blue-600 font-black">{{ "{:,}".format(settlement_category_totals.values() | sum) }}ì›</span></li>
                        </ul>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-black text-gray-800 mb-6 italic">ğŸ“‹ ì˜¤ë”ë³„ ì •ì‚° í˜„í™©</h3>
                    <p class="text-[11px] text-gray-500 font-bold mb-4">ê´€ë¦¬ ì¤‘ì¸ ì¹´í…Œê³ ë¦¬ í’ˆëª©ë§Œ í‘œì‹œë©ë‹ˆë‹¤.</p>
                    <div class="bg-white rounded-[2rem] border border-gray-100 shadow-sm overflow-x-auto overflow-y-auto max-h-[32rem] text-left">
                        <table class="w-full text-left min-w-[800px]">
                            <thead class="bg-gray-50 border-b border-gray-100 text-[10px] text-gray-400 font-black">
                                <tr>
                                    <th class="p-5">ì˜¤ë”ë„˜ë²„</th>
                                    <th class="p-5">íŒë§¤ì¼</th>
                                    <th class="p-5">í’ˆëª©</th>
                                    <th class="p-5 text-center">ìˆ˜ëŸ‰</th>
                                    <th class="p-5 text-center">ë°°ì†¡í˜„í™©</th>
                                    <th class="p-5 text-right">ê°€ê²©(ì •ì‚°ëŒ€ìƒ)</th>
                                    <th class="p-5 text-right">í•©ê³„ê¸ˆì•¡</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for o in filtered_orders %}
                                <tr class="border-b border-gray-50 hover:bg-teal-50/20">
                                    <td class="p-5 font-mono text-[11px] text-gray-700">{{ o.order_id[-12:] if o.order_id else '-' }}</td>
                                    <td class="p-5 text-gray-700 font-bold">{{ o.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td class="p-5 text-gray-700 text-[11px] leading-relaxed">{{ (o._manager_items | default([])) | join(', ') }}</td>
                                    <td class="p-5 text-center font-black">{{ o._manager_qty | default(0) }}</td>
                                    <td class="p-5 text-center"><span class="{% if o.status == 'ê²°ì œì·¨ì†Œ' %}text-red-500{% else %}text-teal-600{% endif %} font-bold text-[11px]">{{ o.status }}</span></td>
                                    <td class="p-5 text-right font-black text-blue-600">{{ "{:,}".format(o._manager_subtotal | default(0)) }}ì›</td>
                                    <td class="p-5 text-right font-black text-gray-800">{{ "{:,}".format(o._manager_subtotal | default(0)) }}ì›</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="7" class="p-10 text-center text-gray-400 font-bold text-sm">í•´ë‹¹ ê¸°ê°„ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="bg-gray-100 border-t-2 border-gray-200">
                            <tr>
                                <td class="p-5 font-black text-gray-500 text-[11px]" colspan="3">ì´í•©ê³„</td>
                                <td class="p-5 text-center font-black text-gray-800">{{ order_total_qty }}</td>
                                <td class="p-5"></td>
                                <td class="p-5 text-right font-black text-blue-600">{{ "{:,}".format(order_total_subtotal) }}ì›</td>
                                <td class="p-5 text-right font-black text-gray-800">{{ "{:,}".format(order_total_subtotal) }}ì›</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                </div>
            </div>
            <script>
            function setDateRange(range) {
                const startInput = document.getElementById('start_date');
                const endInput = document.getElementById('end_date');
                if (!startInput || !endInput) return;
                const now = new Date();
                let start = new Date();
                let end = new Date();
                if (range === 'today') { start.setHours(0,0,0,0); end.setHours(23,59,59,999); }
                else if (range === '7days') { start.setDate(now.getDate()-7); start.setHours(0,0,0,0); }
                else if (range === 'month') { start.setDate(1); start.setHours(0,0,0,0); }
                const format = (d) => new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                startInput.value = format(start);
                endInput.value = format(end);
                document.getElementById('date-filter-form').submit();
            }
            document.getElementById('selectAllSettlement')?.addEventListener('change', function() {
                document.querySelectorAll('.settlement-row-checkbox').forEach(cb => cb.checked = this.checked);
            });
            document.getElementById('settlement-bulk-status-btn')?.addEventListener('click', async function() {
                const ids = Array.from(document.querySelectorAll('.settlement-row-checkbox:checked')).map(cb => cb.value).filter(Boolean);
                if (!ids.length) { alert('ì„ íƒí•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
                const status = document.getElementById('settlement-bulk-status')?.value;
                if (!status) return;
                try {
                    const r = await fetch('/admin/settlement/bulk_item_status', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ order_item_ids: ids, settlement_status: status }), credentials: 'same-origin' });
                    const j = await r.json();
                    if (j.success) { alert(j.message); document.getElementById('date-filter-form')?.submit(); } else { alert(j.message || 'ë³€ê²½ ì‹¤íŒ¨'); }
                } catch (e) { alert('ìš”ì²­ ì‹¤íŒ¨'); }
            });
            </script>

        {% elif tab == 'utm' %}
            <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm mb-8">
                <h2 class="text-xl font-black text-gray-800 mb-2">ğŸ¯ ê´‘ê³ ë³„ ìœ ì…Â·ì£¼ë¬¸ ì§‘ê³„</h2>
                <p class="text-[11px] text-gray-500 font-bold mb-6">ê´‘ê³  ë§í¬ì— UTMì„ ë¶™ì´ë©´ ì—¬ê¸°ì„œ ì§‘ê³„ë©ë‹ˆë‹¤. ê´‘ê³ ë¹„ë¥¼ ì…ë ¥í•˜ë©´ CPAÂ·ROASê°€ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.</p>
                <div class="overflow-x-auto">
                    <table class="w-full text-left min-w-[700px] text-[11px] font-bold">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="p-4">ìœ ì…ê²½ë¡œ (utm_source)</th>
                                <th class="p-4 text-center">íšŒì›ê°€ì…</th>
                                <th class="p-4 text-center">êµ¬ë§¤ì ìˆ˜</th>
                                <th class="p-4 text-center">ì£¼ë¬¸ ìˆ˜</th>
                                <th class="p-4 text-right">ë§¤ì¶œ</th>
                                <th class="p-4 text-right">ê´‘ê³ ë¹„ ì…ë ¥ (ì›)</th>
                                <th class="p-4 text-center">CPA</th>
                                <th class="p-4 text-center">ROAS</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for a in utm_aggregates %}
                            <tr class="border-b border-gray-100 hover:bg-teal-50/30">
                                <td class="p-4 font-black text-gray-800">{{ a.source }}</td>
                                <td class="p-4 text-center">{{ a.signup_count }}</td>
                                <td class="p-4 text-center">{{ a.buyer_count }}</td>
                                <td class="p-4 text-center">{{ a.order_count }}</td>
                                <td class="p-4 text-right font-black text-teal-600">{{ "{:,}".format(a.revenue) }}ì›</td>
                                <td class="p-4 text-right">
                                    <input type="number" min="0" step="1000" class="utm-ad-spend w-28 border border-gray-200 rounded-lg px-2 py-1.5 text-right text-xs" data-source="{{ a.source }}" placeholder="0">
                                </td>
                                <td class="p-4 text-center utm-cpa font-black text-gray-600">-</td>
                                <td class="p-4 text-center utm-roas font-black text-gray-600">-</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="8" class="p-8 text-center text-gray-400">ìœ ì…/ì£¼ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. UTM ë§í¬ë¡œ ìœ ì… í›„ íšŒì›ê°€ì…Â·ì£¼ë¬¸í•˜ë©´ ì§‘ê³„ë©ë‹ˆë‹¤.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="mt-6 p-4 bg-amber-50 rounded-2xl border border-amber-200 text-[11px] text-amber-800 font-bold">
                    <strong>ğŸ“Œ UTM ë§í¬ ì˜ˆì‹œ (ë³µë¶™ í›„ ì†ŒìŠ¤ë§Œ ìˆ˜ì •)</strong><br>
                    ì¹´ì¹´ì˜¤: <code class="bg-white px-1 rounded">?utm_source=kakao&utm_medium=local&utm_campaign=songdo</code><br>
                    ë‹¹ê·¼: <code class="bg-white px-1 rounded">?utm_source=daangn&utm_medium=local&utm_campaign=songdo</code><br>
                    ë„¤ì´ë²„: <code class="bg-white px-1 rounded">?utm_source=naver&utm_medium=search&utm_campaign=basam</code>
                </div>
                <p class="mt-4 text-[10px] text-gray-500">CPA = ê´‘ê³ ë¹„ Ã· êµ¬ë§¤ì ìˆ˜ Â· ROAS = ë§¤ì¶œ Ã· ê´‘ê³ ë¹„ Ã— 100 (ê´‘ê³ ë¹„ ì…ë ¥ ì‹œë§Œ í‘œì‹œ)</p>
            </div>
            <script>
            (function(){
                document.querySelectorAll('.utm-ad-spend').forEach(function(inp){
                    function update(){
                        var row = inp.closest('tr');
                        if (!row) return;
                        var buyer = parseInt(row.querySelector('td:nth-child(3)')?.textContent || '0', 10);
                        var revenue = parseInt((row.querySelector('td:nth-child(5)')?.textContent || '0').replace(/[^0-9]/g,''), 10) || 0;
                        var adSpend = parseInt(inp.value, 10) || 0;
                        var cpaEl = row.querySelector('.utm-cpa');
                        var roasEl = row.querySelector('.utm-roas');
                        if (!cpaEl || !roasEl) return;
                        if (adSpend <= 0) { cpaEl.textContent = '-'; roasEl.textContent = '-'; return; }
                        cpaEl.textContent = buyer > 0 ? (adSpend / buyer).toLocaleString() + 'ì›' : '-';
                        roasEl.textContent = (revenue / adSpend * 100).toFixed(0) + '%';
                    }
                    inp.addEventListener('input', update);
                    inp.addEventListener('change', update);
                });
            })();
            </script>

        {% elif tab == 'reviews' %}
            <div class="bg-white rounded-[2.5rem] border border-gray-50 shadow-sm overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 border-b border-gray-100 text-[10px]">
                        <tr><th class="p-6">íŒë§¤ì(ì¹´í…Œê³ ë¦¬)</th><th class="p-6">ìƒí’ˆ/ì‘ì„±ì</th><th class="p-6">ë‚´ìš©</th><th class="p-6 text-center">ê´€ë¦¬</th></tr>
                    </thead>
                    <tbody>
                        {% for r in reviews %}
                        <tr class="border-b border-gray-100 hover:bg-red-50/30">
                            <td class="p-6 text-gray-500 font-bold">{{ category_names.get(r.category_id, '-') }}</td>
                            <td class="p-6"><span class="text-teal-600">[{{ r.product_name }}]</span><br><b>{{ r.user_name }}</b></td>
                            <td class="p-6 text-gray-600 leading-relaxed">{{ r.content }}</td>
                            <td class="p-6 text-center"><a href="/admin/review/delete/{{ r.id }}" class="text-red-500 underline" onclick="return confirm('ì‚­ì œ?')">ì‚­ì œ</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}
    </div>

    <script>
    function setDateRange(range) {
        const startInput = document.getElementById('start_date');
        const endInput = document.getElementById('end_date');
        const now = new Date();
        let start = new Date();
        let end = new Date();
        if (range === 'today') { start.setHours(0,0,0,0); end.setHours(23,59,59,999); }
        else if (range === '7days') { start.setDate(now.getDate()-7); start.setHours(0,0,0,0); }
        else if (range === 'month') { start.setDate(1); start.setHours(0,0,0,0); }
        const format = (d) => new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
        var startStr = format(start);
        var endStr = format(end);
        if(startInput) startInput.value = startStr;
        if(endInput) endInput.value = endStr;
        var start2 = document.getElementById('start_date_2');
        var end2 = document.getElementById('end_date_2');
        if(start2) start2.value = startStr;
        if(end2) end2.value = endStr;
        var form = document.getElementById('date-filter-form') || document.getElementById('date-filter-form-2');
        if(form) form.submit();
    }

    (function() {
        window.printSelectedInvoices = function() {
            var boxes = document.querySelectorAll ? document.querySelectorAll('.order-checkbox:checked') : [];
            var selected = [];
            for (var i = 0; i < boxes.length; i++) selected.push(boxes[i].value);
            if (selected.length === 0) { alert("ì¶œë ¥í•  ì£¼ë¬¸ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
            window.open('/admin/order/print?ids=' + selected.join(','), '_blank', 'width=800,height=900');
        };
        window.requestBulkDelivery = function() {
            var boxes = document.querySelectorAll ? document.querySelectorAll('.order-checkbox:checked') : [];
            var selected = [];
            for (var i = 0; i < boxes.length; i++) selected.push(boxes[i].value);
            if (selected.length === 0) { alert("ì„ íƒëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
            if (!confirm(selected.length + "ê±´ì„ ì¼ê´„ ë°°ì†¡ ìš”ì²­í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            sendDeliveryRequest(selected);
        };
    })();
    function sendDeliveryRequest(ids) {
        fetch('/admin/order/bulk_request_delivery', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ order_ids: ids }),
            credentials: 'same-origin'
        }).then(function(res){ return res.json(); }).then(function(data) {
            if (data.success) {
                alert(data.message);
                ids.forEach(function(id) {
                    var statusSpan = document.getElementById('status-' + id);
                    if (statusSpan) statusSpan.innerText = '[ë°°ì†¡ìš”ì²­]';
                    var row = document.getElementById('row-' + id);
                    if (row) {
                        var cb = row.querySelector('.order-checkbox');
                        if (cb) cb.remove();
                    }
                });
            } else { alert(data.message || 'ì²˜ë¦¬ ì‹¤íŒ¨'); }
        }).catch(function() { alert("í†µì‹  ì˜¤ë¥˜"); });
    }

    function bindOrderCheckboxes() {
        var selectAll = document.getElementById('selectAllOrders');
        if (selectAll) {
            selectAll.addEventListener('change', function() {
                document.querySelectorAll('.order-checkbox').forEach(function(cb) { cb.checked = selectAll.checked; });
            });
        }
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', bindOrderCheckboxes);
    } else {
        bindOrderCheckboxes();
    }

    async function approveSettlement(catName, amt, email) {
        if(!confirm(catName + "ì˜ " + amt.toLocaleString() + "ì› ì •ì‚°ì„ ì…ê¸ˆ ì™„ë£Œì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        try {
            const res = await fetch('/admin/settlement/complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ category_name: catName, amount: amt, manager_email: email })
            });
            const result = await res.json();
            if(result.success) { alert(result.message); location.reload(); }
        } catch(e) { alert("ì„œë²„ ì˜¤ë¥˜"); }
    }
    function downloadSalesTableImage() {
        var el = document.getElementById('sales-detail-table-wrap');
        if (!el) { alert('í…Œì´ë¸”ì´ ì—†ê±°ë‚˜ ì£¼ë¬¸ ë° ë§¤ì¶œ ì§‘ê³„ íƒ­ì—ì„œ ì¡°íšŒ í›„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.'); return; }
        if (typeof html2canvas === 'undefined') {
            alert('ì´ë¯¸ì§€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì¤‘... ì ì‹œ í›„ ë‹¤ì‹œ í´ë¦­í•´ ì£¼ì„¸ìš”.');
            var s = document.createElement('script');
            s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
            s.onload = function() { runDownload(el); };
            document.head.appendChild(s);
            return;
        }
        runDownload(el);
    }
    function runDownload(el) {
        html2canvas(el, { scale: 2, useCORS: true }).then(function(canvas) {
            var a = document.createElement('a');
            a.href = canvas.toDataURL('image/png');
            a.download = 'ë§¤ì¶œìƒì„¸_' + new Date().toISOString().slice(0,10) + '.png';
            a.click();
        }).catch(function() { alert('ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); });
    }
    function downloadSalesSummaryTableImage() {
        var el = document.getElementById('sales-summary-table-wrap');
        if (!el) { alert('í…Œì´ë¸”ì´ ì—†ê±°ë‚˜ ì£¼ë¬¸ ë° ë§¤ì¶œ ì§‘ê³„ íƒ­ì—ì„œ ì¡°íšŒ í›„ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.'); return; }
        if (typeof html2canvas === 'undefined') {
            alert('ì´ë¯¸ì§€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì¤‘... ì ì‹œ í›„ ë‹¤ì‹œ í´ë¦­í•´ ì£¼ì„¸ìš”.');
            var s = document.createElement('script');
            s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
            s.onload = function() { runDownload(el); };
            document.head.appendChild(s);
            return;
        }
        runDownload(el);
    }
    (function() {
        function syncSelectAllFromRowCbs() {
            var cbs = document.querySelectorAll('.settlement-row-cb');
            var checked = document.querySelectorAll('.settlement-row-cb:checked');
            var allChecked = cbs.length > 0 && checked.length === cbs.length;
            document.querySelectorAll('.select-all-orders-settlement, .select-all-settlement-rows').forEach(function(el) { el.checked = allChecked; });
        }
        document.addEventListener('change', function(e) {
            if (!e.target || !e.target.classList) return;
            if (e.target.classList.contains('select-all-orders-settlement') || e.target.classList.contains('select-all-settlement-rows')) {
                var checked = e.target.checked;
                document.querySelectorAll('.settlement-row-cb').forEach(function(cb) { cb.checked = checked; });
            }
            if (e.target.classList.contains('settlement-row-cb')) {
                syncSelectAllFromRowCbs();
            }
        });
        document.addEventListener('click', function(e) {
            if (!e.target || !e.target.classList) return;
            if (e.target.classList.contains('btn-bulk-settlement-status')) {
                var checked = document.querySelectorAll('.settlement-row-cb:checked');
                var orderIdSet = {};
                checked.forEach(function(cb) {
                    var tr = cb.closest('tr');
                    if (tr) {
                        var orderId = tr.getAttribute('data-order-pk');
                        if (orderId) orderIdSet[orderId] = true;
                    }
                });
                var orderIds = Object.keys(orderIdSet).map(function(k) { return parseInt(k, 10); }).filter(function(id) { return !isNaN(id) && id > 0; });
                var sel = document.getElementById('bulkSettlementStatus') || document.querySelector('.bulk-settlement-status');
                var status = (sel && sel.value) ? sel.value : 'ì…ê¸ˆì™„ë£Œ';
                if (orderIds.length === 0) { alert('ë³€ê²½í•  í’ˆëª©(í–‰)ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }
                if (!confirm('ì„ íƒí•œ ' + orderIds.length + 'ê°œ ì£¼ë¬¸(ì˜¤ë”)ì„ ëª¨ë‘ "' + status + '"(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                var done = 0, fail = 0, failMsgs = [];
                function onEnd() {
                    if (done + fail === orderIds.length) {
                        var msg = 'ë³€ê²½ ì™„ë£Œ: ' + done + 'ê±´' + (fail ? ', ì‹¤íŒ¨: ' + fail + 'ê±´' : '');
                        if (fail && failMsgs.length) msg += '\n' + failMsgs.slice(0, 3).join('\n') + (failMsgs.length > 3 ? '\n...' : '');
                        alert(msg);
                        location.reload();
                    }
                }
                orderIds.forEach(function(orderId) {
                    fetch('/admin/settlement/order_status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'same-origin',
                        body: JSON.stringify({ order_id: orderId, settlement_status: status })
                    }).then(function(r) {
                        return r.json().then(function(data) {
                            return { ok: r.ok, status: r.status, data: data };
                        }).catch(function() { return { ok: false, status: r.status, data: { success: false, message: 'ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨' }; });
                    }).then(function(result) {
                        if (result.ok && result.data && result.data.success) { done++; } else { fail++; if (result.data && result.data.message) failMsgs.push(result.data.message); }
                        onEnd();
                    }).catch(function(err) { fail++; failMsgs.push('ìš”ì²­ ì‹¤íŒ¨'); onEnd(); });
                });
                return;
            }
            if (e.target.classList.contains('settlement-log-trigger')) {
                var trigger = e.target;
                var contentEl = trigger.parentElement.querySelector('.settlement-log-content');
                var modal = document.getElementById('settlement-log-modal');
                var bodyEl = document.getElementById('settlement-log-modal-body');
                if (contentEl && modal && bodyEl) {
                    bodyEl.innerHTML = contentEl.innerHTML;
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    modal.setAttribute('aria-hidden', 'false');
                }
                return;
            }
            if (e.target.id === 'settlement-log-modal-close' || e.target.id === 'settlement-log-modal') {
                var modal = document.getElementById('settlement-log-modal');
                if (modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    modal.setAttribute('aria-hidden', 'true');
                }
                return;
            }
        });
    })();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" async></script>
    """
    return render_template_string(HEADER_HTML + admin_html + FOOTER_HTML, **locals())
    
"""
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-left">
    <div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm">
        <p class="text-[9px] text-gray-400 font-black uppercase mb-1">Total Sales</p>
        <p class="text-xl font-black text-teal-600">{{ "{:,}".format(stats.sales) }}ì›</p>
    </div>
    <div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm">
        <p class="text-[9px] text-gray-400 font-black uppercase mb-1">Orders</p>
        <p class="text-xl font-black text-gray-800">{{ stats.count }}ê±´</p>
    </div>
    <div class="bg-white p-6 rounded-[2rem] border border-gray-100 shadow-sm">
        <p class="text-[9px] text-gray-400 font-black uppercase mb-1">Delivery Fees</p>
        <p class="text-xl font-black text-orange-500">{{ "{:,}".format(stats.delivery) }}ì›</p>
    </div>
    <div class="bg-gray-800 p-6 rounded-[2rem] shadow-xl">
        <p class="text-[9px] text-gray-400 font-black uppercase mb-1 text-white/50">Grand Total</p>
        <p class="text-xl font-black text-white">{{ "{:,}".format(stats.grand_total) }}ì›</p>
    </div>
</div>
    <div class="max-w-7xl mx-auto py-12 px-4 md:px-6 font-black text-xs md:text-sm text-left">
        <div class="flex justify-between items-center mb-10 text-left">
            <h2 class="text-2xl md:text-3xl font-black text-orange-700 italic text-left">Admin Panel</h2>
            <div class="flex gap-4 text-left"><a href="/logout" class="absolute top-6 right-6 z-[9999] text-[12px] md:text-[10px] bg-gray-100 px-6 py-3 md:px-5 md:py-2 rounded-full text-gray-500 font-black hover:bg-red-50 hover:text-red-500 transition-all shadow-md border border-gray-200 text-center">LOGOUT</a></div>
        </div>
        
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 p-4 mb-12 bg-white rounded-2xl border border-gray-100 shadow-sm text-left">
            {% if my_categories %}<a href="/seller/orders" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition bg-teal-50 border border-teal-200 text-teal-700 hover:bg-teal-100 hover:border-teal-300">ë‚´ ë°œì£¼ ëª©ë¡</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=email_order" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'seller_request' or tab == 'email_order' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">emailë°œì£¼</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=marketing_cost" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'marketing_cost' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë§ˆì¼€íŒ…ë¹„ ì‚¬ìš©ë‚´ì—­</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=messages" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'messages' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë©”ì‹œì§€ ë°œì†¡</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=delivery_zone" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'delivery_zone' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë°°ì†¡êµ¬ì—­ê´€ë¦¬</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=delivery_request" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'delivery_request' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë°°ì†¡ìš”ì²­</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=backup" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'backup' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë°±ì—…</a>{% endif %}
            <a href="/admin?tab=products" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'products' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ìƒí’ˆ ê´€ë¦¬</a>
            {% if is_master %}<a href="/admin?tab=popup" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'popup' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì•Œë¦¼íŒì—…</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=partnership" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'partnership' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì œíœ´ë¬¸ì˜</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=restaurant_request" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'restaurant_request' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì „êµ­ë§›ì§‘ìš”ì²­</a>{% endif %}
            <a href="/admin?tab=settlement" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'settlement' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì •ì‚°ê´€ë¦¬</a>
            <a href="/admin?tab=orders" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'orders' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì£¼ë¬¸ ë° ë°°ì†¡ ì§‘ê³„</a>
            {% if is_master %}<a href="/admin?tab=categories" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'categories' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ì¹´í…Œê³ ë¦¬/íŒë§¤ì ì„¤ì •</a>{% endif %}
            <a href="/admin?tab=stats" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'stats' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">í†µê³„</a>
            <a href="/admin?tab=reviews" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'reviews' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">ë¦¬ë·° ê´€ë¦¬</a>
            {% if is_master %}<a href="/admin?tab=sellers" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'sellers' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">íŒë§¤ì ê´€ë¦¬</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=point_manage" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'point_manage' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">í¬ì¸íŠ¸ ê´€ë¦¬</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=member_grade" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'member_grade' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">íšŒì› ë“±ê¸‰</a>{% endif %}
            {% if is_master %}<a href="/admin?tab=members" class="px-4 py-3 rounded-xl text-center font-black text-[11px] transition {% if tab == 'members' %}bg-orange-50 border-2 border-orange-500 text-orange-600{% else %}bg-gray-50 border border-gray-200 text-gray-600 hover:bg-gray-100 hover:border-orange-200{% endif %}">íšŒì›ê´€ë¦¬</a>{% endif %}
        </div>

        {% if tab == 'products' %}
            <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm mb-12">
    <form action="/admin" method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
        <input type="hidden" name="tab" value="orders">
        
        <div class="space-y-2">
            <label class="text-[10px] text-gray-400 font-black uppercase tracking-widest ml-2">ì‹œì‘ ì¼ì‹œ</label>
            <input type="datetime-local" name="start_date" value="{{ start_date_str.replace(' ', 'T') }}" 
                   class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs focus:ring-2 focus:ring-teal-500 transition">
        </div>

        <div class="space-y-2">
            <label class="text-[10px] text-gray-400 font-black uppercase tracking-widest ml-2">ì¢…ë£Œ ì¼ì‹œ</label>
            <input type="datetime-local" name="end_date" value="{{ end_date_str.replace(' ', 'T') }}" 
                   class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs focus:ring-2 focus:ring-teal-500 transition">
        </div>

        <div class="space-y-2">
            <label class="text-[10px] text-gray-400 font-black uppercase tracking-widest ml-2">ì¹´í…Œê³ ë¦¬</label>
            <select name="order_cat" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs bg-white focus:ring-2 focus:ring-teal-500 transition">
                <option value="ì „ì²´">ëª¨ë“  í’ˆëª© í•©ì‚°</option>
                {% for c in selectable_categories %}
                <option value="{{c.name}}" {% if sel_order_cat == c.name %}selected{% endif %}>{{c.name}}</option>
                {% endfor %}
            </select>
        </div>

        <button type="submit" class="bg-teal-600 text-white py-4 rounded-2xl font-black shadow-lg shadow-teal-100 hover:bg-teal-700 transition active:scale-95 text-xs">
            <i class="fas fa-search mr-2"></i> ê¸°ê°„ ì¡°íšŒí•˜ê¸°
        </button>
    </form>
</div>
                <div class="flex gap-3 text-left">
                    <button onclick="document.getElementById('excel_upload_form').classList.toggle('hidden')" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-black text-xs shadow-lg hover:bg-blue-700 transition">ğŸ“¦ ì—‘ì…€ ëŒ€ëŸ‰ ë“±ë¡</button>
                    <a href="/admin/add" class="bg-teal-600 text-white px-6 py-3 rounded-2xl font-black text-xs shadow-lg hover:bg-teal-700 transition">+ ê°œë³„ ìƒí’ˆ ë“±ë¡</a>
                </div>
            </div>
            
            <div class="bg-white rounded-[2rem] shadow-sm border border-gray-50 overflow-hidden text-left">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 border-b border-gray-100 text-gray-400 uppercase text-[10px] md:text-xs">
                        <tr><th class="p-6">ìƒí’ˆ ê¸°ë³¸ ì •ë³´</th><th class="p-6 text-center">ì¬ê³ </th><th class="p-6 text-center">ê´€ë¦¬</th></tr>
                    </thead>
                    <tbody class="text-left">
                        {% for p in products %}
                        <tr class="border-b border-gray-50 hover:bg-gray-50/50 transition">
                            <td class="p-6 text-left">
                                <b class="text-gray-800 text-sm md:text-base">{{ p.name }}</b> <span class="text-orange-500 text-[9px] md:text-[10px] font-black ml-2">{{ p.badge }}</span><br>
                                <span class="text-teal-600 font-bold text-[10px] md:text-xs">{{ p.description or 'ì„¤ëª… ì—†ìŒ' }}</span><br>
                                <span class="text-gray-400 text-[10px] md:text-xs">{{ "{:,}".format(p.price) }}ì› / {{ p.spec or 'ì¼ë°˜' }}</span>
                            </td>
                            <td class="p-6 text-center font-black text-gray-500">{{ p.stock }}ê°œ</td>
                            <td class="p-6 text-center space-x-3 text-[10px] md:text-xs text-center">
                                <a href="/admin/edit/{{p.id}}" class="text-blue-500 hover:underline">ìˆ˜ì •</a>
                                <a href="/admin/delete/{{p.id}}" class="text-red-300 hover:text-red-500 transition" onclick="return confirm('ì´ ìƒí’ˆì„ ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        {% elif tab == 'categories' %}
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 text-left">
                <div class="bg-white p-8 md:p-12 rounded-[2.5rem] md:rounded-[3.5rem] border border-gray-50 shadow-sm h-fit text-left">
                    <h3 class="text-[11px] md:text-sm text-gray-400 uppercase tracking-widest mb-10 font-black text-left">íŒë§¤ ì¹´í…Œê³ ë¦¬ ë° ì‚¬ì—…ì ì¶”ê°€</h3>
                    <form action="/admin/category/add" method="POST" class="space-y-5 text-left">
                        <input name="cat_name" placeholder="ì¹´í…Œê³ ë¦¬ëª… (ì˜ˆ: ì‚°ì§€ì§ì†¡ ë†ì‚°ë¬¼)" class="border border-gray-100 p-5 rounded-2xl w-full font-black text-sm text-left" required>
                        <textarea name="description" placeholder="ë°°ì†¡ê¸°í•œ ì •ë³´ ë“± ì„¤ëª…" class="border border-gray-100 p-5 rounded-2xl w-full h-24 font-black text-sm text-left"></textarea>
                        <input name="manager_email" placeholder="ê´€ë¦¬ ë§¤ë‹ˆì € ì´ë©”ì¼ (ID)" class="border border-gray-100 p-5 rounded-2xl w-full font-black text-sm text-left">
                        <select name="tax_type" class="border border-gray-100 p-5 rounded-2xl w-full font-black text-sm text-left bg-white"><option value="ê³¼ì„¸">ì¼ë°˜ ê³¼ì„¸ ìƒí’ˆ</option><option value="ë©´ì„¸">ë©´ì„¸ ë†ì¶•ì‚°ë¬¼</option></select>
                        <p class="text-[10px] text-amber-600 font-bold uppercase mt-2 text-left">ë…¸ì¶œ íšŒì›ë“±ê¸‰ (ëª‡ ë“±ê¸‰ ì´ìƒ)</p>
                        <select name="min_member_grade" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs text-left bg-white"><option value="">ì „ì²´ íšŒì›</option><option value="1">1ë‹¨ê³„ ì´ìƒ</option><option value="2">2ë‹¨ê³„ ì´ìƒ</option><option value="3">3ë‹¨ê³„ ì´ìƒ</option><option value="4">4ë‹¨ê³„ ì´ìƒ</option><option value="5">5ë‹¨ê³„ë§Œ</option></select>
                        <div class="border-t border-gray-100 pt-8 space-y-4 text-left">
                            <p class="text-[10px] text-teal-600 font-bold tracking-widest uppercase text-left">Seller Business Profile</p>
                            <input name="biz_name" placeholder="ì‚¬ì—…ì ìƒí˜¸ëª…" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm text-left">
                            <input name="biz_representative" placeholder="ëŒ€í‘œì ì„±í•¨" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm text-left">
                            <input name="biz_reg_number" placeholder="ì‚¬ì—…ì ë“±ë¡ë²ˆí˜¸ ( - í¬í•¨ )" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm text-left">
                            <input name="biz_address" placeholder="ì‚¬ì—…ì¥ ì†Œì¬ì§€" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm text-left">
                            <input name="biz_contact" placeholder="ê³ ê° ì„¼í„° ë²ˆí˜¸" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm text-left">
                            <input name="seller_link" placeholder="íŒë§¤ì ë¬¸ì˜ (ì¹´ì¹´ì˜¤/ì±„íŒ…) ë§í¬" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm text-left">
                            <p class="text-[10px] text-blue-600 font-bold tracking-widest uppercase pt-2 text-left">ì •ì‚° ê³„ì¢Œ</p>
                            <input name="bank_name" placeholder="ì€í–‰ëª…" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm text-left">
                            <input name="account_holder" placeholder="ì˜ˆê¸ˆì£¼" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm text-left">
                            <input name="settlement_account" placeholder="ì •ì‚°ê³„ì¢Œ (ê³„ì¢Œë²ˆí˜¸)" class="border border-gray-100 p-4 rounded-xl w-full font-bold text-xs md:text-sm text-left">
                        </div>
                        <button class="w-full bg-teal-600 text-white py-5 rounded-3xl font-black text-base md:text-lg shadow-xl hover:bg-teal-700 transition text-center">ì‹ ê·œ ì¹´í…Œê³ ë¦¬ ìƒì„±</button>
                    </form>
                </div>
                
                <div class="bg-white rounded-[2.5rem] md:rounded-[3.5rem] border border-gray-50 shadow-sm overflow-hidden text-left">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b border-gray-100 font-bold uppercase text-[10px] md:text-xs">
                            <tr><th class="p-6">ì „ì‹œ ìˆœì„œ</th><th class="p-6">ì¹´í…Œê³ ë¦¬ëª…</th><th class="p-6 text-center">ê´€ë¦¬</th></tr>
                        </thead>
                        <tbody class="text-left">
                            {% for c in categories %}
                            <tr class="border-b border-gray-50 text-left hover:bg-gray-50/50 transition">
                                <td class="p-6 flex gap-4 text-left">
                                    <a href="/admin/category/move/{{c.id}}/up" class="text-blue-500 p-2"><i class="fas fa-chevron-up"></i></a>
                                    <a href="/admin/category/move/{{c.id}}/down" class="text-red-500 p-2"><i class="fas fa-chevron-down"></i></a>
                                </td>
                                <td class="p-6 text-left"><b class="text-gray-800">{{ c.name }}</b><br><span class="text-gray-400 text-[10px]">ë§¤ë‹ˆì €: {{ c.manager_email or 'ë¯¸ì§€ì •' }}</span></td>
                                <td class="p-6 text-center space-x-3 text-[10px] text-center">
                                    <a href="/admin/category/edit/{{c.id}}" class="text-blue-500 hover:underline">ìˆ˜ì •</a>
                                    <a href="/admin/category/delete/{{c.id}}" class="text-red-200 hover:text-red-500 transition" onclick="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        {% elif tab == 'sellers' %}
            <div class="mb-12 text-left">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6 text-left">
                    <div>
                        <h3 class="text-lg font-black text-gray-800 italic">Seller Business Profile (íŒë§¤ì ì •ë³´)</h3>
                        <p class="text-[11px] text-gray-500 font-bold mt-1">ì—‘ì…€ í˜•ì‹ìœ¼ë¡œ ì •ë ¬ëœ íŒë§¤ìë³„ ì‚¬ì—…ìÂ·ì •ì‚° ì •ë³´</p>
                    </div>
                    <a href="/admin/sellers/excel" class="bg-teal-600 text-white px-5 py-2.5 rounded-xl font-black text-xs shadow hover:bg-teal-700">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</a>
                </div>
                <div class="flex gap-2 mb-4">
                    <a href="/admin?tab=sellers&seller_tax=ì „ì²´" class="px-4 py-2 rounded-xl text-[11px] font-black {% if seller_tax == 'ì „ì²´' %}bg-teal-600 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">ì „ì²´</a>
                    <a href="/admin?tab=sellers&seller_tax=ê³¼ì„¸" class="px-4 py-2 rounded-xl text-[11px] font-black {% if seller_tax == 'ê³¼ì„¸' %}bg-teal-600 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">ê³¼ì„¸</a>
                    <a href="/admin?tab=sellers&seller_tax=ë©´ì„¸" class="px-4 py-2 rounded-xl text-[11px] font-black {% if seller_tax == 'ë©´ì„¸' %}bg-teal-600 text-white{% else %}bg-gray-100 text-gray-600 hover:bg-gray-200{% endif %}">ë©´ì„¸</a>
                </div>
                <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-x-auto text-left">
                    <table class="w-full text-left min-w-[1000px] text-[11px] font-bold border-collapse">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="p-3 border border-gray-600 w-12 text-center">ìˆœì„œ</th>
                                <th class="p-3 border border-gray-600 w-16 text-center">ê³¼ì„¸/ë©´ì„¸</th>
                                <th class="p-3 border border-gray-600">ì¹´í…Œê³ ë¦¬</th>
                                <th class="p-3 border border-gray-600">ìƒí˜¸</th>
                                <th class="p-3 border border-gray-600">ëŒ€í‘œì</th>
                                <th class="p-3 border border-gray-600">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</th>
                                <th class="p-3 border border-gray-600">ì†Œì¬ì§€</th>
                                <th class="p-3 border border-gray-600">ê³ ê°ì„¼í„°</th>
                                <th class="p-3 border border-gray-600">ë¬¸ì˜ë§í¬</th>
                                <th class="p-3 border border-gray-600">ì€í–‰ëª…</th>
                                <th class="p-3 border border-gray-600">ì˜ˆê¸ˆì£¼</th>
                                <th class="p-3 border border-gray-600">ì •ì‚°ê³„ì¢Œ</th>
                                <th class="p-3 border border-gray-600">ë§¤ë‹ˆì €ì´ë©”ì¼</th>
                                <th class="p-3 border border-gray-600 w-20 text-center">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody class="text-left">
                            {% for c in sellers_categories %}
                            <tr class="border-b border-gray-100 hover:bg-gray-50/50 text-left">
                                <td class="p-3 border border-gray-100 text-center text-gray-500">{{ loop.index }}</td>
                                <td class="p-3 border border-gray-100 text-center"><span class="{% if (c.tax_type or 'ê³¼ì„¸') == 'ë©´ì„¸' %}text-amber-600{% else %}text-teal-600{% endif %} font-black text-[10px]">{{ c.tax_type or 'ê³¼ì„¸' }}</span></td>
                                <td class="p-3 border border-gray-100 font-black text-teal-700">{{ c.name }}</td>
                                <td class="p-3 border border-gray-100">{{ c.biz_name or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.biz_representative or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.biz_reg_number or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.biz_address or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.biz_contact or '-' }}</td>
                                <td class="p-3 border border-gray-100 text-teal-600 truncate max-w-[120px]" title="{{ c.seller_inquiry_link or '' }}">{% if c.seller_inquiry_link %}{{ c.seller_inquiry_link[:30] }}{% if c.seller_inquiry_link|length > 30 %}...{% endif %}{% else %}-{% endif %}</td>
                                <td class="p-3 border border-gray-100">{{ c.bank_name or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.account_holder or '-' }}</td>
                                <td class="p-3 border border-gray-100">{{ c.settlement_account or '-' }}</td>
                                <td class="p-3 border border-gray-100 text-gray-500">{{ c.manager_email or '-' }}</td>
                                <td class="p-3 border border-gray-100 text-center"><a href="/admin/category/edit/{{ c.id }}" class="text-blue-600 font-black hover:underline text-[10px]">ìˆ˜ì •</a></td>
                            </tr>
                            {% else %}
                            <tr><td colspan="14" class="p-8 text-center text-gray-400 font-bold">ë“±ë¡ëœ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬ ì„¤ì •ì—ì„œ ì¶”ê°€í•´ ì£¼ì„¸ìš”.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

        {% elif tab == 'settlement' %}
            <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm mb-12">
                <div class="flex gap-2 mb-6">
                    <button type="button" onclick="setDateRange('today')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ì˜¤ëŠ˜</button>
                    <button type="button" onclick="setDateRange('7days')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ìµœê·¼ 7ì¼</button>
                    <button type="button" onclick="setDateRange('month')" class="px-4 py-2 bg-gray-100 rounded-xl text-[10px] font-black hover:bg-teal-100 transition">ì´ë²ˆ ë‹¬</button>
                </div>
                <form action="/admin" method="GET" id="date-filter-form" class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                    <input type="hidden" name="tab" value="settlement">
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì‹œì‘ ì¼ì‹œ</label><input type="datetime-local" name="start_date" id="start_date" value="{{ start_date_str.replace(' ', 'T') }}" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs"></div>
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì¢…ë£Œ ì¼ì‹œ</label><input type="datetime-local" name="end_date" id="end_date" value="{{ end_date_str.replace(' ', 'T') }}" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs"></div>
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì¹´í…Œê³ ë¦¬ í•„í„°</label><select name="order_cat" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs bg-white"><option value="ì „ì²´">ëª¨ë“  í’ˆëª© í•©ì‚°</option>{% for c in selectable_categories %}<option value="{{c.name}}" {% if sel_order_cat == c.name %}selected{% endif %}>{{c.name}}</option>{% endfor %}</select></div>
                    <div><label class="text-[10px] text-gray-400 font-black ml-2">ì…ê¸ˆìƒíƒœ</label><select name="settlement_status" class="w-full border-none bg-gray-50 p-4 rounded-2xl font-black text-xs bg-white"><option value="ì „ì²´" {% if sel_settlement_status == 'ì „ì²´' %}selected{% endif %}>ì „ì²´</option><option value="ì…ê¸ˆëŒ€ê¸°" {% if sel_settlement_status == 'ì…ê¸ˆëŒ€ê¸°' %}selected{% endif %}>ì…ê¸ˆëŒ€ê¸°</option><option value="ì…ê¸ˆì™„ë£Œ" {% if sel_settlement_status == 'ì…ê¸ˆì™„ë£Œ' %}selected{% endif %}>ì…ê¸ˆì™„ë£Œ</option><option value="ì·¨ì†Œ" {% if sel_settlement_status == 'ì·¨ì†Œ' %}selected{% endif %}>ì·¨ì†Œ</option><option value="ë³´ë¥˜" {% if sel_settlement_status == 'ë³´ë¥˜' %}selected{% endif %}>ë³´ë¥˜</option></select></div>
                    <button type="submit" class="bg-teal-600 text-white py-4 rounded-2xl font-black shadow-lg">ì¡°íšŒí•˜ê¸°</button>
                </form>
                <p class="mt-3 text-[11px] text-gray-600 font-bold">ì—‘ì…€: <a href="/admin/orders/settlement_detail_excel?start_date={{ start_date_str.replace(' ', '%20') }}&end_date={{ end_date_str.replace(' ', '%20') }}&order_cat={{ sel_order_cat | urlencode }}&settlement_status={{ sel_settlement_status | urlencode }}" class="text-teal-600 hover:underline">ì •ì‚° ìƒì„¸ (në„˜ë²„)</a> Â· <a href="/admin/settlement/category_excel?start_date={{ start_date_str.replace(' ', '%20') }}&end_date={{ end_date_str.replace(' ', '%20') }}&category={{ sel_order_cat | urlencode }}" class="text-teal-600 hover:underline">ì¹´í…Œê³ ë¦¬ë³„ íŒë§¤ í’ˆëª© (í’ˆëª©Â·ê·œê²©Â·ìˆ˜ëŸ‰)</a></p>
            </div>
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 mb-4 italic">ğŸ“Š ì •ì‚° ìƒì„¸ (në„˜ë²„ ê¸°ì¤€)</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-4">ê³ ê° ê²°ì œ ì‹œ í’ˆëª©ë³„ ê³ ìœ  në„˜ë²„ê°€ ë¶€ì—¬ë˜ë©°, í•´ë‹¹ ë²ˆí˜¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì •ì‚°í•©ë‹ˆë‹¤.</p>
                <div class="flex items-center gap-4 mb-4 flex-wrap">
                    <span class="text-[11px] font-bold text-gray-600">ì„ íƒ í•­ëª© ì…ê¸ˆìƒíƒœ ë³€ê²½:</span>
                    <select id="settlement-bulk-status-2" class="border border-gray-200 rounded-xl px-3 py-2 text-xs font-black bg-white">
                        <option value="ì…ê¸ˆëŒ€ê¸°">ì…ê¸ˆëŒ€ê¸°</option>
                        <option value="ì…ê¸ˆì™„ë£Œ">ì…ê¸ˆì™„ë£Œ</option>
                        <option value="ì·¨ì†Œ">ì·¨ì†Œ</option>
                        <option value="ë³´ë¥˜">ë³´ë¥˜</option>
                    </select>
                    <button type="button" id="settlement-bulk-status-btn-2" class="bg-teal-600 text-white px-5 py-2 rounded-xl text-xs font-black shadow">ì ìš©</button>
                </div>
                <div id="settlement-detail-table-wrap-2" class="bg-white rounded-[2rem] border border-gray-100 shadow-sm overflow-x-auto">
                    <table class="w-full text-left min-w-[900px] text-[10px] font-black">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="p-3 w-12"><input type="checkbox" id="selectAllSettlement2" title="ì „ì²´ì„ íƒ" class="rounded"></th>
                                <th class="p-3">ì •ì‚°ë²ˆí˜¸(n)</th>
                                <th class="p-3">íŒë§¤ì¼ì‹œ</th>
                                <th class="p-3">ì¹´í…Œê³ ë¦¬</th>
                                <th class="p-3 text-center">ë©´ì„¸ì—¬ë¶€</th>
                                <th class="p-3">í’ˆëª©</th>
                                <th class="p-3 text-right">íŒë§¤ê¸ˆì•¡</th>
                                <th class="p-3 text-right">ìˆ˜ìˆ˜ë£Œ</th>
                                <th class="p-3 text-right">ë°°ì†¡ê´€ë¦¬ë¹„</th>
                                <th class="p-3 text-right">ì •ì‚°í•©ê³„</th>
                                <th class="p-3 text-center">ì…ê¸ˆìƒíƒœ(ì…ê¸ˆì¼)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in settlement_detail_rows %}
                            <tr class="border-b border-gray-50 hover:bg-teal-50/20">
                                <td class="p-3"><input type="checkbox" class="settlement-row-checkbox-2 rounded" value="{{ r.order_item_id }}" data-order-item-id="{{ r.order_item_id }}"></td>
                                <td class="p-3 font-mono text-gray-700">{{ r.settlement_no or '-' }}</td>
                                <td class="p-3 text-gray-700">{{ r.sale_dt }}</td>
                                <td class="p-3 text-gray-600">{{ r.category }}</td>
                                <td class="p-3 text-center text-[9px]">{{ r.tax_exempt }}</td>
                                <td class="p-3 text-gray-800">{{ r.product_name }}</td>
                                <td class="p-3 text-right">{{ "{:,}".format(r.sales_amount) }}ì›</td>
                                <td class="p-3 text-right">{{ "{:,}".format(r.fee) }}ì›</td>
                                <td class="p-3 text-right">{{ "{:,}".format(r.delivery_fee) }}ì›</td>
                                <td class="p-3 text-right font-black text-blue-600">{{ "{:,}".format(r.settlement_total) }}ì›</td>
                                <td class="p-3 text-center align-top"><span class="{% if r.settlement_status == 'ì…ê¸ˆì™„ë£Œ' %}bg-green-100 text-green-700{% else %}bg-orange-100 text-orange-600{% endif %} px-2 py-1 rounded-full text-[9px]">{{ r.settlement_status }}</span>{% if r.settled_at %}<div class="text-[8px] text-gray-500 mt-1">{{ r.settled_at }}</div>{% endif %}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="11" class="p-10 text-center text-gray-400 font-bold text-sm">í•´ë‹¹ ê¸°ê°„ ì •ì‚° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="mt-6 p-6 bg-gray-50 rounded-2xl border border-gray-200">
                    <h4 class="text-sm font-black text-gray-700 mb-4">ğŸ“Œ ì¹´í…Œê³ ë¦¬ë³„ ì´í•©ê³„ê¸ˆì•¡</h4>
                    <ul class="space-y-2 text-[11px] font-black">
                        {% for cat_name, total_amt in settlement_category_totals.items() %}
                        <li class="flex justify-between"><span class="text-gray-600">{{ cat_name }}</span><span class="text-teal-600">{{ "{:,}".format(total_amt) }}ì›</span></li>
                        {% endfor %}
                        <li class="flex justify-between pt-3 border-t-2 border-gray-300 mt-3"><span class="text-gray-800">ì´í•©ê³„</span><span class="text-blue-600 font-black">{{ "{:,}".format(settlement_category_totals.values() | sum) }}ì›</span></li>
                    </ul>
                </div>
            </div>
            <div class="mb-12">
                <h3 class="text-lg font-black text-gray-800 mb-6 italic">ğŸ“‹ ì˜¤ë”ë³„ ì •ì‚° í˜„í™©</h3>
                <p class="text-[11px] text-gray-500 font-bold mb-4">ê´€ë¦¬ ì¤‘ì¸ ì¹´í…Œê³ ë¦¬ í’ˆëª©ë§Œ í‘œì‹œë©ë‹ˆë‹¤.</p>
                <div class="bg-white rounded-[2rem] border border-gray-100 shadow-sm overflow-x-auto">
                    <table class="w-full text-left min-w-[800px]">
                        <thead class="bg-gray-50 border-b border-gray-100 text-[10px] text-gray-400 font-black">
                            <tr>
                                <th class="p-5">ì˜¤ë”ë„˜ë²„</th>
                                <th class="p-5">íŒë§¤ì¼</th>
                                <th class="p-5">í’ˆëª©</th>
                                <th class="p-5 text-center">ìˆ˜ëŸ‰</th>
                                <th class="p-5 text-center">ë°°ì†¡í˜„í™©</th>
                                <th class="p-5 text-right">ê°€ê²©(ì •ì‚°ëŒ€ìƒ)</th>
                                <th class="p-5 text-right">í•©ê³„ê¸ˆì•¡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for o in filtered_orders %}
                            <tr class="border-b border-gray-50 hover:bg-teal-50/20">
                                <td class="p-5 font-mono text-[11px] text-gray-700">{{ o.order_id[-12:] if o.order_id else '-' }}</td>
                                <td class="p-5 text-gray-700 font-bold">{{ o.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td class="p-5 text-gray-700 text-[11px] leading-relaxed">{{ (o._manager_items | default([])) | join(', ') }}</td>
                                <td class="p-5 text-center font-black">{{ o._manager_qty | default(0) }}</td>
                                <td class="p-5 text-center"><span class="{% if o.status == 'ê²°ì œì·¨ì†Œ' %}text-red-500{% else %}text-teal-600{% endif %} font-bold text-[11px]">{{ o.status }}</span></td>
                                <td class="p-5 text-right font-black text-blue-600">{{ "{:,}".format(o._manager_subtotal | default(0)) }}ì›</td>
                                <td class="p-5 text-right font-black text-gray-800">{{ "{:,}".format(o._manager_subtotal | default(0)) }}ì›</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="7" class="p-10 text-center text-gray-400 font-bold text-sm">í•´ë‹¹ ê¸°ê°„ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="bg-gray-100 border-t-2 border-gray-200">
                            <tr>
                                <td class="p-5 font-black text-gray-500 text-[11px]" colspan="3">ì´í•©ê³„</td>
                                <td class="p-5 text-center font-black text-gray-800">{{ order_total_qty }}</td>
                                <td class="p-5"></td>
                                <td class="p-5 text-right font-black text-blue-600">{{ "{:,}".format(order_total_subtotal) }}ì›</td>
                                <td class="p-5 text-right font-black text-gray-800">{{ "{:,}".format(order_total_subtotal) }}ì›</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <script>
            function setDateRange(range) {
                const startInput = document.getElementById('start_date');
                const endInput = document.getElementById('end_date');
                if (!startInput || !endInput) return;
                const now = new Date();
                let start = new Date();
                let end = new Date();
                if (range === 'today') { start.setHours(0,0,0,0); end.setHours(23,59,59,999); }
                else if (range === '7days') { start.setDate(now.getDate()-7); start.setHours(0,0,0,0); }
                else if (range === 'month') { start.setDate(1); start.setHours(0,0,0,0); }
                const format = (d) => new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                startInput.value = format(start);
                endInput.value = format(end);
                document.getElementById('date-filter-form').submit();
            }
            document.getElementById('selectAllSettlement2')?.addEventListener('change', function() {
                document.querySelectorAll('.settlement-row-checkbox-2').forEach(cb => cb.checked = this.checked);
            });
            document.getElementById('settlement-bulk-status-btn-2')?.addEventListener('click', async function() {
                const ids = Array.from(document.querySelectorAll('.settlement-row-checkbox-2:checked')).map(cb => cb.value).filter(Boolean);
                if (!ids.length) { alert('ì„ íƒí•œ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
                const status = document.getElementById('settlement-bulk-status-2')?.value;
                if (!status) return;
                try {
                    const r = await fetch('/admin/settlement/bulk_item_status', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ order_item_ids: ids, settlement_status: status }), credentials: 'same-origin' });
                    const j = await r.json();
                    if (j.success) { alert(j.message); document.getElementById('date-filter-form')?.submit(); } else { alert(j.message || 'ë³€ê²½ ì‹¤íŒ¨'); }
                } catch (e) { alert('ìš”ì²­ ì‹¤íŒ¨'); }
            });
            </script>

        {% elif tab == 'reviews' %}
            <div class="bg-white rounded-[2.5rem] shadow-xl border border-gray-50 overflow-hidden">
                <table class="w-full text-[10px] md:text-xs font-black text-left">
                    <thead class="bg-gray-800 text-white">
                        <tr><th class="p-6">íŒë§¤ì(ì¹´í…Œê³ ë¦¬)</th><th class="p-6">ìƒí’ˆ/ì‘ì„±ì</th><th class="p-6">ë‚´ìš©</th><th class="p-6 text-center">ê´€ë¦¬</th></tr>
                    </thead>
                    <tbody>
                        {% for r in reviews %}
                        <tr class="border-b border-gray-100 hover:bg-red-50/30">
                            <td class="p-6 text-gray-500 font-bold">{{ category_names.get(r.category_id, '-') }}</td>
                            <td class="p-6"><span class="text-teal-600">[{{ r.product_name }}]</span><br>{{ r.user_name }}</td>
                            <td class="p-6">{{ r.content }}</td>
                            <td class="p-6 text-center"><a href="/admin/review/delete/{{ r.id }}" class="bg-red-500 text-white px-4 py-2 rounded-full" onclick="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}
    </div>""" 

# --------------------------------------------------------------------------------
# 7. ì—‘ì…€ ëŒ€ëŸ‰ ì—…ë¡œë“œ (ì‚¬ìš©ì ì»¤ìŠ¤í…€ ì–‘ì‹ ëŒ€ì‘)
# --------------------------------------------------------------------------------
@login_required
def admin_product_bulk_upload_template():
    """ìƒí’ˆ ì—‘ì…€ ì—…ë¡œë“œìš© ì–‘ì‹ íŒŒì¼ ë‹¤ìš´ë¡œë“œ (í•„ìˆ˜ ì»¬ëŸ¼: ì¹´í…Œê³ ë¦¬, ìƒí’ˆëª…, ê·œê²©, ê°€ê²©, ì´ë¯¸ì§€íŒŒì¼ëª…)"""
    if not current_user.is_admin:
        return redirect('/')
    df = pd.DataFrame(columns=['ì¹´í…Œê³ ë¦¬', 'ìƒí’ˆëª…', 'ê·œê²©', 'ê°€ê²©', 'ì´ë¯¸ì§€íŒŒì¼ëª…'])
    df.loc[0] = ['(ì¹´í…Œê³ ë¦¬ëª…)', '(ìƒí’ˆëª…)', '(ì˜ˆ: 1ë°•ìŠ¤)', 0, '(íŒŒì¼ëª….jpg)']
    out = BytesIO()
    with pd.ExcelWriter(out, engine='openpyxl') as w:
        df.to_excel(w, index=False)
    out.seek(0)
    return send_file(out, download_name='ìƒí’ˆ_ì—‘ì…€_ì—…ë¡œë“œ_ì–‘ì‹.xlsx', as_attachment=True)


@app.route('/admin/product/bulk_upload', methods=['POST'])
@login_required
def admin_product_bulk_upload():
    """ì‚¬ìš©ì ì—‘ì…€ ì–‘ì‹(í•œê¸€ í—¤ë”) ê¸°ë°˜ ëŒ€ëŸ‰ ì—…ë¡œë“œ ë¡œì§"""
    if not current_user.is_admin: return redirect('/')
    file = request.files.get('excel_file')
    if not file: return redirect('/admin')
    try:
        df = pd.read_excel(file)
        # ì‚¬ìš©ì ìš”ì²­ í—¤ë”: ì¹´í…Œê³ ë¦¬, ìƒí’ˆëª…, ê·œê²©, ê°€ê²©, ì´ë¯¸ì§€íŒŒì¼ëª…
        required_cols = ['ì¹´í…Œê³ ë¦¬', 'ìƒí’ˆëª…', 'ê·œê²©', 'ê°€ê²©', 'ì´ë¯¸ì§€íŒŒì¼ëª…']
        if not all(col in df.columns for col in required_cols): 
            flash("ì—‘ì…€ í—¤ë” ë¶ˆì¼ì¹˜ (í•„ìš”: ì¹´í…Œê³ ë¦¬, ìƒí’ˆëª…, ê·œê²©, ê°€ê²©, ì´ë¯¸ì§€íŒŒì¼ëª…)"); return redirect('/admin')
        
        count = 0
        for _, row in df.iterrows():
            cat_name = str(row['ì¹´í…Œê³ ë¦¬']).strip()
            cat_exists = Category.query.filter_by(name=cat_name).first()
            if not cat_exists: continue
            
            # ì´ë¯¸ì§€ ê²½ë¡œ ë§¤í•‘ ë° ìƒì„¸ì‚¬ì§„ ìë™ ì„¤ì •
            raw_img_name = str(row['ì´ë¯¸ì§€íŒŒì¼ëª…']).strip()
            img_url = f"/static/uploads/{raw_img_name}" if raw_img_name != 'nan' else ""
            
            new_p = Product(
                category=cat_name, 
                name=str(row['ìƒí’ˆëª…']), 
                price=int(row['ê°€ê²©']), 
                spec=str(row['ê·œê²©']), 
                origin="êµ­ì‚°", 
                farmer="ë°”êµ¬ë‹ˆì‚¼ì´Œ", 
                stock=50, # ê¸°ë³¸ ì¬ê³  50ê°œ ì„¤ì •
                image_url=img_url, 
                detail_image_url=img_url, # ë©”ì¸ê³¼ ìƒì„¸ ë™ì¼í•˜ê²Œ ë³µì‚¬
                is_active=True, 
                tax_type=cat_exists.tax_type
            )
            db.session.add(new_p); count += 1
            
        db.session.commit()
        flash(f"{count}ê°œì˜ ìƒí’ˆì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."); return redirect('/admin')
    except Exception as e: 
        db.session.rollback()
        flash(f"ì—…ë¡œë“œ ì‹¤íŒ¨: {str(e)}"); return redirect('/admin')
        db.session.commit()
        flash(f"{count}ê°œì˜ ìƒí’ˆì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."); return redirect('/admin')
    except Exception as e: 
        db.session.rollback()
        flash(f"ì—…ë¡œë“œ ì‹¤íŒ¨: {str(e)}"); return redirect('/admin')

@app.route('/admin/board/restaurant-request/<int:rid>/comment', methods=['POST'])
@login_required
def admin_restaurant_request_comment(rid):
    """ê´€ë¦¬ì: ì „êµ­ë§›ì§‘ìš”ì²­ ê¸€ì— ëŒ“ê¸€(admin_notes) ì €ì¥. ìƒì„¸ í˜ì´ì§€ì— ë…¸ì¶œ."""
    if not current_user.is_admin:
        return redirect('/')
    r = RestaurantRequest.query.get_or_404(rid)
    r.admin_notes = (request.form.get('admin_notes') or '').strip() or None
    db.session.commit()
    flash("ê´€ë¦¬ì ëŒ“ê¸€ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
    return redirect('/admin?tab=restaurant_request')


@app.route('/admin/board/restaurant-request/<int:rid>/hide', methods=['POST'])
@login_required
def admin_restaurant_request_hide(rid):
    if not current_user.is_admin:
        return redirect('/')
    r = RestaurantRequest.query.get_or_404(rid)
    r.is_hidden = not r.is_hidden
    db.session.commit()
    flash("ìˆ¨ê¹€ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤." if r.is_hidden else "ë‹¤ì‹œ ë…¸ì¶œë©ë‹ˆë‹¤.")
    return redirect('/admin?tab=restaurant_request')


@login_required
def admin_delivery_request_comment(did):
    """ê´€ë¦¬ì: ë°°ì†¡ìš”ì²­ ê¸€ì— ëŒ“ê¸€(admin_notes) ì €ì¥. ìƒì„¸ í˜ì´ì§€ì— ë…¸ì¶œ."""
    if not current_user.is_admin:
        return redirect('/')
    r = DeliveryRequest.query.get_or_404(did)
    r.admin_notes = (request.form.get('admin_notes') or '').strip() or None
    db.session.commit()
    flash("ê´€ë¦¬ì ëŒ“ê¸€ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
    return redirect('/admin?tab=delivery_request')


@login_required
def admin_delivery_request_hide(did):
    if not current_user.is_admin:
        return redirect('/')
    r = DeliveryRequest.query.get_or_404(did)
    r.is_hidden = not r.is_hidden
    db.session.commit()
    flash("ìˆ¨ê¹€ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤." if r.is_hidden else "ë‹¤ì‹œ ë…¸ì¶œë©ë‹ˆë‹¤.")
    return redirect('/admin?tab=delivery_request')


@app.route('/admin/board/partnership/<int:pid>/comment', methods=['POST'])
@login_required
def admin_partnership_comment(pid):
    """ê´€ë¦¬ì: ì œíœ´ë¬¸ì˜ì— ëŒ“ê¸€(admin_notes) ì €ì¥. ê¸€ì“´ì´ê°€ ìƒì„¸ì—ì„œ í™•ì¸ ê°€ëŠ¥."""
    if not current_user.is_admin:
        return redirect('/')
    p = PartnershipInquiry.query.get_or_404(pid)
    p.admin_notes = (request.form.get('admin_notes') or '').strip() or None
    db.session.commit()
    flash("ê´€ë¦¬ì ëŒ“ê¸€ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
    return redirect('/admin?tab=partnership')


@login_required
def admin_partnership_hide(pid):
    if not current_user.is_admin:
        return redirect('/')
    p = PartnershipInquiry.query.get_or_404(pid)
    p.is_hidden = not p.is_hidden
    db.session.commit()
    flash("ìˆ¨ê¹€ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤." if p.is_hidden else "ë‹¤ì‹œ ë…¸ì¶œë©ë‹ˆë‹¤.")
    return redirect('/admin?tab=partnership')


@login_required
def admin_email_setup():
    """ì´ë©”ì¼ í‚¤(ë¹„ë°€ë²ˆí˜¸) ë°›ëŠ” ë°©ë²• ì•ˆë‚´. ê´€ë¦¬ì ì „ìš©."""
    if not current_user.is_admin:
        return redirect('/')
    configured = bool(MAIL_SERVER and MAIL_USERNAME and MAIL_PASSWORD)
    try:
        with open(os.path.join(os.path.dirname(__file__), "EMAIL_SETUP.md"), "r", encoding="utf-8") as f:
            guide = f.read()
    except Exception:
        guide = "EMAIL_SETUP.md íŒŒì¼ì„ ì°¸ê³ í•˜ì„¸ìš”. Gmail: ì•± ë¹„ë°€ë²ˆí˜¸, Naver: SMTP ì‚¬ìš© ì„¤ì • í›„ MAIL_* í™˜ê²½ë³€ìˆ˜ ì„¤ì •."
    return render_template_string(
        HEADER_HTML + """
        <div class="max-w-3xl mx-auto px-4 py-12">
            <a href="/admin?tab=email_order" class="text-gray-400 hover:text-teal-600 text-sm font-bold mb-6 inline-block">â† emailë°œì£¼</a>
            <h1 class="text-2xl font-black text-gray-800 mb-2">ì´ë©”ì¼ ë°œì†¡ ì„¤ì • ì•ˆë‚´</h1>
            <p class="text-sm text-gray-500 mb-4">íŒë§¤ì ë°œì£¼ ë©”ì¼ ë°œì†¡ì„ ìœ„í•´ SMTP ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ì•„ë˜ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ í™˜ê²½ ë³€ìˆ˜ì— ë„£ì–´ ì£¼ì„¸ìš”.</p>
            <div class="mb-6 p-4 rounded-2xl {{ 'bg-teal-50 border border-teal-200' if configured else 'bg-amber-50 border border-amber-200' }}">
                <p class="font-black {{ 'text-teal-800' if configured else 'text-amber-800' }}">í˜„ì¬ ìƒíƒœ: {{ 'ì„¤ì •ë¨ (MAIL_SERVER, MAIL_USERNAME, MAIL_PASSWORD)' if configured else 'ë¯¸ì„¤ì • â€” MAIL_SERVER, MAIL_USERNAME, MAIL_PASSWORD í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ì„¸ìš”.' }}</p>
            </div>
            <div class="bg-white rounded-2xl border border-gray-100 p-6 whitespace-pre-wrap text-sm font-medium text-gray-700">{{ guide }}</div>
        </div>
        """ + FOOTER_HTML,
        guide=guide,
        configured=configured
    )


def _get_email_order_lines(category_name, order_date):
    """í•´ë‹¹ ì¹´í…Œê³ ë¦¬Â·ì¼ìì˜ ë°œì£¼ í’ˆëª© ëª©ë¡ (ê²°ì œ í’ˆëª©ë„˜ë²„ë³„ 1ê±´). íŒë§¤ì‹œê°, í’ˆëª…, ìˆ˜ëŸ‰, ê¸ˆì•¡í•©ê³„, VAT, ë°œì£¼ìƒíƒœ."""
    start_dt = datetime.combine(order_date, datetime.min.time())
    end_dt = datetime.combine(order_date, datetime.max.time().replace(microsecond=0))
    items = db.session.query(OrderItem, Order, Settlement).join(
        Order, OrderItem.order_id == Order.id
    ).outerjoin(Settlement, Settlement.order_item_id == OrderItem.id).filter(
        Order.status != 'ê²°ì œì·¨ì†Œ',
        OrderItem.cancelled == False,
        OrderItem.product_category == category_name,
        Order.created_at >= start_dt,
        Order.created_at <= end_dt
    ).order_by(Order.created_at.asc(), OrderItem.id.asc()).all()
    status_map = {}
    for e in EmailOrderLineStatus.query.filter(
        EmailOrderLineStatus.order_item_id.in_([x[0].id for x in items])
    ).all():
        status_map[e.order_item_id] = e.status
    result = []
    for oi, ord, st in items:
        sale_dt = (st.sale_dt if st else ord.created_at) or ord.created_at
        settlement_no = (st.settlement_no if st else None) or ("N" + str(oi.id).zfill(10))
        total = oi.price * oi.quantity
        vat_label = (getattr(oi, 'tax_type', None) or 'ê³¼ì„¸') == 'ë©´ì„¸' and 'ë©´ì„¸' or 'ê³¼ì„¸'
        result.append({
            'order_item_id': oi.id,
            'sale_dt': sale_dt,
            'settlement_no': settlement_no,
            'product_name': oi.product_name,
            'quantity': oi.quantity,
            'amount_total': total,
            'vat_label': vat_label,
            'status': status_map.get(oi.id, 'ëŒ€ê¸°'),
        })
    return result


def _build_order_items_text(category_name, order_date):
    """í•´ë‹¹ ì¹´í…Œê³ ë¦¬Â·ì¼ìì˜ ë°œì£¼ í’ˆëª© í…ìŠ¤íŠ¸ (íŒë§¤ì‹œê°Â·í’ˆëª©Â·ê·œê²©Â·ìˆ˜ëŸ‰Â·ê¸ˆì•¡í•©ê³„Â·VAT)."""
    lines_data = _get_email_order_lines(category_name, order_date)
    if not lines_data:
        return "í•´ë‹¹ ì¼ì ë°œì£¼ í’ˆëª© ì—†ìŒ"
    oi_ids = [x['order_item_id'] for x in lines_data]
    order_items = OrderItem.query.filter(OrderItem.id.in_(oi_ids)).all()
    oi_map = {oi.id: oi for oi in order_items}
    products = Product.query.filter(Product.id.in_([oi.product_id for oi in order_items])).all()
    p_map = {p.id: (p.spec or "-") for p in products}
    lines = ["íŒë§¤ì‹œê°\tí’ˆëª©\tê·œê²©\tìˆ˜ëŸ‰\të‹¨ê°€\tê¸ˆì•¡í•©ê³„\tVAT"]
    for row in lines_data:
        oi = oi_map.get(row['order_item_id'])
        spec = p_map.get(oi.product_id, "-") if oi else "-"
        sale_str = row['sale_dt'].strftime('%Y-%m-%d %H:%M') if row.get('sale_dt') else '-'
        price_str = f"{oi.price:,}" if oi else "-"
        lines.append(f"{sale_str}\t{row['product_name']}\t{spec}\t{row['quantity']}\t{price_str}\t{row['amount_total']:,}\t{row['vat_label']}")
    return "\n".join(lines)


@app.route('/admin/seller/order_preview', methods=['GET'])
@login_required
def admin_seller_order_preview():
    """ë°œì£¼ ì–‘ì‹ ë¯¸ë¦¬ë³´ê¸° (ì´ë©”ì¼ ë¯¸ë°œì†¡). category_id, order_date, to_email(ì„ íƒ) ë°›ì•„ subject/body ë°˜í™˜."""
    if not current_user.is_admin:
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    category_id = request.args.get("category_id", type=int)
    order_date_str = (request.args.get("order_date") or "").strip() or datetime.now().strftime("%Y-%m-%d")
    try:
        order_date = datetime.strptime(order_date_str, "%Y-%m-%d").date()
    except Exception:
        order_date = datetime.now().date()
    cat = Category.query.get(category_id)
    if not cat:
        return jsonify({"success": False, "message": "ì¹´í…Œê³ ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 400
    items_text = _build_order_items_text(cat.name, order_date)
    base_url = (os.getenv("SITE_URL") or request.url_root or "").rstrip("/")
    body = f"""ì˜¤ëŠ˜ ë°œì£¼ í’ˆëª©ì…ë‹ˆë‹¤.

ë°œì£¼ ì¼ì: {order_date}

{items_text}

---
ã€ë°œì£¼ í™•ì¸ã€‘
ì•„ë˜ ë§í¬ë¥¼ í´ë¦­í•˜ì‹œë©´ ë°œì£¼ í™•ì¸ì´ ì™„ë£Œë˜ë©°, ê´€ë¦¬ìì—ê²Œ í™•ì¸ ë©”ì‹œì§€ê°€ ì „ì†¡ë©ë‹ˆë‹¤.
(ë°œì†¡ ì‹œ í™•ì¸ ë§í¬Â·ì½”ë“œê°€ ì±„ì›Œì§‘ë‹ˆë‹¤)

ë‚´ ë°œì£¼ ëª©ë¡(ë¡œê·¸ì¸ í›„ í™•ì¸): {base_url}/seller/orders
"""
    subject = f"[ë°”êµ¬ë‹ˆì‚¼ì´Œ] ë°œì£¼ í’ˆëª© ì•ˆë‚´ ({cat.name}) {order_date}"
    return jsonify({"success": True, "subject": subject, "body": body, "items_text": items_text})


@app.route('/admin/seller/send_manual_email', methods=['POST'])
@login_required
def admin_seller_send_manual_email():
    """ìˆ˜ê¸° ì´ë©”ì¼ ë°œì†¡ (ë™ì¼ ë°œì£¼ ì–‘ì‹ìœ¼ë¡œ ì§ì ‘ ì…ë ¥í•˜ì—¬ ë°œì†¡)."""
    if not current_user.is_admin:
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    data = request.get_json() or request.form
    to_email = (data.get("to_email") or "").strip()
    subject = (data.get("subject") or "").strip()
    body = (data.get("body") or "").strip()
    if not to_email or "@" not in to_email:
        return jsonify({"success": False, "message": "ìˆ˜ì‹  ì´ë©”ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."}), 400
    if not subject:
        return jsonify({"success": False, "message": "ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."}), 400
    try:
        send_mail(to_email, subject, body)
    except Exception as e:
        return jsonify({"success": False, "message": str(e) or "ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨."}), 500
    return jsonify({"success": True, "message": "ì´ë©”ì¼ì„ ë°œì†¡í–ˆìŠµë‹ˆë‹¤."})


@app.route('/admin/seller/send_order_email', methods=['POST'])
@login_required
def admin_seller_send_order_email():
    """íŒë§¤ì(ì¹´í…Œê³ ë¦¬)ì—ê²Œ ë°œì£¼ ì´ë©”ì¼ ë°œì†¡. í™•ì¸ì½”ë“œ ìƒì„±Â·ì €ì¥ í›„ ì´ë©”ì¼ ë³¸ë¬¸ì— í™•ì¸ ë§í¬/ì½”ë“œ í¬í•¨."""
    if not current_user.is_admin:
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    data = request.get_json() or request.form
    category_id = data.get("category_id", type=int)
    order_date_str = (data.get("order_date") or "").strip() or datetime.now().strftime("%Y-%m-%d")
    try:
        order_date = datetime.strptime(order_date_str, "%Y-%m-%d").date()
    except Exception:
        order_date = datetime.now().date()
    cat = Category.query.get(category_id)
    if not cat:
        return jsonify({"success": False, "message": "ì¹´í…Œê³ ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."}), 400
    to_email = (data.get("to_email") or "").strip() or (cat.manager_email or "").strip()
    if not to_email or "@" not in to_email:
        return jsonify({"success": False, "message": "ìˆ˜ì‹  ì´ë©”ì¼ì„ ì…ë ¥í•˜ê±°ë‚˜ ì¹´í…Œê³ ë¦¬ì— íŒë§¤ì ì´ë©”ì¼ì„ ë“±ë¡í•˜ì„¸ìš”."}), 400
    import random
    import string
    code = "".join(random.choices(string.digits, k=6))
    while SellerOrderConfirmation.query.filter_by(confirmation_code=code).first():
        code = "".join(random.choices(string.digits, k=6))
    conf = SellerOrderConfirmation(
        category_id=cat.id,
        category_name=cat.name,
        confirmation_code=code,
        order_date=order_date,
        recipient_email=to_email,
    )
    db.session.add(conf)
    db.session.flush()
    # ê²°ì œ í’ˆëª©ë„˜ë²„ë³„ ë°œì£¼ìƒíƒœ í–‰ ìƒì„±/ê°±ì‹  (ë°œì†¡ì™„ë£Œ)
    order_lines = _get_email_order_lines(cat.name, order_date)
    for row in order_lines:
        ex = EmailOrderLineStatus.query.filter_by(order_item_id=row['order_item_id']).first()
        if ex:
            ex.status = 'ë°œì†¡ì™„ë£Œ'
            ex.confirmation_id = conf.id
        else:
            db.session.add(EmailOrderLineStatus(order_item_id=row['order_item_id'], status='ë°œì†¡ì™„ë£Œ', confirmation_id=conf.id))
    db.session.commit()
    items_text = _build_order_items_text(cat.name, order_date)
    base_url = (os.getenv("SITE_URL") or request.url_root or "").rstrip("/")
    confirm_url = f"{base_url}/seller/confirm?code={code}"
    my_orders_url = f"{base_url}/seller/orders"
    body = f"""ì˜¤ëŠ˜ ë°œì£¼ í’ˆëª©ì…ë‹ˆë‹¤.

ë°œì£¼ ì¼ì: {order_date}

{items_text}

---
ã€ë°œì£¼ í™•ì¸ã€‘
ì•„ë˜ ë§í¬ë¥¼ í´ë¦­í•˜ì‹œë©´ ë°œì£¼ í™•ì¸ì´ ì™„ë£Œë˜ë©°, ê´€ë¦¬ìì—ê²Œ í™•ì¸ ë©”ì‹œì§€ê°€ ì „ì†¡ë©ë‹ˆë‹¤.
í™•ì¸ ë§í¬: {confirm_url}
í™•ì¸ì½”ë“œ(ë§í¬ ì ‘ì†ì´ ì–´ë ¤ìš¸ ë•Œ): {code}

ë‚´ ë°œì£¼ ëª©ë¡(ë¡œê·¸ì¸ í›„ í™•ì¸): {my_orders_url}
"""
    subject = f"[ë°”êµ¬ë‹ˆì‚¼ì´Œ] ë°œì£¼ í’ˆëª© ì•ˆë‚´ ({cat.name}) {order_date}"
    try:
        send_mail(to_email, subject, body)
    except Exception as e:
        db.session.rollback()
        return jsonify({"success": False, "message": str(e) or "ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨. ì´ë©”ì¼ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”."}), 500
    return jsonify({
        "success": True,
        "message": "ì´ë©”ì¼ì„ ë°œì†¡í–ˆìŠµë‹ˆë‹¤.",
        "confirmation_code": code,
        "confirm_url": confirm_url,
    })


@app.route('/seller/confirm')
def seller_confirm():
    """íŒë§¤ì ë°œì£¼ í™•ì¸. ?code=XXX ë¡œ ì ‘ì†í•˜ê±°ë‚˜ í¼ì—ì„œ í™•ì¸ì½”ë“œ ì…ë ¥ ì‹œ ë°œì£¼í™•ì¸ ì²˜ë¦¬. í™•ì¸ ì‹œ ê´€ë¦¬ìì—ê²Œ ë°œì£¼ í™•ì¸ ë©”ì‹œì§€(ì´ë©”ì¼) ì „ì†¡."""
    code = (request.args.get("code") or request.form.get("code") or "").strip()
    if code:
        conf = SellerOrderConfirmation.query.filter_by(confirmation_code=code).first()
        if conf:
            just_confirmed = False
            if not conf.confirmed_at:
                conf.confirmed_at = datetime.now()
                # í•´ë‹¹ ë°œì£¼ì— í¬í•¨ëœ í’ˆëª© ë°œì£¼ìƒíƒœ â†’ í™•ì¸ì™„ë£Œ
                for e in EmailOrderLineStatus.query.filter_by(confirmation_id=conf.id).all():
                    e.status = 'í™•ì¸ì™„ë£Œ'
                db.session.commit()
                just_confirmed = True
                # ë°œì£¼ í™•ì¸ ì‹œ ê´€ë¦¬ìì—ê²Œ ë°œì£¼ í™•ì¸ ë©”ì‹œì§€(ì´ë©”ì¼) ì „ì†¡
                try:
                    admin_user = User.query.filter_by(is_admin=True).first()
                    if admin_user and getattr(admin_user, "email", None):
                        admin_email = admin_user.email.strip()
                        if admin_email:
                            subject = f"[ë°”êµ¬ë‹ˆì‚¼ì´Œ] ë°œì£¼ í™•ì¸ë¨ - {conf.category_name} ({conf.order_date})"
                            body = f"""íŒë§¤ì({conf.category_name})ê°€ ë°œì£¼ í™•ì¸ì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.

ë°œì£¼ ì¼ì: {conf.order_date}
ì¹´í…Œê³ ë¦¬: {conf.category_name}
í™•ì¸ ì‹œê°: {conf.confirmed_at}
ìˆ˜ì‹  ì´ë©”ì¼: {conf.recipient_email or '-'}
"""
                            send_mail(admin_email, subject, body)
                except Exception:
                    pass
            return render_template_string(
                HEADER_HTML + """
                <div class="max-w-md mx-auto px-4 py-20 text-center">
                    <div class="bg-teal-50 border border-teal-200 rounded-2xl p-8">
                        <p class="text-4xl mb-4">âœ“</p>
                        <h1 class="text-xl font-black text-teal-800 mb-2">ë°œì£¼ í™•ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</h1>
                        <p class="text-sm text-gray-600 mb-2">{{ conf.category_name }} Â· {{ conf.order_date }}</p>
                        <p class="text-xs text-teal-600 font-bold">ë°œì£¼ í™•ì¸ ë©”ì‹œì§€ê°€ ê´€ë¦¬ìì—ê²Œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                        <a href="/seller/orders" class="inline-block mt-6 px-5 py-2.5 bg-teal-600 text-white rounded-xl text-sm font-black hover:bg-teal-700 transition">ë‚´ ë°œì£¼ ëª©ë¡</a>
                    </div>
                </div>
                """ + FOOTER_HTML,
                conf=conf
            )
    invalid = bool(code)
    return render_template_string(
        HEADER_HTML + """
        <div class="max-w-md mx-auto px-4 py-20">
            <h1 class="text-xl font-black text-gray-800 mb-4 text-center">ë°œì£¼ í™•ì¸</h1>
            <p class="text-sm text-gray-500 mb-6 text-center">ì´ë©”ì¼ë¡œ ë°›ì€ 6ìë¦¬ í™•ì¸ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            <form method="GET" action="/seller/confirm" class="flex gap-2">
                <input type="text" name="code" maxlength="6" placeholder="000000" value="{{ code }}" class="flex-1 px-4 py-3 rounded-xl border border-gray-200 text-center font-black text-lg tracking-widest" pattern="[0-9]{6}" title="6ìë¦¬ ìˆ«ì">
                <button type="submit" class="px-6 py-3 bg-teal-600 text-white rounded-xl font-black">í™•ì¸</button>
            </form>
            {% if invalid %}<p class="mt-4 text-sm text-red-600 text-center">ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë§Œë£Œëœ ì½”ë“œì…ë‹ˆë‹¤.</p>{% endif %}
            <p class="mt-6 text-center"><a href="/seller/orders" class="text-teal-600 text-sm font-bold hover:underline">ë‚´ ë°œì£¼ ëª©ë¡</a></p>
        </div>
        """ + FOOTER_HTML,
        code=code or "",
        invalid=invalid
    )


@app.route('/seller/orders')
@login_required
def seller_my_orders():
    """íŒë§¤ì(ì¹´í…Œê³ ë¦¬ ë§¤ë‹ˆì €) ì „ìš©: ë‚´ ë°œì£¼ ëª©ë¡. í™•ì¸ ëŒ€ê¸°/í™•ì¸ì™„ë£Œ í‘œì‹œ ë° í™•ì¸ ë§í¬ ì œê³µ."""
    my_cats = Category.query.filter_by(manager_email=current_user.email).all()
    if not my_cats:
        flash("íŒë§¤ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")
        return redirect("/")
    cat_ids = [c.id for c in my_cats]
    confirmations = SellerOrderConfirmation.query.filter(
        SellerOrderConfirmation.category_id.in_(cat_ids)
    ).order_by(SellerOrderConfirmation.created_at.desc()).limit(100).all()
    base_url = (os.getenv("SITE_URL") or request.url_root or "").rstrip("/")
    list_items = []
    for c in confirmations:
        list_items.append({
            "conf": c,
            "confirm_url": f"{base_url}/seller/confirm?code={c.confirmation_code}",
        })
    return render_template_string(
        HEADER_HTML + """
        <div class="max-w-2xl mx-auto px-4 py-12">
            <h1 class="text-xl md:text-2xl font-black text-gray-800 mb-2">ë‚´ ë°œì£¼ ëª©ë¡</h1>
            <p class="text-sm text-gray-500 mb-6">ë°œì£¼ ì´ë©”ì¼ë¡œ ë°›ì€ ê±´ì— ëŒ€í•´ í™•ì¸í•˜ê¸° ë§í¬ë¡œ ì ‘ì†í•˜ì‹œë©´ ë°œì£¼ í™•ì¸ì´ ì™„ë£Œë˜ë©°, ê´€ë¦¬ìì—ê²Œ í™•ì¸ ë©”ì‹œì§€ê°€ ì „ì†¡ë©ë‹ˆë‹¤.</p>
            <div class="space-y-3">
                {% for item in list_items %}
                <div class="bg-white rounded-2xl border border-gray-100 p-4 shadow-sm flex flex-wrap items-center justify-between gap-3">
                    <div>
                        <p class="font-black text-gray-800">{{ item.conf.category_name }} Â· {{ item.conf.order_date }}</p>
                        <p class="text-[10px] text-gray-500 mt-0.5">ë°œì†¡ì¼ {{ item.conf.created_at.strftime('%Y-%m-%d %H:%M') if item.conf.created_at else '-' }}{% if item.conf.recipient_email %} Â· {{ item.conf.recipient_email }}{% endif %}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        {% if item.conf.confirmed_at %}
                        <span class="px-3 py-1.5 rounded-xl bg-teal-100 text-teal-700 text-xs font-black">í™•ì¸ì™„ë£Œ</span>
                        <span class="text-[10px] text-gray-500">{{ item.conf.confirmed_at.strftime('%Y-%m-%d %H:%M') }}</span>
                        {% else %}
                        <a href="{{ item.confirm_url }}" class="px-4 py-2.5 bg-teal-600 text-white rounded-xl text-xs font-black hover:bg-teal-700 transition">í™•ì¸í•˜ê¸°</a>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="bg-gray-50 rounded-2xl p-12 text-center text-gray-500 text-sm">ë°œì£¼ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìê°€ ë°œì£¼ ì´ë©”ì¼ì„ ë³´ë‚´ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
                {% endfor %}
            </div>
            <p class="mt-6 text-center"><a href="/admin" class="text-teal-600 text-sm font-bold hover:underline">ê´€ë¦¬ì í™”ë©´ìœ¼ë¡œ</a></p>
        </div>
        """ + FOOTER_HTML,
        list_items=list_items
    )


@app.route('/admin/backup/run', methods=['POST'])
@login_required
def admin_backup_run():
    """ê´€ë¦¬ì: ìˆ˜ë™ ë°±ì—… ì‹¤í–‰ (SQLite â†’ zip â†’ GitHub Release ë˜ëŠ” ë¡œì»¬)."""
    if not current_user.is_admin:
        return jsonify({"success": False, "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."}), 403
    ok, msg = run_backup()
    if ok:
        return jsonify({"success": True, "message": msg})
    return jsonify({"success": False, "message": msg}), 500


@app.route('/admin/backup/cron')
def admin_backup_cron():
    """ì™¸ë¶€ cronì—ì„œ í˜¸ì¶œ (í•œêµ­ì‹œê°„ ìƒˆë²½ 4ì‹œ ë“±). ì¿¼ë¦¬ key=BACKUP_CRON_SECRET ê³¼ ì¼ì¹˜í•´ì•¼ í•¨."""
    key = (request.args.get("key") or "").strip()
    secret = os.getenv("BACKUP_CRON_SECRET", "").strip()
    if not secret or key != secret:
        return "Unauthorized", 401
    ok, msg = run_backup()
    return jsonify({"success": ok, "message": msg})


@app.route('/admin/review/delete/<int:rid>')
@login_required
def admin_review_delete(rid):
    if not (current_user.is_admin or Category.query.filter_by(manager_email=current_user.email).first()):
        return redirect('/')
    r = Review.query.get_or_404(rid)
    db.session.delete(r)
    db.session.commit()
    flash("ë¦¬ë·°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")
    return redirect('/admin?tab=reviews')

# --------------------------------------------------------------------------------
# 7-2. í…ŒìŠ¤íŠ¸ ì¹´í…Œê³ ë¦¬ 3ê°œ + ê°€ìƒ ìƒí’ˆ 10ê°œì”© ì‹œë“œ (ì „ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ìš©)
# --------------------------------------------------------------------------------
def _seed_test_categories_and_products():
    """í…ŒìŠ¤íŠ¸ ì¹´í…Œê³ ë¦¬ 3ê°œì™€ ì¹´í…Œê³ ë¦¬ë‹¹ ê°€ìƒ ìƒí’ˆ 10ê°œ ìƒì„±. ë“±ë¡ ê¸°ëŠ¥ ì „ í•„ë“œ í™œìš©."""
    now = datetime.now()
    today_evening = now.replace(hour=20, minute=0, second=0, microsecond=0)
    tomorrow = (now + timedelta(days=1)).replace(hour=18, minute=0, second=0, microsecond=0)
    categories_data = [
        {"name": "í…ŒìŠ¤íŠ¸-ì±„ì†Œ", "description": "í…ŒìŠ¤íŠ¸ìš© ì±„ì†Œ ì¹´í…Œê³ ë¦¬ (ìƒí’ˆ ë“±ë¡Â·ìˆ˜ì •Â·ë°°ì§€Â·ë§ˆê° í…ŒìŠ¤íŠ¸)", "order": 900},
        {"name": "í…ŒìŠ¤íŠ¸-ê³¼ì¼", "description": "í…ŒìŠ¤íŠ¸ìš© ê³¼ì¼ ì¹´í…Œê³ ë¦¬", "order": 901},
        {"name": "í…ŒìŠ¤íŠ¸-ìˆ˜ì‚°", "description": "í…ŒìŠ¤íŠ¸ìš© ìˆ˜ì‚° ì¹´í…Œê³ ë¦¬", "order": 902},
    ]
    for cdata in categories_data:
        if not Category.query.filter_by(name=cdata["name"]).first():
            db.session.add(Category(name=cdata["name"], description=cdata["description"], order=cdata["order"], tax_type="ê³¼ì„¸"))
    db.session.commit()

    products_data = []
    # í…ŒìŠ¤íŠ¸-ì±„ì†Œ 10ì¢…: description(ë‹¹ì¼/+1/+2), badge(ì˜¤ëŠ˜ë§ˆê°/ì‚¼ì´Œì¶”ì²œ/ì—†ìŒ), deadline(ì˜¤ëŠ˜/ë‚´ì¼/ì—†ìŒ), stock ë‹¤ì–‘
    veg_names = ["ì²­ê²½ì±„ 1ë‹¨", "ìƒì¶” 2ì¢… ëª¨ë‘ ", "ê¹»ì 1ë‹¨", "ì‹œê¸ˆì¹˜ 1ë‹¨", "ë¸Œë¡œì½œë¦¬ 1ì†¡ì´", "ë‹¹ê·¼ 1kg", "ì–‘íŒŒ 2kg", "ëŒ€íŒŒ 3ëŒ€", "ìª½íŒŒ 1ë‹¨", "ë¯¸ë‚˜ë¦¬ 1ë‹¨"]
    for i, name in enumerate(veg_names):
        products_data.append({
            "category": "í…ŒìŠ¤íŠ¸-ì±„ì†Œ", "name": name, "description": ["ë‹¹ì¼ë°°ì†¡", "+1ì¼", "+2ì¼", "+3ì¼"][i % 4],
            "price": [3500, 4500, 2800, 3200, 2200, 4000, 3500, 1500, 1800, 2500][i],
            "spec": ["1ë‹¨", "1íŒ©", "1ë‹¨", "1ë‹¨", "1ì†¡ì´", "1kg", "2kg", "3ëŒ€", "1ë‹¨", "1ë‹¨"][i],
            "origin": "êµ­ì‚°", "farmer": "ë°”êµ¬ë‹ˆì‚¼ì´Œ", "stock": [5, 10, 20, 15, 30, 50, 40, 99, 10, 8][i],
            "deadline": today_evening if i % 3 == 0 else (tomorrow if i % 3 == 1 else None),
            "badge": ["ì˜¤ëŠ˜ë§ˆê°", "ì‚¼ì´Œì¶”ì²œ", ""][i % 3], "image_url": f"https://placehold.co/400x400/dcfce7/166534?text=V{i+1}",
            "detail_image_url": f"https://placehold.co/600x400/bbf7d0/166534?text={name[:4]}",
        })
    # í…ŒìŠ¤íŠ¸-ê³¼ì¼ 10ì¢…
    fruit_names = ["ì‚¬ê³¼ 2kg", "ë°° 1.5kg", "í¬ë„ 1kg", "ê·¤ 2kg", "ìˆ˜ë°• 1í†µ", "ì°¸ì™¸ 2kg", "ë³µìˆ­ì•„ 1kg", "ë¸”ë£¨ë² ë¦¬ 125g", "ë”¸ê¸° 500g", "ë°”ë‚˜ë‚˜ 1kg"]
    for i, name in enumerate(fruit_names):
        products_data.append({
            "category": "í…ŒìŠ¤íŠ¸-ê³¼ì¼", "name": name, "description": ["+1ì¼", "+2ì¼", "ë‹¹ì¼ë°°ì†¡", "+3ì¼"][i % 4],
            "price": [12000, 15000, 8000, 9000, 18000, 14000, 11000, 6500, 12000, 4500][i],
            "spec": ["2kg", "1.5kg", "1kg", "2kg", "1í†µ", "2kg", "1kg", "125g", "500g", "1kg"][i],
            "origin": "êµ­ì‚°", "farmer": "ë°”êµ¬ë‹ˆì‚¼ì´Œ", "stock": [20, 15, 30, 40, 10, 25, 18, 50, 12, 60][i],
            "deadline": tomorrow if i % 2 == 0 else None, "badge": ["ì‚¼ì´Œì¶”ì²œ", "", "ì˜¤ëŠ˜ë§ˆê°"][i % 3],
            "image_url": f"https://placehold.co/400x400/fef3c7/d97706?text=F{i+1}",
            "detail_image_url": f"https://placehold.co/600x400/fde68a/d97706?text={name[:4]}",
        })
    # í…ŒìŠ¤íŠ¸-ìˆ˜ì‚° 10ì¢…
    fish_names = ["ê³ ë“±ì–´ 2ë§ˆë¦¬", "ê°ˆì¹˜ 1kg", "ë™íƒœ 1ë§ˆë¦¬", "ìƒˆìš° 300g", "ì˜¤ì§•ì–´ 1ë§ˆë¦¬", "ë¬¸ì–´ 1ë§ˆë¦¬", "ì—°ì–´ 200g", "ì°¸ì¹˜ìº” 3ìº”", "ë©¸ì¹˜ 100g", "ê¹€ 10ì¥"]
    for i, name in enumerate(fish_names):
        products_data.append({
            "category": "í…ŒìŠ¤íŠ¸-ìˆ˜ì‚°", "name": name, "description": ["+1ì¼", "+2ì¼", "+3ì¼", "ë‹¹ì¼ë°°ì†¡"][i % 4],
            "price": [8000, 12000, 6500, 15000, 9000, 18000, 7000, 4500, 3500, 4000][i],
            "spec": ["2ë§ˆë¦¬", "1kg", "1ë§ˆë¦¬", "300g", "1ë§ˆë¦¬", "1ë§ˆë¦¬", "200g", "3ìº”", "100g", "10ì¥"][i],
            "origin": "êµ­ì‚°/ìˆ˜ì…", "farmer": "ë°”êµ¬ë‹ˆì‚¼ì´Œ", "stock": [10, 8, 25, 15, 12, 5, 30, 50, 40, 20][i],
            "deadline": today_evening if i % 4 == 0 else (tomorrow if i % 4 == 1 else None),
            "badge": ["", "ì˜¤ëŠ˜ë§ˆê°", "ì‚¼ì´Œì¶”ì²œ", ""][i % 4],
            "image_url": f"https://placehold.co/400x400/dbeafe/1d4ed8?text=S{i+1}",
            "detail_image_url": f"https://placehold.co/600x400/bfdbfe/1d4ed8?text={name[:4]}",
        })

    # ë§ˆê°ì‹œê°„ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ìš© ê°€ìƒ ìƒí’ˆ: í˜„ì¬ì‹œê° + 15ë¶„ ë§ˆê° (í…ŒìŠ¤íŠ¸-ì±„ì†Œì— 1ì¢…)
    deadline_test_at = now + timedelta(minutes=15)
    if not Product.query.filter_by(category="í…ŒìŠ¤íŠ¸-ì±„ì†Œ", name="ë§ˆê°í…ŒìŠ¤íŠ¸-ê°€ìƒìƒí’ˆ").first():
        products_data.append({
            "category": "í…ŒìŠ¤íŠ¸-ì±„ì†Œ", "name": "ë§ˆê°í…ŒìŠ¤íŠ¸-ê°€ìƒìƒí’ˆ", "description": "ë‹¹ì¼ë°°ì†¡",
            "price": 1000, "spec": "1ê°œ", "origin": "ë§ˆê° ì¹´ìš´íŠ¸ë‹¤ìš´ í…ŒìŠ¤íŠ¸ìš©", "farmer": "ë°”êµ¬ë‹ˆì‚¼ì´Œ",
            "stock": 99, "deadline": deadline_test_at, "badge": "ì˜¤ëŠ˜ë§ˆê°",
            "image_url": "https://placehold.co/400x400/fecaca/dc2626?text=ë§ˆê°í…ŒìŠ¤íŠ¸",
            "detail_image_url": "https://placehold.co/600x400/fecaca/dc2626?text=ë§ˆê°í…ŒìŠ¤íŠ¸",
        })

    created = 0
    for pdata in products_data:
        exists = Product.query.filter_by(category=pdata["category"], name=pdata["name"]).first()
        if not exists:
            p = Product(
                category=pdata["category"], name=pdata["name"], description=pdata["description"],
                price=pdata["price"], spec=pdata["spec"], origin=pdata["origin"], farmer=pdata["farmer"],
                stock=pdata["stock"], deadline=pdata["deadline"], badge=pdata.get("badge", ""),
                image_url=pdata["image_url"], detail_image_url=pdata.get("detail_image_url", pdata["image_url"]),
                is_active=True, tax_type="ê³¼ì„¸"
            )
            db.session.add(p)
            created += 1
    db.session.commit()
    return created


def _seed_virtual_reviews_per_product(count_per_product=10):
    """ìƒí’ˆë³„ ê°€ìƒ êµ¬ë§¤ í›„ê¸° count_per_productê°œì”© ìƒì„±. order_idëŠ” ê°€ìƒ ê³ ìœ ê°’(ìŒìˆ˜) ì‚¬ìš©."""
    reviews_content = [
        "ë§›ìˆê³  ì‹ ì„ í•´ìš”. ë‹¤ìŒì—ë„ ì£¼ë¬¸í• ê²Œìš”!",
        "ë°°ì†¡ ë¹¨ë¼ì„œ ì¢‹ì•˜ì–´ìš”. í’ˆì§ˆë„ ë§Œì¡±í•©ë‹ˆë‹¤.",
        "ìƒê°ë³´ë‹¤ ì–‘ ë§ê³  ê°€ì„±ë¹„ ì¢‹ì•„ìš”.",
        "ì¹œêµ¬ ì¶”ì²œìœ¼ë¡œ ì²˜ìŒ ì£¼ë¬¸í–ˆëŠ”ë° ëŒ€ë§Œì¡±ì…ë‹ˆë‹¤.",
        "í¬ì¥ ê¼¼ê¼¼í•˜ê³  ìƒíƒœ ì¢‹ì•˜ì–´ìš”. ì¶”ì²œí•©ë‹ˆë‹¤.",
        "ë§›ì´ ì¢‹ì•„ì„œ ìì£¼ ì‹œì¼œë¨¹ì„ ê²ƒ ê°™ì•„ìš”.",
        "ë‹¹ì¼ ë°›ì•„ì„œ ë„ˆë¬´ ë§Œì¡±ìŠ¤ëŸ¬ì›Œìš”.",
        "ê°€ê²© ëŒ€ë¹„ í€„ë¦¬í‹° ì¢‹ìŠµë‹ˆë‹¤. ê°ì‚¬í•´ìš”.",
        "ì‹ ì„ í•˜ê³  ë§›ìˆì–´ìš”. ì¬ì£¼ë¬¸ ì˜ì‚¬ ìˆìŠµë‹ˆë‹¤.",
        "ì„œë¹„ìŠ¤ë„ ì¢‹ê³  ìƒí’ˆë„ ë§Œì¡±í•©ë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤.",
    ]
    user_names = ["ê¹€**", "ì´**", "ë°•**", "ìµœ**", "ì •**", "ê°•**", "ì¡°**", "ìœ¤**", "ì¥**", "í•œ**"]
    products = Product.query.filter_by(is_active=True).all()
    cat_ids = {}
    created = 0
    for p in products:
        if p.category and p.category not in cat_ids:
            c = Category.query.filter_by(name=p.category).first()
            cat_ids[p.category] = c.id if c else None
        category_id = cat_ids.get(p.category)
        existing = Review.query.filter_by(product_id=p.id).count()
        to_add = max(0, count_per_product - existing)
        for j in range(to_add):
            # ê°€ìƒ order_id: ìŒìˆ˜ë¡œ ì‹¤ì£¼ë¬¸ê³¼ êµ¬ë¶„, ìƒí’ˆë³„Â·ìˆœë²ˆë³„ ê³ ìœ  (ê¸°ì¡´ í›„ê¸° ìˆ˜ + j)
            virtual_order_id = -(p.id * 1000 + existing + j)
            if Review.query.filter_by(order_id=virtual_order_id).first():
                continue
            content = reviews_content[j % len(reviews_content)]
            uname = user_names[j % len(user_names)]
            img = f"https://placehold.co/400x400/e0f2fe/1e40af?text=í›„ê¸°"
            r = Review(
                order_id=virtual_order_id,
                user_id=0,
                user_name=uname,
                product_id=p.id,
                product_name=p.name[:100] if p.name else "",
                category_id=category_id,
                content=content,
                image_url=img,
            )
            db.session.add(r)
            created += 1
    if created:
        db.session.commit()
    return created


@app.route('/admin/seed_test_data')
@login_required
def admin_seed_test_data():
    """í…ŒìŠ¤íŠ¸ ì¹´í…Œê³ ë¦¬ 3ê°œ + ê°€ìƒ ìƒí’ˆ 10ê°œì”© ìƒì„± (ê´€ë¦¬ì ì „ìš©)."""
    if not current_user.is_admin:
        return redirect('/')
    created = _seed_test_categories_and_products()
    flash(f"í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„± ì™„ë£Œ. ìƒˆë¡œ ë“±ë¡ëœ ìƒí’ˆ {created}ê±´ (ì¹´í…Œê³ ë¦¬Â·ê¸°ì¡´ ìƒí’ˆì€ ì¤‘ë³µ ìƒì„± ì•ˆ í•¨).")
    return redirect('/admin')


def _delete_test_categories_and_products():
    """í…ŒìŠ¤íŠ¸ ì¹´í…Œê³ ë¦¬(í…ŒìŠ¤íŠ¸-ì±„ì†Œ/ê³¼ì¼/ìˆ˜ì‚°)ì™€ í•´ë‹¹ ìƒí’ˆ ì „ë¶€ ì‚­ì œ. ì‚­ì œëœ ìƒí’ˆ ìˆ˜ ë°˜í™˜."""
    test_cat_names = ["í…ŒìŠ¤íŠ¸-ì±„ì†Œ", "í…ŒìŠ¤íŠ¸-ê³¼ì¼", "í…ŒìŠ¤íŠ¸-ìˆ˜ì‚°"]
    deleted_products = Product.query.filter(Product.category.in_(test_cat_names)).all()
    deleted_count = len(deleted_products)
    pids = [p.id for p in deleted_products]
    if pids:
        Review.query.filter(Review.product_id.in_(pids)).delete(synchronize_session=False)
    for p in deleted_products:
        db.session.delete(p)
    for name in test_cat_names:
        cat = Category.query.filter_by(name=name).first()
        if cat:
            db.session.delete(cat)
    db.session.commit()
    return deleted_count


@app.route('/admin/delete_test_data')
@login_required
def admin_delete_test_data():
    """í…ŒìŠ¤íŠ¸ ì¹´í…Œê³ ë¦¬ ë° í•´ë‹¹ ìƒí’ˆ ì „ë¶€ ì‚­ì œ (ê´€ë¦¬ì ì „ìš©)."""
    if not current_user.is_admin:
        return redirect('/')
    deleted = _delete_test_categories_and_products()
    flash(f"í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚­ì œ ì™„ë£Œ. ìƒí’ˆ {deleted}ê±´ ë° í…ŒìŠ¤íŠ¸ ì¹´í…Œê³ ë¦¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")
    return redirect('/admin')


@app.route('/admin/seed_virtual_reviews')
@login_required
def admin_seed_virtual_reviews():
    """ìƒí’ˆë³„ ê°€ìƒ êµ¬ë§¤ í›„ê¸° 10ê°œì”© ìƒì„± (ê´€ë¦¬ì ì „ìš©)."""
    if not current_user.is_admin:
        return redirect('/')
    created = _seed_virtual_reviews_per_product(10)
    flash(f"ê°€ìƒ êµ¬ë§¤ í›„ê¸° ìƒì„± ì™„ë£Œ. ìƒˆë¡œ ë“±ë¡ëœ í›„ê¸° {created}ê±´ (ìƒí’ˆë‹¹ 10ê°œì”©, ê¸°ì¡´ í›„ê¸°ëŠ” ê±´ë„ˆëœ€).")
    return redirect('/admin?tab=reviews')


def _seed_virtual_orders(num_orders=20, days_back=10, min_items=2, max_items=3):
    """ìµœê·¼ days_back ì¼ ì´ë‚´ ê°€ìƒ ì£¼ë¬¸ num_ordersê±´ ìƒì„±. ì£¼ë¬¸ë‹¹ min_items~max_itemsê°œ í’ˆëª©. í…ŒìŠ¤íŠ¸ìš©."""
    user = User.query.filter(User.is_admin == False).first() or User.query.filter_by(is_admin=True).first()
    if not user:
        return 0
    products = Product.query.filter_by(is_active=True).limit(100).all()
    if len(products) < 2:
        return 0
    now = datetime.now()
    created_count = 0
    for i in range(num_orders):
        # ìµœê·¼ 10ì¼ ì´ë‚´ ëœë¤ ì‹œê°
        created_at = now - timedelta(days=random.uniform(0, days_back), hours=random.uniform(0, 24))
        n_items = random.randint(min_items, max_items)
        chosen = random.sample(products, min(n_items, len(products)))
        quantities = [random.randint(1, 3) for _ in chosen]
        total_price = sum(p.price * q for p, q in zip(chosen, quantities))
        delivery_fee = 3000 if total_price < 40000 else 0
        tax_free = sum(p.price * q for p, q in zip(chosen, quantities) if getattr(p, 'tax_type', None) == 'ë©´ì„¸')
        product_details = " | ".join(f"[{p.category}] {p.name}({q})" for p, q in zip(chosen, quantities))
        order_id = f"ORDER_VIRT_{now.strftime('%Y%m%d%H%M%S')}_{i}_{random.randint(1000, 9999)}"
        payment_key = f"virtual_pk_{order_id}"
        delivery_address_str = "(ì¸ì²œ ì—°ìˆ˜êµ¬ ì†¡ë„ë™ 123-45) 101ë™ 101í˜¸ (í˜„ê´€:1234)"
        order = Order(
            user_id=user.id,
            customer_name=user.name or "í…ŒìŠ¤íŠ¸ê³ ê°",
            customer_phone=user.phone or "010-0000-0000",
            customer_email=user.email or "test@test.com",
            product_details=product_details,
            total_price=total_price + delivery_fee,
            delivery_fee=delivery_fee,
            tax_free_amount=tax_free,
            status='ê²°ì œì™„ë£Œ',
            order_id=order_id,
            payment_key=payment_key,
            delivery_address=delivery_address_str,
            request_memo="",
            points_used=0,
            quick_extra_fee=0,
            created_at=created_at,
        )
        db.session.add(order)
        db.session.flush()
        for p, qty in zip(chosen, quantities):
            tax_type = getattr(p, 'tax_type', None) or 'ê³¼ì„¸'
            oi = OrderItem(
                order_id=order.id,
                product_id=p.id,
                product_name=p.name,
                product_category=p.category,
                price=p.price,
                quantity=qty,
                tax_type=tax_type,
                cancelled=False,
                item_status='ê²°ì œì™„ë£Œ',
            )
            db.session.add(oi)
            db.session.flush()
            sales_amount = p.price * qty
            fee = round(sales_amount * 0.055)
            delivery_fee_per = 990
            total = sales_amount - fee - delivery_fee_per
            settlement_no = "N" + str(oi.id).zfill(10)
            cat = Category.query.filter_by(name=p.category).first()
            tax_exempt_val = (getattr(cat, 'tax_type', None) or 'ê³¼ì„¸') == 'ë©´ì„¸'
            db.session.add(Settlement(
                settlement_no=settlement_no,
                order_id=order.id,
                order_item_id=oi.id,
                sale_dt=created_at,
                category=p.category,
                tax_exempt=tax_exempt_val,
                product_name=p.name,
                sales_amount=sales_amount,
                fee=fee,
                delivery_fee=delivery_fee_per,
                settlement_total=total,
                settlement_status='ì…ê¸ˆëŒ€ê¸°',
                settled_at=None,
            ))
        created_count += 1
    if created_count:
        db.session.commit()
    return created_count


@app.route('/admin/seed_virtual_orders')
@login_required
def admin_seed_virtual_orders():
    """ìµœê·¼ 10ì¼ ì´ë‚´ ê°€ìƒ ì£¼ë¬¸ 20ê±´ ìƒì„± (í’ˆëª© 2~3ê°œì”©, í…ŒìŠ¤íŠ¸ìš©)."""
    if not current_user.is_admin:
        return redirect('/')
    created = _seed_virtual_orders(num_orders=20, days_back=10, min_items=2, max_items=3)
    flash(f"ê°€ìƒ ì£¼ë¬¸ ìƒì„± ì™„ë£Œ. ì£¼ë¬¸ {created}ê±´ (ìµœê·¼ 10ì¼ ì´ë‚´, í’ˆëª© 2~3ê°œì”©).")
    return redirect('/admin?tab=orders')


# --------------------------------------------------------------------------------
# 8. ê°œë³„ ìƒí’ˆ ë“±ë¡/ìˆ˜ì •/ì‚­ì œ ë° ì¹´í…Œê³ ë¦¬ ê´€ë¦¬
# --------------------------------------------------------------------------------

@app.route('/admin/add', methods=['GET', 'POST'])
@login_required
def admin_product_add():
    """ê°œë³„ ìƒí’ˆ ë“±ë¡"""
    categories = Category.query.order_by(Category.order.asc(), Category.id.asc()).all()
    my_categories = [c.name for c in categories if c.manager_email == current_user.email]
    is_master = current_user.is_admin
    selectable_categories = [c for c in categories if is_master or c.name in my_categories]
    if request.method == 'POST':
        cat_name = request.form['category']
        if not check_admin_permission(cat_name): return redirect('/admin')
        main_img = save_uploaded_file(request.files.get('main_image'))
        detail_files = request.files.getlist('detail_images')
        detail_img_url_str = ",".join(filter(None, [save_uploaded_file(f) for f in detail_files if f.filename != '']))
        deadline_val = datetime.strptime(request.form['deadline'], '%Y-%m-%dT%H:%M') if request.form.get('deadline') else None
        rt = request.form.get('reset_time', '').strip()[:5] if request.form.get('reset_time') else None
        rq = request.form.get('reset_to_quantity', '').strip()
        reset_to_q = int(rq) if rq.isdigit() else None
        sp = request.form.get('supply_price', '').strip()
        supply_price = int(sp) if sp.isdigit() else None
        new_p = Product(name=request.form['name'], description=request.form['description'], category=cat_name, price=int(request.form['price']), supply_price=supply_price, spec=request.form['spec'], origin=request.form['origin'], farmer="ë°”êµ¬ë‹ˆì‚¼ì´Œ", stock=int(request.form['stock']), image_url=main_img or "", detail_image_url=detail_img_url_str, deadline=deadline_val, badge=request.form.get('badge', ''), reset_time=rt or None, reset_to_quantity=reset_to_q)
        db.session.add(new_p); db.session.commit(); return redirect('/admin')
    return render_template_string(HEADER_HTML + """<div class="max-w-xl mx-auto py-20 px-6 font-black text-left"><h2 class="text-3xl font-black mb-12 border-l-8 border-teal-600 pl-6 uppercase italic text-left">Add Product</h2><p class="text-[11px] text-gray-500 font-bold mb-6 bg-gray-50 p-4 rounded-xl border border-gray-100">ê° í•­ëª©ì´ <strong>ëª©ë¡Â·ìƒì„¸ í˜ì´ì§€ ì–´ë””ì—</strong> ë‚˜ê°€ëŠ”ì§€: ìƒí’ˆëª…â†’ëª©ë¡ ì¹´ë“œÂ·ìƒì„¸ ì œëª© / Short Introâ†’ìƒí’ˆëª… ì˜† / Detailed Introâ†’ìƒì„¸ ì‚¬ì§„ ìœ„ / Deliveryâ†’ëª©ë¡ ë°°ì§€Â·ìƒì„¸ ë°°ì†¡ë¬¸êµ¬ / ê°€ê²©Â·ê·œê²©â†’ëª©ë¡Â·ìƒì„¸ / ì¬ê³ â†’ì”ì—¬ Nê°œ / ë§ˆê°ì¼â†’ì¹´ìš´íŠ¸ë‹¤ìš´Â·ì˜¤ëŠ˜ë§ˆê° / Main Imageâ†’ëª©ë¡Â·ëŒ€í‘œì‚¬ì§„ / Detail Imagesâ†’ìƒì„¸ ë³¸ë¬¸ ì—¬ëŸ¬ ì¥.</p><form method="POST" enctype="multipart/form-data" class="bg-white p-10 rounded-[3rem] shadow-2xl space-y-7 text-left"><select name="category" class="w-full p-5 bg-gray-50 rounded-2xl font-black outline-none focus:ring-4 focus:ring-teal-50 text-left">{% for c in selectable_categories %}<option value="{{c.name}}">{{c.name}}</option>{% endfor %}</select>
   <input name="name" placeholder="ìƒí’ˆ ëª…ì¹­ (ì˜ˆ: ê¿€ë¶€ì‚¬ ì‚¬ê³¼)" class="w-full p-5 bg-gray-50 rounded-2xl font-black text-left text-sm" value="{{ p.name if p else '' }}" required>

<div class="space-y-1">
    <label class="text-[10px] text-orange-500 font-black ml-4 uppercase tracking-widest">Short Intro (ìƒí’ˆëª… ì˜† í•œì¤„ì†Œê°œ)</label>
    <input name="badge" placeholder="ì˜ˆ: ì•„ì‚­í•˜ê³  ë‹¬ì½¤í•œ, ì‚°ì§€ì§ì†¡" class="w-full p-5 bg-orange-50 border border-orange-100 rounded-2xl font-black text-left text-sm focus:ring-4 focus:ring-orange-100 outline-none transition" value="{{ p.badge if p else '' }}">
</div>

<div class="space-y-1">
    <label class="text-[10px] text-teal-600 font-black ml-4 uppercase tracking-widest">Detailed Intro (ì‚¬ì§„ ìœ„ ë…¸ì¶œ ë¬¸êµ¬)</label>
    <input name="origin" placeholder="ìƒì„¸í˜ì´ì§€ ì‚¬ì§„ ë°”ë¡œ ìœ„ì— ë…¸ì¶œë  ë¬¸êµ¬" class="w-full p-5 bg-teal-50 border border-teal-100 rounded-2xl font-black text-left text-sm focus:ring-4 focus:ring-teal-100 outline-none transition" value="{{ p.origin if p else '' }}">
</div>

<div class="space-y-1">
    <label class="text-[10px] text-blue-600 font-black ml-4 uppercase tracking-widest">Delivery (ë°°ì†¡ ì˜ˆì •ì¼)</label>
    <select name="description" class="w-full p-5 bg-blue-50 text-blue-700 rounded-2xl font-black text-sm outline-none border-none focus:ring-4 focus:ring-blue-100">
        <option value="+1ì¼" {% if p and p.description == '+1ì¼' %}selected{% endif %}>ğŸšš ì£¼ë¬¸ ì™„ë£Œ í›„ +1ì¼ ë°°ì†¡</option>
        <option value="+2ì¼" {% if p and p.description == '+2ì¼' %}selected{% endif %}>ğŸšš ì£¼ë¬¸ ì™„ë£Œ í›„ +2ì¼ ë°°ì†¡</option>
        <option value="+3ì¼" {% if p and p.description == '+3ì¼' %}selected{% endif %}>ğŸšš ì£¼ë¬¸ ì™„ë£Œ í›„ +3ì¼ ë°°ì†¡</option>
        <option value="ë‹¹ì¼ë°°ì†¡" {% if p and p.description == 'ë‹¹ì¼ë°°ì†¡' %}selected{% endif %}>âš¡ ì†¡ë„ ì§€ì—­ ë‹¹ì¼ ë°°ì†¡</option>
    </select>
</div>
<div class="grid grid-cols-2 gap-5 text-left"><input name="price" type="number" placeholder="íŒë§¤ ê°€ê²©(ì›)" class="p-5 bg-gray-50 rounded-2xl font-black text-left text-sm" required><input name="spec" placeholder="ê·œê²© (ì˜ˆ: 5kg/1ë°•ìŠ¤)" class="p-5 bg-gray-50 rounded-2xl font-black text-left text-sm"></div>
<div class="grid grid-cols-1 gap-5 text-left"><label class="text-[10px] text-gray-400 font-black ml-4 uppercase tracking-widest">ì—…ì²´ê³µê¸‰ê°€ê²© (ì›)</label><input name="supply_price" type="number" min="0" placeholder="ì—…ì²´ê³µê¸‰ê°€ê²© (ì„ íƒ)" class="p-5 bg-gray-50 rounded-2xl font-black text-left text-sm"></div>
<div class="grid grid-cols-2 gap-5 text-left"><input name="stock" type="number" placeholder="í•œì • ìˆ˜ëŸ‰" class="p-5 bg-gray-50 rounded-2xl font-black text-left text-sm" value="50"><input name="deadline" type="datetime-local" id="add-deadline" class="p-5 bg-gray-50 rounded-2xl font-black text-left text-sm"></div>
<div id="add-reset-time-block" class="grid grid-cols-2 gap-5 text-left">
    <div><label class="text-[10px] text-amber-600 font-black ml-4 block mb-1">ì¬ê³  ì´ˆê¸°í™” ì‹œê° (ë§ˆê°ì¼ ì—†ì„ ë•Œ)</label><input name="reset_time" type="time" class="w-full p-5 bg-amber-50 rounded-2xl font-black text-left text-sm border border-amber-100" placeholder="09:00"></div>
    <div><label class="text-[10px] text-amber-600 font-black ml-4 block mb-1">ì´ˆê¸°í™” ì‹œ ë³µì› ìˆ˜ëŸ‰</label><input name="reset_to_quantity" type="number" min="0" placeholder="ì˜ˆ: 50" class="w-full p-5 bg-amber-50 rounded-2xl font-black text-left text-sm border border-amber-100"></div>
</div>
<script>(function(){ var d=document.getElementById('add-deadline'); var b=document.getElementById('add-reset-time-block'); if(d&&b){ function t(){ b.classList.toggle('hidden', !!d.value); } d.addEventListener('change',t); d.addEventListener('input',t); } })();</script>
<select name="badge" class="w-full p-5 bg-gray-50 rounded-2xl font-black text-left text-sm"><option value="">ë…¸ì¶œ ë±ƒì§€ ì—†ìŒ</option><option value="ì˜¤ëŠ˜ë§ˆê°">ğŸ”¥ ì˜¤ëŠ˜ë§ˆê°</option><option value="ì‚¼ì´Œì¶”ì²œ">â­ ì‚¼ì´Œì¶”ì²œ</option></select>
<div class="p-6 border-2 border-dashed border-gray-100 rounded-3xl text-left"><label class="text-[10px] text-gray-400 uppercase font-black block mb-4 text-left">Main Image (ëª©ë¡Â·ëŒ€í‘œ ì‚¬ì§„)</label><input type="file" name="main_image" accept="image/*" class="text-xs text-left product-image-input"></div>
<div class="p-6 border-2 border-dashed border-blue-50 rounded-3xl text-left"><label class="text-[10px] text-blue-400 uppercase font-black block mb-4 text-left">Detail Images (ìƒì„¸ ë³¸ë¬¸ ì—¬ëŸ¬ ì¥)</label><input type="file" name="detail_images" multiple accept="image/*" class="text-xs text-left product-image-input"></div>
<button type="submit" class="w-full bg-teal-600 text-white py-6 rounded-3xl font-black text-xl shadow-xl hover:bg-teal-700 transition active:scale-95 text-center admin-product-submit-btn">ìƒí’ˆ ë“±ë¡ ì™„ë£Œ</button></form></div>
<script>
(function(){
function processImageFile(file) {
  if (!file || !file.type || !file.type.match(/^image\//)) return Promise.resolve(file);
  return new Promise(function(resolve) {
    var img = new Image();
    var url = URL.createObjectURL(file);
    img.onload = function() {
      URL.revokeObjectURL(url);
      var w = img.naturalWidth, h = img.naturalHeight;
      var minSide = Math.min(w, h);
      var size = Math.min(1200, minSide);
      var canvas = document.createElement('canvas');
      canvas.width = size; canvas.height = size;
      var ctx = canvas.getContext('2d');
      var sx = (w - minSide) / 2, sy = (h - minSide) / 2;
      ctx.drawImage(img, sx, sy, minSide, minSide, 0, 0, size, size);
      canvas.toBlob(function(blob) { resolve(blob ? new File([blob], file.name || 'image.jpg', { type: 'image/jpeg' }) : file); }, 'image/jpeg', 0.82);
    };
    img.onerror = function() { URL.revokeObjectURL(url); resolve(file); };
    img.src = url;
  });
}
var form = document.querySelector('form[enctype="multipart/form-data"]');
if (form && form.action && form.action.indexOf('/admin/add') !== -1) {
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    var f = this;
    var btn = f.querySelector('.admin-product-submit-btn');
    var originalText = btn ? btn.textContent : '';
    if (btn) { btn.disabled = true; btn.textContent = 'ì €ì¥ ì¤‘...'; }
    var formData = new FormData(f);
    var mainIn = f.querySelector('input[name="main_image"]');
    if (mainIn && mainIn.files && mainIn.files[0]) {
      var p = await processImageFile(mainIn.files[0]);
      if (p) formData.set('main_image', p, p.name || 'main.jpg');
    }
    var detailIn = f.querySelector('input[name="detail_images"]');
    if (detailIn && detailIn.files && detailIn.files.length) {
      formData.delete('detail_images');
      for (var i = 0; i < detailIn.files.length; i++) {
        var q = await processImageFile(detailIn.files[i]);
        if (q) formData.append('detail_images', q, q.name || ('detail_' + i + '.jpg'));
      }
    }
    try {
      var r = await fetch(f.action, { method: 'POST', body: formData, redirect: 'follow' });
      if (r.ok) { window.location.href = r.url || '/admin'; } else { alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); if (btn) { btn.disabled = false; btn.textContent = originalText; } }
    } catch (err) { alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); if (btn) { btn.disabled = false; btn.textContent = originalText; } }
  });
}
})();
</script>
""", selectable_categories=selectable_categories, p=None)

@app.route('/admin/edit/<int:pid>', methods=['GET', 'POST'])
@login_required
def admin_product_edit(pid):
    """ê°œë³„ ìƒí’ˆ ìˆ˜ì • (ìƒí’ˆ ë“±ë¡í¼ê³¼ ë™ì¼í•œ ë””ìì¸ ë° êµ¬ì„± ì ìš©)"""
    p = Product.query.get_or_404(pid)
    if request.method == 'POST':
        # ë°ì´í„° ì—…ë°ì´íŠ¸ ë¡œì§
        p.name = request.form['name']
        p.description = request.form['description']
        p.price = int(request.form['price'])
        sp = request.form.get('supply_price', '').strip()
        p.supply_price = int(sp) if sp.isdigit() else None
        p.spec = request.form['spec']
        p.stock = int(request.form['stock'])
        p.origin = request.form['origin']
        p.badge = request.form.get('badge', '')
        p.deadline = datetime.strptime(request.form['deadline'], '%Y-%m-%dT%H:%M') if request.form.get('deadline') else None
        rt = request.form.get('reset_time', '').strip()
        p.reset_time = rt[:5] if rt else None
        rq = request.form.get('reset_to_quantity', '').strip()
        p.reset_to_quantity = int(rq) if rq.isdigit() else None
        if not p.reset_time:
            p.last_reset_at = None
        
        # ë©”ì¸ ì´ë¯¸ì§€ ë³€ê²½ ì‹œ ì²˜ë¦¬
        main_img = save_uploaded_file(request.files.get('main_image'))
        if main_img: p.image_url = main_img
        
        # ìƒì„¸ ì´ë¯¸ì§€ ë³€ê²½ ì‹œ ì²˜ë¦¬
        detail_files = request.files.getlist('detail_images')
        if detail_files and detail_files[0].filename != '':
            p.detail_image_url = ",".join(filter(None, [save_uploaded_file(f) for f in detail_files if f.filename != '']))
            
        db.session.commit()
        flash("ìƒí’ˆ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.")
        return redirect('/admin')

    # ìˆ˜ì • í¼ ë Œë”ë§ (ë“±ë¡ í¼ê³¼ ë””ìì¸ í†µì¼)
    return render_template_string(HEADER_HTML + """
    <div class="max-w-xl mx-auto py-12 md:py-20 px-6 font-black text-left">
        <h2 class="text-2xl md:text-3xl font-black mb-10 border-l-8 border-blue-600 pl-5 uppercase italic text-gray-800">
            Edit Product
        </h2>
        <p class="text-[11px] text-gray-500 font-bold mb-6 bg-gray-50 p-4 rounded-xl border border-gray-100">ì•„ë˜ ê° í•­ëª©ì€ ìƒí’ˆ ëª©ë¡Â·ìƒì„¸ í˜ì´ì§€ì˜ <strong>ì–´ëŠ ìœ„ì¹˜ì— ì–´ë–¤ ê¸€ê·€</strong>ë¡œ ë…¸ì¶œë˜ëŠ”ì§€ ì ì–´ ë‘ì—ˆìŠµë‹ˆë‹¤. ë“±ë¡ ì‹œ ì°¸ê³ í•˜ì„¸ìš”.</p>
        
        <form id="admin-product-form-edit" method="POST" enctype="multipart/form-data" class="bg-white p-8 md:p-12 rounded-[2.5rem] md:rounded-[3.5rem] shadow-2xl space-y-7 text-left">
            <div class="space-y-1">
                <label class="text-[10px] text-gray-400 font-black ml-4 uppercase tracking-widest">Product Name (ìƒí’ˆëª…)</label>
                <p class="text-[10px] text-gray-500 ml-4 mb-0.5">ë…¸ì¶œ ìœ„ì¹˜: ë©”ì¸Â·ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì¹´ë“œì˜ <strong>ìƒí’ˆëª… í•œ ì¤„</strong>, ìƒì„¸ í˜ì´ì§€ ì œëª©</p>
                <input name="name" placeholder="ìƒí’ˆ ëª…ì¹­ (ì˜ˆ: ê¿€ë¶€ì‚¬ ì‚¬ê³¼)" 
                       class="w-full p-5 bg-gray-50 rounded-2xl font-black text-left text-sm focus:ring-4 focus:ring-blue-50 outline-none transition" 
                       value="{{ p.name }}" required>
            </div>

            <div class="space-y-1">
                <label class="text-[10px] text-orange-500 font-black ml-4 uppercase tracking-widest">Short Intro / Badge (í•œì¤„ì†Œê°œÂ·ë±ƒì§€)</label>
                <p class="text-[10px] text-gray-500 ml-4 mb-0.5">ë…¸ì¶œ ìœ„ì¹˜: ëª©ë¡ ì¹´ë“œì—ì„œ <strong>ìƒí’ˆëª… ë°”ë¡œ ì˜†</strong> (ì˜ˆ: | ì‚°ì§€ì§ì†¡), ìƒì„¸ì—ì„œë„ ìƒí’ˆëª… ì˜†. ë±ƒì§€ ì„ íƒ ì‹œ ì˜¤ëŠ˜ë§ˆê°Â·ì‚¼ì´Œì¶”ì²œ ë“±</p>
                <input name="badge" placeholder="ì˜ˆ: ì•„ì‚­í•˜ê³  ë‹¬ì½¤í•œ, ì‚°ì§€ì§ì†¡" 
                       class="w-full p-5 bg-orange-50 border border-orange-100 rounded-2xl font-black text-left text-sm focus:ring-4 focus:ring-orange-100 outline-none transition" 
                       value="{{ p.badge or '' }}">
            </div>

            <div class="space-y-1">
                <label class="text-[10px] text-teal-600 font-black ml-4 uppercase tracking-widest">Detailed Intro / Origin (ì‚¬ì§„ ìœ„ ë¬¸êµ¬)</label>
                <p class="text-[10px] text-gray-500 ml-4 mb-0.5">ë…¸ì¶œ ìœ„ì¹˜: <strong>ìƒì„¸ í˜ì´ì§€ ë©”ì¸ ì´ë¯¸ì§€ ë°”ë¡œ ìœ„</strong> í•œ ì¤„ ë¬¸êµ¬ (ì›ì‚°ì§€Â·í’ˆì§ˆ ì„¤ëª… ë“±)</p>
                <input name="origin" placeholder="ìƒì„¸í˜ì´ì§€ ì‚¬ì§„ ë°”ë¡œ ìœ„ì— ë…¸ì¶œë  ë¬¸êµ¬" 
                       class="w-full p-5 bg-teal-50 border border-teal-100 rounded-2xl font-black text-left text-sm focus:ring-4 focus:ring-teal-100 outline-none transition" 
                       value="{{ p.origin or '' }}">
            </div>

            <div class="space-y-1">
                <label class="text-[10px] text-blue-600 font-black ml-4 uppercase tracking-widest">Delivery (ë°°ì†¡ ì˜ˆì •ì¼)</label>
                <p class="text-[10px] text-gray-500 ml-4 mb-0.5">ë…¸ì¶œ ìœ„ì¹˜: ëª©ë¡ ì¹´ë“œ <strong>ì´ë¯¸ì§€ ì¢Œì¸¡ ë°°ì§€</strong> (ë‹¹ì¼ë°°ì†¡/+1ì¼/+2ì¼ ë“±), ìƒì„¸ í˜ì´ì§€ ë°°ì†¡ ì•ˆë‚´ ë¬¸êµ¬</p>
                <select name="description" class="w-full p-5 bg-blue-50 text-blue-700 rounded-2xl font-black text-sm outline-none border-none focus:ring-4 focus:ring-blue-100">
                    <option value="+1ì¼" {% if p.description == '+1ì¼' %}selected{% endif %}>ğŸšš ì£¼ë¬¸ ì™„ë£Œ í›„ +1ì¼ ë°°ì†¡</option>
                    <option value="+2ì¼" {% if p.description == '+2ì¼' %}selected{% endif %}>ğŸšš ì£¼ë¬¸ ì™„ë£Œ í›„ +2ì¼ ë°°ì†¡</option>
                    <option value="+3ì¼" {% if p.description == '+3ì¼' %}selected{% endif %}>ğŸšš ì£¼ë¬¸ ì™„ë£Œ í›„ +3ì¼ ë°°ì†¡</option>
                    <option value="ë‹¹ì¼ë°°ì†¡" {% if p.description == 'ë‹¹ì¼ë°°ì†¡' %}selected{% endif %}>âš¡ ì†¡ë„ ì§€ì—­ ë‹¹ì¼ ë°°ì†¡</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-5">
                <div class="space-y-1">
                    <label class="text-[10px] text-gray-400 font-black ml-4 uppercase tracking-widest">Price (ì›)</label>
                    <p class="text-[10px] text-gray-500 ml-4 mb-0.5">ë…¸ì¶œ: ëª©ë¡Â·ìƒì„¸ <strong>ê°€ê²©</strong></p>
                    <input name="price" type="number" placeholder="íŒë§¤ ê°€ê²©" 
                           class="w-full p-5 bg-gray-50 rounded-2xl font-black text-left text-sm outline-none" 
                           value="{{ p.price }}" required>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] text-gray-400 font-black ml-4 uppercase tracking-widest">Spec (ê·œê²©)</label>
                    <p class="text-[10px] text-gray-500 ml-4 mb-0.5">ë…¸ì¶œ: ëª©ë¡ ì¹´ë“œ <strong>ê·œê²© ë±ƒì§€</strong> (ì˜ˆ: 1ë°•ìŠ¤, 1kg)</p>
                    <input name="spec" placeholder="ì˜ˆ: 5kg/1ë°•ìŠ¤" 
                           class="w-full p-5 bg-gray-50 rounded-2xl font-black text-left text-sm outline-none" 
                           value="{{ p.spec or '' }}">
                </div>
            </div>

            <div class="grid grid-cols-1 gap-5">
                <div class="space-y-1">
                    <label class="text-[10px] text-gray-400 font-black ml-4 uppercase tracking-widest">ì—…ì²´ê³µê¸‰ê°€ê²© (ì›)</label>
                    <p class="text-[10px] text-gray-500 ml-4 mb-0.5">ê´€ë¦¬ìš©. ê³ ê°ì—ê²Œ ë…¸ì¶œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                    <input name="supply_price" type="number" min="0" placeholder="ì—…ì²´ê³µê¸‰ê°€ê²© (ì„ íƒ)" 
                           class="w-full p-5 bg-gray-50 rounded-2xl font-black text-left text-sm outline-none" 
                           value="{{ p.supply_price if p.supply_price is not none else '' }}">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-5">
                <div class="space-y-1">
                    <label class="text-[10px] text-gray-400 font-black ml-4 uppercase tracking-widest">Stock (í•œì • ìˆ˜ëŸ‰)</label>
                    <p class="text-[10px] text-gray-500 ml-4 mb-0.5">ë…¸ì¶œ: ìƒì„¸ í˜ì´ì§€ <strong>ì”ì—¬ Nê°œ</strong>, ëª©ë¡ ì¹´ë“œ í•˜ë‹¨ ì”ì—¬ ìˆ˜</p>
                    <input name="stock" type="number" placeholder="ì¬ê³  ìˆ˜ëŸ‰" 
                           class="w-full p-5 bg-gray-50 rounded-2xl font-black text-left text-sm outline-none" 
                           value="{{ p.stock }}">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] text-red-400 font-black ml-4 uppercase tracking-widest">Deadline (ë§ˆê°ì¼)</label>
                    <p class="text-[10px] text-gray-500 ml-4 mb-0.5">ë…¸ì¶œ: ë§ˆê° ìˆìœ¼ë©´ ìƒì„¸Â·ëª©ë¡ì— <strong>ì¹´ìš´íŠ¸ë‹¤ìš´Â·ì˜¤ëŠ˜ë§ˆê°</strong> ë“±. ë¹„ìš°ë©´ ìƒì‹œ íŒë§¤</p>
                    <input name="deadline" type="datetime-local" id="edit-deadline"
                           class="w-full p-5 bg-gray-50 rounded-2xl font-black text-left text-sm outline-none" 
                           value="{{ p.deadline.strftime('%Y-%m-%dT%H:%M') if p.deadline else '' }}">
                </div>
            </div>

            <div id="edit-reset-time-block" class="grid grid-cols-2 gap-5 {% if p.deadline %}hidden{% endif %}">
                <div class="space-y-1">
                    <label class="text-[10px] text-amber-600 font-black ml-4 uppercase tracking-widest">ì¬ê³  ì´ˆê¸°í™” ì‹œê° (ë§ˆê°ì¼ ì—†ì„ ë•Œ)</label>
                    <p class="text-[10px] text-gray-500 ml-4 mb-0.5">ë§¤ì¼ ì´ ì‹œê°ì´ ë˜ë©´ ì•„ë˜ Â«ì´ˆê¸°í™” ìˆ˜ëŸ‰Â»ìœ¼ë¡œ ì¬ê³ ê°€ ìë™ ë³µì›ë©ë‹ˆë‹¤.</p>
                    <input name="reset_time" type="time" placeholder="09:00" 
                           class="w-full p-5 bg-amber-50 rounded-2xl font-black text-left text-sm outline-none border border-amber-100" 
                           value="{{ p.reset_time or '' }}">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] text-amber-600 font-black ml-4 uppercase tracking-widest">ì´ˆê¸°í™” ì‹œ ë³µì› ìˆ˜ëŸ‰</label>
                    <p class="text-[10px] text-gray-500 ml-4 mb-0.5">ìœ„ ì‹œê°ì— ì¬ê³ ë¥¼ ì´ ìˆ«ìë¡œ ë§ì¶¥ë‹ˆë‹¤. ë¹„ìš°ë©´ ì´ˆê¸°í™” ì•ˆ í•¨.</p>
                    <input name="reset_to_quantity" type="number" placeholder="ì˜ˆ: 50" min="0"
                           class="w-full p-5 bg-amber-50 rounded-2xl font-black text-left text-sm outline-none border border-amber-100" 
                           value="{{ p.reset_to_quantity if p.reset_to_quantity is not none else '' }}">
                </div>
            </div>
            <script>
            (function(){
                var deadlineInput = document.getElementById('edit-deadline');
                var block = document.getElementById('edit-reset-time-block');
                if (deadlineInput && block) {
                    function toggle() { block.classList.toggle('hidden', !!deadlineInput.value); }
                    deadlineInput.addEventListener('change', toggle);
                    deadlineInput.addEventListener('input', toggle);
                }
            })();
            </script>

            <div class="pt-4 space-y-4">
                <div class="p-6 border-2 border-dashed border-gray-100 rounded-3xl">
                    <label class="text-[10px] text-gray-400 uppercase font-black block mb-3">Main Image (ë©”ì¸ ì´ë¯¸ì§€)</label>
                    <p class="text-[10px] text-gray-500 ml-0 mb-2">ë…¸ì¶œ ìœ„ì¹˜: <strong>ë©”ì¸Â·ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì¹´ë“œ</strong> ë° ìƒì„¸ í˜ì´ì§€ ëŒ€í‘œ ì‚¬ì§„ (ê¸°ì¡´ ì´ë¯¸ì§€ ìœ ì§€ ê°€ëŠ¥)</p>
                    <input type="file" name="main_image" accept="image/*" class="text-[10px] font-bold product-image-input">
                    {% if p.image_url %}
                    <p class="text-[9px] text-blue-500 mt-2 font-bold italic">í˜„ì¬ ë“±ë¡ë¨: {{ p.image_url.split('/')[-1] }}</p>
                    {% endif %}
                </div>
                
                <div class="p-6 border-2 border-dashed border-blue-50 rounded-3xl">
                    <label class="text-[10px] text-blue-400 uppercase font-black block mb-3">Detail Images (ìƒì„¸ ì´ë¯¸ì§€)</label>
                    <p class="text-[10px] text-gray-500 ml-0 mb-2">ë…¸ì¶œ ìœ„ì¹˜: <strong>ìƒí’ˆ ìƒì„¸ í˜ì´ì§€</strong> ë³¸ë¬¸ì— ì—¬ëŸ¬ ì¥ ë…¸ì¶œ (ìƒˆë¡œ ë“±ë¡ ì‹œ ê¸°ì¡´ ëŒ€ì²´)</p>
                    <input type="file" name="detail_images" multiple accept="image/*" class="text-[10px] font-bold product-image-input">
                </div>
            </div>

            <button type="submit" class="w-full bg-blue-600 text-white py-6 rounded-3xl font-black text-xl shadow-xl hover:bg-blue-700 transition active:scale-95 text-center admin-product-submit-btn">
                ìƒí’ˆ ì •ë³´ ìˆ˜ì • ì™„ë£Œ
            </button>
            
            <div class="text-center mt-4">
                <a href="/admin" class="text-gray-300 text-xs font-bold hover:text-gray-500 transition">ìˆ˜ì • ì·¨ì†Œí•˜ê³  ëŒì•„ê°€ê¸°</a>
            </div>
        </form>
    </div>
    <script>
    (function(){
    function processImageFile(file) {
      if (!file || !file.type || !file.type.match(/^image\//)) return Promise.resolve(file);
      return new Promise(function(resolve) {
        var img = new Image();
        var url = URL.createObjectURL(file);
        img.onload = function() {
          URL.revokeObjectURL(url);
          var w = img.naturalWidth, h = img.naturalHeight;
          var minSide = Math.min(w, h);
          var size = Math.min(1200, minSide);
          var canvas = document.createElement('canvas');
          canvas.width = size; canvas.height = size;
          var ctx = canvas.getContext('2d');
          var sx = (w - minSide) / 2, sy = (h - minSide) / 2;
          ctx.drawImage(img, sx, sy, minSide, minSide, 0, 0, size, size);
          canvas.toBlob(function(blob) { resolve(blob ? new File([blob], file.name || 'image.jpg', { type: 'image/jpeg' }) : file); }, 'image/jpeg', 0.82);
        };
        img.onerror = function() { URL.revokeObjectURL(url); resolve(file); };
        img.src = url;
      });
    }
    var form = document.getElementById('admin-product-form-edit');
    if (form) {
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        var f = this;
        var btn = f.querySelector('.admin-product-submit-btn');
        var originalText = btn ? btn.textContent : '';
        if (btn) { btn.disabled = true; btn.textContent = 'ì €ì¥ ì¤‘...'; }
        var formData = new FormData(f);
        var mainIn = f.querySelector('input[name="main_image"]');
        if (mainIn && mainIn.files && mainIn.files[0]) {
          var p = await processImageFile(mainIn.files[0]);
          if (p) formData.set('main_image', p, p.name || 'main.jpg');
        }
        var detailIn = f.querySelector('input[name="detail_images"]');
        if (detailIn && detailIn.files && detailIn.files.length) {
          formData.delete('detail_images');
          for (var i = 0; i < detailIn.files.length; i++) {
            var q = await processImageFile(detailIn.files[i]);
            if (q) formData.append('detail_images', q, q.name || ('detail_' + i + '.jpg'));
          }
        }
        try {
          var r = await fetch(f.action, { method: 'POST', body: formData, redirect: 'follow' });
          if (r.ok) { window.location.href = r.url || '/admin'; } else { alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); if (btn) { btn.disabled = false; btn.textContent = originalText; } }
        } catch (err) { alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); if (btn) { btn.disabled = false; btn.textContent = originalText; } }
      });
    }
    })();
    </script>
    """ + FOOTER_HTML, p=p)
@app.route('/admin/delete/<int:pid>')
@login_required
def admin_delete(pid):
    """ìƒí’ˆ ì‚­ì œ"""
    p = Product.query.get(pid)
    if p and check_admin_permission(p.category): db.session.delete(p); db.session.commit()
    return redirect('/admin')

@app.route('/admin/category/add', methods=['POST'])
@login_required
def admin_category_add():
    """ì¹´í…Œê³ ë¦¬ ì¶”ê°€"""
    if not current_user.is_admin: return redirect('/')
    last_cat = Category.query.order_by(Category.order.desc()).first()
    next_order = (last_cat.order + 1) if last_cat else 0
    mg = request.form.get('min_member_grade', '').strip()
    min_mg = int(mg) if mg and mg.isdigit() and mg in ('1', '2', '3', '4', '5') else None
    db.session.add(Category(name=request.form['cat_name'], description=request.form.get('description'), tax_type=request.form['tax_type'], manager_email=request.form.get('manager_email'), seller_name=request.form.get('biz_name'), seller_inquiry_link=request.form.get('seller_link'), biz_name=request.form.get('biz_name'), biz_representative=request.form.get('biz_representative'), biz_reg_number=request.form.get('biz_reg_number'), biz_address=request.form.get('biz_address'), biz_contact=request.form.get('biz_contact'), bank_name=request.form.get('bank_name'), account_holder=request.form.get('account_holder'), settlement_account=request.form.get('settlement_account'), order=next_order, min_member_grade=min_mg))
    db.session.commit(); return redirect('/admin?tab=categories')

@app.route('/admin/category/edit/<int:cid>', methods=['GET', 'POST'])
@login_required
def admin_category_edit(cid):
    """ì¹´í…Œê³ ë¦¬ ìˆ˜ì •"""
    if not current_user.is_admin: return redirect('/')
    cat = Category.query.get_or_404(cid)
    if request.method == 'POST':
        cat.name, cat.description, cat.tax_type, cat.manager_email = request.form['cat_name'], request.form['description'], request.form['tax_type'], request.form.get('manager_email')
        cat.biz_name, cat.biz_representative, cat.biz_reg_number, cat.biz_address, cat.biz_contact, cat.seller_inquiry_link = request.form.get('biz_name'), request.form.get('biz_representative'), request.form.get('biz_reg_number'), request.form.get('biz_address'), request.form.get('biz_contact'), request.form.get('seller_link')
        cat.bank_name, cat.account_holder, cat.settlement_account = request.form.get('bank_name'), request.form.get('account_holder'), request.form.get('settlement_account')
        cat.seller_name = cat.biz_name
        mg = request.form.get('min_member_grade', '').strip()
        cat.min_member_grade = int(mg) if mg and mg.isdigit() and mg in ('1', '2', '3', '4', '5') else None
        db.session.commit(); return redirect('/admin?tab=categories')
    mg_val = getattr(cat, 'min_member_grade', None)
    return render_template_string(HEADER_HTML + """<div class="max-w-xl mx-auto py-20 px-6 font-black text-left"><h2 class="text-2xl md:text-3xl font-black mb-12 tracking-tighter uppercase text-teal-600 text-left">Edit Category Profile</h2><form method="POST" class="bg-white p-10 rounded-[3rem] shadow-2xl space-y-8 text-left"><div><label class="text-[10px] text-gray-400 uppercase font-black ml-4 text-left">Settings</label><input name="cat_name" value="{{cat.name}}" class="border border-gray-100 p-5 rounded-2xl w-full font-black mt-2 text-sm text-left" required><textarea name="description" class="border border-gray-100 p-5 rounded-2xl w-full h-24 font-black mt-3 text-sm text-left" placeholder="í•œì¤„ ì†Œê°œ">{{cat.description or ''}}</textarea><input name="manager_email" value="{{cat.manager_email or ''}}" class="border border-gray-100 p-5 rounded-2xl w-full font-black mt-3 text-sm text-left" placeholder="ë§¤ë‹ˆì € ì´ë©”ì¼"><select name="tax_type" class="border border-gray-100 p-5 rounded-2xl w-full font-black mt-3 text-sm text-left bg-white"><option value="ê³¼ì„¸" {% if cat.tax_type == 'ê³¼ì„¸' %}selected{% endif %}>ê³¼ì„¸</option><option value="ë©´ì„¸" {% if cat.tax_type == 'ë©´ì„¸' %}selected{% endif %}>ë©´ì„¸</option></select><p class="text-[10px] text-amber-600 font-bold uppercase mt-4 ml-4 text-left">íšŒì› ë“±ê¸‰ë³„ ë…¸ì¶œ (ë¹„ì›Œë‘ë©´ ì „ì²´)</p><select name="min_member_grade" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs text-left mt-2 bg-white"><option value="">ì „ì²´ íšŒì›</option><option value="1" {% if mg_val == 1 %}selected{% endif %}>1ë‹¨ê³„ ì´ìƒ</option><option value="2" {% if mg_val == 2 %}selected{% endif %}>2ë‹¨ê³„ ì´ìƒ</option><option value="3" {% if mg_val == 3 %}selected{% endif %}>3ë‹¨ê³„ ì´ìƒ</option><option value="4" {% if mg_val == 4 %}selected{% endif %}>4ë‹¨ê³„ ì´ìƒ</option><option value="5" {% if mg_val == 5 %}selected{% endif %}>5ë‹¨ê³„ë§Œ</option></select></div><div class="border-t border-gray-50 pt-10 space-y-4 text-left"><label class="text-[10px] text-teal-600 uppercase font-black ml-4 text-left">Business Info</label><input name="biz_name" value="{{cat.biz_name or ''}}" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs text-left" placeholder="ìƒí˜¸ëª…"><input name="biz_representative" value="{{cat.biz_representative or ''}}" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs text-left" placeholder="ëŒ€í‘œì"><input name="biz_reg_number" value="{{cat.biz_reg_number or ''}}" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs text-left" placeholder="ì‚¬ì—…ìë²ˆí˜¸"><input name="biz_address" value="{{cat.biz_address or ''}}" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs text-left" placeholder="ì£¼ì†Œ"><input name="biz_contact" value="{{cat.biz_contact or ''}}" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs text-left" placeholder="ê³ ê°ì„¼í„°"><input name="seller_link" value="{{cat.seller_inquiry_link or ''}}" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs text-left" placeholder="ë¬¸ì˜ ë§í¬ URL"><p class="text-[10px] text-blue-600 font-bold uppercase mt-4 text-left">ì •ì‚° ê³„ì¢Œ</p><input name="bank_name" value="{{cat.bank_name or ''}}" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs text-left mt-2" placeholder="ì€í–‰ëª…"><input name="account_holder" value="{{cat.account_holder or ''}}" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs text-left mt-2" placeholder="ì˜ˆê¸ˆì£¼"><input name="settlement_account" value="{{cat.settlement_account or ''}}" class="border border-gray-100 p-4 rounded-xl w-full font-black text-xs text-left mt-2" placeholder="ì •ì‚°ê³„ì¢Œ (ê³„ì¢Œë²ˆí˜¸)"></div><button class="w-full bg-blue-600 text-white py-6 rounded-3xl font-black shadow-xl hover:bg-blue-700 transition text-center text-center">Save Profile Updates</button></form></div>""", cat=cat, mg_val=mg_val)

@app.route('/admin/category/move/<int:cid>/<string:direction>')
@login_required
def admin_category_move(cid, direction):
    """ì¹´í…Œê³ ë¦¬ ìˆœì„œ ì´ë™"""
    if not current_user.is_admin: return redirect('/')
    curr = Category.query.get_or_404(cid)
    if direction == 'up': target = Category.query.filter(Category.order < curr.order).order_by(Category.order.desc()).first()
    else: target = Category.query.filter(Category.order > curr.order).order_by(Category.order.asc()).first()
    if target: curr.order, target.order = target.order, curr.order; db.session.commit()
    return redirect('/admin?tab=categories')

@app.route('/admin/category/delete/<int:cid>')
@login_required
def admin_category_delete(cid):
    """ì¹´í…Œê³ ë¦¬ ì‚­ì œ"""
    if not current_user.is_admin: return redirect('/')
    db.session.delete(Category.query.get(cid)); db.session.commit(); return redirect('/admin?tab=categories')


@app.route('/admin/sellers/excel')
@login_required
def admin_sellers_excel():
    """íŒë§¤ì ì •ë³´(Seller Business Profile) ì—‘ì…€ ë‹¤ìš´ë¡œë“œ"""
    if not current_user.is_admin:
        flash("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin')
    categories = Category.query.order_by(Category.order.asc(), Category.id.asc()).all()
    rows = []
    for i, c in enumerate(categories, 1):
        rows.append({
            'ìˆœì„œ': i,
            'ì¹´í…Œê³ ë¦¬': c.name or '',
            'ìƒí˜¸': c.biz_name or '',
            'ëŒ€í‘œì': c.biz_representative or '',
            'ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸': c.biz_reg_number or '',
            'ì†Œì¬ì§€': c.biz_address or '',
            'ê³ ê°ì„¼í„°': c.biz_contact or '',
            'ë¬¸ì˜ë§í¬': c.seller_inquiry_link or '',
            'ì€í–‰ëª…': c.bank_name or '',
            'ì˜ˆê¸ˆì£¼': c.account_holder or '',
            'ì •ì‚°ê³„ì¢Œ': c.settlement_account or '',
            'ë§¤ë‹ˆì €ì´ë©”ì¼': c.manager_email or '',
        })
    if not rows:
        flash("ë‹¤ìš´ë¡œë“œí•  íŒë§¤ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin?tab=sellers')
    df = pd.DataFrame(rows)
    out = BytesIO()
    with pd.ExcelWriter(out, engine='openpyxl') as w:
        df.to_excel(w, index=False)
    out.seek(0)
    filename = f"íŒë§¤ìì •ë³´_{datetime.now().strftime('%m%d_%H%M')}.xlsx"
    return send_file(out, download_name=filename, as_attachment=True)


from urllib.parse import quote


@app.route('/admin/orders/sales_excel')
@login_required
def admin_orders_sales_excel():
    """ì¡°íšŒ ê²°ê³¼ ìƒì„¸ í…Œì´ë¸” ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ì£¼ë¬¸ì¼ì‹œ, íŒë§¤ìƒí’ˆëª…, íŒë§¤ìˆ˜ëŸ‰, ê²°ì œìƒíƒœ)"""
    categories = Category.query.all()
    my_categories = [c.name for c in categories if c.manager_email == current_user.email]
    if not (current_user.is_admin or my_categories):
        flash("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin')
    is_master = current_user.is_admin
    now = datetime.now()
    start_date_str = request.args.get('start_date', now.strftime('%Y-%m-%d 00:00')).replace('T', ' ')
    end_date_str = request.args.get('end_date', now.strftime('%Y-%m-%d 23:59')).replace('T', ' ')
    query = Order.query.filter(Order.status != 'ê²°ì œì·¨ì†Œ')
    order_ids_param = request.args.get('order_ids', '').strip()
    if order_ids_param:
        allowed_ids = [x.strip() for x in order_ids_param.split(',') if x.strip()]
        if allowed_ids:
            query = query.filter(Order.order_id.in_(allowed_ids))
    else:
        try:
            sd = datetime.strptime(start_date_str, '%Y-%m-%d %H:%M')
            ed = datetime.strptime(end_date_str, '%Y-%m-%d %H:%M')
            query = query.filter(Order.created_at >= sd, Order.created_at <= ed)
        except Exception:
            pass
    sel_order_cat = request.args.get('order_cat', 'ì „ì²´')
    orders = query.order_by(Order.created_at.desc()).all()
    sales_table_rows = []
    for o in orders:
        if is_master:
            order_show = True
        else:
            order_show = False
            parts = (o.product_details or '').split(' | ')
            for part in parts:
                match = re.search(r'\[(.*?)\] (.*)', part)
                if match and match.group(1).strip() in my_categories:
                    order_show = True
                    break
        if not order_show:
            continue
        parts = (o.product_details or '').split(' | ')
        order_date_str = o.created_at.strftime('%Y-%m-%d %H:%M') if o.created_at else ''
        status_str = o.status or 'ê²°ì œì™„ë£Œ'
        items = OrderItem.query.filter_by(order_id=o.id).order_by(OrderItem.id.asc()).all()
        if items:
            for oi in items:
                if (is_master or oi.product_category in my_categories) and (sel_order_cat == 'ì „ì²´' or oi.product_category == sel_order_cat):
                    is_cancelled = getattr(oi, 'cancelled', False) or (getattr(oi, 'item_status', None) in ('ë¶€ë¶„ì·¨ì†Œ', 'í’ˆì ˆì·¨ì†Œ'))
                    sales_table_rows.append({
                        'order_date': order_date_str,
                        'product_name': oi.product_name,
                        'category': oi.product_category,
                        'quantity': 0 if is_cancelled else oi.quantity,
                        'status': 'ì·¨ì†Œ' if is_cancelled else (getattr(oi, 'item_status', None) or status_str)
                    })
        else:
            for part in parts:
                match = re.search(r'\[(.*?)\] (.*)', part)
                if match:
                    cat_n, items_str = match.groups()
                    if (is_master or cat_n in my_categories) and (sel_order_cat == 'ì „ì²´' or cat_n == sel_order_cat):
                        for item in items_str.split(', '):
                            it_match = re.search(r'(.*?)\((\d+)\)', item)
                            if it_match:
                                pn, qt = it_match.groups()
                                sales_table_rows.append({'order_date': order_date_str, 'product_name': pn.strip(), 'category': cat_n, 'quantity': int(qt), 'status': status_str})
    if not sales_table_rows:
        flash("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin?tab=orders')
    df = pd.DataFrame(sales_table_rows, columns=['order_date', 'product_name', 'category', 'quantity', 'status'])
    df.columns = ['ì£¼ë¬¸ì¼ì‹œ', 'íŒë§¤ìƒí’ˆëª…', 'ì¹´í…Œê³ ë¦¬', 'íŒë§¤ìˆ˜ëŸ‰', 'ê²°ì œìƒíƒœ']
    out = BytesIO()
    with pd.ExcelWriter(out, engine='openpyxl') as w:
        df.to_excel(w, index=False)
    out.seek(0)
    filename = f"ë§¤ì¶œìƒì„¸_{datetime.now().strftime('%m%d_%H%M')}.xlsx"
    return send_file(out, download_name=filename, as_attachment=True)


@app.route('/admin/orders/sales_summary_excel')
@login_required
def admin_orders_sales_summary_excel():
    """íŒë§¤ìƒí’ˆëª…ë³„ íŒë§¤ìˆ˜ëŸ‰ ì´í•©ê³„ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (í’ˆëª©Â·íŒë§¤ìƒí’ˆëª…Â·ì´í•©ê³„)"""
    categories = Category.query.all()
    my_categories = [c.name for c in categories if c.manager_email == current_user.email]
    if not (current_user.is_admin or my_categories):
        flash("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin')
    is_master = current_user.is_admin
    now = datetime.now()
    start_date_str = request.args.get('start_date', now.strftime('%Y-%m-%d 00:00')).replace('T', ' ')
    end_date_str = request.args.get('end_date', now.strftime('%Y-%m-%d 23:59')).replace('T', ' ')
    query = Order.query.filter(Order.status != 'ê²°ì œì·¨ì†Œ')
    order_ids_param = request.args.get('order_ids', '').strip()
    if order_ids_param:
        allowed_ids = [x.strip() for x in order_ids_param.split(',') if x.strip()]
        if allowed_ids:
            query = query.filter(Order.order_id.in_(allowed_ids))
    else:
        try:
            sd = datetime.strptime(start_date_str, '%Y-%m-%d %H:%M')
            ed = datetime.strptime(end_date_str, '%Y-%m-%d %H:%M')
            query = query.filter(Order.created_at >= sd, Order.created_at <= ed)
        except Exception:
            pass
    sel_order_cat = request.args.get('order_cat', 'ì „ì²´')
    orders = query.order_by(Order.created_at.desc()).all()
    sales_table_rows = []
    for o in orders:
        if is_master:
            order_show = True
        else:
            order_show = False
            parts = (o.product_details or '').split(' | ')
            for part in parts:
                match = re.search(r'\[(.*?)\] (.*)', part)
                if match and match.group(1).strip() in my_categories:
                    order_show = True
                    break
        if not order_show:
            continue
        parts = (o.product_details or '').split(' | ')
        order_date_str = o.created_at.strftime('%Y-%m-%d %H:%M') if o.created_at else ''
        status_str = o.status or 'ê²°ì œì™„ë£Œ'
        items = OrderItem.query.filter_by(order_id=o.id).order_by(OrderItem.id.asc()).all()
        if items:
            for oi in items:
                if (is_master or oi.product_category in my_categories) and (sel_order_cat == 'ì „ì²´' or oi.product_category == sel_order_cat):
                    is_cancelled = getattr(oi, 'cancelled', False) or (getattr(oi, 'item_status', None) in ('ë¶€ë¶„ì·¨ì†Œ', 'í’ˆì ˆì·¨ì†Œ'))
                    sales_table_rows.append({
                        'order_date': order_date_str,
                        'product_name': oi.product_name,
                        'category': oi.product_category,
                        'quantity': 0 if is_cancelled else oi.quantity,
                        'status': 'ì·¨ì†Œ' if is_cancelled else (getattr(oi, 'item_status', None) or status_str)
                    })
        else:
            for part in parts:
                match = re.search(r'\[(.*?)\] (.*)', part)
                if match:
                    cat_n, items_str = match.groups()
                    if (is_master or cat_n in my_categories) and (sel_order_cat == 'ì „ì²´' or cat_n == sel_order_cat):
                        for item in items_str.split(', '):
                            it_match = re.search(r'(.*?)\((\d+)\)', item)
                            if it_match:
                                pn, qt = it_match.groups()
                                sales_table_rows.append({'order_date': order_date_str, 'product_name': pn.strip(), 'category': cat_n, 'quantity': int(qt), 'status': status_str})
    from collections import defaultdict
    agg = defaultdict(int)
    for r in sales_table_rows:
        key = (r.get('category', ''), r.get('product_name', ''))
        agg[key] += r.get('quantity', 0)
    product_summary_rows = [{'category': k[0], 'product_name': k[1], 'total_quantity': v} for k, v in sorted(agg.items())]
    if not product_summary_rows:
        flash("ë‹¤ìš´ë¡œë“œí•  ì§‘ê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin?tab=orders')
    df = pd.DataFrame(product_summary_rows, columns=['category', 'product_name', 'total_quantity'])
    df.columns = ['í’ˆëª©(ì¹´í…Œê³ ë¦¬)', 'íŒë§¤ìƒí’ˆëª…', 'íŒë§¤ìˆ˜ëŸ‰ ì´í•©ê³„']
    out = BytesIO()
    with pd.ExcelWriter(out, engine='openpyxl') as w:
        df.to_excel(w, index=False)
    out.seek(0)
    filename = f"íŒë§¤ìƒí’ˆëª…ë³„_ì´í•©ê³„_{datetime.now().strftime('%m%d_%H%M')}.xlsx"
    return send_file(out, download_name=filename, as_attachment=True)


@app.route('/admin/orders/settlement_detail_excel')
@login_required
def admin_orders_settlement_detail_excel():
    """ì •ì‚° ìƒì„¸ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (Settlement í…Œì´ë¸” në„˜ë²„ ê¸°ì¤€, ë‚ ì§œÂ·ì¹´í…Œê³ ë¦¬Â·ì…ê¸ˆìƒíƒœ í•„í„°)"""
    categories = Category.query.all()
    my_categories = [c.name for c in categories if c.manager_email == current_user.email]
    if not (current_user.is_admin or my_categories):
        flash("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin')
    is_master = current_user.is_admin
    now = datetime.now()
    start_date_str = request.args.get('start_date', now.strftime('%Y-%m-%d 00:00')).replace('T', ' ')
    end_date_str = request.args.get('end_date', now.strftime('%Y-%m-%d 23:59')).replace('T', ' ')
    sel_order_cat = request.args.get('order_cat', 'ì „ì²´')
    sel_settlement_status = request.args.get('settlement_status', 'ì „ì²´')
    if sel_settlement_status == 'ì •ì‚°ëŒ€ê¸°': sel_settlement_status = 'ì…ê¸ˆëŒ€ê¸°'
    if sel_settlement_status == 'ì •ì‚°ì™„ë£Œ': sel_settlement_status = 'ì…ê¸ˆì™„ë£Œ'
    try:
        start_dt = datetime.strptime(start_date_str, '%Y-%m-%d %H:%M')
        end_dt = datetime.strptime(end_date_str, '%Y-%m-%d %H:%M')
    except Exception:
        start_dt = now.replace(hour=0, minute=0, second=0)
        end_dt = now.replace(hour=23, minute=59, second=59)
    q = Settlement.query.filter(Settlement.sale_dt >= start_dt, Settlement.sale_dt <= end_dt)
    if not is_master:
        q = q.filter(Settlement.category.in_(my_categories))
    if sel_order_cat != 'ì „ì²´':
        q = q.filter(Settlement.category == sel_order_cat)
    if sel_settlement_status and sel_settlement_status != 'ì „ì²´':
        q = q.filter(Settlement.settlement_status == sel_settlement_status)
    rows = []
    for s in q.order_by(Settlement.sale_dt.desc()).all():
        rows.append({
            'settlement_no': s.settlement_no,
            'sale_dt': s.sale_dt.strftime('%Y-%m-%d %H:%M') if s.sale_dt else '',
            'category': s.category,
            'tax_exempt': 'ë©´ì„¸' if s.tax_exempt else 'ê³¼ì„¸',
            'product_name': s.product_name,
            'sales_amount': s.sales_amount,
            'fee': s.fee,
            'delivery_fee': s.delivery_fee,
            'settlement_total': s.settlement_total,
            'settlement_status': s.settlement_status,
            'settled_at': s.settled_at.strftime('%Y-%m-%d %H:%M') if s.settled_at else '',
        })
    if not rows:
        flash("ë‹¤ìš´ë¡œë“œí•  ì •ì‚° ìƒì„¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin?tab=settlement')
    df = pd.DataFrame(rows, columns=['settlement_no', 'sale_dt', 'category', 'tax_exempt', 'product_name', 'sales_amount', 'fee', 'delivery_fee', 'settlement_total', 'settlement_status', 'settled_at'])
    df.columns = ['ì •ì‚°ë²ˆí˜¸(n)', 'íŒë§¤ì¼ì‹œ', 'ì¹´í…Œê³ ë¦¬', 'ë©´ì„¸ì—¬ë¶€', 'í’ˆëª©', 'íŒë§¤ê¸ˆì•¡', 'ìˆ˜ìˆ˜ë£Œ', 'ë°°ì†¡ê´€ë¦¬ë¹„', 'ì •ì‚°í•©ê³„', 'ì…ê¸ˆìƒíƒœ', 'ì…ê¸ˆì¼']
    out = BytesIO()
    with pd.ExcelWriter(out, engine='openpyxl') as w:
        df.to_excel(w, index=False)
    out.seek(0)
    filename = f"ì •ì‚°ìƒì„¸_{datetime.now().strftime('%m%d_%H%M')}.xlsx"
    return send_file(out, download_name=filename, as_attachment=True)


@app.route('/admin/settlement/category_excel')
@login_required
def admin_settlement_category_excel():
    """ì •ì‚°ê´€ë¦¬: ì¹´í…Œê³ ë¦¬ë³„ íŒë§¤ í’ˆëª© ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (í’ˆëª©ëª…Â·ê·œê²©Â·ìˆ˜ëŸ‰Â·ë‹¨ê°€Â·í•©ê³„)"""
    categories = Category.query.all()
    my_categories = [c.name for c in categories if c.manager_email == current_user.email]
    if not (current_user.is_admin or my_categories):
        flash("ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin')
    is_master = current_user.is_admin
    now = datetime.now()
    start_date_str = request.args.get('start_date', now.strftime('%Y-%m-%d 00:00')).replace('T', ' ')
    end_date_str = request.args.get('end_date', now.strftime('%Y-%m-%d 23:59')).replace('T', ' ')
    sel_cat = request.args.get('category', 'ì „ì²´')
    try:
        start_dt = datetime.strptime(start_date_str, '%Y-%m-%d %H:%M')
        end_dt = datetime.strptime(end_date_str, '%Y-%m-%d %H:%M')
    except Exception:
        start_dt = now.replace(hour=0, minute=0, second=0)
        end_dt = now.replace(hour=23, minute=59, second=59)
    q = db.session.query(OrderItem, Order, Product).join(
        Order, OrderItem.order_id == Order.id
    ).outerjoin(Product, OrderItem.product_id == Product.id)
    q = q.filter(Order.status != 'ê²°ì œì·¨ì†Œ', OrderItem.cancelled == False)
    q = q.filter(Order.created_at >= start_dt, Order.created_at <= end_dt)
    if not is_master:
        q = q.filter(OrderItem.product_category.in_(my_categories))
    if sel_cat != 'ì „ì²´':
        q = q.filter(OrderItem.product_category == sel_cat)
    rows = []
    for oi, o, p in q.order_by(Order.created_at.desc(), OrderItem.id.asc()).all():
        spec = (p.spec if p else None) or "-"
        rows.append({
            "sale_dt": o.created_at.strftime('%Y-%m-%d %H:%M') if o and o.created_at else '',
            "category": oi.product_category,
            "product_name": oi.product_name,
            "spec": spec,
            "quantity": oi.quantity,
            "price": oi.price,
            "total": oi.price * oi.quantity,
        })
    if not rows:
        flash("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin?tab=settlement')
    df = pd.DataFrame(rows, columns=["sale_dt", "category", "product_name", "spec", "quantity", "price", "total"])
    df.columns = ["íŒë§¤ì¼ì‹œ", "ì¹´í…Œê³ ë¦¬", "í’ˆëª©ëª…", "ê·œê²©", "ìˆ˜ëŸ‰", "ë‹¨ê°€", "í•©ê³„"]
    out = BytesIO()
    with pd.ExcelWriter(out, engine='openpyxl') as w:
        df.to_excel(w, index=False)
    out.seek(0)
    filename = f"ì¹´í…Œê³ ë¦¬ë³„_íŒë§¤í’ˆëª©_{datetime.now().strftime('%m%d_%H%M')}.xlsx"
    return send_file(out, download_name=filename, as_attachment=True)


@app.route('/admin/orders/excel')
@login_required
def admin_orders_excel():
    """ì£¼ë¬¸ ë‚´ì—­ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ (ì •ì‚°ì—¬ë¶€/ì¼ì‹œ í¬í•¨ + í’ˆëª© ë¶„ë¦¬ ìµœì¢… ì™„ì„±ë³¸)"""
    categories = Category.query.all()
    my_categories = [c.name for c in categories if c.manager_email == current_user.email]
    
    if not (current_user.is_admin or my_categories):
        flash("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin')



    is_master = current_user.is_admin
    now = datetime.now()
    
    # [ê¸°ì¡´ ë¡œì§ ìœ ì§€] ë‚ ì§œ ë³€ìˆ˜ ì •ì˜
    start_date_str = request.args.get('start_date', now.strftime('%Y-%m-%d 00:00')).replace('T', ' ')
    end_date_str = request.args.get('end_date', now.strftime('%Y-%m-%d 23:59')).replace('T', ' ')
    
    query = Order.query.filter(Order.status != 'ê²°ì œì·¨ì†Œ')
    
    # í˜„ì¬ ê¶Œí•œ ìˆëŠ” ì˜¤ë”ë§Œ ì‚¬ìš©: order_idsê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì£¼ë¬¸ë§Œ ëŒ€ìƒ(ë‚ ì§œëŠ” ì°¸ê³ ìš©), ì—†ìœ¼ë©´ ë‚ ì§œë¡œë§Œ í•„í„°
    order_ids_param = request.args.get('order_ids', '').strip()
    if order_ids_param:
        allowed_ids = [x.strip() for x in order_ids_param.split(',') if x.strip()]
        if allowed_ids:
            query = query.filter(Order.order_id.in_(allowed_ids))
    else:
        try:
            sd = datetime.strptime(start_date_str, '%Y-%m-%d %H:%M')
            ed = datetime.strptime(end_date_str, '%Y-%m-%d %H:%M')
            query = query.filter(Order.created_at >= sd, Order.created_at <= ed)
        except:
            pass

    orders = query.order_by(Order.created_at.desc()).all()
    
    data = []
    all_product_columns = set()

    for o in orders:
        # ê¶Œí•œ ìˆëŠ” í’ˆëª©ë§Œ í•©ì‚° (ì˜¤ë”ë³„ ì •ì‚°ëŒ€ìƒê¸ˆì•¡)
        row_manager_subtotal = 0

        row = {
            "ì¼ì‹œ": o.created_at.strftime('%Y-%m-%d %H:%M') if o.created_at else "-",
            "ì£¼ë¬¸ë²ˆí˜¸": o.order_id[-8:] if o.order_id else "-",
            "ê³ ê°ëª…": o.customer_name or "-",
            "ì „í™”ë²ˆí˜¸": o.customer_phone or "-",
            "ì£¼ì†Œ": o.delivery_address or "-",
            "ë©”ëª¨": o.request_memo or "-",
            "ê²°ì œê¸ˆì•¡": 0,  # ì•„ë˜ì—ì„œ ê¶Œí•œë³„ë¡œ ì±„ì›€
            "ìƒíƒœ": o.status or "-",
            "ì…ê¸ˆì—¬ë¶€": "ì…ê¸ˆì™„ë£Œ" if getattr(o, 'is_settled', False) else "ëŒ€ê¸°",
            "ì •ì‚°ì¼ì‹œ": o.settled_at.strftime('%Y-%m-%d %H:%M') if (getattr(o, 'is_settled', False) and o.settled_at) else "-"
        }
        
        parts = o.product_details.split(' | ') if o.product_details else []
        row_show_flag = False
        
        for part in parts:
            match = re.search(r'\[(.*?)\] (.*)', part)
            if match:
                cat_n, items_str = match.groups()
                if is_master or cat_n in my_categories:
                    row_show_flag = True
                    items = items_str.split(', ')
                    for item in items:
                        item_match = re.search(r'(.*?)\((\d+)\)', item)
                        if item_match:
                            p_name = item_match.group(1).strip()
                            p_qty = int(item_match.group(2))
                            col_name = f"[{cat_n}] {p_name}"
                            row[col_name] = p_qty
                            all_product_columns.add(col_name)
                            # ê¶Œí•œ ìˆëŠ” í’ˆëª©ë§Œ ì •ì‚°ëŒ€ìƒê¸ˆì•¡ì— í•©ì‚°
                            p_obj = Product.query.filter_by(name=p_name).first()
                            if p_obj:
                                row_manager_subtotal += p_obj.price * p_qty

        if row_show_flag:
            # ë§ˆìŠ¤í„°ëŠ” ì£¼ë¬¸ ì „ì²´ ê²°ì œê¸ˆì•¡, ë§¤ë‹ˆì €ëŠ” í•´ë‹¹ ì˜¤ë”ì˜ ê¶Œí•œ í’ˆëª© í•©ê³„ë§Œ
            row["ê²°ì œê¸ˆì•¡"] = o.total_price if is_master else row_manager_subtotal
            data.append(row)

    if not data:
        flash("ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return redirect('/admin?tab=orders')

    # ë°ì´í„°í”„ë ˆì„ ìƒì„± ë° ì—´ ìˆœì„œ í™•ì •
    df = pd.DataFrame(data)
    
    # í—¤ë” ìˆœì„œ ê³ ì • (ì •ë³´ì„± ì—´ë“¤ì„ ì•ìœ¼ë¡œ ë°°ì¹˜)
    base_cols = ["ì¼ì‹œ", "ì£¼ë¬¸ë²ˆí˜¸", "ê³ ê°ëª…", "ì „í™”ë²ˆí˜¸", "ì£¼ì†Œ", "ë©”ëª¨", "ê²°ì œê¸ˆì•¡", "ìƒíƒœ", "ì •ì‚°ì—¬ë¶€", "ì •ì‚°ì¼ì‹œ"]
    
    # ì‹¤ì œ ìƒì„±ëœ ìƒí’ˆ ì—´ë“¤ë§Œ ì¶”ì¶œí•˜ì—¬ ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬
    existing_base_cols = [c for c in base_cols if c in df.columns]
    product_cols = sorted([c for c in df.columns if c not in base_cols])
    
    df = df[existing_base_cols + product_cols]
    df = df.fillna('') # ìˆ˜ëŸ‰ ì—†ëŠ” ì¹¸ ë¹ˆì¹¸ ì²˜ë¦¬

    # ì´í•©ê³„ í–‰ ì¶”ê°€ (ê¶Œí•œ ìˆëŠ” í’ˆëª© í•©ê³„ë§Œ)
    total_row = {c: "" for c in df.columns}
    total_row["ì£¼ë¬¸ë²ˆí˜¸"] = "ì´í•©ê³„"
    if "ê²°ì œê¸ˆì•¡" in df.columns:
        total_row["ê²°ì œê¸ˆì•¡"] = pd.to_numeric(df["ê²°ì œê¸ˆì•¡"], errors="coerce").fillna(0).astype(int).sum()
    df = pd.concat([df, pd.DataFrame([total_row])], ignore_index=True)

    out = BytesIO()
    with pd.ExcelWriter(out, engine='openpyxl') as w:
        df.to_excel(w, index=False)
    
    out.seek(0)
    filename = f"ë°”êµ¬ë‹ˆì‚¼ì´Œ_ì£¼ë¬¸ì •ì‚°_{datetime.now().strftime('%m%d_%H%M')}.xlsx"
    return send_file(out, download_name=filename, as_attachment=True)
    # ë°ì´í„°í”„ë ˆì„ ìƒì„± ë° ì—´ ìˆœì„œ ì •ë¦¬
    df = pd.DataFrame(data)
    
    # ê¸°ë³¸ ì •ë³´ ì—´ ë¦¬ìŠ¤íŠ¸
    base_cols = ["ì¼ì‹œ", "ì£¼ë¬¸ë²ˆí˜¸", "ê³ ê°ëª…", "ì „í™”ë²ˆí˜¸", "ì£¼ì†Œ", "ë©”ëª¨", "ê²°ì œê¸ˆì•¡", "ìƒíƒœ"]
    # ì‹¤ì œ ìƒì„±ëœ ìƒí’ˆ ì—´ë“¤ë§Œ ì¶”ì¶œí•˜ì—¬ ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬
    exist_prod_cols = sorted([c for c in all_product_columns if c in df.columns])
    
    # ìµœì¢… ì—´ ìˆœì„œ í™•ì • (ê¸°ë³¸ì •ë³´ + ìƒí’ˆì—´)
    df = df[base_cols + exist_prod_cols]
    # ìˆ˜ëŸ‰ì´ ì—†ëŠ” ì¹¸(NaN)ì€ 0 ë˜ëŠ” ë¹ˆì¹¸ìœ¼ë¡œ ì²˜ë¦¬ (ìˆ˜ëŸ‰ ì§‘ê³„ë¥¼ ìœ„í•´ 0 ì¶”ì²œ)
    df = df.fillna('') 

    # ë©”ëª¨ë¦¬ ë²„í¼ì— ì—‘ì…€ ì“°ê¸°
    out = BytesIO()
    with pd.ExcelWriter(out, engine='openpyxl') as w:
        df.to_excel(w, index=False, sheet_name='ì£¼ë¬¸ë¦¬ìŠ¤íŠ¸')
        
        # ì—‘ì…€ ì—´ ë„ˆë¹„ ìë™ ìµœì í™”
        worksheet = w.sheets['ì£¼ë¬¸ë¦¬ìŠ¤íŠ¸']
        for idx, col in enumerate(df.columns):
            column_len = df[col].astype(str).str.len().max()
            column_len = max(column_len, len(col)) + 5
            worksheet.column_dimensions[chr(65 + idx)].width = min(column_len, 60)

    out.seek(0)
    
    # íŒŒì¼ëª… í•œê¸€ ê¹¨ì§ ë°©ì§€ ì¸ì½”ë”©
    filename = f"ë°”êµ¬ë‹ˆì‚¼ì´Œ_ì£¼ë¬¸ë°ì´í„°_{datetime.now().strftime('%m%d_%H%M')}.xlsx"
    encoded_filename = quote(filename)
    
    response = send_file(
        out, 
        mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        as_attachment=True, 
        download_name=filename
    )
    response.headers["Content-Disposition"] = f"attachment; filename={encoded_filename}; filename*=UTF-8''{encoded_filename}"
    
    return response

# --------------------------------------------------------------------------------
# 9. ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ë° ì„œë²„ ì‹¤í–‰
# --------------------------------------------------------------------------------

def init_db():
